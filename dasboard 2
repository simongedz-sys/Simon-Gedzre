import React, { useState, useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { 
  Brain, 
  X, 
  CheckSquare, 
  Calendar, 
  AlertTriangle, 
  Clock,
  Sun,
  Sunrise,
  Moon,
  Coffee,
  Sparkles,
  TrendingUp
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { format, isToday, parseISO, isBefore, startOfDay } from 'date-fns';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';

export default function JackieWelcomeModal() {
  const [isOpen, setIsOpen] = useState(false);
  const [hasShownToday, setHasShownToday] = useState(false);
  const navigate = useNavigate();

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me(),
  });

  const { data: tasks = [] } = useQuery({
    queryKey: ['tasks'],
    queryFn: () => base44.entities.Task.list(),
    enabled: !!user,
  });

  const { data: appointments = [] } = useQuery({
    queryKey: ['appointments'],
    queryFn: () => base44.entities.Appointment.list(),
    enabled: !!user,
  });

  const { data: leads = [] } = useQuery({
    queryKey: ['leads'],
    queryFn: () => base44.entities.Lead.list(),
    enabled: !!user,
  });

  const { data: showings = [] } = useQuery({
    queryKey: ['showings'],
    queryFn: () => base44.entities.Showing.list(),
    enabled: !!user,
  });

  const { data: openHouses = [] } = useQuery({
    queryKey: ['openHouses'],
    queryFn: () => base44.entities.OpenHouse.list(),
    enabled: !!user,
  });

  // Check if we should show the welcome modal
  useEffect(() => {
    if (!user) return;

    const lastShownKey = `jackie_welcome_last_shown_${user.id}`;
    const lastShown = localStorage.getItem(lastShownKey);
    const today = format(new Date(), 'yyyy-MM-dd');

    if (lastShown !== today) {
      // Small delay to let the app load first
      const timer = setTimeout(() => {
        setIsOpen(true);
        localStorage.setItem(lastShownKey, today);
        setHasShownToday(true);
      }, 1500);

      return () => clearTimeout(timer);
    } else {
      setHasShownToday(true);
    }
  }, [user]);

  const getGreeting = () => {
    const hour = new Date().getHours();
    if (hour < 6) return { text: 'Good night', icon: Moon, emoji: 'üåô' };
    if (hour < 12) return { text: 'Good morning', icon: Sunrise, emoji: '‚òÄÔ∏è' };
    if (hour < 17) return { text: 'Good afternoon', icon: Sun, emoji: 'üå§Ô∏è' };
    if (hour < 21) return { text: 'Good evening', icon: Coffee, emoji: 'üåÖ' };
    return { text: 'Good night', icon: Moon, emoji: 'üåô' };
  };

  const greeting = getGreeting();
  const firstName = user?.full_name?.split(' ')[0] || 'there';

  // Get today's tasks
  const todaysTasks = tasks.filter(task => {
    if (!task.due_date || task.status === 'completed' || task.status === 'cancelled') return false;
    return isToday(parseISO(task.due_date));
  });

  // Get overdue tasks
  const overdueTasks = tasks.filter(task => {
    if (!task.due_date || task.status === 'completed' || task.status === 'cancelled') return false;
    const dueDate = parseISO(task.due_date);
    return isBefore(dueDate, startOfDay(new Date()));
  });

  // Get today's appointments
  const todaysAppointments = appointments.filter(apt => {
    if (!apt.scheduled_date || apt.status === 'cancelled' || apt.status === 'completed') return false;
    return isToday(parseISO(apt.scheduled_date));
  });

  // Get today's showings
  const todaysShowings = showings.filter(showing => {
    if (!showing.scheduled_date || showing.status === 'cancelled') return false;
    return isToday(parseISO(showing.scheduled_date));
  });

  // Get today's open houses
  const todaysOpenHouses = openHouses.filter(oh => {
    if (!oh.date || oh.status === 'cancelled') return false;
    return isToday(parseISO(oh.date));
  });

  // Get hot leads
  const hotLeads = leads.filter(lead => (lead.score || 0) >= 70 && lead.status !== 'converted' && lead.status !== 'lost');

  // Critical tasks
  const criticalTasks = todaysTasks.filter(t => t.priority === 'critical' || t.priority === 'high');

  const totalTodayEvents = todaysTasks.length + todaysAppointments.length + todaysShowings.length + todaysOpenHouses.length;

  const getMotivationalMessage = () => {
    if (overdueTasks.length > 3) {
      return "Let's tackle those overdue items first - you've got this! üí™";
    }
    if (criticalTasks.length > 0) {
      return "You have some high-priority items today. Let's knock them out! üéØ";
    }
    if (totalTodayEvents === 0) {
      return "Your schedule is clear today - perfect time to follow up with leads! üìû";
    }
    if (hotLeads.length > 0) {
      return `You have ${hotLeads.length} hot lead${hotLeads.length > 1 ? 's' : ''} waiting for your attention! üî•`;
    }
    return "Ready to make today productive? Let's do this! ‚≠ê";
  };

  if (!isOpen) return null;

  return (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4"
        onClick={() => setIsOpen(false)}
      >
        <motion.div
          initial={{ opacity: 0, scale: 0.9, y: 20 }}
          animate={{ opacity: 1, scale: 1, y: 0 }}
          exit={{ opacity: 0, scale: 0.9, y: 20 }}
          transition={{ type: 'spring', damping: 25, stiffness: 300 }}
          onClick={(e) => e.stopPropagation()}
        >
          <Card className="w-full max-w-lg bg-gradient-to-br from-white to-indigo-50 dark:from-slate-900 dark:to-indigo-950 shadow-2xl border-2 border-indigo-200 dark:border-indigo-800 overflow-hidden">
            {/* Header */}
            <CardHeader className="p-4 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 relative overflow-hidden">
              <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4xIj48cGF0aCBkPSJNMzYgMzRoLTJ2LTRoMnY0em0wLTZoLTJ2LTRoMnY0em0tNiA2aC0ydi00aDJ2NHptMC02aC0ydi00aDJ2NHoiLz48L2c+PC9nPjwvc3ZnPg==')] opacity-30"></div>
              <div className="flex items-center justify-between relative">
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                    <Brain className="w-7 h-7 text-white" />
                  </div>
                  <div>
                    <h2 className="text-xl font-bold text-white">
                      {greeting.emoji} {greeting.text}, {firstName}!
                    </h2>
                    <p className="text-indigo-100 text-sm">
                      {format(new Date(), 'EEEE, MMMM d, yyyy')}
                    </p>
                  </div>
                </div>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => setIsOpen(false)}
                  className="text-white hover:bg-white/20 h-8 w-8"
                >
                  <X className="w-5 h-5" />
                </Button>
              </div>
            </CardHeader>

            <CardContent className="p-4 space-y-4">
              {/* Jackie's Message */}
              <div className="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-xl p-4 border border-indigo-100 dark:border-indigo-800">
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center flex-shrink-0">
                    <Sparkles className="w-4 h-4 text-white" />
                  </div>
                  <div>
                    <p className="text-sm font-medium text-slate-700 dark:text-slate-200">
                      {getMotivationalMessage()}
                    </p>
                  </div>
                </div>
              </div>

              {/* Today's Overview */}
              <div className="grid grid-cols-2 gap-3">
                <div 
                  className="bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200 dark:border-slate-700 cursor-pointer hover:shadow-md transition-shadow"
                  onClick={() => { setIsOpen(false); navigate(createPageUrl('Tasks')); }}
                >
                  <div className="flex items-center gap-2 mb-2">
                    <CheckSquare className="w-4 h-4 text-cyan-500" />
                    <span className="text-xs font-semibold text-slate-600 dark:text-slate-300">Today's Tasks</span>
                  </div>
                  <p className="text-2xl font-bold text-slate-900 dark:text-white">{todaysTasks.length}</p>
                  {criticalTasks.length > 0 && (
                    <Badge className="mt-1 bg-red-100 text-red-700 text-[10px]">
                      {criticalTasks.length} high priority
                    </Badge>
                  )}
                </div>

                <div 
                  className="bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200 dark:border-slate-700 cursor-pointer hover:shadow-md transition-shadow"
                  onClick={() => { setIsOpen(false); navigate(createPageUrl('Calendar')); }}
                >
                  <div className="flex items-center gap-2 mb-2">
                    <Calendar className="w-4 h-4 text-purple-500" />
                    <span className="text-xs font-semibold text-slate-600 dark:text-slate-300">Appointments</span>
                  </div>
                  <p className="text-2xl font-bold text-slate-900 dark:text-white">{todaysAppointments.length}</p>
                  {todaysShowings.length > 0 && (
                    <Badge className="mt-1 bg-green-100 text-green-700 text-[10px]">
                      +{todaysShowings.length} showings
                    </Badge>
                  )}
                </div>
              </div>

              {/* Overdue Warning */}
              {overdueTasks.length > 0 && (
                <div 
                  className="bg-red-50 dark:bg-red-900/20 rounded-xl p-3 border border-red-200 dark:border-red-800 cursor-pointer hover:shadow-md transition-shadow"
                  onClick={() => { setIsOpen(false); navigate(createPageUrl('Tasks')); }}
                >
                  <div className="flex items-center gap-2">
                    <AlertTriangle className="w-5 h-5 text-red-500" />
                    <div className="flex-1">
                      <p className="text-sm font-semibold text-red-700 dark:text-red-300">
                        {overdueTasks.length} Overdue Task{overdueTasks.length > 1 ? 's' : ''}
                      </p>
                      <p className="text-xs text-red-600 dark:text-red-400">
                        These need your attention today
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Hot Leads */}
              {hotLeads.length > 0 && (
                <div 
                  className="bg-amber-50 dark:bg-amber-900/20 rounded-xl p-3 border border-amber-200 dark:border-amber-800 cursor-pointer hover:shadow-md transition-shadow"
                  onClick={() => { setIsOpen(false); navigate(createPageUrl('Leads?filter=hot')); }}
                >
                  <div className="flex items-center gap-2">
                    <TrendingUp className="w-5 h-5 text-amber-500" />
                    <div className="flex-1">
                      <p className="text-sm font-semibold text-amber-700 dark:text-amber-300">
                        üî• {hotLeads.length} Hot Lead{hotLeads.length > 1 ? 's' : ''}
                      </p>
                      <p className="text-xs text-amber-600 dark:text-amber-400">
                        Ready for follow-up
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Task List Preview */}
              {todaysTasks.length > 0 && (
                <div className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                  <div className="px-3 py-2 bg-slate-50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-600">
                    <p className="text-xs font-semibold text-slate-600 dark:text-slate-300">Today's Tasks</p>
                  </div>
                  <ScrollArea className="max-h-32">
                    <div className="p-2 space-y-1">
                      {todaysTasks.slice(0, 5).map((task, idx) => (
                        <div 
                          key={task.id || idx} 
                          className="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer"
                          onClick={() => { setIsOpen(false); navigate(createPageUrl(`Tasks?highlight=${task.id}`)); }}
                        >
                          <div className={`w-2 h-2 rounded-full ${
                            task.priority === 'critical' ? 'bg-red-500' :
                            task.priority === 'high' ? 'bg-orange-500' :
                            task.priority === 'medium' ? 'bg-yellow-500' : 'bg-green-500'
                          }`} />
                          <span className="text-sm text-slate-700 dark:text-slate-200 truncate flex-1">
                            {task.title}
                          </span>
                          {task.due_time && (
                            <span className="text-xs text-slate-400 flex items-center gap-1">
                              <Clock className="w-3 h-3" />
                              {task.due_time}
                            </span>
                          )}
                        </div>
                      ))}
                      {todaysTasks.length > 5 && (
                        <p className="text-xs text-slate-400 text-center py-1">
                          +{todaysTasks.length - 5} more tasks
                        </p>
                      )}
                    </div>
                  </ScrollArea>
                </div>
              )}

              {/* Quick Actions */}
              <div className="flex gap-2">
                <Button
                  onClick={() => { setIsOpen(false); navigate(createPageUrl('Tasks')); }}
                  className="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-sm"
                >
                  <CheckSquare className="w-4 h-4 mr-2" />
                  View Tasks
                </Button>
                <Button
                  onClick={() => { setIsOpen(false); navigate(createPageUrl('Calendar')); }}
                  variant="outline"
                  className="flex-1 text-sm"
                >
                  <Calendar className="w-4 h-4 mr-2" />
                  Calendar
                </Button>
              </div>

              <Button
                onClick={() => setIsOpen(false)}
                variant="ghost"
                className="w-full text-slate-500 text-xs"
              >
                Dismiss - I'll check later
              </Button>
            </CardContent>
          </Card>
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Newspaper, ArrowRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Badge } from '@/components/ui/badge';

export default function LatestNewsWidget({ news = [] }) {
    const navigate = useNavigate();

    const recentNews = news
        .sort((a, b) => {
            try {
                const dateA = new Date(a.publish_date || a.created_date);
                const dateB = new Date(b.publish_date || b.created_date);
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            } catch (e) {
                return 0;
            }
        })
        .slice(0, 4);

    // Show default content if no news available
    const displayNews = recentNews.length > 0 ? recentNews : [
        { id: '1', title: 'Market Intelligence Updates Available', category: 'market_trends' },
        { id: '2', title: 'Industry Analysis Coming Soon', category: 'business_tips' },
        { id: '3', title: 'Technology Integration Guides', category: 'technology' },
        { id: '4', title: 'Local Market Insights', category: 'local_market' }
    ];

    const showDataNotice = news.length === 0;

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Newspaper className="w-4 h-4 text-rose-500" />
                    Latest News
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('News'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {showDataNotice && (
                    <div className="mb-2 p-2 bg-amber-100/50 dark:bg-amber-900/20 border border-amber-300/50 dark:border-amber-700/30 rounded text-xs text-amber-800 dark:text-amber-200">
                        Using cached content
                    </div>
                )}
                {displayNews.length > 0 ? (
                    <div className="space-y-1 h-full flex flex-col justify-around">
                        {displayNews.map(article => (
                            <div key={article.id} className="flex items-start justify-between p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50 cursor-pointer" onClick={() => navigate(createPageUrl(`News`))}>
                                <div className="overflow-hidden">
                                    <p className="font-medium text-xs text-slate-800 dark:text-slate-200 truncate">{article.title}</p>
                                    <Badge variant="outline" className="capitalize text-[9px] px-1 py-0 mt-1">{article.category?.replace(/_/g, ' ')}</Badge>
                                </div>
                                <ArrowRight className="w-3.5 h-3.5 text-slate-400 flex-shrink-0 ml-2 mt-1" />
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No news articles.</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Check back for the latest intelligence.</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Target, ArrowRight, Flame } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';

export default function LeadsList({ leads = [] }) {
    const navigate = useNavigate();

    const hotLeads = leads
        .filter(l => (l.score || 0) >= 70 && !['closed', 'lost', 'converted'].includes(l.status))
        .sort((a, b) => {
            try {
                const dateA = new Date(a.created_date);
                const dateB = new Date(b.created_date);
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            } catch (e) {
                return 0;
            }
        })
        .slice(0, 5); // Limit to top 5 hot leads, newest first

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Flame className="w-4 h-4 text-orange-500" />
                    Hot Leads
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('Leads'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {hotLeads.length > 0 ? (
                    <div className="space-y-1 h-full flex flex-col justify-around">
                        {hotLeads.map(lead => (
                            <div key={lead.id} className="flex items-center justify-between p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50">
                                <div className="flex items-center gap-2">
                                    <Avatar className="h-7 w-7">
                                        <AvatarFallback className="bg-orange-100 text-orange-600 font-bold text-[10px]">
                                            {lead.name?.charAt(0) || '?'}
                                        </AvatarFallback>
                                    </Avatar>
                                    <div>
                                        <p className="font-medium text-xs text-slate-800 dark:text-slate-200">{lead.name}</p>
                                        <div className="flex items-center gap-2">
                                            <Badge className="bg-orange-100 text-orange-700 text-[9px] px-1 py-0">{lead.score} Score</Badge>
                                            {lead.lead_type === 'seller' && <Badge className="bg-amber-100 text-amber-700 text-[9px] px-1 py-0">üü° Seller Lead</Badge>}
                                            {lead.lead_type === 'buyer' && <Badge className="bg-blue-100 text-blue-700 text-[9px] px-1 py-0">üîµ Buyer Lead</Badge>}
                                            <span className="text-[10px] text-slate-500">{lead.lead_source}</span>
                                        </div>
                                    </div>
                                </div>
                                <Button variant="ghost" size="icon" onClick={() => navigate(createPageUrl(`Leads?openLead=${lead.id}`))} className="h-6 w-6">
                                    <ArrowRight className="w-3.5 h-3.5" />
                                </Button>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No hot leads right now</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Great time to prospect!</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React, { useState, useEffect } from 'react';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { TrendingUp, TrendingDown, Home, RefreshCw, ArrowUp, ArrowDown, Minus } from 'lucide-react';
import { format } from 'date-fns';
import { toast } from 'sonner';

// Mortgage rate data structure with daily tracking
const getMortgageRatesForDate = (dateStr) => {
    // These would be fetched from an API in production
    // For now, we'll use static data with slight variations
    const baseRates = {
        conforming: [
            { name: 'Conforming 30-Year Fixed', mi: 'BPMI', rate: 6.125, points: 0.875, apr: 6.708 },
            { name: 'FHA 30-Year Fixed', mi: 'MIP', rate: 5.500, points: 1.000, apr: 6.348 },
            { name: 'Conforming 15-Year Fixed', mi: 'BPMI', rate: 5.375, points: 0.750, apr: 5.824 },
            { name: 'FHA 15-Year Fixed', mi: 'MIP', rate: 5.250, points: 0.375, apr: 6.046 }
        ],
        jumbo: [
            { name: 'Jumbo 7-Year/6-Month ARM', mi: null, rate: 5.500, points: 1.000, apr: 6.347 },
            { name: 'Jumbo 30-Year Fixed', mi: null, rate: 6.250, points: 0.875, apr: 6.360 },
            { name: 'Jumbo 15-Year Fixed', mi: null, rate: 6.000, points: 0.875, apr: 6.181 }
        ]
    };
    
    return baseRates;
};

const RateRow = ({ loan, previousRate }) => {
    const rateChange = previousRate ? loan.rate - previousRate : 0;
    const hasIncreased = rateChange > 0;
    const hasDecreased = rateChange < 0;
    const isUnchanged = rateChange === 0;

    return (
        <div className="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors border-b border-slate-100 dark:border-slate-800 last:border-0">
            <div className="flex-1 min-w-0">
                <p className="text-xs font-semibold text-slate-800 dark:text-slate-200 truncate">
                    {loan.name}
                </p>
                {loan.mi && (
                    <p className="text-[10px] text-slate-500 dark:text-slate-400">
                        MI: {loan.mi}
                    </p>
                )}
            </div>
            <div className="grid grid-cols-3 gap-3 text-right ml-3">
                <div>
                    <div className="flex items-center justify-end gap-1">
                        <p className="text-xs font-bold text-blue-600 dark:text-blue-400">
                            {loan.rate.toFixed(3)}%
                        </p>
                        {previousRate && (
                            <>
                                {hasIncreased && (
                                    <ArrowUp className="w-3 h-3 text-red-500" />
                                )}
                                {hasDecreased && (
                                    <ArrowDown className="w-3 h-3 text-green-500" />
                                )}
                                {isUnchanged && (
                                    <Minus className="w-3 h-3 text-slate-400" />
                                )}
                            </>
                        )}
                    </div>
                    <p className="text-[9px] text-slate-500">Rate</p>
                    {previousRate && rateChange !== 0 && (
                        <p className={`text-[8px] ${hasIncreased ? 'text-red-500' : 'text-green-500'}`}>
                            {hasIncreased ? '+' : ''}{rateChange.toFixed(3)}%
                        </p>
                    )}
                </div>
                <div>
                    <p className="text-xs font-medium text-slate-700 dark:text-slate-300">
                        {loan.points.toFixed(3)}
                    </p>
                    <p className="text-[9px] text-slate-500">Points</p>
                </div>
                <div>
                    <p className="text-xs font-medium text-green-600 dark:text-green-400">
                        {loan.apr.toFixed(3)}%
                    </p>
                    <p className="text-[9px] text-slate-500">APR</p>
                </div>
            </div>
        </div>
    );
};

export default function MortgageRatesWidget() {
    const queryClient = useQueryClient();
    const [activeTab, setActiveTab] = useState('conforming');
    const [manualRefresh, setManualRefresh] = useState(0);
    const [currentRates, setCurrentRates] = useState(getMortgageRatesForDate(format(new Date(), 'yyyy-MM-dd')));
    const [previousRates, setPreviousRates] = useState(null);
    const [isRefreshing, setIsRefreshing] = useState(false);

    // Check for 1:00 AM daily update
    useEffect(() => {
        const checkDailyUpdate = () => {
            const now = new Date();
            const lastUpdate = localStorage.getItem('mortgage_rates_last_update');
            const today = format(now, 'yyyy-MM-dd');
            const currentHour = now.getHours();
            
            // Check if we need to update (after 1 AM and haven't updated today)
            if (currentHour >= 1 && lastUpdate !== today) {
                // It's past 1 AM and we haven't updated today - refresh the data
                localStorage.setItem('mortgage_rates_last_update', today);
                setManualRefresh(prev => prev + 1);
            }
        };

        // Check every minute for the 1 AM update window
        const interval = setInterval(checkDailyUpdate, 60000);
        checkDailyUpdate(); // Check immediately on mount

        return () => clearInterval(interval);
    }, []);

    // Load cached rates on mount
    useEffect(() => {
        const cached = localStorage.getItem('mortgage_rates_cache');
        if (cached) {
            try {
                const parsed = JSON.parse(cached);
                if (parsed.current) setCurrentRates(parsed.current);
                if (parsed.previous) setPreviousRates(parsed.previous);
            } catch (e) {
                console.error('Error parsing cached rates:', e);
            }
        }
    }, []);

    const { data: rateData, isLoading, refetch } = useQuery({
        queryKey: ['mortgageRates', manualRefresh],
        queryFn: async () => {
            try {
                const today = format(new Date(), 'yyyy-MM-dd');
                
                // Only use cache if NOT a manual refresh
                if (manualRefresh === 0) {
                    const cached = localStorage.getItem('mortgage_rates_cache');
                    if (cached) {
                        const parsed = JSON.parse(cached);
                        if (parsed.date === today && parsed.data) {
                            console.log('Using cached mortgage rates from today');
                            if (parsed.current) setCurrentRates(parsed.current);
                            if (parsed.previous) setPreviousRates(parsed.previous);
                            return parsed.data;
                        }
                    }
                }

                console.log('Fetching fresh mortgage rates from web...');
                const response = await base44.integrations.Core.InvokeLLM({
                    prompt: `Get the CURRENT mortgage rates in the United States as of today ${today}. 
                    Search for the latest rates from Freddie Mac, Bankrate, or other reliable sources.
                    
                    Provide:
                    1. Current 30-year fixed conforming rate
                    2. Current 15-year fixed conforming rate  
                    3. Current FHA 30-year rate
                    4. Current Jumbo 30-year rate
                    5. The rate from 1 week ago for trend
                    
                    Return JSON in this exact format:
                    {
                        "current_rate": 6.84,
                        "rate_15yr": 6.02,
                        "fha_rate": 6.25,
                        "jumbo_rate": 7.05,
                        "one_week_ago": 6.78,
                        "trend": "up",
                        "source": "Freddie Mac",
                        "last_updated": "2024-11-28"
                    }`,
                    add_context_from_internet: true,
                    response_json_schema: {
                        type: "object",
                        properties: {
                            current_rate: { type: "number" },
                            rate_15yr: { type: "number" },
                            fha_rate: { type: "number" },
                            jumbo_rate: { type: "number" },
                            one_week_ago: { type: "number" },
                            trend: { type: "string" },
                            source: { type: "string" },
                            last_updated: { type: "string" }
                        }
                    }
                });

                if (response) {
                    // Store previous rates before updating
                    const oldCache = localStorage.getItem('mortgage_rates_cache');
                    let oldRates = null;
                    if (oldCache) {
                        const oldParsed = JSON.parse(oldCache);
                        if (oldParsed.current) {
                            oldRates = oldParsed.current;
                            setPreviousRates(oldRates);
                        }
                    }

                    // Build new rates from LLM response
                    const newRates = {
                        conforming: [
                            { name: 'Conforming 30-Year Fixed', mi: 'BPMI', rate: response.current_rate || 6.84, points: 0.875, apr: (response.current_rate || 6.84) + 0.583 },
                            { name: 'FHA 30-Year Fixed', mi: 'MIP', rate: response.fha_rate || 6.25, points: 1.000, apr: (response.fha_rate || 6.25) + 0.848 },
                            { name: 'Conforming 15-Year Fixed', mi: 'BPMI', rate: response.rate_15yr || 6.02, points: 0.750, apr: (response.rate_15yr || 6.02) + 0.449 },
                            { name: 'FHA 15-Year Fixed', mi: 'MIP', rate: (response.fha_rate || 6.25) - 0.25, points: 0.375, apr: (response.fha_rate || 6.25) + 0.546 }
                        ],
                        jumbo: [
                            { name: 'Jumbo 7-Year/6-Month ARM', mi: null, rate: (response.jumbo_rate || 7.05) - 0.75, points: 1.000, apr: (response.jumbo_rate || 7.05) - 0.403 },
                            { name: 'Jumbo 30-Year Fixed', mi: null, rate: response.jumbo_rate || 7.05, points: 0.875, apr: (response.jumbo_rate || 7.05) + 0.11 },
                            { name: 'Jumbo 15-Year Fixed', mi: null, rate: (response.jumbo_rate || 7.05) - 0.25, points: 0.875, apr: (response.jumbo_rate || 7.05) - 0.069 }
                        ]
                    };
                    setCurrentRates(newRates);

                    // Save to cache
                    localStorage.setItem('mortgage_rates_cache', JSON.stringify({
                        date: today,
                        data: response,
                        timestamp: new Date().toISOString(),
                        current: newRates,
                        previous: oldRates
                    }));

                    localStorage.setItem('mortgage_rates_last_date', today);
                }

                return response;
            } catch (error) {
                console.log('Mortgage rates unavailable:', error.message);
                return null;
            }
        },
        staleTime: Infinity,
        cacheTime: 24 * 60 * 60 * 1000,
        retry: false,
        refetchOnWindowFocus: false,
        refetchOnMount: false,
    });

    const trend = rateData?.trend || 'neutral';
    const isUp = trend === 'up';

    const getCacheInfo = () => {
        const cached = localStorage.getItem('mortgage_rates_cache');
        if (cached) {
            const parsed = JSON.parse(cached);
            return {
                date: parsed.date,
                timestamp: parsed.timestamp
            };
        }
        return null;
    };

    const cacheInfo = getCacheInfo();

    const handleRefresh = async () => {
        setIsRefreshing(true);
        toast.info('Fetching latest mortgage rates...');
        
        // Clear cached data to force fresh fetch
        localStorage.removeItem('mortgage_rates_cache');
        localStorage.removeItem('mortgage_rates_last_update');
        
        // Invalidate and refetch
        await queryClient.invalidateQueries({ queryKey: ['mortgageRates'] });
        setManualRefresh(prev => prev + 1);
        
        setTimeout(() => {
            setIsRefreshing(false);
            toast.success('Mortgage rates updated!');
        }, 2000);
    };

    const displayRates = activeTab === 'conforming' ? currentRates.conforming : currentRates.jumbo;
    const displayPreviousRates = previousRates ? (activeTab === 'conforming' ? previousRates.conforming : previousRates.jumbo) : null;

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Home className="w-4 h-4 text-blue-500" />
                    Mortgage Rates
                </CardTitle>
                <Button
                    variant="ghost"
                    size="sm"
                    onClick={handleRefresh}
                    disabled={isLoading || isRefreshing}
                    className="h-7 px-2 text-xs gap-1 hover:bg-blue-50 dark:hover:bg-blue-900/30"
                    title="Click to refresh rates"
                >
                    <RefreshCw className={`w-3.5 h-3.5 ${isLoading || isRefreshing ? 'animate-spin' : ''}`} />
                    {isRefreshing ? 'Updating...' : 'Refresh'}
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow flex flex-col">
                {/* Trend Indicator */}
                {rateData && (
                    <div className="mb-3 flex items-center justify-between p-2 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                        <div className="flex items-center gap-2">
                            {isUp ? (
                                <TrendingUp className="w-4 h-4 text-red-500" />
                            ) : (
                                <TrendingDown className="w-4 h-4 text-green-500" />
                            )}
                            <div>
                                <p className="text-xs font-semibold text-slate-800 dark:text-slate-200">
                                    30-Year Average: {rateData.current_rate.toFixed(3)}%
                                    {rateData.one_week_ago && (
                                        <span className={`ml-2 text-[10px] font-bold ${isUp ? 'text-red-600' : 'text-green-600'}`}>
                                            {isUp ? '‚Üë' : '‚Üì'} {Math.abs(rateData.current_rate - rateData.one_week_ago).toFixed(3)}%
                                        </span>
                                    )}
                                    <span className="ml-2 text-[10px] font-normal text-slate-500">
                                        ({rateData.last_updated || format(new Date(), 'MMM d, yyyy')})
                                    </span>
                                </p>
                                <p className="text-[10px] text-slate-500">
                                    {isUp ? 'Rising' : 'Falling'} trend {rateData.source ? `‚Ä¢ ${rateData.source}` : ''}
                                    {rateData.one_week_ago && (
                                        <span className="ml-1">‚Ä¢ Was {rateData.one_week_ago.toFixed(3)}% last week</span>
                                    )}
                                </p>
                            </div>
                        </div>
                    </div>
                )}

                {/* Tabs */}
                <div className="flex gap-1 mb-3 bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                    <button
                        onClick={() => setActiveTab('conforming')}
                        className={`flex-1 px-3 py-1.5 text-xs font-semibold rounded-md transition-all ${
                            activeTab === 'conforming'
                                ? 'bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 shadow-sm'
                                : 'text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200'
                        }`}
                    >
                        Conforming
                    </button>
                    <button
                        onClick={() => setActiveTab('jumbo')}
                        className={`flex-1 px-3 py-1.5 text-xs font-semibold rounded-md transition-all ${
                            activeTab === 'jumbo'
                                ? 'bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 shadow-sm'
                                : 'text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200'
                        }`}
                    >
                        Jumbo
                    </button>
                </div>

                {/* Updated Date for Tab */}
                {cacheInfo && (
                    <p className="text-[10px] text-slate-400 dark:text-slate-500 text-center mb-2">
                        Updated: {format(new Date(cacheInfo.timestamp), 'MMM d, yyyy h:mma')}
                    </p>
                )}

                {/* Rates List */}
                <div className="flex-grow overflow-y-auto space-y-0 bg-white/50 dark:bg-slate-900/50 rounded-lg p-2">
                    {displayRates.map((loan, index) => {
                        const previousRate = displayPreviousRates ? displayPreviousRates[index]?.rate : null;
                        return (
                            <RateRow key={index} loan={loan} previousRate={previousRate} />
                        );
                    })}
                </div>

                {/* Footer Info */}
                <div className="mt-3 pt-2 border-t border-slate-200 dark:border-slate-700">
                    {cacheInfo ? (
                        <div className="text-center">
                            <p className="text-[10px] text-slate-400 dark:text-slate-500">
                                As of {format(new Date(cacheInfo.timestamp), 'MMM d, h:mma')}
                            </p>
                            <p className="text-[9px] text-slate-400 dark:text-slate-500 mt-0.5">
                                Auto-updates daily at 1:00 AM
                            </p>
                        </div>
                    ) : (
                        <p className="text-[10px] text-slate-400 dark:text-slate-500 text-center">
                            Click refresh to fetch live trend data
                        </p>
                    )}
                </div>
            </CardContent>
        </Card>
    );
}
import React, { useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Target, TrendingUp, AlertTriangle, ArrowRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';

export default function MyGoalsWidget() {
    const navigate = useNavigate();

    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me()
    });

    const { data: teamMembers = [] } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: async () => {
            try {
                return await base44.entities.TeamMember.list() || [];
            } catch (error) {
                return [];
            }
        }
    });

    const { data: goals = [] } = useQuery({
        queryKey: ['performanceGoals'],
        queryFn: async () => {
            try {
                return await base44.entities.PerformanceGoal.list() || [];
            } catch (error) {
                return [];
            }
        }
    });

    // Find my goals
    const myGoals = useMemo(() => {
        if (!user || !teamMembers.length) return [];
        
        const myTeamMember = teamMembers.find(m => m.email === user.email);
        if (!myTeamMember) return [];

        // Get current goals
        const now = new Date();
        return goals.filter(g => {
            if (g.agent_id !== myTeamMember.id) return false;
            const end = new Date(g.period_end);
            return end >= now && g.status !== 'completed';
        });
    }, [goals, teamMembers, user]);

    const getProgressPercentage = (current, target) => {
        if (!target || target === 0) return 0;
        return Math.min(Math.round((current / target) * 100), 100);
    };

    const getStatusColor = (status) => {
        const colors = {
            on_track: 'bg-green-100 text-green-700',
            exceeded: 'bg-blue-100 text-blue-700',
            at_risk: 'bg-yellow-100 text-yellow-700',
            behind: 'bg-red-100 text-red-700'
        };
        return colors[status] || colors.on_track;
    };

    if (myGoals.length === 0) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Target className="w-5 h-5" />
                        My Performance Goals
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <p className="text-sm text-slate-500 dark:text-slate-400">
                        No active goals set. Contact your manager to set performance goals.
                    </p>
                </CardContent>
            </Card>
        );
    }

    const currentGoal = myGoals[0]; // Show the most recent goal

    return (
        <Card>
            <CardHeader>
            <div className="flex justify-between items-center">
                <CardTitle className="flex items-center gap-2">
                    <Target className="w-5 h-5" />
                    My Performance Goals
                </CardTitle>
                    <Badge className={getStatusColor(currentGoal.status)}>
                        {currentGoal.status.replace('_', ' ').toUpperCase()}
                    </Badge>
                </div>
                <p className="text-sm text-slate-500 dark:text-slate-400">
                    {currentGoal.period_type.charAt(0).toUpperCase() + currentGoal.period_type.slice(1)} Goal - 
                    {' '}{new Date(currentGoal.period_start).toLocaleDateString()} to {new Date(currentGoal.period_end).toLocaleDateString()}
                </p>
            </CardHeader>
            <CardContent className="space-y-4">
                {/* Revenue Progress */}
                {currentGoal.revenue_goal > 0 && (
                    <div>
                        <div className="flex justify-between text-sm mb-2">
                            <span className="font-medium">Revenue</span>
                            <span>
                                ${(currentGoal.current_revenue || 0).toLocaleString()} / ${currentGoal.revenue_goal.toLocaleString()}
                            </span>
                        </div>
                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                            <div
                                className="bg-green-500 h-2.5 rounded-full transition-all"
                                style={{ width: `${getProgressPercentage(currentGoal.current_revenue, currentGoal.revenue_goal)}%` }}
                            />
                        </div>
                        <p className="text-xs text-slate-500 mt-1">
                            {getProgressPercentage(currentGoal.current_revenue, currentGoal.revenue_goal)}% complete
                        </p>
                    </div>
                )}

                {/* Deals Progress */}
                {currentGoal.deals_goal > 0 && (
                    <div>
                        <div className="flex justify-between text-sm mb-2">
                            <span className="font-medium">Deals Closed</span>
                            <span>
                                {currentGoal.current_deals || 0} / {currentGoal.deals_goal}
                            </span>
                        </div>
                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                            <div
                                className="bg-blue-500 h-2.5 rounded-full transition-all"
                                style={{ width: `${getProgressPercentage(currentGoal.current_deals, currentGoal.deals_goal)}%` }}
                            />
                        </div>
                    </div>
                )}

                {/* Activities Progress */}
                {currentGoal.activities_goal > 0 && (
                    <div>
                        <div className="flex justify-between text-sm mb-2">
                            <span className="font-medium">Activities</span>
                            <span>
                                {currentGoal.current_activities || 0} / {currentGoal.activities_goal}
                            </span>
                        </div>
                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                            <div
                                className="bg-purple-500 h-2.5 rounded-full transition-all"
                                style={{ width: `${getProgressPercentage(currentGoal.current_activities, currentGoal.activities_goal)}%` }}
                            />
                        </div>
                    </div>
                )}

                {/* AI Insight Alert */}
                {currentGoal.ai_insights && (currentGoal.status === 'at_risk' || currentGoal.status === 'behind') && (
                    <div className="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                        <div className="flex items-start gap-2">
                            <AlertTriangle className="w-4 h-4 text-amber-600 mt-0.5" />
                            <div>
                                <p className="text-xs font-semibold text-amber-800 dark:text-amber-300">
                                    AI Recommendation
                                </p>
                                <p className="text-xs text-amber-700 dark:text-amber-400 mt-1">
                                    {JSON.parse(currentGoal.ai_insights).recommendation}
                                </p>
                            </div>
                        </div>
                    </div>
                )}

                <Button
                    variant="outline"
                    size="sm"
                    className="w-full"
                    onClick={() => navigate(createPageUrl('MyGoals'))}
                >
                    View All My Goals
                    <ArrowRight className="w-4 h-4 ml-2" />
                </Button>
            </CardContent>
        </Card>
    );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Users, ArrowRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { formatDistanceToNow, parseISO } from 'date-fns';

export default function NewBuyersWidget({ buyers = [] }) {
    const navigate = useNavigate();

    const recentBuyers = buyers
        .sort((a, b) => {
            try {
                const dateA = new Date(a.created_date);
                const dateB = new Date(b.created_date);
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            } catch (e) {
                return 0;
            }
        })
        .slice(0, 4);

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Users className="w-4 h-4 text-green-500" />
                    Recent Buyers
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('Buyers'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {recentBuyers.length > 0 ? (
                    <div className="space-y-1 h-full flex flex-col justify-around">
                        {recentBuyers.map(buyer => (
                            <div key={buyer.id} className="flex items-center justify-between p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50 cursor-pointer" onClick={() => navigate(createPageUrl(`BuyerDetail?id=${buyer.id}`))}>
                                <div className="flex items-center gap-2 overflow-hidden">
                                    <Avatar className="h-7 w-7">
                                        <AvatarFallback className="bg-green-100 text-green-600 font-bold text-[10px]">
                                            {buyer.first_name?.charAt(0) || '?'}
                                        </AvatarFallback>
                                    </Avatar>
                                    <div className="overflow-hidden">
                                        <p className="font-medium text-xs text-slate-800 dark:text-slate-200 truncate">{buyer.first_name} {buyer.last_name}</p>
                                        <div className="flex items-center gap-2 text-xs text-slate-500">
                                            <Badge variant="outline" className="capitalize text-[9px] px-1 py-0">{buyer.status}</Badge>
                                            <span className="text-[10px]">added {(() => {
                                                try {
                                                    const date = parseISO(buyer.created_date);
                                                    return isNaN(date.getTime()) ? 'recently' : formatDistanceToNow(date, { addSuffix: true });
                                                } catch (e) {
                                                    return 'recently';
                                                }
                                            })()}</span>
                                        </div>
                                    </div>
                                </div>
                                <ArrowRight className="w-3.5 h-3.5 text-slate-400" />
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No buyers yet.</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Add a buyer to get started.</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Target, ArrowRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Badge } from '@/components/ui/badge';

export default function NewFSBOLeadsWidget({ fsboLeads = [] }) {
    const navigate = useNavigate();

    const newLeads = fsboLeads
        .filter(l => l.status === 'new')
        .sort((a, b) => {
            try {
                const dateA = new Date(a.created_date);
                const dateB = new Date(b.created_date);
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            } catch (e) {
                return 0;
            }
        })
        .slice(0, 4);

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Target className="w-4 h-4 text-cyan-500" />
                    New FSBO Leads
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('FSBO'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {newLeads.length > 0 ? (
                    <div className="space-y-1 h-full flex flex-col justify-around">
                        {newLeads.map(lead => (
                            <div key={lead.id} className="flex items-center justify-between p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50 cursor-pointer" onClick={() => navigate(createPageUrl(`FSBODetail?id=${lead.id}`))}>
                                <div className="overflow-hidden">
                                    <p className="font-medium text-xs text-slate-800 dark:text-slate-200 truncate">{lead.property_address}</p>
                                    <div className="flex items-center gap-2 text-xs text-slate-500">
                                        <p className="text-xs font-bold text-green-600 dark:text-green-400">
                                            {lead.price ? lead.price.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }) : 'N/A'}
                                        </p>
                                        <Badge variant="outline" className="text-[9px] px-1 py-0">{lead.listing_source}</Badge>
                                    </div>
                                </div>
                                <ArrowRight className="w-3.5 h-3.5 text-slate-400 flex-shrink-0" />
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No new FSBO leads.</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Check back later for new leads.</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React, { useMemo } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer } from "recharts";
import { Newspaper, TrendingUp, TrendingDown, Minus, ArrowRight } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { format } from "date-fns";

export default function NewsSentimentWidget({ newsArticles = [] }) {
  const navigate = useNavigate();
  
  const { sentimentValue, emotion, recentHeadlines, chartData, trend } = useMemo(() => {
    // Always return default data structure
    const defaultData = {
      sentimentValue: 64,
      emotion: "Optimism",
      trend: "stable",
      recentHeadlines: [
        { source: "Market Intelligence", title: "Real Estate Market Remains Stable", sentiment: "positive" },
        { source: "Industry News", title: "Technology Integration Continues", sentiment: "positive" },
        { source: "Market Analysis", title: "Moderate Growth Expected", sentiment: "neutral" },
        { source: "Economic Report", title: "Steady Market Conditions", sentiment: "positive" },
      ],
      chartData: []
    };

    if (!newsArticles || newsArticles.length === 0) {
      return defaultData;
    }

    try {
      // Create 12 months of data
      const now = new Date();
      const monthlyData = {};
      
      // Initialize all 12 months with empty arrays
      for (let i = 11; i >= 0; i--) {
        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthKey = format(monthDate, 'yyyy-MM');
        const monthLabel = format(monthDate, 'MMM yy');
        
        monthlyData[monthKey] = {
          monthKey,
          monthLabel,
          values: [],
          date: monthDate
        };
      }
      
      // Add articles to their respective months
      newsArticles.forEach(article => {
        try {
          const articleDate = new Date(article.publish_date || article.created_date);
          const monthKey = format(articleDate, 'yyyy-MM');
          
          if (monthlyData[monthKey]) {
            monthlyData[monthKey].values.push(article.relevance_score || 50);
          }
        } catch (e) {
          console.error("Error processing article:", e);
        }
      });

      // Calculate monthly averages
      const monthlyAverages = Object.values(monthlyData)
        .map(month => ({
          date: format(month.date, 'MMM yy'),
          value: month.values.length > 0 
            ? Math.round(month.values.reduce((a, b) => a + b, 0) / month.values.length)
            : 50,
          sortDate: month.date
        }))
        .sort((a, b) => a.sortDate - b.sortDate);

      const recentArticles = newsArticles.slice(0, 20);
      const avgScore = recentArticles.reduce((sum, a) => sum + (a.relevance_score || 50), 0) / recentArticles.length;

      let emotionLabel = "Optimism";
      if (avgScore < 21) emotionLabel = "Fear";
      else if (avgScore < 41) emotionLabel = "Caution";
      else if (avgScore < 61) emotionLabel = "Neutral";
      else if (avgScore < 81) emotionLabel = "Optimism";
      else emotionLabel = "Euphoria";

      const headlines = newsArticles.slice(0, 4).map(article => ({
        source: article.source || "News",
        title: article.title,
        sentiment: article.relevance_score >= 70 ? "positive" : article.relevance_score >= 40 ? "neutral" : "negative"
      }));

      let trendDirection = "stable";
      if (monthlyAverages.length >= 2) {
        const current = monthlyAverages[monthlyAverages.length - 1].value;
        const previous = monthlyAverages[monthlyAverages.length - 2].value;
        if (current - previous > 5) trendDirection = "up";
        else if (previous - current > 5) trendDirection = "down";
      }

      return {
        sentimentValue: Math.round(avgScore),
        emotion: emotionLabel,
        recentHeadlines: headlines,
        chartData: monthlyAverages,
        trend: trendDirection
      };
    } catch (error) {
      console.error("Error calculating sentiment:", error);
      return defaultData;
    }
  }, [newsArticles]);

  const getColors = () => {
    if (sentimentValue < 21) return { bg: "bg-red-100 dark:bg-red-900/30", text: "text-red-700 dark:text-red-300", accent: "#dc2626", badgeBg: "bg-red-500" };
    if (sentimentValue < 41) return { bg: "bg-orange-100 dark:bg-orange-900/30", text: "text-orange-700 dark:text-orange-300", accent: "#ea580c", badgeBg: "bg-orange-500" };
    if (sentimentValue < 61) return { bg: "bg-yellow-100 dark:bg-yellow-900/30", text: "text-yellow-700 dark:text-yellow-300", accent: "#ca8a04", badgeBg: "bg-yellow-500" };
    if (sentimentValue < 81) return { bg: "bg-emerald-100 dark:bg-emerald-900/30", text: "text-emerald-700 dark:text-emerald-300", accent: "#22c55e", badgeBg: "bg-emerald-500" };
    return { bg: "bg-cyan-100 dark:bg-cyan-900/30", text: "text-cyan-700 dark:text-cyan-300", accent: "#06b6d4", badgeBg: "bg-cyan-500" };
  };

  const getTrendIcon = () => {
    if (trend === "up") return <TrendingUp className="w-3 h-3 text-emerald-500" />;
    if (trend === "down") return <TrendingDown className="w-3 h-3 text-red-500" />;
    return <Minus className="w-3 h-3 text-slate-400" />;
  };

  const getSentimentIndicator = (sentiment) => {
    if (sentiment === "positive") return <div className="w-2 h-2 rounded-full bg-emerald-500" />;
    if (sentiment === "negative") return <div className="w-2 h-2 rounded-full bg-red-500" />;
    return <div className="w-2 h-2 rounded-full bg-slate-400" />;
  };

  const colors = getColors();

  return (
    <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
      <CardHeader className="flex flex-row items-center justify-between p-3">
        <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
          <Newspaper className="w-4 h-4 text-blue-500" />
          News Sentiment
        </CardTitle>
        <Button 
          variant="ghost" 
          size="sm" 
          onClick={() => navigate(createPageUrl('News'))}
          className="text-primary hover:bg-primary/10 h-6 text-xs px-2"
        >
          View All
        </Button>
      </CardHeader>
      
      <CardContent className="p-3 flex-grow flex flex-col gap-3">
        {/* Main Score Display */}
        <div className={`${colors.bg} rounded-lg p-4`}>
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-baseline gap-2">
              <span className={`text-3xl font-bold ${colors.text}`}>{sentimentValue}</span>
              <span className="text-xs text-slate-500 dark:text-slate-400">/ 100</span>
              {getTrendIcon()}
            </div>
            <Badge className={`${colors.badgeBg} text-white text-xs`}>
              {emotion}
            </Badge>
          </div>
          
          {/* Progress Bar */}
          <div className="relative w-full h-2 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
            <div className="absolute inset-0 bg-gradient-to-r from-red-400 via-yellow-400 via-green-400 to-cyan-400 opacity-30" />
            <div 
              className="h-full rounded-full transition-all duration-500"
              style={{ 
                width: `${sentimentValue}%`, 
                backgroundColor: colors.accent 
              }} 
            />
          </div>
          
          {/* Labels */}
          <div className="flex justify-between mt-2 text-[9px] text-slate-500 dark:text-slate-400">
            <span>Fear</span>
            <span>Neutral</span>
            <span>Euphoria</span>
          </div>
        </div>

        {/* Headlines Section */}
        <div className="flex-grow bg-slate-50 dark:bg-slate-800/50 rounded-lg p-3 overflow-y-auto max-h-48">
          <p className="text-[10px] font-medium text-slate-500 dark:text-slate-400 mb-2">Latest Headlines</p>
          <div className="space-y-2">
            {recentHeadlines.slice(0, 3).map((h, i) => (
              <div 
                key={i}
                className="flex items-start gap-2 p-2 rounded-lg bg-white dark:bg-slate-900/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                onClick={() => navigate(createPageUrl('News'))}
              >
                {getSentimentIndicator(h.sentiment)}
                <div className="flex-1 min-w-0">
                  <p className="text-[9px] font-medium text-slate-400 uppercase">{h.source}</p>
                  <p className="text-xs text-slate-700 dark:text-slate-200 line-clamp-2">{h.title}</p>
                </div>
                <ArrowRight className="w-3 h-3 text-slate-400 flex-shrink-0" />
              </div>
            ))}
          </div>
        </div>

        {/* Mini Chart */}
        {chartData.length > 0 && (
          <div className="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-3">
            <p className="text-[10px] font-medium text-slate-500 dark:text-slate-400 mb-2">Trend</p>
            <ResponsiveContainer width="100%" height={60}>
              <AreaChart data={chartData}>
                <defs>
                  <linearGradient id="newsGradient" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor={colors.accent} stopOpacity={0.3}/>
                    <stop offset="95%" stopColor={colors.accent} stopOpacity={0.05}/>
                  </linearGradient>
                </defs>
                <XAxis dataKey="date" hide />
                <YAxis domain={[0, 100]} hide />
                <Area 
                  type="monotone" 
                  dataKey="value" 
                  stroke={colors.accent}
                  strokeWidth={2} 
                  fill="url(#newsGradient)"
                  dot={false}
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        )}

        {/* Info */}
        <p className="text-[10px] text-slate-500 dark:text-slate-400 leading-relaxed">
          üí° Sentiment from industry publications & market commentary
        </p>
      </CardContent>
    </Card>
  );
}
import React, { useState, useEffect, useMemo } from 'react';
import { MapContainer, TileLayer, Marker, Popup, useMap, Polyline } from 'react-leaflet';
import L from 'leaflet';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { MapPin, ArrowRight, Briefcase, Navigation, Car, Clock, Loader2, AlertCircle, Edit2, X, Check } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { format, parseISO, startOfDay, endOfDay } from 'date-fns';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import { useNavigate } from 'react-router-dom';

// Fix for default icon issue in Leaflet with bundlers like Webpack
const officeIcon = new L.DivIcon({
  html: `<div class="p-1 bg-gray-700 rounded-full ring-4 ring-gray-500/30 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="w-2.5 h-2.5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg></div>`,
  className: '',
  iconSize: [20, 20],
  iconAnchor: [10, 10]
});

const meetingIcon = new L.DivIcon({
  html: `<div class="p-1 bg-primary rounded-full ring-4 ring-primary/30"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M17.657 16.657L13.414 20.9a1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>`,
  className: '',
  iconSize: [22, 22],
  iconAnchor: [11, 22]
});

const currentLocationIcon = new L.DivIcon({
  html: `<div class="p-2 bg-blue-500 rounded-full ring-4 ring-blue-400/50 animate-pulse"><svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/></svg></div>`,
  className: '',
  iconSize: [28, 28],
  iconAnchor: [14, 14]
});

const FitBounds = ({ bounds }) => {
  const map = useMap();
  useEffect(() => {
    if (bounds && bounds.isValid()) {
      map.flyToBounds(bounds, { padding: [80, 80] });
    }
  }, [map, bounds]);
  return null;
};

const RecenterMap = ({ lat, lng }) => {
  const map = useMap();
  useEffect(() => {
    if (lat && lng) {
      map.setView([lat, lng], map.getZoom());
    }
  }, [map, lat, lng]);
  return null;
};

export default function NextMeetingWidget({ appointments = [], showings = [], openHouses = [], properties = [], currentUser, sharedNextMeeting }) {
  const navigate = useNavigate();
  const [currentLocation, setCurrentLocation] = useState(null);
  const [isMobile, setIsMobile] = useState(false);
  const [locationError, setLocationError] = useState(null);
  const [isEditingFromAddress, setIsEditingFromAddress] = useState(false);
  const [customFromInput, setCustomFromInput] = useState('');

  const queryClient = useQueryClient();

  // Detect mobile device
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
    };
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // Get current GPS location (now always active if available, not just mobile)
  useEffect(() => {
    if ('geolocation' in navigator) { 
      const watchId = navigator.geolocation.watchPosition(
        (position) => {
          setCurrentLocation({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
          setLocationError(null);
        },
        (error) => {
          // Only log permission denied, ignore timeout and other errors
          if (error.code === error.PERMISSION_DENIED) {
            console.log('Location permission denied'); // Changed from console.debug to console.log
            setLocationError('Location access denied');
          } else {
            // Silently handle timeout and other errors by not setting an error state
            // console.warn('Geolocation error:', error.message);
            setLocationError(null); 
          }
        },
        {
          enableHighAccuracy: false, // Changed to false for better battery life and quicker fix
          timeout: 30000, // Increased to 30 seconds to avoid frequent timeout errors
          maximumAge: 600000 // Accept location up to 10 minutes old
        }
      );

      return () => navigator.geolocation.clearWatch(watchId);
    }
  }, []);

  // Update custom from address mutation
  const updateFromAddressMutation = useMutation({
    mutationFn: async (address) => {
      if (!address || address.trim() === '') {
        // Clear custom address
        await base44.auth.updateMe({
          custom_from_address: null,
          custom_from_lat: null,
          custom_from_lng: null
        });
        return null;
      }

      // Geocode the address
      try {
        const geocoded = await base44.integrations.Core.InvokeLLM({
          prompt: `Using Google Maps' geocoding, what is the precise latitude and longitude for the following address: "${address}"? Respond ONLY with a JSON object.`,
          add_context_from_internet: true,
          response_json_schema: {
            type: "object",
            properties: { "lat": { "type": "number" }, "lng": { "type": "number" } },
            required: ["lat", "lng"]
          }
        });

        if (geocoded && typeof geocoded.lat === 'number' && typeof geocoded.lng === 'number') {
          await base44.auth.updateMe({
            custom_from_address: address,
            custom_from_lat: geocoded.lat,
            custom_from_lng: geocoded.lng
          });
          return { address, ...geocoded };
        }
        throw new Error("Could not geocode address");
      } catch (e) {
        throw new Error("Failed to geocode address. Please check the address and try again.");
      }
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['user'] });
      if (data) {
        toast.success("From address saved!");
      } else {
        toast.success("From address cleared!");
      }
      setIsEditingFromAddress(false);
      setCustomFromInput('');
    },
    onError: (error) => {
      toast.error(error.message || "Failed to save address");
    }
  });

  const handleSaveFromAddress = () => {
    updateFromAddressMutation.mutate(customFromInput);
  };

  const handleClearFromAddress = () => {
    updateFromAddressMutation.mutate('');
  };

  // Determine the "from" location priority: current GPS > custom address > office (for calculation)
  const fromLocation = useMemo(() => {
    // Priority 1: Current GPS location (most accurate real-time location)
    if (currentLocation) {
      return { ...currentLocation, type: 'gps', address: 'Your Current Location' };
    }
    // Priority 2: User-defined custom location
    if (currentUser?.custom_from_address && typeof currentUser?.custom_from_lat === 'number' && typeof currentUser?.custom_from_lng === 'number') {
      return {
        lat: currentUser.custom_from_lat,
        lng: currentUser.custom_from_lng,
        address: currentUser.custom_from_address,
        type: 'custom'
      };
    }
    // Priority 3: Falls back to officeLocation (handled separately)
    return null;
  }, [currentUser, currentLocation]);

  const { data: officeLocation, error: officeError, isLoading: isLoadingLocation } = useQuery({
    queryKey: ['officeLocationGeocode', currentUser?.default_office_location, currentUser?.company_office_address, currentUser?.private_office_address],
    queryFn: async () => {
        // Check which office location is the default
        const usePrivate = currentUser?.default_office_location === 'private';
        
        let address;
        
        if (usePrivate) {
            address = currentUser?.private_office_address;
        } else {
            address = currentUser?.company_office_address;
        }

        // If no address, throw error
        if (!address) {
            throw new Error("No office address set in your profile.");
        }
        
        // Use Nominatim OpenStreetMap geocoding API (free, no key needed)
        const encodedAddress = encodeURIComponent(address);
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`, {
            headers: {
                'User-Agent': 'RealtyMind/1.0'
            }
        });
        
        if (!response.ok) {
            throw new Error("Geocoding service unavailable");
        }
        
        const results = await response.json();
        
        if (results && results.length > 0) {
            const lat = parseFloat(results[0].lat);
            const lng = parseFloat(results[0].lon);
            return { lat, lng, address, isPrivate: usePrivate };
        }
        
        throw new Error("Could not find coordinates for this address.");
    },
    enabled: !!currentUser && (!!currentUser.company_office_address || !!currentUser.private_office_address),
    staleTime: 30 * 60 * 1000, // Cache for 30 minutes
    retry: 1,
  });

  // Calculate next meeting locally - use state to persist the value
  const [persistedNextMeeting, setPersistedNextMeeting] = useState(null);
  
  const calculatedNextMeeting = useMemo(() => {
      if (!appointments || !showings || !openHouses || !properties) return null;
      
      const now = new Date();
      const todayStart = startOfDay(now);
      const todayEnd = endOfDay(now);
      
      const allEvents = [
          ...appointments.map(a => {
              try {
                  const eventDate = parseISO(`${a.scheduled_date}T${a.scheduled_time || '00:00:00'}`);
                  if (isNaN(eventDate.getTime())) return null;
                  return {
                      ...a,
                      eventType: 'Appointment',
                      eventDate,
                  };
              } catch (e) {
                  return null;
              }
          }).filter(Boolean),
          ...showings.map(s => {
              try {
                  const property = properties.find(p => p.id === s.property_id);
                  const eventDate = parseISO(`${s.scheduled_date}T${s.scheduled_time || '00:00:00'}`);
                  if (isNaN(eventDate.getTime())) return null;
                  return {
                      ...s,
                      eventType: 'Showing',
                      title: `Showing: ${property?.address || 'Property Viewing'}`,
                      eventDate,
                      location_lat: property?.location_lat,
                      location_lng: property?.location_lng,
                      location_address: property?.address,
                      scheduled_date: s.scheduled_date,
                      scheduled_time: s.scheduled_time,
                  };
              } catch (e) {
                  return null;
              }
          }).filter(Boolean),
          ...openHouses.map(oh => {
              try {
                  const property = properties.find(p => p.id === oh.property_id);
                  const eventDate = parseISO(`${oh.date}T${oh.start_time || '00:00:00'}`);
                  if (isNaN(eventDate.getTime())) return null;
                  return {
                      ...oh,
                      eventType: 'Open House',
                      title: `Open House: ${property?.address || 'Property Viewing'}`,
                      eventDate,
                      scheduled_date: oh.date,
                      scheduled_time: oh.start_time,
                      location_lat: property?.location_lat,
                      location_lng: property?.location_lng,
                      location_address: property?.address,
                  };
              } catch (e) {
                  return null;
              }
          }).filter(Boolean),
      ];

      return allEvents
          .filter(e => {
              return e.eventDate >= now && 
                     e.eventDate >= todayStart && 
                     e.eventDate <= todayEnd &&
                     ((e.location_lat && e.location_lng) || e.location_address);
          })
          .sort((a, b) => a.eventDate.getTime() - b.eventDate.getTime())
          [0];
  }, [appointments, showings, openHouses, properties]);

  // Use sharedNextMeeting from Dashboard if provided, otherwise use calculated
  const nextMeeting = sharedNextMeeting || calculatedNextMeeting;
  
  // Persist the meeting to avoid flickering when data refetches
  useEffect(() => {
    if (nextMeeting) {
      setPersistedNextMeeting(nextMeeting);
    }
  }, [nextMeeting]);
  
  // Use persisted meeting if current is null (data refetching)
  const displayMeeting = nextMeeting || persistedNextMeeting;

  // Geocode meeting location if only address is available
  const { data: meetingLocation, isLoading: isLoadingMeetingLocation } = useQuery({
    queryKey: ['meetingLocationGeocode', displayMeeting?.id, displayMeeting?.location_address],
    queryFn: async () => {
        // If we have coordinates already, use them
        if (displayMeeting?.location_lat && displayMeeting?.location_lng) {
            return {
                lat: displayMeeting.location_lat,
                lng: displayMeeting.location_lng,
                address: displayMeeting.location_address
            };
        }

        if (!displayMeeting?.location_address) {
            return null;
        }

        // Use Base44 InvokeLLM for more reliable geocoding
        try {
            const geocoded = await base44.integrations.Core.InvokeLLM({
                prompt: `Using Google Maps' geocoding, what is the precise latitude and longitude for the following address: "${displayMeeting.location_address}"? Respond ONLY with a JSON object.`,
                add_context_from_internet: true,
                response_json_schema: {
                    type: "object",
                    properties: { "lat": { "type": "number" }, "lng": { "type": "number" } },
                    required: ["lat", "lng"]
                }
            });
    
            if (geocoded && typeof geocoded.lat === 'number' && typeof geocoded.lng === 'number') {
                return { lat: geocoded.lat, lng: geocoded.lng, address: displayMeeting.location_address };
            }
            return null;
        } catch (e) {
            console.error("Geocoding failed:", e);
            return null;
        }
    },
    enabled: !!displayMeeting && (!!displayMeeting.location_address || (!!displayMeeting.location_lat && !!displayMeeting.location_lng)),
    staleTime: 30 * 60 * 1000,
    retry: 1,
  });

  // Calculate straight-line distance - always return something if we have meeting location
  const estimatedDistance = useMemo(() => {
    const startPoint = fromLocation || officeLocation;
    
    // If we have coordinates for both points, calculate precise distance
    if (startPoint?.lat && startPoint?.lng && meetingLocation?.lat && meetingLocation?.lng) {
      const toRadians = (deg) => deg * (Math.PI / 180);
      const R = 6371; // Earth's radius in km
      const dLat = toRadians(meetingLocation.lat - startPoint.lat);
      const dLon = toRadians(meetingLocation.lng - startPoint.lng);
      const a = 
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRadians(startPoint.lat)) * Math.cos(toRadians(meetingLocation.lat)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c;
      
      // Estimate driving time: distance * 1.3 (road factor) / 60 km/h average speed in city
      const estimatedTime = (distance * 1.3) / 60 * 60;
      
      return {
        distance_km: distance.toFixed(1),
        estimated_minutes: Math.round(estimatedTime),
        isPrecise: true
      };
    }
    
    // Fallback: if we have meeting location but no start coordinates yet, show approximate
    if (meetingLocation?.lat && meetingLocation?.lng) {
      // Return a reasonable estimate while waiting for start location
      return {
        distance_km: '15-20',
        estimated_minutes: 25,
        isPrecise: false,
        isLoading: true
      };
    }
    
    return null;
  }, [fromLocation, officeLocation, meetingLocation]);

  const { data: liveTravelTime, isLoading: isLoadingTravelTime, isFetching: isFetchingTravelTime, error: travelTimeError } = useQuery({
    queryKey: ['liveTravelTime', fromLocation?.lat, fromLocation?.lng, officeLocation?.lat, officeLocation?.lng, meetingLocation?.lat, meetingLocation?.lng, 'dashboard-widget'],
    queryFn: async () => {
        // Use fromLocation (custom or GPS) if available, otherwise use office
        const startPoint = fromLocation || officeLocation;
        if (!startPoint || !meetingLocation?.lat || !meetingLocation?.lng) {
            return null;
        }
        
        // Use address for better results
        let startLocation = '';
        let destinationLocation = '';
        
        if (fromLocation?.type === 'gps') {
          startLocation = `${startPoint.lat}, ${startPoint.lng}`;
        } else if (startPoint.address) {
          startLocation = startPoint.address;
        } else {
          startLocation = `${startPoint.lat}, ${startPoint.lng}`;
        }
        
        if (displayMeeting.location_address) {
          destinationLocation = displayMeeting.location_address;
        } else {
          destinationLocation = `${meetingLocation.lat}, ${meetingLocation.lng}`;
        }
        
        try {
            const result = await base44.integrations.Core.InvokeLLM({
                prompt: `Using Google Maps Directions API with CURRENT REAL-TIME TRAFFIC, calculate the driving time and distance:

Start: ${startLocation}
Destination: ${destinationLocation}

CRITICAL REQUIREMENTS:
- Use ACTUAL ROAD ROUTES (highways, streets) - NOT straight line
- Include CURRENT TRAFFIC CONDITIONS (check live traffic now)
- Account for traffic lights, turns, speed limits
- Return REALISTIC driving time a car would take RIGHT NOW

Respond ONLY with JSON: {"travel_time_minutes": number, "distance_km": number}`,
                response_json_schema: {
                    type: "object",
                    properties: { 
                        "travel_time_minutes": { "type": "number" },
                        "distance_km": { "type": "number" }
                    },
                    required: ["travel_time_minutes", "distance_km"]
                },
                add_context_from_internet: true
            });
            
            // Store in localStorage so NextEventBanner can access it
            if (result?.travel_time_minutes && displayMeeting?.id) {
                localStorage.setItem('sharedTravelTime', JSON.stringify({
                    travel_time_minutes: result.travel_time_minutes,
                    distance_km: result.distance_km,
                    timestamp: Date.now(),
                    meetingId: displayMeeting.id
                }));
            }
            
            return result;
        } catch (e) {
            console.error("Failed to fetch live travel time:", e);
            throw e; // Throw to trigger error state
        }
    },
    enabled: !!displayMeeting && !!meetingLocation?.lat && !!meetingLocation?.lng && (!!officeLocation || !!fromLocation),
    refetchInterval: 5 * 60 * 1000,
    staleTime: 2 * 60 * 1000, // Reduce to 2 minutes for fresher traffic data
    retry: 2,
  });

  const canShowMap = useMemo(() => {
    return displayMeeting && meetingLocation && meetingLocation.lat && meetingLocation.lng;
  }, [displayMeeting, meetingLocation]);

  const mapBounds = useMemo(() => {
    if (canShowMap) {
      // Use fromLocation if available, otherwise office
      const startPoint = fromLocation || officeLocation;
      if (startPoint) {
        return L.latLngBounds([
          [startPoint.lat, startPoint.lng],
          [meetingLocation.lat, meetingLocation.lng]
        ]);
      }
    }
    return null;
  }, [officeLocation, fromLocation, meetingLocation, canShowMap]);

  const routeLine = useMemo(() => {
    if (!canShowMap) return null;
    const startPoint = fromLocation || officeLocation;
    if (!startPoint || typeof startPoint.lat !== 'number' || typeof startPoint.lng !== 'number') return null;
    
    return [
      [startPoint.lat, startPoint.lng],
      [meetingLocation.lat, meetingLocation.lng]
    ];
  }, [officeLocation, fromLocation, meetingLocation, canShowMap]);

  const handleGetDirections = () => {
    if (!displayMeeting) return;
    
    // Always prefer address string for Google Maps (more reliable)
    const destination = displayMeeting.location_address 
        ? encodeURIComponent(nextMeeting.location_address)
        : (meetingLocation?.lat && meetingLocation?.lng)
            ? `${meetingLocation.lat},${meetingLocation.lng}`
            : '';
    
    let origin = '';
    // Use fromLocation if available, otherwise office
    const startPoint = fromLocation || officeLocation;
    if (startPoint) {
      // For custom addresses, prioritize using the actual address string over coordinates
      if (startPoint.type === 'custom' && startPoint.address) {
        origin = encodeURIComponent(startPoint.address);
      } 
      // For GPS location, use coordinates for real-time accuracy
      else if (startPoint.type === 'gps') {
        origin = `${startPoint.lat},${startPoint.lng}`;
      }
      // For office, use address if available, otherwise coordinates
      else if (startPoint.address) {
        origin = encodeURIComponent(startPoint.address);
      } else if (typeof startPoint.lat === 'number' && typeof startPoint.lng === 'number') {
        origin = `${startPoint.lat},${startPoint.lng}`;
      }
    }
    
    const url = `https://www.google.com/maps/dir/${origin}/${destination}`;
    window.open(url, '_blank');
  };

  // Calculate car position percentage based on actual GPS location
  const carPositionPercentage = useMemo(() => {
    // Default to starting point (0%) if no GPS location available
    if (!currentLocation || !meetingLocation?.lat || !meetingLocation?.lng) return 0;
    
    // Start point is the fromLocation or office (where you theoretically started from)
    const startPoint = fromLocation || officeLocation;
    if (!startPoint || typeof startPoint.lat !== 'number' || typeof startPoint.lng !== 'number') return 0;
    
    // Calculate distances using Haversine formula (approximate)
    const toRadians = (deg) => deg * (Math.PI / 180);
    
    const calculateDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371; // Earth's radius in km
      const dLat = toRadians(lat2 - lat1);
      const dLon = toRadians(lon2 - lon1);
      const a = 
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    };
    
    // Distance from current GPS location to the START point
    const distanceToStart = calculateDistance(
      currentLocation.lat,
      currentLocation.lng,
      startPoint.lat, 
      startPoint.lng
    );
    
    // Distance from current GPS location to the DESTINATION
    const distanceToDestination = calculateDistance(
      currentLocation.lat,
      currentLocation.lng,
      meetingLocation.lat, 
      meetingLocation.lng
    );
    
    // Total distance from start to destination
    const totalDistance = calculateDistance(
      startPoint.lat, 
      startPoint.lng, 
      meetingLocation.lat, 
      meetingLocation.lng
    );
    
    // If current location is very close to the start point (within 1 km), show 0%
    if (distanceToStart < 1.0) {
      return 0;
    }
    
    // If current location is very close to the destination (within 1 km), show 100%
    if (distanceToDestination < 1.0) {
      return 100;
    }
    
    // If total distance is very small, default to 0%
    if (totalDistance < 0.1) {
      return 0;
    }
    
    // Calculate progress based on the relationship:
    // We want: Progress = how much of the journey is complete
    // If distanceToStart is small and distanceToDestination is large = near start = low %
    // If distanceToStart is large and distanceToDestination is small = near destination = high %
    
    // Simple formula: what percentage of total distance have we covered from start?
    const distanceCovered = totalDistance - distanceToDestination;
    let percentage = (distanceCovered / totalDistance) * 100;
    
    // If the GPS location doesn't make sense (off route significantly), default to 0%
    // This happens when distanceToStart + distanceToDestination >> totalDistance
    const routeDeviation = (distanceToStart + distanceToDestination) / totalDistance;
    if (routeDeviation > 1.5) {
      // Too far off route, likely haven't started journey yet
      return 0;
    }

    // Ensure between 0 and 100
    return Math.max(0, Math.min(Math.round(percentage), 100));
  }, [currentLocation, fromLocation, officeLocation, meetingLocation]);

  return (
    <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
      <CardHeader className="p-3">
        <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
          <Briefcase className="w-4 h-4 text-cyan-500" />
          {displayMeeting ? 'Next Meeting Travel' : 'Your Current Location'}
        </CardTitle>
      </CardHeader>
      <CardContent className="p-0 flex-grow flex flex-col" style={{ minHeight: '300px' }}>
        {!displayMeeting ? (
          <div className="flex flex-col h-full">
            <div className="flex-grow relative">
                {!currentLocation && !officeLocation && (
                    <div className="absolute inset-0 flex items-center justify-center bg-slate-50/50 dark:bg-slate-900/50 z-10 flex-col gap-2">
                        <Loader2 className="w-6 h-6 animate-spin text-primary" />
                        <p className="text-sm text-slate-600 dark:text-slate-400">Finding your location...</p>
                    </div>
                )}
                 {locationError && !currentLocation && !officeLocation && (
                    <div className="absolute inset-0 flex flex-col items-center justify-center bg-amber-50 dark:bg-amber-900/50 z-10 text-center p-2">
                        <AlertCircle className="w-5 h-5 text-amber-500 mb-1" />
                        <p className="text-xs font-semibold text-amber-700 dark:text-amber-300">Location Unavailable</p>
                        <p className="text-[11px] text-amber-600 dark:text-amber-400">{locationError}</p>
                    </div>
                )}
                {currentLocation ? (
                    <MapContainer
                        key={`current-${currentLocation.lat}-${currentLocation.lng}`}
                        center={[currentLocation.lat, currentLocation.lng]}
                        zoom={16}
                        style={{ height: '100%', width: '100%', borderRadius: '0 0 0.5rem 0.5rem' }}
                        scrollWheelZoom={false}
                        attributionControl={false}
                    >
                        <TileLayer
                            url="https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"
                        />
                        <Marker position={[currentLocation.lat, currentLocation.lng]} icon={currentLocationIcon}>
                            <Popup>Your Current Location</Popup>
                        </Marker>
                        <RecenterMap lat={currentLocation.lat} lng={currentLocation.lng} />
                    </MapContainer>
                ) : officeLocation && (
                    <MapContainer
                        key={`office-${officeLocation.lat}-${officeLocation.lng}`}
                        center={[officeLocation.lat, officeLocation.lng]}
                        zoom={16}
                        style={{ height: '100%', width: '100%', borderRadius: '0 0 0.5rem 0.5rem' }}
                        scrollWheelZoom={false}
                        attributionControl={false}
                    >
                        <TileLayer
                            url="https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"
                        />
                        <Marker position={[officeLocation.lat, officeLocation.lng]} icon={officeIcon}>
                            <Popup>{officeLocation.address}</Popup>
                        </Marker>
                        <RecenterMap lat={officeLocation.lat} lng={officeLocation.lng} />
                    </MapContainer>
                )}
            </div>
            <div className="p-3 border-t border-slate-200/50 dark:border-slate-700/50 text-center">
                 <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No Upcoming Meetings</p>
                 <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                    {currentLocation ? 'Showing your current location' : (officeLocation?.isPrivate ? 'Private Office' : 'Company Office') + ': ' + (officeLocation?.address || 'Your schedule is clear for now.')}
                 </p>
            </div>
          </div>
        ) : (
          <div className="flex flex-col h-full">
            <div className="px-3 pt-2 pb-1 border-b border-slate-200/50 dark:border-slate-700/50 space-y-1">
                {/* Title and location on one line */}
                <div className="flex items-start gap-1.5">
                    <p className="font-semibold text-sm text-slate-800 dark:text-slate-200 flex-1 line-clamp-1">{displayMeeting.title}</p>
                    <Clock className="w-3 h-3 text-slate-400 flex-shrink-0 mt-0.5" />
                    <span className="text-xs text-slate-600 dark:text-slate-400 font-medium">{displayMeeting.scheduled_time}</span>
                </div>
                
                {/* Location - compact */}
                {displayMeeting.location_address && (
                    <p className="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1 line-clamp-1">
                        <MapPin className="w-3 h-3 text-primary flex-shrink-0" />
                        {displayMeeting.location_address}
                    </p>
                )}
                
                {/* Travel time - compact inline */}
                <div className="flex items-center gap-3 text-xs">
                    <div className="flex items-center gap-1">
                        <Car className="w-3 h-3 text-slate-400" />
                        {(isLoadingTravelTime || isFetchingTravelTime) ? (
                            <Loader2 className="w-3 h-3 animate-spin text-primary" />
                        ) : liveTravelTime?.travel_time_minutes ? (
                            <span className="font-semibold text-primary">
                                {Math.round(liveTravelTime.travel_time_minutes)}m ‚Ä¢ {liveTravelTime.distance_km?.toFixed(1)}km
                            </span>
                        ) : estimatedDistance?.isPrecise ? (
                            <span className="text-slate-500">~{estimatedDistance.estimated_minutes}m</span>
                        ) : (
                            <span className="text-slate-400">...</span>
                        )}
                    </div>
                    
                    {/* Depart time */}
                    {liveTravelTime?.travel_time_minutes && displayMeeting.scheduled_time && (
                        <div className="flex items-center gap-1">
                            <Navigation className="w-3 h-3 text-orange-500 flex-shrink-0" />
                            <span className="font-medium text-orange-600 dark:text-orange-400">
                                Leave {(() => {
                                    const [hours, minutes] = displayMeeting.scheduled_time.split(':').map(Number);
                                    const meetingTime = new Date();
                                    meetingTime.setHours(hours, minutes, 0, 0);
                                    meetingTime.setMinutes(meetingTime.getMinutes() - Math.round(liveTravelTime.travel_time_minutes));
                                    return format(meetingTime, 'h:mm a');
                                })()}
                            </span>
                        </div>
                    )}
                </div>
                
                {/* From location - compact */}
                {!isEditingFromAddress ? (
                  <div className="flex items-center gap-1 group">
                    {fromLocation?.type === 'custom' ? (
                        <p className="text-[10px] text-purple-600 dark:text-purple-400 flex-1 truncate">From: {fromLocation.address}</p>
                    ) : fromLocation?.type === 'gps' ? (
                        <p className="text-[10px] text-blue-600 dark:text-blue-400 flex-1">From: Current Location</p>
                    ) : officeLocation ? (
                        <p className="text-[10px] text-slate-500 dark:text-slate-400 flex-1">From: Office</p>
                    ) : null}
                    <Button 
                      variant="ghost" 
                      size="icon" 
                      className="h-4 w-4 opacity-0 group-hover:opacity-100"
                      onClick={() => setIsEditingFromAddress(true)}
                    >
                      <Edit2 className="w-2.5 h-2.5" />
                    </Button>
                    {fromLocation?.type === 'custom' && (
                        <Button 
                          variant="ghost" 
                          size="icon" 
                          className="h-4 w-4 opacity-0 group-hover:opacity-100 text-red-500"
                          onClick={handleClearFromAddress}
                        >
                          <X className="w-2.5 h-2.5" />
                        </Button>
                    )}
                  </div>
                ) : (
                  <div className="flex items-center gap-1">
                    <Input 
                      placeholder="From address..."
                      value={customFromInput}
                      onChange={(e) => setCustomFromInput(e.target.value)}
                      className="h-5 text-[10px] flex-1"
                      autoFocus
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') handleSaveFromAddress();
                        if (e.key === 'Escape') {
                          setIsEditingFromAddress(false);
                          setCustomFromInput('');
                        }
                      }}
                    />
                    <Button 
                      variant="ghost" 
                      size="icon" 
                      className="h-5 w-5"
                      onClick={handleSaveFromAddress}
                      disabled={updateFromAddressMutation.isLoading || !customFromInput.trim()}
                    >
                      {updateFromAddressMutation.isLoading ? (
                        <Loader2 className="w-2.5 h-2.5 animate-spin" />
                      ) : (
                        <Check className="w-2.5 h-2.5" />
                      )}
                    </Button>
                    <Button 
                      variant="ghost" 
                      size="icon" 
                      className="h-5 w-5"
                      onClick={() => {
                        setIsEditingFromAddress(false);
                        setCustomFromInput('');
                      }}
                    >
                      <X className="w-2.5 h-2.5" />
                    </Button>
                  </div>
                )}
            </div>
            
            {currentLocation && (fromLocation || officeLocation) && meetingLocation && (
                <div className="relative bg-gradient-to-r from-blue-500/10 to-cyan-500/10 dark:from-blue-600/20 dark:to-cyan-600/20 px-3 py-1.5 border-b border-slate-200/50 dark:border-slate-700/50">
                    <div className="flex items-center gap-2">
                        <div className="text-sm">üè¢</div>
                        <div className="flex-1 relative h-5 flex items-center">
                            <div className="absolute inset-0 flex items-center">
                                <div className="w-full h-0.5 bg-slate-200 dark:bg-slate-700 rounded-full"></div>
                            </div>
                            <div className="absolute inset-0 flex items-center">
                                <div 
                                    className="h-0.5 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full transition-all duration-1000" 
                                    style={{ width: `${carPositionPercentage}%` }}
                                ></div>
                            </div>
                            <div 
                                className="absolute text-sm transition-all duration-1000" 
                                style={{ 
                                    left: `${carPositionPercentage}%`, 
                                    transform: 'translateX(-50%)',
                                    animation: carPositionPercentage > 0 && carPositionPercentage < 100 ? 'bounce 2s infinite' : 'none'
                                }}
                            >
                                üöó
                            </div>
                        </div>
                        <MapPin className="w-3 h-3 text-primary" />
                    </div>
                </div>
            )}

            <div className="flex-grow relative">
               {isLoadingMeetingLocation && !canShowMap && (
                   <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-50/50 dark:bg-slate-900/50 z-10 gap-2">
                       <Loader2 className="w-6 h-6 animate-spin text-primary" />
                       <p className="text-xs text-slate-600 dark:text-slate-400">Loading map...</p>
                   </div>
               )}
               {canShowMap ? (
                 <>
                    {officeError && !fromLocation && (
                       <div className="absolute top-2 left-2 right-2 flex items-center gap-2 bg-amber-50 dark:bg-amber-900/50 border border-amber-200 dark:border-amber-700 rounded-lg p-2 z-10">
                           <AlertCircle className="w-4 h-4 text-amber-600 flex-shrink-0" />
                           <p className="text-[10px] text-amber-700 dark:text-amber-300">Set office address in settings for better routes</p>
                       </div>
                   )}
                   <MapContainer
                       center={[meetingLocation.lat, meetingLocation.lng]}
                       zoom={12}
                       style={{ height: '100%', width: '100%', minHeight: '180px', borderRadius: '0 0 0.5rem 0.5rem' }}
                       scrollWheelZoom={false}
                       attributionControl={false}
                   >
                       <TileLayer
                           url="https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"
                       />
                       {routeLine && (
                           <Polyline 
                               positions={routeLine} 
                               color="#3b82f6" 
                               weight={3}
                               dashArray="10, 10"
                               opacity={0.6}
                           />
                       )}
                       <Marker position={[meetingLocation.lat, meetingLocation.lng]} icon={meetingIcon}>
                           <Popup>{meetingLocation.address || displayMeeting.title}</Popup>
                       </Marker>
                       {currentLocation && (
                           <Marker position={[currentLocation.lat, currentLocation.lng]} icon={currentLocationIcon}>
                               <Popup>Your Current Location</Popup>
                           </Marker>
                       )}
                       {fromLocation?.type === 'custom' ? (
                           <Marker position={[fromLocation.lat, fromLocation.lng]} icon={officeIcon}>
                               <Popup>From: {fromLocation.address}</Popup>
                           </Marker>
                       ) : !currentLocation && officeLocation && (
                            <Marker position={[officeLocation.lat, officeLocation.lng]} icon={officeIcon}>
                               <Popup>Your Office: {officeLocation.address}</Popup>
                           </Marker>
                       )}
                       {mapBounds && <FitBounds bounds={mapBounds} />}
                   </MapContainer>
                 </>
               ) : (
                <div className="flex-grow flex flex-col items-center justify-center text-center p-4 bg-slate-50/50 dark:bg-slate-900/50">
                    <MapPin className="w-8 h-8 text-slate-400 mb-2" />
                    <p className="font-medium text-sm text-slate-700 dark:text-slate-300">Geocoding address...</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1 px-4">{displayMeeting.location_address || "Loading..."}</p>
                </div>
               )}
            </div>
             <div className="p-2 border-t border-slate-200/50 dark:border-slate-700/50">
                <Button onClick={handleGetDirections} size="sm" className="w-full bg-primary hover:bg-primary/90">
                    Get Directions <ArrowRight className="w-4 h-4 ml-2" />
                </Button>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { ExternalLink, Plus, X, Edit2, Globe } from 'lucide-react';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';

export default function QuickLinksWidget({ user }) {
  const [links, setLinks] = useState(() => {
    try {
      return JSON.parse(user?.quick_links || '[]');
    } catch {
      return [];
    }
  });
  const [showAddModal, setShowAddModal] = useState(false);
  const [editingLink, setEditingLink] = useState(null);
  const [formData, setFormData] = useState({ name: '', url: '' });

  const saveLinks = async (newLinks) => {
    try {
      await base44.auth.updateMe({ quick_links: JSON.stringify(newLinks) });
      setLinks(newLinks);
      toast.success('Links saved!');
    } catch (error) {
      toast.error('Failed to save links');
    }
  };

  const handleAdd = () => {
    if (!formData.name || !formData.url) {
      toast.error('Please fill in all fields');
      return;
    }

    let url = formData.url;
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      url = 'https://' + url;
    }

    const newLinks = editingLink !== null
      ? links.map((link, idx) => idx === editingLink ? { ...formData, url } : link)
      : [...links, { ...formData, url }];

    saveLinks(newLinks);
    setShowAddModal(false);
    setFormData({ name: '', url: '' });
    setEditingLink(null);
  };

  const handleEdit = (index) => {
    setEditingLink(index);
    setFormData(links[index]);
    setShowAddModal(true);
  };

  const handleDelete = (index) => {
    const newLinks = links.filter((_, idx) => idx !== index);
    saveLinks(newLinks);
  };

  return (
    <>
      <Card className="bg-white/70 dark:bg-slate-800/40 backdrop-blur-xl border border-slate-200/50 dark:border-slate-700/50 rounded-2xl shadow-lg dark:shadow-2xl h-full">
        <CardHeader className="py-4 px-5">
          <CardTitle className="flex items-center justify-between text-lg font-bold text-slate-800 dark:text-white">
            <div className="flex items-center gap-2">
              <Globe className="w-5 h-5 text-blue-500" />
              Quick Links
            </div>
            <Button
              size="sm"
              variant="ghost"
              onClick={() => {
                setEditingLink(null);
                setFormData({ name: '', url: '' });
                setShowAddModal(true);
              }}
              className="h-7 w-7 p-0"
            >
              <Plus className="w-4 h-4" />
            </Button>
          </CardTitle>
        </CardHeader>
        <CardContent className="px-5 pb-5">
          {links.length === 0 ? (
            <div className="text-center py-8 text-slate-500">
              <Globe className="w-12 h-12 mx-auto mb-3 opacity-30" />
              <p className="text-sm">No quick links yet</p>
              <p className="text-xs mt-1">Add your frequently used sites</p>
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-2">
              {links.map((link, idx) => (
                <div
                  key={idx}
                  className="group relative bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-lg p-3 hover:shadow-md transition-all"
                >
                  <a
                    href={link.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="block"
                  >
                    <div className="flex items-center gap-2 mb-1">
                      <ExternalLink className="w-3.5 h-3.5 text-blue-600" />
                      <span className="font-semibold text-sm text-slate-900 dark:text-white truncate">
                        {link.name}
                      </span>
                    </div>
                    <p className="text-xs text-slate-500 truncate">{link.url}</p>
                  </a>
                  <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        handleEdit(idx);
                      }}
                      className="p-1 bg-white dark:bg-slate-600 rounded shadow-sm hover:bg-slate-100"
                    >
                      <Edit2 className="w-3 h-3 text-slate-600 dark:text-slate-300" />
                    </button>
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        handleDelete(idx);
                      }}
                      className="p-1 bg-white dark:bg-slate-600 rounded shadow-sm hover:bg-red-50"
                    >
                      <X className="w-3 h-3 text-red-600" />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      <Dialog open={showAddModal} onOpenChange={setShowAddModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>
              {editingLink !== null ? 'Edit Link' : 'Add Quick Link'}
            </DialogTitle>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label>Name</Label>
              <Input
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="Zillow, MLS, etc."
              />
            </div>
            <div>
              <Label>URL</Label>
              <Input
                value={formData.url}
                onChange={(e) => setFormData({ ...formData, url: e.target.value })}
                placeholder="zillow.com or https://zillow.com"
              />
            </div>
            <div className="flex justify-end gap-2">
              <Button variant="outline" onClick={() => {
                setShowAddModal(false);
                setEditingLink(null);
                setFormData({ name: '', url: '' });
              }}>
                Cancel
              </Button>
              <Button onClick={handleAdd} className="bg-blue-600 hover:bg-blue-700">
                {editingLink !== null ? 'Update' : 'Add'}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </>
  );
}
import React from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Activity, MessageSquare, CheckSquare, Image, Building2 } from "lucide-react";

export default function RecentActivity() {
  // Mock activity data for demonstration
  const activities = [
    {
      id: 1,
      type: "message",
      icon: MessageSquare,
      title: "New message from John Smith",
      description: "Regarding property inspection schedule",
      time: "2 minutes ago",
      color: "text-blue-500"
    },
    {
      id: 2,
      type: "task",
      icon: CheckSquare,
      title: "Task completed",
      description: "Property photos uploaded and approved",
      time: "1 hour ago",
      color: "text-emerald-500"
    },
    {
      id: 3,
      type: "photo",
      icon: Image,
      title: "Photos pending approval",
      description: "123 Main St requires broker review",
      time: "3 hours ago",
      color: "text-amber-500"
    },
    {
      id: 4,
      type: "property",
      icon: Building2,
      title: "New property added",
      description: "456 Oak Avenue listed at $450,000",
      time: "1 day ago",
      color: "text-slate-500"
    }
  ];

  return (
    <Card className="shadow-sm border-0 bg-white/80 backdrop-blur-sm">
      <CardHeader className="pb-4">
        <CardTitle className="flex items-center gap-2 text-slate-900">
          <Activity className="w-5 h-5" />
          Recent Activity
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {activities.map((activity) => {
          const Icon = activity.icon;
          return (
            <div key={activity.id} className="flex items-start gap-3">
              <div className={`p-2 rounded-lg bg-slate-50 ${activity.color}`}>
                <Icon className="w-4 h-4" />
              </div>
              <div className="flex-1 min-w-0">
                <p className="font-medium text-slate-900 text-sm">{activity.title}</p>
                <p className="text-xs text-slate-500 mt-1">{activity.description}</p>
                <p className="text-xs text-slate-400 mt-2">{activity.time}</p>
              </div>
            </div>
          );
        })}
      </CardContent>
    </Card>
  );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { FileText, ArrowRight, AlertTriangle, CheckCircle, Clock } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Badge } from '@/components/ui/badge';
import { formatDistanceToNow, parseISO } from 'date-fns';

export default function RecentDocumentsWidget({ documents = [], properties = [] }) {
    const navigate = useNavigate();

    const recentDocs = documents
        .sort((a, b) => {
            try {
                const dateA = new Date(a.created_date);
                const dateB = new Date(b.created_date);
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            } catch (e) {
                return 0;
            }
        })
        .slice(0, 4);

    const getStatusInfo = (status) => {
        switch (status) {
            case 'pending': return { icon: Clock, className: 'bg-yellow-100 text-yellow-800' };
            case 'approved': return { icon: CheckCircle, className: 'bg-green-100 text-green-800' };
            case 'signed': return { icon: CheckCircle, className: 'bg-blue-100 text-blue-800' };
            case 'archived': return { icon: FileText, className: 'bg-slate-100 text-slate-800' };
            default: return { icon: FileText, className: 'bg-slate-100 text-slate-800' };
        }
    };
    
    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <FileText className="w-4 h-4 text-orange-500" />
                    Recent Documents
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('Documents'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {recentDocs.length > 0 ? (
                    <div className="space-y-1 h-full flex flex-col justify-around">
                        {recentDocs.map(doc => {
                            const property = properties.find(p => p.id === doc.property_id);
                            const statusInfo = getStatusInfo(doc.status);
                            const StatusIcon = statusInfo.icon;
                            
                            return (
                                <div key={doc.id} className="flex items-center justify-between p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50">
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        <StatusIcon className={`w-3.5 h-3.5 flex-shrink-0 ${statusInfo.className.replace('bg-', 'text-')}`} />
                                        <div className="overflow-hidden">
                                            <p className="font-medium text-xs text-slate-800 dark:text-slate-200 truncate">{doc.document_name}</p>
                                            <div className="flex items-center gap-2 text-xs text-slate-500">
                                                <Badge variant="outline" className={`capitalize text-[9px] px-1 py-0`}>{doc.status}</Badge>
                                                {property && <span className="truncate text-[10px]">{property.address}</span>}
                                            </div>
                                        </div>
                                    </div>
                                    <Button variant="ghost" size="icon" onClick={() => navigate(createPageUrl('Documents'))} className="h-6 w-6">
                                        <ArrowRight className="w-3.5 h-3.5" />
                                    </Button>
                                </div>
                            );
                        })}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No documents uploaded yet.</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Upload a document to get started.</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { MessageSquare, ArrowRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import _ from 'lodash';

export default function RecentMessagesWidget({ messages = [], users = [], properties = [], currentUser }) {
    const navigate = useNavigate();

    const unreadThreads = React.useMemo(() => {
        if (!currentUser || !messages.length) return [];
        
        const unread = messages.filter(m => m.recipient_id === currentUser.id && !m.is_read);
        const groupedByThread = _.groupBy(unread, message => {
             const otherUserId = message.sender_id !== currentUser?.id ? message.sender_id : message.recipient_id;
             return `${message.property_id}_${otherUserId}`;
        });

        return Object.values(groupedByThread).map(threadMessages => {
            const latestMessage = _.orderBy(threadMessages, 'created_date', 'desc')[0];
            const otherUser = users.find(u => u.id === latestMessage.sender_id);
            const property = properties.find(p => p.id === latestMessage.property_id);
            return {
                ...latestMessage,
                sender: otherUser,
                property: property,
                unreadCount: threadMessages.length,
            };
        }).sort((a,b) => {
            try {
                const dateA = new Date(a.created_date);
                const dateB = new Date(b.created_date);
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            } catch (e) {
                return 0;
            }
        }).slice(0, 4);

    }, [messages, users, properties, currentUser]);

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className={`flex items-center gap-2 text-lg font-bold ${unreadThreads.length > 0 ? 'animate-[flash_1s_ease-in-out_infinite]' : 'text-slate-800 dark:text-white'}`}>
                    <MessageSquare className={`w-4 h-4 ${unreadThreads.length > 0 ? 'text-red-500' : 'text-indigo-500'}`} />
                    <span className={unreadThreads.length > 0 ? 'text-red-600 dark:text-red-400' : ''}>
                        Unread Messages
                    </span>
                    {unreadThreads.length > 0 && (
                        <Badge variant="destructive" className="ml-1">{unreadThreads.length}</Badge>
                    )}
                </CardTitle>
                <style>{`
                    @keyframes flash {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.3; }
                    }
                `}</style>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('Messages'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {unreadThreads.length > 0 ? (
                    <div className="space-y-1 h-full flex flex-col justify-around">
                        {unreadThreads.map(message => (
                            <div 
                                key={message.id} 
                                className="flex items-center justify-between p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50 cursor-pointer" 
                                onClick={() => navigate(createPageUrl('Messages') + `?highlightMessage=${message.id}`)}
                            >
                                <div className="flex items-center gap-2 overflow-hidden">
                                    <Avatar className="h-7 w-7">
                                        <AvatarFallback className="bg-indigo-100 text-indigo-600 font-bold text-[10px]">
                                            {message.sender?.full_name?.charAt(0) || '?'}
                                        </AvatarFallback>
                                    </Avatar>
                                    <div className="overflow-hidden">
                                        <p className="font-medium text-xs text-slate-800 dark:text-slate-200 truncate">{message.sender?.full_name || 'Unknown Sender'}</p>
                                        <p className="text-[11px] text-slate-500 truncate">{message.property?.address || 'General Message'}</p>
                                        <p className="text-xs text-slate-600 dark:text-slate-400 mt-0.5 truncate">{message.content}</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                   {message.unreadCount > 1 && <Badge variant="destructive" className="h-4 px-1.5 text-[9px]">{message.unreadCount}</Badge>}
                                   <ArrowRight className="w-3.5 h-3.5 text-slate-400" />
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">All caught up!</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">You have no unread messages.</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Home, ArrowRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Badge } from '@/components/ui/badge';
import { formatDistanceToNow, parseISO } from 'date-fns';

export default function RecentPropertiesWidget({ properties = [] }) {
    const navigate = useNavigate();

    // Properties are pre-sorted by updated_date descending from the query
    const recentProperties = properties.slice(0, 3);

    const getStatusClass = (status) => {
        switch (status) {
            case 'active': return 'bg-green-100 text-green-800';
            case 'pending': return 'bg-yellow-100 text-yellow-800';
            case 'sold': return 'bg-blue-100 text-blue-800';
            default: return 'bg-slate-100 text-slate-800';
        }
    };

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Home className="w-4 h-4 text-green-500" />
                    Recent Properties
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('Properties'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {recentProperties.length > 0 ? (
                    <div className="space-y-2 h-full flex flex-col justify-around">
                        {recentProperties.map(prop => (
                            <div key={prop.id} className="flex items-start gap-2 p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50 cursor-pointer transition-colors" onClick={() => navigate(createPageUrl(`PropertyDetail?id=${prop.id}`))}>
                                <img 
                                    src={prop.primary_photo_url || 'https://via.placeholder.com/150x100?text=No+Image'} 
                                    alt={prop.address} 
                                    className="w-20 h-14 object-cover rounded-md"
                                />
                                <div className="flex-1">
                                    <p className="font-semibold text-xs text-slate-800 dark:text-slate-200 line-clamp-1">{prop.address}</p>
                                    <p className="text-xs font-bold text-green-600 dark:text-green-400">
                                        {prop.price ? prop.price.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }) : 'Price not set'}
                                    </p>
                                    <div className="flex items-center gap-2 mt-1">
                                        <Badge className={`capitalize ${getStatusClass(prop.status)} text-[9px] px-1 py-0`}>{prop.status}</Badge>
                                        <p className="text-[10px] text-slate-500">Updated {(() => {
                                            try {
                                                const date = parseISO(prop.updated_date);
                                                return isNaN(date.getTime()) ? 'recently' : formatDistanceToNow(date, { addSuffix: true });
                                            } catch (e) {
                                                return 'recently';
                                            }
                                        })()}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No properties found.</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Add a property to get started.</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Shield, AlertTriangle, ArrowRight, TrendingUp } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { format, parseISO } from 'date-fns';

const severityColors = {
    critical: 'bg-red-600 text-white',
    high: 'bg-orange-600 text-white',
    medium: 'bg-yellow-600 text-white',
    low: 'bg-blue-600 text-white'
};

export default function ScamAlertsWidget() {
    const navigate = useNavigate();

    const { data: alerts = [], isLoading } = useQuery({
        queryKey: ['scamAlerts'],
        queryFn: () => base44.entities.ScamAlert.list('-publish_date', 10),
        initialData: [],
    });

    const recentAlerts = alerts
        .filter(a => a.is_active)
        .slice(0, 4);

    const criticalCount = alerts.filter(a => a.is_active && a.severity === 'critical').length;

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Shield className="w-4 h-4 text-red-500" />
                    Scam Alerts
                    {criticalCount > 0 && (
                        <Badge className="bg-red-600 text-white text-[9px] px-1.5 py-0">
                            {criticalCount} Critical
                        </Badge>
                    )}
                </CardTitle>
                <Button 
                    variant="ghost" 
                    size="sm" 
                    onClick={() => navigate(createPageUrl('ScamAlerts'))} 
                    className="text-primary hover:bg-primary/10 h-6 text-xs px-2"
                >
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {recentAlerts.length > 0 ? (
                    <div className="space-y-1 h-full flex flex-col justify-around">
                        {recentAlerts.map(alert => (
                            <div 
                                key={alert.id} 
                                className="flex items-start justify-between p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50 cursor-pointer transition-colors"
                                onClick={() => navigate(createPageUrl('ScamAlerts'))}
                            >
                                <div className="flex items-start gap-2 overflow-hidden flex-1">
                                    <AlertTriangle className={`w-3.5 h-3.5 flex-shrink-0 mt-0.5 ${
                                        alert.severity === 'critical' ? 'text-red-600' :
                                        alert.severity === 'high' ? 'text-orange-600' :
                                        'text-yellow-600'
                                    }`} />
                                    <div className="overflow-hidden flex-1">
                                        <p className="font-medium text-xs text-slate-800 dark:text-slate-200 truncate">
                                            {alert.title}
                                        </p>
                                        <div className="flex items-center gap-2 mt-0.5 flex-wrap">
                                            <Badge className={`${severityColors[alert.severity]} text-[9px] px-1 py-0`}>
                                                {alert.severity}
                                            </Badge>
                                            {alert.is_trending && (
                                                <Badge variant="outline" className="text-[9px] px-1 py-0 border-orange-500 text-orange-600">
                                                    <TrendingUp className="w-2.5 h-2.5 mr-0.5" />
                                                    Trending
                                                </Badge>
                                            )}
                                            {alert.publish_date && (
                                               <span className="text-[10px] text-slate-500">
                                                   {format(parseISO(alert.publish_date), 'MMM d')}
                                               </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <ArrowRight className="w-3.5 h-3.5 text-slate-400 flex-shrink-0 ml-2" />
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <Shield className="w-8 h-8 text-green-300 mb-2" />
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">All Clear!</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">No active scam alerts</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React, { useMemo } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Share2, TrendingUp, ArrowRight, AlertCircle } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Badge } from '@/components/ui/badge';
import { RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Tooltip, ResponsiveContainer } from 'recharts';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';

const CustomTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
        return (
            <div className="p-3 text-xs bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm rounded-lg border border-slate-200 dark:border-slate-700 shadow-lg">
                <p className="font-bold text-slate-800 dark:text-slate-200 mb-2">{label}</p>
                {payload.map((entry, idx) => (
                    <div key={idx} className="flex items-center justify-between gap-4">
                        <span style={{ color: entry.color }}>{entry.name}:</span>
                        <span className="font-semibold">{entry.value}%</span>
                    </div>
                ))}
            </div>
        );
    }
    return null;
};

export default function SocialMediaRadarWidget({ buyers = [], contacts = [], leads = [], teamMembers = [], properties = [] }) {
    const navigate = useNavigate();

    // Optimize data queries with longer stale times and error handling
    const { data: allContacts = [], error: contactsError } = useQuery({
        queryKey: ['contacts'],
        queryFn: async () => {
            try {
                return await base44.entities.Contact.list('-last_social_analysis', 100);
            } catch (error) {
                console.error('Error loading contacts:', error);
                return [];
            }
        },
        initialData: contacts || [],
        staleTime: 10 * 60 * 1000,
        cacheTime: 30 * 60 * 1000,
        retry: 1,
        refetchOnWindowFocus: false,
        refetchOnMount: false,
    });

    const { data: allLeads = [], error: leadsError } = useQuery({
        queryKey: ['leads'],
        queryFn: async () => {
            try {
                return await base44.entities.Lead.list('-last_social_analysis', 100);
            } catch (error) {
                console.error('Error loading leads:', error);
                return [];
            }
        },
        initialData: leads || [],
        staleTime: 10 * 60 * 1000,
        cacheTime: 30 * 60 * 1000,
        retry: 1,
        refetchOnWindowFocus: false,
        refetchOnMount: false,
    });

    const { data: allBuyers = [], error: buyersError } = useQuery({
        queryKey: ['buyers'],
        queryFn: async () => {
            try {
                return await base44.entities.Buyer.list('-last_social_analysis', 100);
            } catch (error) {
                console.error('Error loading buyers:', error);
                return [];
            }
        },
        initialData: buyers || [],
        staleTime: 10 * 60 * 1000,
        cacheTime: 30 * 60 * 1000,
        retry: 1,
        refetchOnWindowFocus: false,
        refetchOnMount: false,
    });

    const socialMediaData = useMemo(() => {
        // Get all sellers from properties with safe parsing
        const sellers = properties
            .filter(p => p && p.sellers_info)
            .flatMap(p => {
                try {
                    const parsed = JSON.parse(p.sellers_info);
                    return Array.isArray(parsed) ? parsed : [];
                } catch {
                    return [];
                }
            })
            .filter(s => s && typeof s === 'object'); // Ensure valid objects

        // Combine all people with safe type assignment
        const allPeople = [
            ...(allBuyers || []).filter(b => b && typeof b === 'object').map(b => ({ ...b, type: 'buyer' })),
            ...(allContacts || []).filter(c => c && typeof c === 'object').map(c => ({ ...c, type: 'contact' })),
            ...(allLeads || []).filter(l => l && typeof l === 'object').map(l => ({ ...l, type: 'lead' })),
            ...(teamMembers || []).filter(t => t && typeof t === 'object').map(t => ({ ...t, type: 'team' })),
            ...sellers.map(s => ({ ...s, type: 'seller' }))
        ];

        // Count platform usage
        const platformCounts = {
            Facebook: 0,
            Instagram: 0,
            LinkedIn: 0,
            Twitter: 0,
            TikTok: 0,
            YouTube: 0,
            Pinterest: 0
        };

        const typeCounts = {
            buyer: 0,
            seller: 0,
            contact: 0,
            lead: 0,
            team: 0
        };

        let totalWithSocial = 0;

        allPeople.forEach(person => {
            if (!person || !person.social_media_profiles) return;
            
            try {
                const profiles = typeof person.social_media_profiles === 'string' 
                    ? JSON.parse(person.social_media_profiles) 
                    : person.social_media_profiles;

                if (!profiles || typeof profiles !== 'object') return;

                const hasAnyProfile = Object.keys(profiles).length > 0 && 
                    Object.values(profiles).some(url => url && url.length > 0);

                if (hasAnyProfile) {
                    totalWithSocial++;
                    if (person.type && typeCounts.hasOwnProperty(person.type)) {
                        typeCounts[person.type]++;
                    }

                    // Count each platform
                    Object.keys(profiles).forEach(platform => {
                        if (!platform || !profiles[platform]) return;
                        
                        const platformName = platform.charAt(0).toUpperCase() + platform.slice(1);
                        if (platformCounts.hasOwnProperty(platformName)) {
                            platformCounts[platformName]++;
                        }
                    });
                }
            } catch (e) {
                console.error('Error parsing social profiles:', e);
            }
        });

        // Calculate percentages
        const radarData = Object.keys(platformCounts).map(platform => ({
            platform,
            usage: totalWithSocial > 0 ? Math.round((platformCounts[platform] / totalWithSocial) * 100) : 0,
            count: platformCounts[platform]
        }));

        // Calculate audience breakdown
        const audienceBreakdown = Object.keys(typeCounts).map(type => ({
            type: type.charAt(0).toUpperCase() + type.slice(1) + 's',
            count: typeCounts[type],
            percentage: totalWithSocial > 0 ? Math.round((typeCounts[type] / totalWithSocial) * 100) : 0
        })).filter(item => item.count > 0);

        // Find top platforms
        const topPlatforms = [...radarData]
            .sort((a, b) => b.count - a.count)
            .slice(0, 3)
            .filter(p => p.count > 0);

        return {
            radarData,
            totalWithSocial,
            totalPeople: allPeople.length,
            topPlatforms,
            audienceBreakdown,
            platformCounts
        };
    }, [allBuyers, allContacts, allLeads, teamMembers, properties]);

    const coveragePercentage = socialMediaData.totalPeople > 0 
        ? Math.round((socialMediaData.totalWithSocial / socialMediaData.totalPeople) * 100) 
        : 0;

    // Show error state if any query fails - MOVED AFTER ALL HOOKS
    if (contactsError || leadsError || buyersError) {
        return (
            <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800">
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Share2 className="w-5 h-5 text-primary" />
                        Social Media Radar
                    </CardTitle>
                </CardHeader>
                <CardContent className="flex flex-col items-center justify-center py-8">
                    <AlertCircle className="w-12 h-12 text-amber-500 mb-4" />
                    <p className="text-sm text-slate-600 dark:text-slate-400 text-center">
                        Unable to load social media data
                    </p>
                    <p className="text-xs text-slate-500 dark:text-slate-500 mt-2">
                        Please try again later
                    </p>
                </CardContent>
            </Card>
        );
    }

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Share2 className="w-4 h-4 text-cyan-500" />
                    Social Media Analytics
                </CardTitle>
                <Button 
                    variant="ghost" 
                    size="sm" 
                    onClick={() => navigate(createPageUrl('SocialIntelligence'))} 
                    className="text-primary hover:bg-primary/10 h-6 text-xs px-2"
                >
                    View Details
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow flex flex-col">
                {socialMediaData.totalWithSocial > 0 ? (
                    <>
                        {/* Radar Chart */}
                        <div className="flex-grow">
                            <ResponsiveContainer width="100%" height="100%">
                                <RadarChart cx="50%" cy="50%" outerRadius="70%" data={socialMediaData.radarData}>
                                    <defs>
                                        <linearGradient id="socialGradient" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="var(--theme-primary)" stopOpacity={0.8}/>
                                            <stop offset="95%" stopColor="var(--theme-primary)" stopOpacity={0.2}/>
                                        </linearGradient>
                                    </defs>
                                    <PolarGrid stroke="hsl(var(--border) / 0.5)" />
                                    <PolarAngleAxis 
                                        dataKey="platform" 
                                        tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 10, fontWeight: 500 }} 
                                    />
                                    <PolarRadiusAxis 
                                        angle={30} 
                                        domain={[0, 100]} 
                                        tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 9 }}
                                        tickCount={6}
                                    />
                                    <Radar 
                                        name="Usage %" 
                                        dataKey="usage" 
                                        stroke="var(--theme-primary)" 
                                        fill="var(--theme-primary)" 
                                        fillOpacity={0.4}
                                        strokeWidth={2.5} 
                                    />
                                    <Tooltip content={<CustomTooltip />} />
                                </RadarChart>
                            </ResponsiveContainer>
                        </div>

                        {/* Stats Grid */}
                        <div className="mt-3 pt-3 border-t border-slate-200/50 dark:border-slate-700/50 space-y-2">
                            {/* Top Platforms */}
                            <div>
                                <p className="text-[10px] uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1">
                                    Top Platforms
                                </p>
                                <div className="flex flex-wrap gap-1">
                                    {socialMediaData.topPlatforms.map((platform, idx) => (
                                        <div 
                                            key={platform.platform}
                                            className="px-2 py-0.5 rounded-full bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-500/20"
                                        >
                                            <span className="text-xs font-semibold text-cyan-700 dark:text-cyan-300">
                                                {platform.platform}
                                            </span>
                                            <span className="text-[10px] text-slate-600 dark:text-slate-400 ml-1">
                                                {platform.usage}%
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Audience Breakdown */}
                            <div>
                                <p className="text-[10px] uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1">
                                    Audience Breakdown
                                </p>
                                <div className="flex flex-wrap gap-1">
                                    {socialMediaData.audienceBreakdown.map(item => (
                                        <div 
                                            key={item.type}
                                            className="px-2 py-0.5 rounded-full bg-white/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700"
                                        >
                                            <span className="text-xs font-medium text-slate-700 dark:text-slate-300">
                                                {item.type}
                                            </span>
                                            <span className="text-[10px] text-slate-500 dark:text-slate-400 ml-1">
                                                {item.count} ({item.percentage}%)
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Coverage Stats */}
                            <div className="flex items-center justify-between pt-2 border-t border-slate-200/50 dark:border-slate-700/50">
                                <div className="text-center flex-1">
                                    <p className="text-[10px] text-slate-500 dark:text-slate-400">Coverage</p>
                                    <p className="text-sm font-bold text-primary">{coveragePercentage}%</p>
                                </div>
                                <div className="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
                                <div className="text-center flex-1">
                                    <p className="text-[10px] text-slate-500 dark:text-slate-400">Profiles Found</p>
                                    <p className="text-sm font-bold text-green-600 dark:text-green-400">
                                        {socialMediaData.totalWithSocial}/{socialMediaData.totalPeople}
                                    </p>
                                </div>
                            </div>

                            {/* Recommendation */}
                            {socialMediaData.topPlatforms.length > 0 && (
                                <div className="bg-gradient-to-r from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20 border border-cyan-200 dark:border-cyan-800 rounded-lg p-2">
                                    <div className="flex items-start gap-2">
                                        <TrendingUp className="w-3.5 h-3.5 text-cyan-600 dark:text-cyan-400 mt-0.5 shrink-0" />
                                        <div>
                                            <p className="text-[10px] font-semibold text-cyan-900 dark:text-cyan-100">
                                                Advertising Recommendation
                                            </p>
                                            <p className="text-[10px] text-cyan-800 dark:text-cyan-200 mt-0.5">
                                                Focus on {socialMediaData.topPlatforms[0].platform} 
                                                {socialMediaData.topPlatforms[1] && ` and ${socialMediaData.topPlatforms[1].platform}`} 
                                                {' '}where {socialMediaData.topPlatforms[0].usage}% of your audience is active.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <Share2 className="w-12 h-12 text-slate-300 dark:text-slate-600 mb-3" />
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No social media data yet</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1 mb-3">
                            Analyze your contacts to discover where your audience is active
                        </p>
                        <Button 
                            size="sm" 
                            onClick={() => navigate(createPageUrl('SocialIntelligence'))}
                            className="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600"
                        >
                            Start Analysis <ArrowRight className="w-3.5 h-3.5 ml-1" />
                        </Button>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React from "react";
import { Card, CardContent } from "@/components/ui/card";
import { ArrowUpRight } from "lucide-react";

export default function StatsCard({ title, value, icon: Icon, color, change, onClick }) {
    
  return (
    <Card 
        onClick={onClick}
        className={`relative overflow-hidden group cursor-pointer transition-all duration-300 hover:shadow-lg hover:-translate-y-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700`}
    >
        <div className={`absolute top-0 right-0 -mr-8 -mt-8 w-24 h-24 rounded-full transition-all duration-500 group-hover:scale-[10] bg-gradient-to-br ${color} opacity-10 dark:opacity-20`}/>
      
      <CardContent className="p-6 relative z-10">
        <div className="flex items-start justify-between">
          <div className="space-y-1">
            <p className="text-sm font-medium text-slate-500 dark:text-slate-400">{title}</p>
            <p className="text-4xl font-bold text-slate-800 dark:text-white">{value}</p>
          </div>
          <div className={`p-3 rounded-lg bg-gradient-to-br ${color}`}>
            <Icon className="w-6 h-6 text-white" />
          </div>
        </div>
        {change && (
            <div className="flex items-center gap-1 text-sm text-slate-500 dark:text-slate-400 mt-4">
                <ArrowUpRight className="w-4 h-4 text-green-500" />
                <span>{change}</span>
            </div>
        )}
      </CardContent>
    </Card>
  );
}
import React, { useMemo, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Users, Briefcase, Flame, AlertTriangle, ChevronLeft, ChevronRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { startOfMonth, parseISO } from 'date-fns';
import { RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Legend, Tooltip, ResponsiveContainer } from 'recharts';

const agentColors = [
  'var(--theme-primary)', '#82ca9d', '#ffc658', '#ff8042', '#00C49F', '#FFBB28'
];

const CustomTooltip = ({ active, payload, label, currentAgent }) => {
    if (active && payload && payload.length) {
        const agent = currentAgent;
        if (!agent) return null;

        let rawValue = '';
        switch (label) {
            case 'GCI':
                rawValue = agent.commission.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
                break;
            case 'Deals':
                rawValue = `${agent.deals} active`;
                break;
            case 'Leads':
                rawValue = `${agent.hotLeads} hot`;
                break;
            case 'Tasks':
                rawValue = `${agent.overdueTasks} overdue`;
                break;
            default:
                rawValue = payload[0].value;
        }

        return (
            <div className="p-2 text-xs bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm rounded-lg border border-slate-200 dark:border-slate-700 shadow-lg">
                <p className="font-bold text-slate-800 dark:text-slate-200 mb-1">{label}</p>
                <div className="space-y-1">
                    <div className="flex items-center gap-2 justify-between">
                        <span style={{ color: payload[0].color }} className="font-semibold">{agent.name}:</span>
                        <span className="font-medium text-slate-700 dark:text-slate-300">{rawValue}</span>
                    </div>
                </div>
            </div>
        );
    }
    return null;
};

const TeamProformaWidget = ({ teamMembers = [], users = [], transactions = [], leads = [], tasks = [] }) => {
    const navigate = useNavigate();
    const [currentAgentIndex, setCurrentAgentIndex] = useState(0);

    const proformaData = useMemo(() => {
        if (!teamMembers.length || !users.length) return { chartData: [], agents: [] };

        const thisMonthStart = startOfMonth(new Date());
        const userMap = new Map(users.map(u => [u.email, u]));

        const rawAgentData = teamMembers.map(member => {
            const user = userMap.get(member.email);
            if (!user) return null;

            const memberTransactions = transactions.filter(t => t.listing_agent_id === user.id || t.selling_agent_id === user.id);
            
            const closedThisMonth = memberTransactions.filter(t => {
                if (t.status !== 'closed') return false;
                const closingDateStr = t.important_dates?.closing_date || t.updated_date;
                if (!closingDateStr) return false;
                try { 
                    const date = parseISO(closingDateStr);
                    if (isNaN(date.getTime())) return false;
                    return date >= thisMonthStart;
                } catch { return false; }
            });
            
            const commissionThisMonth = closedThisMonth.reduce((sum, t) => {
                let memberCommission = 0;
                if (t.listing_agent_id === user.id) memberCommission += t.listing_net_commission || 0;
                if (t.selling_agent_id === user.id) memberCommission += t.selling_net_commission || 0;
                return sum + memberCommission;
            }, 0);

            const activeDeals = memberTransactions.filter(t => ['active', 'pending'].includes(t.status)).length;
            const hotLeadsCount = leads.filter(l => l.assigned_agent_id === user.id && (l.score || 0) >= 70 && !['closed', 'lost'].includes(l.status)).length;
            const overdueTasksCount = tasks.filter(t => {
                if (t.assigned_to !== user.id || !t.due_date || t.status === 'completed' || t.status === 'cancelled') return false;
                try { 
                    const d = parseISO(t.due_date);
                    if (isNaN(d.getTime())) return false;
                    d.setHours(0,0,0,0); 
                    const today = new Date(); 
                    today.setHours(0,0,0,0); 
                    return d < today;
                } catch { return false; }
            }).length;

            return {
                id: user.id,
                name: user.full_name,
                commission: commissionThisMonth,
                deals: activeDeals,
                hotLeads: hotLeadsCount,
                overdueTasks: overdueTasksCount,
            };
        }).filter(Boolean).sort((a, b) => b.commission - a.commission);

        if (rawAgentData.length === 0) return { chartData: [], agents: [] };

        const maxCommission = Math.max(1, ...rawAgentData.map(a => a.commission));
        const maxDeals = Math.max(1, ...rawAgentData.map(a => a.deals));
        const maxHotLeads = Math.max(1, ...rawAgentData.map(a => a.hotLeads));
        const maxOverdueTasks = Math.max(1, ...rawAgentData.map(a => a.overdueTasks));

        const metrics = [
            { subject: "GCI", metric: 'commission', max: maxCommission, inverted: false },
            { subject: "Deals", metric: 'deals', max: maxDeals, inverted: false },
            { subject: "Leads", metric: 'hotLeads', max: maxHotLeads, inverted: false },
            { subject: "Tasks", metric: 'overdueTasks', max: maxOverdueTasks, inverted: true },
        ];

        const chartData = metrics.map(m => {
            const entry = { subject: m.subject };
            rawAgentData.forEach(agent => {
                const rawValue = agent[m.metric];
                let normalizedValue = (rawValue / m.max) * 100;
                if (m.inverted) {
                    normalizedValue = 100 - normalizedValue;
                }
                entry[agent.id] = normalizedValue < 0 ? 0 : normalizedValue;
            });
            return entry;
        });

        return { chartData, agents: rawAgentData };

    }, [teamMembers, users, transactions, leads, tasks]);

    const currentAgent = proformaData.agents[currentAgentIndex];

    const handleNext = () => {
        setCurrentAgentIndex((prev) => (prev + 1) % proformaData.agents.length);
    };

    const handlePrevious = () => {
        setCurrentAgentIndex((prev) => (prev - 1 + proformaData.agents.length) % proformaData.agents.length);
    };
    
    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Users className="w-4 h-4 text-green-500" />
                    Team Performance
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('TeamMembers'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View Team
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow overflow-hidden flex flex-col">
                {proformaData.agents.length > 0 ? (
                    <>
                        {proformaData.agents.length > 1 && (
                            <div className="flex items-center justify-between mb-2">
                                <Button 
                                    variant="ghost" 
                                    size="icon" 
                                    onClick={handlePrevious}
                                    className="h-7 w-7"
                                >
                                    <ChevronLeft className="w-4 h-4" />
                                </Button>
                                <div className="text-center">
                                    <p className="font-semibold text-sm text-slate-900 dark:text-slate-100">{currentAgent?.name}</p>
                                    <p className="text-[10px] text-slate-500 dark:text-slate-400">
                                        {currentAgentIndex + 1} of {proformaData.agents.length}
                                    </p>
                                </div>
                                <Button 
                                    variant="ghost" 
                                    size="icon" 
                                    onClick={handleNext}
                                    className="h-7 w-7"
                                >
                                    <ChevronRight className="w-4 h-4" />
                                </Button>
                            </div>
                        )}
                        
                        <div className="flex-grow">
                            <ResponsiveContainer width="100%" height="100%">
                                <RadarChart cx="50%" cy="50%" outerRadius="80%" data={proformaData.chartData}>
                                    <defs>
                                        <radialGradient id="radarGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                            <stop offset="0%" stopColor="var(--theme-primary)" stopOpacity={0.1} />
                                            <stop offset="100%" stopColor="var(--theme-primary)" stopOpacity={0} />
                                        </radialGradient>
                                    </defs>
                                    <PolarGrid stroke="hsl(var(--border) / 0.5)" />
                                    <PolarAngleAxis dataKey="subject" tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 11 }} />
                                    <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                                    
                                    <Radar 
                                        name={currentAgent?.name} 
                                        dataKey={currentAgent?.id} 
                                        stroke={agentColors[currentAgentIndex % agentColors.length]} 
                                        fill={agentColors[currentAgentIndex % agentColors.length]} 
                                        fillOpacity={0.3}
                                        strokeWidth={3} 
                                    />

                                    <Tooltip content={<CustomTooltip currentAgent={currentAgent} />} />
                                </RadarChart>
                            </ResponsiveContainer>
                        </div>

                        <div className="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-slate-200/50 dark:border-slate-700/50">
                            <div className="text-center">
                                <p className="text-xs text-slate-500 dark:text-slate-400">GCI</p>
                                <p className="font-bold text-sm text-green-600 dark:text-green-400">
                                    {currentAgent?.commission.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 })}
                                </p>
                            </div>
                            <div className="text-center">
                                <p className="text-xs text-slate-500 dark:text-slate-400">Active Deals</p>
                                <p className="font-bold text-sm text-blue-600 dark:text-blue-400">{currentAgent?.deals}</p>
                            </div>
                            <div className="text-center">
                                <p className="text-xs text-slate-500 dark:text-slate-400">Hot Leads</p>
                                <p className="font-bold text-sm text-orange-600 dark:text-orange-400">{currentAgent?.hotLeads}</p>
                            </div>
                            <div className="text-center">
                                <p className="text-xs text-slate-500 dark:text-slate-400">Overdue Tasks</p>
                                <p className="font-bold text-sm text-red-600 dark:text-red-400">{currentAgent?.overdueTasks}</p>
                            </div>
                        </div>
                    </>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No team members found.</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Add members to see performance.</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
};

export default TeamProformaWidget;
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Calendar, ArrowRight, Home, CheckSquare, Briefcase } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { format, parseISO, startOfDay } from 'date-fns';

const eventConfig = {
    'Showing': { icon: Home, color: 'bg-blue-100 text-blue-600', link: (id) => createPageUrl(`Showings?id=${id}`) },
    'Open House': { icon: Home, color: 'bg-purple-100 text-purple-600', link: (id) => createPageUrl(`OpenHouses?id=${id}`) },
    'Task': { icon: CheckSquare, color: 'bg-red-100 text-red-600', link: (id) => createPageUrl(`Tasks?highlight=${id}`) },
    'Appointment': { icon: Briefcase, color: 'bg-green-100 text-green-600', link: (id) => createPageUrl(`Calendar?highlight=${id}`) },
};

export default function UpcomingEventsWidget({ showings = [], openHouses = [], properties = [], tasks = [], appointments = [] }) {
    const navigate = useNavigate();
    const now = new Date();

    const upcomingShowings = showings
        .filter(s => {
            if (!s.scheduled_date) return false;
            try {
                const date = parseISO(s.scheduled_date);
                return !isNaN(date.getTime()) && date >= startOfDay(now) && s.status !== 'cancelled' && s.status !== 'completed';
            } catch (e) {
                return false;
            }
        })
        .map(s => {
            const property = properties.find(p => p.id === s.property_id);
            try {
                return {
                    id: s.id,
                    type: 'Showing',
                    date: parseISO(`${s.scheduled_date}T${s.scheduled_time || '00:00:00'}`),
                    title: 'Showing',
                    subtitle: property?.address || 'Location TBD',
                };
            } catch (e) {
                return null;
            }
        })
        .filter(Boolean);

    const upcomingOpenHouses = openHouses
        .filter(oh => {
            if (!oh.date) return false;
            try {
                const date = parseISO(oh.date);
                return !isNaN(date.getTime()) && date >= startOfDay(now) && oh.status !== 'cancelled' && oh.status !== 'completed';
            } catch (e) {
                return false;
            }
        })
        .map(oh => {
            const property = properties.find(p => p.id === oh.property_id);
            try {
                return {
                    id: oh.id,
                    type: 'Open House',
                    date: parseISO(`${oh.date}T${oh.start_time || '00:00:00'}`),
                    title: 'Open House',
                    subtitle: property?.address || 'Location TBD',
                };
            } catch (e) {
                return null;
            }
        })
        .filter(Boolean);

    const upcomingTasks = tasks
        .filter(t => {
            if (!t.due_date) return false;
            try {
                const date = parseISO(t.due_date);
                return !isNaN(date.getTime()) && date >= startOfDay(now) && t.status !== 'completed' && t.status !== 'cancelled';
            } catch (e) {
                return false;
            }
        })
        .map(t => {
            const property = properties.find(p => p.id === t.property_id);
            try {
                return {
                    id: t.id,
                    type: 'Task',
                    date: startOfDay(parseISO(t.due_date)),
                    title: t.title,
                    subtitle: property?.address || `Priority: ${t.priority}`,
                    isAllDay: true,
                };
            } catch (e) {
                return null;
            }
        })
        .filter(Boolean);
        
    const upcomingAppointments = appointments
        .filter(a => {
            if (!a.scheduled_date) return false;
            try {
                const date = parseISO(a.scheduled_date);
                return !isNaN(date.getTime()) && date >= startOfDay(now) && a.status !== 'cancelled' && a.status !== 'completed';
            } catch (e) {
                return false;
            }
        })
        .map(a => {
            const property = properties.find(p => p.id === a.property_id);
            try {
                return {
                    id: a.id,
                    type: 'Appointment',
                    date: parseISO(`${a.scheduled_date}T${a.scheduled_time || '00:00:00'}`),
                    title: a.title,
                    subtitle: a.location_address || property?.address || 'No Location',
                };
            } catch (e) {
                return null;
            }
        })
        .filter(Boolean);

    const allUpcomingEvents = [...upcomingShowings, ...upcomingOpenHouses, ...upcomingTasks, ...upcomingAppointments]
        .sort((a, b) => a.date - b.date)
        .slice(0, 4);

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Calendar className="w-4 h-4 text-blue-500" />
                    Upcoming Events
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('Calendar'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View Calendar
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {allUpcomingEvents.length > 0 ? (
                    <div className="space-y-1 h-full flex flex-col justify-around">
                        {allUpcomingEvents.map(event => {
                            const config = eventConfig[event.type];
                            const Icon = config.icon;
                            
                            return (
                                <div key={`${event.type}-${event.id}`} className="flex items-center justify-between p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50">
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        <div className={`w-8 h-8 rounded-md flex flex-col items-center justify-center font-bold shrink-0 ${config.color}`}>
                                            <span className="text-[9px] -mb-1">{(() => {
                                                try {
                                                    return format(event.date, 'MMM');
                                                } catch (e) {
                                                    return '';
                                                }
                                            })()}</span>
                                            <span className="text-base">{(() => {
                                                try {
                                                    return format(event.date, 'd');
                                                } catch (e) {
                                                    return '';
                                                }
                                            })()}</span>
                                        </div>
                                        <div className="overflow-hidden">
                                            <div className="flex items-center gap-1">
                                                <Icon className={`w-3 h-3 shrink-0 ${config.color.replace('bg-', 'text-')}`} />
                                                <p className="font-semibold text-xs text-slate-800 dark:text-slate-200 truncate">{event.title}</p>
                                            </div>
                                            <p className="text-[11px] text-slate-500 line-clamp-1 ml-[18px]">{event.subtitle}</p>
                                            {!event.isAllDay && <p className="text-[11px] text-slate-500 ml-[18px]">{(() => {
                                                try {
                                                    return format(event.date, 'p');
                                                } catch (e) {
                                                    return '';
                                                }
                                            })()}</p>}
                                        </div>
                                    </div>
                                    <Button variant="ghost" size="icon" onClick={() => navigate(config.link(event.id))} className="h-6 w-6">
                                        <ArrowRight className="w-3.5 h-3.5" />
                                    </Button>
                                </div>
                            );
                        })}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No upcoming events.</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Your schedule is clear!</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React, { useMemo } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { TrendingUp, Loader2 } from 'lucide-react';
import { RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Tooltip, ResponsiveContainer } from 'recharts';
import { startOfMonth, parseISO } from 'date-fns';

const CustomTooltip = ({ active, payload, label, rawMetrics }) => {
    if (active && payload && payload.length) {
        const metric = rawMetrics.find(m => m.dimension === label);
        return (
            <div className="p-3 text-xs bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm rounded-lg border border-slate-200 dark:border-slate-700 shadow-lg">
                <p className="font-bold text-slate-800 dark:text-slate-200 mb-2">{label}</p>
                <div className="space-y-1">
                    <div className="flex items-center justify-between gap-4">
                        <span className="text-slate-600 dark:text-slate-400">Score:</span>
                        <span className="font-semibold text-primary">{payload[0].value.toFixed(0)}/100</span>
                    </div>
                    {metric && (
                        <div className="flex items-center justify-between gap-4 pt-1 border-t border-slate-200 dark:border-slate-700">
                            <span className="text-slate-600 dark:text-slate-400">Activity:</span>
                            <span className="font-medium text-slate-700 dark:text-slate-300">{metric.displayValue}</span>
                        </div>
                    )}
                </div>
            </div>
        );
    }
    return null;
};

export default function UserPerformanceWidget({ user, allData }) {
    const performanceData = useMemo(() => {
        if (!user || !allData) return { chartData: [], rawMetrics: [] };

        const thisMonthStart = startOfMonth(new Date());
        const userId = user.id;

        // Calculate raw metrics with safe fallbacks
        const propertiesCount = (allData.properties || []).filter(p => p.created_by === user.email).length;
        const leadsCount = (allData.leads || []).filter(l => l.created_by === user.email || l.assigned_agent_id === userId).length;
        const leadsConverted = (allData.leads || []).filter(l => (l.created_by === user.email || l.assigned_agent_id === userId) && l.status === 'closed').length;
        
        const userTasks = (allData.tasks || []).filter(t => t.assigned_to === userId);
        const completedTasks = userTasks.filter(t => t.status === 'completed').length;
        const taskCompletionRate = userTasks.length > 0 ? (completedTasks / userTasks.length) * 100 : 0;
        
        const transactionsCount = (allData.transactions || []).filter(t => 
            t.listing_agent_id === userId || t.selling_agent_id === userId
        ).length;
        
        const messagesCount = (allData.messages || []).filter(m => m.sender_id === userId).length;
        const campaignsCount = (allData.marketingCampaigns || []).filter(c => c.created_by === user.email).length;
        const documentsCount = (allData.documents || []).filter(d => d.uploaded_by === userId).length;
        
        const showingsCount = (allData.showings || []).filter(s => s.showing_agent_id === userId).length;
        const appointmentsCount = (allData.appointments || []).filter(a => a.agent_id === userId).length;
        const openHousesCount = (allData.openHouses || []).filter(oh => oh.hosting_agent_id === userId).length;
        const engagementTotal = showingsCount + appointmentsCount + openHousesCount;

        // Normalize to 0-100 scale (using reasonable benchmarks for each metric)
        const normalizeScore = (value, benchmark) => {
            const score = Math.min((value / benchmark) * 100, 100);
            return score;
        };

        const rawMetrics = [
            { 
                dimension: 'Properties', 
                score: normalizeScore(propertiesCount, 10),
                displayValue: `${propertiesCount} managed`
            },
            { 
                dimension: 'Leads', 
                score: normalizeScore(leadsCount, 20),
                displayValue: `${leadsCount} total, ${leadsConverted} converted`
            },
            { 
                dimension: 'Tasks', 
                score: taskCompletionRate,
                displayValue: `${completedTasks}/${userTasks.length} completed`
            },
            { 
                dimension: 'Deals', 
                score: normalizeScore(transactionsCount, 5),
                displayValue: `${transactionsCount} transactions`
            },
            { 
                dimension: 'Messages', 
                score: normalizeScore(messagesCount, 50),
                displayValue: `${messagesCount} sent`
            },
            { 
                dimension: 'Marketing', 
                score: normalizeScore(campaignsCount, 5),
                displayValue: `${campaignsCount} campaigns`
            },
            { 
                dimension: 'Documents', 
                score: normalizeScore(documentsCount, 20),
                displayValue: `${documentsCount} uploaded`
            },
            { 
                dimension: 'Engagement', 
                score: normalizeScore(engagementTotal, 30),
                displayValue: `${engagementTotal} activities`
            },
        ];

        const chartData = rawMetrics.map(m => ({
            dimension: m.dimension,
            score: m.score
        }));

        return { chartData, rawMetrics };
    }, [user, allData]);

    if (!user) {
        return (
            <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex items-center justify-center">
                <Loader2 className="w-8 h-8 animate-spin text-primary" />
            </Card>
        );
    }

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <TrendingUp className="w-4 h-4 text-purple-500" />
                    My Performance Radar
                </CardTitle>
            </CardHeader>
            <CardContent className="p-3 flex-grow overflow-hidden">
                {performanceData.chartData.length > 0 ? (
                    <ResponsiveContainer width="100%" height="100%">
                        <RadarChart cx="50%" cy="50%" outerRadius="75%" data={performanceData.chartData}>
                            <defs>
                                <radialGradient id="userPerformanceGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                    <stop offset="0%" stopColor="var(--theme-primary)" stopOpacity={0.3} />
                                    <stop offset="100%" stopColor="var(--theme-primary)" stopOpacity={0} />
                                </radialGradient>
                            </defs>
                            <PolarGrid stroke="hsl(var(--border) / 0.5)" />
                            <PolarAngleAxis 
                                dataKey="dimension" 
                                tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 10, fontWeight: 500 }} 
                            />
                            <PolarRadiusAxis 
                                angle={45} 
                                domain={[0, 100]} 
                                tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 9 }}
                                tickCount={6}
                            />
                            
                            <Radar 
                                name="Performance" 
                                dataKey="score" 
                                stroke="var(--theme-primary)" 
                                fill="var(--theme-primary)" 
                                fillOpacity={0.4}
                                strokeWidth={2.5} 
                            />

                            <Tooltip content={<CustomTooltip rawMetrics={performanceData.rawMetrics} />} />
                        </RadarChart>
                    </ResponsiveContainer>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No activity data yet.</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Start using the app to see your performance.</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React, { useState, useEffect, useMemo } from 'react';
import { Sun, Cloud, CloudRain, CloudSnow, CloudLightning, CloudFog, Moon, Sunrise, Sunset } from 'lucide-react';
import { base44 } from '@/api/base44Client';

export default function WeatherBanner({ weather: weatherProp, children }) {
    const weather = weatherProp;
    const isLoading = false;
    const error = null;

    // Determine time of day
    const timeOfDay = useMemo(() => {
        const now = new Date();
        const hours = now.getHours();
        
        if (weather?.sunrise && weather?.sunset) {
            const sunriseTime = new Date(weather.sunrise);
            const sunsetTime = new Date(weather.sunset);
            const sunriseHour = sunriseTime.getHours();
            const sunsetHour = sunsetTime.getHours();
            
            if (hours < sunriseHour - 1) return 'night';
            if (hours < sunriseHour + 1) return 'sunrise';
            if (hours < 12) return 'morning';
            if (hours < sunsetHour - 1) return 'afternoon';
            if (hours < sunsetHour + 1) return 'sunset';
            return 'night';
        }
        
        // Fallback without sunrise/sunset data
        if (hours < 6) return 'night';
        if (hours < 8) return 'sunrise';
        if (hours < 12) return 'morning';
        if (hours < 17) return 'afternoon';
        if (hours < 20) return 'sunset';
        return 'night';
    }, [weather?.sunrise, weather?.sunset]);

    // Get initial gradient based on time only (stable, won't change after load)
    const [initialGradient] = useState(() => {
        const hours = new Date().getHours();
        let tod = 'afternoon';
        if (hours < 6) tod = 'night';
        else if (hours < 8) tod = 'sunrise';
        else if (hours < 12) tod = 'morning';
        else if (hours < 17) tod = 'afternoon';
        else if (hours < 20) tod = 'sunset';
        else tod = 'night';
        
        switch (tod) {
            case 'night':
                return 'linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%)';
            case 'sunrise':
                return 'linear-gradient(135deg, #f97316 0%, #ea580c 30%, #dc2626 60%, #9333ea 100%)';
            case 'morning':
                return 'linear-gradient(135deg, #0284c7 0%, #0369a1 50%, #075985 100%)';
            case 'afternoon':
                return 'linear-gradient(135deg, #0369a1 0%, #075985 50%, #0c4a6e 100%)';
            case 'sunset':
                return 'linear-gradient(135deg, #ea580c 0%, #dc2626 30%, #be123c 60%, #7c3aed 100%)';
            default:
                return 'linear-gradient(135deg, #0369a1 0%, #075985 100%)';
        }
    });

    // Use the initial gradient always - no changes after weather loads to prevent flashing
    const gradient = initialGradient;

    // Get weather icon
    const WeatherIcon = useMemo(() => {
        const condition = weather?.condition || 'clear';
        const isNight = timeOfDay === 'night';
        
        switch (condition) {
            case 'cloudy':
                return Cloud;
            case 'rainy':
                return CloudRain;
            case 'snowy':
                return CloudSnow;
            case 'stormy':
                return CloudLightning;
            case 'foggy':
                return CloudFog;
            default:
                if (isNight) return Moon;
                if (timeOfDay === 'sunrise') return Sunrise;
                if (timeOfDay === 'sunset') return Sunset;
                return Sun;
        }
    }, [weather?.condition, timeOfDay]);

    // Icon color based on conditions
    const iconColor = useMemo(() => {
        const condition = weather?.condition || 'clear';
        
        if (condition === 'rainy' || condition === 'stormy') return '#94a3b8';
        if (condition === 'cloudy') return '#e2e8f0';
        if (condition === 'snowy') return '#f1f5f9';
        if (timeOfDay === 'night') return '#fcd34d';
        if (timeOfDay === 'sunrise' || timeOfDay === 'sunset') return '#fbbf24';
        return '#fcd34d';
    }, [weather?.condition, timeOfDay]);

    // Text color based on background
    const textColor = useMemo(() => {
        const condition = weather?.condition || 'clear';
        if (condition === 'snowy') return '#1e293b';
        return '#ffffff';
    }, [weather?.condition]);

    // Always render - show time-based banner even without location/weather

    return (
        <div 
            className="relative overflow-hidden"
            style={{ 
                background: gradient,
                minHeight: '48px'
            }}
        >
            {/* Animated background elements */}
            <div className="absolute inset-0 overflow-hidden pointer-events-none">
                {/* Stars for night */}
                {timeOfDay === 'night' && (
                    <>
                        <div className="absolute rounded-full bg-white" style={{ width: '4px', height: '4px', top: '15%', left: '5%', animation: 'twinkle 2s ease-in-out infinite' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '2px', height: '2px', top: '25%', left: '12%', animation: 'twinkle 2s ease-in-out infinite 0.7s' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '4px', height: '4px', top: '10%', left: '20%', animation: 'twinkle 2s ease-in-out infinite 1.2s' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '2px', height: '2px', top: '35%', left: '28%', animation: 'twinkle 2s ease-in-out infinite 0.3s' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '5px', height: '5px', top: '20%', left: '40%', animation: 'twinkle 2s ease-in-out infinite 1.8s' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '2px', height: '2px', top: '30%', left: '50%', animation: 'twinkle 2s ease-in-out infinite 0.5s' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '4px', height: '4px', top: '12%', left: '58%', animation: 'twinkle 2s ease-in-out infinite 2.1s' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '2px', height: '2px', top: '38%', left: '65%', animation: 'twinkle 2s ease-in-out infinite 0.9s' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '4px', height: '4px', top: '18%', left: '75%', animation: 'twinkle 2s ease-in-out infinite 1.5s' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '2px', height: '2px', top: '28%', left: '85%', animation: 'twinkle 2s ease-in-out infinite 0.2s' }} />
                        <div className="absolute rounded-full bg-white" style={{ width: '5px', height: '5px', top: '8%', left: '92%', animation: 'twinkle 2s ease-in-out infinite 1.1s' }} />
                    </>
                )}
                
                {/* Clouds for cloudy or partly cloudy weather */}
                {(weather?.condition === 'cloudy' || weather?.condition === 'partly_cloudy' || weather?.condition === 'partly cloudy') && (
                    <>
                        <Cloud className="absolute text-white/40" style={{ width: '40px', height: '40px', top: '5%', left: '8%', animation: 'floatCloud 12s ease-in-out infinite' }} />
                        <Cloud className="absolute text-white/30" style={{ width: '50px', height: '50px', top: '15%', left: '30%', animation: 'floatCloud 15s ease-in-out infinite', animationDelay: '3s' }} />
                        <Cloud className="absolute text-white/35" style={{ width: '35px', height: '35px', top: '8%', left: '55%', animation: 'floatCloud 10s ease-in-out infinite', animationDelay: '1s' }} />
                        <Cloud className="absolute text-white/25" style={{ width: '45px', height: '45px', top: '20%', left: '78%', animation: 'floatCloud 14s ease-in-out infinite', animationDelay: '5s' }} />
                    </>
                )}

                {/* Sun rays for clear mornings/afternoons */}
                {(weather?.condition === 'clear' && (timeOfDay === 'morning' || timeOfDay === 'afternoon')) && (
                    <div className="absolute right-8 top-1/2 -translate-y-1/2">
                        <div className="w-8 h-8 bg-yellow-300/30 rounded-full blur-md animate-pulse" />
                    </div>
                )}
            </div>

            {/* Content */}
            <div className="relative z-10 flex items-center justify-between px-4 py-2">
                <div className="flex items-center gap-3">
                    <WeatherIcon 
                        className="w-6 h-6 transition-all duration-500" 
                        style={{ color: iconColor }}
                    />
                    <div>
                        <p className="text-sm font-medium" style={{ color: textColor }}>
                            {new Date().toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                month: 'short', 
                                day: 'numeric' 
                            })}
                        </p>
                        <p className="text-xs opacity-90" style={{ color: textColor }}>
                            {weather?.error === 'no_zip' ? (
                                <span className="text-yellow-200">‚ö†Ô∏è Set office zip code in Settings for weather</span>
                            ) : weather?.summary || (timeOfDay === 'night' ? 'Clear Night ‚ú®' : 'Clear Sky ‚òÄÔ∏è')}
                            {weather?.temperature !== null && weather?.temperature !== undefined && ` ‚Ä¢ ${weather.temperature}¬∞F`}
                            {weather?.high_temperature != null && weather?.low_temperature != null && (
                                <span className="ml-1 opacity-80">(High {weather.high_temperature}¬∞ / Low {weather.low_temperature}¬∞)</span>
                            )}
                            {!weather?.error && (weather?.temperature === null || weather?.temperature === undefined) && error && ' ‚Ä¢ Weather unavailable'}
                        </p>
                    </div>
                </div>
                
                {/* Right side: children (controls) or time */}
                <div className="flex items-center gap-3">
                    {children}
                    <div className="text-right">
                        <p className="text-sm font-semibold" style={{ color: textColor }}>
                            {new Date().toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true 
                            })}
                        </p>
                    </div>
                </div>
            </div>

            {/* CSS for animations */}
            <style>{`
                @keyframes float {
                    0%, 100% { transform: translateX(0) translateY(0); }
                    50% { transform: translateX(10px) translateY(-5px); }
                }
                @keyframes floatCloud {
                    0%, 100% { transform: translateX(0) translateY(0); opacity: 0.25; }
                    25% { transform: translateX(15px) translateY(-3px); opacity: 0.35; }
                    50% { transform: translateX(25px) translateY(0); opacity: 0.3; }
                    75% { transform: translateX(10px) translateY(3px); opacity: 0.25; }
                }
                @keyframes twinkle {
                    0%, 100% { opacity: 0.3; transform: scale(1); }
                    50% { opacity: 1; transform: scale(1.2); }
                }
                .animate-twinkle {
                    animation: twinkle 2s ease-in-out infinite;
                }
            `}</style>
        </div>
    );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Sparkles, ArrowRight, Target, TrendingUp } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Badge } from '@/components/ui/badge';
import { isToday } from 'date-fns';

export default function AIAdvisoryPanel({ user }) {
    const navigate = useNavigate();

    const { data: dailyAdvice = [] } = useQuery({
        queryKey: ['dailyAdvice'],
        queryFn: async () => {
            try {
                const advice = await base44.entities.DailyAIAdvice.list();
                return advice || [];
            } catch (error) {
                console.warn('Error fetching daily advice:', error.message);
                return [];
            }
        },
        enabled: !!user,
        staleTime: 2 * 60 * 60 * 1000, // 2 hours
        cacheTime: 4 * 60 * 60 * 1000, // 4 hours
        retry: false,
        refetchOnWindowFocus: false,
        refetchOnMount: false,
        refetchOnReconnect: false,
    });

    // Filter to today's advice for current user
    const todayAdvice = React.useMemo(() => {
        if (!dailyAdvice || dailyAdvice.length === 0) return [];
        
        try {
            const today = new Date().toISOString().split('T')[0];
            
            // First try to find advice for today AND for this user
            let filtered = dailyAdvice.filter(advice => {
                if (!advice || !advice.advice_date) return false;
                const adviceDate = advice.advice_date.includes('T') 
                    ? advice.advice_date.split('T')[0] 
                    : advice.advice_date;
                const matchesUser = !user || advice.user_id === user.id || !advice.user_id;
                return adviceDate === today && matchesUser;
            });
            
            // If no advice for today, show most recent advice
            if (filtered.length === 0) {
                filtered = dailyAdvice
                    .filter(a => a && (!user || a.user_id === user.id || !a.user_id))
                    .sort((a, b) => new Date(b.advice_date) - new Date(a.advice_date))
                    .slice(0, 10);
            }
            
            return filtered;
        } catch (error) {
            console.error("Error filtering advice:", error);
            return [];
        }
    }, [dailyAdvice, user]);

    const pendingAdvice = todayAdvice.filter(a => !a.is_completed);
    const completedAdvice = todayAdvice.filter(a => a.is_completed);

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Sparkles className="w-4 h-4 text-indigo-500" />
                    AI Daily Plan
                </CardTitle>
                <Button 
                    variant="ghost" 
                    size="sm" 
                    onClick={() => navigate(createPageUrl('DailyAdvice'))} 
                    className="text-primary hover:bg-primary/10 h-6 text-xs px-2"
                >
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {todayAdvice.length > 0 ? (
                    <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-2">
                            <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-2">
                                <div className="flex items-center gap-1 mb-1">
                                    <Target className="w-3 h-3 text-blue-600" />
                                    <span className="text-xs font-medium text-blue-900 dark:text-blue-100">Pending</span>
                                </div>
                                <p className="text-xl font-bold text-blue-600">{pendingAdvice.length}</p>
                            </div>
                            <div className="bg-green-50 dark:bg-green-900/20 rounded-lg p-2">
                                <div className="flex items-center gap-1 mb-1">
                                    <TrendingUp className="w-3 h-3 text-green-600" />
                                    <span className="text-xs font-medium text-green-900 dark:text-green-100">Done</span>
                                </div>
                                <p className="text-xl font-bold text-green-600">{completedAdvice.length}</p>
                            </div>
                        </div>

                        <div className="space-y-2 max-h-48 overflow-y-auto">
                            {pendingAdvice.map((advice) => (
                                <div
                                    key={advice.id}
                                    onClick={() => {
                                        // Navigate to DailyAdvice page - clicking there will handle the action
                                        navigate(createPageUrl('DailyAdvice'));
                                    }}
                                    className="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 cursor-pointer transition-all"
                                >
                                    <div className="flex items-start justify-between gap-2">
                                        <div className="flex-1 min-w-0">
                                            <p className="text-xs font-medium text-slate-900 dark:text-white truncate">
                                                {advice.title}
                                            </p>
                                            <p className="text-[10px] text-slate-500 dark:text-slate-400 truncate mt-0.5">
                                                {advice.description?.substring(0, 50) || advice.category}
                                            </p>
                                            <Badge className={`mt-1 text-[9px] px-1 py-0 ${
                                                advice.priority === 'critical' ? 'bg-red-600' :
                                                advice.priority === 'high' ? 'bg-orange-600' :
                                                advice.priority === 'medium' ? 'bg-blue-600' :
                                                'bg-slate-500'
                                            }`}>
                                                {advice.priority}
                                            </Badge>
                                        </div>
                                        <ArrowRight className="w-3 h-3 text-slate-400 flex-shrink-0" />
                                    </div>
                                </div>
                            ))}
                        </div>

                        <Button 
                            onClick={() => navigate(createPageUrl('DailyAdvice'))}
                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs h-8"
                        >
                            View Full Action Plan
                        </Button>
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center py-4">
                        <Sparkles className="w-8 h-8 text-slate-300 mb-2" />
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300 mb-1">No Plan Yet</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mb-3">Generate AI recommendations</p>
                        <Button 
                            onClick={() => navigate(createPageUrl('DailyAdvice'))}
                            size="sm"
                            className="bg-indigo-600 hover:bg-indigo-700 text-xs"
                        >
                            Generate Plan
                        </Button>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React, { useState, useEffect, useRef } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Send, Loader2, X, Maximize2, Minimize2, Mic, Volume2, VolumeX, RefreshCw, Brain, Bell, TrendingUp, DollarSign, Globe } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { toast } from 'sonner';
import { motion } from 'framer-motion';

const SUGGESTED_PROMPTS = [
    { text: "Schedule a meeting", icon: "üìÜ", type: "conversational" },
    { text: "Create a task", icon: "‚úÖ", type: "conversational" },
    { text: "Add a property", icon: "üè†", type: "direct", action: "PropertyAdd" },
    { text: "Add a lead", icon: "üë§", type: "direct", action: "Leads" },
    { text: "Plan your day", icon: "üìÖ", type: "direct", action: "DailyAdvice" },
    { text: "Show my hot leads", icon: "üî•", type: "direct", action: "Leads" },
    { text: "Market Projections", icon: "üìä", type: "market_reach" },
];

const DIRECT_NAVIGATION_TRIGGERS = [
    { keywords: ['hot leads', 'show hot leads', 'view hot leads', 'my hot leads', 'see hot leads', 'leads'], page: 'Leads', filter: 'hot' },
    { keywords: ['show leads', 'view leads', 'my leads', 'all leads', 'see leads'], page: 'Leads' },
    { keywords: ['show tasks', 'view tasks', 'my tasks', 'all tasks', 'see tasks', 'critical tasks', 'tasks'], page: 'Tasks' },
    { keywords: ['show properties', 'view properties', 'my properties', 'all properties', 'see properties', 'properties'], page: 'Properties' },
    { keywords: ['show calendar', 'view calendar', 'my calendar', 'open calendar', 'calendar'], page: 'Calendar' },
    { keywords: ['show transactions', 'view transactions', 'my transactions', 'deals', 'active transactions', 'active deals', 'transactions'], page: 'Transactions' },
    { keywords: ['show contacts', 'view contacts', 'my contacts', 'sphere', 'contacts'], page: 'Contacts' },
    { keywords: ['show messages', 'view messages', 'my messages', 'inbox', 'messages'], page: 'Messages' },
    { keywords: ['show buyers', 'view buyers', 'my buyers', 'buyers'], page: 'Buyers' },
    { keywords: ['show analytics', 'view analytics', 'analytics', 'reports'], page: 'Analytics' },
    { keywords: ['show documents', 'view documents', 'documents'], page: 'Documents' },
    { keywords: ['show photos', 'view photos', 'photos'], page: 'Photos' },
    { keywords: ['show commissions', 'view commissions', 'commissions'], page: 'Commissions' },
    { keywords: ['show open houses', 'view open houses', 'open houses'], page: 'OpenHouses' },
    { keywords: ['show showings', 'view showings', 'showings'], page: 'Showings' },
    { keywords: ['show team', 'view team', 'team members', 'team'], page: 'TeamMembers' },
    { keywords: ['show goals', 'view goals', 'goals', 'my goals'], page: 'MyGoals' },
    { keywords: ['show news', 'view news', 'news'], page: 'News' },
    { keywords: ['show settings', 'view settings', 'settings'], page: 'Settings' },
    { keywords: ['show notifications', 'view notifications', 'notifications'], page: 'Notifications' },
    { keywords: ['show marketing', 'view marketing', 'marketing campaigns', 'campaigns'], page: 'MarketingCampaigns' },
    { keywords: ['show ai insights', 'view ai insights', 'ai insights', 'insights'], page: 'AIInsights' },
    { keywords: ['knowledge base', 'help', 'support'], page: 'KnowledgeBase' },
    { keywords: ['dashboard', 'home'], page: 'Dashboard' },
    { keywords: ['fsbo', 'for sale by owner', 'fsbo leads', 'fsbo page'], page: 'FSBO' },
    { keywords: ['plan your day', 'plan my day', 'daily plan', 'daily advice', 'what should i do today', 'today plan', 'action plan'], page: 'DailyAdvice' },
];

export default function AIAssistant() {
    const [isOpen, setIsOpen] = useState(false);
    const [isExpanded, setIsExpanded] = useState(false);
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [isListening, setIsListening] = useState(false);
    const [isSpeaking, setIsSpeaking] = useState(false);
    const [voiceEnabled, setVoiceEnabled] = useState(true);
    const [conversationHistory, setConversationHistory] = useState([]);
    const [taskType, setTaskType] = useState(null);
    const [conversationId, setConversationId] = useState(null);
    const [conversationStartTime, setConversationStartTime] = useState(null);
    const [learnings, setLearnings] = useState([]);
    const [showMarketReach, setShowMarketReach] = useState(false);
    const [marketPhase, setMarketPhase] = useState(1);
    const [marketPrice, setMarketPrice] = useState(49);
    const messagesEndRef = useRef(null);
    const recognitionRef = useRef(null);
    const synthRef = useRef(null);
    const navigate = useNavigate();

    const { data: userData } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me(),
    });

    const { data: proactiveSuggestions } = useQuery({
        queryKey: ['proactiveSuggestions'],
        queryFn: async () => {
            const [leads, transactions, tasks] = await Promise.all([
                base44.entities.Lead.filter({ status: 'new' }).catch(() => []),
                base44.entities.Transaction.filter({ status: 'active' }).catch(() => []),
                base44.entities.Task.filter({ status: 'pending', priority: 'critical' }).catch(() => [])
            ]);

            const suggestions = [];
            const hotLeads = leads.filter(l => (l.score || 0) >= 70);
            if (hotLeads.length > 0) {
                suggestions.push({
                    type: 'lead',
                    title: `${hotLeads.length} hot leads need attention`,
                    action: "Show my hot leads",
                    directNav: { page: 'Leads', filter: 'hot' }
                });
            }

            const activeTransactions = transactions.filter(t => t.status === 'active');
            if (activeTransactions.length > 0) {
                suggestions.push({
                    type: 'transaction',
                    title: `${activeTransactions.length} active transactions`,
                    action: "Show my active deals",
                    directNav: { page: 'Transactions' }
                });
            }

            const criticalTasks = tasks.filter(t => t.priority === 'critical');
            if (criticalTasks.length > 0) {
                suggestions.push({
                    type: 'task',
                    title: `${criticalTasks.length} critical tasks pending`,
                    action: "Show my critical tasks",
                    directNav: { page: 'Tasks' }
                });
            }

            return suggestions;
        },
        enabled: !!userData && !isOpen,
        refetchInterval: 5 * 60 * 1000,
        staleTime: 3 * 60 * 1000,
    });

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    useEffect(() => {
        const handleOpenJackie = () => {
            handleOpen();
        };
        
        window.addEventListener('openJackie', handleOpenJackie);
        
        return () => {
            window.removeEventListener('openJackie', handleOpenJackie);
            if (synthRef.current) synthRef.current.cancel();
            if (recognitionRef.current) recognitionRef.current.stop();
        };
    }, []);

    const { data: learningsData, refetch: refetchLearnings } = useQuery({
        queryKey: ['jackieLearnings', userData?.id],
        queryFn: async () => {
            if (!userData?.id) return [];
            try {
                return await base44.entities.JackieLearning.filter({ user_id: userData.id, is_active: true });
            } catch (error) {
                return [];
            }
        },
        enabled: !!userData?.id && isOpen,
        staleTime: 30 * 60 * 1000,
        cacheTime: 60 * 60 * 1000,
        retry: false,
        refetchOnWindowFocus: false,
    });

    useEffect(() => {
        if (learningsData) setLearnings(learningsData);
    }, [learningsData]);

    // Track user feedback on responses
    const recordFeedback = async (messageIndex, isHelpful, feedbackNote = '') => {
        if (!userData?.id) return;
        
        const message = messages[messageIndex];
        const previousUserMessage = messages[messageIndex - 1];
        
        try {
            // Find if there's an existing learning for this type of query
            const queryType = detectQueryType(previousUserMessage?.content || '');
            
            const learningData = {
                user_id: userData.id,
                learning_type: isHelpful ? 'pattern' : 'correction',
                category: queryType === 'scheduling' ? 'scheduling' : 
                          queryType === 'property_owner_lookup' ? 'workflow' : 
                          queryType === 'lead_query' ? 'contact' : 'workflow',
                key: `${queryType}_${isHelpful ? 'success' : 'failure'}`,
                value: isHelpful ? 'Response was helpful' : `Response was not helpful: ${feedbackNote || 'No specific feedback'}`,
                confidence: isHelpful ? 70 : 30,
                occurrence_count: 1,
                last_observed: new Date().toISOString(),
                context: JSON.stringify({
                    user_query: previousUserMessage?.content || '',
                    assistant_response: message?.content?.substring(0, 500) || ''
                }),
                is_active: true
            };
            
            await base44.entities.JackieLearning.create(learningData);
            refetchLearnings();
            
            toast.success(isHelpful ? 'Thanks for the feedback!' : 'Got it, I\'ll improve!');
        } catch (error) {
            console.error('Error recording feedback:', error);
        }
    };

    const detectQueryType = (query) => {
        const lowerQuery = (query || '').toLowerCase();
        if (lowerQuery.match(/who owns|owner of|property owner|lookup owner/)) return 'property_owner_lookup';
        if (lowerQuery.match(/schedule|meeting|appointment/)) return 'scheduling';
        if (lowerQuery.match(/create.*task|add.*task/)) return 'task_creation';
        if (lowerQuery.match(/show.*lead|hot lead/)) return 'lead_query';
        if (lowerQuery.match(/what should i do|today|plan/)) return 'daily_planning';
        return 'general';
    };

    const getLearningsContext = () => {
        if (!learnings || learnings.length === 0) return '';
        
        // Get recent learnings grouped by type
        const recentLearnings = learnings
            .sort((a, b) => new Date(b.learned_at) - new Date(a.learned_at))
            .slice(0, 10);
        
        const helpfulPatterns = recentLearnings.filter(l => l.learning_type === 'pattern');
        const unhelpfulPatterns = recentLearnings.filter(l => l.learning_type === 'correction');
        
        let context = '\n\nLEARNINGS FROM PAST INTERACTIONS:\n';
        
        if (unhelpfulPatterns.length > 0) {
            context += 'AVOID these approaches (user found unhelpful):\n';
            unhelpfulPatterns.forEach(l => {
                context += `- For "${l.category}" queries: ${l.value}\n`;
            });
        }
        
        if (helpfulPatterns.length > 0) {
            context += 'REPEAT these successful approaches:\n';
            helpfulPatterns.forEach(l => {
                context += `- For "${l.category}" queries: This approach worked well\n`;
            });
        }
        
        return context;
    };

    useEffect(() => {
        if ('speechSynthesis' in window) synthRef.current = window.speechSynthesis;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognitionRef.current = new SpeechRecognition();
            recognitionRef.current.continuous = false;
            recognitionRef.current.interimResults = false;
            recognitionRef.current.lang = 'en-US';
            recognitionRef.current.onresult = (event) => {
                setInput(event.results[0][0].transcript);
                setIsListening(false);
            };
            recognitionRef.current.onerror = () => setIsListening(false);
            recognitionRef.current.onend = () => setIsListening(false);
        }
    }, []);

    const speak = (text) => {
        if (!synthRef.current || !voiceEnabled) return;
        synthRef.current.cancel();
        const cleanText = text.replace(/[üåÖüö®üìÖüéØüí°üîç‚úÖüë§üìçüí∞üè†üî•‚ö†Ô∏èüìäüéâüìãüìÜ]/g, '').replace(/Navigate to [A-Za-z]+/gi, '').replace(/\*\*/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1').replace(/https?:\/\/[^\s)]+/g, '').replace(/\n+/g, '. ');
        const utterance = new SpeechSynthesisUtterance(cleanText);
        
        // Select a female voice
        const voices = synthRef.current.getVoices();
        const femaleVoice = voices.find(voice => 
            voice.name.includes('Female') || 
            voice.name.includes('Samantha') || 
            voice.name.includes('Victoria') || 
            voice.name.includes('Karen') ||
            voice.name.includes('Google US English Female') ||
            voice.name.includes('Microsoft Zira') ||
            (voice.lang.startsWith('en') && voice.name.toLowerCase().includes('female'))
        ) || voices.find(voice => voice.lang.startsWith('en') && voice.gender === 'female');
        
        if (femaleVoice) {
            utterance.voice = femaleVoice;
        }
        
        utterance.rate = 1.0; // Slightly slower for softer tone
        utterance.pitch = 1.1; // Slightly higher pitch for female voice
        utterance.volume = 0.9; // Softer volume
        utterance.onstart = () => setIsSpeaking(true);
        utterance.onend = () => setIsSpeaking(false);
        utterance.onerror = () => setIsSpeaking(false);
        synthRef.current.speak(utterance);
    };

    const stopSpeaking = () => {
        if (synthRef.current) {
            synthRef.current.cancel();
            setIsSpeaking(false);
        }
    };

    const startListening = () => {
        if (!recognitionRef.current) {
            toast.error('Voice input not supported');
            return;
        }
        if (isListening) {
            recognitionRef.current.stop();
            setIsListening(false);
        } else {
            try {
                recognitionRef.current.start();
                setIsListening(true);
                toast.success('üé§ Listening...');
            } catch (error) {
                toast.error('Could not start listening');
            }
        }
    };

    const checkDirectNavigation = (userInput) => {
        const lowerInput = userInput.toLowerCase().trim();
        for (const trigger of DIRECT_NAVIGATION_TRIGGERS) {
            if (trigger.keywords.some(keyword => lowerInput.includes(keyword))) {
                return trigger;
            }
        }
        return null;
    };

    const initializeChat = () => {
        const welcomeMsg = {
            role: 'assistant',
            content: `Hi! I'm Jackie, your intelligent assistant.\n\nJust tell me what you'd like to do:\n\nüìÜ Schedule a meeting\n‚úÖ Create a milestone\nüè† Add a property\nüë§ Add a lead\nüìÖ Plan your day (Daily Action Plan)\nüî• Review hot leads`,
            timestamp: new Date().toISOString()
        };
        setMessages([welcomeMsg]);
        setConversationHistory([]);
        setTaskType(null);
        setConversationStartTime(new Date());
    };

    const resetChat = () => {
        stopSpeaking();
        setMessages([]);
        setConversationHistory([]);
        setTaskType(null);
        setConversationId(null);
        setConversationStartTime(null);
        setIsLoading(false);
        initializeChat();
    };

    const handleSend = async () => {
        if (!input.trim() || isLoading) return;

        const userMessage = input.trim();
        const lowerMessage = userMessage.toLowerCase();

        const directNav = checkDirectNavigation(userMessage);
        if (directNav) {
            setMessages(prev => [...prev, {
                role: 'user',
                content: userMessage,
                timestamp: new Date().toISOString()
            }, {
                role: 'assistant',
                content: `Opening ${directNav.page}...`,
                timestamp: new Date().toISOString()
            }]);
            setInput('');
            const path = directNav.filter ? `${directNav.page}?filter=${directNav.filter}` : directNav.page;
            setTimeout(() => {
                setIsOpen(false);
                navigate(createPageUrl(path));
            }, 300);
            return;
        }

        const newUserMessage = { role: 'user', content: userMessage, timestamp: new Date().toISOString() };
        setMessages(prev => [...prev, newUserMessage]);
        setConversationHistory(prev => [...prev, { role: 'user', content: userMessage }]);
        setInput('');
        setIsLoading(true);
        stopSpeaking();

        if (!taskType) {
            if ((lowerMessage.includes('schedule') || lowerMessage.includes('book') || lowerMessage.includes('set up')) && (lowerMessage.includes('meeting') || lowerMessage.includes('appointment'))) {
                setTaskType('meeting');
            } else if (lowerMessage.includes('create') && lowerMessage.includes('task')) {
                setTaskType('task');
            }
        }

        const newHistory = [...conversationHistory, { role: 'user', content: userMessage }];

        try {
            // Build conversation context from history
            const conversationContext = newHistory.map(msg => 
                `${msg.role === 'user' ? 'User' : 'Jackie'}: ${msg.content}`
            ).join('\n');

            // Check if this is a property lookup request
            const isPropertyLookup = lowerMessage.match(/who owns|owner of|property owner|lookup|look up|find owner|owner name|owner info/) || 
                                     lowerMessage.match(/\d+\s+\w+\s+(st|street|ave|avenue|rd|road|dr|drive|ct|court|ln|lane|blvd|boulevard|way|pl|place|cir|circle)/i);

            const learningsContext = getLearningsContext();

                            // Build user location context
            const userLocationContext = userData ? `
USER'S LOCATION INFO:
- Name: ${userData.full_name || 'Unknown'}
- Office/Brokerage: ${userData.office || 'Not set'}
- Company Office Address: ${userData.company_office_address || 'Not set'}
- Private Office Address: ${userData.private_office_address || 'Not set'}
- Working Hours: ${userData.working_hours_start || '09:00'} - ${userData.working_hours_end || '17:00'}
` : '';

            // Check if user is asking about buyers or sellers/properties
            const lowerInput = input.toLowerCase();
            const askingAboutBuyers = lowerInput.includes('buyer') || lowerInput.includes('buyers');
            const askingAboutSellers = lowerInput.includes('seller') || lowerInput.includes('sellers') || lowerInput.includes('listing') || lowerInput.includes('listings') || lowerInput.includes('properties') || lowerInput.includes('property');
            
            let buyersContext = '';
            let sellersContext = '';
            
            if (askingAboutBuyers) {
                try {
                    const buyers = await base44.entities.Buyer.list();
                    if (buyers && buyers.length > 0) {
                        buyersContext = `\nYOUR BUYER LIST (${buyers.length} total):\n` + buyers.map(b => 
                            `- ${b.first_name} ${b.last_name} | Email: ${b.email || 'N/A'} | Phone: ${b.phone || 'N/A'} | Budget: $${b.budget_min?.toLocaleString() || '?'} - $${b.budget_max?.toLocaleString() || '?'} | Status: ${b.status || 'active'} | Preferred Locations: ${b.preferred_locations || 'Any'} | Timeline: ${b.timeline || 'N/A'} | Pre-approved: ${b.pre_approved ? 'Yes' : 'No'}`
                        ).join('\n');
                    } else {
                        buyersContext = '\nYOUR BUYER LIST: No buyers found in the system.';
                    }
                } catch (e) {
                    console.error('Error fetching buyers:', e);
                }
            }
            
            if (askingAboutSellers) {
                try {
                    const properties = await base44.entities.Property.list();
                    if (properties && properties.length > 0) {
                        sellersContext = `\nYOUR PROPERTY/SELLER LIST (${properties.length} total):\n` + properties.map(p => {
                            let sellerInfo = 'N/A';
                            if (p.sellers_info) {
                                try {
                                    const sellers = JSON.parse(p.sellers_info);
                                    sellerInfo = sellers.map(s => s.name || 'Unknown').join(', ');
                                } catch (e) {}
                            }
                            return `- ${p.address} | Price: $${p.price?.toLocaleString() || 'N/A'} | Status: ${p.status || 'active'} | Type: ${p.property_type || 'N/A'} | Beds: ${p.bedrooms || 'N/A'} | Baths: ${p.bathrooms || 'N/A'} | Sqft: ${p.square_feet || 'N/A'} | Seller(s): ${sellerInfo} | MLS: ${p.mls_number || 'N/A'}`;
                        }).join('\n');
                    } else {
                        sellersContext = '\nYOUR PROPERTY/SELLER LIST: No properties found in the system.';
                    }
                } catch (e) {
                    console.error('Error fetching properties:', e);
                }
            }

            const response = await base44.integrations.Core.InvokeLLM({
                                prompt: `You are Jackie, a friendly and conversational intelligent real estate assistant.
            ${learningsContext}
            ${userLocationContext}
            ${buyersContext}
            ${sellersContext}
            CONVERSATION SO FAR:
            ${conversationContext}

${isPropertyLookup ? `
**PROPERTY OWNER LOOKUP REQUEST DETECTED**
The user needs the OWNER NAME and MAILING ADDRESS from county property appraiser records.

FOR BROWARD COUNTY FLORIDA PROPERTIES:
I cannot directly search the bcpa.net database. Provide these instructions to the user:

RESPONSE FORMAT:
"To find the owner of [address], go to the Broward County Property Appraiser website:

1. Visit: **bcpa.net**
2. Click **'Property Search'** at the top
3. Enter the street number and street name (e.g., '5200 NW 64th Ave')
4. Click **Search**
5. The results will show: **Owner Name, Mailing Address, Parcel ID, Assessed Value, and Sales History**

The Property Appraiser is the official public record for property ownership in Broward County."

Also search for any available property details from Zillow/Redfin to provide (beds, baths, sqft, year built, last sale price) as supplemental info.

SUPPLEMENTAL INFO FORMAT:
**Property Details from public listings:**
- Address: [address]
- Beds/Baths: [X bed / X bath]
- Square Feet: [sqft]
- Year Built: [year]
- Last Sale: [date for $price] (if available)

**For Owner Info:** Visit bcpa.net and search the address.
` : ''}

GENERAL RULES:
1. Respond naturally and conversationally
2. Keep responses SHORT - max 2-3 paragraphs
3. NEVER include clickable URLs or web links in your response
4. NEVER use generic greetings like "I hope this message finds you well" or similar phrases
5. If user confirms they want to schedule something, respond with CREATE_APPOINTMENT
6. If user confirms they want a task created, respond with CREATE_TASK

Current Date & Time (User's Local Time): ${new Date().toLocaleString('en-US', { 
    weekday: 'long',
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
})}
Today's Date: ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
Current Time: ${new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}

Respond to the user's message:`,
                add_context_from_internet: true,
            });

            let cleanedResponse = response;
            if (typeof cleanedResponse === 'string') {
                cleanedResponse = cleanedResponse
                    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                    .replace(/https?:\/\/[^\s)]+/g, '')
                    .replace(/\(\s*\)/g, '')
                    .replace(/#{1,6}\s*/g, '')
                    .replace(/\*\*/g, '')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
            }

            if (cleanedResponse && typeof cleanedResponse === 'string' && cleanedResponse.trim()) {
                const assistantMsg = { role: 'assistant', content: cleanedResponse, timestamp: new Date().toISOString() };
                setMessages(prev => [...prev, assistantMsg]);
                setConversationHistory([...newHistory, { role: 'assistant', content: cleanedResponse }]);

                if (cleanedResponse.includes('CREATE_APPOINTMENT')) {
                    setTimeout(() => {
                        navigate(createPageUrl('Calendar'));
                        toast.success('Opening Calendar');
                    }, 2000);
                } else if (cleanedResponse.includes('CREATE_TASK')) {
                    setTimeout(() => {
                        navigate(createPageUrl('Tasks'));
                        toast.success('Opening Tasks');
                    }, 2000);
                }

                if (voiceEnabled && !cleanedResponse.includes('CREATE_')) {
                    speak(cleanedResponse);
                }
            }
            setIsLoading(false);
        } catch (error) {
            setMessages(prev => [...prev, { role: 'assistant', content: "I'm having trouble. Please try again.", timestamp: new Date().toISOString() }]);
            setIsLoading(false);
        }
    };

    const handleSuggestedPrompt = (promptText, promptConfig) => {
        if (promptConfig?.directNav) {
            const path = promptConfig.directNav.filter ? `${promptConfig.directNav.page}?filter=${promptConfig.directNav.filter}` : promptConfig.directNav.page;
            setTimeout(() => {
                setIsOpen(false);
                navigate(createPageUrl(path));
            }, 300);
            return;
        }
        if (promptConfig?.type === 'direct') {
            setTimeout(() => {
                setIsOpen(false);
                navigate(createPageUrl(promptConfig.action));
            }, 300);
            return;
        }
        if (promptConfig?.type === 'market_reach') {
            setShowMarketReach(true);
            return;
        }
        setInput(promptText);
        setTimeout(() => handleSend(), 100);
    };

    // Market Reach Dashboard Data
    const totalAgentsUSA = 1600000;
    const marketPhases = [
        { name: "Awareness", timeframe: "3‚Äì6 months", percentAdoption: 0.002, desc: "Magazine + E-blast reach" },
        { name: "Conversion", timeframe: "6‚Äì12 months", percentAdoption: 0.014, desc: "Broker deals + early adopters" },
        { name: "Expansion", timeframe: "12‚Äì24 months", percentAdoption: 0.07, desc: "Statewide partnerships + retargeting" },
    ];
    const currentMarketData = marketPhases[marketPhase - 1];
    const marketUsers = Math.round(totalAgentsUSA * currentMarketData.percentAdoption);
    const marketPercentUSA = (currentMarketData.percentAdoption * 100).toFixed(2);
    const monthlyRevenue = marketUsers * marketPrice;
    const yearlyRevenue = monthlyRevenue * 12;

    // Format message content to show lists properly
    const formatMessageContent = (content) => {
        if (!content) return null;
        
        // Split by newlines and detect list items
        const lines = content.split('\n');
        const elements = [];
        let currentList = [];
        let listType = null;
        
        lines.forEach((line, idx) => {
            const trimmedLine = line.trim();
            
            // Check for numbered list (1. or 1) format)
            const numberedMatch = trimmedLine.match(/^(\d+)[.)]\s+(.+)/);
            // Check for bullet list (- or ‚Ä¢ or * format)
            const bulletMatch = trimmedLine.match(/^[-‚Ä¢*]\s+(.+)/);
            
            if (numberedMatch) {
                if (listType !== 'ol' && currentList.length > 0) {
                    elements.push(renderList(currentList, listType, elements.length));
                    currentList = [];
                }
                listType = 'ol';
                currentList.push(numberedMatch[2]);
            } else if (bulletMatch) {
                if (listType !== 'ul' && currentList.length > 0) {
                    elements.push(renderList(currentList, listType, elements.length));
                    currentList = [];
                }
                listType = 'ul';
                currentList.push(bulletMatch[1]);
            } else {
                if (currentList.length > 0) {
                    elements.push(renderList(currentList, listType, elements.length));
                    currentList = [];
                    listType = null;
                }
                if (trimmedLine) {
                    elements.push(<p key={`p-${idx}`} className="mb-3">{trimmedLine}</p>);
                }
            }
        });
        
        // Handle remaining list items
        if (currentList.length > 0) {
            elements.push(renderList(currentList, listType, elements.length));
        }
        
        return elements;
    };
    
    const renderList = (items, type, keyPrefix) => {
        const ListTag = type === 'ol' ? 'ol' : 'ul';
        const listClass = type === 'ol' 
            ? 'list-decimal list-inside space-y-3 my-3 ml-2' 
            : 'list-disc list-inside space-y-3 my-3 ml-2';
        
        return (
            <ListTag key={`list-${keyPrefix}`} className={listClass}>
                {items.map((item, idx) => (
                    <li key={idx} className="text-sm py-1">{item}</li>
                ))}
            </ListTag>
        );
    };

    const handleOpen = () => {
        setIsOpen(true);
        if (messages.length === 0) initializeChat();
    };

    if (!isOpen) {
        const showProactiveBadge = (proactiveSuggestions?.length || 0) > 0;
        return (
            <div className="relative">
                <Button onClick={handleOpen} className="w-14 h-14 rounded-full bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 hover:from-indigo-700 hover:via-purple-700 hover:to-pink-700 text-white shadow-2xl transition-all duration-300 hover:scale-110" size="icon">
                    <Brain className="w-7 h-7" />
                </Button>
                <div className="absolute -top-2 -right-2 bg-green-400 text-white text-[10px] font-bold rounded-full w-6 h-6 flex items-center justify-center animate-pulse shadow-lg">‚ö°</div>
                {showProactiveBadge && (
                    <div className="absolute -bottom-2 -left-2 bg-orange-500 text-white text-[10px] font-bold rounded-full w-6 h-6 flex items-center justify-center shadow-lg animate-bounce">
                        <Bell className="w-3 h-3" />
                    </div>
                )}
            </div>
        );
    }

    // Market Reach Dashboard View
    if (showMarketReach) {
        return (
            <Card className={`${isExpanded ? 'fixed inset-4 z-50' : 'fixed bottom-20 right-4 z-50'} flex flex-col shadow-2xl border-2 overflow-hidden`} style={{ width: isExpanded ? 'auto' : '420px', maxHeight: isExpanded ? 'calc(100vh - 32px)' : 'calc(100vh - 120px)', background: 'linear-gradient(135deg, #0B0C10 0%, #141820 50%, #0B0C10 100%)', borderColor: '#C6A15B33' }}>
                <CardHeader className="flex flex-row items-center justify-between p-3 border-b" style={{ borderColor: '#C6A15B33', background: 'linear-gradient(90deg, #C6A15B 0%, #b59045 100%)' }}>
                    <div className="flex items-center gap-2">
                        <TrendingUp className="w-5 h-5 text-[#0C0F14]" />
                        <div>
                            <h3 className="font-bold text-[#0C0F14] text-sm">Market Reach Dashboard</h3>
                            <p className="text-[10px] text-[#0C0F14]/70">U.S. Agent Projections</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-0.5">
                        <Button variant="ghost" size="icon" onClick={() => setIsExpanded(!isExpanded)} className="h-7 w-7 text-[#0C0F14] hover:bg-white/20">
                            {isExpanded ? <Minimize2 className="w-3.5 h-3.5" /> : <Maximize2 className="w-3.5 h-3.5" />}
                        </Button>
                        <Button variant="ghost" size="icon" onClick={() => setShowMarketReach(false)} className="h-7 w-7 text-[#0C0F14] hover:bg-white/20">
                            <X className="w-3.5 h-3.5" />
                        </Button>
                    </div>
                </CardHeader>

                <ScrollArea className="flex-1" style={{ maxHeight: isExpanded ? 'calc(100vh - 200px)' : '450px' }}>
                    <div className="p-4 space-y-4">
                        {/* Market Reach Card */}
                        <motion.div initial={{opacity:0, y:10}} animate={{opacity:1, y:0}} transition={{duration:0.4}} 
                            className="rounded-2xl p-4 border" style={{ background: 'linear-gradient(135deg, #141820 0%, #0B0C10 100%)', borderColor: '#C6A15B33' }}>
                            <div className="flex items-center gap-2 text-[#E6E9EF] font-semibold text-sm mb-3">
                                <Globe size={16} className="text-[#C6A15B]" /> U.S. Agent Market Reach
                            </div>
                            <div className="text-slate-300 text-xs mb-2 flex items-center gap-2">
                                Total Active Agents: <span className="text-[#E6E9EF] font-semibold">1,600,000</span>
                            </div>
                            <div className="mb-3 text-slate-400 text-xs">
                                Phase: <span className="text-[#C6A15B] font-medium">{currentMarketData.name}</span> ({currentMarketData.timeframe})
                            </div>

                            {/* Progress Bar */}
                            <div className="relative h-4 bg-white/10 rounded-full overflow-hidden mb-1">
                                <motion.div initial={{width:0}} animate={{width:`${Math.min(parseFloat(marketPercentUSA) * 10, 100)}%`}} transition={{duration:0.8}} 
                                    className="h-full rounded-full" style={{ background: 'linear-gradient(90deg, #C6A15B 0%, #b59045 100%)' }}/>
                            </div>
                            <div className="text-right text-[10px] text-slate-400">{marketPercentUSA}% of all U.S. agents</div>

                            <div className="mt-3 text-slate-300 text-xs">{currentMarketData.desc}</div>
                            <div className="text-[#E6E9EF] text-2xl font-bold mt-1">{marketUsers.toLocaleString()} users</div>

                            {/* Phase Buttons */}
                            <div className="flex gap-2 mt-4">
                                {marketPhases.map((p,i)=>(
                                    <button key={p.name} onClick={()=>setMarketPhase(i+1)} 
                                        className={`px-3 py-1.5 rounded-xl border text-xs transition-all ${i+1===marketPhase 
                                            ? 'text-[#0C0F14] font-semibold' 
                                            : 'border-[#C6A15B66] text-slate-300 hover:bg-[#C6A15B14]'}`}
                                        style={i+1===marketPhase ? { background: 'linear-gradient(90deg, #C6A15B 0%, #b59045 100%)' } : {}}>
                                        {p.name}
                                    </button>
                                ))}
                            </div>
                        </motion.div>

                        {/* Revenue Calculator Card */}
                        <motion.div initial={{opacity:0, y:10}} animate={{opacity:1, y:0}} transition={{duration:0.4, delay:0.2}} 
                            className="rounded-2xl p-4 border" style={{ background: 'linear-gradient(135deg, #141820 0%, #0B0C10 100%)', borderColor: '#C6A15B33' }}>
                            <div className="flex items-center gap-2 text-[#E6E9EF] font-semibold text-sm mb-3">
                                <DollarSign size={16} className="text-[#C6A15B]" /> Revenue Calculator
                            </div>
                            <div className="text-slate-300 text-xs mb-3">Estimate potential earnings nationwide</div>

                            <div className="flex items-center gap-3 mb-4">
                                <label className="text-slate-400 text-xs whitespace-nowrap">Price/Agent (Monthly)</label>
                                <input
                                    type="number"
                                    min="1"
                                    value={marketPrice}
                                    onChange={(e)=>setMarketPrice(Number(e.target.value))}
                                    className="flex-1 rounded-xl border border-white/10 bg-white/5 text-slate-100 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#C6A15B66]"
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div className="bg-white/5 p-3 rounded-xl text-center">
                                    <div className="text-slate-400 text-[10px]">Monthly Revenue</div>
                                    <div className="text-[#E6E9EF] text-lg font-semibold mt-0.5">${monthlyRevenue.toLocaleString()}</div>
                                </div>
                                <div className="bg-white/5 p-3 rounded-xl text-center">
                                    <div className="text-slate-400 text-[10px]">Yearly Revenue</div>
                                    <div className="text-[#E6E9EF] text-lg font-semibold mt-0.5">${yearlyRevenue.toLocaleString()}</div>
                                </div>
                            </div>

                            <div className="mt-4 text-[10px] text-slate-500 text-center">
                                Based on {marketUsers.toLocaleString()} projected users in {currentMarketData.name} phase
                            </div>
                        </motion.div>

                        {/* Quick Actions */}
                        <div className="flex flex-wrap gap-2">
                            <button onClick={() => setMarketPrice(Math.max(5, Math.round(marketPrice * 0.9)))} 
                                className="px-3 py-1.5 rounded-xl border border-[#C6A15B44] text-xs text-slate-200 hover:bg-[#C6A15B14] transition-all">
                                Apply 10% Discount
                            </button>
                            <button onClick={() => setMarketPhase(p => Math.min(3, p + 1))} 
                                className="px-3 py-1.5 rounded-xl border border-[#C6A15B44] text-xs text-slate-200 hover:bg-[#C6A15B14] transition-all">
                                Next Phase ‚Üí
                            </button>
                        </div>
                    </div>
                </ScrollArea>

                <div className="p-3 border-t flex-shrink-0" style={{ borderColor: '#C6A15B33', background: 'rgba(20, 24, 32, 0.8)' }}>
                    <Button onClick={() => setShowMarketReach(false)} className="w-full text-[#0C0F14] text-xs h-8" style={{ background: 'linear-gradient(90deg, #C6A15B 0%, #b59045 100%)' }}>
                        Back to Jackie
                    </Button>
                </div>
            </Card>
        );
    }

    return (
        <Card className={`${isExpanded ? 'fixed inset-4 z-50' : 'fixed bottom-20 right-4 z-50'} flex flex-col bg-gradient-to-br from-white to-indigo-50 dark:from-slate-900 dark:to-indigo-950 shadow-2xl border-2 border-indigo-200 dark:border-indigo-800`} style={{ width: isExpanded ? 'auto' : '400px', maxHeight: isExpanded ? 'calc(100vh - 32px)' : 'calc(100vh - 120px)' }}>
            <CardHeader className="flex flex-row items-center justify-between p-3 border-b bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 flex-shrink-0">
                <div className="flex items-center gap-2">
                    <Brain className="w-5 h-5 text-white" />
                    <div>
                        <h3 className="font-bold text-white text-sm">Jackie Assistant</h3>
                        <p className="text-[10px] text-indigo-100">Ready to help</p>
                    </div>
                </div>
                <div className="flex items-center gap-0.5">
                    <Button variant="ghost" size="icon" onClick={() => setVoiceEnabled(!voiceEnabled)} className="h-7 w-7 text-white hover:bg-white/20">
                        {voiceEnabled ? <Volume2 className="w-3.5 h-3.5" /> : <VolumeX className="w-3.5 h-3.5" />}
                    </Button>
                    <Button variant="ghost" size="icon" onClick={resetChat} className="h-7 w-7 text-white hover:bg-white/20">
                        <RefreshCw className="w-3.5 h-3.5" />
                    </Button>
                    <Button variant="ghost" size="icon" onClick={() => setIsExpanded(!isExpanded)} className="h-7 w-7 text-white hover:bg-white/20">
                        {isExpanded ? <Minimize2 className="w-3.5 h-3.5" /> : <Maximize2 className="w-3.5 h-3.5" />}
                    </Button>
                    <Button variant="ghost" size="icon" onClick={() => { setIsOpen(false); setIsExpanded(false); stopSpeaking(); }} className="h-7 w-7 text-white hover:bg-white/20">
                        <X className="w-3.5 h-3.5" />
                    </Button>
                </div>
            </CardHeader>

            <ScrollArea className="flex-1 overflow-y-auto" style={{ maxHeight: isExpanded ? 'calc(100vh - 200px)' : '400px' }}>
                <CardContent className="p-3 space-y-3">
                    {messages.map((msg, idx) => (
                                                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                    <div className={`max-w-[85%] rounded-2xl p-3 ${msg.role === 'user' ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white' : 'bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 border border-slate-200 dark:border-slate-700'}`}>
                                                        <div className="text-sm leading-relaxed">
                                                            {formatMessageContent(msg.content)}
                                                        </div>
                                                        {msg.role === 'assistant' && idx > 0 && (
                                                            <div className="flex items-center gap-1 mt-2 pt-2 border-t border-slate-100 dark:border-slate-700">
                                                                <span className="text-[9px] text-slate-400 mr-1">Helpful?</span>
                                                                <button 
                                                                    onClick={() => recordFeedback(idx, true)}
                                                                    className="text-[10px] px-1.5 py-0.5 rounded bg-green-50 hover:bg-green-100 text-green-600 dark:bg-green-900/30 dark:hover:bg-green-900/50 dark:text-green-400"
                                                                >
                                                                    üëç Yes
                                                                </button>
                                                                <button 
                                                                    onClick={() => recordFeedback(idx, false)}
                                                                    className="text-[10px] px-1.5 py-0.5 rounded bg-red-50 hover:bg-red-100 text-red-600 dark:bg-red-900/30 dark:hover:bg-red-900/50 dark:text-red-400"
                                                                >
                                                                    üëé No
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                    {isLoading && (
                        <div className="flex justify-start">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl p-3 border border-slate-200 dark:border-slate-700 flex items-center gap-2">
                                <Loader2 className="w-4 h-4 animate-spin text-indigo-600" />
                                <p className="text-xs">Thinking...</p>
                            </div>
                        </div>
                    )}
                    {messages.length === 1 && !isLoading && (
                        <div className="space-y-2">
                            {proactiveSuggestions && proactiveSuggestions.length > 0 && (
                                <div className="mb-3">
                                    <p className="text-[10px] font-semibold text-orange-600 mb-2">Proactive Insights:</p>
                                    {proactiveSuggestions.map((s, idx) => (
                                        <Button key={idx} variant="outline" size="sm" onClick={() => handleSuggestedPrompt(s.action, s)} className="w-full justify-start mb-1 bg-orange-50 border-orange-200 text-xs">
                                            <Bell className="w-3 h-3 mr-2 text-orange-600" />
                                            {s.title}
                                        </Button>
                                    ))}
                                </div>
                            )}
                            <p className="text-[10px] font-semibold text-slate-600">Quick start:</p>
                            <div className="grid grid-cols-2 gap-1.5">
                                {SUGGESTED_PROMPTS.map((prompt, idx) => (
                                    <Button key={idx} variant="outline" size="sm" onClick={() => handleSuggestedPrompt(prompt.text, prompt)} className="text-left justify-start h-auto py-2 text-[10px]">
                                        <span className="mr-1">{prompt.icon}</span>
                                        {prompt.text}
                                    </Button>
                                ))}
                            </div>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                </CardContent>
            </ScrollArea>

            <div className="p-3 border-t bg-white/50 dark:bg-slate-900/50 flex-shrink-0">
                <div className="flex gap-2">
                    <Button onClick={startListening} disabled={isLoading} variant={isListening ? "destructive" : "outline"} size="icon" className="h-9 w-9">
                        <Mic className="w-4 h-4" />
                    </Button>
                    <Input value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} placeholder="Type your request..." disabled={isLoading} className="flex-1 h-9 text-sm" />
                    <Button onClick={handleSend} disabled={isLoading || !input.trim()} className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white h-9 w-9" size="icon">
                        <Send className="w-4 h-4" />
                    </Button>
                </div>
            </div>
        </Card>
    );
}
import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { BrainCircuit, Loader2, Wand2, Lightbulb, TrendingUp, TrendingDown, Award, Sparkles, DollarSign, Users, Clock, CheckSquare, Mail, MessageSquare, Copy, Target } from 'lucide-react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { format } from 'date-fns';
import { toast } from 'sonner';

const Recommendation = ({ item }) => {
    const priorityConfig = {
        high: { color: "border-red-500/50 bg-red-500/10", iconColor: "text-red-500", label: "High Priority" },
        medium: { color: "border-amber-500/50 bg-amber-500/10", iconColor: "text-amber-500", label: "Medium Priority" },
        low: { color: "border-blue-500/50 bg-blue-500/10", iconColor: "text-blue-500", label: "Low Priority" },
    };
    const config = priorityConfig[item.priority] || priorityConfig.medium;

    return (
        <div className={`p-4 rounded-lg border ${config.color}`}>
            <div className="flex items-start justify-between">
                <div>
                    <h4 className="font-semibold text-sm text-slate-800 dark:text-slate-200">{item.title}</h4>
                    <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">{item.description}</p>
                </div>
                <div className={`flex items-center gap-1.5 text-xs font-medium ${config.iconColor} ml-4`}>
                    <Lightbulb className="w-3.5 h-3.5" />
                    <span>{config.label}</span>
                </div>
            </div>
        </div>
    );
};

const MetricCard = ({ title, value, unit, icon: Icon, color }) => (
    <div className="bg-slate-50/50 dark:bg-slate-800/50 p-3 rounded-lg flex-1 min-w-[150px]">
        <div className="flex items-center gap-2">
            <Icon className={`w-4 h-4 ${color}`} />
            <p className="text-xs text-slate-500 dark:text-slate-400 font-medium">{title}</p>
        </div>
        <p className="text-xl font-bold text-slate-800 dark:text-slate-100 mt-1">{value} <span className="text-sm font-medium text-slate-500">{unit}</span></p>
    </div>
);


export default function AIBusinessAdvisor({ allData }) {
    const queryClient = useQueryClient();
    const [activeTab, setActiveTab] = useState('overview');
    const [generatingTasks, setGeneratingTasks] = useState(false);
    const [generatingTemplates, setGeneratingTemplates] = useState(false);
    const [proactiveTasks, setProactiveTasks] = useState([]);
    const [followUpTemplates, setFollowUpTemplates] = useState([]);
    const [isGeneratingInBackground, setIsGeneratingInBackground] = useState(false);
    
    // Check if there's an ongoing generation and poll for completion
    React.useEffect(() => {
        const generationStartTime = sessionStorage.getItem('aiAnalysisGenerationStartTime');
        
        if (generationStartTime) {
            const startTime = parseInt(generationStartTime, 10);
            const now = Date.now();
            
            // Only show loading if generation started less than 10 minutes ago
            if (now - startTime < 10 * 60 * 1000) {
                setIsGeneratingInBackground(true);
                
                // Poll for new analysis every 3 seconds
                const pollInterval = setInterval(() => {
                    queryClient.invalidateQueries({ queryKey: ['latestBusinessAnalysis'] });
                }, 3000);
                
                return () => clearInterval(pollInterval);
            } else {
                // Clean up stale generation flag
                sessionStorage.removeItem('aiAnalysisGenerationStartTime');
                setIsGeneratingInBackground(false);
            }
        } else {
            setIsGeneratingInBackground(false);
        }
    }, [queryClient]);
    
    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me()
    });

    const { data: latestAnalysis, isLoading: isLoadingAnalysis } = useQuery({
        queryKey: ['latestBusinessAnalysis'],
        queryFn: async () => {
            const analyses = await base44.entities.AIBusinessAnalysis.list('-created_date', 1);
            const analysis = analyses?.[0] || null;
            
            // Check if a new analysis appeared while generating
            const generationStartTime = sessionStorage.getItem('aiAnalysisGenerationStartTime');
            if (generationStartTime && analysis) {
                const startTime = parseInt(generationStartTime, 10);
                const analysisTime = new Date(analysis.created_date).getTime();
                
                // If analysis is newer than generation start, it's complete
                if (analysisTime > startTime) {
                    sessionStorage.removeItem('aiAnalysisGenerationStartTime');
                    setIsGeneratingInBackground(false);
                    toast.success("Your business analysis is ready!", { duration: 5000 });
                }
            }
            
            return analysis;
        }
    });

    const generateProactiveTasks = async () => {
        if (!allData || !user) return;
        
        setGeneratingTasks(true);
        try {
            const sanitizedData = {
                leads: allData?.leads?.slice(0, 30).map(l => ({
                    id: l.id,
                    name: l.name,
                    status: l.status,
                    score: l.score,
                    lead_source: l.lead_source,
                    created_date: l.created_date,
                    last_contact_date: l.last_contact_date
                })) || [],
                properties: allData?.properties?.slice(0, 20).map(p => ({
                    id: p.id,
                    address: p.address,
                    status: p.status,
                    days_on_market: p.days_on_market,
                    listing_date: p.listing_date
                })) || [],
                recentMarketTrends: analysisContent?.executive_summary || 'No recent trends available'
            };

            const prompt = `
You are an intelligent business strategist for a real estate agent. Based on their current lead activity, property listings, and market trends, generate a list of proactive tasks they should complete to maximize conversions and close more deals.

Current data: ${JSON.stringify(sanitizedData)}

Analyze:
1. Hot leads that need immediate follow-up (high scores, recent inquiries)
2. Stale leads that need re-engagement
3. Properties that have been on market too long and need action
4. Market opportunities based on recent trends

Generate 5-7 specific, actionable tasks. Each task should include:
- A clear title
- Detailed description with context from the data
- Priority level (high/medium/low)
- Estimated time to complete
- Expected impact on business

Focus on tasks that drive revenue and conversions, not busy work.
            `;

            const responseSchema = {
                type: "object",
                properties: {
                    tasks: {
                        type: "array",
                        items: {
                            type: "object",
                            properties: {
                                title: { type: "string" },
                                description: { type: "string" },
                                priority: { type: "string", enum: ["high", "medium", "low"] },
                                estimated_time: { type: "string" },
                                impact: { type: "string" },
                                related_entity_type: { type: "string" },
                                related_entity_id: { type: "string" }
                            }
                        }
                    }
                }
            };

            const result = await base44.integrations.Core.InvokeLLM({ prompt, response_json_schema: responseSchema });
            setProactiveTasks(result.tasks || []);
            toast.success(`Generated ${result.tasks?.length || 0} proactive tasks!`);
        } catch (error) {
            console.error('Error generating tasks:', error);
            toast.error('Failed to generate proactive tasks');
        } finally {
            setGeneratingTasks(false);
        }
    };

    const generateFollowUpTemplates = async () => {
        if (!allData) return;
        
        setGeneratingTemplates(true);
        try {
            const leadScenarios = [
                'hot lead first contact',
                'cold lead re-engagement',
                'property showing follow-up',
                'offer negotiation',
                'post-closing thank you'
            ];

            const prompt = `
You are an expert real estate copywriter. Generate personalized follow-up email templates for various scenarios in a real estate agent's workflow.

Create templates for: ${leadScenarios.join(', ')}

For each template provide:
- Scenario name
- Email subject line
- Email body (personalized, professional, warm tone)
- Best time to send
- Key personalization variables needed

IMPORTANT: Make templates feel human and authentic, not robotic. Include clear calls-to-action. Do NOT use generic greetings like "I hope this message finds you well" or similar phrases. Start directly with value.
            `;

            const responseSchema = {
                type: "object",
                properties: {
                    templates: {
                        type: "array",
                        items: {
                            type: "object",
                            properties: {
                                scenario: { type: "string" },
                                subject: { type: "string" },
                                body: { type: "string" },
                                best_time: { type: "string" },
                                variables: { type: "array", items: { type: "string" } }
                            }
                        }
                    }
                }
            };

            const result = await base44.integrations.Core.InvokeLLM({ prompt, response_json_schema: responseSchema });
            setFollowUpTemplates(result.templates || []);
            toast.success(`Generated ${result.templates?.length || 0} follow-up templates!`);
        } catch (error) {
            console.error('Error generating templates:', error);
            toast.error('Failed to generate follow-up templates');
        } finally {
            setGeneratingTemplates(false);
        }
    };

    const createTaskFromRecommendation = async (task) => {
        try {
            await base44.entities.Task.create({
                title: task.title,
                description: task.description,
                priority: task.priority,
                assigned_to: user?.id,
                status: 'pending',
                task_type: 'general'
            });
            toast.success('Task created successfully!');
            queryClient.invalidateQueries({ queryKey: ['tasks'] });
        } catch (error) {
            toast.error('Failed to create task');
        }
    };

    const copyTemplate = (template) => {
        const text = `Subject: ${template.subject}\n\n${template.body}`;
        navigator.clipboard.writeText(text);
        toast.success('Template copied to clipboard!');
    };

    const generateAnalysisMutation = useMutation({
        mutationFn: async () => {
            // Store generation start time
            sessionStorage.setItem('aiAnalysisGenerationStartTime', Date.now().toString());
            setIsGeneratingInBackground(true);
            
            try {
            // Sanitize data to avoid excessive size
            const sanitizedData = {
                transactions: allData?.transactions?.slice(0, 50) || [],
                leads: allData?.leads?.slice(0, 50) || [],
                tasks: allData?.tasks?.slice(0, 50) || [],
                properties: allData?.properties?.slice(0, 50) || []
            };

            const prompt = `
                You are 'RealtyMind', a hyper-personalized AI business coach for a real estate agent.
                You will be provided with a JSON dataset representing THIS SPECIFIC AGENT'S business performance data (their "proforma").
                Your task is to act as their personal coach. Do not provide generic real estate advice. All your analysis and recommendations MUST be directly derived from the provided data.

                Here is the agent's data: ${JSON.stringify(sanitizedData)}

                Now, perform a deep analysis of THIS AGENT'S data, focusing on:
                1.  **Financials**: Analyze their closed deals, commission trends, and average deal values from the 'transactions' data.
                2.  **Lead Pipeline**: How effective are they at converting leads? Look at the 'leads' data.
                3.  **Operations**: Look at 'tasks'. Are there many overdue tasks? This indicates operational bottlenecks.
                4.  **Listings**: From the 'properties' data, what is their average time on market?

                Based on your DETAILED, DATA-DRIVEN analysis, provide a structured JSON response with the following sections:
                1.  **Executive Summary**: A concise, personalized summary of THIS AGENT'S current business health.
                2.  **Strengths**: 2-3 specific things THIS AGENT is doing well, supported by data points from the JSON.
                3.  **Areas for Improvement**: 2-3 specific weaknesses or opportunities for THIS AGENT, directly identified from the data.
                4.  **Actionable Recommendations**: A list of 3 highly specific and actionable recommendations tailored to THIS AGENT'S data.
                5.  **Key Metrics**: Calculate and return: Total Sales Volume, Avg. Commission Per Deal, Lead Conversion Rate (%), and Avg. Days on Market (DOM).
                6.  **Monthly Commission Breakdown**: Provide a breakdown of total commission earned per month for the current year. The output should be an array of objects, where each object has a "month" (3-letter abbreviation, e.g., "Jan") and a "commission" (number) key.

                Remember, the entire response must be hyper-personalized to the agent based on the data provided.
            `;

            const responseSchema = {
                type: "object",
                properties: {
                    executive_summary: { type: "string" },
                    strengths: {
                        type: "array",
                        items: { type: "object", properties: { title: { type: "string" }, description: { type: "string" } } }
                    },
                    improvements: {
                        type: "array",
                        items: { type: "object", properties: { title: { type: "string" }, description: { type: "string" } } }
                    },
                    recommendations: {
                        type: "array",
                        items: {
                            type: "object",
                            properties: {
                                title: { type: "string" },
                                description: { type: "string" },
                                priority: { type: "string", enum: ["high", "medium", "low"] }
                            }
                        }
                    },
                    key_metrics: {
                        type: "object",
                        properties: {
                            total_sales_volume: { type: "number" },
                            avg_commission: { type: "number" },
                            lead_conversion_rate: { type: "number" },
                            avg_dom: { type: "number" }
                        }
                    },
                    monthly_commission_data: {
                        type: "array",
                        items: {
                            type: "object",
                            properties: {
                                month: { type: "string" },
                                commission: { type: "number" }
                            },
                            required: ["month", "commission"]
                        }
                    }
                },
                required: ["executive_summary", "strengths", "improvements", "recommendations", "key_metrics", "monthly_commission_data"]
            };

            const result = await base44.integrations.Core.InvokeLLM({ prompt, response_json_schema: responseSchema });
            return result;
            } catch (error) {
            throw error;
            }
        },
        onSuccess: async (data) => {
            setIsGeneratingInBackground(false);
            sessionStorage.removeItem('aiAnalysisGenerationStartTime');
            try {
                const user = await base44.auth.me();
                if (data && user?.id) {
                    const analysisData = { ...data, user_id: user.id };
                    await base44.entities.AIBusinessAnalysis.create(analysisData);
                    queryClient.invalidateQueries({ queryKey: ['latestBusinessAnalysis'] });
                    toast.success("New business analysis is ready!", { duration: 5000 });
                }
            } catch (error) {
                console.error("Error saving analysis:", error);
                toast.error("Analysis generated but failed to save");
            }
        },
        onError: (error) => {
            setIsGeneratingInBackground(false);
            sessionStorage.removeItem('aiAnalysisGenerationStartTime');
            console.error("Analysis generation failed:", error);
            toast.error("Failed to generate business analysis. Please try again.");
        },
    });

    const analysisContent = useMemo(() => {
        if (!latestAnalysis) return null;
        return {
            ...latestAnalysis,
            key_metrics: latestAnalysis.key_metrics || {},
            monthly_commission_data: latestAnalysis.monthly_commission_data || []
        };
    }, [latestAnalysis]);
    
    // Check if we should show loading based on latest analysis age vs generation start
    const shouldShowLoading = useMemo(() => {
        const generationStartTime = sessionStorage.getItem('aiAnalysisGenerationStartTime');
        
        if (!generationStartTime) {
            return generateAnalysisMutation.isPending || isGeneratingInBackground;
        }
        
        const startTime = parseInt(generationStartTime, 10);
        const now = Date.now();
        
        // If generation started more than 10 minutes ago, assume it failed
        if (now - startTime > 10 * 60 * 1000) {
            sessionStorage.removeItem('aiAnalysisGenerationStartTime');
            return false;
        }
        
        // If no analysis exists, show loading
        if (!latestAnalysis) {
            return true;
        }
        
        // If latest analysis is older than generation start, show loading
        const analysisTime = new Date(latestAnalysis.created_date).getTime();
        return analysisTime < startTime;
    }, [latestAnalysis, generateAnalysisMutation.isPending, isGeneratingInBackground]);
    
    if (isLoadingAnalysis) {
        return (
            <div className="flex items-center justify-center h-48">
                <Loader2 className="w-8 h-8 animate-spin text-primary" />
            </div>
        );
    }

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-2xl shadow-lg h-full">
            <CardHeader className="flex flex-row items-center justify-between p-5">
                <CardTitle className="flex items-center gap-3 text-lg font-bold text-slate-900 dark:text-white">
                    {(generateAnalysisMutation.isPending || isGeneratingInBackground) ? (
                        <Loader2 className="w-6 h-6 text-primary animate-spin" />
                    ) : (
                        <BrainCircuit className="w-6 h-6 text-primary" />
                    )}
                    Business Advisor
                </CardTitle>
                <Button 
                    onClick={() => generateAnalysisMutation.mutate()} 
                    disabled={generateAnalysisMutation.isPending || isGeneratingInBackground}
                    size="sm"
                    className={(generateAnalysisMutation.isPending || isGeneratingInBackground) ? "bg-indigo-600" : ""}
                >
                    {(generateAnalysisMutation.isPending || isGeneratingInBackground) ? (
                        <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Generating...</>
                    ) : (
                        <><Wand2 className="w-4 h-4 mr-2" /> Refresh Analysis</>
                    )}
                </Button>
            </CardHeader>
            <CardContent className="p-5">
                <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
                    <TabsList className="grid w-full grid-cols-4 mb-4">
                        <TabsTrigger value="overview">Overview</TabsTrigger>
                        <TabsTrigger value="tasks">Proactive Tasks</TabsTrigger>
                        <TabsTrigger value="strategy">Strategy</TabsTrigger>
                        <TabsTrigger value="templates">Templates</TabsTrigger>
                    </TabsList>
                    
                    <TabsContent value="overview">
                       {shouldShowLoading ? (
                            <div className="flex flex-col items-center justify-center py-16">
                                <div className="relative w-20 h-20 mb-6">
                                    <div className="absolute inset-0 border-4 border-indigo-200 dark:border-indigo-800 rounded-full"></div>
                                    <div className="absolute inset-0 border-4 border-transparent border-t-indigo-600 rounded-full animate-spin"></div>
                                    <div className="absolute inset-3 border-4 border-purple-200 dark:border-purple-800 rounded-full"></div>
                                    <div className="absolute inset-3 border-4 border-transparent border-b-purple-600 rounded-full animate-spin" style={{ animationDirection: 'reverse', animationDuration: '1.5s' }}></div>
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <BrainCircuit className="w-8 h-8 text-indigo-600 dark:text-indigo-400 animate-pulse" />
                                    </div>
                                </div>
                                <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
                                    {user?.full_name ? `${user.full_name.split(' ')[0]}, I'm Analyzing Your Business...` : 'Analyzing Your Business Data'}
                                </h3>
                                <p className="text-sm text-slate-600 dark:text-slate-400 text-center max-w-md mb-4">
                                    Processing your transactions, leads, properties, and performance metrics to generate personalized insights...
                                </p>
                                <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 max-w-md mb-4">
                                    <p className="text-xs text-amber-700 dark:text-amber-400 text-center font-medium mb-1">
                                        ‚è±Ô∏è This analysis may take a few minutes.
                                    </p>
                                    <p className="text-xs text-amber-600 dark:text-amber-500 text-center">
                                        Feel free to browse other pages - we'll notify you when it's ready!
                                    </p>
                                </div>
                                <div className="w-64 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                    <div className="h-full bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full animate-pulse" style={{ width: '100%', animation: 'progress 2s ease-in-out infinite' }}></div>
                                </div>
                                <style dangerouslySetInnerHTML={{ __html: `
                                    @keyframes progress {
                                        0% { width: 0%; }
                                        50% { width: 70%; }
                                        100% { width: 100%; }
                                    }
                                `}} />
                            </div>
                        ) : !analysisContent ? (
                            <div className="text-center py-10">
                                <p className="text-slate-700 dark:text-slate-300 font-medium">No analysis available.</p>
                                <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">Generate your first business analysis to get started.</p>
                            </div>
                        ) : (
                    <div className="space-y-6">
                        <div>
                            <p className="text-sm text-slate-500 dark:text-slate-400 mb-2">Analysis from {format(new Date(analysisContent.created_date), 'MMMM d, yyyy')}</p>
                            <h3 className="text-base font-semibold flex items-center gap-2"><Sparkles className="w-5 h-5 text-primary" /> Executive Summary</h3>
                            <p className="text-sm text-slate-700 dark:text-slate-300 mt-2 bg-slate-100/50 dark:bg-slate-800/50 p-4 rounded-lg">
                                {analysisContent.executive_summary}
                            </p>
                        </div>

                        <div className="flex gap-4 overflow-x-auto pb-2 -mx-1 px-1">
                             <MetricCard title="Total Sales Volume" value={analysisContent.key_metrics.total_sales_volume?.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }) || 'N/A'} icon={TrendingUp} color="text-green-500" />
                             <MetricCard title="Avg. Commission" value={analysisContent.key_metrics.avg_commission?.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }) || 'N/A'} icon={DollarSign} color="text-emerald-500" />
                             <MetricCard title="Lead Conversion Rate" value={analysisContent.key_metrics.lead_conversion_rate?.toFixed(1) || 'N/A'} unit="%" icon={Users} color="text-blue-500" />
                             <MetricCard title="Avg. Days on Market" value={analysisContent.key_metrics.avg_dom?.toFixed(0) || 'N/A'} unit="days" icon={Clock} color="text-orange-500" />
                        </div>

                        <div>
                            <h3 className="text-base font-semibold flex items-center gap-2 mb-3"><TrendingUp className="w-5 h-5 text-indigo-500" /> Monthly Commission</h3>
                            <div className="h-[200px]">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={analysisContent.monthly_commission_data} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                                        <CartesianGrid strokeDasharray="3 3" strokeOpacity={0.2} vertical={false} />
                                        <XAxis dataKey="month" tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 11 }} axisLine={false} tickLine={false} />
                                        <YAxis tickFormatter={(value) => `$${value/1000}k`} tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 11 }} axisLine={false} tickLine={false} />
                                        <Tooltip 
                                            formatter={(value) => value.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 })} 
                                            cursor={{fill: 'hsla(var(--primary) / 0.1)'}} 
                                            contentStyle={{ 
                                                background: 'hsla(var(--card) / 0.7)',
                                                backdropFilter: 'blur(10px)',
                                                border: '1px solid hsl(var(--border) / 0.5)',
                                                borderRadius: '0.75rem',
                                                fontSize: '12px',
                                                padding: '4px 8px'
                                            }}
                                        />
                                        <Bar dataKey="commission" name="Commission" fill="var(--theme-primary)" radius={[4, 4, 0, 0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            <div>
                                <h3 className="text-base font-semibold flex items-center gap-2 mb-3"><Award className="w-5 h-5 text-green-500" /> Strengths</h3>
                                <div className="space-y-3">
                                    {analysisContent.strengths.map((item, i) => (
                                        <div key={i} className="flex items-start gap-3">
                                            <div className="w-5 h-5 flex-shrink-0 bg-green-100 dark:bg-green-900/50 rounded-full flex items-center justify-center"><TrendingUp className="w-3 h-3 text-green-600 dark:text-green-400" /></div>
                                            <div>
                                                <p className="font-semibold text-sm text-slate-800 dark:text-slate-200">{item.title}</p>
                                                <p className="text-xs text-slate-600 dark:text-slate-400">{item.description}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                             <div>
                                <h3 className="text-base font-semibold flex items-center gap-2 mb-3"><TrendingDown className="w-5 h-5 text-red-500" /> Areas for Improvement</h3>
                                <div className="space-y-3">
                                    {analysisContent.improvements.map((item, i) => (
                                        <div key={i} className="flex items-start gap-3">
                                            <div className="w-5 h-5 flex-shrink-0 bg-red-100 dark:bg-red-900/50 rounded-full flex items-center justify-center"><TrendingDown className="w-3 h-3 text-red-600 dark:text-red-400" /></div>
                                            <div>
                                                <p className="font-semibold text-sm text-slate-800 dark:text-slate-200">{item.title}</p>
                                                <p className="text-xs text-slate-600 dark:text-slate-400">{item.description}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 className="text-base font-semibold flex items-center gap-2 mb-3"><Lightbulb className="w-5 h-5 text-amber-500" /> Actionable Recommendations</h3>
                            <div className="space-y-3">
                                {analysisContent.recommendations.map((item, i) => <Recommendation key={i} item={item} />)}
                            </div>
                        </div>
                    </div>
                        )}
                    </TabsContent>
                    
                    <TabsContent value="tasks">
                        <div className="space-y-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h3 className="text-base font-semibold">Proactive Task Generation</h3>
                                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Intelligent task generation based on your current leads, properties, and market trends</p>
                                </div>
                                <Button 
                                    onClick={generateProactiveTasks}
                                    disabled={generatingTasks}
                                    size="sm"
                                >
                                    {generatingTasks ? (
                                        <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Generating...</>
                                    ) : (
                                        <><Target className="w-4 h-4 mr-2" /> Generate Tasks</>
                                    )}
                                </Button>
                            </div>
                            
                            {proactiveTasks.length === 0 ? (
                                <div className="text-center py-10 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg">
                                    <CheckSquare className="w-12 h-12 mx-auto text-slate-300 dark:text-slate-600 mb-3" />
                                    <p className="text-slate-600 dark:text-slate-400">No tasks generated yet</p>
                                    <p className="text-sm text-slate-500 dark:text-slate-500 mt-1">Click "Generate Tasks" to create smart, actionable tasks</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {proactiveTasks.map((task, idx) => (
                                        <div key={idx} className={`p-4 rounded-lg border ${
                                            task.priority === 'high' ? 'border-red-500/50 bg-red-500/10' :
                                            task.priority === 'medium' ? 'border-amber-500/50 bg-amber-500/10' :
                                            'border-blue-500/50 bg-blue-500/10'
                                        }`}>
                                            <div className="flex items-start justify-between">
                                                <div className="flex-1">
                                                    <h4 className="font-semibold text-sm text-slate-800 dark:text-slate-200">{task.title}</h4>
                                                    <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">{task.description}</p>
                                                    <div className="flex items-center gap-3 mt-2 text-xs text-slate-500">
                                                        <span>‚è±Ô∏è {task.estimated_time}</span>
                                                        <span>üìà Impact: {task.impact}</span>
                                                    </div>
                                                </div>
                                                <Button
                                                    size="sm"
                                                    variant="outline"
                                                    onClick={() => createTaskFromRecommendation(task)}
                                                    className="ml-3"
                                                >
                                                    <CheckSquare className="w-3 h-3 mr-1" />
                                                    Create
                                                </Button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </TabsContent>
                    
                    <TabsContent value="strategy">
                        <div className="space-y-4">
                            <div>
                                <h3 className="text-base font-semibold mb-3">Lead Nurturing Strategy</h3>
                                <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                                    Personalized recommendations for converting and nurturing your leads based on current data and behavior patterns.
                                </p>
                            </div>
                            
                            {!analysisContent ? (
                                <div className="text-center py-10 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg">
                                    <Lightbulb className="w-12 h-12 mx-auto text-slate-300 dark:text-slate-600 mb-3" />
                                    <p className="text-slate-600 dark:text-slate-400">Generate an analysis first</p>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    <div className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-950/30 dark:to-purple-950/30 p-4 rounded-lg border border-indigo-200 dark:border-indigo-800">
                                        <h4 className="font-semibold text-sm text-slate-800 dark:text-slate-200 mb-2">üéØ Strategic Focus Areas</h4>
                                        <ul className="space-y-2 text-sm text-slate-700 dark:text-slate-300">
                                            <li>‚Ä¢ <strong>High-Value Leads:</strong> Focus on leads with scores above 70 - these are hot prospects</li>
                                            <li>‚Ä¢ <strong>Re-engagement:</strong> Reach out to leads inactive for 14+ days with personalized content</li>
                                            <li>‚Ä¢ <strong>Market Timing:</strong> Leverage current market trends in your conversations</li>
                                            <li>‚Ä¢ <strong>Multi-Touch:</strong> Use email, phone, and text for comprehensive outreach</li>
                                        </ul>
                                    </div>
                                    
                                    <div>
                                        <h4 className="font-semibold text-sm mb-3">Conversion Optimization Tactics</h4>
                                        <div className="grid gap-3">
                                            <div className="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                                                <p className="font-medium text-sm text-slate-800 dark:text-slate-200">üìû Immediate Follow-Up</p>
                                                <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">Contact new leads within 5 minutes - increases conversion by 400%</p>
                                            </div>
                                            <div className="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                                                <p className="font-medium text-sm text-slate-800 dark:text-slate-200">üéÅ Value-First Approach</p>
                                                <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">Share market reports, neighborhood insights before asking for business</p>
                                            </div>
                                            <div className="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                                                <p className="font-medium text-sm text-slate-800 dark:text-slate-200">üîÑ Consistent Cadence</p>
                                                <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">Touch base every 7-10 days with different content types</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </TabsContent>
                    
                    <TabsContent value="templates">
                        <div className="space-y-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h3 className="text-base font-semibold">Follow-Up Communication Templates</h3>
                                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Pre-written, personalized templates for various scenarios</p>
                                </div>
                                <Button 
                                    onClick={generateFollowUpTemplates}
                                    disabled={generatingTemplates}
                                    size="sm"
                                >
                                    {generatingTemplates ? (
                                        <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Generating...</>
                                    ) : (
                                        <><Mail className="w-4 h-4 mr-2" /> Generate Templates</>
                                    )}
                                </Button>
                            </div>
                            
                            {followUpTemplates.length === 0 ? (
                                <div className="text-center py-10 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg">
                                    <MessageSquare className="w-12 h-12 mx-auto text-slate-300 dark:text-slate-600 mb-3" />
                                    <p className="text-slate-600 dark:text-slate-400">No templates generated yet</p>
                                    <p className="text-sm text-slate-500 dark:text-slate-500 mt-1">Click "Generate Templates" to create personalized email templates</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {followUpTemplates.map((template, idx) => (
                                        <div key={idx} className="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700">
                                            <div className="flex items-start justify-between mb-3">
                                                <div>
                                                    <h4 className="font-semibold text-sm text-slate-800 dark:text-slate-200">{template.scenario}</h4>
                                                    <p className="text-xs text-slate-500 mt-1">Best time: {template.best_time}</p>
                                                </div>
                                                <Button
                                                    size="sm"
                                                    variant="ghost"
                                                    onClick={() => copyTemplate(template)}
                                                >
                                                    <Copy className="w-3 h-3" />
                                                </Button>
                                            </div>
                                            <div className="space-y-2">
                                                <div>
                                                    <p className="text-xs font-medium text-slate-600 dark:text-slate-400">Subject:</p>
                                                    <p className="text-sm text-slate-800 dark:text-slate-200">{template.subject}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs font-medium text-slate-600 dark:text-slate-400">Body:</p>
                                                    <p className="text-xs text-slate-700 dark:text-slate-300 whitespace-pre-wrap">{template.body}</p>
                                                </div>
                                                {template.variables?.length > 0 && (
                                                    <div className="pt-2 border-t border-slate-200 dark:border-slate-600">
                                                        <p className="text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Variables to personalize:</p>
                                                        <div className="flex flex-wrap gap-1">
                                                            {template.variables.map((v, i) => (
                                                                <span key={i} className="px-2 py-0.5 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 rounded text-xs">
                                                                    {v}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </TabsContent>
                </Tabs>
            </CardContent>
        </Card>
    );
}
import React, { useMemo } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { TrendingUp, BadgePercent, CalendarDays, Home } from 'lucide-react';
import { parseISO, differenceInDays } from 'date-fns';

const StatItem = ({ icon: Icon, label, value, color }) => (
    <div className="flex items-center gap-3">
        <div className={`p-2 rounded-lg bg-white/50 dark:bg-slate-900/50`}>
            <Icon className={`w-4 h-4 ${color}`} />
        </div>
        <div>
            <p className="text-xs text-slate-600 dark:text-slate-400">{label}</p>
            <p className="text-sm font-bold text-slate-900 dark:text-white">{value}</p>
        </div>
    </div>
);

export default function AnalyticsSnapshotWidget({ transactions = [], properties = [] }) {
    const stats = useMemo(() => {
        const closedTransactions = transactions.filter(t => t.status === 'closed' && t.contract_price);
        
        let totalSaleToList = 0;
        let saleToListCount = 0;
        let totalDOM = 0;
        let domCount = 0;

        closedTransactions.forEach(t => {
            const property = properties.find(p => p.id === t.property_id);
            if (property && property.price) {
                totalSaleToList += t.contract_price / property.price;
                saleToListCount++;
            }
            if (property && property.listing_date && t.important_dates?.closing_date) {
                try {
                    const closingDate = parseISO(t.important_dates.closing_date);
                    const listingDate = parseISO(property.listing_date);
                    if (isNaN(closingDate.getTime()) || isNaN(listingDate.getTime())) return;
                    const dom = differenceInDays(closingDate, listingDate);
                    if (dom >= 0) {
                        totalDOM += dom;
                        domCount++;
                    }
                } catch {}
            }
        });

        const avgSaleToList = saleToListCount > 0 ? `${((totalSaleToList / saleToListCount) * 100).toFixed(1)}%` : 'N/A';
        const avgDOM = domCount > 0 ? Math.round(totalDOM / domCount) : 'N/A';
        const totalVolume = closedTransactions.reduce((sum, t) => sum + (t.contract_price || 0), 0);

        return {
            totalVolume: totalVolume.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }),
            avgDOM: avgDOM !== 'N/A' ? `${avgDOM} days` : 'N/A',
            avgSaleToList
        };
    }, [transactions, properties]);

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <TrendingUp className="w-4 h-4 text-teal-500" />
                    Key Analytics
                </CardTitle>
            </CardHeader>
            <CardContent className="p-3 flex-grow flex flex-col justify-around">
                <StatItem icon={TrendingUp} label="Total Closed Volume" value={stats.totalVolume} color="text-teal-500" />
                <StatItem icon={CalendarDays} label="Avg. Days on Market" value={stats.avgDOM} color="text-sky-500" />
                <StatItem icon={BadgePercent} label="Avg. Sale-to-List Ratio" value={stats.avgSaleToList} color="text-lime-500" />
            </CardContent>
        </Card>
    );
}
import React, { useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { format, isToday, parseISO } from 'date-fns';
import { Sparkles, Heart, Star } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

const holidayEmojis = {
    christian: '‚úùÔ∏è',
    jewish: '‚ú°Ô∏è',
    muslim: '‚ò™Ô∏è',
    hindu: 'üïâÔ∏è',
    buddhist: '‚ò∏Ô∏è',
    secular: 'üéâ',
    multiple: 'üåç'
};

const federalHolidayStyles = {
    background: 'bg-gradient-to-r from-red-50 to-blue-50 dark:from-red-900/20 dark:to-blue-900/20',
    border: 'border-2 border-red-200 dark:border-red-800',
    icon: Star
};

export default function HolidayGreeting({ user }) {
    const { data: holidays = [] } = useQuery({
        queryKey: ['holidays'],
        queryFn: () => base44.entities.Holiday.list(),
        staleTime: 60 * 60 * 1000,
    });

    const todayHoliday = useMemo(() => {
        if (!user || !holidays.length) return null;

        let preferences = {
            show_federal: true,
            show_religious: [],
            show_cultural: false
        };

        try {
            if (user.holiday_preferences) {
                preferences = JSON.parse(user.holiday_preferences);
            }
        } catch (e) {
            console.error('Error parsing holiday preferences:', e);
        }

        const today = new Date();
        const todayStr = format(today, 'yyyy-MM-dd');
        
        const todaysHolidays = holidays.filter(holiday => {
            try {
                const holidayStart = parseISO(holiday.date);
                holidayStart.setHours(0, 0, 0, 0);
                const durationDays = holiday.duration_days || 1;
                
                // Calculate the end date (last day of holiday)
                const holidayEnd = new Date(holidayStart);
                holidayEnd.setDate(holidayEnd.getDate() + durationDays - 1);
                holidayEnd.setHours(23, 59, 59, 999);
                
                const todayDate = new Date(today);
                todayDate.setHours(0, 0, 0, 0);
                
                // Check if today is within the holiday range
                const isInHolidayRange = todayDate >= holidayStart && todayDate <= holidayEnd;
                
                if (!isInHolidayRange) return false;

                if (holiday.is_federal && preferences.show_federal) return true;
                if (holiday.holiday_type === 'cultural' && preferences.show_cultural) return true;
                if (holiday.holiday_type === 'religious' && preferences.show_religious.includes(holiday.religion)) return true;

                return false;
            } catch (e) {
                return false;
            }
        });

        const calculateCurrentDay = (startDate, durationDays) => {
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            const current = new Date(today);
            current.setHours(0, 0, 0, 0);
            const dayNumber = Math.floor((current - start) / (1000 * 60 * 60 * 24)) + 1;
            return Math.min(dayNumber, durationDays); // Cap at max duration
        };

        const federalHoliday = todaysHolidays.find(h => h.is_federal);
        if (federalHoliday) {
            const currentDay = calculateCurrentDay(federalHoliday.date, federalHoliday.duration_days || 1);
            return { ...federalHoliday, currentDay };
        }

        const majorHoliday = todaysHolidays.find(h => h.observance_level === 'major');
        if (majorHoliday) {
            const currentDay = calculateCurrentDay(majorHoliday.date, majorHoliday.duration_days || 1);
            return { ...majorHoliday, currentDay };
        }

        if (todaysHolidays[0]) {
            const currentDay = calculateCurrentDay(todaysHolidays[0].date, todaysHolidays[0].duration_days || 1);
            return { ...todaysHolidays[0], currentDay };
        }

        return null;
    }, [holidays, user]);

    if (!todayHoliday) return null;

    const isFederal = todayHoliday.is_federal;
    const emoji = holidayEmojis[todayHoliday.religion] || holidayEmojis.secular;
    const Icon = isFederal ? federalHolidayStyles.icon : (todayHoliday.businesses_closed ? Star : Sparkles);

    return (
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0, scale: 0.95, y: -10 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.95, y: -10 }}
                className={`
                    inline-flex items-center gap-2 px-4 py-2 rounded-full
                    ${isFederal 
                        ? 'bg-gradient-to-r from-red-100 to-blue-100 dark:from-red-900/30 dark:to-blue-900/30 border-2 border-red-300 dark:border-red-700' 
                        : 'bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 border border-purple-300 dark:border-purple-700'
                    }
                    shadow-lg backdrop-blur-sm
                `}
            >
                <motion.span
                    animate={{ 
                        rotate: [0, -10, 10, -10, 0],
                        scale: [1, 1.1, 1.1, 1.1, 1]
                    }}
                    transition={{ 
                        duration: 2, 
                        repeat: Infinity, 
                        repeatDelay: 3 
                    }}
                    className="text-2xl"
                >
                    {emoji}
                </motion.span>
                
                <div className="flex flex-col">
                    <span className={`text-sm font-bold ${isFederal ? 'text-red-700 dark:text-red-300' : 'text-purple-700 dark:text-purple-300'}`}>
                        Happy {todayHoliday.name.replace(/\s*\(.*?\)\s*$/g, '')}!
                        {todayHoliday.duration_days > 1 && todayHoliday.currentDay && (
                            <span className="ml-2 text-xs">
                                Day {todayHoliday.currentDay} of {todayHoliday.duration_days}
                            </span>
                        )}
                    </span>
                    {todayHoliday.businesses_closed && (
                        <span className="text-[10px] text-slate-600 dark:text-slate-400 flex items-center gap-1">
                            <Icon className="w-3 h-3" />
                            {isFederal ? 'Federal Holiday - Banks & Offices Closed' : 'Many businesses closed'}
                        </span>
                    )}
                </div>

                {isFederal && (
                    <motion.div
                        animate={{ rotate: 360 }}
                        transition={{ duration: 3, repeat: Infinity, ease: "linear" }}
                    >
                        <Star className="w-4 h-4 text-red-600 dark:text-red-400" fill="currentColor" />
                    </motion.div>
                )}
            </motion.div>
        </AnimatePresence>
    );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer } from "recharts";
import { TrendingUp, TrendingDown, Minus, Activity, RefreshCw, ArrowRight } from "lucide-react";
import { useQuery } from "@tanstack/react-query";
import { format } from "date-fns";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";

// Default data to use when API is rate limited or unavailable
const DEFAULT_RMEI_DATA = {
  value: 70,
  emotion_label: "Optimism",
  date: new Date().toISOString(),
};

export default function MarketEmotionWidget() {
  const navigate = useNavigate();
  
  const { data: rmeiHistory = [], isLoading } = useQuery({
    queryKey: ['rmeiHistory'],
    queryFn: async () => {
      try {
        const records = await base44.entities.RMEIRecord.list('-date', 30);
        return records || [];
      } catch (error) {
        return [];
      }
    },
    staleTime: 24 * 60 * 60 * 1000,
    cacheTime: 7 * 24 * 60 * 60 * 1000,
    retry: false,
    refetchOnWindowFocus: false,
    refetchOnMount: false,
    refetchOnReconnect: false,
    refetchInterval: false,
  });

  const latestRecord = rmeiHistory.length > 0 ? rmeiHistory[0] : DEFAULT_RMEI_DATA;
  const [indexValue, setIndexValue] = useState(latestRecord?.value || 70);
  const [emotion, setEmotion] = useState(latestRecord?.emotion_label || "Optimism");

  useEffect(() => {
    if (latestRecord) {
      setIndexValue(latestRecord.value || 70);
      setEmotion(latestRecord.emotion_label || "Optimism");
    }
  }, [latestRecord]);

  const getColors = () => {
    if (indexValue < 26) return { bg: "bg-red-100 dark:bg-red-900/30", text: "text-red-700 dark:text-red-300", accent: "#dc2626", badgeBg: "bg-red-500" };
    if (indexValue < 46) return { bg: "bg-orange-100 dark:bg-orange-900/30", text: "text-orange-700 dark:text-orange-300", accent: "#ea580c", badgeBg: "bg-orange-500" };
    if (indexValue < 56) return { bg: "bg-yellow-100 dark:bg-yellow-900/30", text: "text-yellow-700 dark:text-yellow-300", accent: "#ca8a04", badgeBg: "bg-yellow-500" };
    if (indexValue < 76) return { bg: "bg-emerald-100 dark:bg-emerald-900/30", text: "text-emerald-700 dark:text-emerald-300", accent: "#22c55e", badgeBg: "bg-emerald-500" };
    return { bg: "bg-cyan-100 dark:bg-cyan-900/30", text: "text-cyan-700 dark:text-cyan-300", accent: "#06b6d4", badgeBg: "bg-cyan-500" };
  };

  const getTrendIcon = () => {
    if (rmeiHistory.length < 2) return null;
    const previous = rmeiHistory[1]?.value || indexValue;
    const change = indexValue - previous;
    
    if (change > 2) return <TrendingUp className="w-3 h-3 text-emerald-500" />;
    if (change < -2) return <TrendingDown className="w-3 h-3 text-red-500" />;
    return <Minus className="w-3 h-3 text-slate-400" />;
  };

  const colors = getColors();

  const chartData = React.useMemo(() => {
    if (rmeiHistory.length === 0) return [];

    try {
      const monthlyData = {};
      
      rmeiHistory.forEach(record => {
        try {
          const date = new Date(record.date);
          const monthKey = format(date, 'yyyy-MM');
          
          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { monthKey, values: [], date };
          }
          
          monthlyData[monthKey].values.push(record.value);
        } catch (e) {}
      });

      return Object.values(monthlyData)
        .map(month => ({
          date: format(month.date, 'MMM'),
          value: Math.round(month.values.reduce((a, b) => a + b, 0) / month.values.length),
          sortDate: month.date
        }))
        .sort((a, b) => a.sortDate - b.sortDate)
        .slice(-6);
    } catch (error) {
      return [];
    }
  }, [rmeiHistory]);

  const showDataNotice = rmeiHistory.length === 0 && !isLoading;

  return (
    <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
      <CardHeader className="flex flex-row items-center justify-between p-3">
        <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
          <Activity className="w-4 h-4 text-amber-500" />
          Market Emotion
        </CardTitle>
        <Button 
          variant="ghost" 
          size="sm" 
          onClick={() => navigate(createPageUrl('InitializeRMEI'))}
          className="text-primary hover:bg-primary/10 h-6 text-xs px-2"
        >
          View All
        </Button>
      </CardHeader>
      
      <CardContent className="p-3 flex-grow flex flex-col gap-3">
        {/* Main Score Display */}
        <div className={`${colors.bg} rounded-lg p-4`}>
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-baseline gap-2">
              <span className={`text-3xl font-bold ${colors.text}`}>{indexValue}</span>
              <span className="text-xs text-slate-500 dark:text-slate-400">/ 100</span>
              {getTrendIcon()}
            </div>
            <Badge className={`${colors.badgeBg} text-white text-xs`}>
              {emotion}
            </Badge>
          </div>
          
          {/* Progress Bar */}
          <div className="relative w-full h-2 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
            <div className="absolute inset-0 bg-gradient-to-r from-red-400 via-yellow-400 via-green-400 to-cyan-400 opacity-30" />
            <div 
              className="h-full rounded-full transition-all duration-500"
              style={{ 
                width: `${indexValue}%`, 
                backgroundColor: colors.accent 
              }} 
            />
          </div>
          
          {/* Labels */}
          <div className="flex justify-between mt-2 text-[9px] text-slate-500 dark:text-slate-400">
            <span>Fear</span>
            <span>Neutral</span>
            <span>Euphoria</span>
          </div>
        </div>

        {/* Mini Chart */}
        {chartData.length > 0 && (
          <div className="flex-grow bg-slate-50 dark:bg-slate-800/50 rounded-lg p-3">
            <p className="text-[10px] font-medium text-slate-500 dark:text-slate-400 mb-2">6-Month Trend</p>
            <ResponsiveContainer width="100%" height={80}>
              <AreaChart data={chartData}>
                <defs>
                  <linearGradient id="emotionGradient" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor={colors.accent} stopOpacity={0.3}/>
                    <stop offset="95%" stopColor={colors.accent} stopOpacity={0.05}/>
                  </linearGradient>
                </defs>
                <XAxis dataKey="date" hide />
                <YAxis domain={[0, 100]} hide />
                <Tooltip
                  contentStyle={{
                    background: 'white',
                    border: '1px solid #e2e8f0',
                    borderRadius: '8px',
                    fontSize: '11px',
                    padding: '6px 10px',
                  }}
                  formatter={(value) => [`${value}`, "Index"]}
                />
                <Area 
                  type="monotone" 
                  dataKey="value" 
                  stroke={colors.accent}
                  strokeWidth={2} 
                  fill="url(#emotionGradient)"
                  dot={false}
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        )}

        {/* Info */}
        <p className="text-[10px] text-slate-500 dark:text-slate-400 leading-relaxed">
          üí° Combines mortgage rates, price trends & market psychology
        </p>
      </CardContent>
    </Card>
  );
}
import React, { useState, useEffect, useRef } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Bell, X, MapPin, Clock, CalendarIcon, User, Volume2, VolumeX, Car, AlertTriangle, RefreshCw } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { format } from 'date-fns';
import { createPageUrl } from '@/utils';
import { Link, useNavigate } from 'react-router-dom';
import { toast } from 'sonner'; // Changed from 'react-hot-toast'
import RecurringEventManager from '../calendar/RecurringEventManager'; // New import

export default function NextEventBanner() {
  const queryClient = useQueryClient();
  const navigate = useNavigate();
  const [dismissed, setDismissed] = useState(false);
  const [alarmActive, setAlarmActive] = useState(false);
  const [alarmMuted, setAlarmMuted] = useState(false);
  const [showLateModal, setShowLateModal] = useState(false);
  const [showRecurringManager, setShowRecurringManager] = useState(false); // New state
  const [minutesRemaining, setMinutesRemaining] = useState(null);
  const [currentTime, setCurrentTime] = useState(new Date());
  const [sentLateNotification, setSentLateNotification] = useState(false);
  const audioContextRef = useRef(null);
  const intervalRef = useRef(null);
  const alarmIntervalRef = useRef(null);
  const lastSpeechRef = useRef(null);
  const isSpeakingRef = useRef(false); // Track if currently speaking

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me(),
    staleTime: 5 * 60 * 1000
  });

  const { data: weatherData } = useQuery({
    queryKey: ['weather'],
    queryFn: async () => {
      const position = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
      });
      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `What is the current temperature, today's high temperature, today's low temperature, and weather condition at coordinates ${position.coords.latitude}, ${position.coords.longitude}? Respond with JSON only.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            temperature: { type: "number" },
            high_temperature: { type: "number" },
            low_temperature: { type: "number" },
            condition: { type: "string" },
            emoji: { type: "string" }
          }
        }
      });
      return result;
    },
    enabled: !!user,
    staleTime: 60 * 60 * 1000, // 1 hour
    cacheTime: 2 * 60 * 60 * 1000, // 2 hours
    retry: false,
    refetchOnWindowFocus: false,
    refetchOnMount: false,
    refetchOnReconnect: false
  });

  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  const { data: allEvents = [] } = useQuery({
    queryKey: ['allUpcomingEvents'],
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    queryFn: async () => {
      const [appointments, showings, openHouses, properties] = await Promise.all([
      base44.entities.Appointment.filter({ agent_id: user.id }).catch(() => []),
      base44.entities.Showing.filter({ showing_agent_id: user.id }).catch(() => []),
      base44.entities.OpenHouse.filter({ hosting_agent_id: user.id }).catch(() => []),
      Promise.all([
      base44.entities.Property.filter({ listing_agent_id: user.id }).catch(() => []),
      base44.entities.Property.filter({ created_by: user.email }).catch(() => [])]
      ).then((results) => {
        const combined = [...results[0], ...results[1]];
        return Array.from(new Map(combined.map((item) => [item.id, item])).values());
      })]
      );

      const now = new Date();

      // MODIFIED: Only show events for TODAY from 6:00 AM onwards, not tomorrow
      const today6AM = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 6, 0, 0);
      const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);

      // Function to check for traffic delays
      const checkTrafficDelay = async (fromLat, fromLng, toLat, toLng) => {
        if (!fromLat || !fromLng || !toLat || !toLng) return null;

        try {
          const result = await base44.integrations.Core.InvokeLLM({
            prompt: `Check current traffic conditions from coordinates ${fromLat},${fromLng} to ${toLat},${toLng}. Are there any crashes, accidents, or severe traffic delays? Respond with JSON only.`,
            add_context_from_internet: true,
            response_json_schema: {
              type: "object",
              properties: {
                has_delay: { type: "boolean", description: "Whether there's a significant delay" },
                delay_minutes: { type: "number", description: "Additional minutes of delay due to traffic" },
                reason: { type: "string", description: "Reason for delay (e.g., crash, heavy traffic)" }
              },
              required: ["has_delay", "delay_minutes", "reason"]
            }
          });
          return result;
        } catch (e) {
          console.log('Could not check traffic:', e);
          return null;
        }
      };

      // If current time is before 6 AM, show events from 6 AM today
      // If current time is after 6 AM, show events from now
      const showEventsFrom = now < today6AM ? today6AM : now;

      // Don't show events beyond today - only TODAY's events
      const showEventsUntil = todayEnd;

      const showRecurringBeforeMinutes = user?.recurring_event_show_before_minutes || 0; // Changed from 60 to 0 - only show when event is NOW
      const recurringShowThreshold = new Date(now.getTime() + showRecurringBeforeMinutes * 60 * 1000);

      const generateRecurringInstances = (appointment) => {
        if (!appointment.is_recurring) return [];

        const instances = [];
        try {
          const startDate = new Date(appointment.scheduled_date);
          if (isNaN(startDate.getTime())) return [];
          
          const endDate = appointment.recurrence_end_date ?
            new Date(appointment.recurrence_end_date) :
            showEventsUntil;
          
          if (appointment.recurrence_end_date && isNaN(endDate.getTime())) return [];

          let currentDate = new Date(Math.max(startDate.getTime(), showEventsFrom.getTime()));

        // Get cancelled instances
        const cancelledInstances = appointment.cancelled_instances ?
        JSON.parse(appointment.cancelled_instances) :
        [];

        // Only process dates for TODAY
        while (currentDate <= endDate && currentDate <= showEventsUntil) {
          const dateString = format(currentDate, 'yyyy-MM-dd');

          // Skip if this instance was cancelled
          if (cancelledInstances.includes(dateString)) {
            currentDate.setDate(currentDate.getDate() + 1); // Move to next day for check
            continue;
          }

          const eventDate = new Date(`${dateString}T${appointment.scheduled_time}`);
          if (isNaN(eventDate.getTime())) {
            currentDate.setDate(currentDate.getDate() + 1);
            continue;
          }

          // For recurring events, only show if they're happening NOW (within showRecurringBeforeMinutes)
          // This prevents showing recurring events hours in advance
          const timeUntilEvent = eventDate - now;
          const minutesUntilEvent = Math.floor(timeUntilEvent / 1000 / 60);

          // Only include if event is within the threshold (default 0 means only show when happening)
          if (minutesUntilEvent >= -5 && minutesUntilEvent <= showRecurringBeforeMinutes && eventDate <= showEventsUntil) {
            let shouldInclude = true;

            if (appointment.recurrence_pattern === 'weekly' && appointment.recurrence_days) {
              const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
              const currentDayName = dayNames[currentDate.getDay()];
              const selectedDays = appointment.recurrence_days.split(',');
              shouldInclude = selectedDays.includes(currentDayName);
            }

            if (shouldInclude) {
              instances.push({
                ...appointment,
                type: 'appointment',
                datetime: eventDate,
                isToday: true,
                isRecurringInstance: true,
                instanceDate: dateString
              });
            }
          }

          if (appointment.recurrence_pattern === 'daily') {
            currentDate.setDate(currentDate.getDate() + 1);
          } else if (appointment.recurrence_pattern === 'weekly') {
            currentDate.setDate(currentDate.getDate() + 1);
          } else if (appointment.recurrence_pattern === 'monthly') {
            currentDate.setMonth(currentDate.getMonth() + 1);
          }
        }

        } catch (e) {
          console.error('Error generating recurring instances:', e);
          return [];
        }
        return instances;
      };

      const mappedAppointments = appointments.
      filter((a) =>
      a.status !== 'cancelled' &&
      a.status !== 'completed' &&
      a.scheduled_date &&
      a.scheduled_time
      ).
      flatMap((a) => {
        if (a.is_recurring) {
          return generateRecurringInstances(a);
        } else {
          try {
            const eventDate = new Date(`${a.scheduled_date}T${a.scheduled_time}`);
            if (isNaN(eventDate.getTime())) return [];
            // Only include if TODAY and within the time range
            if (eventDate >= showEventsFrom && eventDate <= showEventsUntil) {
              return [{
                ...a,
                type: 'appointment',
                datetime: eventDate,
                isToday: true
              }];
            }
            return [];
          } catch (e) {
            return [];
          }
        }
      });

      const mappedShowings = await Promise.all(showings.
      filter((s) =>
      s.status !== 'cancelled' &&
      s.status !== 'completed' &&
      s.scheduled_date &&
      s.scheduled_time
      ).
      map(async (s) => {
        try {
          const eventDate = new Date(`${s.scheduled_date}T${s.scheduled_time}`);
          if (isNaN(eventDate.getTime())) return null;
          const property = properties.find((p) => p.id === s.property_id);

        let trafficDelay = null;
        if (user?.custom_from_lat && user?.custom_from_lng && property?.location_lat && property?.location_lng) {
          trafficDelay = await checkTrafficDelay(
            user.custom_from_lat,
            user.custom_from_lng,
            property.location_lat,
            property.location_lng
          );
        }

          return {
            ...s,
            type: 'showing',
            datetime: eventDate,
            isToday: eventDate >= today6AM && eventDate <= todayEnd,
            location_lat: property?.location_lat,
            location_lng: property?.location_lng,
            location_address: property?.address,
            trafficDelay
          };
        } catch (e) {
          return null;
        }
      })).
      then((results) => results.filter((s) => s && s.datetime >= showEventsFrom && s.datetime <= showEventsUntil));

      const mappedOpenHouses = await Promise.all(openHouses.
      filter((oh) =>
      oh.status !== 'cancelled' &&
      oh.status !== 'completed' &&
      oh.date &&
      oh.start_time
      ).
      map(async (oh) => {
        try {
          const eventDate = new Date(`${oh.date}T${oh.start_time}`);
          if (isNaN(eventDate.getTime())) return null;
          const property = properties.find((p) => p.id === oh.property_id);

        let trafficDelay = null;
        if (user?.custom_from_lat && user?.custom_from_lng && property?.location_lat && property?.location_lng) {
          trafficDelay = await checkTrafficDelay(
            user.custom_from_lat,
            user.custom_from_lng,
            property.location_lat,
            property.location_lng
          );
        }

          return {
            ...oh,
            type: 'openhouse',
            datetime: eventDate,
            isToday: eventDate >= today6AM && eventDate <= todayEnd,
            location_lat: property?.location_lat,
            location_lng: property?.location_lng,
            location_address: property?.address,
            trafficDelay
          };
        } catch (e) {
          return null;
        }
      })).
      then((results) => results.filter((oh) => oh && oh.datetime >= showEventsFrom && oh.datetime <= showEventsUntil));

      // Only return events for TODAY from 6 AM onwards (or from now if after 6 AM) and up to todayEnd
      return [...mappedAppointments, ...mappedShowings, ...mappedOpenHouses].
      filter((e) => e.datetime >= showEventsFrom && e.datetime <= showEventsUntil).
      sort((a, b) => a.datetime - b.datetime);
    },
    enabled: !!user,
    refetchInterval: 60000 // 1 minute instead of 30 seconds
  });

  const nextEvent = allEvents.length > 0 ? allEvents[0] : null;

  // Update countdown every second
  useEffect(() => {
    if (!nextEvent) {
      setMinutesRemaining(null);
      return;
    }

    const updateCountdown = () => {
      const now = new Date();
      const eventTime = nextEvent.datetime;
      const diffMs = eventTime - now;
      const diffMinutes = Math.floor(diffMs / 1000 / 60);
      setMinutesRemaining(diffMinutes);
    };

    updateCountdown();
    const countdownInterval = setInterval(updateCountdown, 1000);

    return () => clearInterval(countdownInterval);
  }, [nextEvent]);

  // Initialize Web Audio API
  useEffect(() => {
    if (!audioContextRef.current && typeof window !== 'undefined') {
      audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
    }
  }, []);

  // Function to play sound using Web Audio API
  const playBeep = (frequency, duration, volume) => {
    if (!audioContextRef.current || alarmMuted) return;

    try {
      const context = audioContextRef.current;
      const oscillator = context.createOscillator();
      const gainNode = context.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(context.destination);

      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(volume, context.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + duration);

      oscillator.start(context.currentTime);
      oscillator.stop(context.currentTime + duration);
    } catch (error) {
      console.log('Error playing beep:', error);
    }
  };

  // Function to play alarm sound based on user preference
  const playAlarmSound = (volume) => {
    const alarmSound = user?.alarm_sound || 'beep';

    if (alarmMuted) return;

    switch (alarmSound) {
      case 'beep':
        playBeep(800, 0.2, volume);
        break;
      case 'chime':
        playBeep(523.25, 0.1, volume);
        setTimeout(() => playBeep(659.25, 0.1, volume), 100);
        setTimeout(() => playBeep(783.99, 0.2, volume), 200);
        break;
      case 'bell':
        playBeep(1046.5, 0.3, volume);
        setTimeout(() => playBeep(1318.51, 0.3, volume), 150);
        break;
      case 'alert':
        playBeep(1000, 0.1, volume);
        setTimeout(() => playBeep(800, 0.1, volume), 150);
        setTimeout(() => playBeep(1000, 0.1, volume), 300);
        break;
      case 'urgent':
        for (let i = 0; i < 3; i++) {
          setTimeout(() => playBeep(1200, 0.1, volume), i * 150);
        }
        break;
      default:
        playBeep(800, 0.2, volume);
    }
  };

  // ENHANCED: More robust Text-to-Speech function with better interrupt handling
  const speakAlert = (text) => {
    if (alarmMuted) {
      console.log('üîá Speech muted');
      return;
    }

    if (!('speechSynthesis' in window)) {
      console.error('‚ùå Speech synthesis not supported');
      return;
    }

    // Prevent overlapping speeches
    const now = Date.now();
    if (isSpeakingRef.current || lastSpeechRef.current && now - lastSpeechRef.current < 3000) {
      console.log('‚è≠Ô∏è Skipping speech (already speaking or too soon)');
      return;
    }

    try {
      console.log('üé§ Preparing to speak:', text);

      // Completely stop any ongoing speech
      window.speechSynthesis.cancel();
      isSpeakingRef.current = false;

      // Create the speech function
      const doSpeak = (retryCount = 0) => {
        if (alarmMuted || dismissed) {
          console.log('üîá Speech cancelled (muted or dismissed)');
          return;
        }

        // Create a fresh utterance
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        utterance.lang = 'en-US';

        utterance.onstart = () => {
          console.log('‚úÖ Speech started');
          isSpeakingRef.current = true;
          lastSpeechRef.current = Date.now();
        };

        utterance.onend = () => {
          console.log('‚úÖ Speech completed');
          isSpeakingRef.current = false;
        };

        utterance.onerror = (event) => {
          isSpeakingRef.current = false;

          // Interrupted and cancelled errors are expected, don't log them as errors
          if (event.error === 'interrupted' || event.error === 'cancelled') {
            console.log('üîá Speech interrupted or cancelled (expected)');
            return;
          }

          // Log other errors
          if (event.error !== 'network') {
            console.warn('‚ö†Ô∏è Speech error:', event.error);
          }

          // Only retry once for network errors
          if (event.error === 'network' && retryCount < 1) {
            console.log('üîÑ Retrying speech (attempt', retryCount + 1, ')...');
            setTimeout(() => {
              window.speechSynthesis.cancel();
              setTimeout(() => doSpeak(retryCount + 1), 500);
            }, 1000);
          }
        };

        // Speak immediately
        console.log('üöÄ Speaking now...');
        window.speechSynthesis.speak(utterance);
      };

      // Wait for cancel to complete, then speak
      setTimeout(() => doSpeak(), 300);

    } catch (error) {
      console.error('‚ùå Error with speech synthesis:', error);
      isSpeakingRef.current = false;
    }
  };

  // Get time-based greeting
  const getGreeting = () => {
    const hour = new Date().getHours();
    if (hour < 12) return "Good morning";
    if (hour < 18) return "Good afternoon";
    return "Good evening";
  };

  // Alarm system - triggers 30 minutes before departure and at departure time
  useEffect(() => {
    // If dismissed, clear everything
    if (!nextEvent || !user || dismissed) {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
        intervalRef.current = null;
      }
      if (alarmIntervalRef.current) {
        clearInterval(alarmIntervalRef.current);
        alarmIntervalRef.current = null;
      }
      setAlarmActive(false);
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        isSpeakingRef.current = false;
      }
      return;
    }

    // If muted, stop alarm but keep checking
    if (alarmMuted) {
      if (alarmIntervalRef.current) {
        clearInterval(alarmIntervalRef.current);
        alarmIntervalRef.current = null;
      }
      setAlarmActive(false);
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        isSpeakingRef.current = false;
      }
    }

    const alarmEnabled = user.alarm_enabled !== false;
    if (!alarmEnabled) {
      console.log('‚è∞ Alarms disabled in user settings');
      return;
    }

    const agentFirstName = user?.full_name?.split(' ')[0] || 'Agent';
    const greeting = getGreeting();

    const checkAlarm = () => {
      const now = new Date();
      const eventTime = nextEvent.datetime;
      const officeLocation = {
        lat: user.custom_from_lat || user.office_lat,
        lng: user.custom_from_lng || user.office_lng
      };

      let travelTime = nextEvent.travel_time_minutes || 0;

      if (officeLocation.lat && officeLocation.lng &&
      nextEvent.location_lat && nextEvent.location_lng) {
        travelTime = nextEvent.travel_time_minutes || 30;
      }

      const departureTime = new Date(eventTime.getTime() - travelTime * 60 * 1000);
      const warningTime = new Date(departureTime.getTime() - 30 * 60 * 1000);
      const timeUntilDeparture = departureTime - now;
      const timeUntilWarning = warningTime - now;
      const minutesUntilDeparture = Math.floor(timeUntilDeparture / 1000 / 60);
      const minutesUntilWarning = Math.floor(timeUntilWarning / 1000 / 60);

      const eventTitle = nextEvent.title || (
      nextEvent.type === 'appointment' ? 'your appointment' :
      nextEvent.type === 'showing' ? 'your showing' :
      nextEvent.type === 'openhouse' ? 'your open house' : 'your event');

      console.log('‚è∞ Alarm Check:', {
        currentTime: format(now, 'HH:mm:ss'),
        eventTime: format(eventTime, 'HH:mm:ss'),
        departureTime: format(departureTime, 'HH:mm:ss'),
        minutesUntilWarning,
        minutesUntilDeparture,
        alarmMuted,
        alarmActive,
        dismissed,
        travelTime,
        greeting,
        agentFirstName,
        eventTitle
      });

      // 30-minute warning (gentle reminder)
      if (minutesUntilWarning <= 0 && minutesUntilWarning > -1 && !localStorage.getItem(`warned-${nextEvent.id || nextEvent.instanceDate}`)) {
        console.log('üîî 30-MINUTE WARNING TRIGGERED!');
        if (!alarmMuted) {
          localStorage.setItem(`warned-${nextEvent.id || nextEvent.instanceDate}`, 'true');
          playAlarmSound(0.3);
          const message = `${greeting} ${agentFirstName}, reminder: You need to leave for ${eventTitle} in 30 minutes`;
          console.log('üó£Ô∏è Speaking 30-min warning:', message);
          speakAlert(message);
        } else {
          console.log('üîá 30-min warning muted');
        }
      }

      // Departure time alarm (escalating)
      if (minutesUntilDeparture <= 0 && minutesUntilDeparture > -5) {
        console.log('üö® DEPARTURE TIME - ALARM SHOULD TRIGGER NOW!');
        if (!alarmActive && !alarmMuted) {
          console.log('‚úÖ Starting escalating alarm...');
          setAlarmActive(true);
          playEscalatingAlarm(agentFirstName, eventTitle, greeting);
        } else {
          console.log('‚ö†Ô∏è Alarm not triggered:', { alarmActive, alarmMuted });
        }
      } else {
        if (alarmActive) {
          console.log('‚èπÔ∏è Stopping alarm (outside departure window)');
          setAlarmActive(false);
          if (alarmIntervalRef.current) {
            clearInterval(alarmIntervalRef.current);
            alarmIntervalRef.current = null;
          }
          if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            isSpeakingRef.current = false;
          }
        }
      }

      // Running late notification (5+ minutes past departure)
      if (minutesUntilDeparture <= -5 && minutesUntilDeparture > -10 && !sentLateNotification) {
        console.log('üöó RUNNING LATE - Sending notification');
        sendRunningLateNotification();
      }
    };

    checkAlarm();
    intervalRef.current = setInterval(checkAlarm, 5000);

    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
      if (alarmIntervalRef.current) {
        clearInterval(alarmIntervalRef.current);
      }
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        isSpeakingRef.current = false;
      }
    };
  }, [nextEvent, user, dismissed, alarmMuted, alarmActive]);

  const playEscalatingAlarm = (agentName, eventTitle, greeting) => {
    console.log('üöÄ playEscalatingAlarm called:', { agentName, eventTitle, greeting, alarmMuted });

    if (alarmMuted) {
      console.log('üîá Escalating alarm muted, exiting');
      return;
    }

    let playCount = 0;
    const maxPlays = 20;
    let volume = 0.3;

    const message = `${greeting} ${agentName}, time to leave for ${eventTitle}. You need to depart now.`;
    console.log('üó£Ô∏è DEPARTURE VOICE MESSAGE:', message);
    speakAlert(message);

    const playAlarm = () => {
      if (playCount >= maxPlays || alarmMuted || dismissed) {
        console.log('‚èπÔ∏è Stopping alarm:', { playCount, alarmMuted, dismissed });
        if (alarmIntervalRef.current) {
          clearInterval(alarmIntervalRef.current);
          alarmIntervalRef.current = null;
        }
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          isSpeakingRef.current = false;
        }
        setAlarmActive(false);
        return;
      }

      console.log(`üîä Playing alarm sound #${playCount + 1}, volume: ${volume.toFixed(2)}`);
      playAlarmSound(Math.min(volume, 1.0));

      if (playCount % 5 === 0 && playCount > 0) {
        const repeatMessage = `${agentName}, time to leave now`;
        console.log('üó£Ô∏è Speaking (repeat):', repeatMessage);
        speakAlert(repeatMessage);
      }

      playCount++;
      volume += 0.05;
    };

    playAlarm();
    alarmIntervalRef.current = setInterval(playAlarm, 3000);
  };

  const handleMuteAlarm = () => {
    setAlarmMuted((prev) => {
      const newMutedState = !prev;
      if (newMutedState) {
        setAlarmActive(false);
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          isSpeakingRef.current = false;
        }
        if (alarmIntervalRef.current) {
          clearInterval(alarmIntervalRef.current);
          alarmIntervalRef.current = null;
        }
      }
      return newMutedState;
    });
  };

  const handleDismiss = () => {
    setDismissed(true);
    setAlarmMuted(true);
    setAlarmActive(false);
    setSentLateNotification(false);

    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      isSpeakingRef.current = false;
    }

    if (alarmIntervalRef.current) {
      clearInterval(alarmIntervalRef.current);
      alarmIntervalRef.current = null;
    }

    if (nextEvent) {
      localStorage.removeItem(`warned-${nextEvent.id || nextEvent.instanceDate}`);
      // Set dismiss for this session (until page reload)
      sessionStorage.setItem('eventBannerDismissed', 'true');
    }
  };

  const handleLeavingNow = () => {
    setDismissed(true);
    setAlarmMuted(true);
    setAlarmActive(false);
    setSentLateNotification(false);

    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      isSpeakingRef.current = false;
    }

    if (alarmIntervalRef.current) {
      clearInterval(alarmIntervalRef.current);
      alarmIntervalRef.current = null;
    }

    if (nextEvent) {
      // Store the current event ID to not show until next event
      localStorage.setItem('dismissedEventId', nextEvent.id || nextEvent.instanceDate || '');
      localStorage.removeItem(`warned-${nextEvent.id || nextEvent.instanceDate}`);
    }
  };

  const sendRunningLateNotification = async () => {
    setSentLateNotification(true);

    try {
      const eventTitle = nextEvent.title || (
      nextEvent.type === 'appointment' ? 'your appointment' :
      nextEvent.type === 'showing' ? 'your showing' :
      nextEvent.type === 'openhouse' ? 'your open house' : 'your event');

      // Create notification
      await base44.entities.Notification.create({
        user_id: user.id,
        title: 'üöó Running Late Alert',
        message: `You're running late for ${eventTitle} at ${format(nextEvent.datetime, 'h:mm a')}`,
        notification_type: 'system_alert',
        priority: 'urgent',
        related_entity_type: nextEvent.type === 'appointment' ? 'appointment' :
        nextEvent.type === 'showing' ? 'showing' : 'open_house',
        related_entity_id: nextEvent.id
      });

      toast.error(`Running late for ${eventTitle}!`, {
        duration: 10000,
        action: {
          label: 'View',
          onClick: () => navigate(getEventLink())
        }
      });

      // Voice alert
      if (!alarmMuted) {
        speakAlert(`You are running late for ${eventTitle}. Please depart immediately.`);
      }
    } catch (error) {
      console.error('Error sending late notification:', error);
    }
  };

  // Check if dismissed for this session
  const sessionDismissed = sessionStorage.getItem('eventBannerDismissed') === 'true';

  // Check if this specific event was dismissed with "Leaving Now"
  const dismissedEventId = localStorage.getItem('dismissedEventId');
  const isCurrentEventDismissed = dismissedEventId && dismissedEventId === (nextEvent?.id || nextEvent?.instanceDate || '');

  if (!nextEvent || dismissed || sessionDismissed || isCurrentEventDismissed) return null;

  const now = new Date();
  const eventTime = nextEvent.datetime;
  const officeLocation = {
    lat: user?.custom_from_lat || user?.office_lat,
    lng: user?.custom_from_lng || user?.office_lng
  };

  let travelTime = nextEvent.travel_time_minutes || 0;
  if (officeLocation.lat && officeLocation.lng && nextEvent.location_lat && nextEvent.location_lng) {
    travelTime = nextEvent.travel_time_minutes || 30;
  }

  const departureTime = new Date(eventTime.getTime() - travelTime * 60 * 1000);
  const warningTime = new Date(departureTime.getTime() - 30 * 60 * 1000);
  const timeUntilEvent = eventTime - now;
  const timeUntilDeparture = departureTime - now;
  const timeUntilWarning = warningTime - now;
  const minutesUntilDeparture = Math.floor(timeUntilDeparture / 1000 / 60);
  const minutesUntilWarning = Math.floor(timeUntilWarning / 1000 / 60);

  const isTimeToLeave = minutesUntilDeparture <= 0 && minutesUntilDeparture > -5;
  const isWarningTime = minutesUntilWarning <= 0 && minutesUntilWarning > -30;
  const isUrgent = minutesUntilDeparture <= 15;

  // Calculate progress bar values (show 1 hour before meeting)
  const showProgressBar = minutesRemaining !== null && minutesRemaining <= 60 && minutesRemaining > 0;
  const progressPercentage = showProgressBar ? (60 - minutesRemaining) / 60 * 100 : 0;

  // Color based on time remaining
  const getProgressColor = () => {
    if (minutesRemaining === null) return '';
    if (minutesRemaining > 45) return 'bg-green-500';
    if (minutesRemaining > 30) return 'bg-yellow-500';
    if (minutesRemaining > 15) return 'bg-orange-500';
    return 'bg-red-500';
  };

  const getEventTitle = () => {
    if (nextEvent.type === 'appointment') return nextEvent.title || 'Appointment';
    if (nextEvent.type === 'showing') return `Showing${nextEvent.property_id ? ' at Property' : ''}`;
    if (nextEvent.type === 'openhouse') return 'Open House';
    return 'Event';
  };

  const getEventLink = () => {
    if (nextEvent.type === 'appointment') return createPageUrl('Calendar');
    if (nextEvent.type === 'showing') return createPageUrl('Showings');
    if (nextEvent.type === 'openhouse') return createPageUrl('OpenHouses');
    return createPageUrl('Calendar');
  };

  // Get agent first name and greeting
  const agentFirstName = user?.full_name?.split(' ')[0] || 'Agent';
  const greeting = getGreeting();
  const eventTitle = getEventTitle();

  // Format time remaining with hours and minutes
  const formatTimeRemaining = (totalMinutes) => {
    if (totalMinutes === null || totalMinutes < 0) return null;

    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;

    if (hours > 0) {
      return `${hours}h ${minutes}m`;
    }
    return `${minutes}m`;
  };

  // Test voice function
  const testVoice = () => {
    playAlarmSound(0.5); // Use playAlarmSound which respects alarmMuted
    setTimeout(() => {
      if (!alarmMuted) {// Only speak if not muted
        speakAlert(`${greeting} ${agentFirstName}, this is a test of your voice alert system for ${eventTitle}`);
      }
    }, 500);
  };

  return (
    <>
            <div className={`
                w-full rounded-xl transition-all duration-300 shadow-sm overflow-hidden
                ${alarmActive ? 'bg-red-600 text-white animate-pulse' :
      isTimeToLeave ? 'bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800' :
      isWarningTime ? 'bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800' :
      isUrgent ? 'bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800' :
      'bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700'}
            `}>
                {/* Progress Bar */}
                {showProgressBar && !alarmActive &&
        <div className="h-1 w-full bg-slate-200 dark:bg-slate-700">
                        <div
            className={`h-full transition-all duration-1000 ${getProgressColor()}`}
            style={{ width: `${progressPercentage}%` }} />

                    </div>
        }
                <div className="">
                    <div className="flex items-center justify-between gap-3">
                        {/* Left: Icon + Event Info */}
                        <div className="flex items-center gap-3 flex-1 min-w-0">
                            {/* Icon with progress ring */}
                            <div className="relative flex-shrink-0">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                alarmActive ? 'bg-white/20' :
                isTimeToLeave ? 'bg-red-100 dark:bg-red-900/50' :
                isWarningTime ? 'bg-orange-100 dark:bg-orange-900/50' :
                isUrgent ? 'bg-amber-100 dark:bg-amber-900/50' :
                'bg-blue-100 dark:bg-blue-900/50'}`
                }>
                                    {alarmActive ?
                  <Bell className="w-5 h-5 text-white animate-bounce" /> :

                  <CalendarIcon className={`w-5 h-5 ${
                  isTimeToLeave ? 'text-red-600 dark:text-red-400' :
                  isWarningTime ? 'text-orange-600 dark:text-orange-400' :
                  isUrgent ? 'text-amber-600 dark:text-amber-400' :
                  'text-blue-600 dark:text-blue-400'}`
                  } />
                  }
                                </div>
                                {/* Mini progress indicator */}
                                {showProgressBar && !alarmActive &&
                <svg className="absolute -top-0.5 -left-0.5 w-11 h-11 -rotate-90">
                                        <circle cx="22" cy="22" r="18" fill="none" stroke="currentColor" strokeWidth="3"
                  className="text-slate-200 dark:text-slate-700" />
                                        <circle cx="22" cy="22" r="18" fill="none" strokeWidth="3"
                  strokeDasharray={`${progressPercentage * 1.13} 113`}
                  className={getProgressColor().replace('bg-', 'text-')} />
                                    </svg>
                }
                            </div>
                            
                            {/* Event details */}
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 flex-wrap">
                                    <Link
                    to={getEventLink()}
                    className={`font-semibold text-sm hover:underline truncate ${
                    alarmActive ? 'text-white' :
                    isTimeToLeave ? 'text-red-900 dark:text-red-100' :
                    isWarningTime ? 'text-orange-900 dark:text-orange-100' :
                    isUrgent ? 'text-amber-900 dark:text-amber-100' :
                    'text-slate-900 dark:text-slate-100'}`
                    }>

                                        {alarmActive ? `üö® TIME TO LEAVE!` : eventTitle}
                                    </Link>
                                    {nextEvent.isRecurringInstance && !alarmActive &&
                  <button
                    onClick={(e) => {e.preventDefault();setShowRecurringManager(true);}}
                    className="text-[10px] px-1.5 py-0.5 bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 rounded-full hover:bg-purple-200 transition-colors">

                                            <RefreshCw className="w-2.5 h-2.5 inline mr-0.5" />Recurring
                                        </button>
                  }
                                </div>
                                <div className={`flex items-center gap-3 text-xs mt-0.5 ${
                alarmActive ? 'text-white/80' : 'text-slate-500 dark:text-slate-400'}`
                }>
                                    <span className="flex items-center gap-1">
                                        <Clock className="w-3 h-3" />
                                        {format(eventTime, 'h:mm a')}
                                    </span>
                                    {nextEvent.location_address &&
                  <span className="flex items-center gap-1 truncate max-w-[150px]">
                                            <MapPin className="w-3 h-3" />
                                            {nextEvent.location_address}
                                        </span>
                  }
                                    {travelTime > 0 &&
                  <>
                                            <span className="flex items-center gap-1">
                                                <Car className="w-3 h-3" />
                                                {travelTime}m
                                            </span>
                                            <span className={`flex items-center gap-1 font-semibold ${
                    alarmActive ? 'text-yellow-300' :
                    isTimeToLeave ? 'text-red-700 dark:text-red-300' :
                    isWarningTime ? 'text-orange-700 dark:text-orange-300' :
                    'text-purple-600 dark:text-purple-400'}`
                    }>
                                                ‚Ä¢ Leave {format(departureTime, 'h:mm a')}
                                            </span>
                                        </>
                  }
                                </div>
                            </div>
                        </div>

                        {/* Right: Time remaining + Actions */}
                        <div className="flex items-center gap-2 flex-shrink-0">
                            {/* Countdown badge */}
                            {!alarmActive && minutesRemaining !== null && minutesRemaining > 0 &&
              <div className={`text-center px-3 py-1 rounded-lg ${
              isTimeToLeave ? 'bg-red-100 dark:bg-red-900/50' :
              isWarningTime ? 'bg-orange-100 dark:bg-orange-900/50' :
              isUrgent ? 'bg-amber-100 dark:bg-amber-900/50' :
              'bg-blue-100 dark:bg-blue-900/50'}`
              }>
                                    <p className={`text-lg font-bold leading-none ${
                isTimeToLeave ? 'text-red-700 dark:text-red-300' :
                isWarningTime ? 'text-orange-700 dark:text-orange-300' :
                isUrgent ? 'text-amber-700 dark:text-amber-300' :
                'text-blue-700 dark:text-blue-300'}`
                }>{formatTimeRemaining(minutesRemaining)}</p>
                                    <p className={`text-[10px] ${
                isTimeToLeave ? 'text-red-600 dark:text-red-400' :
                isWarningTime ? 'text-orange-600 dark:text-orange-400' :
                isUrgent ? 'text-amber-600 dark:text-amber-400' :
                'text-blue-600 dark:text-blue-400'}`
                }>until event</p>
                                </div>
              }

                            {/* Traffic alert - compact */}
                            {nextEvent.trafficDelay?.has_delay &&
              <Badge className="bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300 text-[10px]">
                                    <AlertTriangle className="w-3 h-3 mr-1" />
                                    +{nextEvent.trafficDelay.delay_minutes}m traffic
                                </Badge>
              }

                            {/* Action buttons - compact */}
                            <div className="flex items-center gap-1">
                                <Button
                  onClick={handleLeavingNow}
                  size="sm"
                  variant="ghost"
                  className={`h-8 px-2 text-xs ${alarmActive ? 'text-white hover:bg-white/20' : 'hover:bg-green-100 dark:hover:bg-green-900/30'}`}>

                                    <Car className="w-3 h-3 mr-1" />
                                    Leaving
                                </Button>
                                <Button
                  onClick={handleMuteAlarm}
                  size="icon"
                  variant="ghost"
                  className={`h-8 w-8 ${alarmActive ? 'text-white hover:bg-white/20' : ''}`}>

                                    {alarmMuted ? <VolumeX className="w-4 h-4" /> : <Volume2 className="w-4 h-4" />}
                                </Button>
                                <Button
                  onClick={handleDismiss}
                  size="icon"
                  variant="ghost"
                  className={`h-8 w-8 ${alarmActive ? 'text-white hover:bg-white/20' : ''}`}>

                                    <X className="w-4 h-4" />
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Running Late Modal */}
            {showLateModal &&
      <Dialog open={showLateModal} onOpenChange={setShowLateModal}>
                    <DialogContent>
                        <DialogHeader>
                            <DialogTitle>Send "Running Late" Notification</DialogTitle>
                        </DialogHeader>
                        <div className="space-y-4">
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                This feature is configured in Settings ‚Üí Communication.
                            </p>
                            <p className="text-sm">
                                Would you like to go to settings to configure your late notification templates?
                            </p>
                        </div>
                        <DialogFooter>
                            <Button variant="outline" onClick={() => setShowLateModal(false)}>
                                Cancel
                            </Button>
                            <Button onClick={() => {
              setShowLateModal(false);
              window.location.href = createPageUrl('Settings') + '?tab=communication';
            }}>
                                Go to Settings
                            </Button>
                        </DialogFooter>
                    </DialogContent>
                </Dialog>
      }

            {/* Recurring Event Manager */}
            {showRecurringManager && nextEvent &&
      <RecurringEventManager
        appointment={nextEvent}
        onClose={() => setShowRecurringManager(false)}
        onUpdated={() => {
          queryClient.invalidateQueries({ queryKey: ['allUpcomingEvents'] });
          setDismissed(true); // Dismiss the current banner to force re-render/re-evaluation
        }}
        onEditFull={(apt) => {
          setShowRecurringManager(false);
          navigate(createPageUrl('Calendar') + `?editAppointment=${apt.id}`);
        }} />

      }
        </>);

}
import React, { memo } from 'react';
import { Card, CardContent } from "@/components/ui/card";
import { ArrowUp, ArrowDown, TrendingUp } from "lucide-react";

const OptimizedStatsCard = memo(({ 
  title, 
  value, 
  icon: Icon, 
  trend, 
  trendValue, 
  color = "indigo",
  onClick 
}) => {
  const colorClasses = {
    indigo: "from-indigo-500 to-indigo-600",
    green: "from-green-500 to-green-600",
    blue: "from-blue-500 to-blue-600",
    purple: "from-purple-500 to-purple-600",
    orange: "from-orange-500 to-orange-600",
    red: "from-red-500 to-red-600"
  };

  const gradient = colorClasses[color] || colorClasses.indigo;

  return (
    <Card 
      className="cursor-pointer hover:shadow-xl transition-all duration-300 border-2 border-slate-200 hover:border-indigo-300 overflow-hidden group"
      onClick={onClick}
    >
      <CardContent className="p-6">
        <div className="flex items-start justify-between">
          <div className="flex-1">
            <p className="text-sm font-medium text-slate-600 mb-2">{title}</p>
            <p className="text-4xl font-bold text-slate-900 mb-2">{value}</p>
            
            {trend && trendValue !== undefined && (
              <div className={`flex items-center gap-1 text-sm ${trend === 'up' ? 'text-green-600' : trend === 'down' ? 'text-red-600' : 'text-slate-600'}`}>
                {trend === 'up' ? <ArrowUp className="w-4 h-4" /> : trend === 'down' ? <ArrowDown className="w-4 h-4" /> : <TrendingUp className="w-4 h-4" />}
                <span className="font-semibold">{trendValue}%</span>
                <span className="text-slate-500">vs last period</span>
              </div>
            )}
          </div>
          
          <div className={`p-4 rounded-xl bg-gradient-to-br ${gradient} shadow-lg group-hover:scale-110 transition-transform duration-300`}>
            <Icon className="w-8 h-8 text-white" />
          </div>
        </div>
      </CardContent>
    </Card>
  );
}, (prevProps, nextProps) => {
  return (
    prevProps.value === nextProps.value &&
    prevProps.trendValue === nextProps.trendValue &&
    prevProps.trend === nextProps.trend
  );
});

OptimizedStatsCard.displayName = 'OptimizedStatsCard';

export default OptimizedStatsCard;
import React from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { 
  Target, 
  TrendingUp, 
  Users, 
  Home, 
  Sparkles,
  Award
} from "lucide-react";

export default function PersonalizedInsights({ user, stats, intelligence }) {
  const navigate = useNavigate();

  const getInsightsForProfile = () => {
    const profileType = user?.agent_profile_type;
    
    if (profileType === 'new_agent') {
      return {
        title: "Your Daily Action Plan",
        icon: Sparkles,
        color: "#3b82f6",
        insights: [
          {
            title: "üìö Today's Learning: Lead Generation Basics",
            message: "Spend 30 minutes learning about effective lead follow-up strategies. Follow up with 5 leads today.",
            action: "View Leads",
            link: "Leads"
          },
          {
            title: "üìû Daily Call Goal: Make 10 Calls",
            message: "Call 5 past clients and 5 sphere contacts. Ask if they know anyone buying or selling.",
            action: "View Contacts",
            link: "Contacts"
          },
          {
            title: "üéØ This Week: Set Up 3 Coffee Meetings",
            message: "Schedule face-to-face meetings with 3 people in your network to build relationships.",
            action: "Schedule",
            link: "Calendar"
          },
          {
            title: "üí° Skill Building: Property Pricing",
            message: "Research 3 comparable properties in your target area. Practice creating CMAs.",
            action: "Browse Properties",
            link: "Properties"
          }
        ]
      };
    }
    
    if (profileType === 'listing_specialist') {
      const targetNeighborhoods = user?.target_neighborhoods?.split(',').map(n => n.trim()).filter(Boolean) || [];
      return {
        title: "Listing Growth Opportunities",
        icon: Home,
        color: "#10b981",
        insights: [
          {
            title: `üéØ Geographic Farming: ${targetNeighborhoods[0] || 'Your Target Area'}`,
            message: `Send market reports to 50 homeowners in ${targetNeighborhoods[0] || 'your target neighborhood'}. You need consistent visibility to win listings.`,
            action: "Create Campaign",
            link: "MarketingCampaigns"
          },
          {
            title: "üìä Price Your Listings Competitively",
            message: intelligence?.overpriced > 0 
              ? `You have ${intelligence.overpriced} overpriced listings. Review pricing to generate more showings.`
              : "Your pricing strategy is on point! Keep analyzing market data.",
            action: "Review Properties",
            link: "Properties"
          },
          {
            title: "üöÄ Expired Listings Strategy",
            message: "Contact 5 expired listings this week. Offer a fresh marketing approach and competitive pricing analysis.",
            action: "Research Expireds",
            link: "Properties"
          },
          {
            title: "üí∞ Seller Lead Generation",
            message: `Focus on ${user?.target_price_range || 'your price range'}. Create targeted 'What's Your Home Worth?' campaigns.`,
            action: "Design Marketing",
            link: "MarketingDesignStudio"
          }
        ]
      };
    }
    
    if (profileType === 'buyer_specialist') {
      return {
        title: "Buyer Business Growth",
        icon: Users,
        color: "#f59e0b",
        insights: [
          {
            title: "üè† Active Buyer Opportunities",
            message: intelligence?.matchedBuyers > 0
              ? `${intelligence.matchedBuyers} buyers have matching properties! Schedule showings now.`
              : "Pre-qualify more buyers and set up property alerts for them.",
            action: "View Buyers",
            link: "Buyers"
          },
          {
            title: "üî• Hot Leads Needing Attention",
            message: intelligence?.hotLeads > 0
              ? `${intelligence.hotLeads} hot leads with immediate timeline. Priority follow-up needed!`
              : "Great job on lead follow-up! Keep nurturing your pipeline.",
            action: "Contact Leads",
            link: "Leads"
          },
          {
            title: "üìç Property Tours & Showings",
            message: "Schedule 5 property showings this week. More showings = more closings.",
            action: "Schedule Showings",
            link: "Showings"
          },
          {
            title: "üí≥ Financing Partnerships",
            message: "Connect with 2 lenders this month. Strong lender relationships help close deals faster.",
            action: "View Contacts",
            link: "Contacts"
          }
        ]
      };
    }
    
    if (profileType === 'dual_agent') {
      return {
        title: "Balanced Business Strategy",
        icon: TrendingUp,
        color: "#8b5cf6",
        insights: [
          {
            title: "‚öñÔ∏è Portfolio Balance",
            message: `Listings: ${stats.properties} | Buyers: ${stats.buyers}. Aim for 60/40 listing/buyer ratio for optimal income.`,
            action: "View Analytics",
            link: "Analytics"
          },
          {
            title: "üîÑ Double-End Opportunities",
            message: intelligence?.matchedBuyers > 0
              ? `${intelligence.matchedBuyers} buyers match your listings! Potential double-end deals.`
              : "Keep building both sides of your business for double-end opportunities.",
            action: "Match Buyers",
            link: "AIBuyerPropertyMatcher"
          },
          {
            title: "üìà Revenue Optimization",
            message: `Revenue growth: ${intelligence?.revenueGrowth}%. Focus on ${intelligence?.revenueGrowth < 10 ? 'increasing listings' : 'maintaining momentum'}.`,
            action: "View Commissions",
            link: "Commissions"
          },
          {
            title: "üéØ Time Management",
            message: intelligence?.staleLeads > 0
              ? `${intelligence.staleLeads} stale leads need attention. Prioritize high-value activities.`
              : "Excellent follow-up! Keep balancing buyer and listing activities.",
            action: "Review Tasks",
            link: "Tasks"
          }
        ]
      };
    }
    
    if (profileType === 'advanced_agent') {
      return {
        title: "Growth & Scale Strategies",
        icon: Award,
        color: "#ec4899",
        insights: [
          {
            title: "üíé Market Dominance",
            message: intelligence?.topNeighborhoods[0]
              ? `You're crushing it in ${intelligence.topNeighborhoods[0].city}! Expand to adjacent areas.`
              : "Identify your top-performing neighborhoods and double down on marketing there.",
            action: "Market Analysis",
            link: "Analytics"
          },
          {
            title: "üìä Lead Source ROI",
            message: intelligence?.bestSource
              ? `${intelligence.bestSource.source} converts at ${intelligence.bestSource.conversionRate}%. Invest more there!`
              : "Analyze your lead sources to find your best ROI channels.",
            action: "Lead Analytics",
            link: "Analytics"
          },
          {
            title: "‚ö° Pipeline Velocity",
            message: `Avg time to close: ${intelligence?.avgTimeToClose} days. ${intelligence?.avgTimeToClose > 45 ? 'Speed up your process' : 'Excellent efficiency!'}.`,
            action: "Process Optimization",
            link: "Transactions"
          },
          {
            title: "üöÄ Scale Your Business",
            message: intelligence?.predictedRevenue > 50000
              ? "You're ready to build a team! Consider hiring an assistant or junior agent."
              : "Focus on systemizing your business before hiring.",
            action: "Team Planning",
            link: "TeamMembers"
          }
        ]
      };
    }
    
    // Default insights
    return {
      title: "Business Recommendations",
      icon: Target,
      color: "#6366f1",
      insights: [
        {
          title: "Complete Your Agent Profile",
          message: "Set up your agent profile to get personalized recommendations tailored to your business goals.",
          action: "Setup Profile",
          link: "Settings"
        }
      ]
    };
  };

  const content = getInsightsForProfile();
  const Icon = content.icon;

  return (
    <Card className="border-l-4" style={{ borderLeftColor: content.color }}>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Icon className="w-5 h-5" style={{ color: content.color }} />
          {content.title}
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {content.insights.map((insight, idx) => (
            <div
              key={idx}
              className="p-3 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600 transition-colors"
            >
              <h4 className="font-semibold text-sm mb-2">{insight.title}</h4>
              <p className="text-xs text-slate-600 dark:text-slate-400 mb-3 line-clamp-2">{insight.message}</p>
              <Button
                size="sm"
                variant="outline"
                onClick={() => navigate(createPageUrl(insight.link))}
                className="w-full text-xs h-8"
              >
                {insight.action}
              </Button>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
import React from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { Building2, MapPin, BedDouble, Bath, Square, Edit, Trash2, Eye } from "lucide-react";

export default function PropertyCard({ property, progress, onView, onEdit, onDelete }) {
  const getStatusColor = (status) => {
    const colors = {
      active: "bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-700",
      pending: "bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-700",
      sold: "bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-700",
      cancelled: "bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-700"
    };
    return colors[status] || "bg-slate-100 text-slate-700 border-slate-200";
  };

  return (
    <Card className="overflow-hidden hover:shadow-xl transition-all duration-300 border border-slate-200 dark:border-slate-700 group">
      {/* Property Image */}
      {property.primary_photo_url ? (
        <div className="relative h-48 overflow-hidden">
          <img 
            src={property.primary_photo_url} 
            alt={property.address}
            className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
          />
          <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
          
          {/* Status Badge */}
          <div className="absolute top-3 right-3">
            <Badge className={`${getStatusColor(property.status)} border shadow-lg font-bold`}>
              {property.status?.toUpperCase()}
            </Badge>
          </div>

          {/* Price Overlay */}
          <div className="absolute bottom-3 left-3">
            <div className="bg-black/70 backdrop-blur-md rounded-lg px-3 py-1 border border-white/20">
              <p className="text-white font-bold text-lg">
                ${property.price?.toLocaleString() || 'N/A'}
              </p>
            </div>
          </div>
        </div>
      ) : (
        <div className="relative h-48 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-900 flex items-center justify-center">
          <Building2 className="w-16 h-16 text-slate-300 dark:text-slate-600" />
          
          {/* Status Badge */}
          <div className="absolute top-3 right-3">
            <Badge className={`${getStatusColor(property.status)} border font-bold`}>
              {property.status?.toUpperCase()}
            </Badge>
          </div>

          {/* Price */}
          <div className="absolute bottom-3 left-3">
            <div className="bg-black/70 backdrop-blur-md rounded-lg px-3 py-1 border border-white/20">
              <p className="text-white font-bold text-lg">
                ${property.price?.toLocaleString() || 'N/A'}
              </p>
            </div>
          </div>
        </div>
      )}

      <CardContent className="p-4 space-y-3">
        {/* Address */}
        <div>
          <h3 className="font-bold text-lg text-slate-900 dark:text-white mb-1 line-clamp-1">
            {property.address}
          </h3>
          <div className="flex items-center gap-1 text-sm text-slate-600 dark:text-slate-400">
            <MapPin className="w-3 h-3" />
            <span>{property.city}, {property.state}</span>
          </div>
        </div>

        {/* Property Details */}
        <div className="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400">
          {property.bedrooms && (
            <div className="flex items-center gap-1">
              <BedDouble className="w-4 h-4" />
              <span>{property.bedrooms} bed</span>
            </div>
          )}
          {property.bathrooms && (
            <div className="flex items-center gap-1">
              <Bath className="w-4 h-4" />
              <span>{property.bathrooms} bath</span>
            </div>
          )}
          {property.square_feet && (
            <div className="flex items-center gap-1">
              <Square className="w-4 h-4" />
              <span>{property.square_feet.toLocaleString()} sqft</span>
            </div>
          )}
        </div>

        {/* Progress Bars */}
        {progress && (
          <div className="space-y-3 pt-3 border-t border-slate-200 dark:border-slate-700">
            {/* Listing Progress */}
            <div>
              <div className="flex justify-between items-center mb-1.5">
                <span className="text-xs font-semibold text-slate-700 dark:text-slate-300">
                  Listing Progress
                </span>
                <span className="text-xs font-bold text-blue-600 dark:text-blue-400">
                  {progress.listing_side_progress}%
                </span>
              </div>
              <Progress value={progress.listing_side_progress} className="h-2">
                <div 
                  className="h-full bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-400 dark:to-blue-500 rounded-full transition-all duration-500"
                  style={{ width: `${progress.listing_side_progress}%` }}
                />
              </Progress>
            </div>

            {/* Selling Progress */}
            <div>
              <div className="flex justify-between items-center mb-1.5">
                <span className="text-xs font-semibold text-slate-700 dark:text-slate-300">
                  Selling Progress
                </span>
                <span className="text-xs font-bold text-purple-600 dark:text-purple-400">
                  {progress.selling_side_progress}%
                </span>
              </div>
              <Progress value={progress.selling_side_progress} className="h-2">
                <div 
                  className="h-full bg-gradient-to-r from-purple-500 to-purple-600 dark:from-purple-400 dark:to-purple-500 rounded-full transition-all duration-500"
                  style={{ width: `${progress.selling_side_progress}%` }}
                />
              </Progress>
            </div>
          </div>
        )}

        {/* Action Buttons */}
        <div className="flex gap-2 pt-3 border-t border-slate-200 dark:border-slate-700">
          <Button 
            variant="outline" 
            onClick={onView}
            className="flex-1 text-xs"
          >
            <Eye className="w-3 h-3 mr-1" />
            View
          </Button>
          {onEdit && (
            <Button 
              variant="outline" 
              onClick={onEdit}
              className="flex-1 text-xs"
            >
              <Edit className="w-3 h-3 mr-1" />
              Edit
            </Button>
          )}
          {onDelete && (
            <Button 
              variant="destructive" 
              onClick={onDelete}
              size="sm"
              className="text-xs px-2"
            >
              <Trash2 className="w-3 h-3" />
            </Button>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { toast } from 'sonner';

import LeadModal from '../leads/LeadModal';
import TaskModal from '../tasks/TaskModal';
import AppointmentModal from '../calendar/AppointmentModal';
import ContactModal from '../contacts/ContactModal';
import BuyerModal from '../buyers/BuyerModal';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Plus, Target, Building, UserPlus, CheckSquare, Calendar, Phone, Zap, DollarSign, Briefcase, Search } from 'lucide-react';
import GlobalSearch from '../common/GlobalSearch';

export default function QuickActionsWidget() {
    const actions = [
      { label: 'Add Lead', icon: Target, modal: 'lead', entity: 'Lead', gradient: 'from-slate-500 to-slate-600' },
      { label: 'Add Listing', icon: Building, action: 'navigate', page: 'PropertyAdd', gradient: 'from-sky-500 to-sky-600' },
      { label: 'Add Buyer', icon: UserPlus, modal: 'buyer', entity: 'Buyer', gradient: 'from-emerald-500 to-emerald-600' },
      { label: 'Add Task', icon: CheckSquare, modal: 'task', entity: 'Task', gradient: 'from-amber-500 to-amber-600' },
      { label: 'Add Event', icon: Calendar, modal: 'event', entity: 'Appointment', gradient: 'from-cyan-500 to-cyan-600' },
      { label: 'Add Contact', icon: Phone, modal: 'contact', entity: 'Contact', gradient: 'from-rose-500 to-rose-600' },
      { label: 'New Transaction', icon: Briefcase, action: 'navigate', page: 'Transactions?action=new', gradient: 'from-purple-500 to-purple-600' },
      { label: 'Mortgage Calc', icon: DollarSign, action: 'navigate', page: 'MortgageCalculator', gradient: 'from-indigo-500 to-indigo-600' },
    ];
    const [activeModal, setActiveModal] = useState(null);
    const navigate = useNavigate();
    const queryClient = useQueryClient();

    const { data: users } = useQuery({ queryKey: ['users'], queryFn: () => base44.entities.User.list(), initialData: [] });
    const { data: properties } = useQuery({ queryKey: ['properties'], queryFn: () => base44.entities.Property.list(), initialData: [] });
    const { data: campaigns } = useQuery({ queryKey: ['marketingCampaigns'], queryFn: () => base44.entities.MarketingCampaign.list(), initialData: [] });

    const handleActionClick = (action) => {
        if (action.modal) setActiveModal(action.modal);
        else if (action.action === 'navigate') navigate(createPageUrl(action.page));
    };

    const createMutation = useMutation({
        mutationFn: ({ entity, data }) => base44.entities[entity].create(data),
        onSuccess: (data, variables) => {
            queryClient.invalidateQueries({ queryKey: [variables.entity.toLowerCase() + 's'] });
            queryClient.invalidateQueries({ queryKey: ['dashboardData'] });
            window.dispatchEvent(new Event('refreshGlobalData'));
            toast.success(`${variables.entity} created successfully!`);
            setActiveModal(null);
        },
        onError: (error, variables) => {
            toast.error(`Failed to create ${variables.entity}: ${error.message}`);
        },
    });

    const handleSave = (entity) => (data) => {
        createMutation.mutate({ entity, data });
    };

    const renderModal = () => {
        switch (activeModal) {
            case 'lead':
                return <LeadModal users={users} campaigns={campaigns} onSave={handleSave('Lead')} onClose={() => setActiveModal(null)} />;
            case 'task':
                return <TaskModal users={users} properties={properties} onSave={handleSave('Task')} onClose={() => setActiveModal(null)} />;
            case 'event':
                return <AppointmentModal onSave={handleSave('Appointment')} onClose={() => setActiveModal(null)} users={users} properties={properties} />;
            case 'contact':
                return <ContactModal onSave={handleSave('Contact')} onClose={() => setActiveModal(null)} />;
            case 'buyer':
                return <BuyerModal users={users} onSave={handleSave('Buyer')} onClose={() => setActiveModal(null)} />;
            default:
                return null;
        }
    };
    
    return (
        <>
            <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
                <CardHeader className="p-3">
                    <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                        <Zap className="w-4 h-4 text-yellow-500" />
                        Quick Actions
                    </CardTitle>
                </CardHeader>
                <CardContent className="p-3 flex-grow flex flex-col gap-3">
                    <div className="w-full">
                        <GlobalSearch />
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 w-full flex-grow">
                        {actions.map(action => (
                            <button
                                key={action.label}
                                onClick={() => handleActionClick(action)}
                                className={`flex flex-col items-center justify-center p-2 rounded-lg text-white text-[11px] font-semibold h-16 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg bg-gradient-to-br ${action.gradient}`}
                            >
                                <action.icon className="w-5 h-5 mb-1" />
                                <span>{action.label}</span>
                            </button>
                        ))}
                    </div>
                </CardContent>
            </Card>
            {activeModal && renderModal()}
        </>
    );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { DollarSign, Users, Briefcase, TrendingUp } from 'lucide-react';

const StatCard = ({ title, value, icon: Icon, color, change }) => (
  <Card className="app-card overflow-hidden">
    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
      <CardTitle className="text-sm font-medium app-text-muted">{title}</CardTitle>
      <Icon className={`h-5 w-5 ${color}`} />
    </CardHeader>
    <CardContent>
      <div className="text-3xl font-bold app-title">{value}</div>
      {change && <p className="text-xs app-text-muted pt-1">{change}</p>}
    </CardContent>
  </Card>
);

export default function StatsCards({ leads = [], transactions = [] }) {
  const totalLeads = leads.length;
  const hotLeads = leads.filter(l => (l.score || 0) >= 70).length;
  const activeTransactions = transactions.filter(t => t.status === 'active' || t.status === 'pending').length;

  const totalRevenue = transactions
    .filter(t => t.status === 'closed')
    .reduce((acc, t) => acc + (t.listing_net_commission || 0) + (t.selling_net_commission || 0), 0);

  const formatCurrency = (amount) => {
    if (amount >= 1_000_000) {
      return `$${(amount / 1_000_000).toFixed(1)}M`;
    }
    if (amount >= 1_000) {
      return `$${(amount / 1_000).toFixed(0)}K`;
    }
    return `$${amount.toFixed(0)}`;
  };

  const stats = [
    { title: 'Total Leads', value: totalLeads, icon: Users, color: 'text-blue-500' },
    { title: 'Hot Leads', value: hotLeads, icon: TrendingUp, color: 'text-orange-500' },
    { title: 'Active Transactions', value: activeTransactions, icon: Briefcase, color: 'text-purple-500' },
    { title: 'Total Revenue', value: formatCurrency(totalRevenue), icon: DollarSign, color: 'text-green-500' },
  ];

  return (
    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      {stats.map((stat) => (
        <StatCard key={stat.title} {...stat} />
      ))}
    </div>
  );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { CheckSquare, AlertTriangle, ArrowRight, ListTodo } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { format, isToday, parseISO } from 'date-fns';
import { Badge } from '@/components/ui/badge';

export default function TasksList({ tasks = [] }) {
    const navigate = useNavigate();

    const getUrgency = (task) => {
        if (!task.due_date || task.status === 'completed' || task.status === 'cancelled') return 'normal';
        try {
            const dueDate = parseISO(task.due_date);
            if (isToday(dueDate)) return 'today';
            if (dueDate < new Date()) return 'overdue';
        } catch (e) {
            return 'normal';
        }
        return 'normal';
    };

    const urgentTasks = tasks
        .filter(t => ['pending', 'in_progress'].includes(t.status) && ['overdue', 'today'].includes(getUrgency(t)))
        .sort((a, b) => {
            const urgencyA = getUrgency(a);
            const urgencyB = getUrgency(b);
            if (urgencyA === 'overdue' && urgencyB !== 'overdue') return -1;
            if (urgencyA !== 'overdue' && urgencyB === 'overdue') return 1;
            try {
                const dateA = new Date(a.due_date);
                const dateB = new Date(b.due_date);
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateA - dateB;
            } catch (e) {
                return 0;
            }
        })
        .slice(0, 5);

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <ListTodo className="w-4 h-4 text-red-500" />
                    <span className={urgentTasks.length > 0 ? "animate-[flash_1s_ease-in-out_infinite]" : ""}>Urgent Tasks</span>
                    <style>{`
                        @keyframes flash {
                            0%, 100% { color: #dc2626; }
                            50% { color: #fca5a5; }
                        }
                    `}</style>
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('Tasks'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {urgentTasks.length > 0 ? (
                    <div className="space-y-1 h-full flex flex-col justify-around">
                        {urgentTasks.map(task => (
                            <div key={task.id} className="flex items-center justify-between p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50">
                                <div className="flex items-center gap-2">
                                    <CheckSquare className="w-3.5 h-3.5 text-slate-500" />
                                    <div>
                                        <p className={`font-medium text-xs ${getUrgency(task) === 'overdue' ? 'text-red-600 dark:text-red-400 animate-pulse' : 'text-slate-800 dark:text-slate-200'}`}>{task.title}</p>
                                        <div className="flex items-center gap-2 text-xs text-slate-500">
                                            {getUrgency(task) === 'overdue' ? (
                                                <Badge variant="destructive" className="text-[9px] px-1 py-0">Overdue</Badge>
                                            ) : (
                                                <Badge variant="outline" className="border-amber-500/50 text-amber-600 dark:text-amber-400 text-[9px] px-1 py-0">Due Today</Badge>
                                            )}
                                            <span className="text-[10px]">{(() => {
                                                try {
                                                    const date = parseISO(task.due_date);
                                                    return isNaN(date.getTime()) ? 'No date' : format(date, 'MMM d');
                                                } catch (e) {
                                                    return 'No date';
                                                }
                                            })()}</span>
                                        </div>
                                    </div>
                                </div>
                                <Button variant="ghost" size="icon" onClick={() => navigate(createPageUrl(`Tasks?highlight=${task.id}`))} className="h-6 w-6">
                                    <ArrowRight className="w-3.5 h-3.5" />
                                </Button>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No Urgent Tasks</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">You're all caught up!</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React, { useState, useEffect } from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { AlertTriangle, ArrowRight, X } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';

export default function TeamAttentionWidget({ inactiveCount }) {
    const navigate = useNavigate();
    const [isVisible, setIsVisible] = useState(false);

    useEffect(() => {
        if (inactiveCount > 0) {
            const dismissedUntil = localStorage.getItem('teamAttentionDismissedUntil');
            if (!dismissedUntil || new Date().getTime() > parseInt(dismissedUntil, 10)) {
                setIsVisible(true);
            } else {
                setIsVisible(false);
            }
        } else {
            setIsVisible(false);
        }
    }, [inactiveCount]);

    const handleDismiss = () => {
        const sevenDaysFromNow = new Date().getTime() + 7 * 24 * 60 * 60 * 1000;
        localStorage.setItem('teamAttentionDismissedUntil', sevenDaysFromNow.toString());
        setIsVisible(false);
    };

    if (!isVisible) {
        return null;
    }

    return (
        <Card className="app-card bg-gradient-to-br from-red-100 to-amber-100 dark:from-red-900/50 dark:to-amber-900/50 border-red-300 dark:border-red-700 relative">
            <Button
                variant="ghost"
                size="icon"
                className="absolute top-2 right-2 h-7 w-7 text-red-800/70 dark:text-red-300/70 hover:bg-red-200/50 dark:hover:bg-red-800/50"
                onClick={handleDismiss}
                aria-label="Dismiss for 7 days"
            >
                <X className="w-4 h-4" />
            </Button>
            <CardContent className="p-6 pr-10">
                <div className="flex items-center gap-4">
                    <div className="p-3 bg-red-500/20 rounded-full">
                        <AlertTriangle className="w-6 h-6 text-red-600 dark:text-red-300" />
                    </div>
                    <div className="flex-1">
                        <h3 className="font-semibold text-red-900 dark:text-red-200">Team Members Need Attention</h3>
                        <p className="text-sm text-red-800 dark:text-red-300">
                            {inactiveCount} {inactiveCount > 1 ? 'members have' : 'member has'} had no activity in the last 30 days.
                        </p>
                    </div>
                    <Button 
                        variant="secondary" 
                        size="sm" 
                        onClick={() => navigate(createPageUrl('TeamMembers'))}
                    >
                        Review Team <ArrowRight className="w-4 h-4 ml-2" />
                    </Button>
                </div>
            </CardContent>
        </Card>
    );
}
import React, { useMemo } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { TrendingUp, TrendingDown, Clock, Award } from 'lucide-react';
import { motion } from 'framer-motion';

export default function TimeMachineWidget({ leads = [], transactions = [], tasks = [] }) {
    const metrics = useMemo(() => {
        // Define baseline date (90 days ago or user's first activity)
        const now = new Date();
        const baselineDate = new Date();
        baselineDate.setDate(baselineDate.getDate() - 90);
        const midpointDate = new Date();
        midpointDate.setDate(midpointDate.getDate() - 45);

        // Split data into baseline period and recent period
        const baselineLeads = leads.filter(l => 
            new Date(l.created_date) >= baselineDate && 
            new Date(l.created_date) <= midpointDate
        );
        const recentLeads = leads.filter(l => 
            new Date(l.created_date) > midpointDate
        );

        const baselineTransactions = transactions.filter(t => 
            new Date(t.created_date) >= baselineDate && 
            new Date(t.created_date) <= midpointDate
        );
        const recentTransactions = transactions.filter(t => 
            new Date(t.created_date) > midpointDate
        );

        const baselineTasks = tasks.filter(t => 
            new Date(t.created_date) >= baselineDate && 
            new Date(t.created_date) <= midpointDate
        );
        const recentTasks = tasks.filter(t => 
            new Date(t.created_date) > midpointDate
        );

        // Calculate Lead Conversion Rate
        const baselineConverted = baselineLeads.filter(l => l.status === 'converted').length;
        const baselineConversionRate = baselineLeads.length > 0 
            ? (baselineConverted / baselineLeads.length) * 100 
            : 0;

        const recentConverted = recentLeads.filter(l => l.status === 'converted').length;
        const recentConversionRate = recentLeads.length > 0 
            ? (recentConverted / recentLeads.length) * 100 
            : 0;

        const conversionImprovement = recentConversionRate - baselineConversionRate;

        // Calculate Days to Close
        const baselineClosedDeals = baselineTransactions.filter(t => 
            t.status === 'closed' && t.important_dates
        );
        const baselineDaysToClose = baselineClosedDeals.length > 0
            ? baselineClosedDeals.reduce((sum, t) => {
                const dates = typeof t.important_dates === 'string' 
                    ? JSON.parse(t.important_dates) 
                    : t.important_dates;
                if (dates?.offer_date && dates?.closing_date) {
                    const start = new Date(dates.offer_date);
                    const end = new Date(dates.closing_date);
                    return sum + Math.floor((end - start) / (1000 * 60 * 60 * 24));
                }
                return sum;
            }, 0) / baselineClosedDeals.length
            : 0;

        const recentClosedDeals = recentTransactions.filter(t => 
            t.status === 'closed' && t.important_dates
        );
        const recentDaysToClose = recentClosedDeals.length > 0
            ? recentClosedDeals.reduce((sum, t) => {
                const dates = typeof t.important_dates === 'string' 
                    ? JSON.parse(t.important_dates) 
                    : t.important_dates;
                if (dates?.offer_date && dates?.closing_date) {
                    const start = new Date(dates.offer_date);
                    const end = new Date(dates.closing_date);
                    return sum + Math.floor((end - start) / (1000 * 60 * 60 * 24));
                }
                return sum;
            }, 0) / recentClosedDeals.length
            : 0;

        const daysImprovement = baselineDaysToClose - recentDaysToClose;

        // Calculate Task Completion Rate
        const baselineCompleted = baselineTasks.filter(t => t.status === 'completed').length;
        const baselineCompletionRate = baselineTasks.length > 0 
            ? (baselineCompleted / baselineTasks.length) * 100 
            : 0;

        const recentCompleted = recentTasks.filter(t => t.status === 'completed').length;
        const recentCompletionRate = recentTasks.length > 0 
            ? (recentCompleted / recentTasks.length) * 100 
            : 0;

        const completionImprovement = recentCompletionRate - baselineCompletionRate;

        return {
            conversionRate: {
                baseline: baselineConversionRate.toFixed(1),
                current: recentConversionRate.toFixed(1),
                improvement: conversionImprovement.toFixed(1),
                isPositive: conversionImprovement > 0
            },
            daysToClose: {
                baseline: baselineDaysToClose.toFixed(0),
                current: recentDaysToClose.toFixed(0),
                improvement: Math.abs(daysImprovement).toFixed(0),
                isPositive: daysImprovement > 0
            },
            taskCompletion: {
                baseline: baselineCompletionRate.toFixed(1),
                current: recentCompletionRate.toFixed(1),
                improvement: completionImprovement.toFixed(1),
                isPositive: completionImprovement > 0
            }
        };
    }, [leads, transactions, tasks]);

    const MetricCard = ({ title, icon: Icon, baseline, current, improvement, isPositive, suffix = '' }) => (
        <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            className="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700"
        >
            <div className="flex items-center gap-2 mb-3">
                <Icon className="w-4 h-4 text-slate-600 dark:text-slate-400" />
                <h4 className="text-sm font-semibold text-slate-700 dark:text-slate-300">{title}</h4>
            </div>
            <div className="space-y-2">
                <div className="flex items-baseline gap-2">
                    <span className="text-3xl font-bold text-slate-900 dark:text-white">
                        {current}{suffix}
                    </span>
                    {parseFloat(improvement) !== 0 && (
                        <div className={`flex items-center gap-1 ${isPositive ? 'text-green-600' : 'text-red-600'}`}>
                            {isPositive ? <TrendingUp className="w-4 h-4" /> : <TrendingDown className="w-4 h-4" />}
                            <span className="text-sm font-semibold">
                                {isPositive ? '+' : ''}{improvement}{suffix}
                            </span>
                        </div>
                    )}
                </div>
                <p className="text-xs text-slate-500 dark:text-slate-400">
                    vs. {baseline}{suffix} baseline (90 days ago)
                </p>
            </div>
        </motion.div>
    );

    const hasImprovement = 
        parseFloat(metrics.conversionRate.improvement) > 0 ||
        parseFloat(metrics.daysToClose.improvement) > 0 ||
        parseFloat(metrics.taskCompletion.improvement) > 0;

    return (
        <Card className="overflow-hidden">
            <CardHeader className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white pb-4">
                <div className="flex items-center gap-3">
                    <div className="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                        <Clock className="w-6 h-6" />
                    </div>
                    <div>
                        <CardTitle className="text-white">The Time Machine</CardTitle>
                        <p className="text-sm text-white/80 mt-1">Your Performance Improvement</p>
                    </div>
                </div>
            </CardHeader>
            <CardContent className="pt-6">
                {hasImprovement ? (
                    <>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <MetricCard
                                title="Lead Conversion"
                                icon={TrendingUp}
                                baseline={metrics.conversionRate.baseline}
                                current={metrics.conversionRate.current}
                                improvement={metrics.conversionRate.improvement}
                                isPositive={metrics.conversionRate.isPositive}
                                suffix="%"
                            />
                            <MetricCard
                                title="Days to Close"
                                icon={Clock}
                                baseline={metrics.daysToClose.baseline}
                                current={metrics.daysToClose.current}
                                improvement={metrics.daysToClose.improvement}
                                isPositive={metrics.daysToClose.isPositive}
                                suffix=" days"
                            />
                            <MetricCard
                                title="Task Completion"
                                icon={Award}
                                baseline={metrics.taskCompletion.baseline}
                                current={metrics.taskCompletion.current}
                                improvement={metrics.taskCompletion.improvement}
                                isPositive={metrics.taskCompletion.isPositive}
                                suffix="%"
                            />
                        </div>

                        <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                            <p className="text-sm text-green-800 dark:text-green-300 font-semibold">
                                üéâ Since using RealtyMind, your performance has measurably improved. 
                                {parseFloat(metrics.conversionRate.improvement) > 0 && 
                                    ` Your lead conversion rate increased by ${metrics.conversionRate.improvement}%.`}
                                {parseFloat(metrics.daysToClose.improvement) > 0 && 
                                    ` You're closing deals ${metrics.daysToClose.improvement} days faster.`}
                                {' '}RealtyMind is working for you!
                            </p>
                        </div>
                    </>
                ) : (
                    <div className="text-center py-8">
                        <Clock className="w-16 h-16 mx-auto mb-4 text-slate-300 dark:text-slate-600" />
                        <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-2">
                            Building Your Baseline
                        </h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400 max-w-md mx-auto">
                            Keep using RealtyMind! We'll start showing your performance improvements 
                            after 90 days of data collection.
                        </p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Share2, ArrowRight, Mail, Send } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Badge } from '@/components/ui/badge';

export default function ActiveCampaignsWidget({ campaigns = [] }) {
    const navigate = useNavigate();

    const activeCampaigns = campaigns
        .filter(c => ['active', 'scheduled'].includes(c.status))
        .slice(0, 3);

    const getStatusClass = (status) => {
        switch (status) {
            case 'active': return 'bg-green-100 text-green-800';
            case 'scheduled': return 'bg-blue-100 text-blue-800';
            default: return 'bg-slate-100 text-slate-800';
        }
    };

    return (
        <Card className="bg-white/30 dark:bg-slate-900/30 backdrop-blur-xl border border-white/20 dark:border-slate-800 rounded-lg shadow-lg h-full flex flex-col">
            <CardHeader className="flex flex-row items-center justify-between p-3">
                <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                    <Share2 className="w-4 h-4 text-cyan-500" />
                    Active Campaigns
                </CardTitle>
                <Button variant="ghost" size="sm" onClick={() => navigate(createPageUrl('MarketingCampaigns'))} className="text-primary hover:bg-primary/10 h-6 text-xs px-2">
                    View All
                </Button>
            </CardHeader>
            <CardContent className="p-3 flex-grow">
                {activeCampaigns.length > 0 ? (
                    <div className="space-y-2 h-full flex flex-col justify-around">
                        {activeCampaigns.map(campaign => (
                            <div key={campaign.id} className="flex items-start justify-between gap-2 p-1 rounded-md hover:bg-slate-50/50 dark:hover:bg-slate-800/50">
                                <div className="flex items-center gap-2">
                                    <div className="w-7 h-7 rounded-md bg-cyan-100 flex items-center justify-center flex-shrink-0">
                                        <Mail className="w-4 h-4 text-cyan-600" />
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-semibold text-xs text-slate-800 dark:text-slate-200 line-clamp-1">{campaign.name}</p>
                                        <div className="flex items-center gap-2">
                                            <Badge className={`capitalize ${getStatusClass(campaign.status)} text-[9px] px-1 py-0`}>{campaign.status}</Badge>
                                            <p className="text-[10px] text-slate-500 flex items-center gap-1"><Send className="w-2.5 h-2.5" /> {campaign.recipient_count || 0} recipients</p>
                                        </div>
                                    </div>
                                </div>
                                <Button variant="ghost" size="icon" onClick={() => navigate(createPageUrl(`MarketingCampaigns?id=${campaign.id}`))} className="h-6 w-6">
                                    <ArrowRight className="w-3.5 h-3.5" />
                                </Button>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center h-full flex flex-col justify-center items-center">
                        <p className="font-medium text-sm text-slate-700 dark:text-slate-300">No active campaigns.</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Launch a campaign to engage clients.</p>
                    </div>
                )}
            </CardContent>
        </Card>
    );
}
import React, { useState, useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import { toast } from 'sonner';
import {
    AlertCircle, Award, BarChart3, Brain, Briefcase, Calendar, Check, Clock, DollarSign, FileText, Flame, Home, Loader2, Mail, Megaphone, Newspaper, Radio, SlidersHorizontal, Sparkles, Target, TrendingUp, Users, X, UserPlus, Zap, Shield, Crown, Lock, Printer, LayoutGrid, Globe
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';

const TIER_NAMES = {
    1: 'Starter',
    2: 'Essential',
    3: 'Premium',
    4: 'Elite'
};

const TIER_COLORS = {
    1: 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300',
    2: 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300',
    3: 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300',
    4: 'bg-gradient-to-r from-amber-400 to-orange-500 text-white'
};

export const ALL_WIDGETS = [
    { key: 'ai_business_advisor', label: 'Business Advisor', icon: Brain, category: 'Intelligence & Insights', minTier: 4 },
    { key: 'ai_advisory', label: 'Advisory Panel', icon: Sparkles, category: 'Intelligence & Insights', minTier: 1 },
    { key: 'jackie_activities', label: 'Jackie Activities', icon: Sparkles, category: 'Intelligence & Insights', minTier: 1 },
    { key: 'time_machine', label: 'Time Machine', icon: Clock, category: 'Intelligence & Insights', minTier: 3 },
    { key: 'commission_chart', label: 'Year-to-Date Commission', icon: TrendingUp, category: 'Analytics', minTier: 1 },
    { key: 'pipeline_chart', label: 'Transaction Pipeline', icon: Briefcase, category: 'Analytics', minTier: 1 },
    { key: 'analytics_snapshot', label: 'Analytics Snapshot', icon: BarChart3, category: 'Analytics', minTier: 2 },
    { key: 'user_performance', label: 'My Performance', icon: Award, category: 'Analytics', minTier: 1 },
    { key: 'mortgage_rates', label: 'Mortgage Rates', icon: DollarSign, category: 'Market', minTier: 1 },
    { key: 'market_emotion', label: 'Market Emotion Index', icon: TrendingUp, category: 'Market', minTier: 2 },
    { key: 'news_sentiment', label: 'News Sentiment', icon: Newspaper, category: 'Market', minTier: 2 },
    { key: 'latest_news', label: 'Latest News', icon: Newspaper, category: 'Market', minTier: 2 },
    { key: 'scam_alerts', label: 'Scam Alerts', icon: Shield, category: 'Security', minTier: 1 },
    { key: 'quick_actions', label: 'Quick Actions', icon: Zap, category: 'Productivity', minTier: 1 },
    { key: 'quick_links', label: 'Quick Links', icon: Globe, category: 'Productivity', minTier: 1 },
    { key: 'urgent_tasks', label: 'Urgent Next Actions', icon: AlertCircle, category: 'Productivity', minTier: 1 },
    { key: 'hot_leads_list', label: 'Hot Leads', icon: Flame, category: 'Sales', minTier: 1 },
    { key: 'new_buyers', label: 'New Buyers', icon: UserPlus, category: 'Sales', minTier: 1 },
    { key: 'new_fsbo_leads', label: 'New FSBO Leads', icon: Target, category: 'Sales', minTier: 2 },
    { key: 'upcoming_events', label: 'Upcoming Events', icon: Calendar, category: 'Calendar', minTier: 1 },
    { key: 'next_meeting', label: 'Next Meeting', icon: Clock, category: 'Calendar', minTier: 1 },
    { key: 'recent_properties', label: 'Recent Properties', icon: Home, category: 'Properties', minTier: 1 },
    { key: 'active_campaigns', label: 'Active Campaigns', icon: Megaphone, category: 'Marketing', minTier: 2 },
    { key: 'recent_documents', label: 'Recent Documents', icon: FileText, category: 'Documents', minTier: 1 },
    { key: 'unread_messages', label: 'Unread Messages', icon: Mail, category: 'Communication', minTier: 1 },
    { key: 'team_proforma', label: 'Team Performance', icon: Users, category: 'Team', minTier: 2 },
    { key: 'social_media_radar', label: 'Social Media Radar', icon: Radio, category: 'Social', minTier: 3 },
    { key: 'investor_letters', label: 'Investor Letters Due', icon: Printer, category: 'Sales', minTier: 1 },
    { key: 'external_widget', label: 'External Widget', icon: LayoutGrid, category: 'Productivity', minTier: 1 },
];

export const DEFAULT_WIDGETS = [
    'ai_business_advisor',
    'jackie_activities',
    'time_machine',
    'commission_chart',
    'pipeline_chart',
    'ai_advisory',
    'mortgage_rates',
    'scam_alerts',
    'quick_actions',
    'urgent_tasks',
    'hot_leads_list',
];

// Group widgets by category
const getWidgetsByCategory = () => {
    const categories = {};
    ALL_WIDGETS.forEach(widget => {
        if (!categories[widget.category]) {
            categories[widget.category] = [];
        }
        categories[widget.category].push(widget);
    });
    return categories;
};

export default function CustomizeDashboardModal({ user, enabledWidgets, onClose, onSave, isSaving, subscriptionData }) {
    const [selectedWidgets, setSelectedWidgets] = useState(enabledWidgets);
    const widgetsByCategory = getWidgetsByCategory();
    
    // Get user's tier level from subscription data - handle both number and string formats
    const rawTierLevel = subscriptionData?.tierLevel;
    const rawPlanName = subscriptionData?.planName || '';
    
    // Determine tier level - check if it's a number, or derive from plan name
    let userTierLevel = 1;
    if (typeof rawTierLevel === 'number') {
        userTierLevel = rawTierLevel;
    } else if (typeof rawTierLevel === 'string') {
        // Try to parse as number first
        const parsed = parseInt(rawTierLevel, 10);
        if (!isNaN(parsed)) {
            userTierLevel = parsed;
        } else {
            // Check if it's a tier name
            const tierNameLower = rawTierLevel.toLowerCase();
            if (tierNameLower === 'elite') userTierLevel = 4;
            else if (tierNameLower === 'premium') userTierLevel = 3;
            else if (tierNameLower === 'essential') userTierLevel = 2;
            else userTierLevel = 1;
        }
    } else if (rawPlanName) {
        // Derive from plan name
        const planNameLower = rawPlanName.toLowerCase();
        if (planNameLower.includes('elite')) userTierLevel = 4;
        else if (planNameLower.includes('premium')) userTierLevel = 3;
        else if (planNameLower.includes('essential')) userTierLevel = 2;
        else userTierLevel = 1;
    }
    
    const currentPlanName = rawPlanName || TIER_NAMES[userTierLevel] || 'Starter';

    const isWidgetAvailable = (widget) => {
        if (!widget) return false;
        // If user has tier 4 (Elite), everything is available
        if (userTierLevel >= 4) return true;
        return !widget.minTier || userTierLevel >= widget.minTier;
    };

    useEffect(() => {
        setSelectedWidgets(enabledWidgets);
    }, [enabledWidgets]);

    const handleToggleWidget = (widgetKey) => {
        const widget = ALL_WIDGETS.find(w => w.key === widgetKey);
        
        if (!isWidgetAvailable(widget)) {
            toast.error(
                `This widget requires ${TIER_NAMES[widget.minTier]} plan or higher`,
                {
                    description: 'Upgrade your subscription to unlock this feature',
                    action: {
                        label: 'Upgrade',
                        onClick: () => {
                            onClose();
                            window.location.href = '/settings';
                        }
                    }
                }
            );
            return;
        }
        
        setSelectedWidgets(prev =>
            prev.includes(widgetKey)
                ? prev.filter(key => key !== widgetKey)
                : [...prev, widgetKey]
        );
    };

    const handleSelectAll = () => {
        setSelectedWidgets(ALL_WIDGETS.map(w => w.key));
    };

    const handleDeselectAll = () => {
        setSelectedWidgets([]);
    };

    const handleSave = () => {
        onSave(selectedWidgets);
    };

    return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                <header className="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                            <SlidersHorizontal className="w-5 h-5 text-white" />
                        </div>
                        <div>
                            <h2 className="text-xl font-bold text-slate-900 dark:text-white">Customize Your Dashboard</h2>
                            <p className="text-sm text-slate-500 dark:text-slate-400">
                                {selectedWidgets.length} of {ALL_WIDGETS.length} widgets selected
                            </p>
                        </div>
                    </div>
                    <Button variant="ghost" size="icon" onClick={onClose} className="rounded-full">
                        <X className="w-5 h-5" />
                    </Button>
                </header>

                <div className="p-6 flex-grow overflow-y-auto">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2">
                            <Crown className="w-5 h-5 text-indigo-600" />
                            <span className="text-sm font-semibold text-slate-700 dark:text-slate-300">Your Plan:</span>
                            <span className={`px-3 py-1 text-sm font-bold rounded-full ${TIER_COLORS[userTierLevel]}`}>
                                {currentPlanName}
                            </span>
                        </div>
                        <div className="flex gap-2">
                            <Button variant="outline" size="sm" onClick={handleSelectAll}>
                                Select All
                            </Button>
                            <Button variant="outline" size="sm" onClick={handleDeselectAll}>
                                Clear All
                            </Button>
                        </div>
                    </div>
                    <p className="text-slate-600 dark:text-slate-400 mb-6">
                        Select widgets to display. Widgets show which plan tier is required.
                    </p>

                    <div className="space-y-6">
                        {Object.entries(widgetsByCategory).map(([category, widgets]) => (
                            <div key={category}>
                                <h3 className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                                    <span className="w-2 h-2 rounded-full bg-indigo-500"></span>
                                    {category}
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {widgets.map(widget => {
                                        const isSelected = selectedWidgets.includes(widget.key);
                                        const isAvailable = isWidgetAvailable(widget);
                                        
                                        return (
                                            <button
                                                key={widget.key}
                                                onClick={() => handleToggleWidget(widget.key)}
                                                disabled={!isAvailable}
                                                className={`flex items-center justify-between p-4 rounded-xl border-2 transition-all duration-200 text-left ${
                                                    !isAvailable
                                                        ? 'bg-slate-100 dark:bg-slate-800/30 border-slate-200 dark:border-slate-700 opacity-60 cursor-not-allowed'
                                                        : isSelected
                                                            ? 'bg-indigo-50 dark:bg-indigo-900/30 border-indigo-500 shadow-md'
                                                            : 'bg-slate-50 dark:bg-slate-700/50 border-transparent hover:border-slate-300 dark:hover:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700'
                                                }`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-9 h-9 rounded-lg flex items-center justify-center ${
                                                        !isAvailable
                                                            ? 'bg-slate-200 dark:bg-slate-700'
                                                            : isSelected 
                                                                ? 'bg-indigo-100 dark:bg-indigo-800' 
                                                                : 'bg-slate-200 dark:bg-slate-600'
                                                    }`}>
                                                        <widget.icon className={`w-5 h-5 ${
                                                            !isAvailable
                                                                ? 'text-slate-400 dark:text-slate-500'
                                                                : isSelected 
                                                                    ? 'text-indigo-600 dark:text-indigo-400' 
                                                                    : 'text-slate-500 dark:text-slate-400'
                                                        }`} />
                                                    </div>
                                                    <div className="flex flex-col items-start">
                                                        <span className={`font-medium ${
                                                            !isAvailable
                                                                ? 'text-slate-400 dark:text-slate-500'
                                                                : isSelected 
                                                                    ? 'text-slate-900 dark:text-white' 
                                                                    : 'text-slate-700 dark:text-slate-300'
                                                        }`}>
                                                            {widget.label}
                                                        </span>
                                                        <span className={`text-xs px-2 py-0.5 rounded-full mt-1 ${TIER_COLORS[widget.minTier || 1]}`}>
                                                            {TIER_NAMES[widget.minTier || 1]}
                                                        </span>
                                                    </div>
                                                </div>
                                                {!isAvailable ? (
                                                    <Lock className="w-5 h-5 text-slate-400 dark:text-slate-500 flex-shrink-0" />
                                                ) : isSelected && (
                                                    <div className="w-6 h-6 rounded-full bg-indigo-600 flex items-center justify-center flex-shrink-0">
                                                        <Check className="w-4 h-4 text-white" />
                                                    </div>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                <footer className="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
                    <Button variant="outline" onClick={onClose} disabled={isSaving}>
                        Cancel
                    </Button>
                    <Button onClick={handleSave} disabled={isSaving} className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700">
                        {isSaving ? (
                            <>
                                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                Saving...
                            </>
                        ) : "Save Preferences"}
                    </Button>
                </footer>
            </div>
        </div>
    );
}
import React, { useEffect, useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Sparkles, X } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { base44 } from '@/api/base44Client';

export default function DailyConfidenceBoost({ user }) {
    const [boost, setBoost] = useState(null);
    const [isVisible, setIsVisible] = useState(false);

    useEffect(() => {
        if (!user) return;
        
        const fetchBoost = async () => {
            try {
                const response = await base44.functions.invoke('generateDailyBoost');
                if (response.data?.shouldShow && response.data?.message) {
                    setBoost(response.data);
                    setIsVisible(true);
                }
            } catch (error) {
                console.error('Error fetching daily boost:', error);
            }
        };

        fetchBoost();
    }, [user]);

    if (!isVisible || !boost) return null;

    return (
        <AnimatePresence>
            {isVisible && (
                <motion.div
                    initial={{ opacity: 0, y: -20, scale: 0.95 }}
                    animate={{ opacity: 1, y: 0, scale: 1 }}
                    exit={{ opacity: 0, y: -20, scale: 0.95 }}
                    className="mb-6"
                >
                    <div className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-6 shadow-2xl">
                        {/* Animated background sparkles */}
                        <div className="absolute inset-0 overflow-hidden">
                            {[...Array(20)].map((_, i) => (
                                <motion.div
                                    key={i}
                                    className="absolute w-1 h-1 bg-white rounded-full"
                                    style={{
                                        left: `${Math.random() * 100}%`,
                                        top: `${Math.random() * 100}%`
                                    }}
                                    animate={{
                                        opacity: [0, 1, 0],
                                        scale: [0, 1.5, 0]
                                    }}
                                    transition={{
                                        duration: 2 + Math.random() * 2,
                                        repeat: Infinity,
                                        delay: Math.random() * 2
                                    }}
                                />
                            ))}
                        </div>

                        <div className="relative flex items-start justify-between gap-4">
                            <div className="flex items-start gap-4 flex-1">
                                <motion.div
                                    animate={{ rotate: [0, 10, -10, 0] }}
                                    transition={{ duration: 2, repeat: Infinity }}
                                    className="flex-shrink-0"
                                >
                                    <div className="w-14 h-14 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                        <Sparkles className="w-8 h-8 text-white" />
                                    </div>
                                </motion.div>
                                
                                <div className="flex-1">
                                    <h3 className="text-white font-bold text-xl mb-2">
                                        Daily Confidence Boost
                                    </h3>
                                    <p className="text-white/95 text-base leading-relaxed">
                                        {boost.message.split('**').map((part, idx) => 
                                            idx % 2 === 1 ? <strong key={idx}>{part}</strong> : part
                                        )}
                                    </p>
                                    
                                    {boost.metrics && (
                                        <div className="mt-4 flex flex-wrap gap-3">
                                            {boost.metrics.taskCompletionRate > 0 && (
                                                <div className="bg-white/10 backdrop-blur-sm rounded-lg px-3 py-1.5 text-white text-sm">
                                                    üìã {boost.metrics.taskCompletionRate}% Tasks Done
                                                </div>
                                            )}
                                            {boost.metrics.hotLeads > 0 && (
                                                <div className="bg-white/10 backdrop-blur-sm rounded-lg px-3 py-1.5 text-white text-sm">
                                                    üî• {boost.metrics.hotLeads} Hot Leads
                                                </div>
                                            )}
                                            {boost.metrics.convertedLeads > 0 && (
                                                <div className="bg-white/10 backdrop-blur-sm rounded-lg px-3 py-1.5 text-white text-sm">
                                                    ‚úÖ {boost.metrics.convertedLeads} Converted
                                                </div>
                                            )}
                                            {boost.metrics.recentTransactions > 0 && (
                                                <div className="bg-white/10 backdrop-blur-sm rounded-lg px-3 py-1.5 text-white text-sm">
                                                    üìà {boost.metrics.recentTransactions} Transactions
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <Button
                                variant="ghost"
                                size="icon"
                                onClick={() => setIsVisible(false)}
                                className="text-white/70 hover:text-white hover:bg-white/10 flex-shrink-0"
                            >
                                <X className="w-5 h-5" />
                            </Button>
                        </div>
                    </div>
                </motion.div>
            )}
        </AnimatePresence>
    );
}
import React, { useState, useEffect, useRef } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { X, Settings, Maximize2, Minimize2, GripVertical } from 'lucide-react';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';

export default function FloatingExternalWidget({ user, isEmbedded = false }) {
  const [isVisible, setIsVisible] = useState(false);
  const [isMinimized, setIsMinimized] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [position, setPosition] = useState({ x: 100, y: 100 });
  const [size, setSize] = useState({ width: 400, height: 300 });
  const [isDragging, setIsDragging] = useState(false);
  const [isResizing, setIsResizing] = useState(false);
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
  const [config, setConfig] = useState({
    url: '',
    title: 'External Widget'
  });
  const [tempUrl, setTempUrl] = useState('');
  const [tempTitle, setTempTitle] = useState('');
  const [iframeError, setIframeError] = useState(false);
  const widgetRef = useRef(null);

  // Load saved config from user data
  useEffect(() => {
    if (user?.external_widget_config) {
      try {
        const savedConfig = JSON.parse(user.external_widget_config);
        setConfig(savedConfig.config || { url: '', title: 'External Widget' });
        setPosition(savedConfig.position || { x: 100, y: 100 });
        setSize(savedConfig.size || { width: 400, height: 300 });
        setIsVisible(savedConfig.isVisible || false);
      } catch (e) {
        console.error('Error loading widget config:', e);
      }
    }
  }, [user]);

  // Save config to user data
  const saveConfig = async (newConfig, newPosition, newSize, visible) => {
    try {
      await base44.auth.updateMe({
        external_widget_config: JSON.stringify({
          config: newConfig,
          position: newPosition,
          size: newSize,
          isVisible: visible
        })
      });
    } catch (error) {
      console.error('Error saving widget config:', error);
    }
  };

  const handleMouseDown = (e) => {
    if (e.target.closest('.drag-handle')) {
      setIsDragging(true);
      setDragOffset({
        x: e.clientX - position.x,
        y: e.clientY - position.y
      });
    }
  };

  const handleMouseMove = (e) => {
    if (isDragging) {
      const newX = e.clientX - dragOffset.x;
      const newY = e.clientY - dragOffset.y;
      setPosition({ x: newX, y: newY });
    }
    if (isResizing) {
      const newWidth = Math.max(300, e.clientX - position.x);
      const newHeight = Math.max(200, e.clientY - position.y);
      setSize({ width: newWidth, height: newHeight });
    }
  };

  const handleMouseUp = () => {
    if (isDragging || isResizing) {
      saveConfig(config, position, size, isVisible);
    }
    setIsDragging(false);
    setIsResizing(false);
  };

  useEffect(() => {
    if (isDragging || isResizing) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
      return () => {
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isDragging, isResizing, dragOffset, position]);

  const handleSaveSettings = async () => {
    const newConfig = { url: tempUrl, title: tempTitle };
    setConfig(newConfig);
    setIframeError(false);
    await saveConfig(newConfig, position, size, isVisible);
    setShowSettings(false);
    toast.success('Widget settings saved!');
  };

  const handleClose = async () => {
    setIsVisible(false);
    await saveConfig(config, position, size, false);
  };

  const handleToggleMinimize = () => {
    setIsMinimized(!isMinimized);
  };

  // Embedded mode: always show inline
  if (isEmbedded) {
    return (
      <Card className="h-full flex flex-col overflow-hidden">
        <CardHeader className="p-3 bg-gradient-to-r from-indigo-600 to-purple-600 flex-none">
          <div className="flex items-center justify-between">
            <CardTitle className="text-sm text-white flex items-center gap-2">
              <GripVertical className="w-4 h-4" />
              {config.title || 'External Widget'}
            </CardTitle>
            <Button
              variant="ghost"
              size="icon"
              className="h-6 w-6 text-white hover:bg-white/20"
              onClick={(e) => {
                e.stopPropagation();
                setTempUrl(config.url);
                setTempTitle(config.title);
                setShowSettings(true);
              }}
            >
              <Settings className="w-3 h-3" />
            </Button>
          </div>
        </CardHeader>
        <CardContent className="p-0 flex-1 overflow-hidden">
          {config.url ? (
            iframeError ? (
              <div className="flex flex-col items-center justify-center h-full text-center p-6 bg-amber-50 dark:bg-amber-900/20">
                <div className="max-w-sm">
                  <X className="w-12 h-12 text-amber-600 mx-auto mb-3" />
                  <p className="font-semibold text-slate-900 dark:text-white mb-2">Can't Embed This Site</p>
                  <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                    {config.url.includes('google.com') || config.url.includes('gmail') 
                      ? 'Gmail blocks iframe embedding for security.'
                      : 'This site doesn\'t allow iframe embedding.'}
                  </p>
                  <div className="flex gap-2 justify-center">
                    <Button
                      size="sm"
                      onClick={() => window.open(config.url, '_blank')}
                      className="bg-blue-600 hover:bg-blue-700"
                    >
                      Open in New Tab
                    </Button>
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => {
                        setTempUrl('');
                        setTempTitle('External Widget');
                        setShowSettings(true);
                        setIframeError(false);
                      }}
                    >
                      Try Different Site
                    </Button>
                  </div>
                </div>
              </div>
            ) : (
              <iframe
                src={config.url}
                className="w-full h-full border-0"
                title={config.title}
                sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
                onError={() => setIframeError(true)}
              />
            )
          ) : (
            <div className="flex items-center justify-center h-full text-center p-6 text-slate-500">
              <div>
                <p className="mb-2">No URL configured</p>
                <Button
                  size="sm"
                  onClick={() => {
                    setTempUrl('');
                    setTempTitle('External Widget');
                    setShowSettings(true);
                  }}
                >
                  <Settings className="w-3 h-3 mr-1" />
                  Configure
                </Button>
              </div>
            </div>
          )}
        </CardContent>

        {/* Settings Dialog */}
        <Dialog open={showSettings} onOpenChange={setShowSettings}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Widget Settings</DialogTitle>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div className="space-y-2">
                <Label htmlFor="widget-title">Widget Title</Label>
                <Input
                  id="widget-title"
                  value={tempTitle}
                  onChange={(e) => setTempTitle(e.target.value)}
                  placeholder="e.g., Traffic Cam, Home Camera"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="widget-url">External URL</Label>
                <Input
                  id="widget-url"
                  value={tempUrl}
                  onChange={(e) => setTempUrl(e.target.value)}
                  placeholder="https://example.com"
                />
                <p className="text-xs text-slate-500">
                  Enter any URL. Note: Gmail, Facebook, and some sites block iframe embedding.
                </p>
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setShowSettings(false)}>
                Cancel
              </Button>
              <Button onClick={handleSaveSettings}>
                Save
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </Card>
    );
  }

  // Floating mode
  if (!isVisible) {
    return (
      <Button
        onClick={() => {
          setIsVisible(true);
          saveConfig(config, position, size, true);
        }}
        className="fixed bottom-4 left-4 z-50 shadow-lg"
        size="sm"
      >
        <GripVertical className="w-4 h-4 mr-2" />
        Show Widget
      </Button>
    );
  }

  return (
    <>
      <div
        ref={widgetRef}
        className="fixed z-[9999] shadow-2xl"
        style={{
          left: `${position.x}px`,
          top: `${position.y}px`,
          width: isMinimized ? 'auto' : `${size.width}px`,
          height: isMinimized ? 'auto' : `${size.height}px`,
          cursor: isDragging ? 'grabbing' : 'default'
        }}
        onMouseDown={handleMouseDown}
      >
        <Card className="h-full flex flex-col overflow-hidden">
          <CardHeader className="drag-handle cursor-grab active:cursor-grabbing p-3 bg-gradient-to-r from-indigo-600 to-purple-600 flex-none">
            <div className="flex items-center justify-between">
              <CardTitle className="text-sm text-white flex items-center gap-2">
                <GripVertical className="w-4 h-4" />
                {config.title || 'External Widget'}
              </CardTitle>
              <div className="flex gap-1">
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-6 w-6 text-white hover:bg-white/20"
                  onClick={(e) => {
                    e.stopPropagation();
                    setTempUrl(config.url);
                    setTempTitle(config.title);
                    setShowSettings(true);
                  }}
                >
                  <Settings className="w-3 h-3" />
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-6 w-6 text-white hover:bg-white/20"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleToggleMinimize();
                  }}
                >
                  {isMinimized ? <Maximize2 className="w-3 h-3" /> : <Minimize2 className="w-3 h-3" />}
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-6 w-6 text-white hover:bg-white/20"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleClose();
                  }}
                >
                  <X className="w-3 h-3" />
                </Button>
              </div>
            </div>
          </CardHeader>

          {!isMinimized && (
            <>
              <CardContent className="p-0 flex-1 overflow-hidden relative">
                {config.url ? (
                  iframeError ? (
                    <div className="flex flex-col items-center justify-center h-full text-center p-6 bg-amber-50 dark:bg-amber-900/20">
                      <div className="max-w-sm">
                        <X className="w-12 h-12 text-amber-600 mx-auto mb-3" />
                        <p className="font-semibold text-slate-900 dark:text-white mb-2">Can't Embed This Site</p>
                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                          {config.url.includes('google.com') || config.url.includes('gmail') 
                            ? 'Gmail blocks iframe embedding for security.'
                            : 'This site doesn\'t allow iframe embedding.'}
                        </p>
                        <div className="flex gap-2 justify-center">
                          <Button
                            size="sm"
                            onClick={() => window.open(config.url, '_blank')}
                            className="bg-blue-600 hover:bg-blue-700"
                          >
                            Open in New Tab
                          </Button>
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => {
                              setTempUrl('');
                              setTempTitle('External Widget');
                              setShowSettings(true);
                              setIframeError(false);
                            }}
                          >
                            Try Different Site
                          </Button>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <iframe
                      src={config.url}
                      className="w-full h-full border-0"
                      title={config.title}
                      sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
                      onError={() => setIframeError(true)}
                    />
                  )
                ) : (
                  <div className="flex items-center justify-center h-full text-center p-6 text-slate-500">
                    <div>
                      <p className="mb-2">No URL configured</p>
                      <Button
                        size="sm"
                        onClick={() => {
                          setTempUrl('');
                          setTempTitle('External Widget');
                          setShowSettings(true);
                        }}
                      >
                        <Settings className="w-3 h-3 mr-1" />
                        Configure
                      </Button>
                    </div>
                  </div>
                )}
              </CardContent>

              {/* Resize handle */}
              <div
                className="absolute bottom-0 right-0 w-4 h-4 cursor-se-resize bg-slate-300 hover:bg-slate-400"
                onMouseDown={(e) => {
                  e.stopPropagation();
                  setIsResizing(true);
                }}
              />
            </>
          )}
        </Card>
      </div>

      {/* Settings Dialog */}
      <Dialog open={showSettings} onOpenChange={setShowSettings}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Widget Settings</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="widget-title">Widget Title</Label>
              <Input
                id="widget-title"
                value={tempTitle}
                onChange={(e) => setTempTitle(e.target.value)}
                placeholder="e.g., Traffic Cam, Home Camera"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="widget-url">External URL</Label>
              <Input
                id="widget-url"
                value={tempUrl}
                onChange={(e) => setTempUrl(e.target.value)}
                placeholder="https://example.com"
              />
              <p className="text-xs text-slate-500">
                Enter any URL (camera feed, traffic map, weather widget, etc.)
              </p>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowSettings(false)}>
              Cancel
            </Button>
            <Button onClick={handleSaveSettings}>
              Save
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
}
import React from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Printer, Mail, Building, ChevronRight, AlertTriangle } from 'lucide-react';
import { format, differenceInDays } from 'date-fns';

export default function InvestorLettersWidget() {
  const { data: properties = [], isLoading: isLoadingProperties } = useQuery({
    queryKey: ['investorProperties'],
    queryFn: () => base44.entities.InvestorProperty.list('-created_date'),
    staleTime: 5 * 60 * 1000
  });

  const { data: campaigns = [], isLoading: isLoadingCampaigns } = useQuery({
    queryKey: ['investorMailCampaigns'],
    queryFn: () => base44.entities.InvestorMailCampaign.list(),
    staleTime: 5 * 60 * 1000
  });

  const lettersDue = React.useMemo(() => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    return properties
      .filter(p => {
        if (!p.mail_campaign_id || !p.next_followup_date) return false;
        const followupDate = new Date(p.next_followup_date);
        followupDate.setHours(0, 0, 0, 0);
        return followupDate <= today && (p.mail_campaign_step || 0) < 12;
      })
      .map(property => {
        const campaign = campaigns.find(c => c.id === property.mail_campaign_id);
        const followupDate = new Date(property.next_followup_date);
        const daysOverdue = differenceInDays(today, followupDate);
        return { property, campaign, daysOverdue };
      })
      .filter(item => item.campaign)
      .sort((a, b) => b.daysOverdue - a.daysOverdue);
  }, [properties, campaigns]);

  const isLoading = isLoadingProperties || isLoadingCampaigns;

  if (isLoading) {
    return (
      <Card className="h-full">
        <CardHeader className="pb-2">
          <CardTitle className="text-base flex items-center gap-2">
            <Printer className="w-4 h-4" />
            Investor Letters
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="animate-pulse space-y-3">
            <div className="h-12 bg-slate-200 dark:bg-slate-700 rounded" />
            <div className="h-12 bg-slate-200 dark:bg-slate-700 rounded" />
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="h-full">
      <CardHeader className="pb-2">
        <div className="flex items-center justify-between">
          <CardTitle className="text-base flex items-center gap-2">
            <Printer className="w-4 h-4 text-orange-500" />
            Investor Letters
            {lettersDue.length > 0 && (
              <Badge className="bg-orange-500 text-white ml-1">{lettersDue.length}</Badge>
            )}
          </CardTitle>
          <Link to={createPageUrl('InvestorHub')}>
            <Button variant="ghost" size="sm" className="text-xs">
              View All <ChevronRight className="w-3 h-3 ml-1" />
            </Button>
          </Link>
        </div>
      </CardHeader>
      <CardContent>
        {lettersDue.length === 0 ? (
          <div className="text-center py-6">
            <div className="w-12 h-12 mx-auto mb-3 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
              <Mail className="w-6 h-6 text-emerald-600 dark:text-emerald-400" />
            </div>
            <p className="text-sm font-medium text-slate-700 dark:text-slate-300">All caught up!</p>
            <p className="text-xs text-slate-500 dark:text-slate-400">No letters due for printing</p>
          </div>
        ) : (
          <div className="space-y-2 max-h-[280px] overflow-y-auto">
            {lettersDue.slice(0, 5).map(({ property, campaign, daysOverdue }) => (
              <div 
                key={property.id}
                className={`p-3 rounded-lg border transition-colors ${
                  daysOverdue > 7 
                    ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' 
                    : daysOverdue > 0
                      ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800'
                      : 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800'
                }`}
              >
                <div className="flex items-start gap-2">
                  <div className={`p-1.5 rounded-lg flex-shrink-0 ${
                    daysOverdue > 7 
                      ? 'bg-red-500' 
                      : daysOverdue > 0 
                        ? 'bg-orange-500' 
                        : 'bg-amber-500'
                  }`}>
                    <Printer className="w-3 h-3 text-white" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-slate-900 dark:text-white truncate">
                      {property.address}
                    </p>
                    <p className="text-xs text-slate-500 dark:text-slate-400">
                      {property.owner_name || 'Unknown Owner'} ‚Ä¢ Letter {(property.mail_campaign_step || 0) + 1}/12
                    </p>
                    <div className="flex items-center gap-2 mt-1">
                      {daysOverdue > 0 ? (
                        <span className="flex items-center gap-1 text-xs font-medium text-red-600 dark:text-red-400">
                          <AlertTriangle className="w-3 h-3" />
                          {daysOverdue} day{daysOverdue > 1 ? 's' : ''} overdue
                        </span>
                      ) : (
                        <span className="text-xs font-medium text-amber-600 dark:text-amber-400">
                          Due today
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ))}
            {lettersDue.length > 5 && (
              <Link to={createPageUrl('InvestorHub')}>
                <div className="text-center py-2 text-sm text-indigo-600 dark:text-indigo-400 hover:underline cursor-pointer">
                  +{lettersDue.length - 5} more letters due
                </div>
              </Link>
            )}
          </div>
        )}
      </CardContent>
    </Card>
  );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Sparkles, FileText, CheckSquare, ExternalLink, Clock, CheckCircle, Loader2 } from 'lucide-react';
import { format } from 'date-fns';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';

export default function JackieActivitiesWidget({ tasks = [], documents = [], properties = [] }) {
    const navigate = useNavigate();

    // Filter for Jackie-created items (last 7 days)
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    const jackieTasks = tasks
        .filter(t => 
            t.description && 
            t.description.toLowerCase().includes('jackie') ||
            t.description && t.description.toLowerCase().includes('voice') ||
            t.title && t.title.toLowerCase().includes('jackie')
        )
        .filter(t => new Date(t.created_date) > sevenDaysAgo)
        .slice(0, 3);

    const jackieReports = documents
        .filter(d => 
            d.document_type === 'cma_report' || 
            d.document_name && d.document_name.includes('CMA') ||
            d.ai_summary && d.ai_summary.includes('Jackie')
        )
        .filter(d => new Date(d.created_date) > sevenDaysAgo)
        .slice(0, 3);

    const activities = [
        ...jackieTasks.map(t => ({
            id: t.id,
            type: 'task',
            title: t.title,
            subtitle: t.property_id ? properties.find(p => p.id === t.property_id)?.address : null,
            status: t.status,
            date: t.created_date,
            link: createPageUrl('Tasks')
        })),
        ...jackieReports.map(d => ({
            id: d.id,
            type: 'report',
            title: d.document_name,
            subtitle: properties.find(p => p.id === d.property_id)?.address || 'CMA Report',
            status: d.ai_processing_status,
            date: d.created_date,
            url: d.file_url,
            link: createPageUrl('Documents')
        }))
    ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

    if (activities.length === 0) {
        return (
            <Card className="app-card bg-white/70 dark:bg-slate-800/40 backdrop-blur-xl border border-slate-200/50 dark:border-slate-700/50 rounded-2xl shadow-lg dark:shadow-2xl h-full">
                <CardHeader className="py-4 px-5">
                    <CardTitle className="flex items-center gap-2 text-lg font-bold text-slate-800 dark:text-white">
                        <Sparkles className="w-5 h-5 text-purple-500" />
                        Jackie Activities
                    </CardTitle>
                </CardHeader>
                <CardContent className="text-center py-8">
                    <Sparkles className="w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" />
                    <p className="text-sm text-slate-500 dark:text-slate-400">No recent Jackie activities</p>
                    <p className="text-xs text-slate-400 dark:text-slate-500 mt-1">
                        Try asking Jackie to value a property or create a task
                    </p>
                    <Button 
                        size="sm" 
                        variant="outline" 
                        className="mt-4"
                        onClick={() => navigate(createPageUrl('JackieAI'))}
                    >
                        Open Jackie AI
                    </Button>
                </CardContent>
            </Card>
        );
    }

    return (
        <Card className="app-card bg-white/70 dark:bg-slate-800/40 backdrop-blur-xl border border-slate-200/50 dark:border-slate-700/50 rounded-2xl shadow-lg dark:shadow-2xl h-full">
            <CardHeader className="py-4 px-5">
                <CardTitle className="flex items-center justify-between text-lg font-bold text-slate-800 dark:text-white">
                    <div className="flex items-center gap-2">
                        <Sparkles className="w-5 h-5 text-purple-500" />
                        Jackie Activities
                    </div>
                    <Button 
                        size="sm" 
                        variant="ghost"
                        onClick={() => navigate(createPageUrl('JackieAI'))}
                    >
                        <Sparkles className="w-4 h-4" />
                    </Button>
                </CardTitle>
            </CardHeader>
            <CardContent className="px-4 pb-4 space-y-2">
                {activities.map(activity => (
                    <div
                        key={activity.id}
                        className="flex items-start gap-3 p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors cursor-pointer"
                        onClick={() => navigate(activity.link)}
                    >
                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
                            activity.type === 'task' 
                                ? 'bg-blue-100 dark:bg-blue-900/30' 
                                : 'bg-purple-100 dark:bg-purple-900/30'
                        }`}>
                            {activity.type === 'task' ? (
                                <CheckSquare className="w-4 h-4 text-blue-600 dark:text-blue-400" />
                            ) : (
                                <FileText className="w-4 h-4 text-purple-600 dark:text-purple-400" />
                            )}
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-medium text-slate-900 dark:text-white truncate">
                                {activity.title}
                            </p>
                            {activity.subtitle && (
                                <p className="text-xs text-slate-500 dark:text-slate-400 truncate">
                                    {activity.subtitle}
                                </p>
                            )}
                            <div className="flex items-center gap-2 mt-1">
                                {activity.status === 'pending' && (
                                    <Badge variant="outline" className="text-xs">
                                        <Clock className="w-3 h-3 mr-1" />
                                        Pending
                                    </Badge>
                                )}
                                {activity.status === 'processing' && (
                                    <Badge variant="outline" className="text-xs">
                                        <Loader2 className="w-3 h-3 mr-1 animate-spin" />
                                        Generating...
                                    </Badge>
                                )}
                                {activity.status === 'completed' && (
                                    <Badge variant="outline" className="text-xs text-green-600">
                                        <CheckCircle className="w-3 h-3 mr-1" />
                                        Ready
                                    </Badge>
                                )}
                                <span className="text-xs text-slate-400">
                                    {format(new Date(activity.date), 'MMM d, h:mm a')}
                                </span>
                            </div>
                        </div>
                        {activity.url && activity.status === 'completed' && (
                            <Button
                                size="sm"
                                variant="ghost"
                                className="flex-shrink-0"
                                onClick={(e) => {
                                    e.stopPropagation();
                                    window.open(activity.url, '_blank');
                                }}
                            >
                                <ExternalLink className="w-4 h-4" />
                            </Button>
                        )}
                    </div>
                ))}
            </CardContent>
        </Card>
    );
}
