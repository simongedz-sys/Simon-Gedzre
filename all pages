import React, { useState, useMemo } from 'react';
import { useQuery, useMutation } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { BrainCircuit, Wand2, Loader2 } from 'lucide-react';
import AnalysisResult from '../components/propertywhisperer/AnalysisResult';

const AIPropertyWhisperer = () => {
    const [selectedPropertyId, setSelectedPropertyId] = useState(null);
    const [analysisResult, setAnalysisResult] = useState(null);

    const { data: properties, isLoading: isLoadingProperties } = useQuery({
        queryKey: ['properties'],
        queryFn: () => base44.entities.Property.list(),
        initialData: []
    });
    
    const selectedProperty = useMemo(() => {
        return properties.find(p => p.id === selectedPropertyId);
    }, [selectedPropertyId, properties]);

    const analysisMutation = useMutation({
        mutationFn: async () => {
            if (!selectedProperty) {
                throw new Error("No property selected.");
            }
            
            const [photos, marketComps] = await Promise.all([
                base44.entities.Photo.filter({ property_id: selectedPropertyId }),
                base44.entities.Property.filter({ status: 'sold', city: selectedProperty.city }, '-updated_date', 5)
            ]);

            const propertyDataForAI = {
                ...selectedProperty,
                photos: photos.map(p => ({ url: p.file_url, caption: p.caption, category: p.category })),
            };

            const prompt = `
                You are 'Property Whisperer', a world-class AI real estate advisor with deep expertise in property marketing, buyer psychology, and data analysis. Your task is to perform a comprehensive analysis of the following property and predict how buyers will react to it.

                PROPERTY DATA:
                ${JSON.stringify(propertyDataForAI, null, 2)}

                MARKET COMPARABLES (RECENTLY SOLD):
                ${JSON.stringify(marketComps, null, 2)}

                Based on all the provided data, generate a detailed analysis in the exact JSON format specified.
            `;

            const responseSchema = {
                type: "object",
                properties: {
                    emotional_response: {
                        type: "object",
                        properties: {
                            overall_feeling: { type: "string", description: "A one-sentence summary of the property's primary emotional impact." },
                            photo_analysis: {
                                type: "array",
                                items: {
                                    type: "object",
                                    properties: {
                                        predicted_emotion: { type: "string", description: "e.g., 'Cozy & Welcoming', 'Sleek & Modern', 'Dated & Needs Work'" },
                                        positive_takeaway: { type: "string" },
                                        improvement_suggestion: { type: "string" },
                                    },
                                    required: ["predicted_emotion", "positive_takeaway", "improvement_suggestion"]
                                }
                            },
                            ideal_buyer_profile: {
                                type: "object",
                                properties: {
                                    name: { type: "string", description: "e.g., 'Young Professionals', 'Growing Family', 'Empty Nesters'" },
                                    description: { type: "string", description: "A brief description of this buyer type." }
                                }
                            }
                        }
                    },
                    virtual_buyer_simulation: {
                        type: "object",
                        properties: {
                            buyer_personas: {
                                type: "array",
                                items: {
                                    type: "object",
                                    properties: {
                                        name: { type: "string", description: "e.g., 'First-Time Homebuyers'" },
                                        potential_objections: { type: "array", items: { type: "string" } },
                                        suggested_talking_points: { type: "array", items: { type: "string" } }
                                    },
                                    required: ["name", "potential_objections", "suggested_talking_points"]
                                }
                            }
                        }
                    },
                    instant_optimization: {
                        type: "object",
                        properties: {
                            staging_recommendations: {
                                type: "array",
                                items: {
                                    type: "object",
                                    properties: {
                                        area: { type: "string", description: "e.g., 'Living Room', 'Kitchen'" },
                                        recommendation: { type: "string" },
                                        impact: { type: "string", enum: ["High", "Medium", "Low"] }
                                    },
                                    required: ["area", "recommendation", "impact"]
                                }
                            },
                            pricing_psychology: {
                                type: "object",
                                properties: {
                                    suggested_price: { type: "number" },
                                    reasoning: { type: "string" }
                                }
                            },
                            marketing_angle: {
                                type: "object",
                                properties: {
                                    suggested_angle: { type: "string", description: "A compelling marketing angle." },
                                    headline_suggestion: { type: "string", description: "A catchy headline for listings." }
                                }
                            }
                        }
                    }
                },
                required: ["emotional_response", "virtual_buyer_simulation", "instant_optimization"]
            };

            return await base44.integrations.Core.InvokeLLM({ prompt, response_json_schema: responseSchema });
        },
        onSuccess: (data) => {
            setAnalysisResult(data);
            toast.success("Property analysis complete!");
        },
        onError: (error) => {
            console.error("Analysis failed:", error);
            toast.error("Analysis failed. Please check the data and try again.");
        },
    });

    return (
        <div className="page-container p-4 space-y-6">
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-3xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                        <BrainCircuit className="w-8 h-8 text-primary" />
                        AI Property Whisperer
                    </h1>
                    <p className="text-slate-500 dark:text-slate-400 mt-1">The Mind-Reading Real Estate Assistant. Predict what buyers will think before they see the property.</p>
                </div>
            </header>

            <Card className="app-card">
                <CardContent className="p-4 md:p-6">
                    <div className="flex flex-col md:flex-row gap-4 items-center">
                        <div className="flex-grow w-full">
                             <label className="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block">Select a Property to Analyze</label>
                            <Select onValueChange={setSelectedPropertyId} value={selectedPropertyId} disabled={isLoadingProperties || analysisMutation.isLoading}>
                                <SelectTrigger className="w-full">
                                    <SelectValue placeholder={isLoadingProperties ? "Loading properties..." : "Select a property"} />
                                </SelectTrigger>
                                <SelectContent>
                                    {properties.map(prop => (
                                        <SelectItem key={prop.id} value={prop.id}>{prop.address}</SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>
                        <Button 
                            onClick={() => analysisMutation.mutate()} 
                            disabled={!selectedPropertyId || analysisMutation.isLoading}
                            className="w-full md:w-auto mt-4 md:mt-0 self-end"
                        >
                            {analysisMutation.isLoading ? (
                                <><Loader2 className="w-4 h-4 mr-2 animate-spin" />Analyzing...</>
                            ) : (
                                <><Wand2 className="w-4 h-4 mr-2" />Analyze Property</>
                            )}
                        </Button>
                    </div>
                </CardContent>
            </Card>

            {analysisMutation.isLoading && (
                <div className="text-center p-10">
                    <Loader2 className="w-12 h-12 text-primary animate-spin mx-auto" />
                    <p className="mt-4 font-semibold text-slate-700 dark:text-slate-300">The Property Whisperer is deep in thought...</p>
                    <p className="text-sm text-slate-500 dark:text-slate-400">Analyzing photos, market data, and buyer psychology.</p>
                </div>
            )}
            
            {analysisResult && (
                <AnalysisResult result={analysisResult} property={selectedProperty} />
            )}

            {!analysisResult && !analysisMutation.isLoading && (
                 <div className="text-center py-12 px-6 bg-slate-50 dark:bg-slate-800/50 rounded-lg border-2 border-dashed border-slate-200 dark:border-slate-700">
                    <BrainCircuit className="w-12 h-12 text-slate-400 dark:text-slate-500 mx-auto" />
                    <h3 className="mt-4 text-lg font-semibold text-slate-800 dark:text-slate-200">Ready for Revolutionary Insights?</h3>
                    <p className="mt-1 text-sm text-slate-500 dark:text-slate-400 max-w-md mx-auto">Select one of your properties and click "Analyze Property" to unlock data-driven predictions that will help you sell faster and for a higher price.</p>
                </div>
            )}
        </div>
    );
};

export default AIPropertyWhisperer;
import React, { useState, useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Loader2, Brain, TrendingUp, AlertTriangle, Sparkles, Users, DollarSign, Target } from 'lucide-react';
import ReactMarkdown from 'react-markdown';
import { toast } from 'sonner';

export default function AITeamAdvisor() {
    const [selectedMember, setSelectedMember] = useState(null);
    const [analysis, setAnalysis] = useState(null);
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [teamOverview, setTeamOverview] = useState(null);
    const [isLoadingOverview, setIsLoadingOverview] = useState(false);

    // Fetch all data
    const { data: teamMembers = [], isLoading: loadingMembers } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: async () => {
            try {
                return await base44.entities.TeamMember.list() || [];
            } catch (error) {
                console.error('Error loading team members:', error);
                return [];
            }
        }
    });

    const { data: users = [] } = useQuery({
        queryKey: ['users'],
        queryFn: async () => {
            try {
                return await base44.entities.User.list() || [];
            } catch (error) {
                console.error('Error loading users:', error);
                return [];
            }
        }
    });

    const { data: transactions = [] } = useQuery({
        queryKey: ['transactions'],
        queryFn: async () => {
            try {
                return await base44.entities.Transaction.list() || [];
            } catch (error) {
                console.error('Error loading transactions:', error);
                return [];
            }
        }
    });

    const { data: properties = [] } = useQuery({
        queryKey: ['properties'],
        queryFn: async () => {
            try {
                return await base44.entities.Property.list() || [];
            } catch (error) {
                console.error('Error loading properties:', error);
                return [];
            }
        }
    });

    const { data: leads = [] } = useQuery({
        queryKey: ['leads'],
        queryFn: async () => {
            try {
                return await base44.entities.Lead.list() || [];
            } catch (error) {
                console.error('Error loading leads:', error);
                return [];
            }
        }
    });

    const { data: leadActivities = [] } = useQuery({
        queryKey: ['leadActivities'],
        queryFn: async () => {
            try {
                return await base44.entities.LeadActivity.list() || [];
            } catch (error) {
                console.error('Error loading activities:', error);
                return [];
            }
        }
    });

    // Calculate comprehensive performance data - EXACT SAME LOGIC AS TEAM MEMBERS PAGE
    const enrichedMembers = useMemo(() => {
        console.log('üîÑ AI Advisor: Calculating team performance...', {
            teamMembers: teamMembers.length,
            users: users.length,
            transactions: transactions.length,
            properties: properties.length,
            leads: leads.length
        });

        if (!teamMembers || teamMembers.length === 0) return [];

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        return teamMembers.map(member => {
            const user = users.find(u => u.email === member.email);
            console.log(`\nüë§ AI Advisor analyzing ${member.full_name}...`);

            // Find transactions where this member is credited (METHOD 1 & 2)
            const memberTransactions = transactions.filter(t => {
                // PRIMARY: Check notes field
                try {
                    if (t.notes) {
                        const notes = JSON.parse(t.notes);
                        if (notes.listing_team_member_id === member.id || 
                            notes.selling_team_member_id === member.id) {
                            console.log(`  ‚úÖ Transaction matched via notes: Property ${t.property_id}`);
                            return true;
                        }
                    }
                } catch (e) {}
                
                // FALLBACK: Check if selling_agent_name matches
                if (t.selling_agent_name && t.selling_agent_name === member.full_name) {
                    console.log(`  ‚úÖ Transaction matched via selling_agent_name: ${t.selling_agent_name}`);
                    return true;
                }
                
                // FALLBACK: Check agent IDs
                if (t.listing_agent_id === user?.id || t.selling_agent_id === user?.id) {
                    console.log(`  ‚úÖ Transaction matched via agent ID`);
                    return true;
                }
                
                return false;
            });

            console.log(`  üìä Found ${memberTransactions.length} transactions for ${member.full_name}`);

            // Calculate revenue from all matching transactions
            let revenue = 0;
            memberTransactions.forEach(t => {
                let transactionRevenue = 0;
                
                // PRIMARY: Check notes for team member credits
                try {
                    if (t.notes) {
                        const notes = JSON.parse(t.notes);
                        
                        if (notes.listing_team_member_id === member.id) {
                            transactionRevenue += (t.listing_net_commission || 0);
                            console.log(`    üí∞ Listing commission (via notes): $${t.listing_net_commission || 0}`);
                        }
                        
                        if (notes.selling_team_member_id === member.id) {
                            transactionRevenue += (t.selling_net_commission || 0);
                            console.log(`    üí∞ Selling commission (via notes): $${t.selling_net_commission || 0}`);
                        }
                    }
                } catch (e) {}
                
                // FALLBACK: If no revenue from notes, check agent IDs
                if (transactionRevenue === 0) {
                    if (t.listing_agent_id === user?.id) {
                        transactionRevenue += (t.listing_net_commission || 0);
                        console.log(`    üí∞ Listing commission (via agent ID): $${t.listing_net_commission || 0}`);
                    }
                    if (t.selling_agent_id === user?.id) {
                        transactionRevenue += (t.selling_net_commission || 0);
                        console.log(`    üí∞ Selling commission (via agent ID): $${t.selling_net_commission || 0}`);
                    }
                }
                
                // FALLBACK: If still no revenue, check selling agent name
                if (transactionRevenue === 0 && t.selling_agent_name === member.full_name) {
                    transactionRevenue += (t.selling_net_commission || 0);
                    console.log(`    üí∞ Selling commission (by name): $${t.selling_net_commission || 0}`);
                }
                
                revenue += transactionRevenue;
            });

            console.log(`  üíµ Total revenue for ${member.full_name}: $${revenue}`);

            // METHOD 3: Check properties by tags
            const memberProperties = properties.filter(p => {
                if (p.listing_agent_id === user?.id) {
                    console.log(`  üè† Property matched via listing_agent_id: ${p.address}`);
                    return true;
                }
                if (p.tags && p.tags.includes(`listing_agent:${member.id}`)) {
                    console.log(`  üè† Property matched via tags: ${p.address}`);
                    return true;
                }
                return false;
            });

            // METHOD 4: Check leads assigned
            const memberLeads = leads.filter(l => {
                if (l.assigned_agent_id === user?.id) return true;
                if (l.owner_id === user?.id) return true;
                if (l.notes && l.notes.includes(member.id)) return true;
                return false;
            });

            // METHOD 5: Check activities
            const memberActivities = leadActivities.filter(a => a.user_id === user?.id);

            // Check for inactivity
            const hasRecentActivity = memberActivities.some(a => new Date(a.created_date) > thirtyDaysAgo) ||
                                     memberTransactions.some(t => new Date(t.updated_date || t.created_date) > thirtyDaysAgo);

            const enrichedData = {
                ...member,
                revenue: revenue,
                deals: memberTransactions.length,
                properties: memberProperties.length,
                leads: memberLeads.length,
                activities: memberActivities.length,
                isInactive: !hasRecentActivity,
            };

            console.log(`  ‚úÖ Final enriched data for ${member.full_name}:`, enrichedData);
            return enrichedData;
        });
    }, [teamMembers, users, transactions, properties, leads, leadActivities]);

    // Calculate team-wide statistics
    const teamStats = useMemo(() => {
        if (!enrichedMembers || enrichedMembers.length === 0) {
            return {
                totalRevenue: 0,
                totalDeals: 0,
                avgRevenue: 0,
                topPerformer: null,
                bottomPerformer: null,
            };
        }

        const totalRevenue = enrichedMembers.reduce((sum, m) => sum + (m.revenue || 0), 0);
        const totalDeals = enrichedMembers.reduce((sum, m) => sum + (m.deals || 0), 0);
        const avgRevenue = enrichedMembers.length > 0 ? totalRevenue / enrichedMembers.length : 0;

        const sortedByRevenue = [...enrichedMembers].sort((a, b) => (b.revenue || 0) - (a.revenue || 0));
        
        console.log('üìä AI Advisor Team Statistics:', {
            totalRevenue: `$${totalRevenue.toFixed(0)}`,
            totalDeals,
            avgRevenue: `$${avgRevenue.toFixed(0)}`,
            memberCount: enrichedMembers.length
        });

        return {
            totalRevenue,
            totalDeals,
            avgRevenue,
            topPerformer: sortedByRevenue[0] || null,
            bottomPerformer: sortedByRevenue[sortedByRevenue.length - 1] || null,
        };
    }, [enrichedMembers]);

    const handleTeamOverview = async () => {
        if (!enrichedMembers || enrichedMembers.length === 0) {
            toast.error('No team members found to analyze');
            return;
        }

        setIsLoadingOverview(true);
        setTeamOverview(null);

        try {
            const teamData = enrichedMembers.map(member => ({
                name: member.full_name,
                role: member.role,
                revenue: member.revenue || 0,
                deals: member.deals || 0,
                properties: member.properties || 0,
                leads: member.leads || 0,
                activities: member.activities || 0,
                isInactive: member.isInactive,
            }));

            const prompt = `
You are an expert real estate brokerage manager analyzing team performance.

**TEAM OVERVIEW:**
- Total Team Members: ${enrichedMembers.length}
- Total Team Revenue: $${teamStats.totalRevenue.toLocaleString()}
- Total Team Deals: ${teamStats.totalDeals}
- Average Revenue per Agent: $${teamStats.avgRevenue.toLocaleString()}

**TOP PERFORMER:**
- Name: ${teamStats.topPerformer?.full_name || 'N/A'}
- Revenue: $${(teamStats.topPerformer?.revenue || 0).toLocaleString()}
- Deals: ${teamStats.topPerformer?.deals || 0}

**INDIVIDUAL PERFORMANCE BREAKDOWN:**
${teamData.map((m, idx) => `
${idx + 1}. ${m.name} (${m.role})
   - Revenue: $${m.revenue.toLocaleString()}
   - Deals: ${m.deals}
   - Properties: ${m.properties}
   - Active Leads: ${m.leads}
   - Activities: ${m.activities}
   - Status: ${m.isInactive ? '‚ö†Ô∏è INACTIVE (No activity in 30 days)' : '‚úÖ Active'}
`).join('\n')}

**YOUR TASK:**
Provide a comprehensive team performance analysis in Markdown format with the following sections:

### 1. Executive Summary
Provide a high-level overview of overall team health and performance. Reference the **Total Team Revenue of $${teamStats.totalRevenue.toLocaleString()}**.

### 2. Top Performers
Identify and analyze the top 3 performers. What are they doing right? Include specific revenue numbers.

### 3. Performance Concerns
Identify team members who need attention (inactive, low performance, etc.). Be specific about what's concerning.

### 4. Team Strengths
What is the team doing well collectively?

### 5. Areas for Improvement
What specific actions can improve overall team performance?

### 6. Strategic Recommendations
Provide 3-5 actionable recommendations for the broker/manager to implement this month.

Be specific, data-driven, and actionable. Reference actual numbers from the data provided.
            `;

            const response = await base44.integrations.Core.InvokeLLM({
                prompt,
                add_context_from_internet: false,
            });

            setTeamOverview(response);
            toast.success('Team overview generated successfully');
        } catch (error) {
            console.error('Error generating team overview:', error);
            toast.error(`Failed to generate team overview: ${error.message}`);
        } finally {
            setIsLoadingOverview(false);
        }
    };

    const handleMemberAnalysis = async (member) => {
        setSelectedMember(member);
        setIsAnalyzing(true);
        setAnalysis(null);

        try {
            const enrichedMember = enrichedMembers.find(m => m.id === member.id);
            
            if (!enrichedMember) {
                toast.error('Could not find performance data for this member');
                return;
            }

            const memberRevenue = enrichedMember.revenue || 0;
            const revenuePercentage = teamStats.totalRevenue > 0 ? ((memberRevenue / teamStats.totalRevenue) * 100).toFixed(1) : 0;

            const prompt = `
You are an expert real estate performance coach analyzing an individual agent's performance.

**AGENT PROFILE:**
- Name: ${enrichedMember.full_name}
- Role: ${enrichedMember.role}
- Specialization: ${enrichedMember.specialization || 'Not specified'}

**PERFORMANCE METRICS:**
- Total Revenue: $${memberRevenue.toLocaleString()}
- Total Deals: ${enrichedMember.deals || 0}
- Properties Managed: ${enrichedMember.properties || 0}
- Active Leads: ${enrichedMember.leads || 0}
- Activities Logged: ${enrichedMember.activities || 0}
- Status: ${enrichedMember.isInactive ? '‚ö†Ô∏è INACTIVE (No activity in 30 days)' : '‚úÖ Active'}

**TEAM CONTEXT:**
- Team Total Revenue: $${teamStats.totalRevenue.toLocaleString()}
- Team Average Revenue: $${teamStats.avgRevenue.toLocaleString()}
- Their % of Team Revenue: ${revenuePercentage}%
- Team Total Deals: ${teamStats.totalDeals}

**YOUR TASK:**
Provide a detailed individual performance analysis in Markdown format:

### 1. Performance Summary
How is this agent performing relative to team averages? Be specific with numbers.

### 2. Strengths
What is this agent doing well? Reference specific metrics.

### 3. Concerns
${enrichedMember.isInactive ? 
    'This agent shows NO ACTIVITY in the last 30 days. What might be causing this? What immediate actions should the manager take?' : 
    'Are there any performance concerns? What metrics could be improved?'}

### 4. Growth Opportunities
What specific actions can this agent take to increase their production?

### 5. Manager Action Items
What should the broker/manager do to support this agent this week?

Be specific, encouraging but honest, and actionable.
            `;

            const response = await base44.integrations.Core.InvokeLLM({
                prompt,
                add_context_from_internet: false,
            });

            setAnalysis(response);
            toast.success(`Analysis generated for ${enrichedMember.full_name}`);
        } catch (error) {
            console.error('Error analyzing member:', error);
            toast.error(`Failed to analyze member: ${error.message}`);
        } finally {
            setIsAnalyzing(false);
        }
    };

    if (loadingMembers) {
        return (
            <div className="page-container flex items-center justify-center min-h-screen">
                <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
            </div>
        );
    }

    return (
        <div className="page-container space-y-6">
            <div>
                <h1 className="text-3xl font-bold text-slate-900 dark:text-white">AI Team Performance Analyst</h1>
                <p className="text-slate-600 dark:text-slate-400 mt-2">
                    Comprehensive AI-powered analysis of your team's performance and recommendations.
                </p>
            </div>

            {/* Team Statistics Overview */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Team Members</p>
                                <p className="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1">
                                    {enrichedMembers.length}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                                <Users className="w-6 h-6 text-purple-600 dark:text-purple-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Revenue</p>
                                <p className="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">
                                    ${(teamStats.totalRevenue / 1000).toFixed(0)}k
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                                <DollarSign className="w-6 h-6 text-green-600 dark:text-green-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Deals</p>
                                <p className="text-2xl font-bold text-blue-600 dark:text-blue-400 mt-1">
                                    {teamStats.totalDeals}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                <Target className="w-6 h-6 text-blue-600 dark:text-blue-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Avg per Agent</p>
                                <p className="text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1">
                                    ${(teamStats.avgRevenue / 1000).toFixed(0)}k
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                                <TrendingUp className="w-6 h-6 text-orange-600 dark:text-orange-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>
            </div>

            {/* Generate Team Overview Button */}
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Brain className="w-5 h-5 text-indigo-600" />
                        Team Overview Analysis
                    </CardTitle>
                    <CardDescription>
                        Get AI-powered insights on overall team performance, strengths, and strategic recommendations
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <Button 
                        onClick={handleTeamOverview} 
                        disabled={isLoadingOverview || enrichedMembers.length === 0}
                        className="bg-indigo-600 hover:bg-indigo-700"
                    >
                        {isLoadingOverview ? (
                            <><Loader2 className="w-4 h-4 mr-2 animate-spin" />Analyzing Team...</>
                        ) : (
                            <><Sparkles className="w-4 h-4 mr-2" />Generate Team Overview</>
                        )}
                    </Button>
                </CardContent>
            </Card>

            {/* Team Overview Results */}
            {teamOverview && (
                <Card>
                    <CardHeader>
                        <CardTitle>Team Performance Overview</CardTitle>
                    </CardHeader>
                    <CardContent className="prose dark:prose-invert max-w-none">
                        <ReactMarkdown>{teamOverview}</ReactMarkdown>
                    </CardContent>
                </Card>
            )}

            {/* Individual Team Members */}
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Users className="w-5 h-5 text-purple-600" />
                        Individual Performance Analysis
                    </CardTitle>
                    <CardDescription>
                        Click on any team member to get personalized AI coaching and recommendations
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {enrichedMembers.map((member) => (
                            <Card 
                                key={member.id}
                                className={`cursor-pointer transition-all hover:shadow-lg ${
                                    selectedMember?.id === member.id ? 'ring-2 ring-indigo-500' : ''
                                } ${
                                    member.isInactive ? 'border-red-300 bg-red-50/50 dark:bg-red-900/10' : ''
                                }`}
                                onClick={() => handleMemberAnalysis(member)}
                            >
                                <CardContent className="p-4">
                                    <div className="flex items-start justify-between mb-3">
                                        <div>
                                            <h3 className="font-semibold text-lg text-slate-900 dark:text-white">
                                                {member.full_name}
                                            </h3>
                                            <p className="text-sm text-slate-500 dark:text-slate-400">
                                                {member.role?.replace(/_/g, ' ')}
                                            </p>
                                        </div>
                                        {member.isInactive && (
                                            <AlertTriangle className="w-5 h-5 text-red-500" />
                                        )}
                                    </div>
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-slate-600 dark:text-slate-400">Revenue:</span>
                                            <span className="font-semibold text-green-600 dark:text-green-400">
                                                ${(member.revenue || 0).toLocaleString('en-US', { maximumFractionDigits: 0 })}
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-slate-600 dark:text-slate-400">Deals:</span>
                                            <span className="font-semibold">{member.deals || 0}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-slate-600 dark:text-slate-400">Activities:</span>
                                            <span className="font-semibold">{member.activities || 0}</span>
                                        </div>
                                    </div>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </CardContent>
            </Card>

            {/* Individual Analysis Results */}
            {selectedMember && (
                <Card>
                    <CardHeader>
                        <CardTitle>
                            AI Analysis: {selectedMember.full_name}
                        </CardTitle>
                    </CardHeader>
                    <CardContent>
                        {isAnalyzing ? (
                            <div className="flex items-center justify-center p-8">
                                <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
                                <span className="ml-3 text-slate-600">Analyzing performance...</span>
                            </div>
                        ) : analysis ? (
                            <div className="prose dark:prose-invert max-w-none">
                                <ReactMarkdown>{analysis}</ReactMarkdown>
                            </div>
                        ) : null}
                    </CardContent>
                </Card>
            )}
        </div>
    );
}
import React, { useState, useEffect, useMemo } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { 
  format, 
  startOfMonth, 
  endOfMonth, 
  startOfYear, 
  endOfYear,
  subMonths,
  subYears,
  parseISO,
  differenceInDays
} from "date-fns";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

import {
  LineChart,
  Line,
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from "recharts";

import {
  ArrowLeft,
  TrendingUp,
  DollarSign,
  Home,
  Target,
  Calendar,
  Clock,
  BarChart3,
  PieChart as PieChartIcon,
  Activity,
  Award,
  Briefcase,
  RefreshCw
} from "lucide-react";

export default function Analytics() {
  const navigate = useNavigate();
  const [timeRange, setTimeRange] = useState("this_month");
  const [viewType, setViewType] = useState("overview");
  const [isLoading, setIsLoading] = useState(true);
  
  // Data states
  const [properties, setProperties] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [leads, setLeads] = useState([]);
  const [buyers, setBuyers] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [user, props, trans, leadsData, buyersData, tasksData] = await Promise.all([
        base44.auth.me(),
        base44.entities.Property.list(),
        base44.entities.Transaction.list(),
        base44.entities.Lead.list(),
        base44.entities.Buyer.list(),
        base44.entities.Task.list(),
      ]);

      setCurrentUser(user);
      setProperties(props || []);
      setTransactions(trans || []);
      setLeads(leadsData || []);
      setBuyers(buyersData || []);
      setTasks(tasksData || []);
    } catch (error) {
      console.error("Error loading analytics data:", error);
    }
    setIsLoading(false);
  };

  // Date range filters
  const getDateRange = () => {
    const now = new Date();
    switch (timeRange) {
      case "this_month":
        return { start: startOfMonth(now), end: endOfMonth(now) };
      case "last_month":
        const lastMonth = subMonths(now, 1);
        return { start: startOfMonth(lastMonth), end: endOfMonth(lastMonth) };
      case "this_year":
        return { start: startOfYear(now), end: endOfYear(now) };
      case "last_year":
        const lastYear = subYears(now, 1);
        return { start: startOfYear(lastYear), end: endOfYear(lastYear) };
      case "all_time":
      default:
        return { start: new Date(2020, 0, 1), end: now };
    }
  };

  const dateRange = getDateRange();

  // Filter data by date range
  const filterByDateRange = (items, dateField = "created_date") => {
    return items.filter(item => {
      if (!item[dateField]) return false;
      const itemDate = new Date(item[dateField]);
      return itemDate >= dateRange.start && itemDate <= dateRange.end;
    });
  };

  const filteredProperties = filterByDateRange(properties);
  const filteredTransactions = filterByDateRange(transactions);
  const filteredLeads = filterByDateRange(leads);
  const filteredBuyers = filterByDateRange(buyers);

  // Calculate KPIs
  const kpis = useMemo(() => {
    // Revenue metrics
    const closedTransactions = filteredTransactions.filter(t => t.status === "closed");
    const totalRevenue = closedTransactions.reduce((sum, t) => sum + (t.contract_price || 0), 0);
    const totalCommission = closedTransactions.reduce((sum, t) => 
      sum + (t.listing_net_commission || 0) + (t.selling_net_commission || 0), 0
    );

    // Property metrics
    const activeListings = filteredProperties.filter(p => p.status === "active").length;
    const soldProperties = filteredProperties.filter(p => p.status === "sold").length;
    const avgDaysOnMarket = filteredProperties.length > 0
      ? Math.round(filteredProperties.reduce((sum, p) => sum + (p.days_on_market || 0), 0) / filteredProperties.length)
      : 0;

    // Lead metrics
    const totalLeads = filteredLeads.length;
    const convertedLeads = filteredLeads.filter(l => l.status === "converted").length;
    const conversionRate = totalLeads > 0 ? ((convertedLeads / totalLeads) * 100).toFixed(1) : 0;

    // Transaction metrics
    const activeDeals = filteredTransactions.filter(t => t.status === "active" || t.status === "pending").length;
    const avgDaysToClose = closedTransactions.length > 0
      ? Math.round(closedTransactions.reduce((sum, t) => {
          if (t.important_dates?.closing_date && t.important_dates?.offer_date) {
            return sum + differenceInDays(
              parseISO(t.important_dates.closing_date),
              parseISO(t.important_dates.offer_date)
            );
          }
          return sum;
        }, 0) / closedTransactions.length)
      : 0;

    // Task metrics
    const completedTasks = tasks.filter(t => t.status === "completed" && 
      new Date(t.completed_date) >= dateRange.start && 
      new Date(t.completed_date) <= dateRange.end
    ).length;
    const overdueTasks = tasks.filter(t => 
      t.status !== "completed" && 
      t.due_date && 
      new Date(t.due_date) < new Date()
    ).length;

    return {
      totalRevenue,
      totalCommission,
      activeListings,
      soldProperties,
      avgDaysOnMarket,
      totalLeads,
      convertedLeads,
      conversionRate,
      activeDeals,
      closedDeals: closedTransactions.length,
      avgDaysToClose,
      completedTasks,
      overdueTasks,
    };
  }, [filteredProperties, filteredTransactions, filteredLeads, tasks, dateRange]);

  // Monthly revenue trend
  const monthlyRevenueTrend = useMemo(() => {
    const months = {};
    filteredTransactions
      .filter(t => t.status === "closed" && t.important_dates?.closing_date)
      .forEach(t => {
        const month = format(parseISO(t.important_dates.closing_date), "MMM yyyy");
        if (!months[month]) {
          months[month] = { month, revenue: 0, commission: 0, deals: 0 };
        }
        months[month].revenue += t.contract_price || 0;
        months[month].commission += (t.listing_net_commission || 0) + (t.selling_net_commission || 0);
        months[month].deals += 1;
      });
    
    return Object.values(months).sort((a, b) => new Date(a.month) - new Date(b.month));
  }, [filteredTransactions]);

  // Lead source breakdown
  const leadSourceData = useMemo(() => {
    const sources = {};
    filteredLeads.forEach(lead => {
      const source = lead.lead_source || "unknown";
      sources[source] = (sources[source] || 0) + 1;
    });
    
    return Object.entries(sources).map(([name, value]) => ({ name, value }));
  }, [filteredLeads]);

  // Property status distribution
  const propertyStatusData = useMemo(() => {
    const statuses = {};
    filteredProperties.forEach(prop => {
      const status = prop.status || "unknown";
      statuses[status] = (statuses[status] || 0) + 1;
    });
    
    return Object.entries(statuses).map(([name, value]) => ({ name, value }));
  }, [filteredProperties]);

  // Transaction pipeline
  const pipelineData = useMemo(() => {
    const stages = {
      active: { name: "Active", value: 0, revenue: 0 },
      pending: { name: "Pending", value: 0, revenue: 0 },
      closed: { name: "Closed", value: 0, revenue: 0 },
      cancelled: { name: "Cancelled", value: 0, revenue: 0 },
    };

    filteredTransactions.forEach(t => {
      if (stages[t.status]) {
        stages[t.status].value += 1;
        stages[t.status].revenue += t.contract_price || 0;
      }
    });

    return Object.values(stages);
  }, [filteredTransactions]);

  // Top performing properties
  const topProperties = useMemo(() => {
    return [...filteredProperties]
      .filter(p => p.price)
      .sort((a, b) => (b.price || 0) - (a.price || 0))
      .slice(0, 5);
  }, [filteredProperties]);

  const COLORS = ['#0c4a6e', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

  if (isLoading) {
    return (
      <div className="page-container">
        <div className="animate-pulse space-y-6">
          {[1, 2, 3, 4].map(i => (
            <div key={i} className="h-64 bg-slate-200 dark:bg-slate-700 rounded-lg"></div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      {/* Header */}
      <Card className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-xl">
        <CardContent className="p-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => navigate(createPageUrl("Dashboard"))}
                className="text-white hover:bg-white/20 rounded-full"
              >
                <ArrowLeft className="w-5 h-5" />
              </Button>
              <div>
                <h1 className="text-2xl font-bold mb-1">Analytics & Insights</h1>
                <p className="text-white/90 text-sm">Track your performance and business metrics</p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <Select value={timeRange} onValueChange={setTimeRange}>
                <SelectTrigger className="w-48 bg-white/20 border-white/30 text-white">
                  <Calendar className="w-4 h-4 mr-2" />
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="this_month">This Month</SelectItem>
                  <SelectItem value="last_month">Last Month</SelectItem>
                  <SelectItem value="this_year">This Year</SelectItem>
                  <SelectItem value="last_year">Last Year</SelectItem>
                  <SelectItem value="all_time">All Time</SelectItem>
                </SelectContent>
              </Select>
              <Button
                onClick={loadData}
                variant="ghost"
                size="sm"
                className="text-white hover:bg-white/20"
              >
                <RefreshCw className="w-4 h-4 mr-2" />
                Refresh
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* KPI Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {/* Total Revenue */}
        <Card className="border-2 border-green-200 dark:border-green-800 hover:shadow-xl transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-start justify-between mb-4">
              <div className="flex-1">
                <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Total Revenue</p>
                <p className="text-3xl font-bold text-green-600 dark:text-green-400">
                  ${(kpis.totalRevenue / 1000000).toFixed(2)}M
                </p>
                <p className="text-xs text-slate-500 mt-1">
                  {kpis.closedDeals} closed deals
                </p>
              </div>
              <div className="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center shadow-lg">
                <DollarSign className="w-6 h-6 text-white" />
              </div>
            </div>
            <div className="flex items-center gap-2 text-sm">
              <TrendingUp className="w-4 h-4 text-green-600" />
              <span className="text-green-600 font-semibold">Commission: ${kpis.totalCommission.toLocaleString()}</span>
            </div>
          </CardContent>
        </Card>

        {/* Active Listings */}
        <Card className="border-2 border-blue-200 dark:border-blue-800 hover:shadow-xl transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-start justify-between mb-4">
              <div className="flex-1">
                <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Active Listings</p>
                <p className="text-3xl font-bold text-blue-600 dark:text-blue-400">
                  {kpis.activeListings}
                </p>
                <p className="text-xs text-slate-500 mt-1">
                  {kpis.soldProperties} sold this period
                </p>
              </div>
              <div className="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center shadow-lg">
                <Home className="w-6 h-6 text-white" />
              </div>
            </div>
            <div className="flex items-center gap-2 text-sm">
              <Clock className="w-4 h-4 text-blue-600" />
              <span className="text-blue-600 font-semibold">Avg {kpis.avgDaysOnMarket} days on market</span>
            </div>
          </CardContent>
        </Card>

        {/* Lead Conversion */}
        <Card className="border-2 border-purple-200 dark:border-purple-800 hover:shadow-xl transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-start justify-between mb-4">
              <div className="flex-1">
                <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Lead Conversion</p>
                <p className="text-3xl font-bold text-purple-600 dark:text-purple-400">
                  {kpis.conversionRate}%
                </p>
                <p className="text-xs text-slate-500 mt-1">
                  {kpis.convertedLeads} of {kpis.totalLeads} leads
                </p>
              </div>
              <div className="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center shadow-lg">
                <Target className="w-6 h-6 text-white" />
              </div>
            </div>
            <div className="flex items-center gap-2 text-sm">
              <TrendingUp className="w-4 h-4 text-purple-600" />
              <span className="text-purple-600 font-semibold">Strong performance</span>
            </div>
          </CardContent>
        </Card>

        {/* Active Pipeline */}
        <Card className="border-2 border-amber-200 dark:border-amber-800 hover:shadow-xl transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-start justify-between mb-4">
              <div className="flex-1">
                <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Active Pipeline</p>
                <p className="text-3xl font-bold text-amber-600 dark:text-amber-400">
                  {kpis.activeDeals}
                </p>
                <p className="text-xs text-slate-500 mt-1">
                  Avg {kpis.avgDaysToClose} days to close
                </p>
              </div>
              <div className="w-12 h-12 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center shadow-lg">
                <Briefcase className="w-6 h-6 text-white" />
              </div>
            </div>
            <div className="flex items-center gap-2 text-sm">
              <Activity className="w-4 h-4 text-amber-600" />
              <span className="text-amber-600 font-semibold">{kpis.completedTasks} tasks done</span>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Charts Section */}
      <Tabs value={viewType} onValueChange={setViewType} className="space-y-6">
        <TabsList className="grid w-full grid-cols-4 lg:w-auto lg:inline-grid">
          <TabsTrigger value="overview">
            <BarChart3 className="w-4 h-4 mr-2" />
            Overview
          </TabsTrigger>
          <TabsTrigger value="revenue">
            <DollarSign className="w-4 h-4 mr-2" />
            Revenue
          </TabsTrigger>
          <TabsTrigger value="pipeline">
            <Activity className="w-4 h-4 mr-2" />
            Pipeline
          </TabsTrigger>
          <TabsTrigger value="leads">
            <Target className="w-4 h-4 mr-2" />
            Leads
          </TabsTrigger>
        </TabsList>

        {/* Overview Tab */}
        <TabsContent value="overview" className="space-y-6">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Monthly Revenue Trend */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <TrendingUp className="w-5 h-5 text-green-600" />
                  Revenue Trend
                </CardTitle>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={300}>
                  <AreaChart data={monthlyRevenueTrend}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                    <XAxis dataKey="month" stroke="#64748b" />
                    <YAxis stroke="#64748b" />
                    <Tooltip 
                      contentStyle={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', borderRadius: '8px' }}
                      formatter={(value) => `$${(value / 1000).toFixed(0)}K`}
                    />
                    <Area type="monotone" dataKey="revenue" stroke="#10b981" fill="#10b981" fillOpacity={0.3} />
                  </AreaChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>

            {/* Property Status Distribution */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <PieChartIcon className="w-5 h-5 text-blue-600" />
                  Property Status
                </CardTitle>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={300}>
                  <PieChart>
                    <Pie
                      data={propertyStatusData}
                      cx="50%"
                      cy="50%"
                      labelLine={false}
                      label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                      outerRadius={100}
                      fill="#8884d8"
                      dataKey="value"
                    >
                      {propertyStatusData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>

            {/* Lead Sources */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Target className="w-5 h-5 text-purple-600" />
                  Lead Sources
                </CardTitle>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={leadSourceData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                    <XAxis dataKey="name" stroke="#64748b" />
                    <YAxis stroke="#64748b" />
                    <Tooltip contentStyle={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', borderRadius: '8px' }} />
                    <Bar dataKey="value" fill="#8b5cf6" radius={[8, 8, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>

            {/* Transaction Pipeline */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Activity className="w-5 h-5 text-amber-600" />
                  Transaction Pipeline
                </CardTitle>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={pipelineData} layout="vertical">
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                    <XAxis type="number" stroke="#64748b" />
                    <YAxis dataKey="name" type="category" stroke="#64748b" />
                    <Tooltip 
                      contentStyle={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', borderRadius: '8px' }}
                      formatter={(value, name) => name === 'revenue' ? `$${(value / 1000).toFixed(0)}K` : value}
                    />
                    <Bar dataKey="value" fill="#f59e0b" radius={[0, 8, 8, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>
          </div>

          {/* Top Properties */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Award className="w-5 h-5 text-indigo-600" />
                Top Performing Properties
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {topProperties.map((property, index) => (
                  <div key={property.id} className="flex items-center gap-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg hover:shadow-md transition-shadow">
                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold">
                      #{index + 1}
                    </div>
                    <div className="flex-1">
                      <p className="font-semibold text-slate-900 dark:text-white">{property.address}</p>
                      <p className="text-sm text-slate-500">{property.city}, {property.state}</p>
                    </div>
                    <div className="text-right">
                      <p className="text-xl font-bold text-green-600">${(property.price / 1000).toFixed(0)}K</p>
                      <p className="text-sm text-slate-500">{property.status}</p>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Revenue Tab */}
        <TabsContent value="revenue" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Revenue & Commission Analysis</CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={400}>
                <LineChart data={monthlyRevenueTrend}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                  <XAxis dataKey="month" stroke="#64748b" />
                  <YAxis stroke="#64748b" />
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', borderRadius: '8px' }}
                    formatter={(value) => `$${(value / 1000).toFixed(0)}K`}
                  />
                  <Legend />
                  <Line type="monotone" dataKey="revenue" stroke="#10b981" strokeWidth={3} name="Revenue" />
                  <Line type="monotone" dataKey="commission" stroke="#6366f1" strokeWidth={3} name="Commission" />
                </LineChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          {/* Commission Breakdown */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20">
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-green-700 dark:text-green-300 mb-1">Total Commission</p>
                    <p className="text-3xl font-bold text-green-600">${kpis.totalCommission.toLocaleString()}</p>
                  </div>
                  <DollarSign className="w-12 h-12 text-green-600 opacity-50" />
                </div>
              </CardContent>
            </Card>

            <Card className="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20">
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-blue-700 dark:text-blue-300 mb-1">Avg Commission/Deal</p>
                    <p className="text-3xl font-bold text-blue-600">
                      ${kpis.closedDeals > 0 ? Math.round(kpis.totalCommission / kpis.closedDeals).toLocaleString() : 0}
                    </p>
                  </div>
                  <Target className="w-12 h-12 text-blue-600 opacity-50" />
                </div>
              </CardContent>
            </Card>

            <Card className="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20">
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-purple-700 dark:text-purple-300 mb-1">Commission Rate</p>
                    <p className="text-3xl font-bold text-purple-600">
                      {kpis.totalRevenue > 0 ? ((kpis.totalCommission / kpis.totalRevenue) * 100).toFixed(2) : 0}%
                    </p>
                  </div>
                  <TrendingUp className="w-12 h-12 text-purple-600 opacity-50" />
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>

        {/* Pipeline Tab */}
        <TabsContent value="pipeline" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Transaction Pipeline Overview</CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={400}>
                <BarChart data={pipelineData}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                  <XAxis dataKey="name" stroke="#64748b" />
                  <YAxis yAxisId="left" stroke="#64748b" />
                  <YAxis yAxisId="right" orientation="right" stroke="#64748b" />
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#fff', border: '1px solid #e2e8f0', borderRadius: '8px' }}
                    formatter={(value, name) => {
                      if (name === 'revenue') return `$${(value / 1000).toFixed(0)}K`;
                      return value;
                    }}
                  />
                  <Legend />
                  <Bar yAxisId="left" dataKey="value" fill="#6366f1" radius={[8, 8, 0, 0]} name="Count" />
                  <Bar yAxisId="right" dataKey="revenue" fill="#10b981" radius={[8, 8, 0, 0]} name="Revenue" />
                </BarChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Leads Tab */}
        <TabsContent value="leads" className="space-y-6">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <Card>
              <CardHeader>
                <CardTitle>Lead Source Performance</CardTitle>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={350}>
                  <PieChart>
                    <Pie
                      data={leadSourceData}
                      cx="50%"
                      cy="50%"
                      labelLine={true}
                      label={({ name, value }) => `${name}: ${value}`}
                      outerRadius={120}
                      fill="#8884d8"
                      dataKey="value"
                    >
                      {leadSourceData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Lead Conversion Funnel</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {[
                    { stage: 'New Leads', count: filteredLeads.filter(l => l.status === 'new').length, color: 'bg-blue-500' },
                    { stage: 'Contacted', count: filteredLeads.filter(l => l.status === 'contacted').length, color: 'bg-indigo-500' },
                    { stage: 'Qualified', count: filteredLeads.filter(l => l.status === 'qualified').length, color: 'bg-purple-500' },
                    { stage: 'Nurturing', count: filteredLeads.filter(l => l.status === 'nurturing').length, color: 'bg-pink-500' },
                    { stage: 'Converted', count: filteredLeads.filter(l => l.status === 'converted').length, color: 'bg-green-500' },
                  ].map((stage, index) => {
                    const total = filteredLeads.length;
                    const percentage = total > 0 ? (stage.count / total * 100).toFixed(1) : 0;
                    return (
                      <div key={index} className="space-y-2">
                        <div className="flex justify-between items-center">
                          <span className="font-medium text-slate-700 dark:text-slate-300">{stage.stage}</span>
                          <span className="text-sm text-slate-500">{stage.count} ({percentage}%)</span>
                        </div>
                        <div className="h-8 bg-slate-100 dark:bg-slate-800 rounded-lg overflow-hidden">
                          <div 
                            className={`h-full ${stage.color} flex items-center justify-center text-white text-sm font-semibold transition-all duration-500`}
                            style={{ width: `${percentage}%` }}
                          >
                            {percentage > 10 && `${percentage}%`}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
      </Tabs>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  Target,
  Clock,
  Mail,
  Phone,
  MessageSquare,
  Calendar,
  TrendingUp,
  Sparkles,
  RefreshCw,
  CheckCircle2,
  ArrowRight,
  AlertCircle,
  Copy,
  X
} from "lucide-react";
import { toast } from "sonner";

export default function AutomatedFollowups() {
  const navigate = useNavigate();
  const [suggestions, setSuggestions] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isGenerating, setIsGenerating] = useState(false);
  const [user, setUser] = useState(null);
  const [leads, setLeads] = useState([]);
  const [activities, setActivities] = useState([]);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [currentUser, leadsData, activitiesData] = await Promise.all([
        base44.auth.me(),
        base44.entities.Lead.list(),
        base44.entities.LeadActivity.list("-created_date")
      ]);

      setUser(currentUser);
      setLeads(leadsData || []);
      setActivities(activitiesData || []);

      // Load existing follow-up suggestions
      await loadSuggestions(currentUser);
    } catch (error) {
      console.error("Error loading data:", error);
    }
    setIsLoading(false);
  };

  const loadSuggestions = async (currentUser) => {
    try {
      const insights = await base44.entities.AIInsight.filter({
        user_id: currentUser.id,
        insight_type: "follow_up_suggestion"
      }, "-created_date");

      setSuggestions(insights || []);
    } catch (error) {
      console.error("Error loading suggestions:", error);
    }
  };

  const analyzeLeadEngagement = (lead) => {
    const leadActivities = activities.filter(a => a.lead_id === lead.id);
    
    const engagement = {
      totalInteractions: leadActivities.length,
      lastContact: lead.last_contact ? new Date(lead.last_contact) : null,
      daysSinceContact: lead.last_contact 
        ? Math.floor((Date.now() - new Date(lead.last_contact)) / (1000 * 60 * 60 * 24))
        : 999,
      responseRate: 0,
      preferredChannel: 'email',
      bestTimeToContact: 'morning',
      engagementTrend: 'neutral'
    };

    // Calculate response rate
    const totalOutreach = leadActivities.filter(a => 
      ['call', 'email'].includes(a.activity_type)
    ).length;
    const positiveResponses = leadActivities.filter(a => 
      a.outcome === 'positive'
    ).length;
    engagement.responseRate = totalOutreach > 0 ? (positiveResponses / totalOutreach * 100) : 0;

    // Determine preferred channel
    const channelCounts = {
      email: leadActivities.filter(a => a.activity_type === 'email' && a.outcome === 'positive').length,
      call: leadActivities.filter(a => a.activity_type === 'call' && a.outcome === 'positive').length,
      text: leadActivities.filter(a => a.activity_type === 'text' && a.outcome === 'positive').length
    };
    engagement.preferredChannel = Object.keys(channelCounts).reduce((a, b) => 
      channelCounts[a] > channelCounts[b] ? a : b
    );

    // Analyze engagement trend
    const recentActivities = leadActivities
      .filter(a => new Date(a.created_date) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000))
      .length;
    const oldActivities = leadActivities
      .filter(a => {
        const date = new Date(a.created_date);
        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
        const sixtyDaysAgo = new Date(Date.now() - 60 * 24 * 60 * 60 * 1000);
        return date > sixtyDaysAgo && date <= thirtyDaysAgo;
      })
      .length;

    if (recentActivities > oldActivities) {
      engagement.engagementTrend = 'increasing';
    } else if (recentActivities < oldActivities) {
      engagement.engagementTrend = 'decreasing';
    }

    return engagement;
  };

  const generateFollowupSuggestions = async () => {
    setIsGenerating(true);
    try {
      const activeLeads = leads.filter(l => 
        l.status !== 'converted' && l.status !== 'lost'
      );

      let generatedCount = 0;

      for (const lead of activeLeads) {
        const engagement = analyzeLeadEngagement(lead);

        // Only generate suggestions for leads that need follow-up
        if (engagement.daysSinceContact > 3 || engagement.engagementTrend === 'decreasing') {
          try {
            const prompt = `Create a personalized follow-up strategy for this real estate lead:

Lead Profile:
- Name: ${lead.name}
- Status: ${lead.status}
- Lead Score: ${lead.score || 0}/100
- Interest: ${lead.interest_type || 'buying'}
- Budget: $${lead.budget_min?.toLocaleString() || '0'} - $${lead.budget_max?.toLocaleString() || '0'}
- Preferred Areas: ${lead.preferred_areas || 'Not specified'}
- Timeline: ${lead.timeline || 'Not specified'}

Engagement Analysis:
- Days Since Last Contact: ${engagement.daysSinceContact}
- Total Interactions: ${engagement.totalInteractions}
- Response Rate: ${engagement.responseRate.toFixed(1)}%
- Preferred Channel: ${engagement.preferredChannel}
- Engagement Trend: ${engagement.engagementTrend}

Create a JSON response with:
1. title: Compelling subject line (e.g., "Perfect Home Match for [Name] - 3 New Listings!")
2. strategy: 2-3 sentence approach based on their engagement pattern
3. message_templates: Array of 3 different message templates (email/text/call script)
4. best_time: Optimal time to reach out (specific day/time recommendation)
5. follow_up_sequence: Array of 3 follow-up steps if no response
6. value_proposition: What specific value you're offering
7. urgency_factor: Reason they should respond now
8. personalization_tips: 2-3 specific things to mention based on their profile`;

            const response = await base44.integrations.Core.InvokeLLM({
              prompt,
              response_json_schema: {
                type: "object",
                properties: {
                  title: { type: "string" },
                  strategy: { type: "string" },
                  message_templates: { 
                    type: "array", 
                    items: { 
                      type: "object",
                      properties: {
                        channel: { type: "string" },
                        message: { type: "string" }
                      }
                    }
                  },
                  best_time: { type: "string" },
                  follow_up_sequence: { type: "array", items: { type: "string" } },
                  value_proposition: { type: "string" },
                  urgency_factor: { type: "string" },
                  personalization_tips: { type: "array", items: { type: "string" } }
                },
                required: ["title", "strategy", "message_templates", "best_time"]
              }
            });

            if (response && response.title && response.strategy) {
              // Calculate priority based on lead score and engagement
              let priority = "medium";
              if (lead.score >= 70 || engagement.engagementTrend === 'decreasing') {
                priority = "high";
              } else if (lead.score < 40) {
                priority = "low";
              }

              await base44.entities.AIInsight.create({
                insight_type: "follow_up_suggestion",
                entity_type: "lead",
                entity_id: lead.id,
                title: response.title,
                description: response.strategy,
                action_items: [
                  ...(response.message_templates || []).map(t => `[${t.channel}] ${t.message}`),
                  `Best Time: ${response.best_time}`,
                  `Value: ${response.value_proposition}`
                ],
                supporting_data: {
                  engagement,
                  templates: response.message_templates,
                  follow_up_sequence: response.follow_up_sequence,
                  urgency_factor: response.urgency_factor,
                  personalization_tips: response.personalization_tips,
                  best_time: response.best_time
                },
                priority,
                confidence_score: Math.min(100, lead.score + engagement.responseRate),
                user_id: user.id,
                status: "new"
              });

              generatedCount++;
            }
          } catch (leadError) {
            console.error(`Error generating suggestion for lead ${lead.id}:`, leadError);
          }
        }
      }

      toast.success(`Generated ${generatedCount} follow-up suggestions!`);
      await loadSuggestions(user);
    } catch (error) {
      console.error("Error generating suggestions:", error);
      toast.error("Failed to generate suggestions");
    }
    setIsGenerating(false);
  };

  const handleCopyMessage = (message) => {
    navigator.clipboard.writeText(message);
    toast.success("Message copied to clipboard!");
  };

  const handleMarkActedOn = async (suggestion) => {
    try {
      await base44.entities.AIInsight.update(suggestion.id, {
        status: "acted_on"
      });
      toast.success("Marked as completed!");
      await loadSuggestions(user);
    } catch (error) {
      console.error("Error updating suggestion:", error);
    }
  };

  const handleDismiss = async (suggestion) => {
    try {
      await base44.entities.AIInsight.update(suggestion.id, {
        status: "dismissed"
      });
      await loadSuggestions(user);
    } catch (error) {
      console.error("Error dismissing suggestion:", error);
    }
  };

  const getPriorityColor = (priority) => {
    const colors = {
      high: "bg-red-100 text-red-700 border-red-300",
      medium: "bg-yellow-100 text-yellow-700 border-yellow-300",
      low: "bg-blue-100 text-blue-700 border-blue-300"
    };
    return colors[priority] || colors.medium;
  };

  const getPriorityIcon = (priority) => {
    if (priority === 'high') return <AlertCircle className="w-4 h-4" />;
    if (priority === 'medium') return <Clock className="w-4 h-4" />;
    return <CheckCircle2 className="w-4 h-4" />;
  };

  const getChannelIcon = (channel) => {
    if (channel === 'email') return <Mail className="w-4 h-4" />;
    if (channel === 'call') return <Phone className="w-4 h-4" />;
    return <MessageSquare className="w-4 h-4" />;
  };

  if (isLoading) {
    return (
      <div className="page-container">
        <div className="flex items-center justify-center min-h-[400px]">
          <RefreshCw className="w-8 h-8 animate-spin text-indigo-600" />
        </div>
      </div>
    );
  }

  const pendingSuggestions = suggestions.filter(s => s.status === 'new');
  const completedSuggestions = suggestions.filter(s => s.status === 'acted_on');

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Header */}
        <Card className="border-l-4 border-l-indigo-500">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                  <Target className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h1 className="text-2xl font-bold text-slate-900 dark:text-white">
                    Automated Follow-up Suggestions
                  </h1>
                  <p className="text-sm text-slate-600 dark:text-slate-400">
                    AI-powered personalized follow-up strategies for your leads
                  </p>
                </div>
                {pendingSuggestions.length > 0 && (
                  <Badge className="bg-red-500 text-white">
                    {pendingSuggestions.length} Pending
                  </Badge>
                )}
              </div>
              <Button
                onClick={generateFollowupSuggestions}
                disabled={isGenerating}
                className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white"
              >
                {isGenerating ? (
                  <>
                    <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-4 h-4 mr-2" />
                    Generate Suggestions
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardContent className="p-4 text-center">
              <Target className="w-8 h-8 mx-auto mb-2 text-indigo-600" />
              <p className="text-2xl font-bold">{pendingSuggestions.length}</p>
              <p className="text-xs text-slate-600">Pending Actions</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <CheckCircle2 className="w-8 h-8 mx-auto mb-2 text-green-600" />
              <p className="text-2xl font-bold">{completedSuggestions.length}</p>
              <p className="text-xs text-slate-600">Completed</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <TrendingUp className="w-8 h-8 mx-auto mb-2 text-purple-600" />
              <p className="text-2xl font-bold">
                {suggestions.length > 0 
                  ? Math.round(suggestions.reduce((sum, s) => sum + (s.confidence_score || 0), 0) / suggestions.length)
                  : 0}%
              </p>
              <p className="text-xs text-slate-600">Avg Confidence</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <Calendar className="w-8 h-8 mx-auto mb-2 text-amber-600" />
              <p className="text-2xl font-bold">
                {leads.filter(l => l.status !== 'converted' && l.status !== 'lost').length}
              </p>
              <p className="text-xs text-slate-600">Active Leads</p>
            </CardContent>
          </Card>
        </div>

        {/* Suggestions List */}
        <div className="space-y-4">
          {pendingSuggestions.length > 0 ? (
            pendingSuggestions.map((suggestion) => {
              const lead = leads.find(l => l.id === suggestion.entity_id);
              const engagement = lead ? analyzeLeadEngagement(lead) : null;
              const supportingData = suggestion.supporting_data || {};

              return (
                <Card key={suggestion.id} className="border-l-4 border-l-indigo-500 hover:shadow-lg transition-shadow">
                  <CardContent className="p-6">
                    {/* Header */}
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-2">
                          <h3 className="text-xl font-bold text-slate-900 dark:text-white">
                            {suggestion.title}
                          </h3>
                          <Badge className={`${getPriorityColor(suggestion.priority)} flex items-center gap-1`}>
                            {getPriorityIcon(suggestion.priority)}
                            {suggestion.priority}
                          </Badge>
                          <Badge variant="outline">
                            {suggestion.confidence_score}% confidence
                          </Badge>
                        </div>
                        {lead && (
                          <div className="flex items-center gap-4 text-sm text-slate-600">
                            <span className="flex items-center gap-1">
                              <Mail className="w-4 h-4" />
                              {lead.email}
                            </span>
                            {lead.phone && (
                              <span className="flex items-center gap-1">
                                <Phone className="w-4 h-4" />
                                {lead.phone}
                              </span>
                            )}
                            <span className="font-semibold">Score: {lead.score}/100</span>
                          </div>
                        )}
                      </div>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => navigate(createPageUrl(`LeadDetail?id=${lead.id}`))}
                      >
                        View Lead
                      </Button>
                    </div>

                    {/* Strategy */}
                    <div className="mb-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                      <h4 className="font-semibold text-sm text-slate-700 dark:text-slate-300 mb-2">
                        Recommended Strategy:
                      </h4>
                      <p className="text-sm text-slate-600 dark:text-slate-400">
                        {suggestion.description}
                      </p>
                    </div>

                    {/* Engagement Insights */}
                    {engagement && (
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                        <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                          <div className="text-xs text-blue-600 dark:text-blue-400 mb-1">Last Contact</div>
                          <div className="font-semibold text-sm">
                            {engagement.daysSinceContact} days ago
                          </div>
                        </div>
                        <div className="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg">
                          <div className="text-xs text-green-600 dark:text-green-400 mb-1">Response Rate</div>
                          <div className="font-semibold text-sm">
                            {engagement.responseRate.toFixed(0)}%
                          </div>
                        </div>
                        <div className="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg">
                          <div className="text-xs text-purple-600 dark:text-purple-400 mb-1">Preferred Channel</div>
                          <div className="font-semibold text-sm capitalize">
                            {engagement.preferredChannel}
                          </div>
                        </div>
                        <div className="bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg">
                          <div className="text-xs text-amber-600 dark:text-amber-400 mb-1">Engagement Trend</div>
                          <div className="font-semibold text-sm capitalize">
                            {engagement.engagementTrend}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Best Time */}
                    {supportingData.best_time && (
                      <div className="mb-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
                        <div className="flex items-center gap-2">
                          <Clock className="w-4 h-4 text-amber-600" />
                          <span className="font-semibold text-sm text-amber-900 dark:text-amber-100">
                            Best Time to Contact:
                          </span>
                          <span className="text-sm text-amber-700 dark:text-amber-300">
                            {supportingData.best_time}
                          </span>
                        </div>
                      </div>
                    )}

                    {/* Message Templates */}
                    {supportingData.templates && supportingData.templates.length > 0 && (
                      <div className="mb-4">
                        <h4 className="font-semibold text-sm text-slate-700 dark:text-slate-300 mb-3">
                          Message Templates:
                        </h4>
                        <div className="space-y-3">
                          {supportingData.templates.map((template, idx) => (
                            <div key={idx} className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-4">
                              <div className="flex items-start justify-between mb-2">
                                <div className="flex items-center gap-2">
                                  {getChannelIcon(template.channel)}
                                  <span className="font-semibold text-sm capitalize">
                                    {template.channel}
                                  </span>
                                </div>
                                <Button
                                  size="sm"
                                  variant="ghost"
                                  onClick={() => handleCopyMessage(template.message)}
                                >
                                  <Copy className="w-4 h-4" />
                                </Button>
                              </div>
                              <p className="text-sm text-slate-600 dark:text-slate-400 whitespace-pre-wrap">
                                {template.message}
                              </p>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Value Proposition */}
                    {supportingData.value_proposition && (
                      <div className="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                        <h4 className="font-semibold text-sm text-green-900 dark:text-green-100 mb-1 flex items-center gap-2">
                          <TrendingUp className="w-4 h-4" />
                          Value You're Offering:
                        </h4>
                        <p className="text-sm text-green-700 dark:text-green-300">
                          {supportingData.value_proposition}
                        </p>
                      </div>
                    )}

                    {/* Urgency Factor */}
                    {supportingData.urgency_factor && (
                      <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                        <h4 className="font-semibold text-sm text-red-900 dark:text-red-100 mb-1 flex items-center gap-2">
                          <AlertCircle className="w-4 h-4" />
                          Why They Should Respond Now:
                        </h4>
                        <p className="text-sm text-red-700 dark:text-red-300">
                          {supportingData.urgency_factor}
                        </p>
                      </div>
                    )}

                    {/* Personalization Tips */}
                    {supportingData.personalization_tips && supportingData.personalization_tips.length > 0 && (
                      <div className="mb-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-800">
                        <h4 className="font-semibold text-sm text-purple-900 dark:text-purple-100 mb-2">
                          Personalization Tips:
                        </h4>
                        <ul className="space-y-1">
                          {supportingData.personalization_tips.map((tip, idx) => (
                            <li key={idx} className="text-sm text-purple-700 dark:text-purple-300 flex items-start gap-2">
                              <ArrowRight className="w-4 h-4 mt-0.5 flex-shrink-0" />
                              {tip}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* Follow-up Sequence */}
                    {supportingData.follow_up_sequence && supportingData.follow_up_sequence.length > 0 && (
                      <div className="mb-4 p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-200 dark:border-indigo-800">
                        <h4 className="font-semibold text-sm text-indigo-900 dark:text-indigo-100 mb-2">
                          If No Response, Follow Up With:
                        </h4>
                        <ol className="space-y-1 list-decimal list-inside">
                          {supportingData.follow_up_sequence.map((step, idx) => (
                            <li key={idx} className="text-sm text-indigo-700 dark:text-indigo-300">
                              {step}
                            </li>
                          ))}
                        </ol>
                      </div>
                    )}

                    {/* Actions */}
                    <div className="flex gap-3 pt-4 border-t">
                      <Button
                        onClick={() => handleMarkActedOn(suggestion)}
                        className="bg-green-600 hover:bg-green-700 text-white flex-1"
                      >
                        <CheckCircle2 className="w-4 h-4 mr-2" />
                        Mark as Completed
                      </Button>
                      <Button
                        variant="outline"
                        onClick={() => handleDismiss(suggestion)}
                      >
                        <X className="w-4 h-4 mr-2" />
                        Dismiss
                      </Button>
                    </div>
                  </CardContent>
                </Card>
              );
            })
          ) : (
            <Card>
              <CardContent className="p-12 text-center">
                <Target className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                <h3 className="text-xl font-semibold text-slate-900 mb-2">
                  No Follow-up Suggestions Yet
                </h3>
                <p className="text-slate-500 mb-6">
                  Click "Generate Suggestions" to get AI-powered follow-up strategies for your leads
                </p>
                <Button
                  onClick={generateFollowupSuggestions}
                  disabled={isGenerating}
                  className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white"
                >
                  <Sparkles className="w-4 h-4 mr-2" />
                  Generate Suggestions
                </Button>
              </CardContent>
            </Card>
          )}
        </div>

        {/* Completed Suggestions */}
        {completedSuggestions.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <CheckCircle2 className="w-5 h-5 text-green-600" />
                Completed Follow-ups ({completedSuggestions.length})
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                {completedSuggestions.map((suggestion) => {
                  const lead = leads.find(l => l.id === suggestion.entity_id);
                  return (
                    <div key={suggestion.id} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                      <div className="flex items-center gap-3">
                        <CheckCircle2 className="w-5 h-5 text-green-600" />
                        <div>
                          <p className="font-semibold text-sm">{suggestion.title}</p>
                          {lead && (
                            <p className="text-xs text-slate-500">{lead.name} ‚Ä¢ {lead.email}</p>
                          )}
                        </div>
                      </div>
                      <span className="text-xs text-slate-500">
                        {new Date(suggestion.updated_date).toLocaleDateString()}
                      </span>
                    </div>
                  );
                })}
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}


import React, { useState, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import { format, parseISO } from 'date-fns'; // Added parseISO here
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Input } from '@/components/ui/input';
import { Download, Upload, HardDrive, History, AlertTriangle, Palette, Loader2 } from 'lucide-react';

const ENTITIES_TO_BACKUP = [
  "Property", "Lead", "Task", "Transaction", "Contact", "Buyer", "OpenHouse",
  "Message", "Photo", "Document", "Showing", "Commission", "MarketingCampaign",
  "FSBOLead", "Appointment", "TeamMember", "Feedback"
];

const CONFIG_LOCAL_STORAGE_KEYS = [
  "theme", "colorTheme", "navOrder", "openCategories", "dashboardWidgets"
];

export default function BackupRestorePage() {
  const queryClient = useQueryClient();
  const [isDataBackingUp, setIsDataBackingUp] = useState(false);
  const [isConfigBackingUp, setIsConfigBackingUp] = useState(false);
  const [isRestoring, setIsRestoring] = useState(false);
  const [history, setHistory] = useState([]);

  const { data: currentUser } = useQuery({
    queryKey: ["currentUser"],
    queryFn: () => base44.auth.me(),
  });

  const updateUserMutation = useMutation({
    mutationFn: (data) => base44.auth.updateMe(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["currentUser"] });
    },
  });

  useEffect(() => {
    const savedHistory = localStorage.getItem('backupHistory');
    if (savedHistory) {
      setHistory(JSON.parse(savedHistory));
    }
  }, []);

  const addHistoryRecord = (type, description) => {
    const newRecord = {
      date: new Date().toISOString(),
      type,
      description,
    };
    const updatedHistory = [newRecord, ...history.slice(0, 9)];
    setHistory(updatedHistory);
    localStorage.setItem('backupHistory', JSON.stringify(updatedHistory));
  };

  const handleBackupData = async () => {
    setIsDataBackingUp(true);
    toast.info("Starting full data backup. This may take a moment...");

    try {
      const backupData = {};
      const promises = ENTITIES_TO_BACKUP.map(entityName =>
        base44.entities[entityName].list().then(data => {
          backupData[entityName] = data;
        }).catch(err => {
          console.warn(`Could not back up entity ${entityName}:`, err);
          backupData[entityName] = [];
        })
      );

      await Promise.all(promises);

      const jsonString = JSON.stringify(backupData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const timestamp = format(new Date(), 'yyyy-MM-dd_HH-mm-ss');
      link.download = `realtymind_data_backup_${timestamp}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      addHistoryRecord('Data Backup', `Exported ${ENTITIES_TO_BACKUP.length} data models.`);
      toast.success("Data backup successfully downloaded.");
    } catch (error) {
      console.error("Data backup failed:", error);
      toast.error("Data backup failed. Please check the console for details.");
    } finally {
      setIsDataBackingUp(false);
    }
  };

  const handleBackupConfig = async () => {
    setIsConfigBackingUp(true);
    toast.info("Backing up settings and layout...");

    try {
      const configData = {
        localStorage: {},
        userSettings: {},
      };

      // Backup localStorage
      CONFIG_LOCAL_STORAGE_KEYS.forEach(key => {
        const value = localStorage.getItem(key);
        if (value) {
          try {
            configData.localStorage[key] = JSON.parse(value);
          } catch {
            configData.localStorage[key] = value;
          }
        }
      });

      // Backup user-specific settings from their entity
      if (currentUser) {
        configData.userSettings = {
          theme_preference: currentUser.theme_preference,
          dashboard_layout: currentUser.dashboard_layout,
          agent_profile_type: currentUser.agent_profile_type,
          business_goals: currentUser.business_goals,
        };
      }

      const jsonString = JSON.stringify(configData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const timestamp = format(new Date(), 'yyyy-MM-dd_HH-mm-ss');
      link.download = `realtymind_config_backup_${timestamp}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      addHistoryRecord('Config Backup', 'Exported UI settings and layout.');
      toast.success("Configuration backup successfully downloaded.");
    } catch (error) {
      console.error("Config backup failed:", error);
      toast.error("Configuration backup failed.");
    } finally {
      setIsConfigBackingUp(false);
    }
  };

  const handleRestoreConfig = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    setIsRestoring(true);
    toast.info("Restoring configuration...");

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const configData = JSON.parse(e.target.result);

        // Restore localStorage
        if (configData.localStorage) {
          Object.entries(configData.localStorage).forEach(([key, value]) => {
            if (CONFIG_LOCAL_STORAGE_KEYS.includes(key)) {
              localStorage.setItem(key, typeof value === 'object' ? JSON.stringify(value) : value);
            }
          });
        }
        
        // Restore user settings
        if (configData.userSettings && Object.keys(configData.userSettings).length > 0) {
            await updateUserMutation.mutateAsync(configData.userSettings);
        }
        
        addHistoryRecord('Config Restore', `Restored from ${file.name}`);
        toast.success("Configuration restored! The app will now reload to apply changes.", {
          duration: 5000,
        });

        setTimeout(() => {
            window.location.reload();
        }, 3000);

      } catch (error) {
        console.error("Config restore failed:", error);
        toast.error("Failed to restore configuration. The file may be invalid.");
      } finally {
        setIsRestoring(false);
        event.target.value = null; // Reset file input
      }
    };
    reader.readAsText(file);
  };

  return (
    <div className="page-container space-y-8">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Backup & Restore</h1>
        <p className="text-slate-500 mt-2">
          Create and manage backups of your application data and settings.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        {/* Backup Section */}
        <Card className="shadow-lg hover:shadow-xl transition-shadow">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Download className="w-6 h-6 text-indigo-500" />
              Create a Backup
            </CardTitle>
            <CardDescription>
              Download a snapshot of your app's data or configuration.
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            <div>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <HardDrive className="w-5 h-5 text-slate-500" />
                  <span className="font-semibold">Application Data</span>
                </div>
                <Button onClick={handleBackupData} disabled={isDataBackingUp}>
                  {isDataBackingUp ? (
                    <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Backing up...</>
                  ) : (
                    "Backup Data"
                  )}
                </Button>
              </div>
              <p className="text-sm text-slate-500 mt-2 ml-8">
                Exports all records from your properties, leads, tasks, contacts, and other data models into a single JSON file.
              </p>
            </div>
            <div>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <Palette className="w-5 h-5 text-slate-500" />
                  <span className="font-semibold">Settings & Layout</span>
                </div>
                <Button onClick={handleBackupConfig} variant="outline" disabled={isConfigBackingUp}>
                   {isConfigBackingUp ? (
                    <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Backing up...</>
                  ) : (
                    "Backup Config"
                  )}
                </Button>
              </div>
              <p className="text-sm text-slate-500 mt-2 ml-8">
                Exports UI preferences like theme, colors, and navigation menu order.
              </p>
            </div>
          </CardContent>
        </Card>

        {/* Restore Section */}
        <Card className="shadow-lg hover:shadow-xl transition-shadow">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Upload className="w-6 h-6 text-green-500" />
              Restore from Backup
            </CardTitle>
            <CardDescription>
              Upload a backup file to restore your app's state.
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            <div>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <Palette className="w-5 h-5 text-slate-500" />
                  <span className="font-semibold">Restore Settings & Layout</span>
                </div>
                <Button asChild variant="outline">
                   <label htmlFor="config-restore-input" className="cursor-pointer">
                    {isRestoring ? <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Restoring...</> : "Upload Config"}
                    <Input id="config-restore-input" type="file" className="hidden" accept=".json" onChange={handleRestoreConfig} disabled={isRestoring} />
                   </label>
                </Button>
              </div>
               <p className="text-sm text-slate-500 mt-2 ml-8">
                Restore your UI settings. The app will reload after a successful restore.
              </p>
            </div>

            <div>
              <div className="flex items-center gap-3 mb-2">
                <HardDrive className="w-5 h-5 text-slate-500" />
                <span className="font-semibold">Restore Application Data</span>
              </div>
              <Alert variant="destructive">
                <AlertTriangle className="h-4 w-4" />
                <AlertTitle>Manual Process Required</AlertTitle>
                <AlertDescription>
                  For security and data integrity, restoring application data is a manual process. Please contact support or use the dedicated CSV import tools in Settings to restore your data. Automatic data restore is not available to prevent accidental data loss.
                </AlertDescription>
              </Alert>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* History Section */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <History className="w-6 h-6 text-slate-500" />
            Backup History
          </CardTitle>
          <CardDescription>
            A log of your recent backup and restore activities.
          </CardDescription>
        </CardHeader>
        <CardContent>
          {history.length > 0 ? (
            <ul className="space-y-3">
              {history.map((item, index) => (
                <li key={index} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                  <div className="flex items-center gap-3">
                    {item.type.includes('Backup') ? <Download className="w-4 h-4 text-blue-500"/> : <Upload className="w-4 h-4 text-green-500"/>}
                    <div>
                      <p className="font-semibold">{item.type}</p>
                      <p className="text-xs text-slate-500">{item.description}</p>
                    </div>
                  </div>
                  <p className="text-sm text-slate-500 dark:text-slate-400">
                    {format(parseISO(item.date), "MMM d, yyyy 'at' hh:mm a")}
                  </p>
                </li>
              ))}
            </ul>
          ) : (
            <div className="text-center py-8">
              <p className="text-slate-500">No backup activities recorded yet.</p>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { base44 } from "@/api/base44Client";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { 
  ArrowLeft, Edit, Save, X, Mail, Phone, MapPin, DollarSign, Home, 
  User as UserIcon, Calendar, FileText, CheckCircle2, Zap, Bell,
  Sparkles, Activity, Globe, ExternalLink, Facebook, Linkedin, 
  Instagram, Twitter, Heart, Tag, Target, Building2, Key, MessageSquare
} from "lucide-react";
import AddressAutocomplete from "../components/properties/AddressAutocomplete";
import ClientCommunicationPanel from "../components/communication/ClientCommunicationPanel";
import ActivityLogger from "../components/common/ActivityLogger";
import { useQuery, useQueryClient } from "@tanstack/react-query";

const SocialIcon = ({ platform }) => {
    const icons = {
        facebook: <Facebook className="w-4 h-4" />,
        linkedin: <Linkedin className="w-4 h-4" />,
        instagram: <Instagram className="w-4 h-4" />,
        twitter: <Twitter className="w-4 h-4" />,
        default: <Globe className="w-4 h-4" />
    };
    return icons[platform] || icons.default;
};

const IntentScoreBadge = ({ score, type }) => {
    const getScoreConfig = (score) => {
        if (score >= 80) return { label: 'Hot', color: 'bg-red-500', textColor: 'text-white' };
        if (score >= 60) return { label: 'Warm', color: 'bg-orange-500', textColor: 'text-white' };
        if (score >= 40) return { label: 'Lukewarm', color: 'bg-yellow-500', textColor: 'text-white' };
        if (score >= 20) return { label: 'Cool', color: 'bg-blue-500', textColor: 'text-white' };
        return { label: 'Cold', color: 'bg-slate-400', textColor: 'text-white' };
    };

    const config = getScoreConfig(score);
    
    return (
        <div className="flex items-center gap-2">
            <Badge className={`${config.color} ${config.textColor} flex items-center gap-1`}>
                <Target className="w-3 h-3" />
                {config.label} {type}
            </Badge>
            <span className="text-xs font-semibold text-slate-600 dark:text-slate-400">{score}/100</span>
        </div>
    );
};

const IntentSignalCard = ({ signal }) => {
    const getIconAndColor = (category) => {
        if (category === 'buyer') return { Icon: Home, color: 'bg-blue-50 dark:bg-blue-900/20 border-blue-200' };
        if (category === 'seller') return { Icon: DollarSign, color: 'bg-green-50 dark:bg-green-900/20 border-green-200' };
        return { Icon: Activity, color: 'bg-slate-50 dark:bg-slate-900/20 border-slate-200' };
    };
    
    const { Icon, color } = getIconAndColor(signal.category);
    
    return (
        <div className={`flex items-start gap-3 p-3 rounded-lg ${color} border`}>
            <div className="p-2 rounded-lg bg-white dark:bg-slate-800 shadow-sm">
                <Icon className="w-4 h-4 text-indigo-600" />
            </div>
            <div className="flex-1">
                <p className="text-sm font-semibold text-slate-900 dark:text-white">{signal.title}</p>
                <p className="text-xs text-slate-600 dark:text-slate-400 mt-0.5">{signal.description}</p>
                {signal.timestamp && (
                    <p className="text-xs text-slate-500 mt-1">
                        {new Date(signal.timestamp).toLocaleDateString()}
                    </p>
                )}
            </div>
            <Badge variant="outline" className="text-xs">+{signal.score}</Badge>
        </div>
    );
};

export default function BuyerDetail() {
  const { id } = useParams();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [buyer, setBuyer] = useState(null);
  const [properties, setProperties] = useState([]);
  const [users, setUsers] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [editData, setEditData] = useState(null);

  const { data: buyerActivities = [] } = useQuery({
    queryKey: ['buyerActivities', buyer?.id],
    queryFn: () => base44.entities.LeadActivity.filter({ lead_id: buyer.id }),
    enabled: !!buyer?.id
  });

  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const buyerId = urlParams.get('id') || id;
    
    if (buyerId) {
      loadData(buyerId);
    } else {
      setError("No buyer ID provided");
      setIsLoading(false);
    }
  }, [id]);

  const loadData = async (buyerId) => {
    setIsLoading(true);
    setError(null);
    try {
      const [buyerList, propertyData, userData] = await Promise.all([
        base44.entities.Buyer.list(),
        base44.entities.Property.list(),
        base44.entities.User.list()
      ]);
      
      const buyerData = buyerList.find(b => b.id === buyerId);
      
      if (!buyerData) {
        setError("Buyer not found");
        setIsLoading(false);
        return;
      }
      
      setBuyer(buyerData);
      setEditData(buyerData);
      setProperties(propertyData);
      setUsers(userData);
    } catch (error) {
      console.error("Error loading buyer details:", error);
      setError("Failed to load buyer details");
    }
    setIsLoading(false);
  };

  const handleSave = async () => {
    try {
      await base44.entities.Buyer.update(buyer.id, {
        ...editData,
        budget_min: parseFloat(editData.budget_min) || 0,
        budget_max: parseFloat(editData.budget_max) || 0
      });
      setBuyer(editData);
    } catch (error) {
      console.error("Error updating buyer:", error);
      alert("Failed to update buyer. Please try again.");
    }
  };

  const getStatusColor = (status) => {
    const colors = {
      active: "bg-green-100 text-green-700 border-green-200",
      under_contract: "bg-amber-100 text-amber-700 border-amber-200",
      closed: "bg-blue-100 text-blue-700 border-blue-200",
      inactive: "bg-slate-100 text-slate-700 border-slate-200"
    };
    return colors[status] || "bg-slate-100 text-slate-700 border-slate-200";
  };

  if (isLoading) {
    return (
      <div className="page-container">
        <div className="p-8">
          <div className="animate-pulse space-y-6">
            <div className="h-8 bg-slate-200 rounded w-1/3"></div>
            <div className="h-32 bg-slate-200 rounded"></div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="h-48 bg-slate-200 rounded"></div>
              <div className="h-48 bg-slate-200 rounded"></div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (error || !buyer) {
    return (
      <div className="page-container">
        <div className="p-8 text-center">
          <UserIcon className="w-16 h-16 mx-auto mb-4 text-slate-300" />
          <h2 className="text-xl font-semibold text-slate-900 mb-2">
            {error || "Buyer not found"}
          </h2>
          <p className="text-slate-500 mb-4">The buyer you're looking for doesn't exist or may have been removed.</p>
          <Button onClick={() => navigate(createPageUrl("Buyers"))}>
            <ArrowLeft className="w-4 h-4 mr-2" />
            Back to Buyers
          </Button>
        </div>
      </div>
    );
  }

  const assignedProperty = properties.find(p => p.id === buyer.assigned_property_id);
  const assignedAgent = users.find(u => u.id === buyer.assigned_agent_id);

  // Parse intent data
  const intentData = buyer?.intent_data ? JSON.parse(buyer.intent_data) : null;
  const socialProfiles = buyer?.social_media_profiles ? JSON.parse(buyer.social_media_profiles) : {};
  const lifeEvents = buyer?.life_events ? JSON.parse(buyer.life_events) : [];
  const interests = buyer?.interests_hobbies ? JSON.parse(buyer.interests_hobbies) : [];

  return (
    <div className="page-container">
      <div className="p-4 space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => navigate(-1)}
                className="rounded-full"
              >
                <ArrowLeft className="w-5 h-5" />
              </Button>
              <div className="flex items-center gap-4">
                <div className="w-16 h-16 rounded-full flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white text-2xl font-bold">
                  {buyer.first_name?.charAt(0)}{buyer.last_name?.charAt(0)}
                </div>
                <div>
                  <h1 className="app-title text-3xl mb-1">
                    {buyer.first_name} {buyer.last_name}
                  </h1>
                  <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold border ${getStatusColor(buyer.status)}`}>
                    {buyer.status?.replace('_', ' ')}
                  </span>
                </div>
              </div>
            </div>
            <Button onClick={handleSave} className="app-button">
              <Save className="w-4 h-4 mr-2" />
              Save Changes
            </Button>
        </div>

        {/* Intent Intelligence Section */}
        {intentData && (
          <div className="app-card p-6 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
            <h3 className="app-title text-xl mb-4 flex items-center gap-2">
              <div className="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-800 flex items-center justify-center">
                <Sparkles className="w-4 h-4 text-indigo-600 dark:text-indigo-300" />
              </div>
              AI Intent Intelligence
            </h3>
            
            {/* Intent Scores */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div className="bg-white dark:bg-slate-800 p-4 rounded-lg">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-slate-600 dark:text-slate-400">Buyer Intent</span>
                  <Zap className={`w-5 h-5 ${intentData.buyer_intent_score >= 60 ? 'text-red-500' : 'text-slate-400'}`} />
                </div>
                <Progress value={intentData.buyer_intent_score || 0} className="h-3 mb-2" />
                <IntentScoreBadge score={intentData.buyer_intent_score || 0} type="Buyer" />
              </div>
              
              <div className="bg-white dark:bg-slate-800 p-4 rounded-lg">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-slate-600 dark:text-slate-400">Seller Intent</span>
                  <Home className={`w-5 h-5 ${intentData.seller_intent_score >= 60 ? 'text-red-500' : 'text-slate-400'}`} />
                </div>
                <Progress value={intentData.seller_intent_score || 0} className="h-3 mb-2" />
                <IntentScoreBadge score={intentData.seller_intent_score || 0} type="Seller" />
              </div>
            </div>

            {/* Intent Signals */}
            {intentData.signals && intentData.signals.length > 0 && (
              <div className="mb-6">
                <h4 className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                  <Bell className="w-4 h-4" />
                  Recent Intent Signals ({intentData.signals.length})
                </h4>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {intentData.signals.map((signal, i) => (
                    <IntentSignalCard key={i} signal={signal} />
                  ))}
                </div>
              </div>
            )}

            {/* Recommended Actions */}
            {intentData.recommended_actions && intentData.recommended_actions.length > 0 && (
              <div>
                <h4 className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                  <Target className="w-4 h-4" />
                  Recommended Actions
                </h4>
                <ul className="space-y-2">
                  {intentData.recommended_actions.map((action, i) => (
                    <li key={i} className="flex items-start gap-2 text-sm text-slate-700 dark:text-slate-300">
                      <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                      {action}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        )}

        {/* Contact Information */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="app-card p-6">
            <h3 className="app-title text-xl mb-4 flex items-center gap-2">
              <div className="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center">
                <Mail className="w-4 h-4 text-indigo-600" />
              </div>
              Contact Information
            </h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-slate-600 mb-2">Email</label>
                <Input
                  type="email"
                  value={editData.email}
                  onChange={(e) => setEditData({...editData, email: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-slate-600 mb-2">Phone</label>
                <Input
                  type="tel"
                  value={editData.phone}
                  onChange={(e) => setEditData({...editData, phone: e.target.value})}
                />
              </div>
            </div>
          </div>

          <div className="app-card p-6">
            <h3 className="app-title text-xl mb-4 flex items-center gap-2">
              <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                <DollarSign className="w-4 h-4 text-emerald-600" />
              </div>
              Budget Information
            </h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-slate-600 mb-2">Minimum Budget</label>
                <Input
                  type="number"
                  value={editData.budget_min}
                  onChange={(e) => setEditData({...editData, budget_min: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-slate-600 mb-2">Maximum Budget</label>
                <Input
                  type="number"
                  value={editData.budget_max}
                  onChange={(e) => setEditData({...editData, budget_max: e.target.value})}
                />
              </div>
            </div>
          </div>
        </div>

        {/* Current Home Situation */}
        <div className="app-card p-6 border-2 border-amber-400 bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 shadow-lg">
          <h3 className="app-title text-xl mb-4 flex items-center gap-2">
            <div className="w-8 h-8 rounded-lg bg-amber-500 flex items-center justify-center">
              <Building2 className="w-4 h-4 text-white" />
            </div>
            <span className="text-amber-800 dark:text-amber-300 font-bold">Current Home Situation</span>
            <Badge className="bg-amber-500 text-white ml-2">Important</Badge>
          </h3>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-semibold text-slate-600 mb-2">Current Housing Status</label>
              <Select
                value={editData.current_housing_status || "unknown"}
                onValueChange={(value) => setEditData({...editData, current_housing_status: value})}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Select housing status" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="unknown">Unknown</SelectItem>
                  <SelectItem value="renting">Currently Renting</SelectItem>
                  <SelectItem value="owns_selling">Owns Home - Looking to Sell</SelectItem>
                  <SelectItem value="owns_keeping">Owns Home - Keeping It</SelectItem>
                  <SelectItem value="living_with_family">Living with Family</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Show selling fields if owns and selling, or has selling property address, or linked property */}
            {(editData.current_housing_status === "owns_selling" || editData.must_sell_first || editData.selling_property_address || editData.linked_property_id) && (
              <>
                <div>
                  <label className="block text-sm font-semibold text-slate-600 mb-2">Must Sell Before Buying?</label>
                  <Select
                    value={editData.must_sell_first ? "yes" : "no"}
                    onValueChange={(value) => setEditData({...editData, must_sell_first: value === "yes"})}
                  >
                    <SelectTrigger className="w-full">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="no">No - Can buy without selling first</SelectItem>
                      <SelectItem value="yes">Yes - Must sell before buying</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="block text-sm font-semibold text-slate-600 mb-2">Property Address to Sell</label>
                  <AddressAutocomplete
                    value={editData.selling_property_address || ""}
                    city={editData.selling_property_city || ""}
                    state={editData.selling_property_state || ""}
                    zipCode={editData.selling_property_zip || ""}
                    onChange={(value) => setEditData({...editData, selling_property_address: value})}
                    onAddressSelect={(addressData) => {
                      // Construct full address string
                      const fullAddress = addressData.city && addressData.state 
                        ? `${addressData.address}, ${addressData.city}, ${addressData.state} ${addressData.zip_code || ''}`.trim()
                        : addressData.address;
                      setEditData(prev => ({
                        ...prev,
                        selling_property_address: fullAddress,
                        selling_property_city: addressData.city || "",
                        selling_property_state: addressData.state || "",
                        selling_property_zip: addressData.zip_code || ""
                      }));
                    }}
                    onPropertyDataFetch={(propertyData) => {
                      // Extract owner info from property records
                      if (propertyData.owners && propertyData.owners.length > 0) {
                        const owner = propertyData.owners[0];
                        setEditData(prev => ({
                          ...prev,
                          selling_property_owner_name: owner.name || "",
                          selling_property_owner_mailing_address: owner.mailing_address || ""
                        }));
                      }
                      // Update city/state/zip if returned from records
                      if (propertyData.city || propertyData.state || propertyData.zip_code) {
                        setEditData(prev => {
                          const street = prev.selling_property_address?.split(',')[0] || prev.selling_property_address || "";
                          const city = propertyData.city || prev.selling_property_city || "";
                          const state = propertyData.state || prev.selling_property_state || "";
                          const zip = propertyData.zip_code || prev.selling_property_zip || "";
                          const fullAddress = city && state 
                            ? `${street}, ${city}, ${state} ${zip}`.trim()
                            : street;
                          return {
                            ...prev,
                            selling_property_address: fullAddress,
                            selling_property_city: city,
                            selling_property_state: state,
                            selling_property_zip: zip
                          };
                        });
                      }
                    }}
                  />
                </div>

                {/* Owner Name */}
                <div>
                  <label className="block text-sm font-semibold text-slate-600 mb-2">Owner Name</label>
                  <Input
                    type="text"
                    value={editData.selling_property_owner_name || ""}
                    onChange={(e) => setEditData({...editData, selling_property_owner_name: e.target.value})}
                    placeholder="Owner name from tax records"
                  />
                </div>

                {/* Owner Mailing Address */}
                <div>
                  <label className="block text-sm font-semibold text-slate-600 mb-2">Owner Mailing Address</label>
                  <Input
                    type="text"
                    value={editData.selling_property_owner_mailing_address || ""}
                    onChange={(e) => setEditData({...editData, selling_property_owner_mailing_address: e.target.value})}
                    placeholder="Mailing address from tax records"
                  />
                </div>
              </>
            )}

            {/* Show renting note */}
            {editData.current_housing_status === "renting" && (
              <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p className="text-sm text-blue-700">
                  <span className="font-semibold">Note:</span> Buyer is currently renting and ready to transition to homeownership.
                </p>
              </div>
            )}
          </div>
        </div>

        {/* Preferences */}
        <div className="app-card p-6">
          <h3 className="app-title text-xl mb-4 flex items-center gap-2">
            <div className="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
              <Home className="w-4 h-4 text-blue-600" />
            </div>
            Property Preferences
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-semibold text-slate-600 mb-2">Preferred Locations</label>
              <Input
                type="text"
                value={editData.preferred_locations}
                onChange={(e) => setEditData({...editData, preferred_locations: e.target.value})}
                placeholder="Downtown, Marina District"
              />
            </div>
            <div>
              <label className="block text-sm font-semibold text-slate-600 mb-2">Property Type</label>
              <select
                value={editData.property_type_preference}
                onChange={(e) => setEditData({...editData, property_type_preference: e.target.value})}
                className="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none"
              >
                <option value="any">Any Type</option>
                <option value="single_family">Single Family</option>
                <option value="condo">Condo</option>
                <option value="townhouse">Townhouse</option>
                <option value="multi_family">Multi-Family</option>
              </select>
            </div>
          </div>
        </div>

        {/* Social Media Profiles */}
        {Object.keys(socialProfiles).length > 0 && (
          <div className="app-card p-6">
            <h3 className="app-title text-xl mb-4 flex items-center gap-2">
              <div className="w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-800 flex items-center justify-center">
                <Globe className="w-4 h-4 text-purple-600 dark:text-purple-300" />
              </div>
              Social Media Profiles
            </h3>
            <div className="flex flex-wrap gap-3">
              {Object.entries(socialProfiles).map(([platform, url]) => (
                <a
                  key={platform}
                  href={url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                >
                  <SocialIcon platform={platform} />
                  <span className="text-sm font-medium capitalize">{platform}</span>
                  <ExternalLink className="w-3 h-3" />
                </a>
              ))}
            </div>
          </div>
        )}

        {/* Life Events */}
        {lifeEvents.length > 0 && (
          <div className="app-card p-6">
            <h3 className="app-title text-xl mb-4 flex items-center gap-2">
              <div className="w-8 h-8 rounded-lg bg-pink-100 dark:bg-pink-800 flex items-center justify-center">
                <Heart className="w-4 h-4 text-pink-600 dark:text-pink-300" />
              </div>
              Life Events
            </h3>
            <div className="space-y-3">
              {lifeEvents.map((event, i) => (
                <div key={i} className="flex items-start gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                  <Calendar className="w-5 h-5 text-slate-400 mt-0.5" />
                  <div>
                    <p className="font-semibold text-slate-900 dark:text-white">{event.event}</p>
                    {event.date && <p className="text-xs text-slate-500">{new Date(event.date).toLocaleDateString()}</p>}
                    {event.details && <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">{event.details}</p>}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Interests & Hobbies */}
        {interests.length > 0 && (
          <div className="app-card p-6">
            <h3 className="app-title text-xl mb-4 flex items-center gap-2">
              <div className="w-8 h-8 rounded-lg bg-amber-100 dark:bg-amber-800 flex items-center justify-center">
                <Tag className="w-4 h-4 text-amber-600 dark:text-amber-300" />
              </div>
              Interests & Hobbies
            </h3>
            <div className="flex flex-wrap gap-2">
              {interests.map((interest, i) => (
                <Badge key={i} variant="outline" className="text-sm">
                  {interest}
                </Badge>
              ))}
            </div>
          </div>
        )}

        {/* Assignment Information */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {assignedAgent && (
            <div className="app-card p-6">
              <h3 className="app-title text-xl mb-4">Assigned Agent</h3>
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-white font-semibold">
                  {assignedAgent.full_name?.charAt(0) || assignedAgent.email?.charAt(0)}
                </div>
                <div>
                  <p className="font-semibold text-slate-900">{assignedAgent.full_name || assignedAgent.email}</p>
                  <p className="text-sm text-slate-500">{assignedAgent.role || "Agent"}</p>
                </div>
              </div>
            </div>
          )}

          {assignedProperty && (
            <div className="app-card p-6">
              <h3 className="app-title text-xl mb-4">Assigned Property</h3>
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 rounded-lg bg-slate-100 flex items-center justify-center">
                  <Home className="w-6 h-6 text-slate-400" />
                </div>
                <div>
                  <p className="font-semibold text-slate-900">{assignedProperty.address}</p>
                  <p className="text-sm text-slate-500">
                    ${assignedProperty.price?.toLocaleString()}
                  </p>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Notes */}
        <div className="app-card p-6">
          <h3 className="app-title text-xl mb-4 flex items-center gap-2">
            <div className="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center">
              <FileText className="w-4 h-4 text-amber-600" />
            </div>
            Additional Notes
          </h3>
          <textarea
            value={editData.notes}
            onChange={(e) => setEditData({...editData, notes: e.target.value})}
            className="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none"
            rows={4}
            placeholder="Add any additional notes about this buyer..."
          />
        </div>

        {/* Activity Logger */}
        <ActivityLogger
          entityType="buyer"
          entityId={buyer.id}
          entityData={{
            name: `${buyer.first_name} ${buyer.last_name}`,
            email: buyer.email,
            phone: buyer.phone,
            address: buyer.selling_property_address
          }}
          activities={buyerActivities}
          onActivityLogged={() => {
            queryClient.invalidateQueries({ queryKey: ['buyerActivities', buyer.id] });
          }}
        />

        {/* Communication History */}
        <div className="app-card p-6">
          <h3 className="app-title text-xl mb-4 flex items-center gap-2">
            <div className="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center">
              <MessageSquare className="w-4 h-4 text-indigo-600" />
            </div>
            Communication History
          </h3>
          <ClientCommunicationPanel
            clientType="buyer"
            clientId={buyer.id}
            clientData={{
              name: `${buyer.first_name} ${buyer.last_name}`,
              first_name: buyer.first_name,
              email: buyer.email,
              phone: buyer.phone
            }}
          />
        </div>

        {/* Created Date */}
        <div className="app-card p-4 bg-slate-50">
          <div className="flex items-center gap-2 text-sm text-slate-500">
            <Calendar className="w-4 h-4" />
            <span>
              Added on {new Date(buyer.created_date).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}
            </span>
          </div>
        </div>
      </div>
    </div>
  );
}
import React, { useState, useRef } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { 
    MapPin, School, TrendingUp, Home, DollarSign, Users, 
    Mail, Printer, Download, Loader2, Search, Shield, 
    Bus, ShoppingCart, Trees, Activity, Star, Award,
    Navigation, Building, Calendar, AlertCircle
} from 'lucide-react';
import { toast } from 'sonner';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';

export default function BuyerReport() {
    const [zipcode, setZipcode] = useState('');
    const [reportData, setReportData] = useState(null);
    const [isGenerating, setIsGenerating] = useState(false);
    const [isSendingEmail, setIsSendingEmail] = useState(false);
    const [buyerEmail, setBuyerEmail] = useState('');
    const reportRef = useRef(null);

    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me()
    });

    const generateReport = async () => {
        if (!zipcode || zipcode.length < 5) {
            toast.error('Please enter a valid ZIP code');
            return;
        }

        setIsGenerating(true);
        try {
            // Get location data from zipcode
            const locationPrompt = `For ZIP code ${zipcode}, provide the city name, state, and approximate latitude/longitude coordinates.`;
            const locationData = await base44.integrations.Core.InvokeLLM({
                prompt: locationPrompt,
                add_context_from_internet: true,
                response_json_schema: {
                    type: "object",
                    properties: {
                        city: { type: "string" },
                        state: { type: "string" },
                        latitude: { type: "number" },
                        longitude: { type: "number" }
                    }
                }
            });

            // Comprehensive neighborhood data from ATTOM and AI
            const dataPrompt = `
                For ZIP code ${zipcode} (${locationData.city}, ${locationData.state}), provide a comprehensive buyer's guide including:
                
                1. Neighborhood Summary: Character, lifestyle, notable features, what makes it special
                2. Transportation: Public transit options, walkability score, bike-friendliness, commute times to major employment centers
                3. Lifestyle & Amenities: Restaurants, shopping, parks, entertainment, cultural attractions
                4. Market Trends: Current home prices, price trends (6mo, 1yr, 3yr), inventory levels, days on market
                5. Schools: Top-rated schools with ratings, test scores, student-teacher ratios
                6. Safety: Crime rates, safety score, police/fire response times
                7. Demographics: Population, median age, household income, education levels, diversity
                8. Future Development: Planned projects, infrastructure improvements, growth outlook
                
                Provide current, accurate data from internet sources. Be specific with numbers and examples.
            `;

            const comprehensiveData = await base44.integrations.Core.InvokeLLM({
                prompt: dataPrompt,
                add_context_from_internet: true,
                response_json_schema: {
                    type: "object",
                    properties: {
                        neighborhood_summary: {
                            type: "object",
                            properties: {
                                title: { type: "string" },
                                description: { type: "string" },
                                character: { type: "string" },
                                highlights: { type: "array", items: { type: "string" } }
                            }
                        },
                        transportation: {
                            type: "object",
                            properties: {
                                walkability_score: { type: "number" },
                                transit_score: { type: "number" },
                                bike_score: { type: "number" },
                                public_transit: { type: "array", items: { type: "string" } },
                                major_highways: { type: "array", items: { type: "string" } },
                                airports_nearby: { type: "array", items: { 
                                    type: "object",
                                    properties: {
                                        name: { type: "string" },
                                        distance_miles: { type: "number" }
                                    }
                                }}
                            }
                        },
                        lifestyle: {
                            type: "object",
                            properties: {
                                restaurants_count: { type: "number" },
                                shopping_centers: { type: "array", items: { type: "string" } },
                                parks_recreation: { type: "array", items: { type: "string" } },
                                entertainment: { type: "array", items: { type: "string" } },
                                nightlife_rating: { type: "number" },
                                family_friendly_rating: { type: "number" }
                            }
                        },
                        market_trends: {
                            type: "object",
                            properties: {
                                median_home_price: { type: "number" },
                                price_per_sqft: { type: "number" },
                                price_trend_6mo: { type: "string" },
                                price_change_percentage: { type: "number" },
                                avg_days_on_market: { type: "number" },
                                inventory_level: { type: "string" },
                                market_temperature: { type: "string" },
                                forecast: { type: "string" }
                            }
                        },
                        schools: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    name: { type: "string" },
                                    type: { type: "string" },
                                    rating: { type: "number" },
                                    distance_miles: { type: "number" },
                                    test_scores: { type: "string" },
                                    student_teacher_ratio: { type: "string" }
                                }
                            }
                        },
                        safety: {
                            type: "object",
                            properties: {
                                crime_rate: { type: "string" },
                                safety_score: { type: "number" },
                                violent_crime_rate: { type: "string" },
                                property_crime_rate: { type: "string" },
                                police_response_time: { type: "string" }
                            }
                        },
                        demographics: {
                            type: "object",
                            properties: {
                                population: { type: "number" },
                                median_age: { type: "number" },
                                median_household_income: { type: "number" },
                                education_bachelor_plus: { type: "number" },
                                diversity_index: { type: "number" }
                            }
                        },
                        future_development: {
                            type: "object",
                            properties: {
                                growth_outlook: { type: "string" },
                                major_projects: { type: "array", items: { type: "string" } },
                                infrastructure_improvements: { type: "array", items: { type: "string" } }
                            }
                        }
                    }
                }
            });

            setReportData({
                zipcode,
                location: locationData,
                ...comprehensiveData,
                generated_date: new Date().toLocaleDateString(),
                agent: user
            });

            toast.success('Report generated successfully!');
        } catch (error) {
            console.error('Error generating report:', error);
            toast.error('Failed to generate report. Please try again.');
        } finally {
            setIsGenerating(false);
        }
    };

    const handlePrint = () => {
        window.print();
    };

    const handleDownloadPDF = async () => {
        if (!reportRef.current) return;

        try {
            toast.info('Generating PDF... This may take a moment');
            
            const canvas = await html2canvas(reportRef.current, {
                scale: 2,
                useCORS: true,
                logging: false
            });

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(`Buyer-Report-${zipcode}-${Date.now()}.pdf`);
            toast.success('PDF downloaded successfully!');
        } catch (error) {
            console.error('PDF generation error:', error);
            toast.error('Failed to generate PDF');
        }
    };

    const handleEmailReport = async () => {
        if (!buyerEmail) {
            toast.error('Please enter buyer email address');
            return;
        }

        setIsSendingEmail(true);
        try {
            const reportHTML = reportRef.current?.innerHTML || '';
            
            await base44.integrations.Core.SendEmail({
                to: buyerEmail,
                from_name: user?.full_name || 'Your Real Estate Agent',
                subject: `Comprehensive Buyer Report - ${reportData.location.city}, ${reportData.location.state} (${zipcode})`,
                body: `
                    <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
                        <h1 style="color: #4F46E5;">Buyer Report for ${reportData.location.city}, ${reportData.location.state}</h1>
                        <p>Hi there! I've prepared a comprehensive neighborhood report for ZIP code ${zipcode}. This report includes market trends, schools, safety information, and lifestyle amenities to help you make an informed decision.</p>
                        ${reportHTML}
                        <hr style="margin: 30px 0; border: 1px solid #e5e7eb;">
                        <p style="color: #64748b; font-size: 14px;">This report was prepared by ${user?.full_name || 'your agent'}. If you have any questions or would like to schedule a showing, please don't hesitate to reach out!</p>
                    </div>
                `
            });

            toast.success(`Report sent to ${buyerEmail}!`);
            setBuyerEmail('');
        } catch (error) {
            console.error('Email error:', error);
            toast.error('Failed to send email');
        } finally {
            setIsSendingEmail(false);
        }
    };

    const ScoreCircle = ({ score, max = 100, label, color = "indigo" }) => {
        const percentage = (score / max) * 100;
        const circumference = 2 * Math.PI * 40;
        const strokeDashoffset = circumference - (percentage / 100) * circumference;

        return (
            <div className="flex flex-col items-center">
                <div className="relative w-24 h-24">
                    <svg className="transform -rotate-90 w-24 h-24">
                        <circle cx="48" cy="48" r="40" stroke="#e5e7eb" strokeWidth="8" fill="none" />
                        <circle 
                            cx="48" cy="48" r="40" 
                            stroke={`var(--theme-primary)`}
                            strokeWidth="8" 
                            fill="none"
                            strokeDasharray={circumference}
                            strokeDashoffset={strokeDashoffset}
                            strokeLinecap="round"
                            className="transition-all duration-1000"
                        />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                        <span className="text-2xl font-bold text-slate-900 dark:text-white">{score}</span>
                    </div>
                </div>
                <p className="text-sm font-medium text-slate-600 dark:text-slate-400 mt-2">{label}</p>
            </div>
        );
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 via-indigo-50 to-purple-50 dark:from-slate-950 dark:via-indigo-950 dark:to-purple-950">
            <div className="max-w-7xl mx-auto p-6 space-y-6">
                {/* Header */}
                <div className="text-center space-y-4">
                    <div className="inline-flex items-center gap-3 px-6 py-3 bg-white dark:bg-slate-900 rounded-full shadow-lg">
                        <Home className="w-6 h-6 text-indigo-600" />
                        <h1 className="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                            Comprehensive Buyer Report
                        </h1>
                    </div>
                    <p className="text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">
                        Generate detailed neighborhood insights, market analysis, and lifestyle information for any ZIP code
                    </p>
                </div>

                {/* Search Section */}
                <Card className="border-2 border-indigo-200 dark:border-indigo-800 shadow-xl">
                    <CardContent className="p-6">
                        <div className="flex flex-col md:flex-row gap-4">
                            <div className="flex-1">
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                    Enter ZIP Code
                                </label>
                                <div className="relative">
                                    <MapPin className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                                    <Input
                                        type="text"
                                        placeholder="e.g., 90210"
                                        value={zipcode}
                                        onChange={(e) => setZipcode(e.target.value)}
                                        className="pl-10 text-lg h-12"
                                        maxLength={5}
                                    />
                                </div>
                            </div>
                            <div className="flex items-end">
                                <Button
                                    onClick={generateReport}
                                    disabled={isGenerating}
                                    size="lg"
                                    className="w-full md:w-auto bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                                >
                                    {isGenerating ? (
                                        <><Loader2 className="w-5 h-5 mr-2 animate-spin" /> Generating...</>
                                    ) : (
                                        <><Search className="w-5 h-5 mr-2" /> Generate Report</>
                                    )}
                                </Button>
                            </div>
                        </div>
                    </CardContent>
                </Card>

                {/* Report Display */}
                {reportData && (
                    <>
                        {/* Action Buttons */}
                        <div className="flex flex-wrap gap-3 justify-end print:hidden">
                            <div className="flex gap-2 items-center">
                                <Input
                                    type="email"
                                    placeholder="Buyer's email"
                                    value={buyerEmail}
                                    onChange={(e) => setBuyerEmail(e.target.value)}
                                    className="w-64"
                                />
                                <Button
                                    onClick={handleEmailReport}
                                    disabled={isSendingEmail}
                                    variant="outline"
                                    className="border-green-600 text-green-600 hover:bg-green-50"
                                >
                                    {isSendingEmail ? <Loader2 className="w-4 h-4 animate-spin" /> : <Mail className="w-4 h-4 mr-2" />}
                                    Email
                                </Button>
                            </div>
                            <Button onClick={handleDownloadPDF} variant="outline" className="border-blue-600 text-blue-600 hover:bg-blue-50">
                                <Download className="w-4 h-4 mr-2" /> Download PDF
                            </Button>
                            <Button onClick={handlePrint} variant="outline" className="border-slate-600 text-slate-600 hover:bg-slate-50">
                                <Printer className="w-4 h-4 mr-2" /> Print
                            </Button>
                        </div>

                        {/* Report Content */}
                        <div ref={reportRef} className="space-y-6 bg-white dark:bg-slate-900 p-8 rounded-2xl shadow-2xl">
                            {/* Report Header */}
                            <div className="border-b-4 border-gradient-to-r from-indigo-600 to-purple-600 pb-6">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h2 className="text-4xl font-bold text-slate-900 dark:text-white mb-2">
                                            {reportData.location.city}, {reportData.location.state}
                                        </h2>
                                        <p className="text-xl text-slate-600 dark:text-slate-400">ZIP Code: {reportData.zipcode}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-sm text-slate-500">Generated on</p>
                                        <p className="text-lg font-semibold text-slate-900 dark:text-white">{reportData.generated_date}</p>
                                        {reportData.agent && (
                                            <p className="text-sm text-slate-600 dark:text-slate-400 mt-2">
                                                Prepared by: {reportData.agent.full_name}
                                            </p>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Neighborhood Summary */}
                            <section className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-950 dark:to-purple-950 rounded-xl p-6 border-l-4 border-indigo-600">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-12 h-12 rounded-xl bg-indigo-600 flex items-center justify-center">
                                        <Home className="w-6 h-6 text-white" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white">Neighborhood Summary</h3>
                                </div>
                                <p className="text-lg text-slate-700 dark:text-slate-300 leading-relaxed mb-4">
                                    {reportData.neighborhood_summary.description}
                                </p>
                                <div className="grid md:grid-cols-2 gap-4">
                                    {reportData.neighborhood_summary.highlights?.map((highlight, idx) => (
                                        <div key={idx} className="flex items-start gap-2">
                                            <Star className="w-5 h-5 text-yellow-500 flex-shrink-0 mt-1" />
                                            <p className="text-slate-700 dark:text-slate-300">{highlight}</p>
                                        </div>
                                    ))}
                                </div>
                            </section>

                            {/* Transportation */}
                            <section className="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-950 dark:to-cyan-950 rounded-xl p-6 border-l-4 border-blue-600">
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="w-12 h-12 rounded-xl bg-blue-600 flex items-center justify-center">
                                        <Bus className="w-6 h-6 text-white" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white">Transportation & Accessibility</h3>
                                </div>
                                
                                <div className="grid grid-cols-3 gap-8 mb-6">
                                    <ScoreCircle score={reportData.transportation.walkability_score} label="Walkability" />
                                    <ScoreCircle score={reportData.transportation.transit_score} label="Transit" />
                                    <ScoreCircle score={reportData.transportation.bike_score} label="Bike Score" />
                                </div>

                                <div className="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <h4 className="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                                            <Navigation className="w-4 h-4 text-blue-600" /> Public Transit
                                        </h4>
                                        <ul className="space-y-1">
                                            {reportData.transportation.public_transit?.map((transit, idx) => (
                                                <li key={idx} className="text-slate-700 dark:text-slate-300 pl-4">‚Ä¢ {transit}</li>
                                            ))}
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 className="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                                            <MapPin className="w-4 h-4 text-blue-600" /> Nearby Airports
                                        </h4>
                                        <ul className="space-y-1">
                                            {reportData.transportation.airports_nearby?.map((airport, idx) => (
                                                <li key={idx} className="text-slate-700 dark:text-slate-300 pl-4">
                                                    ‚Ä¢ {airport.name} ({airport.distance_miles} miles)
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </section>

                            {/* Lifestyle & Amenities */}
                            <section className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-950 dark:to-emerald-950 rounded-xl p-6 border-l-4 border-green-600">
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="w-12 h-12 rounded-xl bg-green-600 flex items-center justify-center">
                                        <ShoppingCart className="w-6 h-6 text-white" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white">Lifestyle & Amenities</h3>
                                </div>

                                <div className="grid md:grid-cols-3 gap-6 mb-6">
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center">
                                        <p className="text-3xl font-bold text-green-600">{reportData.lifestyle.restaurants_count}+</p>
                                        <p className="text-sm text-slate-600 dark:text-slate-400">Restaurants</p>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center">
                                        <div className="flex items-center justify-center gap-1 mb-1">
                                            {[...Array(5)].map((_, i) => (
                                                <Star key={i} className={`w-4 h-4 ${i < reportData.lifestyle.nightlife_rating ? 'text-yellow-500 fill-yellow-500' : 'text-slate-300'}`} />
                                            ))}
                                        </div>
                                        <p className="text-sm text-slate-600 dark:text-slate-400">Nightlife</p>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center">
                                        <div className="flex items-center justify-center gap-1 mb-1">
                                            {[...Array(5)].map((_, i) => (
                                                <Star key={i} className={`w-4 h-4 ${i < reportData.lifestyle.family_friendly_rating ? 'text-yellow-500 fill-yellow-500' : 'text-slate-300'}`} />
                                            ))}
                                        </div>
                                        <p className="text-sm text-slate-600 dark:text-slate-400">Family Friendly</p>
                                    </div>
                                </div>

                                <div className="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <h4 className="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                                            <Trees className="w-4 h-4 text-green-600" /> Parks & Recreation
                                        </h4>
                                        <ul className="space-y-1">
                                            {reportData.lifestyle.parks_recreation?.slice(0, 4).map((park, idx) => (
                                                <li key={idx} className="text-slate-700 dark:text-slate-300 pl-4">‚Ä¢ {park}</li>
                                            ))}
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 className="font-semibold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                                            <Building className="w-4 h-4 text-green-600" /> Shopping Centers
                                        </h4>
                                        <ul className="space-y-1">
                                            {reportData.lifestyle.shopping_centers?.slice(0, 4).map((center, idx) => (
                                                <li key={idx} className="text-slate-700 dark:text-slate-300 pl-4">‚Ä¢ {center}</li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </section>

                            {/* Market Trends */}
                            <section className="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950 dark:to-pink-950 rounded-xl p-6 border-l-4 border-purple-600">
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="w-12 h-12 rounded-xl bg-purple-600 flex items-center justify-center">
                                        <TrendingUp className="w-6 h-6 text-white" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white">Market Trends</h3>
                                </div>

                                <div className="grid md:grid-cols-4 gap-4 mb-6">
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center border-2 border-purple-200 dark:border-purple-800">
                                        <DollarSign className="w-6 h-6 text-purple-600 mx-auto mb-2" />
                                        <p className="text-2xl font-bold text-slate-900 dark:text-white">
                                            ${(reportData.market_trends.median_home_price / 1000).toFixed(0)}K
                                        </p>
                                        <p className="text-xs text-slate-600 dark:text-slate-400">Median Price</p>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center border-2 border-purple-200 dark:border-purple-800">
                                        <Activity className="w-6 h-6 text-purple-600 mx-auto mb-2" />
                                        <p className="text-2xl font-bold text-slate-900 dark:text-white">
                                            ${reportData.market_trends.price_per_sqft}
                                        </p>
                                        <p className="text-xs text-slate-600 dark:text-slate-400">Price/Sqft</p>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center border-2 border-purple-200 dark:border-purple-800">
                                        <Calendar className="w-6 h-6 text-purple-600 mx-auto mb-2" />
                                        <p className="text-2xl font-bold text-slate-900 dark:text-white">
                                            {reportData.market_trends.avg_days_on_market}
                                        </p>
                                        <p className="text-xs text-slate-600 dark:text-slate-400">Days on Market</p>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center border-2 border-purple-200 dark:border-purple-800">
                                        <TrendingUp className="w-6 h-6 text-green-600 mx-auto mb-2" />
                                        <p className="text-2xl font-bold text-green-600">
                                            {reportData.market_trends.price_change_percentage > 0 ? '+' : ''}{reportData.market_trends.price_change_percentage}%
                                        </p>
                                        <p className="text-xs text-slate-600 dark:text-slate-400">Price Change</p>
                                    </div>
                                </div>

                                <div className="bg-white dark:bg-slate-800 rounded-lg p-4">
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                            reportData.market_trends.market_temperature === 'hot' ? 'bg-red-100 text-red-700' :
                                            reportData.market_trends.market_temperature === 'balanced' ? 'bg-blue-100 text-blue-700' :
                                            'bg-green-100 text-green-700'
                                        }`}>
                                            {reportData.market_trends.market_temperature} Market
                                        </span>
                                        <span className="text-sm text-slate-600 dark:text-slate-400">
                                            ‚Ä¢ {reportData.market_trends.inventory_level} Inventory
                                        </span>
                                    </div>
                                    <p className="text-slate-700 dark:text-slate-300">{reportData.market_trends.forecast}</p>
                                </div>
                            </section>

                            {/* Schools */}
                            <section className="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950 dark:to-orange-950 rounded-xl p-6 border-l-4 border-amber-600">
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="w-12 h-12 rounded-xl bg-amber-600 flex items-center justify-center">
                                        <School className="w-6 h-6 text-white" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white">Top-Rated Schools</h3>
                                </div>

                                <div className="space-y-4">
                                    {reportData.schools?.slice(0, 5).map((school, idx) => (
                                        <div key={idx} className="bg-white dark:bg-slate-800 rounded-lg p-4 flex items-center justify-between">
                                            <div className="flex-1">
                                                <h4 className="font-semibold text-slate-900 dark:text-white">{school.name}</h4>
                                                <p className="text-sm text-slate-600 dark:text-slate-400">{school.type} ‚Ä¢ {school.distance_miles} miles</p>
                                                <p className="text-xs text-slate-500 dark:text-slate-500 mt-1">
                                                    Ratio: {school.student_teacher_ratio}
                                                </p>
                                            </div>
                                            <div className="flex flex-col items-center">
                                                <div className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold ${
                                                    school.rating >= 8 ? 'bg-green-100 text-green-700' :
                                                    school.rating >= 6 ? 'bg-blue-100 text-blue-700' :
                                                    'bg-amber-100 text-amber-700'
                                                }`}>
                                                    {school.rating}
                                                </div>
                                                <p className="text-xs text-slate-500 mt-1">Rating</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </section>

                            {/* Safety */}
                            <section className="bg-gradient-to-br from-red-50 to-rose-50 dark:from-red-950 dark:to-rose-950 rounded-xl p-6 border-l-4 border-red-600">
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="w-12 h-12 rounded-xl bg-red-600 flex items-center justify-center">
                                        <Shield className="w-6 h-6 text-white" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white">Safety & Security</h3>
                                </div>

                                <div className="grid md:grid-cols-2 gap-6">
                                    <div className="text-center">
                                        <ScoreCircle score={reportData.safety.safety_score} label="Safety Score" />
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mt-2">{reportData.safety.crime_rate}</p>
                                    </div>
                                    <div className="space-y-3">
                                        <div className="bg-white dark:bg-slate-800 rounded-lg p-3">
                                            <p className="text-sm text-slate-600 dark:text-slate-400">Violent Crime</p>
                                            <p className="font-semibold text-slate-900 dark:text-white">{reportData.safety.violent_crime_rate}</p>
                                        </div>
                                        <div className="bg-white dark:bg-slate-800 rounded-lg p-3">
                                            <p className="text-sm text-slate-600 dark:text-slate-400">Property Crime</p>
                                            <p className="font-semibold text-slate-900 dark:text-white">{reportData.safety.property_crime_rate}</p>
                                        </div>
                                        <div className="bg-white dark:bg-slate-800 rounded-lg p-3">
                                            <p className="text-sm text-slate-600 dark:text-slate-400">Police Response Time</p>
                                            <p className="font-semibold text-slate-900 dark:text-white">{reportData.safety.police_response_time}</p>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            {/* Demographics */}
                            <section className="bg-gradient-to-br from-cyan-50 to-teal-50 dark:from-cyan-950 dark:to-teal-950 rounded-xl p-6 border-l-4 border-cyan-600">
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="w-12 h-12 rounded-xl bg-cyan-600 flex items-center justify-center">
                                        <Users className="w-6 h-6 text-white" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white">Demographics</h3>
                                </div>

                                <div className="grid md:grid-cols-3 gap-4">
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center">
                                        <p className="text-3xl font-bold text-cyan-600">{reportData.demographics.population?.toLocaleString()}</p>
                                        <p className="text-sm text-slate-600 dark:text-slate-400">Population</p>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center">
                                        <p className="text-3xl font-bold text-cyan-600">${(reportData.demographics.median_household_income / 1000).toFixed(0)}K</p>
                                        <p className="text-sm text-slate-600 dark:text-slate-400">Median Income</p>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 rounded-lg p-4 text-center">
                                        <p className="text-3xl font-bold text-cyan-600">{reportData.demographics.median_age}</p>
                                        <p className="text-sm text-slate-600 dark:text-slate-400">Median Age</p>
                                    </div>
                                </div>
                            </section>

                            {/* Future Development */}
                            <section className="bg-gradient-to-br from-violet-50 to-fuchsia-50 dark:from-violet-950 dark:to-fuchsia-950 rounded-xl p-6 border-l-4 border-violet-600">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-12 h-12 rounded-xl bg-violet-600 flex items-center justify-center">
                                        <Award className="w-6 h-6 text-white" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white">Future Development</h3>
                                </div>
                                <p className="text-lg text-slate-700 dark:text-slate-300 mb-4">{reportData.future_development.growth_outlook}</p>
                                
                                {reportData.future_development.major_projects?.length > 0 && (
                                    <div className="mb-4">
                                        <h4 className="font-semibold text-slate-900 dark:text-white mb-2">Major Projects</h4>
                                        <ul className="space-y-1">
                                            {reportData.future_development.major_projects.map((project, idx) => (
                                                <li key={idx} className="text-slate-700 dark:text-slate-300 pl-4">‚Ä¢ {project}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </section>

                            {/* Agent Biography */}
                            {reportData.agent && (
                                <section className="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 rounded-xl p-8 border-2 border-indigo-200 dark:border-indigo-800">
                                    <div className="flex flex-col md:flex-row gap-6">
                                        <div className="flex-shrink-0">
                                            <div className="w-32 h-32 rounded-2xl bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white text-4xl font-bold shadow-xl overflow-hidden">
                                                {reportData.agent.profile_photo_url ? (
                                                    <img src={reportData.agent.profile_photo_url} alt={reportData.agent.full_name} className="w-full h-full object-cover" />
                                                ) : (
                                                    reportData.agent.full_name?.charAt(0) || 'A'
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-3xl font-bold text-slate-900 dark:text-white mb-2">
                                                {reportData.agent.full_name}
                                            </h3>
                                            {reportData.agent.office && (
                                                <p className="text-xl text-slate-700 dark:text-slate-300 font-semibold mb-2">
                                                    {reportData.agent.office}
                                                </p>
                                            )}
                                            <p className="text-lg text-indigo-600 dark:text-indigo-400 font-semibold mb-4">
                                                Your Trusted Real Estate Professional
                                            </p>
                                            
                                            {reportData.agent.bio && (
                                                <p className="text-slate-700 dark:text-slate-300 leading-relaxed mb-4">
                                                    {reportData.agent.bio}
                                                </p>
                                            )}
                                            
                                            <div className="grid md:grid-cols-2 gap-4 mb-4">
                                                {reportData.agent.email && (
                                                    <div className="flex items-center gap-2">
                                                        <Mail className="w-5 h-5 text-indigo-600" />
                                                        <div>
                                                            <p className="text-xs text-slate-500 dark:text-slate-400">Email</p>
                                                            <p className="font-medium text-slate-900 dark:text-white">{reportData.agent.email}</p>
                                                        </div>
                                                    </div>
                                                )}
                                                {reportData.agent.phone && (
                                                    <div className="flex items-center gap-2">
                                                        <Users className="w-5 h-5 text-indigo-600" />
                                                        <div>
                                                            <p className="text-xs text-slate-500 dark:text-slate-400">Phone</p>
                                                            <p className="font-medium text-slate-900 dark:text-white">{reportData.agent.phone}</p>
                                                        </div>
                                                    </div>
                                                )}
                                                {reportData.agent.license_number && (
                                                    <div className="flex items-center gap-2">
                                                        <Award className="w-5 h-5 text-indigo-600" />
                                                        <div>
                                                            <p className="text-xs text-slate-500 dark:text-slate-400">License #</p>
                                                            <p className="font-medium text-slate-900 dark:text-white">{reportData.agent.license_number}</p>
                                                        </div>
                                                    </div>
                                                )}
                                                {reportData.agent.brokerage && (
                                                    <div className="flex items-center gap-2">
                                                        <Building className="w-5 h-5 text-indigo-600" />
                                                        <div>
                                                            <p className="text-xs text-slate-500 dark:text-slate-400">Brokerage</p>
                                                            <p className="font-medium text-slate-900 dark:text-white">{reportData.agent.brokerage}</p>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {reportData.agent.specializations && (
                                                <div className="mb-4">
                                                    <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Specializations:</p>
                                                    <div className="flex flex-wrap gap-2">
                                                        {reportData.agent.specializations.split(',').map((spec, idx) => (
                                                            <span key={idx} className="px-3 py-1 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded-full text-sm font-medium">
                                                                {spec.trim()}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {reportData.agent.years_experience && (
                                                <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                                                    <Calendar className="w-4 h-4" />
                                                    <span>{reportData.agent.years_experience} years of experience in real estate</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </section>
                            )}

                            {/* Footer */}
                            <div className="border-t-2 border-slate-200 dark:border-slate-700 pt-6 text-center">
                                <p className="text-slate-500 dark:text-slate-400 text-sm">
                                    This report is provided for informational purposes only. Data is sourced from public records and third-party providers. 
                                    Please verify all information independently.
                                </p>
                            </div>
                        </div>
                    </>
                )}
            </div>

            <style dangerouslySetInnerHTML={{ __html: `
                @media print {
                    body * {
                        visibility: hidden;
                    }
                    [data-print="true"], [data-print="true"] * {
                        visibility: visible;
                    }
                    @page {
                        margin: 1cm;
                    }
                }
            `}} />
        </div>
    );
}
import React, { useState, useMemo } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Plus,
  Search,
  UserCheck,
  DollarSign,
  Home,
  TrendingUp,
  Heart,
  Filter,
  User,
  Edit,
  Eye,
  Mail,
  Phone,
  MapPin,
  Calendar,
  Calculator,
  Building2,
  Percent,
  CreditCard,
  FileText,
  List,
  Grid3x3,
  ArrowUpDown,
  ArrowUp,
  ArrowDown,
  Sparkles,
  RefreshCw,
  AlertTriangle,
  ExternalLink,
  ArrowRightLeft,
  CheckCircle,
  Send,
  ArrowLeft,
  Loader2,
} from "lucide-react";
import { toast } from "sonner";
import BuyerModal from "../components/buyers/BuyerModal";
import BuyerCampaignModal from "../components/buyers/BuyerCampaignModal";
import LoadingSpinner from "../components/common/LoadingSpinner";
import { format } from "date-fns";

// Function to find matching properties for a buyer
const findMatchingProperties = (buyer, properties) => {
  if (!properties || properties.length === 0) return [];
  
  return properties.filter(property => {
    // Only consider active properties for sale
    if (property.status !== 'active') return false;
    
    // Check price range
    const propertyPrice = property.price || 0;
    const minBudget = buyer.budget_min || 0;
    const maxBudget = buyer.budget_max || buyer.calculated_max_price || Infinity;
    
    if (propertyPrice < minBudget * 0.9 || propertyPrice > maxBudget * 1.1) return false;
    
    // Check property type preference
    if (buyer.property_type_preference && buyer.property_type_preference !== 'any') {
      if (property.property_type && property.property_type !== buyer.property_type_preference) return false;
    }
    
    // Check bedrooms
    if (buyer.min_bedrooms && property.bedrooms) {
      if (property.bedrooms < buyer.min_bedrooms) return false;
    }
    
    // Check bathrooms
    if (buyer.min_bathrooms && property.bathrooms) {
      if (property.bathrooms < buyer.min_bathrooms) return false;
    }
    
    // Check square feet
    if (buyer.min_square_feet && property.square_feet) {
      if (property.square_feet < buyer.min_square_feet) return false;
    }
    
    // Check location (case-insensitive partial match)
    if (buyer.preferred_locations) {
      const locations = buyer.preferred_locations.toLowerCase().split(',').map(l => l.trim());
      const propertyLocation = `${property.city || ''} ${property.state || ''} ${property.address || ''}`.toLowerCase();
      const locationMatch = locations.some(loc => propertyLocation.includes(loc) || loc.includes(property.city?.toLowerCase() || ''));
      // Location is a soft match - don't exclude if no match, but prioritize if match
    }
    
    return true;
  });
};

const SortableHeader = ({ field, label, sortField, sortDirection, setSortField, setSortDirection, className }) => {
  const isActive = sortField === field;

  const handleClick = () => {
    if (isActive) {
      setSortDirection(sortDirection === "asc" ? "desc" : "asc");
    } else {
      setSortField(field);
      setSortDirection("desc");
    }
  };

  return (
    <button
      onClick={handleClick}
      className={`flex items-center gap-1 hover:text-slate-700 dark:hover:text-slate-300 transition-colors cursor-pointer ${className} ${isActive ? "text-indigo-600" : ""}`}
    >
      <span>{label}</span>
      {isActive ? (
        sortDirection === "asc" ? <ArrowUp className="w-3 h-3" /> : <ArrowDown className="w-3 h-3" />
      ) : (
        <ArrowUpDown className="w-3 h-3 opacity-40" />
      )}
    </button>
  );
};

export default function BuyersPage() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [searchTerm, setSearchTerm] = useState("");
  const [statusFilter, setStatusFilter] = useState("all");
  const [preApprovedFilter, setPreApprovedFilter] = useState(false);
  const [hasPropertyToSellFilter, setHasPropertyToSellFilter] = useState(false);
  const [mustSellFirstFilter, setMustSellFirstFilter] = useState(false);
  const [timelineFilter, setTimelineFilter] = useState("all");
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingBuyer, setEditingBuyer] = useState(null);
  const [viewMode, setViewMode] = useState("list");
  const [sortField, setSortField] = useState("created_date");
  const [sortDirection, setSortDirection] = useState("desc");
  const [isRefreshingMatches, setIsRefreshingMatches] = useState(false);
  const [sendingCampaign, setSendingCampaign] = useState(null);
  const [campaignModalBuyer, setCampaignModalBuyer] = useState(null);

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me(),
    staleTime: 30 * 60 * 1000, // 30 minutes
    cacheTime: 60 * 60 * 1000, // 1 hour
    refetchOnWindowFocus: false,
    refetchOnMount: false,
    retry: 1,
  });

  const { data: buyers = [], isLoading: isLoadingBuyers, error: buyersError } = useQuery({
    queryKey: ["buyers"],
    queryFn: () => base44.entities.Buyer.list("-created_date"),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
    keepPreviousData: true,
  });

  const { data: users = [] } = useQuery({
    queryKey: ["users"],
    queryFn: () => base44.entities.User.list(),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
  });

  const { data: properties = [] } = useQuery({
    queryKey: ["properties"],
    queryFn: () => base44.entities.Property.list(),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
  });

  const userBuyers = useMemo(() => {
    if (!user) return buyers;
    
    if (user.role === 'admin') return buyers;
    
    return buyers.filter(buyer => 
      buyer.assigned_agent_id === user.id || 
      buyer.created_by === user.email
    );
  }, [buyers, user]);

  // Calculate matching properties for each buyer
  const buyerMatchingProperties = useMemo(() => {
    const matches = {};
    userBuyers.forEach(buyer => {
      matches[buyer.id] = findMatchingProperties(buyer, properties);
    });
    return matches;
  }, [userBuyers, properties]);

  const filteredBuyers = useMemo(() => {
    const filtered = userBuyers.filter((buyer) => {
      const matchesSearch =
        searchTerm === "" ||
        `${buyer.first_name} ${buyer.last_name}`
          .toLowerCase()
          .includes(searchTerm.toLowerCase()) ||
        buyer.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        buyer.phone?.includes(searchTerm);

      const matchesStatus =
        statusFilter === "all" || buyer.status === statusFilter;

      const matchesTimeline =
        timelineFilter === "all" || buyer.timeline === timelineFilter;

      const matchesPreApproved =
        !preApprovedFilter || buyer.pre_approved === true;

      const matchesHasPropertyToSell =
        !hasPropertyToSellFilter || buyer.current_housing_status === "owns_selling" || buyer.selling_property_address || buyer.linked_property_id;

      const matchesMustSellFirst =
        !mustSellFirstFilter || buyer.must_sell_first === true;

      return matchesSearch && matchesStatus && matchesTimeline && matchesPreApproved && matchesHasPropertyToSell && matchesMustSellFirst;
    });

    // Sort the filtered buyers
    return filtered.sort((a, b) => {
      let aValue, bValue;

      switch (sortField) {
        case "name":
          aValue = `${a.first_name || ""} ${a.last_name || ""}`.toLowerCase();
          bValue = `${b.first_name || ""} ${b.last_name || ""}`.toLowerCase();
          break;
        case "status":
          aValue = a.status || "";
          bValue = b.status || "";
          break;
        case "email":
          aValue = (a.email || "").toLowerCase();
          bValue = (b.email || "").toLowerCase();
          break;
        case "phone":
          aValue = a.phone || "";
          bValue = b.phone || "";
          break;
        case "budget":
          aValue = a.budget_max || 0;
          bValue = b.budget_max || 0;
          break;
        case "timeline":
          aValue = a.timeline || "";
          bValue = b.timeline || "";
          break;
        case "created_date":
        default:
          aValue = new Date(a.created_date).getTime();
          bValue = new Date(b.created_date).getTime();
          break;
      }

      if (typeof aValue === "string") {
        const comparison = aValue.localeCompare(bValue);
        return sortDirection === "asc" ? comparison : -comparison;
      } else {
        return sortDirection === "asc" ? aValue - bValue : bValue - aValue;
      }
    });
  }, [userBuyers, searchTerm, statusFilter, timelineFilter, preApprovedFilter, hasPropertyToSellFilter, mustSellFirstFilter, sortField, sortDirection]);

  const stats = useMemo(() => {
    return {
      total: userBuyers.length,
      active: userBuyers.filter((b) => b.status === "active").length,
      underContract: userBuyers.filter((b) => b.status === "under_contract").length,
      preApproved: userBuyers.filter((b) => b.pre_approved).length,
      totalBudget: userBuyers.reduce((sum, b) => sum + (b.budget_max || 0), 0),
      hasPropertyToSell: userBuyers.filter((b) => b.current_housing_status === "owns_selling" || b.selling_property_address || b.linked_property_id).length,
      mustSellFirst: userBuyers.filter((b) => b.must_sell_first).length,
    };
  }, [userBuyers]);

  const buyerMutation = useMutation({
    mutationFn: (buyerData) => {
      if (editingBuyer) {
        return base44.entities.Buyer.update(editingBuyer.id, buyerData);
      } else {
        return base44.entities.Buyer.create({
          ...buyerData,
          assigned_agent_id: buyerData.assigned_agent_id || user?.id
        });
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["buyers"] });
      toast.success(
        `Buyer ${editingBuyer ? "updated" : "created"} successfully!`
      );
      setIsModalOpen(false);
      setEditingBuyer(null);
    },
    onError: (error) => {
      toast.error(`Error: ${error.message}`);
    },
  });

  const convertToSellerMutation = useMutation({
    mutationFn: async (buyer) => {
      // Create a new property listing from the buyer's selling property
      const propertyData = {
        address: buyer.selling_property_address || `${buyer.first_name} ${buyer.last_name}'s Property`,
        price: 0, // Price to be determined - required field
        status: "active",
        listing_agent_id: buyer.assigned_agent_id || user?.id,
        sellers_info: JSON.stringify([{
          name: `${buyer.first_name} ${buyer.last_name}`,
          email: buyer.email,
          phone: buyer.phone
        }]),
        seller_needs_to_buy: true,
        linked_buyer_id: buyer.id
      };

      const newProperty = await base44.entities.Property.create(propertyData);

      // Update the buyer to link to the new property
      await base44.entities.Buyer.update(buyer.id, {
        linked_property_id: newProperty.id,
        must_sell_first: true
      });

      return newProperty;
    },
    onSuccess: (newProperty, buyer) => {
      queryClient.invalidateQueries({ queryKey: ["buyers"] });
      queryClient.invalidateQueries({ queryKey: ["properties"] });
      toast.success(`Created property listing for ${buyer.first_name} ${buyer.last_name}!`);
      navigate(createPageUrl(`PropertyDetail?id=${newProperty.id}`));
    },
    onError: (error) => {
      toast.error(`Error converting to seller: ${error.message}`);
    },
  });

  const handleEdit = (buyer) => {
    setEditingBuyer(buyer);
    setIsModalOpen(true);
  };

  const handleViewDetail = (buyer) => {
    navigate(createPageUrl(`BuyerDetail?id=${buyer.id}`));
  };

  const handleViewMatchingProperties = (buyer, matchingProps) => {
    if (!matchingProps || matchingProps.length === 0) return;
    
    // Navigate to properties page with buyer filter and property IDs
    const propertyIds = matchingProps.map(p => p.id).join(',');
    const params = new URLSearchParams();
    params.set('matchedPropertyIds', propertyIds);
    params.set('buyerId', buyer.id);
    params.set('buyerName', `${buyer.first_name} ${buyer.last_name}`);
    
    toast.success(`Found ${matchingProps.length} matching properties for ${buyer.first_name}`);
    navigate(createPageUrl(`Properties?${params.toString()}`));
  };

  const handleRefreshMatches = async () => {
    setIsRefreshingMatches(true);
    try {
      await queryClient.invalidateQueries({ queryKey: ["properties"] });
      toast.success("Property matches refreshed!");
    } catch (error) {
      toast.error("Failed to refresh matches");
    } finally {
      setIsRefreshingMatches(false);
    }
  };

  const handleOpenCampaignModal = (buyer) => {
    if (!buyer.email) {
      toast.error("This buyer doesn't have an email address");
      return;
    }
    setCampaignModalBuyer(buyer);
  };

  const handleSearchProperties = (buyer) => {
    // Use calculated max affordable price from monthly budget
    const maxAffordable = buyer.calculated_max_price || buyer.budget_max;
    
    if (!maxAffordable) {
      toast.error("Please set a monthly payment budget for this buyer first to calculate their max affordable price.");
      return;
    }
    
    // Calculate ¬±10% range around max affordable price
    const minPrice = Math.round(maxAffordable * 0.9); // 10% below
    const maxPrice = Math.round(maxAffordable * 1.1); // 10% above
    
    const params = new URLSearchParams();
    params.set('minPrice', minPrice.toString());
    params.set('maxPrice', maxPrice.toString());
    
    if (buyer.min_bedrooms) {
      params.set('minBedrooms', buyer.min_bedrooms.toString());
    }
    
    if (buyer.min_bathrooms) {
      params.set('minBathrooms', buyer.min_bathrooms.toString());
    }
    
    if (buyer.property_type_preference && buyer.property_type_preference !== 'any') {
      params.set('propertyType', buyer.property_type_preference);
    }
    
    if (buyer.preferred_locations) {
      params.set('location', buyer.preferred_locations);
    }
    
    if (buyer.min_square_feet) {
      params.set('minSquareFeet', buyer.min_square_feet.toString());
    }
    
    params.set('buyerId', buyer.id);
    params.set('buyerName', `${buyer.first_name} ${buyer.last_name}`);
    
    // Show user the search range
    toast.success(`Searching properties between $${minPrice.toLocaleString()} - $${maxPrice.toLocaleString()} (¬±10% of max affordable)`);
    
    navigate(createPageUrl(`Properties?${params.toString()}`));
  };

  const getStatusColor = (status) => {
    const colors = {
      active: "bg-green-100 text-green-700 border-green-200",
      under_contract: "bg-amber-100 text-amber-700 border-amber-200",
      closed: "bg-blue-100 text-blue-700 border-blue-200",
      inactive: "bg-slate-100 text-slate-700 border-slate-200"
    };
    return colors[status] || "bg-slate-100 text-slate-700 border-slate-200";
  };

  const getTimelineColor = (timeline) => {
    const colors = {
      immediate: "bg-red-100 text-red-700 border-red-200",
      "1_3_months": "bg-orange-100 text-orange-700 border-orange-200",
      "3_6_months": "bg-yellow-100 text-yellow-700 border-yellow-200",
      "6_12_months": "bg-blue-100 text-blue-700 border-blue-200",
      over_year: "bg-slate-100 text-slate-700 border-slate-200"
    };
    return colors[timeline] || "bg-slate-100 text-slate-700 border-slate-200";
  };

  if (buyersError) {
    return (
      <div className="page-container">
        <Card className="border-red-200 bg-red-50">
          <CardContent className="p-6">
            <div className="text-center">
              <p className="text-red-600 font-semibold mb-2">Error Loading Buyers</p>
              <p className="text-sm text-red-500 mb-4">
                {buyersError.message || "Unable to load buyers data. Please try again."}
              </p>
              <Button
                onClick={() => queryClient.invalidateQueries({ queryKey: ["buyers"] })}
                variant="outline"
              >
                Retry
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (isLoadingBuyers) {
    return <LoadingSpinner icon={UserCheck} title="Loading Buyers..." description="Loading your buyer profiles" />;
  }

  return (
    <div className="page-container space-y-6">
      {/* Header */}
      <Card className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-xl">
        <CardContent className="p-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Button 
                variant="ghost" 
                size="sm" 
                onClick={() => navigate(-1)}
                className="text-white hover:bg-white/20 -ml-2"
              >
                <ArrowLeft className="w-5 h-5" />
              </Button>
              <div className="w-12 h-12 rounded-lg bg-white/20 flex items-center justify-center">
                <UserCheck className="w-7 h-7" />
              </div>
              <div>
                <h1 className="text-2xl font-bold mb-1">Buyers</h1>
                <p className="text-white/90 text-sm">
                  {filteredBuyers.length} buyers
                </p>
              </div>
            </div>
            <div className="flex gap-2">
              <Button
                onClick={handleRefreshMatches}
                disabled={isRefreshingMatches}
                variant="outline"
                className="border-white/30 bg-white/10 text-white hover:bg-white/20"
              >
                <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshingMatches ? 'animate-spin' : ''}`} />
                Refresh Matches
              </Button>
              <Button
                onClick={() => {
                  setEditingBuyer(null);
                  setIsModalOpen(true);
                }}
                className="bg-white text-indigo-600 hover:bg-slate-100"
              >
                <Plus className="w-4 h-4 mr-2" />
                Add Buyer
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-7 gap-4">
        <Card 
          className={`bg-gradient-to-br from-slate-600 to-slate-800 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl ${statusFilter === 'all' && !preApprovedFilter && !hasPropertyToSellFilter && !mustSellFirstFilter ? 'ring-2 ring-white ring-offset-2' : ''}`}
          onClick={() => {
            setStatusFilter('all');
            setPreApprovedFilter(false);
            setHasPropertyToSellFilter(false);
            setMustSellFirstFilter(false);
          }}
        >
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-white/80">Total Buyers</p>
                <p className="text-2xl font-bold">{stats.total}</p>
              </div>
              <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                <User className="w-5 h-5" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card 
          className={`bg-gradient-to-br from-green-500 to-emerald-600 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl ${statusFilter === 'active' && !preApprovedFilter && !hasPropertyToSellFilter && !mustSellFirstFilter ? 'ring-2 ring-white ring-offset-2' : ''}`}
          onClick={() => {
            setStatusFilter('active');
            setPreApprovedFilter(false);
            setHasPropertyToSellFilter(false);
            setMustSellFirstFilter(false);
          }}
        >
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-white/80">Active</p>
                <p className="text-2xl font-bold">{stats.active}</p>
              </div>
              <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                <TrendingUp className="w-5 h-5" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card 
          className={`bg-gradient-to-br from-blue-500 to-cyan-600 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl ${statusFilter === 'under_contract' && !preApprovedFilter && !hasPropertyToSellFilter && !mustSellFirstFilter ? 'ring-2 ring-white ring-offset-2' : ''}`}
          onClick={() => {
            setStatusFilter('under_contract');
            setPreApprovedFilter(false);
            setHasPropertyToSellFilter(false);
            setMustSellFirstFilter(false);
          }}
        >
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-white/80">Under Contract</p>
                <p className="text-2xl font-bold">{stats.underContract}</p>
              </div>
              <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                <Home className="w-5 h-5" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card 
          className={`bg-gradient-to-br from-purple-500 to-violet-600 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl ${preApprovedFilter ? 'ring-2 ring-white ring-offset-2' : ''}`}
          onClick={() => {
            setPreApprovedFilter(!preApprovedFilter);
            if (!preApprovedFilter) {
              setStatusFilter('all');
              setHasPropertyToSellFilter(false);
              setMustSellFirstFilter(false);
            }
          }}
        >
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-white/80">Pre-Approved</p>
                <p className="text-2xl font-bold">{stats.preApproved}</p>
              </div>
              <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                <Heart className="w-5 h-5" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-br from-amber-500 to-orange-600 text-white border-0 shadow-lg">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-white/80">Total Budget</p>
                <p className="text-2xl font-bold">
                  ${(stats.totalBudget / 1000000).toFixed(1)}M
                </p>
              </div>
              <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                <DollarSign className="w-5 h-5" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card 
          className={`bg-gradient-to-br from-rose-500 to-pink-600 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl ${hasPropertyToSellFilter ? 'ring-2 ring-white ring-offset-2' : ''}`}
          onClick={() => {
            setHasPropertyToSellFilter(!hasPropertyToSellFilter);
            if (!hasPropertyToSellFilter) {
              setStatusFilter('all');
              setPreApprovedFilter(false);
              setMustSellFirstFilter(false);
            }
          }}
        >
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-white/80">üî• Property to Sell</p>
                <p className="text-2xl font-bold">{stats.hasPropertyToSell}</p>
              </div>
              <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                <Home className="w-5 h-5" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card 
          className={`bg-gradient-to-br from-red-600 to-red-800 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl ${mustSellFirstFilter ? 'ring-2 ring-white ring-offset-2' : ''}`}
          onClick={() => {
            setMustSellFirstFilter(!mustSellFirstFilter);
            if (!mustSellFirstFilter) {
              setStatusFilter('all');
              setPreApprovedFilter(false);
              setHasPropertyToSellFilter(false);
            }
          }}
        >
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-white/80">Must Sell First</p>
                <p className="text-2xl font-bold">{stats.mustSellFirst}</p>
              </div>
              <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                <AlertTriangle className="w-5 h-5" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Filters */}
      <Card>
        <CardContent className="p-4 flex flex-wrap items-center gap-4">
          <div className="relative flex-grow">
            <Search className="w-4 h-4 absolute left-3 top-3 text-slate-400" />
            <Input
              placeholder="Search buyers..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-9"
            />
          </div>
          <div className="flex items-center gap-2">
            <Filter className="w-5 h-5 text-slate-500" />
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder="Status" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Statuses</SelectItem>
                <SelectItem value="active">Active</SelectItem>
                <SelectItem value="under_contract">Under Contract</SelectItem>
                <SelectItem value="closed">Closed</SelectItem>
                <SelectItem value="inactive">Inactive</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <Select value={timelineFilter} onValueChange={setTimelineFilter}>
            <SelectTrigger className="w-[180px]">
              <SelectValue placeholder="Timeline" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Timelines</SelectItem>
              <SelectItem value="immediate">Immediate</SelectItem>
              <SelectItem value="1_3_months">1-3 Months</SelectItem>
              <SelectItem value="3_6_months">3-6 Months</SelectItem>
              <SelectItem value="6_12_months">6-12 Months</SelectItem>
              <SelectItem value="over_year">Over a Year</SelectItem>
            </SelectContent>
          </Select>
          {/* View Toggle */}
          <div className="flex items-center gap-1 border rounded-lg p-1">
            <Button
              variant={viewMode === "list" ? "default" : "ghost"}
              size="sm"
              onClick={() => setViewMode("list")}
              className="h-8 px-3"
            >
              <List className="w-4 h-4" />
            </Button>
            <Button
              variant={viewMode === "card" ? "default" : "ghost"}
              size="sm"
              onClick={() => setViewMode("card")}
              className="h-8 px-3"
            >
              <Grid3x3 className="w-4 h-4" />
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Buyers List/Card View */}
      {viewMode === "list" ? (
        <div className="space-y-2">
          {/* List Header with Sortable Columns */}
          <div className="flex items-center gap-3 px-3 py-2 text-xs font-semibold text-slate-500 uppercase bg-slate-100 dark:bg-slate-800 rounded-lg">
            <SortableHeader field="name" label="Name" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-40 flex-shrink-0" />
            <SortableHeader field="status" label="Status" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-24 flex-shrink-0 text-center" />
            <div className="w-40 flex-shrink-0">Email</div>
            <div className="w-28 flex-shrink-0">Phone</div>
            <SortableHeader field="budget" label="Budget" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-24 flex-shrink-0" />
            <SortableHeader field="timeline" label="Timeline" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-24 flex-shrink-0" />
            <div className="w-20 flex-shrink-0 text-center">
              <span className="flex items-center gap-1 justify-center">
                <Sparkles className="w-3 h-3" /> Matches
              </span>
            </div>
            <SortableHeader field="created_date" label="Date" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-20 flex-shrink-0" />
            <div className="ml-auto flex-shrink-0">Actions</div>
          </div>
          {/* List Rows */}
          {filteredBuyers.map((buyer) => {
            const matchingProps = buyerMatchingProperties[buyer.id] || [];
            const matchCount = matchingProps.length;
            
            return (
              <Card 
                key={buyer.id} 
                className="hover:shadow-md transition-shadow cursor-pointer"
                onClick={() => handleViewDetail(buyer)}
              >
                <CardContent className="p-3">
                  <div className="flex items-center gap-3">
                    {/* Name */}
                    <div className="w-44 flex-shrink-0 flex items-center gap-2">
                      <div className="w-8 h-8 rounded-full flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold text-xs">
                        {buyer.first_name?.charAt(0)}{buyer.last_name?.charAt(0)}
                      </div>
                      <div className="flex flex-col">
                        <span className="font-semibold text-sm text-slate-900 dark:text-slate-100 truncate">
                          {buyer.first_name} {buyer.last_name}
                        </span>
                        {(buyer.current_housing_status === "owns_selling" || buyer.selling_property_address || buyer.linked_property_id || buyer.must_sell_first) && (
                          <span className="text-[10px] text-amber-600 font-semibold flex items-center gap-1" title={buyer.selling_property_address || "Has property to sell"}>
                            <Home className="w-3 h-3" /> üî• Has property to sell
                            {buyer.must_sell_first && <span className="text-red-600 ml-1">‚Ä¢ Must sell first</span>}
                          </span>
                        )}
                      </div>
                    </div>
                    {/* Status */}
                    <div className="w-24 flex-shrink-0 text-center">
                      <Badge className={`${getStatusColor(buyer.status)} text-xs capitalize`}>
                        {buyer.status?.replace("_", " ")}
                      </Badge>
                    </div>
                    {/* Email */}
                    <div className="w-40 flex-shrink-0 text-sm text-slate-600 dark:text-slate-400 truncate">
                      {buyer.email || "-"}
                    </div>
                    {/* Phone */}
                    <div className="w-28 flex-shrink-0 text-sm text-slate-600 dark:text-slate-400">
                      {buyer.phone || "-"}
                    </div>
                    {/* Budget */}
                    <div className="w-24 flex-shrink-0 text-sm font-medium text-indigo-600">
                      {buyer.calculated_max_price 
                        ? `$${(buyer.calculated_max_price / 1000).toFixed(0)}K` 
                        : buyer.budget_max 
                          ? `$${(buyer.budget_max / 1000).toFixed(0)}K` 
                          : "-"}
                    </div>
                    {/* Timeline */}
                    <div className="w-24 flex-shrink-0">
                      {buyer.timeline ? (
                        <Badge className={`text-xs capitalize ${getTimelineColor(buyer.timeline)}`}>
                          {buyer.timeline.replace(/_/g, "-").replace("over-year", "over a year")}
                        </Badge>
                      ) : (
                        <span className="text-sm text-slate-400">-</span>
                      )}
                    </div>
                    {/* AI Matches / Selling / Converted */}
                    <div className="w-28 flex-shrink-0 text-center flex flex-col gap-1 items-center">
                      {buyer.linked_property_id && (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            navigate(createPageUrl(`PropertyDetail?id=${buyer.linked_property_id}`));
                          }}
                          className="h-6 px-2 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white text-[10px] font-semibold rounded-full"
                          title="View their property listing - Converted to Seller"
                        >
                          <CheckCircle className="w-3 h-3 mr-1" />
                          Seller
                        </Button>
                      )}
                      {matchCount > 0 ? (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleViewMatchingProperties(buyer, matchingProps);
                          }}
                          className="h-6 px-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-[10px] font-semibold rounded-full"
                        >
                          <Sparkles className="w-3 h-3 mr-1" />
                          {matchCount} Matches
                        </Button>
                      ) : !buyer.linked_property_id ? (
                        <span className="text-xs text-slate-400">-</span>
                      ) : null}
                    </div>
                    {/* Date */}
                    <div className="w-20 flex-shrink-0 text-xs text-slate-500">
                      {buyer.created_date ? format(new Date(buyer.created_date), "MMM d") : "-"}
                    </div>
                    {/* Actions */}
                    <div className="ml-auto flex items-center gap-1 flex-shrink-0">
                      <Button 
                        variant="ghost" 
                        size="sm" 
                        onClick={(e) => {
                          e.stopPropagation();
                          handleOpenCampaignModal(buyer);
                        }} 
                        className="h-8 w-8 p-0" 
                        title="Send Email Campaign"
                      >
                        <Mail className={`w-4 h-4 ${buyer.must_sell_first || buyer.selling_property_address ? 'text-amber-600' : 'text-indigo-600'}`} />
                      </Button>
                      <Button 
                        variant="ghost" 
                        size="sm" 
                        onClick={(e) => {
                          e.stopPropagation();
                          handleSearchProperties(buyer);
                        }} 
                        className="h-8 w-8 p-0" 
                        title="Search Properties"
                      >
                        <Search className="w-4 h-4 text-indigo-600" />
                      </Button>

                      <Button 
                        variant="ghost" 
                        size="sm" 
                        onClick={(e) => {
                          e.stopPropagation();
                          handleEdit(buyer);
                        }} 
                        className="h-8 w-8 p-0" 
                        title="Edit"
                      >
                        <Edit className="w-4 h-4 text-slate-600" />
                      </Button>
                      <Button 
                        variant="ghost" 
                        size="sm" 
                        onClick={(e) => {
                          e.stopPropagation();
                          handleViewDetail(buyer);
                        }} 
                        className="h-8 w-8 p-0" 
                        title="View Details"
                      >
                        <Eye className="w-4 h-4 text-slate-600" />
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>
      ) : (
        /* Card View */
        <div className="grid grid-cols-1 gap-4">
          {filteredBuyers.map((buyer) => {
            const assignedAgent = users.find((u) => u.id === buyer.assigned_agent_id);
            
            return (
              <Card 
                key={buyer.id} 
                className="hover:shadow-lg transition-shadow cursor-pointer"
                onClick={() => handleViewDetail(buyer)}
              >
                <CardContent className="p-6">
                  <div className="flex flex-col gap-4">
                    {/* Header Row */}
                    <div className="flex items-start justify-between">
                      <div className="flex items-center gap-4">
                        <div className="w-16 h-16 rounded-full flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold text-xl">
                          {buyer.first_name?.charAt(0)}{buyer.last_name?.charAt(0)}
                        </div>
                        <div>
                          <h3 className="text-xl font-bold text-slate-900">
                            {buyer.first_name} {buyer.last_name}
                          </h3>
                          <div className="flex items-center gap-2 mt-1">
                            <Badge className={`${getStatusColor(buyer.status)} text-xs capitalize`}>
                              {buyer.status?.replace("_", " ")}
                            </Badge>
                            {buyer.pre_approved && (
                              <Badge className="bg-green-100 text-green-700 text-xs">
                                Pre-Approved
                              </Badge>
                            )}
                            {buyer.timeline && (
                              <Badge variant="outline" className="text-xs">
                                {buyer.timeline.replace("_", " ")}
                              </Badge>
                            )}
                          </div>
                        </div>
                      </div>
                      
                      <div className="flex items-center gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleOpenCampaignModal(buyer);
                          }}
                          className="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border-indigo-200"
                        >
                          <Mail className="w-4 h-4 mr-2" />
                          Email Campaign
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleSearchProperties(buyer);
                          }}
                          className="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border-indigo-200"
                        >
                          <Search className="w-4 h-4 mr-2" />
                          Search Properties
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleEdit(buyer);
                          }}
                        >
                          <Edit className="w-4 h-4 mr-2" />
                          Edit
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleViewDetail(buyer);
                          }}
                        >
                          <Eye className="w-4 h-4 mr-2" />
                          Details
                        </Button>
                      </div>
                    </div>

                    {/* Contact Information */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg">
                      <div className="flex items-center gap-2 text-sm">
                        <Mail className="w-4 h-4 text-slate-400" />
                        <span className="text-slate-600">{buyer.email}</span>
                      </div>
                      {buyer.phone && (
                        <div className="flex items-center gap-2 text-sm">
                          <Phone className="w-4 h-4 text-slate-400" />
                          <span className="text-slate-600">{buyer.phone}</span>
                        </div>
                      )}
                      {buyer.preferred_locations && (
                        <div className="flex items-center gap-2 text-sm">
                          <MapPin className="w-4 h-4 text-slate-400" />
                          <span className="text-slate-600">{buyer.preferred_locations}</span>
                        </div>
                      )}
                      {assignedAgent && (
                        <div className="flex items-center gap-2 text-sm">
                          <User className="w-4 h-4 text-slate-400" />
                          <span className="text-slate-600">Agent: {assignedAgent.full_name || assignedAgent.email}</span>
                        </div>
                      )}
                    </div>

                    {/* Financial Information */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      {/* Monthly Payment Budget */}
                      {buyer.monthly_payment_budget && (
                        <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                          <div className="flex items-center gap-2 mb-2">
                            <DollarSign className="w-4 h-4 text-green-600" />
                            <span className="text-xs font-semibold text-green-900">Monthly Budget</span>
                          </div>
                          <p className="text-2xl font-bold text-green-600">
                            ${buyer.monthly_payment_budget.toLocaleString()}/mo
                          </p>
                        </div>
                      )}

                      {/* Maximum Affordable Price */}
                      {buyer.calculated_max_price && (
                        <div className="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                          <div className="flex items-center gap-2 mb-2">
                            <Home className="w-4 h-4 text-indigo-600" />
                            <span className="text-xs font-semibold text-indigo-900">Max Affordable</span>
                          </div>
                          <p className="text-2xl font-bold text-indigo-600">
                            ${(buyer.calculated_max_price / 1000).toFixed(0)}K
                          </p>
                        </div>
                      )}

                      {/* Budget Range */}
                      {(buyer.budget_min || buyer.budget_max) && (
                        <div className="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                          <div className="flex items-center gap-2 mb-2">
                            <TrendingUp className="w-4 h-4 text-purple-600" />
                            <span className="text-xs font-semibold text-purple-900">Price Range</span>
                          </div>
                          <p className="text-lg font-bold text-purple-600">
                            {buyer.budget_min ? `$${(buyer.budget_min / 1000).toFixed(0)}K` : "$0"} - ${buyer.budget_max ? `${(buyer.budget_max / 1000).toFixed(0)}K` : "Any"}
                          </p>
                        </div>
                      )}
                    </div>

                    {/* Mortgage Details */}
                    {buyer.monthly_payment_budget && (
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div>
                          <div className="flex items-center gap-1 mb-1">
                            <Percent className="w-3 h-3 text-blue-600" />
                            <span className="text-xs font-medium text-blue-900">Down Payment</span>
                          </div>
                          <p className="text-sm font-semibold text-blue-700">
                            {buyer.down_payment_percentage || 20}%
                          </p>
                        </div>
                        
                        <div>
                          <div className="flex items-center gap-1 mb-1">
                            <Percent className="w-3 h-3 text-blue-600" />
                            <span className="text-xs font-medium text-blue-900">Interest Rate</span>
                          </div>
                          <p className="text-sm font-semibold text-blue-700">
                            {buyer.current_interest_rate || 6.5}%
                          </p>
                        </div>
                        
                        <div>
                          <div className="flex items-center gap-1 mb-1">
                            <Calendar className="w-3 h-3 text-blue-600" />
                            <span className="text-xs font-medium text-blue-900">Loan Term</span>
                          </div>
                          <p className="text-sm font-semibold text-blue-700">
                            {buyer.loan_term_years || 30} years
                          </p>
                        </div>
                        
                        <div>
                          <div className="flex items-center gap-1 mb-1">
                            <Building2 className="w-3 h-3 text-blue-600" />
                            <span className="text-xs font-medium text-blue-900">Property Tax</span>
                          </div>
                          <p className="text-sm font-semibold text-blue-700">
                            {buyer.estimated_property_tax_rate || 1.2}%
                          </p>
                        </div>
                        
                        <div>
                          <div className="flex items-center gap-1 mb-1">
                            <CreditCard className="w-3 h-3 text-blue-600" />
                            <span className="text-xs font-medium text-blue-900">Insurance</span>
                          </div>
                          <p className="text-sm font-semibold text-blue-700">
                            ${buyer.estimated_insurance_monthly || 150}/mo
                          </p>
                        </div>
                        
                        {buyer.estimated_hoa_monthly > 0 && (
                          <div>
                            <div className="flex items-center gap-1 mb-1">
                              <Building2 className="w-3 h-3 text-blue-600" />
                              <span className="text-xs font-medium text-blue-900">HOA/Membership</span>
                            </div>
                            <p className="text-sm font-semibold text-blue-700">
                              ${buyer.estimated_hoa_monthly}/mo
                            </p>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Property Preferences */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                      {buyer.property_type_preference && buyer.property_type_preference !== 'any' && (
                        <div>
                          <span className="text-xs font-medium text-amber-900">Type</span>
                          <p className="text-sm font-semibold text-amber-700 capitalize">
                            {buyer.property_type_preference.replace('_', ' ')}
                          </p>
                        </div>
                      )}
                      
                      {buyer.min_bedrooms && (
                        <div>
                          <span className="text-xs font-medium text-amber-900">Min Bedrooms</span>
                          <p className="text-sm font-semibold text-amber-700">
                            {buyer.min_bedrooms}
                          </p>
                        </div>
                      )}
                      
                      {buyer.min_bathrooms && (
                        <div>
                          <span className="text-xs font-medium text-amber-900">Min Bathrooms</span>
                          <p className="text-sm font-semibold text-amber-700">
                            {buyer.min_bathrooms}
                          </p>
                        </div>
                      )}
                      
                      {buyer.min_square_feet && (
                        <div>
                          <span className="text-xs font-medium text-amber-900">Min Sq Ft</span>
                          <p className="text-sm font-semibold text-amber-700">
                            {buyer.min_square_feet.toLocaleString()}
                          </p>
                        </div>
                      )}
                    </div>

                    {/* Features */}
                    {(buyer.must_have_features || buyer.nice_to_have_features) && (
                      <div className="p-4 bg-slate-50 rounded-lg">
                        {buyer.must_have_features && (
                          <div className="mb-2">
                            <span className="text-xs font-semibold text-slate-700">Must-Have Features:</span>
                            <p className="text-sm text-slate-600 mt-1">{buyer.must_have_features}</p>
                          </div>
                        )}
                        {buyer.nice_to_have_features && (
                          <div>
                            <span className="text-xs font-semibold text-slate-700">Nice-to-Have:</span>
                            <p className="text-sm text-slate-600 mt-1">{buyer.nice_to_have_features}</p>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Notes */}
                    {buyer.notes && (
                      <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div className="flex items-center gap-2 mb-2">
                          <FileText className="w-4 h-4 text-yellow-600" />
                          <span className="text-xs font-semibold text-yellow-900">Notes</span>
                        </div>
                        <p className="text-sm text-yellow-800">{buyer.notes}</p>
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>
      )}

      {filteredBuyers.length === 0 && (
        <Card>
          <CardContent className="p-12">
            <div className="text-center">
              <UserCheck className="w-16 h-16 mx-auto text-slate-300 mb-4" />
              <h3 className="text-lg font-semibold text-slate-800">No Buyers Found</h3>
              <p className="text-slate-600 mt-2">
                {searchTerm || statusFilter !== "all" || timelineFilter !== "all"
                  ? 'No buyers match your current filters.'
                  : 'Start by adding your first buyer.'}
              </p>
              {(searchTerm || statusFilter !== "all" || timelineFilter !== "all") && (
                <Button
                  variant="outline"
                  className="mt-4"
                  onClick={() => {
                    setSearchTerm("");
                    setStatusFilter("all");
                    setTimelineFilter("all");
                  }}
                >
                  Clear Filters
                </Button>
              )}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Campaign Modal */}
      {campaignModalBuyer && (
        <BuyerCampaignModal
          isOpen={!!campaignModalBuyer}
          onClose={() => setCampaignModalBuyer(null)}
          buyer={campaignModalBuyer}
          onCampaignSent={() => setCampaignModalBuyer(null)}
        />
      )}

      {isModalOpen && (
        <BuyerModal
          isOpen={isModalOpen}
          onClose={() => {
            setIsModalOpen(false);
            setEditingBuyer(null);
          }}
          buyer={editingBuyer}
          onSave={buyerMutation.mutate}
          users={users}
          properties={properties}
          onConvertToSeller={async (buyer, sellingAddress, propertyIndex) => {
            try {
              const propertyData = {
                address: sellingAddress,
                price: 0,
                status: "active",
                listing_agent_id: buyer.assigned_agent_id || user?.id,
                sellers_info: JSON.stringify([{
                  name: `${buyer.first_name} ${buyer.last_name}`,
                  email: buyer.email,
                  phone: buyer.phone
                }]),
                seller_needs_to_buy: true,
                linked_buyer_id: buyer.id
              };

              const newProperty = await base44.entities.Property.create(propertyData);

              // Get existing linked property IDs
              let linkedIds = [];
              if (buyer.linked_property_ids) {
                try {
                  linkedIds = JSON.parse(buyer.linked_property_ids);
                } catch (e) {}
              }
              // Add legacy linked_property_id if exists
              if (buyer.linked_property_id && !linkedIds.includes(buyer.linked_property_id)) {
                linkedIds.push(buyer.linked_property_id);
              }
              // Add new property ID
              linkedIds.push(newProperty.id);

              // Update selling_properties with converted_property_id
              let sellingPropertiesData = [];
              if (buyer.selling_properties) {
                try {
                  sellingPropertiesData = JSON.parse(buyer.selling_properties);
                } catch (e) {}
              }
              if (sellingPropertiesData[propertyIndex]) {
                sellingPropertiesData[propertyIndex].converted_property_id = newProperty.id;
              }

              await base44.entities.Buyer.update(buyer.id, {
                linked_property_id: linkedIds[0], // Keep first one for legacy
                linked_property_ids: JSON.stringify(linkedIds),
                must_sell_first: true,
                selling_properties: JSON.stringify(sellingPropertiesData)
              });

              queryClient.invalidateQueries({ queryKey: ["buyers"] });
              queryClient.invalidateQueries({ queryKey: ["properties"] });
              toast.success(`Created property listing for ${sellingAddress}!`);

              // Return the new property ID so the modal can track it
              return newProperty.id;
            } catch (error) {
              toast.error(`Error converting to seller: ${error.message}`);
              return null;
            }
          }}
        />
      )}
    </div>
  );
}
import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Loader2, RefreshCw, CheckCircle, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';

export default function CalculateGoalProgress() {
    const [isCalculating, setIsCalculating] = useState(false);
    const [results, setResults] = useState(null);
    const [error, setError] = useState(null);
    const queryClient = useQueryClient();

    const { data: goals = [] } = useQuery({
        queryKey: ['performanceGoals'],
        queryFn: async () => {
            const data = await base44.entities.PerformanceGoal.list();
            return data || [];
        }
    });

    const { data: teamMembers = [] } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: async () => {
            const data = await base44.entities.TeamMember.list();
            return data || [];
        }
    });

    const { data: users = [] } = useQuery({
        queryKey: ['users'],
        queryFn: async () => {
            const data = await base44.entities.User.list();
            return data || [];
        }
    });

    const { data: transactions = [] } = useQuery({
        queryKey: ['transactions'],
        queryFn: async () => {
            const data = await base44.entities.Transaction.list();
            return data || [];
        }
    });

    const { data: properties = [] } = useQuery({
        queryKey: ['properties'],
        queryFn: async () => {
            const data = await base44.entities.Property.list();
            return data || [];
        }
    });

    const { data: leads = [] } = useQuery({
        queryKey: ['leads'],
        queryFn: async () => {
            const data = await base44.entities.Lead.list();
            return data || [];
        }
    });

    const { data: leadActivities = [] } = useQuery({
        queryKey: ['leadActivities'],
        queryFn: async () => {
            const data = await base44.entities.LeadActivity.list();
            return data || [];
        }
    });

    const updateGoalMutation = useMutation({
        mutationFn: ({ id, data }) => base44.entities.PerformanceGoal.update(id, data),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['performanceGoals'] });
        }
    });

    const calculateProgress = async () => {
        setIsCalculating(true);
        setResults(null);
        setError(null);

        try {
            const activeGoals = goals.filter(g => g.status !== 'completed');
            
            if (activeGoals.length === 0) {
                toast.info('No active goals to calculate');
                setIsCalculating(false);
                return;
            }

            const updates = [];
            let successCount = 0;
            let errorCount = 0;

            for (const goal of activeGoals) {
                try {
                    const member = teamMembers.find(m => m.id === goal.agent_id);
                    if (!member) {
                        console.warn(`No team member found for goal ${goal.id}`);
                        errorCount++;
                        continue;
                    }

                    const user = users.find(u => u.email === member.email);
                    const periodStart = new Date(goal.period_start);
                    const periodEnd = new Date(goal.period_end);

                    // Calculate metrics for the goal period
                    const memberTransactions = transactions.filter(t => {
                        const transactionDate = new Date(t.created_date);
                        if (transactionDate < periodStart || transactionDate > periodEnd) return false;

                        // Check if transaction is associated with this member
                        try {
                            if (t.notes) {
                                const notes = JSON.parse(t.notes);
                                if (notes.listing_team_member_id === member.id || 
                                    notes.selling_team_member_id === member.id) {
                                    return true;
                                }
                            }
                        } catch (e) {
                            // Invalid JSON in notes, skip
                        }

                        if (user) {
                            if (t.listing_agent_id === user.id || t.selling_agent_id === user.id) {
                                return true;
                            }
                        }

                        // Check by name
                        if (t.selling_agent_name === member.full_name) return true;

                        return false;
                    });

                    // Calculate revenue
                    let revenue = 0;
                    memberTransactions.forEach(t => {
                        try {
                            if (t.notes) {
                                const notes = JSON.parse(t.notes);
                                if (notes.listing_team_member_id === member.id) {
                                    revenue += (t.listing_net_commission || 0);
                                }
                                if (notes.selling_team_member_id === member.id) {
                                    revenue += (t.selling_net_commission || 0);
                                }
                            }
                        } catch (e) {
                            // Invalid JSON
                        }

                        if (user) {
                            if (t.listing_agent_id === user.id) revenue += (t.listing_net_commission || 0);
                            if (t.selling_agent_id === user.id) revenue += (t.selling_net_commission || 0);
                        }
                    });

                    // Calculate other metrics
                    const deals = memberTransactions.length;

                    const memberProperties = properties.filter(p => {
                        const propDate = new Date(p.created_date);
                        if (propDate < periodStart || propDate > periodEnd) return false;
                        
                        if (user && p.listing_agent_id === user.id) return true;
                        if (p.tags && p.tags.includes(`listing_agent:${member.id}`)) return true;
                        
                        return false;
                    });

                    const memberLeads = leads.filter(l => {
                        const leadDate = new Date(l.created_date);
                        if (leadDate < periodStart || leadDate > periodEnd) return false;
                        
                        if (user) {
                            if (l.assigned_agent_id === user.id || l.owner_id === user.id) return true;
                        }
                        
                        if (l.notes && l.notes.includes(member.id)) return true;
                        
                        return false;
                    });

                    const memberActivities = leadActivities.filter(a => {
                        const actDate = new Date(a.created_date);
                        if (actDate < periodStart || actDate > periodEnd) return false;
                        
                        if (user && a.user_id === user.id) return true;
                        if (a.description && a.description.includes(member.full_name)) return true;
                        
                        return false;
                    });

                    // Determine status based on progress
                    let status = 'on_track';
                    const now = new Date();
                    
                    if (now > periodEnd) {
                        status = 'completed';
                    } else {
                        const totalDays = (periodEnd - periodStart) / (1000 * 60 * 60 * 24);
                        const daysPassed = (now - periodStart) / (1000 * 60 * 60 * 24);
                        const expectedProgress = Math.max(0, Math.min(1, daysPassed / totalDays));

                        // Check revenue progress
                        if (goal.revenue_goal > 0) {
                            const revenueProgress = revenue / goal.revenue_goal;
                            if (revenueProgress >= 1) {
                                status = 'exceeded';
                            } else if (revenueProgress < expectedProgress - 0.2) {
                                status = 'behind';
                            } else if (revenueProgress < expectedProgress - 0.1) {
                                status = 'at_risk';
                            }
                        }
                    }

                    // Generate AI insights if behind or at risk
                    let aiInsights = null;
                    if (status === 'behind' || status === 'at_risk') {
                        try {
                            const recommendation = await generateAIRecommendation(goal, {
                                revenue,
                                deals,
                                activities: memberActivities.length,
                                expectedProgress: (now - periodStart) / (periodEnd - periodStart)
                            });
                            aiInsights = JSON.stringify({ 
                                recommendation, 
                                generated: new Date().toISOString() 
                            });
                        } catch (e) {
                            console.warn('Failed to generate AI insights:', e);
                        }
                    }

                    // Update goal
                    const updateData = {
                        current_revenue: revenue,
                        current_deals: deals,
                        current_listings: memberProperties.filter(p => p.status === 'active').length,
                        current_buyer_deals: memberTransactions.filter(t => user && t.selling_agent_id === user.id).length,
                        current_activities: memberActivities.length,
                        current_leads: memberLeads.length,
                        status,
                        last_calculated: new Date().toISOString(),
                        ai_insights: aiInsights
                    };

                    await updateGoalMutation.mutateAsync({ id: goal.id, data: updateData });
                    updates.push({ 
                        agent: member.full_name, 
                        status,
                        revenue,
                        deals
                    });
                    successCount++;

                } catch (err) {
                    console.error(`Error calculating goal ${goal.id}:`, err);
                    errorCount++;
                }
            }

            setResults({ updates, successCount, errorCount });
            
            if (successCount > 0) {
                toast.success(`Updated ${successCount} goals successfully`);
            }
            if (errorCount > 0) {
                toast.warning(`${errorCount} goals could not be updated`);
            }

        } catch (error) {
            console.error('Error calculating progress:', error);
            setError(error.message);
            toast.error(`Failed to calculate progress: ${error.message}`);
        } finally {
            setIsCalculating(false);
        }
    };

    const generateAIRecommendation = async (goal, current) => {
        try {
            const prompt = `As a sales performance coach, provide a brief (2-3 sentences) recommendation for an agent who is ${goal.status === 'behind' ? 'significantly behind' : 'slightly behind'} their goals.

Current Performance:
- Revenue: $${current.revenue.toFixed(0)} of $${goal.revenue_goal} (${((current.revenue / goal.revenue_goal) * 100).toFixed(0)}%)
- Deals: ${current.deals} of ${goal.deals_goal}
- Activities: ${current.activities} of ${goal.activities_goal}
- Expected Progress: ${(current.expectedProgress * 100).toFixed(0)}%

Provide specific, actionable advice to get back on track.`;

            const response = await base44.integrations.Core.InvokeLLM({
                prompt,
                add_context_from_internet: false
            });

            return response;
        } catch (error) {
            console.warn('AI recommendation failed:', error);
            return "Focus on increasing daily activities and follow up with warm leads to boost your numbers.";
        }
    };

    const isReady = goals.length > 0 && teamMembers.length > 0;

    return (
        <div className="page-container space-y-6">
            <div>
                <h1 className="text-3xl font-bold">Calculate Goal Progress</h1>
                <p className="text-slate-500 dark:text-slate-400 mt-1">
                    Update all performance goals with current progress and generate AI insights
                </p>
            </div>

            <Card>
                <CardHeader>
                    <CardTitle>Recalculate All Goals</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    <p className="text-sm text-slate-600 dark:text-slate-400">
                        This will calculate current progress for all active goals based on transactions, properties, leads, and activities.
                        AI insights will be generated for agents who are behind their targets.
                    </p>

                    {!isReady && (
                        <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4">
                            <div className="flex items-start gap-2">
                                <AlertCircle className="w-4 h-4 text-amber-800 dark:text-amber-200 mt-0.5" />
                                <div>
                                    <p className="text-sm text-amber-800 dark:text-amber-200">
                                        {goals.length === 0 && 'No goals found.'}
                                        {teamMembers.length === 0 && 'No team members found.'}
                                    </p>
                                    {goals.length === 0 && (
                                        <Button 
                                            variant="link" 
                                            className="h-auto p-0 mt-2 text-amber-900 dark:text-amber-100"
                                            onClick={() => window.location.href = '/GoalsManagement'}
                                        >
                                            Go to Goals Management ‚Üí
                                        </Button>
                                    )}
                                    {teamMembers.length === 0 && (
                                        <Button 
                                            variant="link" 
                                            className="h-auto p-0 mt-2 text-amber-900 dark:text-amber-100"
                                            onClick={() => window.location.href = '/TeamMembers'}
                                        >
                                            Go to Team Members ‚Üí
                                        </Button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <Button 
                        onClick={calculateProgress} 
                        disabled={isCalculating}
                        className="w-full sm:w-auto"
                    >
                        {isCalculating ? (
                            <>
                                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                Calculating...
                            </>
                        ) : (
                            <>
                                <RefreshCw className="w-4 h-4 mr-2" />
                                Calculate Progress
                            </>
                        )}
                    </Button>

                    {error && (
                        <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                            <p className="text-sm text-red-800 dark:text-red-200 flex items-center gap-2">
                                <AlertCircle className="w-4 h-4" />
                                Error: {error}
                            </p>
                        </div>
                    )}

                    {results && (
                        <div className="mt-6 space-y-4">
                            <div className="flex items-center gap-2 text-green-600 dark:text-green-400">
                                <CheckCircle className="w-5 h-5" />
                                <h3 className="font-semibold">
                                    Updated {results.successCount} Goal{results.successCount !== 1 ? 's' : ''}
                                    {results.errorCount > 0 && ` (${results.errorCount} failed)`}
                                </h3>
                            </div>
                            <div className="space-y-2">
                                {results.updates.map((result, idx) => (
                                    <div 
                                        key={idx} 
                                        className="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-3 border border-slate-200 dark:border-slate-700"
                                    >
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <p className="font-medium text-slate-900 dark:text-white">
                                                    {result.agent}
                                                </p>
                                                <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">
                                                    ${result.revenue.toLocaleString()} revenue ‚Ä¢ {result.deals} deals
                                                </p>
                                            </div>
                                            <span className={`text-xs font-semibold px-2 py-1 rounded ${
                                                result.status === 'exceeded' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' :
                                                result.status === 'on_track' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                                                result.status === 'at_risk' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300' :
                                                result.status === 'behind' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300' :
                                                'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300'
                                            }`}>
                                                {result.status.replace('_', ' ').toUpperCase()}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </CardContent>
            </Card>

            {/* Data Summary */}
            <Card>
                <CardHeader>
                    <CardTitle>Data Summary</CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4">
                            <p className="text-sm text-slate-500 dark:text-slate-400">Goals</p>
                            <p className="text-2xl font-bold">{goals.length}</p>
                        </div>
                        <div className="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4">
                            <p className="text-sm text-slate-500 dark:text-slate-400">Team Members</p>
                            <p className="text-2xl font-bold">{teamMembers.length}</p>
                        </div>
                        <div className="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4">
                            <p className="text-sm text-slate-500 dark:text-slate-400">Transactions</p>
                            <p className="text-2xl font-bold">{transactions.length}</p>
                        </div>
                        <div className="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4">
                            <p className="text-sm text-slate-500 dark:text-slate-400">Activities</p>
                            <p className="text-2xl font-bold">{leadActivities.length}</p>
                        </div>
                    </div>
                </CardContent>
            </Card>
        </div>
    );
}
import React, { useState, useEffect, useMemo, useRef } from "react";
import { useLocation } from "react-router-dom";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { DragDropContext, Droppable, Draggable } from "@hello-pangea/dnd";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent } from "@/components/ui/card";
import {
  Calendar as CalendarIcon,
  ChevronLeft,
  ChevronRight,
  Home,
  CheckSquare,
  Clock,
  MapPin,
  Eye,
  Plus,
  Menu,
  Search,
  Settings,
  Gift,
  Sparkles,
  GripVertical,
  Phone,
  Copy
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import {
  format,
  startOfMonth,
  endOfMonth,
  eachDayOfInterval,
  isSameMonth,
  isSameDay,
  isToday,
  addMonths,
  subMonths,
  parseISO,
  startOfWeek,
  endOfWeek,
  addDays,
  isWeekend,
  startOfDay
} from "date-fns";
import { toast } from "sonner";
import EnhancedEventModal from "../components/calendar/EnhancedEventModal";
import CalendarSyncModal from "../components/calendar/CalendarSyncModal";
import EventNotificationSound from "../components/calendar/EventNotificationSound";
import TeamCalendarPanel from "../components/calendar/TeamCalendarPanel";
import EventTemplateManager from "../components/calendar/EventTemplateManager";

export default function CalendarPage() {
  const navigate = useNavigate();
  const location = useLocation();
  const queryClient = useQueryClient();
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(null);
  const [viewMode, setViewMode] = useState("week");
  const [eventTypeFilter, setEventTypeFilter] = useState("all");
  const [showEventModal, setShowEventModal] = useState(false);
  const [editingEvent, setEditingEvent] = useState(null);
  const [eventType, setEventType] = useState('appointment');
  const [showSidebar, setShowSidebar] = useState(true);
  const [quickCreateMenu, setQuickCreateMenu] = useState(null); // { x, y, date, time }
  const [showSyncModal, setShowSyncModal] = useState(false);
  const [dragHoverInfo, setDragHoverInfo] = useState(null); // { date, time, x, y }
  const [searchQuery, setSearchQuery] = useState('');
  const [showSearchResults, setShowSearchResults] = useState(false);
  const [travelTimes, setTravelTimes] = useState({});
  const [currentLocation, setCurrentLocation] = useState(null);
  const timeGridRef = useRef(null);
  const searchRef = useRef(null);
  const [selectedTeamMembers, setSelectedTeamMembers] = useState(
    JSON.parse(localStorage.getItem('selectedTeamCalendars') || '[]')
  );
  const [showTemplateManager, setShowTemplateManager] = useState(false);

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me()
  });

  const { data: tasks = [] } = useQuery({ 
    queryKey: ['tasks', user?.id], 
    queryFn: () => base44.entities.Task.filter({ assigned_to: user.id }),
    enabled: !!user?.id
  });
  
  const { data: openHouses = [] } = useQuery({ 
    queryKey: ['openHouses', user?.id], 
    queryFn: () => base44.entities.OpenHouse.filter({ hosting_agent_id: user.id }),
    enabled: !!user?.id
  });
  
  const { data: showings = [] } = useQuery({ 
    queryKey: ['showings', user?.id], 
    queryFn: () => base44.entities.Showing.filter({ showing_agent_id: user.id }),
    enabled: !!user?.id
  });
  
  const { data: appointments = [] } = useQuery({ 
    queryKey: ['appointments', user?.id], 
    queryFn: () => base44.entities.Appointment.filter({ agent_id: user.id }),
    enabled: !!user?.id
  });
  
  const { data: properties = [] } = useQuery({ 
    queryKey: ['properties', user?.id], 
    queryFn: async () => {
      const [listing, created] = await Promise.all([
        base44.entities.Property.filter({ listing_agent_id: user.id }).catch(() => []),
        base44.entities.Property.filter({ created_by: user.email }).catch(() => [])
      ]);
      const combined = [...listing, ...created];
      return Array.from(new Map(combined.map(item => [item.id, item])).values());
    },
    enabled: !!user?.id
  });
  
  const { data: users = [] } = useQuery({ 
    queryKey: ['allUsers'], 
    queryFn: () => base44.entities.User.list() 
  });
  
  const { data: clients = [] } = useQuery({ 
    queryKey: ['contacts', user?.id], 
    queryFn: () => base44.entities.Contact.filter({ created_by: user.email }),
    enabled: !!user?.id
  });
  
  const { data: leads = [] } = useQuery({ 
    queryKey: ['leads', user?.id], 
    queryFn: async () => {
      const [owned, assigned, created] = await Promise.all([
        base44.entities.Lead.filter({ owner_id: user.id }).catch(() => []),
        base44.entities.Lead.filter({ assigned_agent_id: user.id }).catch(() => []),
        base44.entities.Lead.filter({ created_by: user.email }).catch(() => [])
      ]);
      const combined = [...owned, ...assigned, ...created];
      return Array.from(new Map(combined.map(item => [item.id, item])).values());
    },
    enabled: !!user?.id
  });
  
  const { data: buyers = [] } = useQuery({ 
    queryKey: ['buyers', user?.id], 
    queryFn: async () => {
      const [assigned, created] = await Promise.all([
        base44.entities.Buyer.filter({ assigned_agent_id: user.id }).catch(() => []),
        base44.entities.Buyer.filter({ created_by: user.email }).catch(() => [])
      ]);
      const combined = [...assigned, ...created];
      return Array.from(new Map(combined.map(item => [item.id, item])).values());
    },
    enabled: !!user?.id
  });

  // Fetch team members' events
  const { data: teamTasks = [] } = useQuery({
    queryKey: ['teamTasks', selectedTeamMembers],
    queryFn: async () => {
      if (selectedTeamMembers.length === 0) return [];
      const promises = selectedTeamMembers.map(memberId => 
        base44.entities.Task.filter({ assigned_to: memberId }).catch(() => [])
      );
      const results = await Promise.all(promises);
      return results.flat();
    },
    enabled: selectedTeamMembers.length > 0
  });

  const { data: teamAppointments = [] } = useQuery({
    queryKey: ['teamAppointments', selectedTeamMembers],
    queryFn: async () => {
      if (selectedTeamMembers.length === 0) return [];
      const promises = selectedTeamMembers.map(memberId => 
        base44.entities.Appointment.filter({ agent_id: memberId }).catch(() => [])
      );
      const results = await Promise.all(promises);
      return results.flat();
    },
    enabled: selectedTeamMembers.length > 0
  });

  const { data: teamShowings = [] } = useQuery({
    queryKey: ['teamShowings', selectedTeamMembers],
    queryFn: async () => {
      if (selectedTeamMembers.length === 0) return [];
      const promises = selectedTeamMembers.map(memberId => 
        base44.entities.Showing.filter({ showing_agent_id: memberId }).catch(() => [])
      );
      const results = await Promise.all(promises);
      return results.flat();
    },
    enabled: selectedTeamMembers.length > 0
  });

  const { data: teamOpenHouses = [] } = useQuery({
    queryKey: ['teamOpenHouses', selectedTeamMembers],
    queryFn: async () => {
      if (selectedTeamMembers.length === 0) return [];
      const promises = selectedTeamMembers.map(memberId => 
        base44.entities.OpenHouse.filter({ hosting_agent_id: memberId }).catch(() => [])
      );
      const results = await Promise.all(promises);
      return results.flat();
    },
    enabled: selectedTeamMembers.length > 0
  });

  const { data: holidaysFromDB = [] } = useQuery({
    queryKey: ['holidays'],
    queryFn: () => base44.entities.Holiday.list(),
    staleTime: 60 * 60 * 1000, // 1 hour
  });

  // Close quick create menu when clicking outside
  useEffect(() => {
    const handleClickOutside = (e) => {
      setQuickCreateMenu(null);
      if (searchRef.current && !searchRef.current.contains(e.target)) {
        setShowSearchResults(false);
      }
    };
    document.addEventListener('click', handleClickOutside);
    return () => document.removeEventListener('click', handleClickOutside);
  }, []);

  // Get current location for travel time
  useEffect(() => {
    if (viewMode === 'day' && 'geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setCurrentLocation({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
        },
        (error) => {
          console.log('Geolocation unavailable:', error.message);
        },
        {
          enableHighAccuracy: false,
          timeout: 30000,
          maximumAge: 600000
        }
      );
    }
  }, [viewMode]);

  // Handle URL parameter for editing appointments
  useEffect(() => {
    const urlParams = new URLSearchParams(location.search);
    const editAppointmentId = urlParams.get('editAppointment');
    
    if (editAppointmentId && appointments.length > 0) {
      const appointmentToEdit = appointments.find(a => a.id === editAppointmentId);
      if (appointmentToEdit) {
        setEditingEvent(appointmentToEdit);
        setEventType('appointment');
        setShowEventModal(true);
        navigate(createPageUrl('Calendar'), { replace: true });
      }
    }
  }, [location.search, appointments, navigate]);

  // Auto-scroll to 7 AM when viewing day or week view
  useEffect(() => {
    if ((viewMode === 'day' || viewMode === 'week') && timeGridRef.current) {
      // 7 AM = 7 hours * 4 slots * slot height (16px for week, 20px for day)
      const slotHeight = viewMode === 'week' ? 16 : 20;
      const scrollPosition = 7 * 4 * slotHeight;
      timeGridRef.current.scrollTop = scrollPosition;
    }
  }, [viewMode, currentDate]);

  const holidays = useMemo(() => {
    if (!holidaysFromDB || holidaysFromDB.length === 0) return [];
    
    const year = currentDate.getFullYear();
    
    // Parse holiday preferences from user settings
    let prefs = { show_federal: true, show_religious: [], show_cultural: false };
    if (user?.holiday_preferences) {
      try {
        prefs = JSON.parse(user.holiday_preferences);
      } catch (e) {
        console.error('Failed to parse holiday preferences:', e);
      }
    }
    
    return holidaysFromDB
      .filter(h => {
        // Filter by year
        try {
          const holidayDate = new Date(h.date);
          if (isNaN(holidayDate.getTime())) return false;
          const holidayYear = holidayDate.getFullYear();
          if (holidayYear !== year) return false;
        } catch (e) {
          return false;
        }
        
        // Check federal holidays
        if (h.is_federal && prefs.show_federal) return true;
        
        // Check religious holidays
        if (h.religion && prefs.show_religious.includes(h.religion)) return true;
        
        // Check cultural observances
        if (h.holiday_type === 'cultural' && prefs.show_cultural) return true;
        
        return false;
      })
      .map(h => ({
        id: `holiday-${h.id}`,
        type: 'holiday',
        title: h.name,
        date: h.date,
        time: null,
        status: 'observed',
        color: h.color,
        religion: h.religion,
        data: h
      }));
  }, [currentDate, holidaysFromDB, user]);

  const calendarEvents = useMemo(() => {
    const allEvents = [];

    // Combine user's events with team events
    const allTasks = [...tasks, ...teamTasks.map(t => ({ ...t, isTeamEvent: true }))];
    const allAppointments = [...appointments, ...teamAppointments.map(a => ({ ...a, isTeamEvent: true }))];
    const allShowings = [...showings, ...teamShowings.map(s => ({ ...s, isTeamEvent: true }))];
    const allOpenHouses = [...openHouses, ...teamOpenHouses.map(oh => ({ ...oh, isTeamEvent: true }))];

    // Tasks - check for recurring tasks
    allTasks.forEach(task => {
      if (task?.due_date && task.status !== 'cancelled') {
        // Check if task has recurrence
        if (task.is_recurring) {
          try {
            const startDate = parseISO(task.due_date);
            if (isNaN(startDate.getTime())) return;
            const endDate = task.recurrence_end_date ? parseISO(task.recurrence_end_date) : addMonths(endOfMonth(currentDate), 1);
            const visibleStart = startOfMonth(currentDate);
            const visibleEnd = endOfMonth(currentDate);

            let currentInstanceDate = new Date(Math.max(startDate.getTime(), visibleStart.getTime()));

            while (currentInstanceDate <= visibleEnd && currentInstanceDate <= endDate) {
              const dateString = format(currentInstanceDate, 'yyyy-MM-dd');

              let shouldInclude = true;
              if (task.recurrence_pattern === 'weekly' && task.recurrence_days) {
                const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                const currentDayName = dayNames[currentInstanceDate.getDay()];
                const selectedDays = task.recurrence_days.split(',');
                shouldInclude = selectedDays.includes(currentDayName);
              }

              if (shouldInclude && currentInstanceDate >= startDate) {
                allEvents.push({
                  id: `${task.id}-${dateString}`,
                  type: 'task',
                  title: task.title,
                  date: dateString,
                  time: task.due_time || '09:00',
                  status: task.status,
                  priority: task.priority,
                  property_id: task.property_id,
                  description: task.description,
                  data: task,
                  isRecurringInstance: true
                });
              }

              if (task.recurrence_pattern === 'daily') {
                currentInstanceDate = addDays(currentInstanceDate, 1);
              } else if (task.recurrence_pattern === 'weekly') {
                currentInstanceDate = addDays(currentInstanceDate, 1);
              } else if (task.recurrence_pattern === 'monthly') {
                currentInstanceDate.setMonth(currentInstanceDate.getMonth() + 1);
              } else {
                currentInstanceDate = addDays(currentInstanceDate, 1);
              }
            }
          } catch (e) {
            console.error('Error processing recurring task:', task.id, e);
          }
        } else {
          // Non-recurring task - validate date
          try {
            const taskDate = parseISO(task.due_date);
            if (!isNaN(taskDate.getTime())) {
              allEvents.push({
                id: task.id,
                type: 'task',
                title: task.title,
                date: task.due_date,
                time: task.due_time || '09:00',
                status: task.status,
                priority: task.priority,
                property_id: task.property_id,
                description: task.description,
                data: task
              });
            }
          } catch (e) {
            console.error('Invalid date for task:', task.id, e);
          }
        }
      }
    });

    // Open Houses
    allOpenHouses.forEach(oh => {
      if (oh?.date && oh.status !== 'cancelled') {
        try {
          const ohDate = parseISO(oh.date);
          if (!isNaN(ohDate.getTime())) {
            const property = properties.find(p => p?.id === oh.property_id);
            allEvents.push({
              id: oh.id,
              type: 'open_house',
              title: `${property?.address || 'Property'}`,
              date: oh.date,
              time: oh.start_time || '10:00',
              status: oh.status,
              property_id: oh.property_id,
              location: property?.address,
              location_lat: property?.location_lat,
              location_lng: property?.location_lng,
              location_address: property?.address,
              description: oh.notes,
              data: oh
            });
          }
        } catch (e) {
          console.error('Invalid date for open house:', oh.id, e);
        }
      }
    });

    // Showings
    allShowings.forEach(showing => {
      if (showing?.scheduled_date && showing.status !== 'cancelled') {
        try {
          const showingDate = parseISO(showing.scheduled_date);
          if (!isNaN(showingDate.getTime())) {
            const property = properties.find(p => p?.id === showing.property_id);
            allEvents.push({
              id: showing.id,
              type: 'showing',
              title: `${property?.address || 'Property'}`,
              date: showing.scheduled_date,
              time: showing.scheduled_time || '14:00',
              status: showing.status,
              property_id: showing.property_id,
              location: property?.address,
              location_lat: property?.location_lat,
              location_lng: property?.location_lng,
              location_address: property?.address,
              buyer_name: showing.buyer_name,
              data: showing
            });
          }
        } catch (e) {
          console.error('Invalid date for showing:', showing.id, e);
        }
      }
    });

    allAppointments.forEach(apt => {
      if (apt?.scheduled_date && apt.status !== 'cancelled') {
        // Get cancelled instances
        let cancelledInstances = [];
        if (apt.cancelled_instances) {
          try {
            cancelledInstances = JSON.parse(apt.cancelled_instances);
          } catch (e) {
            console.error('Error parsing cancelled instances for appointment:', apt.id, e);
          }
        }

        // Handle recurring events - generate all instances within visible range
        if (apt.is_recurring) {
          try {
            const startDate = parseISO(apt.scheduled_date);
            if (isNaN(startDate.getTime())) return;
            const endDate = apt.recurrence_end_date ? parseISO(apt.recurrence_end_date) : addMonths(endOfMonth(currentDate), 1);
            const visibleStart = startOfMonth(currentDate);
            const visibleEnd = endOfMonth(currentDate);
            
            let currentInstanceDate = new Date(Math.max(startDate.getTime(), visibleStart.getTime()));
            
            // Generate instances based on recurrence pattern
            while (currentInstanceDate <= visibleEnd && currentInstanceDate <= endDate) {
              const dateString = format(currentInstanceDate, 'yyyy-MM-dd');
              
              // Skip cancelled instances
              if (cancelledInstances.includes(dateString)) {
                currentInstanceDate = addDays(currentInstanceDate, 1);
                continue;
              }
              
              // Check working days only
              if (apt.working_days_only) {
                const dayOfWeek = currentInstanceDate.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                  currentInstanceDate = addDays(currentInstanceDate, 1);
                  continue;
                }
              }
              
              // Check weekly pattern days
              let shouldInclude = true;
              if (apt.recurrence_pattern === 'weekly' && apt.recurrence_days) {
                const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                const currentDayName = dayNames[currentInstanceDate.getDay()];
                const selectedDays = apt.recurrence_days.split(',');
                shouldInclude = selectedDays.includes(currentDayName);
              }
              
              if (shouldInclude && currentInstanceDate >= startDate) {
                allEvents.push({
                  id: `${apt.id}-${dateString}`,
                  type: 'appointment',
                  title: apt.title,
                  date: dateString,
                  time: apt.scheduled_time || '09:00',
                  status: apt.status,
                  property_id: apt.property_id,
                  location: apt.location_address,
                  location_address: apt.location_address,
                  location_lat: apt.location_lat,
                  location_lng: apt.location_lng,
                  client_name: apt.client_name,
                  data: apt,
                  isRecurringInstance: true,
                  instanceDate: dateString
                });
              }
              
              // Move to next potential date based on pattern
              if (apt.recurrence_pattern === 'daily') {
                currentInstanceDate = addDays(currentInstanceDate, 1);
              } else if (apt.recurrence_pattern === 'weekly') {
                currentInstanceDate = addDays(currentInstanceDate, 1);
              } else if (apt.recurrence_pattern === 'monthly') {
                currentInstanceDate.setMonth(currentInstanceDate.getMonth() + 1);
              } else {
                currentInstanceDate = addDays(currentInstanceDate, 1);
              }
            }
          } catch (e) {
            console.error('Error processing recurring appointment:', apt.id, e);
          }
        } else {
          // Non-recurring appointment - validate date
          try {
            const aptDate = parseISO(apt.scheduled_date);
            if (!isNaN(aptDate.getTime())) {
              allEvents.push({
                id: apt.id,
                type: 'appointment',
                title: apt.title,
                date: apt.scheduled_date,
                time: apt.scheduled_time || '09:00',
                status: apt.status,
                property_id: apt.property_id,
                location: apt.location_address,
                location_address: apt.location_address,
                location_lat: apt.location_lat,
                location_lng: apt.location_lng,
                client_name: apt.client_name,
                data: apt
              });
            }
          } catch (e) {
            console.error('Invalid date for appointment:', apt.id, e);
          }
        }
      }
    });

    allEvents.push(...holidays);

    return allEvents;
  }, [tasks, openHouses, showings, appointments, properties, holidays, teamTasks, teamAppointments, teamShowings, teamOpenHouses]);

  const followUpTypes = ['follow_up_call', 'buyer_follow_up', 'seller_follow_up', 'fsbo_follow_up', 'lead_follow_up', 'cold_call'];
  
  const eventTypeCounts = {
    all: calendarEvents.filter(e => eventTypeFilter === "all" || e.type === eventTypeFilter).length,
    task: calendarEvents.filter(e => e.type === 'task').length,
    open_house: calendarEvents.filter(e => e.type === 'open_house').length,
    showing: calendarEvents.filter(e => e.type === 'showing').length,
    appointment: calendarEvents.filter(e => e.type === 'appointment' && !followUpTypes.includes(e.data?.appointment_type)).length,
    follow_up: calendarEvents.filter(e => e.type === 'appointment' && followUpTypes.includes(e.data?.appointment_type)).length,
    holiday: calendarEvents.filter(e => e.type === 'holiday').length
  };

  const monthStart = startOfMonth(currentDate);
  const monthEnd = endOfMonth(currentDate);
  const startDate = startOfWeek(monthStart, { weekStartsOn: 0 });
  const endDate = endOfWeek(monthEnd, { weekStartsOn: 0 });
  const daysInView = eachDayOfInterval({ start: startDate, end: endDate });

  const getEventsForDate = (date) => {
    return calendarEvents.filter(event => {
      try {
        const eventDate = parseISO(event.date);
        if (isNaN(eventDate.getTime())) return false;
        const matchesDate = isSameDay(eventDate, date);
      
      let matchesFilter = eventTypeFilter === "all";
      if (!matchesFilter) {
        if (eventTypeFilter === "follow_up") {
          matchesFilter = event.type === 'appointment' && followUpTypes.includes(event.data?.appointment_type);
        } else if (eventTypeFilter === "appointment") {
          matchesFilter = event.type === 'appointment' && !followUpTypes.includes(event.data?.appointment_type);
        } else {
          matchesFilter = event.type === eventTypeFilter;
        }
      }
      
        return matchesDate && matchesFilter;
      } catch (e) {
        return false;
      }
    }).sort((a, b) => {
      const timeA = a.time || '00:00';
      const timeB = b.time || '00:00';
      return timeA.localeCompare(timeB);
    });
  };

  const colorMap = {
    pink: { gradient: 'from-pink-400 to-rose-600', border: 'border-pink-600', ring: 'ring-pink-300/50', lightGradient: 'from-pink-300 to-rose-300', lightBorder: 'border-pink-400', lightText: 'text-pink-900' },
    blue: { gradient: 'from-blue-400 to-blue-600', border: 'border-blue-600', ring: 'ring-blue-300/50', lightGradient: 'from-blue-300 to-blue-300', lightBorder: 'border-blue-400', lightText: 'text-blue-900' },
    purple: { gradient: 'from-purple-400 to-purple-600', border: 'border-purple-600', ring: 'ring-purple-300/50', lightGradient: 'from-purple-300 to-purple-300', lightBorder: 'border-purple-400', lightText: 'text-purple-900' },
    green: { gradient: 'from-green-400 to-green-600', border: 'border-green-600', ring: 'ring-green-300/50', lightGradient: 'from-green-300 to-green-300', lightBorder: 'border-green-400', lightText: 'text-green-900' },
    orange: { gradient: 'from-orange-400 to-orange-600', border: 'border-orange-600', ring: 'ring-orange-300/50', lightGradient: 'from-orange-300 to-orange-300', lightBorder: 'border-orange-400', lightText: 'text-orange-900' },
    red: { gradient: 'from-red-400 to-red-600', border: 'border-red-600', ring: 'ring-red-300/50', lightGradient: 'from-red-300 to-red-300', lightBorder: 'border-red-400', lightText: 'text-red-900' },
    cyan: { gradient: 'from-cyan-400 to-cyan-600', border: 'border-cyan-600', ring: 'ring-cyan-300/50', lightGradient: 'from-cyan-300 to-cyan-300', lightBorder: 'border-cyan-400', lightText: 'text-cyan-900' },
    amber: { gradient: 'from-amber-400 to-amber-600', border: 'border-amber-600', ring: 'ring-amber-300/50', lightGradient: 'from-amber-300 to-amber-300', lightBorder: 'border-amber-400', lightText: 'text-amber-900' },
    emerald: { gradient: 'from-emerald-400 to-emerald-600', border: 'border-emerald-600', ring: 'ring-emerald-300/50', lightGradient: 'from-emerald-300 to-emerald-300', lightBorder: 'border-emerald-400', lightText: 'text-emerald-900' },
    violet: { gradient: 'from-violet-400 to-violet-600', border: 'border-violet-600', ring: 'ring-violet-300/50', lightGradient: 'from-violet-300 to-violet-300', lightBorder: 'border-violet-400', lightText: 'text-violet-900' },
    slate: { gradient: 'from-slate-400 to-slate-600', border: 'border-slate-600', ring: 'ring-slate-300/50', lightGradient: 'from-slate-300 to-slate-300', lightBorder: 'border-slate-400', lightText: 'text-slate-900' }
  };

  const getEventColor = (event, date) => {
    try {
      const eventDate = parseISO(event.date);
      if (isNaN(eventDate.getTime())) return 'bg-gradient-to-r from-slate-400 to-slate-500 border-slate-600';
      const isPast = eventDate < startOfDay(new Date());
      const isTaskCompleted = event.type === 'task' && event.status === 'completed';
    
    const isOverdue = event.type === 'task' && isPast && !isTaskCompleted;
    
    if (isOverdue) {
      return 'bg-gradient-to-r from-red-500 to-rose-600 border-red-700 shadow-lg ring-2 ring-red-400/50 animate-pulse';
    }

    // Use custom color if available
    if (event.type === 'appointment' && event.data?.color && colorMap[event.data.color]) {
      const colorName = event.data.color;
      return isPast 
        ? `bg-${colorName}-300 border-${colorName}-400 text-${colorName}-900 opacity-70`
        : `bg-${colorName}-500 border-${colorName}-600 shadow-md ring-1 ring-${colorName}-300/50`;
    }

    if (event.type === 'task' && event.data?.color && colorMap[event.data.color]) {
      const colorName = event.data.color;
      return isPast || isTaskCompleted
        ? `bg-${colorName}-300 border-${colorName}-400 text-${colorName}-900 opacity-70`
        : `bg-${colorName}-500 border-${colorName}-600 shadow-md ring-1 ring-${colorName}-300/50`;
    }
    
    // Default colors for each event type
    const colors = {
      task: isPast || isTaskCompleted 
        ? 'bg-cyan-300 border-cyan-400 text-cyan-900 opacity-70' 
        : 'bg-cyan-500 border-cyan-600 shadow-md ring-1 ring-cyan-300/50',
      open_house: isPast 
        ? 'bg-violet-300 border-violet-400 text-violet-900 opacity-70' 
        : 'bg-violet-500 border-violet-600 shadow-md ring-1 ring-violet-300/50',
      showing: isPast 
        ? 'bg-emerald-300 border-emerald-400 text-emerald-900 opacity-70' 
        : 'bg-emerald-500 border-emerald-600 shadow-md ring-1 ring-emerald-300/50',
      appointment: isPast 
        ? 'bg-pink-300 border-pink-400 text-pink-900 opacity-70' 
        : 'bg-pink-500 border-pink-600 shadow-md ring-1 ring-pink-300/50',
      holiday: 'bg-amber-500 border-amber-600 shadow-md ring-1 ring-amber-300/50'
    };
    
      return colors[event.type] || 'bg-gradient-to-r from-slate-400 to-slate-500 border-slate-600';
    } catch (e) {
      return 'bg-gradient-to-r from-slate-400 to-slate-500 border-slate-600';
    }
  };

  const getEventIcon = (type) => {
    const icons = {
      task: <CheckSquare className="w-3 h-3" />,
      appointment: <CalendarIcon className="w-3 h-3" />,
      showing: <Eye className="w-3 h-3" />,
      open_house: <Home className="w-3 h-3" />,
      holiday: <Gift className="w-3 h-3" />
    };
    return icons[type] || <Clock className="w-3 h-3" />;
  };

  const getEventTextStyle = (event) => {
    try {
      const eventDate = parseISO(event.date);
      if (isNaN(eventDate.getTime())) return '';
      const isPast = eventDate < startOfDay(new Date());
      const isTaskCompleted = event.type === 'task' && event.status === 'completed';
      const isOverdue = event.type === 'task' && isPast && !isTaskCompleted;
    
    if (isTaskCompleted) {
      return 'line-through opacity-70';
    }
    
    if (isOverdue) {
      return 'font-bold'; // Make overdue tasks stand out more
    }
    
    if (isPast && event.type !== 'task') {
      return 'opacity-80';
    }
    
      return '';
    } catch (e) {
      return '';
    }
  };

  const handleEventClick = (event) => {
    // Don't allow editing team events
    if (event.data?.isTeamEvent) {
      toast.info(`This is ${event.title} (team member's event)`);
      return;
    }

    if (event.type === 'appointment') {
      const dataToEdit = event.isRecurringInstance ? appointments.find(apt => apt.id === event.data.id) : event.data;
      setEditingEvent(dataToEdit);
      setEventType('appointment');
      setShowEventModal(true);
    } else if (event.type === 'task') {
      setEditingEvent(event.data);
      setEventType('task');
      setShowEventModal(true);
    } else if (event.type === 'open_house') {
      setEditingEvent(event.data);
      setEventType('open_house');
      setShowEventModal(true);
    } else if (event.type === 'showing') {
      setEditingEvent(event.data);
      setEventType('showing');
      setShowEventModal(true);
    } else if (event.type === 'holiday') {
      toast.info(`It's ${event.title}! Enjoy the day.`);
    }
  };

  const handleSaveEvent = async (eventData) => {
    try {
      if (eventType === 'appointment') {
        if (editingEvent?.id) {
          await base44.entities.Appointment.update(editingEvent.id, eventData);
          toast.success("Appointment updated!");
        } else {
          await base44.entities.Appointment.create({
            ...eventData,
            agent_id: eventData.agent_id || user?.id,
            status: 'scheduled'
          });
          toast.success("Appointment created!");
        }
        queryClient.invalidateQueries(['appointments']);
      } else if (eventType === 'task') {
        if (editingEvent?.id) {
          await base44.entities.Task.update(editingEvent.id, eventData);
          toast.success("Task updated!");
        } else {
          await base44.entities.Task.create({
            ...eventData,
            assigned_to: eventData.assigned_to || user?.id
          });
          toast.success("Task created!");
        }
        queryClient.invalidateQueries(['tasks']);
      } else if (eventType === 'open_house') {
        if (editingEvent?.id) {
          await base44.entities.OpenHouse.update(editingEvent.id, eventData);
          toast.success("Open house updated!");
        } else {
          await base44.entities.OpenHouse.create({
            ...eventData,
            hosting_agent_id: eventData.hosting_agent_id || user?.id
          });
          toast.success("Open house scheduled!");
        }
        queryClient.invalidateQueries(['openHouses']);
      } else if (eventType === 'showing') {
        if (editingEvent?.id) {
          await base44.entities.Showing.update(editingEvent.id, eventData);
          toast.success("Showing updated!");
        } else {
          await base44.entities.Showing.create({
            ...eventData,
            showing_agent_id: eventData.showing_agent_id || user?.id
          });
          toast.success("Showing scheduled!");
        }
        queryClient.invalidateQueries(['showings']);
      }
      
      setShowEventModal(false);
      setEditingEvent(null);
    } catch (error) {
      console.error("Error saving event:", error);
      toast.error("Failed to save event");
    }
  };

  // Handle drag and drop for events
  const handleDragEnd = async (result) => {
    document.body.style.cursor = '';
    setDragHoverInfo(null);
    const { destination, source, draggableId } = result;
    
    if (!destination) return;
    // Don't do anything if dropped in the same place
    if (destination.droppableId === source.droppableId) return;
    
    // Parse the draggable ID to get event type and ID (format: "type::id")
    const separatorIndex = draggableId.indexOf('::');
    if (separatorIndex === -1) return;
    
    const eventType = draggableId.substring(0, separatorIndex);
    const eventId = draggableId.substring(separatorIndex + 2);
    
    // droppableId is the date string for month view (yyyy-MM-dd)
    const newDate = destination.droppableId;
    let formattedDate = newDate;
    try {
      const parsedDate = parseISO(newDate);
      if (!isNaN(parsedDate.getTime())) {
        formattedDate = format(parsedDate, 'MMM d');
      }
    } catch (e) {
      // Use original newDate as fallback
    }

    try {
      if (eventType === 'task') {
        await base44.entities.Task.update(eventId, { due_date: newDate });
        queryClient.invalidateQueries(['tasks']);
        toast.success("Task moved to " + formattedDate);
      } else if (eventType === 'appointment') {
        await base44.entities.Appointment.update(eventId, { scheduled_date: newDate });
        queryClient.invalidateQueries(['appointments']);
        toast.success("Appointment moved to " + formattedDate);
      } else if (eventType === 'showing') {
        await base44.entities.Showing.update(eventId, { scheduled_date: newDate });
        queryClient.invalidateQueries(['showings']);
        toast.success("Showing moved to " + formattedDate);
      } else if (eventType === 'open_house') {
        await base44.entities.OpenHouse.update(eventId, { date: newDate });
        queryClient.invalidateQueries(['openHouses']);
        toast.success("Open house moved to " + formattedDate);
      }
    } catch (error) {
      console.error("Error moving event:", error);
      toast.error("Failed to move event: " + error.message);
    }
  };

  const todayEvents = getEventsForDate(new Date());
  const currentDayEvents = getEventsForDate(currentDate);

  // Calculate travel times for ALL day view events with addresses - FAST parallel execution
  useEffect(() => {
    if (viewMode !== 'day' || !currentLocation) return;

    const calculateTravelTimes = async () => {
      // Include ALL events with physical locations - ENHANCED to lookup property coords if missing
      const eventsWithAddress = currentDayEvents.filter(e => {
        // For appointments - check address and get coords from property if needed
        if (e.type === 'appointment') {
          const hasAddress = e.location_address || e.data?.location_address;
          const notVirtual = !e.data?.is_virtual;
          
          if (!hasAddress || !notVirtual) {
            console.log('Appointment excluded:', e.title, { hasAddress, notVirtual });
            return false;
          }
          
          // Check if coords exist on event OR can be found via property
          const hasDirectCoords = (e.location_lat && e.location_lng) || (e.data?.location_lat && e.data?.location_lng);
          const hasPropertyId = e.property_id || e.data?.property_id;
          
          console.log('Appointment check:', e.title, { 
            hasAddress, 
            hasDirectCoords, 
            hasPropertyId,
            notVirtual,
            will_include: hasAddress && (hasDirectCoords || hasPropertyId) && notVirtual
          });
          
          return hasAddress && (hasDirectCoords || hasPropertyId) && notVirtual;
        }
        
        // Check showings
        if (e.type === 'showing' && 
            e.location_lat && 
            e.location_lng &&
            e.location_address) {
          return true;
        }
        
        // Check open houses
        if (e.type === 'open_house' && 
            e.location_lat && 
            e.location_lng &&
            e.location_address) {
          return true;
        }
        
        return false;
      });

      console.log('Events with addresses to calculate:', eventsWithAddress.length, eventsWithAddress.map(e => ({ id: e.id, title: e.title, type: e.type })));

      if (eventsWithAddress.length === 0) return;

      // Calculate ALL events in parallel for speed
      const travelPromises = eventsWithAddress.map(async (event) => {
        try {
          // Get coordinates - lookup from property if not on event
          let toLat, toLng;
          
          if (event.type === 'appointment') {
            toLat = event.location_lat || event.data?.location_lat;
            toLng = event.location_lng || event.data?.location_lng;
            
            // If coords missing, lookup from property
            if ((!toLat || !toLng) && (event.property_id || event.data?.property_id)) {
              const propId = event.property_id || event.data?.property_id;
              const property = properties.find(p => p.id === propId);
              if (property?.location_lat && property?.location_lng) {
                toLat = property.location_lat;
                toLng = property.location_lng;
                console.log('‚úÖ Found coords from property for:', event.title, { toLat, toLng });
              }
            }
          } else {
            toLat = event.location_lat;
            toLng = event.location_lng;
          }
          
          if (!toLat || !toLng) {
            console.log('‚ùå No coords available for:', event.title);
            return null;
          }
          
          console.log('Calculating travel for:', event.title, { toLat, toLng });
          
          const result = await base44.integrations.Core.InvokeLLM({
            prompt: `Calculate driving time and distance from coordinates ${currentLocation.lat},${currentLocation.lng} to coordinates ${toLat},${toLng}. Use current traffic conditions.`,
            add_context_from_internet: true,
            response_json_schema: {
              type: 'object',
              properties: {
                duration_minutes: { type: 'number', description: 'Travel time in minutes' },
                distance_miles: { type: 'number', description: 'Distance in miles' }
              }
            }
          });
          
          console.log('Travel result for', event.title, result);
          
          if (result.duration_minutes) {
            return {
              id: event.id,
              data: {
                duration: `${Math.round(result.duration_minutes)} min`,
                distance: result.distance_miles ? `${result.distance_miles.toFixed(1)} mi` : '',
                minutes: Math.round(result.duration_minutes)
              }
            };
          }
        } catch (error) {
          console.error('Travel calc error for:', event.title, error);
        }
        return null;
      });

      // Wait for all calculations in parallel
      const results = await Promise.all(travelPromises);
      
      console.log('All travel results:', results);
      
      // Update state once with all results
      const newTravelTimes = {};
      results.forEach(result => {
        if (result) {
          newTravelTimes[result.id] = result.data;
        }
      });

      console.log('Setting travel times:', newTravelTimes);

      if (Object.keys(newTravelTimes).length > 0) {
        setTravelTimes(prev => ({ ...prev, ...newTravelTimes }));
      }
    };

    calculateTravelTimes();
  }, [viewMode, currentLocation, currentDayEvents.length, properties.length]);

  // Search functionality
  const searchResults = useMemo(() => {
    if (!searchQuery.trim()) return [];
    
    const query = searchQuery.toLowerCase();
    return calendarEvents.filter(event => {
      // Search in title
      if (event.title?.toLowerCase().includes(query)) return true;
      
      // Search in description
      if (event.description?.toLowerCase().includes(query)) return true;
      
      // Search in client/buyer name
      if (event.client_name?.toLowerCase().includes(query)) return true;
      if (event.buyer_name?.toLowerCase().includes(query)) return true;
      
      // Search in location/property address
      if (event.location?.toLowerCase().includes(query)) return true;
      
      // Search in property address
      const property = properties.find(p => p.id === event.property_id);
      if (property?.address?.toLowerCase().includes(query)) return true;
      
      // Search in date
      try {
        const eventDate = parseISO(event.date);
        if (!isNaN(eventDate.getTime()) && format(eventDate, 'MMMM d, yyyy').toLowerCase().includes(query)) return true;
      } catch (e) {
        // Skip invalid dates
      }
      
      // Search in time
      if (event.time?.includes(query)) return true;
      
      return false;
    }).slice(0, 20); // Limit to 20 results
  }, [searchQuery, calendarEvents, properties]);

  const handleSearchResultClick = (event, e) => {
    e.preventDefault();
    e.stopPropagation();
    
    try {
      const eventDate = parseISO(event.date);
      if (isNaN(eventDate.getTime())) {
        toast.error('Invalid event date');
        return;
      }
      setCurrentDate(eventDate);
      setViewMode('day');
      setShowSearchResults(false);
      setSearchQuery('');
      
      // Auto-open the event modal after a short delay
      setTimeout(() => {
        handleEventClick(event);
      }, 300);
    } catch (e) {
      toast.error('Error opening event');
    }
  };

  return (
    <div className="h-screen flex flex-col bg-gradient-to-br from-slate-50 via-white to-slate-100 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800 -m-6">
      {/* Compact Header */}
      <div className="text-white px-4 py-3 flex-shrink-0" style={{ background: 'var(--theme-primary, linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%))' }}>
        <div className="flex items-center justify-between gap-4 flex-wrap">
          {/* Title & Stats */}
          <div className="flex items-center gap-4">
            <h1 className="text-lg font-bold">Calendar</h1>
            <span className="text-white/70 text-sm hidden sm:inline">{calendarEvents.length} events</span>
          </div>

          {/* Quick Action Buttons - Compact */}
          <div className="flex items-center gap-2">
            <Button
              onClick={() => navigate(createPageUrl("Tasks"))}
              size="sm"
              className="h-8 bg-white/15 hover:bg-white/25 border border-white/20 text-white gap-1.5"
            >
              <CheckSquare className="w-3.5 h-3.5" />
              <span className="hidden md:inline">Task</span>
              <Badge className="bg-white/20 text-white text-[10px] h-4 px-1">{eventTypeCounts.task}</Badge>
            </Button>

            <Button
              onClick={() => navigate(createPageUrl("OpenHouses"))}
              size="sm"
              className="h-8 bg-white/15 hover:bg-white/25 border border-white/20 text-white gap-1.5"
            >
              <Home className="w-3.5 h-3.5" />
              <span className="hidden md:inline">Open House</span>
              <Badge className="bg-white/20 text-white text-[10px] h-4 px-1">{eventTypeCounts.open_house}</Badge>
            </Button>

            <Button
              onClick={() => navigate(createPageUrl("Showings"))}
              size="sm"
              className="h-8 bg-white/15 hover:bg-white/25 border border-white/20 text-white gap-1.5"
            >
              <Eye className="w-3.5 h-3.5" />
              <span className="hidden md:inline">Showing</span>
              <Badge className="bg-white/20 text-white text-[10px] h-4 px-1">{eventTypeCounts.showing}</Badge>
            </Button>

            <Button
              onClick={() => { 
                setEditingEvent(null);
                setEventType('appointment');
                setShowEventModal(true);
              }}
              size="sm"
              className="h-8 bg-white/15 hover:bg-white/25 border border-white/20 text-white gap-1.5"
            >
              <CalendarIcon className="w-3.5 h-3.5" />
              <span className="hidden md:inline">Appt</span>
              <Badge className="bg-white/20 text-white text-[10px] h-4 px-1">{eventTypeCounts.appointment}</Badge>
            </Button>

            <Button
              onClick={() => setShowSyncModal(true)}
              size="sm"
              className="h-8 bg-white/15 hover:bg-white/25 border border-white/20 text-white gap-1.5"
            >
              <Sparkles className="w-3.5 h-3.5" />
              <span className="hidden lg:inline">Sync</span>
            </Button>

            <Button
              onClick={() => setShowTemplateManager(true)}
              size="sm"
              className="h-8 bg-white/15 hover:bg-white/25 border border-white/20 text-white gap-1.5"
            >
              <Copy className="w-3.5 h-3.5" />
              <span className="hidden lg:inline">Templates</span>
            </Button>
          </div>

          {/* Filters - Inline Pills */}
          <div className="flex items-center gap-1 overflow-x-auto pb-1 -mb-1 w-full md:w-auto">
            {[
              { key: 'all', label: 'All', count: eventTypeCounts.all, icon: null },
              { key: 'task', label: 'Tasks', count: eventTypeCounts.task, icon: CheckSquare },
              { key: 'open_house', label: 'Open', count: eventTypeCounts.open_house, icon: Home },
              { key: 'showing', label: 'Show', count: eventTypeCounts.showing, icon: Eye },
              { key: 'appointment', label: 'Appt', count: eventTypeCounts.appointment, icon: CalendarIcon },
              { key: 'follow_up', label: 'F/U', count: eventTypeCounts.follow_up, icon: Phone },
            ].map(f => (
              <button
                key={f.key}
                onClick={() => setEventTypeFilter(f.key)}
                className={`flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium whitespace-nowrap transition-all ${
                  eventTypeFilter === f.key
                    ? 'bg-white text-slate-800 shadow'
                    : 'bg-white/10 text-white/90 hover:bg-white/20'
                }`}
              >
                {f.icon && <f.icon className="w-3 h-3" />}
                {f.label}
                <span className={`${eventTypeFilter === f.key ? 'text-slate-500' : 'text-white/60'}`}>({f.count})</span>
              </button>
            ))}
          </div>
        </div>
      </div>

      <div className="flex flex-1 overflow-hidden">
        {/* Left Sidebar */}
        {showSidebar && (
          <div className="w-64 border-r border-slate-200 dark:border-slate-700 p-4 space-y-6 overflow-y-auto bg-gradient-to-b from-white to-slate-50 dark:from-slate-900 dark:to-slate-800">
            <Button
              onClick={() => {
                setEditingEvent(null);
                setEventType('appointment');
                setShowEventModal(true);
              }}
              className="w-full shadow-lg hover:shadow-xl transition-all hover:scale-[1.02]"
              style={{ background: 'var(--theme-primary, linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%))' }}
            >
              <Plus className="w-4 h-4 mr-2" />
              Create
            </Button>

            {/* Mini Calendar */}
            <div className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-3 shadow-sm">
              <div className="flex items-center justify-between mb-3">
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => setCurrentDate(subMonths(currentDate, 1))}
                  className="h-8 w-8 hover:bg-slate-100 dark:hover:bg-slate-700"
                >
                  <ChevronLeft className="w-4 h-4" />
                </Button>
                <span className="text-sm font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                  {format(currentDate, 'MMM yyyy')}
                </span>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => setCurrentDate(addMonths(currentDate, 1))}
                  className="h-8 w-8 hover:bg-slate-100 dark:hover:bg-slate-700"
                >
                  <ChevronRight className="w-4 h-4" />
                </Button>
              </div>

              <div className="grid grid-cols-7 gap-1 text-center text-xs mb-2">
                {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, i) => (
                  <div key={i} className="text-slate-400 font-semibold">{day}</div>
                ))}
              </div>

              <div className="grid grid-cols-7 gap-1">
                {daysInView.map((day, i) => {
                  const hasEvents = getEventsForDate(day).length > 0;
                  const isCurrentDay = isToday(day);
                  const isCurrentMonth = isSameMonth(day, currentDate);

                  return (
                    <button
                      key={i}
                      onClick={(e) => {
                        e.stopPropagation();
                        setCurrentDate(day);
                        setViewMode('day');
                      }}
                      className={`
                        h-8 text-xs rounded-full transition-all cursor-pointer
                        ${!isCurrentMonth ? 'text-slate-300 dark:text-slate-600 hover:text-slate-500' : 'text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700'}
                        ${isCurrentDay ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold shadow-md' : ''}
                        ${hasEvents && !isCurrentDay ? 'font-bold ring-2 ring-indigo-300 dark:ring-indigo-600' : ''}
                      `}
                    >
                      {format(day, 'd')}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* Team Calendar Panel */}
            <TeamCalendarPanel 
              currentUser={user}
              onTeamMembersChange={(members) => setSelectedTeamMembers(members)}
            />

            {/* Event Types Legend */}
            <div>
              <h3 className="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                <span className="w-1 h-4 rounded-full bg-gradient-to-b from-indigo-500 to-purple-600"></span>
                Event Types
              </h3>
              <div className="space-y-1.5">
                {[
                  { type: 'all', label: 'All Events', color: 'bg-gradient-to-r from-slate-500 to-slate-600', icon: <CalendarIcon className="w-3 h-3" /> },
                  { type: 'appointment', label: 'Appointments', color: 'bg-gradient-to-r from-pink-400 to-rose-600', icon: <CalendarIcon className="w-3 h-3" /> },
                  { type: 'follow_up', label: 'Follow-ups', color: 'bg-gradient-to-r from-amber-400 to-orange-500', icon: <Phone className="w-3 h-3" /> },
                  { type: 'task', label: 'Tasks', color: 'bg-gradient-to-r from-cyan-400 to-blue-500', icon: <CheckSquare className="w-3 h-3" /> },
                  { type: 'showing', label: 'Showings', color: 'bg-gradient-to-r from-emerald-400 to-teal-600', icon: <Eye className="w-3 h-3" /> },
                  { type: 'open_house', label: 'Open Houses', color: 'bg-gradient-to-r from-violet-400 to-purple-600', icon: <Home className="w-3 h-3" /> },
                  { type: 'holiday', label: 'Holidays', color: 'bg-gradient-to-r from-green-400 to-emerald-500', icon: <Gift className="w-3 h-3" /> }
                ].map(({ type, label, color, icon }) => (
                  <button
                    key={type}
                    onClick={() => setEventTypeFilter(type)}
                    className={`flex items-center gap-3 w-full p-2.5 rounded-xl transition-all ${eventTypeFilter === type ? 'bg-gradient-to-r from-slate-100 to-slate-50 dark:from-slate-800 dark:to-slate-700 shadow-sm ring-1 ring-slate-200 dark:ring-slate-600' : 'hover:bg-slate-50 dark:hover:bg-slate-800/50'}`}
                  >
                    <div className={`w-7 h-7 rounded-lg ${color} flex items-center justify-center text-white shadow-md`}>
                      {icon}
                    </div>
                    <span className="text-sm text-slate-700 dark:text-slate-200 flex-1 text-left font-medium">
                      {label}
                    </span>
                    <Badge variant="secondary" className="text-xs bg-white dark:bg-slate-700 shadow-sm font-bold">
                      {type === 'all' ? calendarEvents.length : calendarEvents.filter(e => e.type === type).length}
                    </Badge>
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Main Calendar Area */}
        <div className="flex-1 flex flex-col overflow-hidden bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-800">
          {/* Calendar Toolbar */}
          <div className="flex items-center justify-between px-6 py-3 border-b border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm">
            <div className="flex items-center gap-3">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => setShowSidebar(!showSidebar)}
                className="lg:hidden"
              >
                <Menu className="w-5 h-5" />
              </Button>

              <Button
                variant="outline"
                onClick={() => setCurrentDate(new Date())}
                className="font-semibold border-2 hover:border-indigo-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors"
              >
                Today
              </Button>

              <div className="flex items-center gap-1">
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => {
                    if (viewMode === 'day') {
                      setCurrentDate(addDays(currentDate, -1));
                    } else if (viewMode === 'week') {
                      setCurrentDate(addDays(currentDate, -7));
                    } else {
                      setCurrentDate(subMonths(currentDate, 1));
                    }
                  }}
                >
                  <ChevronLeft className="w-5 h-5" />
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => {
                    if (viewMode === 'day') {
                      setCurrentDate(addDays(currentDate, 1));
                    } else if (viewMode === 'week') {
                      setCurrentDate(addDays(currentDate, 7));
                    } else {
                      setCurrentDate(addMonths(currentDate, 1));
                    }
                  }}
                >
                  <ChevronRight className="w-5 h-5" />
                </Button>
              </div>

              <h2 className="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 dark:from-white dark:to-slate-300 bg-clip-text text-transparent">
                {format(currentDate, 'MMMM d, yyyy')}
              </h2>
            </div>

            {/* Search Bar */}
            <div className="relative" ref={searchRef}>
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                <input
                  type="text"
                  placeholder="Search events..."
                  value={searchQuery}
                  onChange={(e) => {
                    setSearchQuery(e.target.value);
                    setShowSearchResults(true);
                  }}
                  onFocus={() => searchQuery && setShowSearchResults(true)}
                  className="pl-9 pr-4 py-2 w-64 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none"
                />
              </div>
            </div>

            <div className="flex items-center gap-1 bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
              <Button
                variant={viewMode === 'day' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => setViewMode('day')}
                className={viewMode === 'day' ? 'shadow-md' : 'hover:bg-white dark:hover:bg-slate-700'}
                style={viewMode === 'day' ? { background: 'var(--theme-primary, #4F46E5)' } : {}}
              >
                Day
              </Button>
              <Button
                variant={viewMode === 'week' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => setViewMode('week')}
                className={viewMode === 'week' ? 'shadow-md' : 'hover:bg-white dark:hover:bg-slate-700'}
                style={viewMode === 'week' ? { background: 'var(--theme-primary, #4F46E5)' } : {}}
              >
                Week
              </Button>
              <Button
                variant={viewMode === 'month' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => setViewMode('month')}
                className={viewMode === 'month' ? 'shadow-md' : 'hover:bg-white dark:hover:bg-slate-700'}
                style={viewMode === 'month' ? { background: 'var(--theme-primary, #4F46E5)' } : {}}
              >
                Month
              </Button>
            </div>
          </div>

          {/* Calendar Grid - Wrapped in DragDropContext */}
          <DragDropContext 
            onDragEnd={handleDragEnd} 
            onDragStart={() => { 
              document.body.style.cursor = 'grabbing';
            }}
            onDragUpdate={(update) => {
              if (update.destination) {
                const destDate = update.destination.droppableId;
                let title = 'Moving to ' + destDate;
                try {
                  const parsedDate = parseISO(destDate);
                  if (!isNaN(parsedDate.getTime())) {
                    title = 'Moving to ' + format(parsedDate, 'MMM d, yyyy');
                  }
                } catch (e) {
                  // Keep default title
                }
                setDragHoverInfo({
                  date: destDate,
                  time: null,
                  title
                });
              }
            }}
          >
            <div className="flex-1 overflow-auto">
            {viewMode === 'month' && (
              <div className="h-full flex flex-col">
                {/* Day Headers */}
                <div className="grid grid-cols-7 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
                  {['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map(day => (
                    <div key={day} className="px-2 py-3 text-center text-xs font-medium text-slate-600 dark:text-slate-400 border-r border-slate-200 dark:border-slate-700 last:border-r-0">
                      {day}
                    </div>
                  ))}
                </div>

                {/* Calendar Days (Droppable areas) */}
                <div className="grid grid-cols-7 flex-1" style={{ gridAutoRows: '1fr' }}>
                  {daysInView.map((day, index) => {
                    const dayEvents = getEventsForDate(day);
                    const isCurrentDay = isToday(day);
                    const isCurrentMonth = isSameMonth(day, currentDate);
                    const isWeekendDay = isWeekend(day);
                    const dateStr = format(day, 'yyyy-MM-dd');

                    return (
                      <Droppable droppableId={dateStr} key={dateStr}>
                        {(provided, snapshot) => (
                          <div
                            ref={provided.innerRef}
                            {...provided.droppableProps}
                            onClick={(e) => {
                              e.stopPropagation();
                              setSelectedDate(day);
                              const rect = e.currentTarget.getBoundingClientRect();
                              setQuickCreateMenu({
                                x: Math.min(rect.left, window.innerWidth - 200),
                                y: Math.min(rect.bottom, window.innerHeight - 250),
                                date: dateStr,
                                time: null
                              });
                            }}
                            className={`
                              border-r border-b border-slate-200 dark:border-slate-700 p-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors min-h-[100px]
                              ${!isCurrentMonth ? 'bg-slate-50/50 dark:bg-slate-900/50' : ''}
                              ${isWeekendDay && isCurrentMonth ? 'bg-slate-50 dark:bg-slate-800/30' : ''}
                              ${index % 7 === 6 ? 'border-r-0' : ''}
                              ${snapshot.isDraggingOver ? 'bg-indigo-50 dark:bg-indigo-900/20 ring-2 ring-indigo-400 ring-inset' : ''}
                            `}
                          >
                            <div className="mb-1">
                              <span className={`
                                inline-flex items-center justify-center w-7 h-7 text-sm rounded-full transition-all
                                ${isCurrentDay ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold shadow-lg ring-2 ring-indigo-300 dark:ring-indigo-600' : ''}
                                ${!isCurrentMonth ? 'text-slate-400 dark:text-slate-600' : 'text-slate-700 dark:text-slate-200 font-medium'}
                              `}>
                                {format(day, 'd')}
                              </span>
                            </div>

                            <div className="space-y-1">
                              {dayEvents.slice(0, 3).map((event) => {
                                const canDrag = event.type !== 'holiday' && !event.isRecurringInstance;
                                const dragId = `${event.type}::${event.id}`;
                                const eventIdx = dayEvents.indexOf(event);
                                
                                if (!canDrag) {
                                  return (
                                    <div
                                      key={`${event.type}-${event.id}-${eventIdx}`}
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleEventClick(event);
                                      }}
                                      className={`
                                       ${getEventColor(event, day)} text-white text-xs px-2 py-1.5 rounded-md border-l-4 hover:shadow-lg hover:scale-105 transition-all cursor-pointer flex items-center gap-1.5
                                       ${getEventTextStyle(event)}
                                       ${event.data?.isTeamEvent ? 'opacity-60 border-dashed' : ''}
                                      `}
                                    >
                                      {getEventIcon(event.type)}
                                      <div className="flex-1 min-w-0">
                                        <div className="font-semibold truncate">{event.time}{event.data?.is_recurring && ' üîÑ'}</div>
                                        <div className="truncate opacity-95">{event.title}</div>
                                      </div>
                                    </div>
                                  );
                                }
                                
                                return (
                                  <Draggable key={dragId} draggableId={dragId} index={eventIdx}>
                                    {(dragProv, dragSnap) => (
                                      <>
                                        <div
                                          ref={dragProv.innerRef}
                                          {...dragProv.draggableProps}
                                          {...dragProv.dragHandleProps}
                                          onClick={(e) => {
                                            if (!dragSnap.isDragging) {
                                              e.stopPropagation();
                                              handleEventClick(event);
                                            }
                                          }}
                                          className={`
                                            ${getEventColor(event, day)} text-white text-xs px-2 py-1.5 rounded-md border-l-4
                                            cursor-grab active:cursor-grabbing flex items-center gap-1.5
                                            ${getEventTextStyle(event)}
                                            ${dragSnap.isDragging ? 'shadow-2xl scale-110 ring-2 ring-white/50 opacity-90' : 'hover:shadow-lg hover:scale-105 transition-all'}
                                          `}
                                          style={{
                                            ...dragProv.draggableProps.style,
                                            opacity: dragSnap.isDragging ? 1 : undefined,
                                          }}
                                        >
                                          <GripVertical className="w-3 h-3 opacity-60 flex-shrink-0" />
                                          {getEventIcon(event.type)}
                                          <div className="flex-1 min-w-0">
                                            <div className="font-semibold truncate">{event.time}</div>
                                            <div className="truncate opacity-95">{event.title}</div>
                                          </div>
                                        </div>
                                        {dragSnap.isDragging && (
                                          <div className={`${getEventColor(event, day)} text-white text-xs px-2 py-1.5 rounded-md border-l-4 opacity-30 flex items-center gap-1.5`}>
                                            <GripVertical className="w-3 h-3 opacity-60 flex-shrink-0" />
                                            {getEventIcon(event.type)}
                                            <div className="flex-1 min-w-0">
                                              <div className="font-semibold truncate">{event.time}</div>
                                              <div className="truncate opacity-95">{event.title}</div>
                                            </div>
                                          </div>
                                        )}
                                      </>
                                    )}
                                  </Draggable>
                                );
                              })}
                              {provided.placeholder}
                              {dayEvents.length > 3 && (
                                <div 
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setCurrentDate(day);
                                    setViewMode('day');
                                  }}
                                  className="text-xs text-slate-500 dark:text-slate-400 px-2 font-medium hover:text-indigo-600 cursor-pointer"
                                >
                                  +{dayEvents.length - 3} more
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </Droppable>
                    );
                  })}
                </div>
              </div>
            )}

            {viewMode === 'week' && (
              <div className="h-full flex flex-col">
                {/* Day Headers */}
                <div className="flex border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
                  <div className="w-16 flex-shrink-0" />
                  {Array.from({ length: 7 }, (_, i) => {
                    const day = addDays(startOfWeek(currentDate, { weekStartsOn: 0 }), i);
                    const isCurrentDay = isToday(day);

                    return (
                      <div key={i} className="flex-1 text-center py-2 border-r border-slate-200 dark:border-slate-700 last:border-r-0">
                        <div className="text-xs text-slate-500 dark:text-slate-400">
                          {format(day, 'EEE')}
                        </div>
                        <div className={`text-2xl font-light ${isCurrentDay ? 'text-indigo-600 font-semibold' : 'text-slate-700 dark:text-slate-200'}`}>
                          {format(day, 'd')}
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Time Grid */}
                <div ref={timeGridRef} className="flex-1 overflow-auto">
                  <div className="flex">
                    {/* Time Column */}
                    <div className="w-16 flex-shrink-0 border-r border-slate-200 dark:border-slate-700">
                      {Array.from({ length: 24 }, (_, hour) => (
                        <div key={hour} className="h-16 border-b border-slate-200 dark:border-slate-700">
                          <div className="px-2 pt-1 h-4">
                            <span className="text-xs text-slate-500 font-medium">{format(new Date().setHours(hour, 0), 'ha')}</span>
                          </div>
                          <div className="h-4 border-t border-slate-100 dark:border-slate-800" />
                          <div className="h-4 border-t border-slate-100 dark:border-slate-800" />
                          <div className="h-4 border-t border-slate-100 dark:border-slate-800" />
                        </div>
                      ))}
                    </div>

                    {/* Days Columns */}
                    {Array.from({ length: 7 }, (_, i) => {
                      const day = addDays(startOfWeek(currentDate, { weekStartsOn: 0 }), i);
                      const dayEvents = getEventsForDate(day);
                      const dateStr = format(day, 'yyyy-MM-dd');

                      return (
                        <Droppable droppableId={dateStr} key={dateStr}>
                          {(provided, snapshot) => (
                            <div
                              ref={provided.innerRef}
                              {...provided.droppableProps}
                              className={`flex-1 min-w-0 border-r border-slate-200 dark:border-slate-700 last:border-r-0 relative ${snapshot.isDraggingOver ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}`}
                            >
                              {Array.from({ length: 24 }, (_, hour) => {
                                const timeStr = `${hour.toString().padStart(2, '0')}:00`;
                                return (
                                <div
                                  key={hour}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const rect = e.currentTarget.getBoundingClientRect();
                                    setQuickCreateMenu({
                                      x: Math.min(rect.left, window.innerWidth - 200),
                                      y: Math.min(rect.top, window.innerHeight - 250),
                                      date: dateStr,
                                      time: timeStr
                                    });
                                  }}
                                  onDragOver={(e) => {
                                    e.preventDefault();
                                    e.currentTarget.classList.add('bg-indigo-100', 'dark:bg-indigo-900/30');
                                    setDragHoverInfo({
                                      date: dateStr,
                                      time: timeStr,
                                      title: `${format(day, 'MMM d')} at ${timeStr}`,
                                      x: e.clientX,
                                      y: e.clientY
                                    });
                                  }}
                                  onDragLeave={(e) => {
                                    e.currentTarget.classList.remove('bg-indigo-100', 'dark:bg-indigo-900/30');
                                  }}
                                  onDrop={async (e) => {
                                    e.preventDefault();
                                    e.currentTarget.classList.remove('bg-indigo-100', 'dark:bg-indigo-900/30');
                                    setDragHoverInfo(null);
                                    try {
                                      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                      let formattedDate = 'selected date';
                                      try {
                                        formattedDate = format(day, 'MMM d');
                                      } catch (err) {
                                        formattedDate = dateStr;
                                      }

                                      if (data.type === 'task') {
                                        await base44.entities.Task.update(data.id, { due_date: dateStr, due_time: timeStr });
                                        queryClient.invalidateQueries(['tasks']);
                                        toast.success(`Task moved to ${formattedDate} at ${timeStr}`);
                                      } else if (data.type === 'appointment') {
                                        await base44.entities.Appointment.update(data.id, { scheduled_date: dateStr, scheduled_time: timeStr });
                                        queryClient.invalidateQueries(['appointments']);
                                        toast.success(`Appointment moved to ${formattedDate} at ${timeStr}`);
                                      } else if (data.type === 'showing') {
                                        await base44.entities.Showing.update(data.id, { scheduled_date: dateStr, scheduled_time: timeStr });
                                        queryClient.invalidateQueries(['showings']);
                                        toast.success(`Showing moved to ${formattedDate} at ${timeStr}`);
                                      } else if (data.type === 'open_house') {
                                        await base44.entities.OpenHouse.update(data.id, { date: dateStr, start_time: timeStr });
                                        queryClient.invalidateQueries(['openHouses']);
                                        toast.success(`Open house moved to ${formattedDate} at ${timeStr}`);
                                      }
                                    } catch (error) {
                                      console.error('Drop error:', error);
                                      toast.error('Failed to move event');
                                    }
                                  }}
                                  className="h-16 border-b border-slate-100 dark:border-slate-800 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors"
                                />
                              );
                              })}

                              {/* Events Overlay - positioned absolutely with overlap handling */}
                              {(() => {
                                // Group events by 15-minute time slots
                                const eventsBySlot = {};
                                dayEvents.forEach((event) => {
                                  const [hours, minutes] = (event.time || '09:00').split(':');
                                  const slot = (parseInt(hours) * 4) + Math.floor(parseInt(minutes) / 15);
                                  if (!eventsBySlot[slot]) eventsBySlot[slot] = [];
                                  eventsBySlot[slot].push(event);
                                });

                                return dayEvents.map((event) => {
                                  const [hours, minutes] = (event.time || '09:00').split(':');
                                  const hourKey = parseInt(hours);
                                  const slot = (hourKey * 4) + Math.floor(parseInt(minutes) / 15);
                                  const topPosition = slot * 16;
                                  const canDrag = event.type !== 'holiday' && !event.isRecurringInstance;
                                  const dragId = `${event.type}::${event.id}`;

                                  // Calculate position for overlapping events
                                  const eventsAtSameTime = eventsBySlot[slot] || [];
                                  const eventIndex = eventsAtSameTime.findIndex(e => e.id === event.id);
                                  const totalOverlapping = eventsAtSameTime.length;
                                  const widthPercent = totalOverlapping > 1 ? (100 / totalOverlapping) : 100;
                                  const leftPercent = eventIndex * widthPercent;

                                  if (!canDrag) {
                                    return (
                                      <div
                                        key={`${event.type}-${event.id}`}
                                        onClick={() => handleEventClick(event)}
                                        className={`absolute ${getEventColor(event, day)} text-white p-1.5 rounded-md border-l-4 cursor-pointer hover:shadow-lg hover:z-20 transition-all`}
                                        style={{ 
                                          top: `${topPosition}px`, 
                                          minHeight: '48px', 
                                          zIndex: 10 + eventIndex,
                                          left: `${leftPercent}%`,
                                          width: `calc(${widthPercent}% - 4px)`,
                                          marginLeft: '2px'
                                        }}
                                      >
                                        <div className={`text-xs font-semibold truncate ${getEventTextStyle(event)}`}>
                                          {event.title}{event.data?.is_recurring && ' üîÑ'}
                                        </div>
                                        <div className="text-xs opacity-90">{event.time}</div>
                                      </div>
                                    );
                                  }

                                  return (
                                    <div
                                      key={dragId}
                                      draggable
                                      onDragStart={(e) => {
                                        e.dataTransfer.setData('text/plain', JSON.stringify({ 
                                          type: event.type, 
                                          id: event.id,
                                          originalDate: dateStr
                                        }));
                                        e.dataTransfer.effectAllowed = 'move';
                                      }}
                                      onClick={() => handleEventClick(event)}
                                      className={`absolute ${getEventColor(event, day)} text-white p-1.5 rounded-md border-l-4 cursor-grab active:cursor-grabbing hover:shadow-lg hover:z-20 transition-all`}
                                      style={{ 
                                        top: `${topPosition}px`, 
                                        minHeight: '48px',
                                        zIndex: 10 + eventIndex,
                                        left: `${leftPercent}%`,
                                        width: `calc(${widthPercent}% - 4px)`,
                                        marginLeft: '2px'
                                      }}
                                    >
                                      <div className="flex items-center gap-1">
                                        <GripVertical className="w-3 h-3 opacity-60 flex-shrink-0" />
                                        <div className={`text-xs font-semibold truncate ${getEventTextStyle(event)}`}>{event.title}</div>
                                      </div>
                                      <div className="text-xs opacity-90 ml-4">{event.time}</div>
                                    </div>
                                  );
                                });
                              })()}
                              <div style={{ display: 'none' }}>{provided.placeholder}</div>
                            </div>
                          )}
                        </Droppable>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}

            {viewMode === 'day' && (
              <div ref={timeGridRef} className="h-full overflow-auto">
                <div className="flex">
                  {/* Time Column */}
                  <div className="w-20 flex-shrink-0 border-r border-slate-200 dark:border-slate-700">
                    {Array.from({ length: 24 }, (_, hour) => (
                      <div key={hour} className="h-20 border-b border-slate-200 dark:border-slate-700 px-3 pt-2">
                        <span className="text-sm text-slate-500">{format(new Date().setHours(hour, 0), 'h a')}</span>
                      </div>
                    ))}
                  </div>

                  {/* Day Column - Droppable */}
                  <Droppable droppableId={format(currentDate, 'yyyy-MM-dd')}>
                    {(provided, snapshot) => (
                      <div
                        ref={provided.innerRef}
                        {...provided.droppableProps}
                        className={`flex-1 relative ${snapshot.isDraggingOver ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}`}
                      >
                        {Array.from({ length: 96 }, (_, slot) => {
                          const hour = Math.floor(slot / 4);
                          const minute = (slot % 4) * 15;
                          const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

                          return (
                            <div
                              key={slot}
                              onClick={(e) => {
                                e.stopPropagation();
                                const rect = e.currentTarget.getBoundingClientRect();
                                setQuickCreateMenu({
                                  x: Math.min(rect.left, window.innerWidth - 200),
                                  y: Math.min(rect.top, window.innerHeight - 250),
                                  date: format(currentDate, 'yyyy-MM-dd'),
                                  time: timeStr
                                });
                              }}
                              onDragOver={(e) => {
                                e.preventDefault();
                                e.currentTarget.classList.add('bg-indigo-100', 'dark:bg-indigo-900/30');
                                const currentDateStr = format(currentDate, 'yyyy-MM-dd');
                                setDragHoverInfo({
                                  date: currentDateStr,
                                  time: timeStr,
                                  title: `${format(currentDate, 'MMM d')} at ${timeStr}`,
                                  x: e.clientX,
                                  y: e.clientY
                                });
                              }}
                              onDragLeave={(e) => {
                                e.currentTarget.classList.remove('bg-indigo-100', 'dark:bg-indigo-900/30');
                              }}
                              onDrop={async (e) => {
                                e.preventDefault();
                                e.currentTarget.classList.remove('bg-indigo-100', 'dark:bg-indigo-900/30');
                                setDragHoverInfo(null);
                                try {
                                  const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                  const dateStr = format(currentDate, 'yyyy-MM-dd');
                                  let formattedDate = 'selected date';
                                  try {
                                    formattedDate = format(currentDate, 'MMM d');
                                  } catch (err) {
                                    formattedDate = dateStr;
                                  }

                                  if (data.type === 'task') {
                                    await base44.entities.Task.update(data.id, { due_date: dateStr, due_time: timeStr });
                                    queryClient.invalidateQueries(['tasks']);
                                    toast.success(`Task moved to ${formattedDate} at ${timeStr}`);
                                  } else if (data.type === 'appointment') {
                                    await base44.entities.Appointment.update(data.id, { scheduled_date: dateStr, scheduled_time: timeStr });
                                    queryClient.invalidateQueries(['appointments']);
                                    toast.success(`Appointment moved to ${formattedDate} at ${timeStr}`);
                                  } else if (data.type === 'showing') {
                                    await base44.entities.Showing.update(data.id, { scheduled_date: dateStr, scheduled_time: timeStr });
                                    queryClient.invalidateQueries(['showings']);
                                    toast.success(`Showing moved to ${formattedDate} at ${timeStr}`);
                                  } else if (data.type === 'open_house') {
                                    await base44.entities.OpenHouse.update(data.id, { date: dateStr, start_time: timeStr });
                                    queryClient.invalidateQueries(['openHouses']);
                                    toast.success(`Open house moved to ${formattedDate} at ${timeStr}`);
                                  }
                                } catch (error) {
                                  console.error('Drop error:', error);
                                  toast.error('Failed to move event');
                                }
                              }}
                              className="h-5 border-b border-slate-100 dark:border-slate-800 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors"
                            />
                          );
                        })}

                        {/* Events - with proper overlap handling like Google Calendar */}
                        {(() => {
                          // Calculate event durations and detect overlaps
                          const eventsWithLayout = currentDayEvents.map((event) => {
                            const [startHours, startMinutes] = (event.time || '09:00').split(':').map(Number);
                            const startSlot = (startHours * 4) + Math.floor(startMinutes / 15);
                            
                            // Calculate duration
                            let durationSlots = 2; // Default 30 minutes (2 slots of 15 min each)
                            if (event.data?.duration_minutes) {
                              durationSlots = Math.ceil(event.data.duration_minutes / 15);
                            } else if (event.type === 'task' && event.data?.due_end_time) {
                              const [endHours, endMinutes] = event.data.due_end_time.split(':').map(Number);
                              const endSlot = (endHours * 4) + Math.floor(endMinutes / 15);
                              durationSlots = endSlot - startSlot || 2;
                            } else if (event.type === 'appointment' && event.data?.scheduled_end_time) {
                              const [endHours, endMinutes] = event.data.scheduled_end_time.split(':').map(Number);
                              const endSlot = (endHours * 4) + Math.floor(endMinutes / 15);
                              durationSlots = endSlot - startSlot || 4;
                            } else if (event.type === 'open_house' && event.data?.end_time) {
                              const [endHours, endMinutes] = event.data.end_time.split(':').map(Number);
                              const endSlot = (endHours * 4) + Math.floor(endMinutes / 15);
                              durationSlots = endSlot - startSlot || 12;
                            } else if (event.type === 'showing' && event.data?.scheduled_end_time) {
                              const [endHours, endMinutes] = event.data.scheduled_end_time.split(':').map(Number);
                              const endSlot = (endHours * 4) + Math.floor(endMinutes / 15);
                              durationSlots = endSlot - startSlot || 2;
                            }
                            
                            return {
                              ...event,
                              startSlot,
                              endSlot: startSlot + durationSlots,
                              durationSlots
                            };
                          });

                          // Improved overlap detection and column assignment
                          const eventsWithColumns = [];
                          
                          // Sort events by start time, then by duration (longer first)
                          const sortedEvents = [...eventsWithLayout].sort((a, b) => {
                            if (a.startSlot !== b.startSlot) return a.startSlot - b.startSlot;
                            return b.durationSlots - a.durationSlots;
                          });
                          
                          // Assign columns using a better algorithm
                          sortedEvents.forEach((event) => {
                            // Find all events that overlap with this one
                            const overlapping = eventsWithColumns.filter(other => {
                              return event.startSlot < other.endSlot && event.endSlot > other.startSlot;
                            });
                            
                            // Find used columns
                            const usedColumns = overlapping.map(e => e.column);
                            
                            // Find first available column
                            let column = 0;
                            while (usedColumns.includes(column)) {
                              column++;
                            }
                            
                            eventsWithColumns.push({
                              ...event,
                              column
                            });
                          });
                          
                          // Calculate maxColumns for each overlap group
                          eventsWithColumns.forEach((event, idx) => {
                            const overlapping = eventsWithColumns.filter((other) => {
                              return event.startSlot < other.endSlot && event.endSlot > other.startSlot;
                            });
                            
                            const maxColumns = Math.max(
                              event.column + 1,
                              ...overlapping.map(e => e.column + 1)
                            );
                            
                            event.maxColumns = maxColumns;
                          });

                          return eventsWithColumns.map((event, eventIndex) => {
                            const topPosition = event.startSlot * 20;
                            const height = event.durationSlots * 20;
                            const canDrag = event.type !== 'holiday' && !event.isRecurringInstance;
                            const dragId = `${event.type}::${event.id}`;

                            // Calculate position based on column
                            const widthPercent = 100 / event.maxColumns;
                            const leftPercent = event.column * widthPercent;

                            if (!canDrag) {
                              const travelInfo = travelTimes[event.id];
                              const fullAddress = event.location_address || event.location || event.data?.location_address;
                              
                              return (
                                <div
                                  key={`${event.type}-${event.id}`}
                                  onClick={() => handleEventClick(event)}
                                  className={`absolute ${getEventColor(event, currentDate)} text-white rounded-lg border-l-4 cursor-pointer hover:shadow-xl transition-all flex flex-col`}
                                  style={{ 
                                    top: `${topPosition}px`, 
                                    height: `${Math.max(height, 60)}px`,
                                    zIndex: 50 + event.column,
                                    left: `calc(${leftPercent}% + 2px)`,
                                    width: `calc(${widthPercent}% - 4px)`,
                                    padding: '8px'
                                  }}
                                >
                                  <div className="flex-1 min-w-0 overflow-hidden">
                                    <div className={`font-semibold text-sm mb-1 truncate ${getEventTextStyle(event)}`}>
                                      {event.title}{event.data?.is_recurring && ' üîÑ'}
                                    </div>
                                    <div className="text-xs opacity-90 mb-1">{event.time}</div>
                                    {fullAddress && (
                                      <div className="text-xs opacity-90 flex items-start gap-1 mb-1">
                                        <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5" />
                                        <span className="line-clamp-2 break-words">{fullAddress}</span>
                                      </div>
                                    )}
                                    {travelInfo && fullAddress && (
                                      <div className="text-[10px] bg-white/20 px-2 py-1 rounded-md backdrop-blur-sm mt-1 flex items-center justify-center gap-2">
                                        <span className="font-semibold">üöó {travelInfo.duration}</span>
                                        <span className="opacity-80">‚Ä¢ {travelInfo.distance}</span>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              );
                            }

                            const travelInfo = travelTimes[event.id];
                            const fullAddress = event.location_address || event.location || event.data?.location_address;
                            
                            return (
                              <div
                                key={dragId}
                                draggable
                                onDragStart={(e) => {
                                  e.dataTransfer.setData('text/plain', JSON.stringify({ 
                                    type: event.type, 
                                    id: event.id,
                                    originalDate: format(currentDate, 'yyyy-MM-dd')
                                  }));
                                  e.dataTransfer.effectAllowed = 'move';
                                }}
                                onClick={() => handleEventClick(event)}
                                className={`absolute ${getEventColor(event, currentDate)} text-white rounded-lg border-l-4 cursor-grab active:cursor-grabbing hover:shadow-xl transition-all flex flex-col`}
                                style={{ 
                                  top: `${topPosition}px`, 
                                  height: `${Math.max(height, 60)}px`,
                                  zIndex: 50 + event.column,
                                  left: `calc(${leftPercent}% + 2px)`,
                                  width: `calc(${widthPercent}% - 4px)`,
                                  padding: '8px'
                                }}
                              >
                                <div className="flex-1 min-w-0 overflow-hidden">
                                  <div className="flex items-center gap-1.5 mb-1">
                                    <GripVertical className="w-3.5 h-3.5 opacity-60 flex-shrink-0" />
                                    <div className={`font-semibold text-sm truncate ${getEventTextStyle(event)}`}>
                                      {event.title}
                                    </div>
                                  </div>
                                  <div className="text-xs opacity-90 ml-5 mb-1">{event.time}</div>
                                  {fullAddress && (
                                    <div className="text-xs opacity-90 ml-5 flex items-start gap-1 mb-1">
                                      <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5" />
                                      <span className="line-clamp-2 break-words">{fullAddress}</span>
                                    </div>
                                  )}
                                  {travelInfo && fullAddress && (
                                    <div className="text-[10px] bg-white/20 px-2 py-1 rounded-md backdrop-blur-sm mt-1 ml-5 flex items-center justify-center gap-2">
                                      <span className="font-semibold">üöó {travelInfo.duration}</span>
                                      <span className="opacity-80">‚Ä¢ {travelInfo.distance}</span>
                                    </div>
                                  )}
                                </div>
                              </div>
                            );
                          });
                        })()}
                        <div style={{ display: 'none' }}>{provided.placeholder}</div>
                      </div>
                    )}
                  </Droppable>
                </div>
              </div>
            )}
            </div>
          </DragDropContext>
        </div>
      </div>

      {/* Search Results Dropdown - Positioned absolutely at top level */}
      {showSearchResults && searchResults.length > 0 && (
        <div 
          className="fixed w-96 max-h-96 overflow-y-auto bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700"
          style={{ 
            top: '140px', 
            right: '24px',
            zIndex: 999999
          }}
        >
          <div className="p-3 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
            <p className="text-xs font-semibold text-slate-600 dark:text-slate-400">
              {searchResults.length} result{searchResults.length !== 1 ? 's' : ''} found
            </p>
          </div>
          <div className="py-2">
            {searchResults.map((event) => {
              const property = properties.find(p => p.id === event.property_id);
              return (
                <button
                  key={`search-${event.type}-${event.id}`}
                  onClick={(e) => handleSearchResultClick(event, e)}
                  onMouseDown={(e) => e.stopPropagation()}
                  className="w-full px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors text-left border-b border-slate-100 dark:border-slate-800 last:border-b-0"
                >
                  <div className="flex items-start gap-3">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-white flex-shrink-0 ${
                      event.type === 'task' ? 'bg-cyan-500' :
                      event.type === 'appointment' ? 'bg-pink-500' :
                      event.type === 'showing' ? 'bg-emerald-500' :
                      event.type === 'open_house' ? 'bg-violet-500' : 'bg-slate-500'
                    }`}>
                      {getEventIcon(event.type)}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-sm text-slate-900 dark:text-white truncate">
                        {event.title}
                      </p>
                      <p className="text-xs text-slate-600 dark:text-slate-400 mt-0.5">
                        {(() => {
                          try {
                            const date = parseISO(event.date);
                            return isNaN(date.getTime()) ? 'Invalid date' : `${format(date, 'MMM d, yyyy')} at ${event.time}`;
                          } catch (e) {
                            return 'Invalid date';
                          }
                        })()} 
                      </p>
                      {(property || event.location || event.client_name || event.buyer_name) && (
                        <p className="text-xs text-slate-500 dark:text-slate-500 mt-1 truncate">
                          {property?.address || event.location || event.client_name || event.buyer_name}
                        </p>
                      )}
                    </div>
                    <Badge 
                      variant="outline" 
                      className="text-[10px] capitalize flex-shrink-0"
                    >
                      {event.type.replace('_', ' ')}
                    </Badge>
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      )}

      {/* Empty Search Results */}
      {showSearchResults && searchQuery && searchResults.length === 0 && (
        <div 
          className="fixed w-96 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 p-8 text-center"
          style={{ 
            top: '140px', 
            right: '24px',
            zIndex: 999999
          }}
        >
          <Search className="w-12 h-12 text-slate-300 mx-auto mb-3" />
          <p className="text-sm text-slate-600 dark:text-slate-400">No events found</p>
          <p className="text-xs text-slate-500 dark:text-slate-500 mt-1">Try different keywords</p>
        </div>
      )}

      {/* Quick Create Menu */}
      {quickCreateMenu && (
        <div 
          className="fixed z-50 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 py-2 min-w-52 backdrop-blur-sm"
          style={{ left: quickCreateMenu.x, top: quickCreateMenu.y }}
          onClick={(e) => e.stopPropagation()}
        >
          <div className="px-4 py-2.5 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-slate-50 to-white dark:from-slate-800 dark:to-slate-700 rounded-t-xl">
            <p className="text-xs font-semibold text-slate-600 dark:text-slate-300">
              üìÖ {(() => {
                try {
                  const date = parseISO(quickCreateMenu.date);
                  return isNaN(date.getTime()) ? quickCreateMenu.date : format(date, 'MMM d, yyyy');
                } catch (e) {
                  return quickCreateMenu.date;
                }
              })()}
              {quickCreateMenu.time && <span className="text-indigo-500"> at {quickCreateMenu.time}</span>}
            </p>
          </div>
          <button
            onClick={() => {
              setEditingEvent({ scheduled_date: quickCreateMenu.date, scheduled_time: quickCreateMenu.time || '09:00' });
              setEventType('appointment');
              setShowEventModal(true);
              setQuickCreateMenu(null);
            }}
            className="w-full px-3 py-2.5 text-left text-sm hover:bg-gradient-to-r hover:from-pink-50 hover:to-rose-50 dark:hover:from-pink-900/20 dark:hover:to-rose-900/20 flex items-center gap-3 transition-all"
          >
            <div className="w-7 h-7 rounded-lg bg-gradient-to-r from-pink-400 to-rose-600 flex items-center justify-center text-white shadow-md">
              <CalendarIcon className="w-3.5 h-3.5" />
            </div>
            <span className="font-medium">New Appointment</span>
          </button>
          <button
            onClick={() => {
              setEditingEvent({ due_date: quickCreateMenu.date, due_time: quickCreateMenu.time || '09:00' });
              setEventType('task');
              setShowEventModal(true);
              setQuickCreateMenu(null);
            }}
            className="w-full px-3 py-2.5 text-left text-sm hover:bg-gradient-to-r hover:from-cyan-50 hover:to-blue-50 dark:hover:from-cyan-900/20 dark:hover:to-blue-900/20 flex items-center gap-3 transition-all"
          >
            <div className="w-7 h-7 rounded-lg bg-gradient-to-r from-cyan-400 to-blue-500 flex items-center justify-center text-white shadow-md">
              <CheckSquare className="w-3.5 h-3.5" />
            </div>
            <span className="font-medium">New Task</span>
          </button>
          <button
            onClick={() => {
              setEditingEvent({ date: quickCreateMenu.date, start_time: quickCreateMenu.time || '10:00' });
              setEventType('open_house');
              setShowEventModal(true);
              setQuickCreateMenu(null);
            }}
            className="w-full px-3 py-2.5 text-left text-sm hover:bg-gradient-to-r hover:from-violet-50 hover:to-purple-50 dark:hover:from-violet-900/20 dark:hover:to-purple-900/20 flex items-center gap-3 transition-all"
          >
            <div className="w-7 h-7 rounded-lg bg-gradient-to-r from-violet-400 to-purple-600 flex items-center justify-center text-white shadow-md">
              <Home className="w-3.5 h-3.5" />
            </div>
            <span className="font-medium">New Open House</span>
          </button>
          <button
            onClick={() => {
              setEditingEvent({ scheduled_date: quickCreateMenu.date, scheduled_time: quickCreateMenu.time || '14:00' });
              setEventType('showing');
              setShowEventModal(true);
              setQuickCreateMenu(null);
            }}
            className="w-full px-3 py-2.5 text-left text-sm hover:bg-gradient-to-r hover:from-emerald-50 hover:to-teal-50 dark:hover:from-emerald-900/20 dark:hover:to-teal-900/20 flex items-center gap-3 transition-all"
          >
            <div className="w-7 h-7 rounded-lg bg-gradient-to-r from-emerald-400 to-teal-600 flex items-center justify-center text-white shadow-md">
              <Eye className="w-3.5 h-3.5" />
            </div>
            <span className="font-medium">New Showing</span>
          </button>
        </div>
      )}

      {/* Enhanced Event Modal */}
      {showEventModal && (
        <EnhancedEventModal
          event={editingEvent}
          eventType={eventType}
          users={users}
          clients={[...clients, ...leads, ...buyers]}
          properties={properties}
          onSave={handleSaveEvent}
          onClose={() => {
            setShowEventModal(false);
            setEditingEvent(null);
          }}
          currentUser={user}
        />
      )}

      {/* Calendar Sync Modal */}
      {showSyncModal && (
        <CalendarSyncModal
          isOpen={showSyncModal}
          onClose={() => setShowSyncModal(false)}
          user={user}
          onSyncComplete={() => {
            queryClient.invalidateQueries(['appointments']);
          }}
        />
      )}

      {/* Event Notification Sound */}
      <EventNotificationSound events={calendarEvents} user={user} />

      {/* Event Template Manager */}
      {showTemplateManager && (
        <EventTemplateManager
          isOpen={showTemplateManager}
          onClose={() => setShowTemplateManager(false)}
          onSelectTemplate={(template) => {
            // Pre-fill event form with template data
            const eventData = {
              title: template.default_title,
              notes: template.default_notes,
              location_address: template.default_location,
              duration_minutes: template.default_duration_minutes,
              appointment_type: template.appointment_type,
              is_virtual: template.is_virtual,
              video_link: template.video_link_template,
              is_recurring: template.is_recurring,
              recurrence_pattern: template.recurrence_pattern,
              recurrence_days: template.recurrence_days,
              color: template.color
            };
            
            setEditingEvent(eventData);
            setEventType(template.event_type);
            setShowEventModal(true);
          }}
        />
      )}

      {/* Drag Hover Indicator - Live Time Display */}
      {dragHoverInfo && (
        <div 
          className="fixed z-[100] pointer-events-none"
          style={{ 
            left: dragHoverInfo.x + 20, 
            top: dragHoverInfo.y - 40,
            transform: 'translate(0, -50%)'
          }}
        >
          <div className="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-4 py-3 rounded-xl shadow-2xl border-2 border-white/20 dark:border-slate-900/20 backdrop-blur-md">
            <div className="flex items-center gap-2">
              <Clock className="w-4 h-4" />
              <span className="font-bold text-sm whitespace-nowrap">{dragHoverInfo.title}</span>
            </div>
          </div>
          <div className="absolute -bottom-2 left-6 w-3 h-3 bg-slate-900 dark:bg-white transform rotate-45 border-r-2 border-b-2 border-white/20 dark:border-slate-900/20"></div>
        </div>
      )}
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery } from "@tanstack/react-query";
import GlobalChatInterface from "../components/chat/GlobalChatInterface";
import LoadingSpinner from "../components/common/LoadingSpinner";
import { MessageSquare } from "lucide-react";

export default function ChatPage() {
  const [currentUser, setCurrentUser] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    loadUser();
  }, []);

  const loadUser = async () => {
    try {
      const user = await base44.auth.me();
      setCurrentUser(user);
    } catch (error) {
      console.error("Error loading user:", error);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <LoadingSpinner 
        icon={MessageSquare} 
        title="Loading Chat..." 
        description="Preparing your conversations"
      />
    );
  }

  if (!currentUser) {
    return (
      <div className="p-8 text-center">
        <p className="text-slate-500">Please log in to access chat</p>
      </div>
    );
  }

  return (
    <div className="h-[calc(100vh-80px)] p-6">
      <div className="max-w-7xl mx-auto h-full">
        <div className="mb-6">
          <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Real-Time Chat</h1>
          <p className="text-slate-600 dark:text-slate-400 mt-1">
            Communicate with clients, agents, and team members instantly
          </p>
        </div>
        
        <GlobalChatInterface currentUser={currentUser} />
      </div>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import {
  Home,
  FileText,
  MessageSquare,
  Calendar,
  User,
  Bell,
  Settings,
  CheckCircle2,
  TrendingUp,
  Mail,
  Phone,
  ArrowRight,
  AlertCircle,
  Loader2,
  Shield,
  Building2,
  DollarSign
} from "lucide-react";
import { toast } from "sonner";
import NextTaskAdvice from '../components/client/NextTaskAdvice';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { MessageCircle, Lightbulb } from "lucide-react";

export default function ClientDashboard() {
  const navigate = useNavigate();
  const [user, setUser] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [properties, setProperties] = useState([]);
  const [documents, setDocuments] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [messages, setMessages] = useState([]);
  const [agent, setAgent] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [showFeedbackPrompt, setShowFeedbackPrompt] = useState(false);

  useEffect(() => {
    loadClientData();
  }, []);

  // Check if monthly feedback prompt should show
  useEffect(() => {
    if (!user) return;

    const lastFeedbackPromptDate = localStorage.getItem(`lastFeedbackPrompt_${user.id}`);
    const now = new Date();
    
    if (!lastFeedbackPromptDate) {
      // First time - show after 2 seconds
      setTimeout(() => setShowFeedbackPrompt(true), 2000);
      localStorage.setItem(`lastFeedbackPrompt_${user.id}`, now.toISOString());
    } else {
      const lastPrompt = new Date(lastFeedbackPromptDate);
      const daysSinceLastPrompt = Math.floor((now - lastPrompt) / (1000 * 60 * 60 * 24));
      
      // Show every 30 days
      if (daysSinceLastPrompt >= 30) {
        setTimeout(() => setShowFeedbackPrompt(true), 2000);
        localStorage.setItem(`lastFeedbackPrompt_${user.id}`, now.toISOString());
      }
    }
  }, [user]);

  const loadClientData = async () => {
    setIsLoading(true);
    setError(null);
    
    try {
      const currentUser = await base44.auth.me();
      setUser(currentUser);

      // Load portal access to determine what client can see
      const portalAccess = await base44.entities.ClientPortalAccess.filter({ 
        client_user_id: currentUser.id,
        is_active: true 
      });

      if (portalAccess.length === 0) {
        setError("No portal access granted. Please contact your agent.");
        setIsLoading(false);
        return;
      }

      // Get accessible property IDs
      const propertyIds = [...new Set(portalAccess.map(a => a.property_id).filter(Boolean))];

      // Load all data based on portal access
      const [allProperties, allTransactions, allTasks, allDocuments, allMessages, allUsers] = await Promise.all([
        base44.entities.Property.list(),
        base44.entities.Transaction.list(),
        base44.entities.Task.list(),
        base44.entities.Document.list(),
        base44.entities.Message.list(),
        base44.entities.User.list()
      ]);

      // Filter to only accessible properties
      const userProperties = allProperties.filter(p => propertyIds.includes(p.id));
      setProperties(userProperties);

      // Filter transactions for accessible properties
      const userTransactions = allTransactions.filter(t => 
        t.property_id && propertyIds.includes(t.property_id)
      );
      setTransactions(userTransactions);

      // Get shared document IDs from portal access
      const sharedDocIds = new Set();
      portalAccess.forEach(access => {
        if (access.document_access) {
          try {
            const docIds = Array.isArray(access.document_access) 
              ? access.document_access 
              : JSON.parse(access.document_access);
            docIds.forEach(id => sharedDocIds.add(id));
          } catch (e) {
            console.error('Error parsing document_access:', e);
          }
        }
      });

      // Filter to only shared documents
      const userDocuments = allDocuments.filter(d => 
        sharedDocIds.has(d.id) ||
        (d.property_id && propertyIds.includes(d.property_id))
      );
      setDocuments(userDocuments);

      // Get tasks for accessible properties (categorized based on access type)
      const userTasks = allTasks.filter(t => {
        if (!t.property_id || !propertyIds.includes(t.property_id)) return false;
        
        // Get access type for this property
        const access = portalAccess.find(a => a.property_id === t.property_id);
        if (!access) return false;

        // Sellers see listing tasks
        if (access.access_type === 'seller') {
          return ['listing', 'marketing', 'documentation', 'inspection'].includes(t.task_type);
        }
        
        // Buyers see contract tasks
        if (access.access_type === 'buyer') {
          return ['contract', 'financing', 'closing'].includes(t.task_type);
        }
        
        return false;
      });
      setTasks(userTasks);

      // Get messages for user
      const userMessages = allMessages.filter(m => 
        m.recipient_id === currentUser.id || m.sender_id === currentUser.id
      ).sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
      setMessages(userMessages);

      // Get agent info from first accessible property/transaction
      if (userTransactions.length > 0) {
        const firstTransaction = userTransactions[0];
        const agentId = firstTransaction.listing_agent_id || firstTransaction.selling_agent_id;
        if (agentId) {
          const agentUser = allUsers.find(u => u.id === agentId);
          setAgent(agentUser);
        }
      } else if (userProperties.length > 0) {
        const firstProperty = userProperties[0];
        const agentId = firstProperty.listing_agent_id;
        if (agentId) {
          const agentUser = allUsers.find(u => u.id === agentId);
          setAgent(agentUser);
        }
      }

    } catch (error) {
      console.error("Error loading client data:", error);
      setError(error.message);
      toast.error("Failed to load dashboard data");
    }
    
    setIsLoading(false);
  };

  const getTransactionProgress = (transaction) => {
    if (!transaction) return 0;
    
    if (transaction.status === 'closed') return 100;
    if (transaction.status === 'pending') return 70;
    if (transaction.status === 'active') return 40;
    return 10;
  };

  const getNextMilestone = (transaction) => {
    if (!transaction) return null;
    
    const progress = getTransactionProgress(transaction);
    if (progress < 20) return "Offer Acceptance";
    if (progress < 40) return "Home Inspection";
    if (progress < 70) return "Financing Approval";
    if (progress < 85) return "Final Walkthrough";
    if (progress < 100) return "Closing";
    return "Complete!";
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100">
        <div className="text-center">
          <Loader2 className="w-16 h-16 mx-auto mb-4 animate-spin text-indigo-600" />
          <p className="text-slate-600">Loading your dashboard...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 p-4">
        <Card className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h2 className="text-2xl font-bold mb-2">Error Loading Dashboard</h2>
            <p className="text-slate-600 mb-6">{error}</p>
            <Button onClick={() => window.location.reload()}>
              Try Again
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (properties.length === 0 && transactions.length === 0) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 p-4">
        <Card className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <Shield className="w-8 h-8 text-indigo-600" />
            </div>
            <h2 className="text-2xl font-bold mb-2">Welcome to Your Client Portal</h2>
            <p className="text-slate-600 mb-6">
              Your agent hasn't granted you access to any properties yet. Once they share a property or transaction with you, it will appear here.
            </p>
            {agent && (
              <div className="mt-6 p-4 bg-indigo-50 rounded-lg">
                <p className="text-sm text-slate-700 mb-2">Your Agent:</p>
                <p className="font-bold">{agent.full_name}</p>
                {agent.email && (
                  <a href={`mailto:${agent.email}`} className="text-sm text-indigo-600 hover:underline flex items-center justify-center gap-1 mt-1">
                    <Mail className="w-3 h-3" />
                    {agent.email}
                  </a>
                )}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      {/* Header */}
      <div className="bg-white border-b shadow-sm">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center">
                <Home className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-xl font-bold text-slate-900">My Real Estate Dashboard</h1>
                <p className="text-sm text-slate-600">
                  Welcome back, {user?.full_name || 'Client'}
                </p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <Button variant="outline" size="icon">
                <Bell className="w-5 h-5" />
              </Button>
              <Button variant="outline" size="icon" onClick={() => navigate(createPageUrl("Settings"))}>
                <Settings className="w-5 h-5" />
              </Button>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
        {/* Next Task Advice */}
        {tasks.length > 0 && tasks.find(t => t.status === 'pending') && (
          <NextTaskAdvice nextTask={tasks.find(t => t.status === 'pending')} />
        )}

        {/* Active Properties & Transactions */}
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="text-2xl font-bold text-slate-900">Your Properties</h2>
            <Badge className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-1">
              <Shield className="w-3 h-3 mr-1" />
              Secure Portal
            </Badge>
          </div>
          
          {properties.map(property => {
            const propertyTransactions = transactions.filter(t => t.property_id === property.id);
            const activeTransaction = propertyTransactions.find(t => t.status === 'active' || t.status === 'pending');
            const progress = activeTransaction 
              ? (activeTransaction.listing_side_progress || 0 + activeTransaction.selling_side_progress || 0) / 2
              : 0;
            const propertyDocs = documents.filter(d => d.property_id === property.id);
            const propertyTasks = tasks.filter(t => t.property_id === property.id);
            const pendingTasks = propertyTasks.filter(t => t.status !== 'completed' && t.status !== 'cancelled');

            return (
              <Card 
                key={property.id} 
                className="border-l-4 border-l-indigo-600 hover:shadow-xl transition-all cursor-pointer group"
                onClick={() => {
                  if (activeTransaction) {
                    navigate(createPageUrl(`ClientTransactionDetail?id=${activeTransaction.id}`));
                  }
                }}
              >
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <Home className="w-5 h-5 text-indigo-600" />
                        <CardTitle className="text-lg">{property.address}</CardTitle>
                      </div>
                      <p className="text-sm text-slate-600">
                        {property.city}, {property.state} {property.zip_code}
                      </p>
                      <div className="flex items-center gap-2 mt-3">
                        <Badge variant="outline" className="text-xs">
                          {property.bedrooms || 0} bd
                        </Badge>
                        <Badge variant="outline" className="text-xs">
                          {property.bathrooms || 0} ba
                        </Badge>
                        {property.square_feet && (
                          <Badge variant="outline" className="text-xs">
                            {property.square_feet.toLocaleString()} sqft
                          </Badge>
                        )}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="text-2xl font-bold text-green-600 mb-1">
                        ${(property.price || 0).toLocaleString()}
                      </div>
                      <Badge className={
                        property.status === 'active' ? 'bg-green-500' :
                        property.status === 'pending' ? 'bg-yellow-500' :
                        property.status === 'sold' ? 'bg-blue-500' :
                        'bg-slate-500'
                      }>
                        {property.status}
                      </Badge>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  {activeTransaction && (
                    <div className="space-y-4">
                      <div>
                        <div className="flex justify-between items-center mb-2">
                          <span className="text-sm font-medium">Transaction Progress</span>
                          <span className="text-sm font-bold text-indigo-600">
                            {Math.round(progress)}%
                          </span>
                        </div>
                        <Progress value={progress} className="h-3" />
                      </div>

                      <div className="grid grid-cols-3 gap-3">
                        <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-center">
                          <FileText className="w-5 h-5 mx-auto mb-1 text-blue-600" />
                          <div className="font-bold text-lg">{propertyDocs.length}</div>
                          <div className="text-xs text-slate-600">Documents</div>
                        </div>
                        <div className="bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg text-center">
                          <CheckCircle2 className="w-5 h-5 mx-auto mb-1 text-amber-600" />
                          <div className="font-bold text-lg">{pendingTasks.length}</div>
                          <div className="text-xs text-slate-600">Pending Tasks</div>
                        </div>
                        <div className="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg text-center">
                          <DollarSign className="w-5 h-5 mx-auto mb-1 text-purple-600" />
                          <div className="font-bold text-sm">
                            ${(activeTransaction.contract_price || 0).toLocaleString()}
                          </div>
                          <div className="text-xs text-slate-600">Contract</div>
                        </div>
                      </div>
                    </div>
                  )}

                  {!activeTransaction && (
                    <div className="bg-slate-50 p-4 rounded-lg text-center">
                      <p className="text-sm text-slate-600">No active transaction</p>
                    </div>
                  )}

                  {activeTransaction && (
                    <Button 
                      onClick={(e) => {
                        e.stopPropagation();
                        navigate(createPageUrl(`ClientTransactionDetail?id=${activeTransaction.id}`));
                      }}
                      className="w-full mt-4 group-hover:bg-indigo-700 transition-colors"
                    >
                      View Deal Room
                      <ArrowRight className="w-4 h-4 ml-2" />
                    </Button>
                  )}
                </CardContent>
              </Card>
            );
          })}
        </div>

        {/* Quick Stats */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600 mb-1">Active Transactions</p>
                  <p className="text-3xl font-bold">{transactions.length}</p>
                </div>
                <TrendingUp className="w-8 h-8 text-indigo-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600 mb-1">Documents</p>
                  <p className="text-3xl font-bold">{documents.length}</p>
                </div>
                <FileText className="w-8 h-8 text-blue-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600 mb-1">Pending Tasks</p>
                  <p className="text-3xl font-bold">
                    {tasks.filter(t => t.status !== 'completed').length}
                  </p>
                </div>
                <CheckCircle2 className="w-8 h-8 text-green-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600 mb-1">Unread Messages</p>
                  <p className="text-3xl font-bold">
                    {messages.filter(m => !m.is_read && m.recipient_id === user?.id).length}
                  </p>
                </div>
                <MessageSquare className="w-8 h-8 text-purple-600" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Agent Info & Quick Actions */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Agent Card */}
          {agent && (
            <Card className="shadow-lg border-2 border-indigo-200">
              <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50">
                <CardTitle className="text-base flex items-center gap-2">
                  <User className="w-5 h-5 text-indigo-600" />
                  Your Agent
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-4">
                <div className="flex items-start gap-3 mb-4">
                  <div className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                    <User className="w-7 h-7 text-white" />
                  </div>
                  <div className="flex-1">
                    <h3 className="font-bold text-lg">{agent.full_name}</h3>
                    {agent.brokerage_name && (
                      <div className="flex items-center gap-1 text-sm text-slate-600 mt-1">
                        <Building2 className="w-3 h-3" />
                        {agent.brokerage_name}
                      </div>
                    )}
                    {agent.license_number && (
                      <p className="text-xs text-slate-500 mt-1">License: {agent.license_number}</p>
                    )}
                  </div>
                </div>

                <div className="space-y-2 mb-4">
                  {agent.email && (
                    <a href={`mailto:${agent.email}`} className="flex items-center gap-2 text-sm text-slate-600 hover:text-indigo-600 transition-colors p-2 rounded hover:bg-indigo-50">
                      <Mail className="w-4 h-4" />
                      {agent.email}
                    </a>
                  )}
                  {agent.phone && (
                    <a href={`tel:${agent.phone}`} className="flex items-center gap-2 text-sm text-slate-600 hover:text-indigo-600 transition-colors p-2 rounded hover:bg-indigo-50">
                      <Phone className="w-4 h-4" />
                      {agent.phone}
                    </a>
                  )}
                </div>

                <Button 
                  onClick={() => {
                    if (transactions.length > 0) {
                      navigate(createPageUrl(`ClientTransactionDetail?id=${transactions[0].id}`));
                    }
                  }}
                  className="w-full bg-gradient-to-r from-indigo-600 to-purple-600"
                  disabled={transactions.length === 0}
                >
                  <MessageSquare className="w-4 h-4 mr-2" />
                  Message Agent
                </Button>
              </CardContent>
            </Card>
          )}

          {/* Recent Activity */}
          <Card className="shadow-lg">
            <CardHeader>
              <CardTitle className="text-base">Recent Activity</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {documents.slice(0, 3).map(doc => (
                <div key={doc.id} className="flex items-center gap-3 p-2 rounded hover:bg-slate-50 transition-colors">
                  <FileText className="w-4 h-4 text-blue-600" />
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium truncate">{doc.document_name}</p>
                    <p className="text-xs text-slate-500">
                      {new Date(doc.created_date).toLocaleDateString()}
                    </p>
                  </div>
                </div>
              ))}
              {messages.slice(0, 2).map(msg => (
                <div key={msg.id} className="flex items-center gap-3 p-2 rounded hover:bg-slate-50 transition-colors">
                  <MessageSquare className="w-4 h-4 text-purple-600" />
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium truncate">{msg.subject || 'Message'}</p>
                    <p className="text-xs text-slate-500">
                      {new Date(msg.created_date).toLocaleDateString()}
                    </p>
                  </div>
                </div>
              ))}
              {documents.length === 0 && messages.length === 0 && (
                <p className="text-sm text-slate-500 text-center py-4">No recent activity</p>
              )}
            </CardContent>
          </Card>
        </div>
      </div>

      {/* Monthly Feedback Prompt Modal */}
      <Dialog open={showFeedbackPrompt} onOpenChange={setShowFeedbackPrompt}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2 text-xl">
              <MessageCircle className="w-6 h-6 text-indigo-600" />
              We'd Love Your Feedback!
            </DialogTitle>
            <DialogDescription className="text-base">
              Your opinion matters! Help us make your real estate experience even better.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-lg">
              <div className="flex items-start gap-3">
                <Lightbulb className="w-6 h-6 text-amber-500 flex-shrink-0 mt-1" />
                <div>
                  <p className="text-sm text-slate-700 mb-2">
                    Share what you love, report issues, or suggest new features that would make your experience better.
                  </p>
                  <p className="text-xs text-slate-500">
                    Takes less than 2 minutes ‚Ä¢ Your feedback drives improvements
                  </p>
                </div>
              </div>
            </div>
            
            <div className="flex gap-3">
              <Button
                variant="outline"
                onClick={() => setShowFeedbackPrompt(false)}
                className="flex-1"
              >
                Maybe Later
              </Button>
              <Button
                onClick={() => {
                  setShowFeedbackPrompt(false);
                  navigate(createPageUrl("FeedbackSuggestions"));
                }}
                className="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white"
              >
                <MessageCircle className="w-4 h-4 mr-2" />
                Share Feedback
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import {
  Home,
  FileText,
  MessageSquare,
  Search,
  Heart,
  Calendar,
  User,
  Bell,
  Settings,
  CheckCircle2,
  Clock,
  TrendingUp,
  Phone,
  Mail,
  ArrowRight,
  Download,
  Eye,
  AlertCircle
} from "lucide-react";
import { toast } from "sonner";

export default function ClientPortal() {
  const navigate = useNavigate();
  const [user, setUser] = useState(null);
  const [portalAccess, setPortalAccess] = useState(null);
  const [transaction, setTransaction] = useState(null);
  const [property, setProperty] = useState(null);
  const [agent, setAgent] = useState(null);
  const [documents, setDocuments] = useState([]);
  const [messages, setMessages] = useState([]);
  const [savedSearches, setSavedSearches] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [tasks, setTasks] = useState([]);
  const [error, setError] = useState(null);

  useEffect(() => {
    loadClientPortalData();
  }, []);

  const loadClientPortalData = async () => {
    setIsLoading(true);
    setError(null);
    
    try {
      const currentUser = await base44.auth.me();
      setUser(currentUser);

      // Check if user has client portal access
      const allAccess = await base44.entities.ClientPortalAccess.list();
      const accessData = allAccess.filter(a => 
        a.client_user_id === currentUser.id && a.is_active
      );

      if (accessData && accessData.length > 0) {
        const access = accessData[0];
        setPortalAccess(access);

        // Load transaction if exists
        if (access.transaction_id) {
          try {
            const allTransactions = await base44.entities.Transaction.list();
            const transactionData = allTransactions.find(t => t.id === access.transaction_id);
            if (transactionData) {
              setTransaction(transactionData);
            }
          } catch (err) {
            console.error("Error loading transaction:", err);
          }
        }

        // Load property if exists
        if (access.property_id) {
          try {
            const allProperties = await base44.entities.Property.list();
            const propertyData = allProperties.find(p => p.id === access.property_id);
            if (propertyData) {
              setProperty(propertyData);
            }
          } catch (err) {
            console.error("Error loading property:", err);
          }
        }

        // Load agent info
        if (access.agent_id) {
          try {
            const allUsers = await base44.entities.User.list();
            const agentData = allUsers.find(u => u.id === access.agent_id);
            if (agentData) {
              setAgent(agentData);
            }
          } catch (err) {
            console.error("Error loading agent:", err);
          }
        }

        // Load documents client can access
        if (access.document_access && access.document_access.length > 0) {
          try {
            const docs = await base44.entities.Document.list();
            const accessibleDocs = docs.filter(d => 
              access.document_access.includes(d.id)
            );
            setDocuments(accessibleDocs);
          } catch (err) {
            console.error("Error loading documents:", err);
          }
        }

        // Load messages
        try {
          const allMessages = await base44.entities.Message.list();
          const userMessages = allMessages.filter(m => 
            m.recipient_id === currentUser.id
          ).sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
          setMessages(userMessages);
        } catch (err) {
          console.error("Error loading messages:", err);
        }

        // Load saved searches (for buyers)
        if (access.access_type === 'buyer' || access.access_type === 'both') {
          try {
            const allSearches = await base44.entities.SavedSearch.list();
            const searches = allSearches.filter(s => 
              s.user_id === currentUser.id && s.is_active
            );
            setSavedSearches(searches);
          } catch (err) {
            console.error("Error loading saved searches:", err);
          }
        }

        // Load client-visible tasks
        if (access.property_id) {
          try {
            const allTasks = await base44.entities.Task.list();
            const tasksData = allTasks.filter(t => 
              t.property_id === access.property_id
            );
            setTasks(tasksData);
          } catch (err) {
            console.error("Error loading tasks:", err);
          }
        }
      }
    } catch (error) {
      console.error("Error loading client portal:", error);
      setError(error.message);
      toast.error("Failed to load portal data");
    }
    
    setIsLoading(false);
  };

  const getTransactionProgress = () => {
    if (!transaction) return 0;
    
    // Simple progress based on status
    if (transaction.status === 'closed') return 100;
    if (transaction.status === 'pending') return 70;
    if (transaction.status === 'active') return 40;
    return 10;
  };

  const getNextMilestone = () => {
    if (!transaction) return null;
    
    const progress = getTransactionProgress();
    if (progress < 20) return "Offer Acceptance";
    if (progress < 40) return "Home Inspection";
    if (progress < 70) return "Financing Approval";
    if (progress < 85) return "Final Walkthrough";
    if (progress < 100) return "Closing";
    return "Complete!";
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-slate-600">Loading your portal...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 p-4">
        <Card className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h2 className="text-2xl font-bold mb-2">Error Loading Portal</h2>
            <p className="text-slate-600 mb-6">{error}</p>
            <Button onClick={() => window.location.reload()}>
              Try Again
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!portalAccess) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 p-4">
        <Card className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <Home className="w-8 h-8 text-indigo-600" />
            </div>
            <h2 className="text-2xl font-bold mb-2">Welcome to Your Client Portal</h2>
            <p className="text-slate-600 mb-6">
              Your agent will grant you access to your personalized portal where you can track your transaction, view documents, and communicate securely.
            </p>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-left">
              <p className="text-sm text-blue-900 font-semibold mb-2">For Demo Purposes:</p>
              <p className="text-sm text-blue-800">
                Ask your agent to set up portal access for you via <strong>Client Portal ‚Üí Setup Client Access</strong>
              </p>
            </div>
            <Button onClick={() => navigate(createPageUrl("Dashboard"))}>
              Go to Dashboard
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      {/* Header */}
      <div className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center">
                <Home className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-xl font-bold text-slate-900">My Real Estate Portal</h1>
                <p className="text-sm text-slate-600">
                  {portalAccess.access_type === 'buyer' ? 'Buyer Dashboard' : 
                   portalAccess.access_type === 'seller' ? 'Seller Dashboard' : 
                   'Your Property Journey'}
                </p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <Button variant="outline" size="icon">
                <Bell className="w-5 h-5" />
              </Button>
              <Button variant="outline" size="icon" onClick={() => navigate(createPageUrl("Settings"))}>
                <Settings className="w-5 h-5" />
              </Button>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
        {/* Transaction Progress */}
        {transaction && (
          <Card className="border-l-4 border-l-indigo-600">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingUp className="w-5 h-5 text-indigo-600" />
                Transaction Progress
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm font-medium">Overall Progress</span>
                    <span className="text-sm font-bold text-indigo-600">
                      {getTransactionProgress()}%
                    </span>
                  </div>
                  <Progress value={getTransactionProgress()} className="h-3" />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-slate-50 p-4 rounded-lg">
                    <div className="text-sm text-slate-600 mb-1">Next Milestone</div>
                    <div className="font-bold text-lg">{getNextMilestone()}</div>
                  </div>
                  <div className="bg-slate-50 p-4 rounded-lg">
                    <div className="text-sm text-slate-600 mb-1">Contract Price</div>
                    <div className="font-bold text-lg text-green-600">
                      ${(transaction.contract_price || 0).toLocaleString()}
                    </div>
                  </div>
                  <div className="bg-slate-50 p-4 rounded-lg">
                    <div className="text-sm text-slate-600 mb-1">Status</div>
                    <Badge className="bg-indigo-600">
                      {transaction.status}
                    </Badge>
                  </div>
                </div>

                {transaction.important_dates && (
                  <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                    <h4 className="font-semibold mb-2 flex items-center gap-2">
                      <Calendar className="w-4 h-4" />
                      Important Dates
                    </h4>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                      {transaction.important_dates.closing_date && (
                        <div>
                          <div className="text-slate-600">Closing</div>
                          <div className="font-semibold">
                            {new Date(transaction.important_dates.closing_date).toLocaleDateString()}
                          </div>
                        </div>
                      )}
                      {transaction.important_dates.inspection_deadline && (
                        <div>
                          <div className="text-slate-600">Inspection</div>
                          <div className="font-semibold">
                            {new Date(transaction.important_dates.inspection_deadline).toLocaleDateString()}
                          </div>
                        </div>
                      )}
                      {transaction.important_dates.financing_deadline && (
                        <div>
                          <div className="text-slate-600">Financing</div>
                          <div className="font-semibold">
                            {new Date(transaction.important_dates.financing_deadline).toLocaleDateString()}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        )}

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {/* Left Column - Property & Agent */}
          <div className="space-y-6">
            {/* Property Card */}
            {property && (
              <Card>
                <CardHeader>
                  <CardTitle className="text-base">Your Property</CardTitle>
                </CardHeader>
                <CardContent>
                  {property.primary_photo_url ? (
                    <img 
                      src={property.primary_photo_url} 
                      alt={property.address}
                      className="w-full h-48 object-cover rounded-lg mb-4"
                    />
                  ) : (
                    <div className="w-full h-48 bg-slate-100 rounded-lg mb-4 flex items-center justify-center">
                      <Home className="w-12 h-12 text-slate-300" />
                    </div>
                  )}
                  <h3 className="font-bold text-lg mb-2">{property.address}</h3>
                  <p className="text-slate-600 text-sm mb-3">
                    {property.city}, {property.state} {property.zip_code}
                  </p>
                  
                  <div className="grid grid-cols-3 gap-2 mb-4 text-sm">
                    <div className="bg-slate-50 p-2 rounded text-center">
                      <div className="font-bold">{property.bedrooms || 0}</div>
                      <div className="text-slate-600 text-xs">Beds</div>
                    </div>
                    <div className="bg-slate-50 p-2 rounded text-center">
                      <div className="font-bold">{property.bathrooms || 0}</div>
                      <div className="text-slate-600 text-xs">Baths</div>
                    </div>
                    <div className="bg-slate-50 p-2 rounded text-center">
                      <div className="font-bold">
                        {property.square_feet ? `${(property.square_feet / 1000).toFixed(1)}K` : 'N/A'}
                      </div>
                      <div className="text-slate-600 text-xs">Sq Ft</div>
                    </div>
                  </div>

                  <div className="text-2xl font-bold text-green-600 mb-4">
                    ${(property.price || 0).toLocaleString()}
                  </div>

                  <Button 
                    onClick={() => navigate(createPageUrl(`PropertyDetail?id=${property.id}`))}
                    className="w-full"
                    variant="outline"
                  >
                    View Details
                    <ArrowRight className="w-4 h-4 ml-2" />
                  </Button>
                </CardContent>
              </Card>
            )}

            {/* Agent Card */}
            {agent && (
              <Card>
                <CardHeader>
                  <CardTitle className="text-base">Your Agent</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="flex items-start gap-3 mb-4">
                    <div className="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
                      <User className="w-6 h-6 text-white" />
                    </div>
                    <div className="flex-1">
                      <h3 className="font-bold">{agent.full_name}</h3>
                      <p className="text-sm text-slate-600">{agent.office || 'Real Estate Agent'}</p>
                    </div>
                  </div>

                  <div className="space-y-2 mb-4">
                    {agent.email && (
                      <a href={`mailto:${agent.email}`} className="flex items-center gap-2 text-sm text-slate-600 hover:text-indigo-600">
                        <Mail className="w-4 h-4" />
                        {agent.email}
                      </a>
                    )}
                    {agent.phone && (
                      <a href={`tel:${agent.phone}`} className="flex items-center gap-2 text-sm text-slate-600 hover:text-indigo-600">
                        <Phone className="w-4 h-4" />
                        {agent.phone}
                      </a>
                    )}
                  </div>

                  <Button 
                    onClick={() => navigate(createPageUrl("Messages"))}
                    className="w-full"
                  >
                    <MessageSquare className="w-4 h-4 mr-2" />
                    Send Message
                  </Button>
                </CardContent>
              </Card>
            )}
          </div>

          {/* Middle Column - Documents & Tasks */}
          <div className="space-y-6">
            {/* Documents */}
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <CardTitle className="text-base flex items-center gap-2">
                    <FileText className="w-5 h-5" />
                    Documents
                  </CardTitle>
                  <Badge variant="outline">{documents.length}</Badge>
                </div>
              </CardHeader>
              <CardContent>
                {documents.length > 0 ? (
                  <div className="space-y-2">
                    {documents.map((doc) => (
                      <div 
                        key={doc.id}
                        className="flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors"
                      >
                        <div className="flex items-center gap-3 flex-1">
                          <FileText className="w-4 h-4 text-slate-400" />
                          <div className="flex-1 min-w-0">
                            <div className="font-medium text-sm truncate">
                              {doc.document_name}
                            </div>
                            <div className="text-xs text-slate-500">
                              {doc.document_type}
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <Button size="sm" variant="ghost" onClick={() => window.open(doc.file_url, '_blank')}>
                            <Eye className="w-4 h-4" />
                          </Button>
                          <Button 
                            size="sm" 
                            variant="ghost"
                            onClick={() => window.open(doc.file_url, '_blank')}
                          >
                            <Download className="w-4 h-4" />
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <FileText className="w-12 h-12 mx-auto mb-2 text-slate-300" />
                    <p className="text-sm text-slate-600">No documents yet</p>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Tasks & Milestones */}
            <Card>
              <CardHeader>
                <CardTitle className="text-base flex items-center gap-2">
                  <CheckCircle2 className="w-5 h-5" />
                  Tasks & Milestones
                </CardTitle>
              </CardHeader>
              <CardContent>
                {tasks.length > 0 ? (
                  <div className="space-y-2">
                    {tasks.filter(t => t.status !== 'completed').slice(0, 5).map((task) => (
                      <div 
                        key={task.id}
                        className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg"
                      >
                        <div className={`w-2 h-2 rounded-full ${
                          task.priority === 'critical' ? 'bg-red-500' :
                          task.priority === 'high' ? 'bg-orange-500' :
                          'bg-blue-500'
                        }`}></div>
                        <div className="flex-1">
                          <div className="font-medium text-sm">{task.title}</div>
                          {task.due_date && (
                            <div className="text-xs text-slate-500 flex items-center gap-1 mt-1">
                              <Clock className="w-3 h-3" />
                              {new Date(task.due_date).toLocaleDateString()}
                            </div>
                          )}
                        </div>
                        <Badge variant="outline" className="text-xs">
                          {task.status}
                        </Badge>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <CheckCircle2 className="w-12 h-12 mx-auto mb-2 text-slate-300" />
                    <p className="text-sm text-slate-600">No pending tasks</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>

          {/* Right Column - Messages & Saved Searches */}
          <div className="space-y-6">
            {/* Recent Messages */}
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <CardTitle className="text-base flex items-center gap-2">
                    <MessageSquare className="w-5 h-5" />
                    Messages
                  </CardTitle>
                  <Badge variant="outline">
                    {messages.filter(m => !m.is_read).length}
                  </Badge>
                </div>
              </CardHeader>
              <CardContent>
                {messages.length > 0 ? (
                  <div className="space-y-2">
                    {messages.slice(0, 5).map((message) => (
                      <div 
                        key={message.id}
                        className={`p-3 rounded-lg cursor-pointer transition-colors ${
                          message.is_read ? 'bg-slate-50 hover:bg-slate-100' : 'bg-indigo-50 hover:bg-indigo-100'
                        }`}
                        onClick={() => navigate(createPageUrl("Messages"))}
                      >
                        <div className="font-medium text-sm mb-1">{message.subject}</div>
                        <div className="text-xs text-slate-600 truncate">
                          {message.content}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                          {new Date(message.created_date).toLocaleDateString()}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <MessageSquare className="w-12 h-12 mx-auto mb-2 text-slate-300" />
                    <p className="text-sm text-slate-600">No messages yet</p>
                  </div>
                )}
                
                <Button 
                  onClick={() => navigate(createPageUrl("Messages"))}
                  variant="outline"
                  className="w-full mt-4"
                >
                  View All Messages
                </Button>
              </CardContent>
            </Card>

            {/* Saved Searches (for buyers) */}
            {(portalAccess.access_type === 'buyer' || portalAccess.access_type === 'both') && (
              <Card>
                <CardHeader>
                  <CardTitle className="text-base flex items-center gap-2">
                    <Heart className="w-5 h-5" />
                    Saved Searches
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  {savedSearches.length > 0 ? (
                    <div className="space-y-2">
                      {savedSearches.map((search) => (
                        <div 
                          key={search.id}
                          className="p-3 bg-slate-50 rounded-lg hover:bg-slate-100 cursor-pointer transition-colors"
                        >
                          <div className="font-medium text-sm mb-1">{search.search_name}</div>
                          <div className="text-xs text-slate-600">
                            {search.match_count} matching properties
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-8">
                      <Search className="w-12 h-12 mx-auto mb-2 text-slate-300" />
                      <p className="text-sm text-slate-600 mb-3">No saved searches</p>
                      <Button size="sm" variant="outline" onClick={() => navigate(createPageUrl("Properties"))}>
                        <Search className="w-4 h-4 mr-2" />
                        Browse Properties
                      </Button>
                    </div>
                  )}
                </CardContent>
              </Card>
            )}

            {/* Quick Actions */}
            <Card>
              <CardHeader>
                <CardTitle className="text-base">Quick Actions</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <Button 
                  onClick={() => navigate(createPageUrl("Properties"))}
                  variant="outline" 
                  className="w-full justify-start"
                >
                  <Search className="w-4 h-4 mr-2" />
                  Browse Properties
                </Button>
                <Button 
                  onClick={() => navigate(createPageUrl("Calendar"))}
                  variant="outline" 
                  className="w-full justify-start"
                >
                  <Calendar className="w-4 h-4 mr-2" />
                  Schedule Showing
                </Button>
                <Button 
                  onClick={() => navigate(createPageUrl("Documents"))}
                  variant="outline" 
                  className="w-full justify-start"
                >
                  <FileText className="w-4 h-4 mr-2" />
                  View All Documents
                </Button>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox";
import {
  UserPlus,
  Mail,
  Phone,
  Home,
  FileText,
  CheckCircle2,
  Eye,
  AlertCircle,
  Users
} from "lucide-react";
import { toast } from "sonner";

export default function ClientPortalSetup() {
  const navigate = useNavigate();
  const [user, setUser] = useState(null);
  const [properties, setProperties] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [documents, setDocuments] = useState([]);
  const [buyers, setBuyers] = useState([]);
  const [clients, setClients] = useState([]);
  const [isCreating, setIsCreating] = useState(false);

  const [selectedProperty, setSelectedProperty] = useState(null);
  const [sellers, setSellers] = useState([]);
  const [buyer, setBuyer] = useState(null);
  const [selectedRecipients, setSelectedRecipients] = useState([]);
  const [selectedDocuments, setSelectedDocuments] = useState([]);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const [currentUser, propertiesData, transactionsData, docsData, buyersData] = await Promise.all([
        base44.auth.me(),
        base44.entities.Property.list(),
        base44.entities.Transaction.list(),
        base44.entities.Document.list(),
        base44.entities.Buyer.list()
      ]);

      setUser(currentUser);
      setProperties(propertiesData || []);
      setTransactions(transactionsData || []);
      setDocuments(docsData || []);
      setBuyers(buyersData || []);

      // Load existing client portal access records
      const clientsData = await base44.entities.ClientPortalAccess.list("-created_date");
      setClients(clientsData || []);
    } catch (error) {
      console.error("Error loading data:", error);
      toast.error("Failed to load initial data.");
    }
  };

  const handlePropertySelect = (propertyId) => {
    const property = properties.find(p => p.id === propertyId);
    setSelectedProperty(property);
    setSelectedRecipients([]);
    setSelectedDocuments([]);
    
    if (!property) {
      setSellers([]);
      setBuyer(null);
      return;
    }

    // Parse sellers from property
    let parsedSellers = [];
    if (property.sellers_info) {
      try {
        parsedSellers = JSON.parse(property.sellers_info);
      } catch (e) {
        console.error("Error parsing sellers:", e);
      }
    }
    setSellers(parsedSellers);

    // Check for active transaction and buyer
    const activeTransaction = transactions.find(t => 
      t.property_id === propertyId && 
      (t.status === 'active' || t.status === 'pending')
    );

    if (activeTransaction) {
      // Get buyer info from transaction or property
      let buyerInfo = null;
      
      if (property.buyer_name && property.buyer_email) {
        buyerInfo = {
          name: property.buyer_name,
          email: property.buyer_email,
          phone: property.buyer_phone
        };
      } else if (property.buyer_id) {
        const buyerRecord = buyers.find(b => b.id === property.buyer_id);
        if (buyerRecord) {
          buyerInfo = {
            name: `${buyerRecord.first_name} ${buyerRecord.last_name}`,
            email: buyerRecord.email,
            phone: buyerRecord.phone
          };
        }
      }
      
      setBuyer(buyerInfo);
    } else {
      setBuyer(null);
    }
  };

  const toggleRecipient = (email, type) => {
    setSelectedRecipients(prev => {
      const exists = prev.find(r => r.email === email);
      if (exists) {
        return prev.filter(r => r.email !== email);
      } else {
        return [...prev, { email, type }];
      }
    });
  };

  const toggleDocument = (docId) => {
    setSelectedDocuments(prev => {
      if (prev.includes(docId)) {
        return prev.filter(id => id !== docId);
      } else {
        return [...prev, docId];
      }
    });
  };

  const handleCreateAccess = async () => {
    if (!selectedProperty || selectedRecipients.length === 0) {
      toast.error("Please select a property and at least one recipient");
      return;
    }

    setIsCreating(true);
    try {
      // Create portal access for each selected recipient
      for (const recipient of selectedRecipients) {
        // Check if user exists
        const allUsers = await base44.entities.User.list();
        const clientUser = allUsers.find(u => u.email === recipient.email);
        
        let clientUserId;
        if (!clientUser) {
          toast.info(`‚ö†Ô∏è User with email ${recipient.email} doesn't exist yet. They'll need to be invited to the platform first.`);
          clientUserId = recipient.email; // Use email as placeholder
        } else {
          clientUserId = clientUser.id;
        }

        // Determine access type
        const accessType = recipient.type === 'buyer' ? 'buyer' : 'seller';

        // Find transaction for this property
        const propertyTransaction = transactions.find(t => 
          t.property_id === selectedProperty.id &&
          (t.status === 'active' || t.status === 'pending')
        );

        // Create portal access
        await base44.entities.ClientPortalAccess.create({
          client_user_id: clientUserId,
          agent_id: user.id,
          access_type: accessType,
          property_id: selectedProperty.id,
          transaction_id: propertyTransaction?.id || null,
          document_access: selectedDocuments,
          is_active: true
        });
      }

      toast.success(`‚úÖ Client portal access created for ${selectedRecipients.length} recipient(s)!`);
      
      // Reset form
      setSelectedProperty(null);
      setSellers([]);
      setBuyer(null);
      setSelectedRecipients([]);
      setSelectedDocuments([]);
      
      await loadData();
    } catch (error) {
      console.error("Error creating portal access:", error);
      toast.error("Failed to create portal access: " + error.message);
    }
    setIsCreating(false);
  };

  const getPropertyDocuments = () => {
    if (!selectedProperty) return [];
    return documents.filter(doc => doc.property_id === selectedProperty.id);
  };

  const getPropertyName = (propertyId) => {
    const property = properties.find(p => p.id === propertyId);
    return property ? property.address : 'N/A';
  };

  const isRecipientSelected = (email) => {
    return selectedRecipients.some(r => r.email === email);
  };

  return (
    <div className="page-container">
      <div className="max-w-6xl mx-auto p-6 space-y-6">
        <div>
          <h1 className="text-3xl font-bold mb-2">Client Portal Setup</h1>
          <p className="text-slate-600">
            Grant your clients access to their personalized portal
          </p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Create New Access Form */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <UserPlus className="w-5 h-5" />
                Create Portal Access
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* Property Selection */}
              <div className="space-y-2">
                <Label>Select Property *</Label>
                <Select 
                  value={selectedProperty?.id || ""}
                  onValueChange={handlePropertySelect}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select property" />
                  </SelectTrigger>
                  <SelectContent>
                    {properties.map(property => (
                      <SelectItem key={property.id} value={property.id}>
                        {property.address} - {property.city}, {property.state}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {selectedProperty && (
                <>
                  {/* Sellers Section */}
                  {sellers.length > 0 && (
                    <div className="space-y-2">
                      <Label className="flex items-center gap-2">
                        <Users className="w-4 h-4" />
                        Sellers - Select Recipients
                      </Label>
                      <div className="border rounded-lg p-3 bg-slate-50 space-y-2">
                        {sellers.map((seller, index) => (
                          <div 
                            key={index}
                            className="flex items-start gap-3 p-3 bg-white rounded-lg border hover:border-indigo-300 transition-colors"
                          >
                            <Checkbox
                              checked={isRecipientSelected(seller.email)}
                              onCheckedChange={() => toggleRecipient(seller.email, 'seller')}
                              className="mt-1 data-[state=checked]:bg-indigo-600 data-[state=checked]:border-indigo-600"
                            />
                            <div className="flex-1">
                              <div className="font-semibold text-sm">{seller.name}</div>
                              <div className="text-xs text-slate-600 flex items-center gap-1 mt-1">
                                <Mail className="w-3 h-3" />
                                {seller.email}
                              </div>
                              {seller.phone && (
                                <div className="text-xs text-slate-600 flex items-center gap-1">
                                  <Phone className="w-3 h-3" />
                                  {seller.phone}
                                </div>
                              )}
                              <Badge variant="outline" className="mt-1 text-xs">
                                Seller
                              </Badge>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Buyer Section - Only show if property is under contract */}
                  {buyer && (
                    <div className="space-y-2">
                      <Label className="flex items-center gap-2">
                        <Users className="w-4 h-4" />
                        Buyer - Under Contract
                      </Label>
                      <div className="border rounded-lg p-3 bg-green-50 space-y-2">
                        <div 
                          className="flex items-start gap-3 p-3 bg-white rounded-lg border hover:border-green-300 transition-colors"
                        >
                          <Checkbox
                            checked={isRecipientSelected(buyer.email)}
                            onCheckedChange={() => toggleRecipient(buyer.email, 'buyer')}
                            className="mt-1 data-[state=checked]:bg-indigo-600 data-[state=checked]:border-indigo-600"
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-sm">{buyer.name}</div>
                            <div className="text-xs text-slate-600 flex items-center gap-1 mt-1">
                              <Mail className="w-3 h-3" />
                              {buyer.email}
                            </div>
                            {buyer.phone && (
                              <div className="text-xs text-slate-600 flex items-center gap-1">
                                <Phone className="w-3 h-3" />
                                {buyer.phone}
                              </div>
                            )}
                            <Badge className="mt-1 text-xs bg-green-600">
                              Buyer
                            </Badge>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* No Sellers Warning */}
                  {sellers.length === 0 && !buyer && (
                    <div className="p-4 bg-amber-50 border border-amber-200 rounded-lg">
                      <div className="flex items-start gap-2">
                        <AlertCircle className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
                        <div className="text-sm text-amber-900">
                          <p className="font-semibold mb-1">No sellers or buyers found</p>
                          <p className="text-xs">Please add seller information to the property first, or ensure the property is under contract to see buyer information.</p>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Selected Recipients Summary */}
                  {selectedRecipients.length > 0 && (
                    <div className="p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                      <p className="text-sm font-semibold text-indigo-900 mb-2">
                        Selected Recipients ({selectedRecipients.length})
                      </p>
                      <div className="space-y-1">
                        {selectedRecipients.map((r, i) => (
                          <div key={i} className="text-xs text-indigo-700 flex items-center gap-2">
                            <CheckCircle2 className="w-3 h-3" />
                            {r.email} ({r.type})
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Document Access */}
                  <div className="space-y-2">
                    <Label>Document Access (Optional)</Label>
                    {getPropertyDocuments().length > 0 ? (
                      <div className="border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2 bg-slate-50">
                        {getPropertyDocuments().map(doc => (
                          <div 
                            key={doc.id}
                            className="flex items-center gap-2 p-2 hover:bg-white rounded transition-colors"
                          >
                            <Checkbox
                              checked={selectedDocuments.includes(doc.id)}
                              onCheckedChange={() => toggleDocument(doc.id)}
                              className="data-[state=checked]:bg-indigo-600 data-[state=checked]:border-indigo-600"
                            />
                            <div className="flex-1 min-w-0">
                              <span className="text-sm truncate block">{doc.document_name}</span>
                              <Badge variant="outline" className="text-xs mt-1">
                                {doc.document_type}
                              </Badge>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-center py-4 text-sm text-slate-600 border rounded-lg bg-slate-50">
                        <FileText className="w-8 h-8 mx-auto mb-2 text-slate-300" />
                        No documents available for this property
                      </div>
                    )}
                    {selectedDocuments.length > 0 && (
                      <p className="text-xs text-slate-600">
                        {selectedDocuments.length} document(s) selected
                      </p>
                    )}
                  </div>
                </>
              )}

              {/* Submit Button */}
              <Button 
                onClick={handleCreateAccess}
                disabled={isCreating || !selectedProperty || selectedRecipients.length === 0}
                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold py-6 text-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isCreating ? (
                  <div className="flex items-center gap-2">
                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                    <span>Creating Portal Access...</span>
                  </div>
                ) : (
                  <div className="flex items-center gap-2">
                    <UserPlus className="w-5 h-5" />
                    <span>Create Portal Access for {selectedRecipients.length} Recipient(s)</span>
                  </div>
                )}
              </Button>

              {!selectedProperty && (
                <p className="text-xs text-center text-slate-500">
                  Select a property to begin
                </p>
              )}
            </CardContent>
          </Card>

          {/* Existing Client Access List */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Eye className="w-5 h-5" />
                Active Client Portals
              </CardTitle>
            </CardHeader>
            <CardContent>
              {clients.length > 0 ? (
                <div className="space-y-3">
                  {clients.map(client => (
                    <div 
                      key={client.id}
                      className="p-4 border rounded-lg hover:bg-slate-50 transition-colors"
                    >
                      <div className="flex items-start justify-between mb-2">
                        <div>
                          <div className="font-semibold">
                            Client ID: {client.client_user_id}
                          </div>
                          <div className="text-sm text-slate-600">
                            {client.access_type} portal
                          </div>
                        </div>
                        <Badge variant={client.is_active ? "default" : "secondary"}>
                          {client.is_active ? "Active" : "Inactive"}
                        </Badge>
                      </div>
                      
                      {client.property_id && (
                        <div className="text-sm text-slate-600 flex items-center gap-2 mt-2">
                          <Home className="w-4 h-4" />
                          {getPropertyName(client.property_id)}
                        </div>
                      )}
                      
                      {client.document_access && client.document_access.length > 0 && (
                        <div className="text-sm text-slate-600 flex items-center gap-2 mt-1">
                          <FileText className="w-4 h-4" />
                          {client.document_access.length} documents accessible
                        </div>
                      )}

                      {client.last_login && (
                        <div className="text-xs text-slate-500 mt-2">
                          Last login: {new Date(client.last_login).toLocaleDateString()}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-12">
                  <Eye className="w-12 h-12 mx-auto mb-3 text-slate-300" />
                  <p className="text-slate-600">No client portals created yet</p>
                </div>
              )}
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate, useSearchParams } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Textarea } from "@/components/ui/textarea";
import {
  ArrowLeft,
  Home,
  FileText,
  CheckCircle2,
  Clock,
  Calendar,
  TrendingUp,
  AlertCircle,
  Loader2,
  Download,
  Eye,
  MessageSquare,
  Shield,
  User,
  Send,
  Building2,
  Mail,
  Phone
} from "lucide-react";
import { toast } from "sonner";
import { format } from "date-fns";
import PropertyMessaging from "../components/properties/PropertyMessaging";

export default function ClientTransactionDetail() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const transactionId = searchParams.get('id');

  const [user, setUser] = useState(null);
  const [transaction, setTransaction] = useState(null);
  const [property, setProperty] = useState(null);
  const [documents, setDocuments] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [agent, setAgent] = useState(null);
  const [allUsers, setAllUsers] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [portalAccess, setPortalAccess] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [activeTab, setActiveTab] = useState('overview');

  useEffect(() => {
    if (transactionId) {
      loadTransactionDetail();
    }
  }, [transactionId]);

  const loadTransactionDetail = async () => {
    setIsLoading(true);
    setError(null);
    
    try {
      const currentUser = await base44.auth.me();
      setUser(currentUser);

      // Check portal access first
      const allAccess = await base44.entities.ClientPortalAccess.filter({
        client_user_id: currentUser.id,
        is_active: true
      });

      if (allAccess.length === 0) {
        throw new Error("No portal access granted. Please contact your agent.");
      }

      // Load transaction
      const allTransactions = await base44.entities.Transaction.list();
      const transactionData = allTransactions.find(t => t.id === transactionId);
      
      if (!transactionData) {
        throw new Error("Transaction not found");
      }

      // Verify portal access to this property
      const access = allAccess.find(a => a.property_id === transactionData.property_id);
      if (!access) {
        throw new Error("You don't have access to this transaction");
      }

      setTransaction(transactionData);
      setPortalAccess(access);

      // Load all supporting data
      const [allProperties, allDocuments, allTasks, userData, teamData] = await Promise.all([
        base44.entities.Property.list(),
        base44.entities.Document.list(),
        base44.entities.Task.list(),
        base44.entities.User.list(),
        base44.entities.TeamMember.list()
      ]);

      setAllUsers(userData);
      setTeamMembers(teamData);

      // Load property
      if (transactionData.property_id) {
        const propertyData = allProperties.find(p => p.id === transactionData.property_id);
        setProperty(propertyData);

        // Get agent
        if (propertyData?.listing_agent_id) {
          const agentData = userData.find(u => u.id === propertyData.listing_agent_id) ||
                            teamData.find(tm => tm.id === propertyData.listing_agent_id);
          setAgent(agentData);
        }
      }

      // Get shared document IDs from portal access
      let sharedDocIds = [];
      if (access.document_access) {
        try {
          sharedDocIds = Array.isArray(access.document_access) 
            ? access.document_access 
            : JSON.parse(access.document_access);
        } catch (e) {
          console.error('Error parsing document_access:', e);
        }
      }

      // Filter to only shared documents
      const accessibleDocs = allDocuments.filter(d => 
        sharedDocIds.includes(d.id) ||
        (d.property_id === transactionData.property_id && !sharedDocIds.length)
      );
      setDocuments(accessibleDocs);

      // Load tasks based on access type
      if (transactionData.property_id) {
        const propertyTasks = allTasks.filter(t => {
          if (t.property_id !== transactionData.property_id) return false;
          
          // Sellers see listing tasks
          if (access.access_type === 'seller') {
            return ['listing', 'marketing', 'documentation', 'inspection'].includes(t.task_type);
          }
          
          // Buyers see contract tasks
          if (access.access_type === 'buyer') {
            return ['contract', 'financing', 'closing'].includes(t.task_type);
          }
          
          return false;
        });
        setTasks(propertyTasks);
      }

    } catch (error) {
      console.error("Error loading transaction detail:", error);
      setError(error.message);
      toast.error("Failed to load transaction details");
    }
    
    setIsLoading(false);
  };

  const getTransactionProgress = () => {
    if (!transaction) return 0;
    
    // Use actual progress from transaction if available
    if (portalAccess?.access_type === 'seller' && transaction.listing_side_progress !== null) {
      return transaction.listing_side_progress;
    }
    
    if (portalAccess?.access_type === 'buyer' && transaction.selling_side_progress !== null) {
      return transaction.selling_side_progress;
    }
    
    // Fallback to status-based progress
    if (transaction.status === 'closed') return 100;
    if (transaction.status === 'pending') return 70;
    if (transaction.status === 'active') return 40;
    return 10;
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'completed': return 'bg-green-100 text-green-800';
      case 'in_progress': return 'bg-blue-100 text-blue-800';
      case 'pending': return 'bg-yellow-100 text-yellow-800';
      case 'cancelled': return 'bg-red-100 text-red-800';
      default: return 'bg-slate-100 text-slate-800';
    }
  };

  const getPriorityColor = (priority) => {
    switch (priority) {
      case 'critical': return 'bg-red-500';
      case 'high': return 'bg-orange-500';
      case 'medium': return 'bg-yellow-500';
      case 'low': return 'bg-blue-500';
      default: return 'bg-slate-500';
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100">
        <div className="text-center">
          <Loader2 className="w-16 h-16 mx-auto mb-4 animate-spin text-indigo-600" />
          <p className="text-slate-600">Loading transaction details...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 p-4">
        <Card className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h2 className="text-2xl font-bold mb-2">Error</h2>
            <p className="text-slate-600 mb-6">{error}</p>
            <Button onClick={() => navigate(createPageUrl("ClientDashboard"))}>
              Back to Dashboard
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  const progress = getTransactionProgress();
  const completedTasks = tasks.filter(t => t.status === 'completed').length;
  const totalTasks = tasks.length;

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      {/* Header */}
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
        <div className="max-w-7xl mx-auto px-4 py-6">
          <div className="flex items-center gap-4 mb-4">
            <Button 
              variant="ghost" 
              size="icon"
              onClick={() => navigate(createPageUrl("ClientDashboard"))}
              className="text-white hover:bg-white/20"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-1">
                <Shield className="w-5 h-5" />
                <h1 className="text-2xl font-bold">Your Deal Room</h1>
              </div>
              <p className="text-white/90 text-sm">
                {property?.address || 'Loading property...'}
              </p>
            </div>
            <Badge className="bg-white/20 text-white border-white/30 px-4 py-2">
              {portalAccess?.access_type === 'buyer' ? 'üë§ Buyer' : 'üè† Seller'}
            </Badge>
          </div>
          
          {/* Quick Stats in Header */}
          <div className="grid grid-cols-3 gap-4">
            <div className="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
              <div className="text-2xl font-bold">{Math.round(progress)}%</div>
              <div className="text-xs text-white/80">Progress</div>
            </div>
            <div className="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
              <div className="text-2xl font-bold">{completedTasks}/{totalTasks}</div>
              <div className="text-xs text-white/80">Tasks Done</div>
            </div>
            <div className="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
              <div className="text-2xl font-bold">{documents.length}</div>
              <div className="text-xs text-white/80">Documents</div>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
        {/* Transaction Overview */}
        <Card className="shadow-xl border-2 border-indigo-200">
          <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50">
            <CardTitle className="flex items-center gap-2">
              <TrendingUp className="w-5 h-5 text-indigo-600" />
              {portalAccess?.access_type === 'seller' ? 'Listing Progress' : 'Transaction Progress'}
            </CardTitle>
          </CardHeader>
          <CardContent className="pt-6">
            <div className="space-y-6">
              <div>
                <div className="flex justify-between items-center mb-3">
                  <span className="text-sm font-medium">
                    {portalAccess?.access_type === 'seller' ? 'Marketing & Preparation' : 'Contract to Closing'}
                  </span>
                  <span className="text-2xl font-bold text-indigo-600">
                    {Math.round(progress)}%
                  </span>
                </div>
                <Progress value={progress} className="h-4" />
                <p className="text-xs text-slate-500 mt-2">
                  {completedTasks} of {totalTasks} tasks completed
                </p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                  <div className="text-sm text-green-700 mb-1 font-medium">Contract Price</div>
                  <div className="font-bold text-2xl text-green-600">
                    ${(transaction.contract_price || 0).toLocaleString()}
                  </div>
                </div>
                <div className="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-lg border border-blue-200">
                  <div className="text-sm text-blue-700 mb-1 font-medium">Status</div>
                  <Badge className="text-base px-3 py-1 bg-indigo-600">
                    {transaction.status}
                  </Badge>
                </div>
              </div>

              {/* Important Dates */}
              {transaction.important_dates && Object.keys(transaction.important_dates).length > 0 && (
                <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                  <h4 className="font-semibold mb-3 flex items-center gap-2 text-blue-900">
                    <Calendar className="w-4 h-4" />
                    Key Dates
                  </h4>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    {transaction.important_dates.closing_date && (
                      <div className="bg-white p-3 rounded border-l-4 border-l-indigo-600">
                        <div className="text-slate-600 text-xs mb-1">üéØ Closing Date</div>
                        <div className="font-bold text-indigo-600">
                          {format(new Date(transaction.important_dates.closing_date), 'MMM dd, yyyy')}
                        </div>
                      </div>
                    )}
                    {transaction.important_dates.inspection_deadline && (
                      <div className="bg-white p-3 rounded">
                        <div className="text-slate-600 text-xs mb-1">Inspection</div>
                        <div className="font-semibold">
                          {format(new Date(transaction.important_dates.inspection_deadline), 'MMM dd')}
                        </div>
                      </div>
                    )}
                    {transaction.important_dates.financing_deadline && (
                      <div className="bg-white p-3 rounded">
                        <div className="text-slate-600 text-xs mb-1">Financing</div>
                        <div className="font-semibold">
                          {format(new Date(transaction.important_dates.financing_deadline), 'MMM dd')}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Tabs Navigation */}
        <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
          <TabsList className="grid w-full grid-cols-4 mb-6">
            <TabsTrigger value="overview">Overview</TabsTrigger>
            <TabsTrigger value="tasks">
              Tasks ({totalTasks})
            </TabsTrigger>
            <TabsTrigger value="documents">
              Documents ({documents.length})
            </TabsTrigger>
            <TabsTrigger value="messages">
              Messages
            </TabsTrigger>
          </TabsList>

          {/* Overview Tab */}
          <TabsContent value="overview" className="space-y-6">

            {/* Property Info Card */}
            {property && (
              <Card className="shadow-lg">
                <CardHeader className="bg-gradient-to-r from-slate-50 to-slate-100">
                  <CardTitle className="flex items-center gap-2">
                    <Home className="w-5 h-5 text-slate-700" />
                    Property Details
                  </CardTitle>
                </CardHeader>
                <CardContent className="pt-6">
                  <div className="space-y-4">
                    <div>
                      <h3 className="font-bold text-xl mb-2">{property.address}</h3>
                      <p className="text-slate-600">
                        {property.city}, {property.state} {property.zip_code}
                      </p>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                      <div className="bg-blue-50 p-3 rounded-lg text-center">
                        <div className="font-bold text-xl">{property.bedrooms || 0}</div>
                        <div className="text-slate-600 text-xs">Bedrooms</div>
                      </div>
                      <div className="bg-purple-50 p-3 rounded-lg text-center">
                        <div className="font-bold text-xl">{property.bathrooms || 0}</div>
                        <div className="text-slate-600 text-xs">Bathrooms</div>
                      </div>
                      <div className="bg-green-50 p-3 rounded-lg text-center">
                        <div className="font-bold text-lg">
                          {property.square_feet ? property.square_feet.toLocaleString() : 'N/A'}
                        </div>
                        <div className="text-slate-600 text-xs">Sq Ft</div>
                      </div>
                    </div>
                    {property.description && (
                      <div className="pt-4 border-t">
                        <p className="text-sm text-slate-700 leading-relaxed">
                          {property.description}
                        </p>
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            )}

            {/* Agent Card */}
            {agent && (
              <Card className="shadow-lg">
                <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50">
                  <CardTitle className="text-base flex items-center gap-2">
                    <User className="w-5 h-5 text-indigo-600" />
                    Your Agent
                  </CardTitle>
                </CardHeader>
                <CardContent className="pt-4">
                  <div className="flex items-start gap-3 mb-4">
                    <div className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                      <User className="w-7 h-7 text-white" />
                    </div>
                    <div className="flex-1">
                      <h3 className="font-bold text-lg">{agent.full_name}</h3>
                      {agent.brokerage_name && (
                        <div className="flex items-center gap-1 text-sm text-slate-600 mt-1">
                          <Building2 className="w-3 h-3" />
                          {agent.brokerage_name}
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="space-y-2">
                    {agent.email && (
                      <a href={`mailto:${agent.email}`} className="flex items-center gap-2 text-sm text-slate-600 hover:text-indigo-600 transition-colors p-2 rounded hover:bg-indigo-50">
                        <Mail className="w-4 h-4" />
                        {agent.email}
                      </a>
                    )}
                    {agent.phone && (
                      <a href={`tel:${agent.phone}`} className="flex items-center gap-2 text-sm text-slate-600 hover:text-indigo-600 transition-colors p-2 rounded hover:bg-indigo-50">
                        <Phone className="w-4 h-4" />
                        {agent.phone}
                      </a>
                    )}
                  </div>
                </CardContent>
              </Card>
            )}
          </TabsContent>

          {/* Tasks Tab */}
          <TabsContent value="tasks">
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <span className="flex items-center gap-2">
                    <CheckCircle2 className="w-5 h-5 text-indigo-600" />
                    {portalAccess?.access_type === 'seller' ? 'Listing Tasks' : 'Transaction Milestones'}
                  </span>
                  <Badge variant="outline">
                    {completedTasks}/{totalTasks} Complete
                  </Badge>
                </CardTitle>
              </CardHeader>
              <CardContent>
                {tasks.length > 0 ? (
                  <div className="space-y-3">
                    {tasks.map(task => (
                      <div 
                        key={task.id}
                        className="flex items-start gap-3 p-4 bg-slate-50 rounded-lg hover:shadow-md transition-shadow"
                      >
                        <div className={`w-3 h-3 rounded-full mt-2 flex-shrink-0 ${
                          task.status === 'completed' ? 'bg-green-500' :
                          task.priority === 'critical' ? 'bg-red-500' :
                          task.priority === 'high' ? 'bg-orange-500' :
                          'bg-blue-500'
                        }`}></div>
                        <div className="flex-1">
                          <div className={`font-medium ${task.status === 'completed' ? 'line-through text-slate-500' : ''}`}>
                            {task.title}
                          </div>
                          {task.description && (
                            <div className="text-sm text-slate-600 mt-1">{task.description}</div>
                          )}
                          <div className="flex items-center gap-3 mt-2">
                            {task.due_date && (
                              <div className="text-xs text-slate-500 flex items-center gap-1">
                                <Clock className="w-3 h-3" />
                                Due: {format(new Date(task.due_date), 'MMM dd, yyyy')}
                              </div>
                            )}
                            <Badge variant="outline" className="text-xs capitalize">
                              {task.task_type}
                            </Badge>
                          </div>
                        </div>
                        <Badge className={getStatusColor(task.status)}>
                          {task.status === 'completed' && <CheckCircle2 className="w-3 h-3 mr-1" />}
                          {task.status}
                        </Badge>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12">
                    <CheckCircle2 className="w-12 h-12 mx-auto mb-3 text-slate-300" />
                    <p className="text-slate-600">No tasks available</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* Documents Tab */}
          <TabsContent value="documents">
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <FileText className="w-5 h-5 text-indigo-600" />
                  Shared Documents
                </CardTitle>
              </CardHeader>
              <CardContent>
                {documents.length > 0 ? (
                  <div className="space-y-2">
                    {documents.map(doc => (
                      <div 
                        key={doc.id}
                        className="flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors border border-slate-200"
                      >
                        <div className="flex items-center gap-3 flex-1">
                          <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <FileText className="w-5 h-5 text-blue-600" />
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="font-medium truncate">
                              {doc.document_name}
                            </div>
                            {doc.category && (
                              <Badge variant="outline" className="text-xs mt-1 capitalize">
                                {doc.category.replace('_', ' ')}
                              </Badge>
                            )}
                            <div className="text-xs text-slate-400 mt-1">
                              Uploaded {format(new Date(doc.created_date), 'MMM dd, yyyy')}
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <Button 
                            size="sm" 
                            variant="ghost"
                            onClick={async () => {
                              try {
                                if (doc.file_url.startsWith('private://')) {
                                  const { signed_url } = await base44.integrations.Core.CreateFileSignedUrl({
                                    file_uri: doc.file_url,
                                    expires_in: 3600
                                  });
                                  window.open(signed_url, '_blank');
                                } else {
                                  window.open(doc.file_url, '_blank');
                                }
                              } catch (error) {
                                toast.error('Failed to open document');
                              }
                            }}
                            className="hover:bg-blue-100"
                          >
                            <Eye className="w-4 h-4" />
                          </Button>
                          <Button 
                            size="sm" 
                            variant="ghost"
                            onClick={async () => {
                              try {
                                if (doc.file_url.startsWith('private://')) {
                                  const { signed_url } = await base44.integrations.Core.CreateFileSignedUrl({
                                    file_uri: doc.file_url,
                                    expires_in: 3600
                                  });
                                  window.open(signed_url, '_blank');
                                } else {
                                  window.open(doc.file_url, '_blank');
                                }
                              } catch (error) {
                                toast.error('Failed to download document');
                              }
                            }}
                            className="hover:bg-green-100"
                          >
                            <Download className="w-4 h-4" />
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12">
                    <FileText className="w-12 h-12 mx-auto mb-3 text-slate-300" />
                    <p className="text-slate-600">No documents shared yet</p>
                    <p className="text-sm text-slate-500 mt-2">Your agent will share relevant documents here</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* Messages Tab */}
          <TabsContent value="messages">
            <Card className="shadow-lg">
              <CardHeader className="bg-gradient-to-r from-cyan-50 to-blue-50">
                <CardTitle className="flex items-center gap-2">
                  <MessageSquare className="w-5 h-5 text-cyan-600" />
                  Chat with Your Agent
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-6">
                <PropertyMessaging
                  property={property}
                  currentUser={user}
                  users={allUsers}
                  teamMembers={teamMembers}
                  listingAgent={agent}
                  sellingAgent={null}
                  buyer={null}
                  sellers={[]}
                  initialRecipient={agent}
                />
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Crown, BookOpen, Video, Mic, ArrowRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';

const resources = [
    {
        title: "Mastering Your Sphere of Influence",
        description: "A 5-year email campaign strategy to nurture your network and generate consistent referrals. Now integrated into the Sphere Autopilot tool!",
        icon: <Crown className="w-8 h-8 text-amber-500" />,
        link: "SphereAutopilot",
        linkText: "Go to Sphere Autopilot"
    },
    {
        title: "Effective Lead Nurturing",
        description: "Learn the best practices for converting new leads into loyal clients using automated follow-ups and personalized communication.",
        icon: <BookOpen className="w-8 h-8 text-blue-500" />,
        link: "Leads",
        linkText: "View Leads"
    },
    {
        title: "Video Marketing for Listings",
        description: "A step-by-step guide to creating compelling property videos that capture attention and drive engagement.",
        icon: <Video className="w-8 h-8 text-red-500" />,
        link: "MarketingCampaigns",
        linkText: "Plan a Campaign"
    },
    {
        title: "Podcast: The Modern Agent",
        description: "Listen to interviews with top-producing agents on technology, market trends, and business growth strategies.",
        icon: <Mic className="w-8 h-8 text-purple-500" />,
        link: null,
        linkText: "Coming Soon"
    },
];

export default function CoachingResources() {
    const navigate = useNavigate();

    return (
        <div className="page-container max-w-6xl mx-auto">
            <div className="text-center mb-12">
                <h1 className="text-4xl font-bold text-slate-900 dark:text-white">Coaching & Resources</h1>
                <p className="text-xl text-slate-600 dark:text-slate-300 mt-2">Elevate your skills and grow your real estate business.</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                {resources.map((resource, index) => (
                    <Card key={index} className="flex flex-col">
                        <CardHeader className="flex flex-row items-center gap-4">
                            <div className="flex-shrink-0">
                                {resource.icon}
                            </div>
                            <div>
                                <CardTitle className="text-xl">{resource.title}</CardTitle>
                            </div>
                        </CardHeader>
                        <CardContent className="flex-grow">
                            <p className="text-slate-600 dark:text-slate-400">{resource.description}</p>
                        </CardContent>
                        <div className="p-6 pt-0">
                            <Button
                                onClick={() => resource.link && navigate(createPageUrl(resource.link))}
                                disabled={!resource.link}
                                className="w-full"
                            >
                                {resource.linkText} <ArrowRight className="w-4 h-4 ml-2" />
                            </Button>
                        </div>
                    </Card>
                ))}
            </div>
        </div>
    );
}

import React, { useState, useEffect, useMemo } from "react";
// This might become unused if commissions are generated, but keep for consistency or future use if the backend changes
import { Transaction } from "@/api/entities";
import { Property } from "@/api/entities";
import { User } from "@/api/entities";
import { TeamMember } from "@/api/entities"; // New import
import { Button } from "@/components/ui/button";
import { DollarSign, TrendingUp, Clock, CheckCircle2, ArrowLeft, Filter } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { toast } from 'react-hot-toast'; // New import for toast notifications

export default function Commissions() {
  const navigate = useNavigate();
  const [commissions, setCommissions] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [properties, setProperties] = useState([]);
  const [users, setUsers] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]); // New state
  const [currentUser, setCurrentUser] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [filterAgent, setFilterAgent] = useState("all"); // Renamed and new filter
  const [filterStatus, setFilterStatus] = useState("all"); // Renamed

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [user, trans, props, usrs, members] = await Promise.all([
        User.me(),
        Transaction.list(),
        Property.list(),
        User.list(),
        TeamMember.list().catch((err) => {
          console.error("Error loading team members:", err);
          return []; // Return an empty array to not block the Promise.all
        })
      ]);
      
      setCurrentUser(user);
      setTransactions(trans || []);
      setProperties(props || []);
      setUsers(usrs || []);
      setTeamMembers(members || []);
      
      // Generate commission records from transactions after all data is loaded
      generateCommissionRecords(trans || [], usrs || [], members || []);
    } catch (error) {
      console.error("Error loading data:", error);
      toast.error("Failed to load commission data.");
    }
    setIsLoading(false);
  };

  const generateCommissionRecords = (trans, allUsers, allMembers) => {
    const commissionRecords = [];
    
    trans.forEach(t => {
      if (t.status === 'closed') {
        // Listing agent commission
        if (t.listing_agent_id && t.listing_net_commission !== undefined && t.listing_net_commission !== null) {
          const agent = allMembers.find(m => m.id === t.listing_agent_id) || 
                        allUsers.find(u => u.id === t.listing_agent_id);
          
          commissionRecords.push({
            id: `${t.id}-listing`,
            transaction_id: t.id,
            property_id: t.property_id,
            agent_id: t.listing_agent_id,
            agent_name: agent?.full_name || agent?.email || "Unknown Agent",
            commission_type: "listing",
            gross_commission: t.listing_gross_commission || 0,
            net_commission: t.listing_net_commission || 0,
            split_percentage: t.agent_split_percentage || 50,
            status: "paid", // Assuming closed transactions mean paid commissions
            payment_date: t.closing_date || t.updated_date
          });
        }
        
        // Selling agent commission
        if ((t.selling_agent_id || t.selling_agent_email) && t.selling_net_commission !== undefined && t.selling_net_commission !== null) {
          const agent = allMembers.find(m => 
            m.id === t.selling_agent_id || 
            (t.selling_agent_email && m.email && m.email.toLowerCase() === t.selling_agent_email.toLowerCase())
          ) || allUsers.find(u => u.id === t.selling_agent_id); // Fallback to all users if not a team member
          
          commissionRecords.push({
            id: `${t.id}-selling`,
            transaction_id: t.id,
            property_id: t.property_id,
            agent_id: agent?.id || t.selling_agent_id, // Use actual agent ID if found, otherwise use transaction's selling_agent_id
            agent_name: agent?.full_name || t.selling_agent_name || (t.selling_agent_email ? `External: ${t.selling_agent_email}` : "External Agent"),
            commission_type: "selling",
            gross_commission: t.selling_gross_commission || 0,
            net_commission: t.selling_net_commission || 0,
            split_percentage: t.agent_split_percentage || 50,
            status: "paid", // Assuming closed transactions mean paid commissions
            payment_date: t.closing_date || t.updated_date
          });
        }
      }
    });
    
    setCommissions(commissionRecords);
  };

  const filteredCommissions = commissions.filter(c => {
    const statusMatch = filterStatus === "all" || c.status === filterStatus;
    const agentMatch = filterAgent === "all" || c.agent_id === filterAgent;
    return statusMatch && agentMatch;
  });

  const myCommissions = filteredCommissions.filter(c => c.agent_id === currentUser?.id);

  const calculateStats = (commissionList) => {
    const total = commissionList.reduce((sum, c) => sum + (c.net_commission || 0), 0);
    const pending = commissionList.filter(c => c.status === "pending").reduce((sum, c) => sum + (c.net_commission || 0), 0);
    const paid = commissionList.filter(c => c.status === "paid").reduce((sum, c) => sum + (c.net_commission || 0), 0);
    
    return { total, pending, paid, count: commissionList.length };
  };

  const myStats = calculateStats(myCommissions);
  const allStats = calculateStats(filteredCommissions);
  const stats = currentUser?.role === "broker" || currentUser?.role === "admin" ? allStats : myStats;

  const getStatusColor = (status) => {
    const colors = {
      pending: "bg-yellow-100 text-yellow-700 border-yellow-200",
      approved: "bg-blue-100 text-blue-700 border-blue-200",
      paid: "bg-green-100 text-green-700 border-green-200",
      disputed: "bg-red-100 text-red-700 border-red-200"
    };
    return colors[status] || colors.pending;
  };

  const getCommissionTypeLabel = (type) => {
    const labels = {
      listing: "Listing Side",
      selling: "Selling Side",
      referral: "Referral",
      bonus: "Bonus"
    };
    return labels[type] || type;
  };

  const allAgentsForFilter = useMemo(() => {
    const agentsMap = new Map();
    // Add all internal users (who could be agents)
    users.forEach(user => {
      // Assuming roles like 'agent', 'broker', 'admin' can have commissions
      if (user.full_name || user.email) {
        agentsMap.set(user.id, { id: user.id, name: user.full_name || user.email });
      }
    });
    // Add team members
    teamMembers.forEach(member => {
      if (member.full_name || member.email) {
        agentsMap.set(member.id, { id: member.id, name: member.full_name || member.email });
      }
    });
    // Add any agents from generated commissions that might not be in users/teamMembers list (e.g. external selling agents if they have an ID)
    commissions.forEach(c => {
      if (c.agent_id && c.agent_name && !agentsMap.has(c.agent_id)) {
        agentsMap.set(c.agent_id, { id: c.agent_id, name: c.agent_name });
      }
    });
    
    return Array.from(agentsMap.values()).sort((a, b) => (a.name || "").localeCompare(b.name || ""));
  }, [users, teamMembers, commissions]);

  if (isLoading) {
    return (
      <div className="p-8 animate-pulse">
        <div className="space-y-6">
          {Array(4).fill(0).map((_, i) => (
            <div key={i} className="h-32 bg-slate-200 rounded-lg"></div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Header */}
        <div className="app-card p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(createPageUrl("Dashboard"))}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <h1 className="app-title text-2xl">Commission Tracking</h1>
              <p className="app-subtitle">Monitor your earnings and payment status</p>
            </div>
          </div>
        </div>

        {/* Stats Cards */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div className="app-card p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="app-text-muted text-sm mb-2">Total Earned</p>
                <p className="app-title text-3xl text-green-600">
                  ${stats.total.toLocaleString()}
                </p>
              </div>
              <div className="p-3 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg">
                <DollarSign className="w-6 h-6 text-white" />
              </div>
            </div>
          </div>

          <div className="app-card p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="app-text-muted text-sm mb-2">Pending</p>
                <p className="app-title text-3xl text-yellow-600">
                  ${stats.pending.toLocaleString()}
                </p>
              </div>
              <div className="p-3 rounded-xl bg-gradient-to-br from-yellow-500 to-amber-600 shadow-lg">
                <Clock className="w-6 h-6 text-white" />
              </div>
            </div>
          </div>

          <div className="app-card p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="app-text-muted text-sm mb-2">Paid Out</p>
                <p className="app-title text-3xl text-blue-600">
                  ${stats.paid.toLocaleString()}
                </p>
              </div>
              <div className="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg">
                <CheckCircle2 className="w-6 h-6 text-white" />
              </div>
            </div>
          </div>

          <div className="app-card p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="app-text-muted text-sm mb-2">Transactions</p>
                <p className="app-title text-3xl text-indigo-600">
                  {stats.count}
                </p>
              </div>
              <div className="p-3 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg">
                <TrendingUp className="w-6 h-6 text-white" />
              </div>
            </div>
          </div>
        </div>

        {/* Filters */}
        <div className="app-card p-4">
          <div className="flex items-center gap-4">
            <Filter className="w-5 h-5 text-slate-400" />
            <Select value={filterStatus} onValueChange={setFilterStatus}>
              <SelectTrigger className="w-48">
                <SelectValue placeholder="Filter by status" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Status</SelectItem>
                <SelectItem value="pending">Pending</SelectItem>
                <SelectItem value="approved">Approved</SelectItem>
                <SelectItem value="paid">Paid</SelectItem>
                <SelectItem value="disputed">Disputed</SelectItem>
              </SelectContent>
            </Select>

            <Select value={filterAgent} onValueChange={setFilterAgent}>
              <SelectTrigger className="w-48">
                <SelectValue placeholder="Filter by agent" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Agents</SelectItem>
                {allAgentsForFilter.map(agent => (
                  <SelectItem key={agent.id} value={agent.id}>
                    {agent.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Commissions Table */}
        <div className="app-card overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-slate-50 border-b border-slate-200">
                <tr>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">
                    Property
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">
                    Agent
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">
                    Type
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">
                    Gross
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">
                    Split
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">
                    Net
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">
                    Status
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">
                    Payment Date
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-200">
                {filteredCommissions.length > 0 ? (
                  filteredCommissions.map((commission) => {
                    const property = properties.find(p => p.id === commission.property_id);
                    // Find agent using generated agent_id, fallback to agent_name from commission itself
                    const agentDisplayName = allAgentsForFilter.find(a => a.id === commission.agent_id)?.name || commission.agent_name || "Unknown Agent";
                    
                    return (
                      <tr key={commission.id} className="hover:bg-slate-50 transition-colors">
                        <td className="px-6 py-4">
                          <div>
                            <p className="font-medium text-slate-900">
                              {property?.address || "Unknown Property"}
                            </p>
                            <p className="text-sm text-slate-500">
                              {property?.city}, {property?.state}
                            </p>
                          </div>
                        </td>
                        <td className="px-6 py-4">
                          <p className="font-medium text-slate-900">
                            {agentDisplayName}
                          </p>
                        </td>
                        <td className="px-6 py-4">
                          <span className="text-sm text-slate-600">
                            {getCommissionTypeLabel(commission.commission_type)}
                          </span>
                        </td>
                        <td className="px-6 py-4">
                          <p className="font-semibold text-slate-900">
                            ${commission.gross_commission?.toLocaleString() || 0}
                          </p>
                        </td>
                        <td className="px-6 py-4">
                          <span className="text-sm text-slate-600">
                            {commission.split_percentage || 0}%
                          </span>
                        </td>
                        <td className="px-6 py-4">
                          <p className="font-bold text-green-600 text-lg">
                            ${commission.net_commission?.toLocaleString() || 0}
                          </p>
                        </td>
                        <td className="px-6 py-4">
                          <Badge className={getStatusColor(commission.status)}>
                            {commission.status}
                          </Badge>
                        </td>
                        <td className="px-6 py-4">
                          <span className="text-sm text-slate-600">
                            {commission.payment_date 
                              ? new Date(commission.payment_date).toLocaleDateString()
                              : "Not paid"}
                          </span>
                        </td>
                      </tr>
                    );
                  })
                ) : (
                  <tr>
                    <td colSpan="8" className="px-6 py-12 text-center">
                      <DollarSign className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                      <h3 className="text-lg font-medium text-slate-900 mb-2">
                        No commissions found
                      </h3>
                      <p className="text-slate-500">
                        {filterStatus !== "all" || filterAgent !== "all"
                          ? `No matching commissions for the selected filters`
                          : "Commission records will appear here once transactions close"}
                      </p>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Progress } from "@/components/ui/progress";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import {
  ArrowLeft, Mail, Phone, MessageSquare, Calendar, TrendingUp, Edit, Send, Loader2, Clock, Tag, Heart, Share2,
  Home, Trash2, FileText,
  AlertCircle, Zap, DollarSign, Target,
  Facebook, Linkedin, Instagram, Twitter, Globe, ExternalLink,
  Sparkles, Activity, CheckCircle2, Plus, X, ArrowUpRight, ArrowDownRight,
  Wand2, Brain, ThumbsUp, ThumbsDown, Copy, Check, ListOrdered
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { formatDistanceToNow } from "date-fns";
import { toast } from "sonner";

import ContactModal from "../components/contacts/ContactModal";
import PredictiveDataPoints from "../components/contacts/PredictiveDataPoints";
import RelationshipInsightsPanel from "../components/contacts/RelationshipInsightsPanel";
import ImportedFieldsCard from "../components/contacts/ImportedFieldsCard";
import ClientLoveMeter from "../components/common/ClientLoveMeter";

// Helper components
const SocialIcon = ({ platform }) => {
    const icons = {
        facebook: <Facebook className="w-4 h-4" />,
        linkedin: <Linkedin className="w-4 h-4" />,
        instagram: <Instagram className="w-4 h-4" />,
        twitter: <Twitter className="w-4 h-4" />,
        default: <Globe className="w-4 h-4" />
    };
    return icons[platform] || icons.default;
};

const IntentScoreBadge = ({ score, type }) => {
    const getScoreConfig = (score) => {
        if (score >= 80) return { label: 'Hot', color: 'bg-red-500', textColor: 'text-white' };
        if (score >= 60) return { label: 'Warm', color: 'bg-orange-500', textColor: 'text-white' };
        if (score >= 40) return { label: 'Lukewarm', color: 'bg-yellow-500', textColor: 'text-white' };
        return { label: 'Cool', color: 'bg-blue-500', textColor: 'text-white' };
    };

    const config = getScoreConfig(score);

    return (
        <div className="flex items-center gap-2">
            <Badge className={`${config.color} ${config.textColor} flex items-center gap-1`}>
                <Target className="w-3 h-3" />
                {config.label} {type}
            </Badge>
            <span className="text-xs font-semibold text-slate-600 dark:text-slate-400">{score}/100</span>
        </div>
    );
};

const IntentSignalCard = ({ signal }) => {
    const getIconAndColor = (category) => {
        if (category === 'buyer') return { Icon: Home, color: 'bg-blue-50 dark:bg-blue-900/20 border-blue-200' };
        if (category === 'seller') return { Icon: DollarSign, color: 'bg-green-50 dark:bg-green-900/20 border-green-200' };
        return { Icon: Activity, color: 'bg-slate-50 dark:bg-slate-900/20 border-slate-200' };
    };

    const { Icon, color } = getIconAndColor(signal.category);

    return (
        <div className={`flex items-start gap-3 p-3 rounded-lg ${color} border`}>
            <div className="p-2 rounded-lg bg-white dark:bg-slate-800 shadow-sm">
                <Icon className="w-4 h-4 text-indigo-600" />
            </div>
            <div className="flex-1">
                <p className="text-sm font-semibold text-slate-900 dark:text-white">{signal.title}</p>
                <p className="text-xs text-slate-600 dark:text-slate-400 mt-0.5">{signal.description}</p>
                {signal.timestamp && (
                    <p className="text-xs text-slate-500 mt-1">
                        {new Date(signal.timestamp).toLocaleDateString()}
                    </p>
                )}
            </div>
            <Badge variant="outline" className="text-xs">+{signal.score}</Badge>
        </div>
    );
};

// Helper function to generate email signature
const generateEmailSignature = (user) => {
    const parts = [];
    
    if (user?.full_name) parts.push(user.full_name);
    if (user?.agency_name || user?.office?.name) parts.push(user.agency_name || user.office.name);
    if (user?.phone) parts.push(user.phone);
    if (user?.email) parts.push(user.email);
    
    return parts.length > 0 ? `\n\n---\n${parts.join('\n')}` : '';
};

export default function ContactDetail() {
  const navigate = useNavigate();
  const urlParams = new URLSearchParams(window.location.search);
  const contactId = urlParams.get("id");
  const queryClient = useQueryClient();

  const { data: contactActivities = [] } = useQuery({
    queryKey: ['contactActivities', contactId],
    queryFn: () => base44.entities.LeadActivity.filter({ lead_id: contactId }),
    enabled: !!contactId
  });

  const [contact, setContact] = useState(null);
  const [currentUser, setCurrentUser] = useState(null);
  const [allUsers, setAllUsers] = useState([]);
  const [messages, setMessages] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showEditModal, setShowEditModal] = useState(false);
  const [isSending, setIsSending] = useState(false);
  
  // Data for Client Love Meter
  const [properties, setProperties] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [clientPortalAccess, setClientPortalAccess] = useState([]);
  const [documents, setDocuments] = useState([]);
  const [communications, setCommunications] = useState([]);

  // Communication states
  const [messageType, setMessageType] = useState("internal");
  const [messageContent, setMessageContent] = useState("");
  const [emailSubject, setEmailSubject] = useState("");

  // AI Assistant states
  const [aiPrompt, setAiPrompt] = useState("");
  const [isGenerating, setIsGenerating] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [isSummarizing, setIsSummarizing] = useState(false);
  const [toneAnalysis, setToneAnalysis] = useState(null);
  const [threadSummary, setThreadSummary] = useState(null);
  const [showAITools, setShowAITools] = useState(false);
  const [copiedDraft, setCopiedDraft] = useState(false);

  // New note state
  const [newNote, setNewNote] = useState("");
  const [isSavingNote, setIsSavingNote] = useState(false);

  useEffect(() => {
    loadData();
  }, [contactId]);

  const loadData = async () => {
    if (!contactId) {
      toast.error("No contact ID provided");
      navigate(createPageUrl("Contacts"));
      return;
    }

    setIsLoading(true);
    try {
      const [user, contactData, usersData, messagesData, propertiesData, transactionsData, portalAccessData, documentsData, communicationsData] = await Promise.all([
        base44.auth.me(),
        base44.entities.Contact.list().then(contacts => contacts.find(c => c.id === contactId)),
        base44.entities.User.list(),
        base44.entities.Message.list(),
        base44.entities.Property.list().catch(() => []),
        base44.entities.Transaction.list().catch(() => []),
        base44.entities.ClientPortalAccess.list().catch(() => []),
        base44.entities.Document.list().catch(() => []),
        base44.entities.Communication.list().catch(() => [])
      ]);

      if (!contactData) {
        toast.error("Contact not found");
        navigate(createPageUrl("Contacts"));
        return;
      }

      setCurrentUser(user);
      setContact(contactData);
      setAllUsers(usersData || []);
      
      // Filter messages to show ONLY messages for THIS specific contact
      const contactMessages = (messagesData || []).filter(m => 
        m.recipient_email === contactData.email && m.sender_id === user.id
      );
      setMessages(contactMessages);
      
      // Set Client Love Meter data
      setProperties(propertiesData || []);
      setTransactions(transactionsData || []);
      setClientPortalAccess(portalAccessData || []);
      setDocuments(documentsData || []);
      setCommunications(communicationsData || []);
    } catch (error) {
      console.error("Error loading contact data:", error);
      toast.error("Failed to load contact information");
    } finally {
      setIsLoading(false);
    }
  };

  const handleGenerateDraft = async () => {
    if (!aiPrompt.trim()) {
      toast.error("Please enter what you want to write about");
      return;
    }

    setIsGenerating(true);
    try {
      const intentData = contact?.intent_data ? JSON.parse(contact.intent_data) : null;
      const lifeEvents = contact?.life_events ? JSON.parse(contact.life_events) : [];
      
      const contextInfo = `
Contact: ${contact.name}
Relationship: ${contact.relationship || 'N/A'}
Property Address: ${contact.property_address || 'N/A'}
Last Contact: ${contact.last_contact_date ? formatDistanceToNow(new Date(contact.last_contact_date), { addSuffix: true }) : 'Never'}
${intentData ? `Buyer Intent: ${intentData.buyer_intent_score}/100, Seller Intent: ${intentData.seller_intent_score}/100` : ''}
${lifeEvents.length > 0 ? `Recent Life Events: ${lifeEvents.map(e => e.event).join(', ')}` : ''}
      `.trim();

      // Generate email signature
      const signature = generateEmailSignature(currentUser);

      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `You are a professional real estate agent writing an email to a client.

Context about the contact:
${contextInfo}

Agent's brief: ${aiPrompt}

Write a professional, warm, and personalized email. The email should:
1. Be appropriate for a real estate professional-client relationship
2. Reference relevant context about the contact when appropriate
3. Be clear, concise, and action-oriented
4. Maintain a friendly but professional tone
5. Include a clear call-to-action or next steps
6. DO NOT include a signature - it will be added automatically

Also suggest 3 compelling subject lines.

Return ONLY valid JSON with this structure:
{
  "email_body": "The email content WITHOUT signature",
  "suggested_subjects": ["Subject 1", "Subject 2", "Subject 3"]
}`,
        response_json_schema: {
          type: "object",
          properties: {
            email_body: { type: "string" },
            suggested_subjects: { type: "array", items: { type: "string" } }
          }
        }
      });

      // Add signature to the generated email
      setMessageContent(result.email_body + signature);
      
      // Set the first suggested subject if no subject exists
      if (!emailSubject && result.suggested_subjects && result.suggested_subjects.length > 0) {
        setEmailSubject(result.suggested_subjects[0]);
      }
      
      toast.success("Email draft generated with your signature! Review and edit as needed.", {
        description: result.suggested_subjects ? `Try subjects: ${result.suggested_subjects.slice(0, 2).join(' or ')}` : undefined,
        duration: 5000
      });
      
      setAiPrompt("");
    } catch (error) {
      console.error("Error generating draft:", error);
      toast.error("Failed to generate email draft: " + error.message);
    } finally {
      setIsGenerating(false);
    }
  };

  const handleAnalyzeTone = async () => {
    if (!messageContent.trim()) {
      toast.error("Please write some content first");
      return;
    }

    setIsAnalyzing(true);
    try {
      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `Analyze the following email for tone and professionalism. Consider:
1. Tone (friendly, formal, casual, professional, etc.)
2. Clarity and conciseness
3. Professional appropriateness for real estate communication
4. Potential improvements
5. Emotional intelligence

Email content:
"${messageContent}"

${emailSubject ? `Subject: "${emailSubject}"` : ''}

Provide constructive feedback and specific suggestions for improvement.

Return ONLY valid JSON with this structure:
{
  "overall_tone": "description",
  "professionalism_score": 85,
  "strengths": ["strength 1", "strength 2"],
  "improvements": ["improvement 1", "improvement 2"],
  "suggested_revisions": "optional improved version"
}`,
        response_json_schema: {
          type: "object",
          properties: {
            overall_tone: { type: "string" },
            professionalism_score: { type: "number" },
            strengths: { type: "array", items: { type: "string" } },
            improvements: { type: "array", items: { type: "string" } },
            suggested_revisions: { type: "string" }
          }
        }
      });

      setToneAnalysis(result);
      toast.success("Tone analysis complete!");
    } catch (error) {
      console.error("Error analyzing tone:", error);
      toast.error("Failed to analyze tone: " + error.message);
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleSummarizeThread = async () => {
    if (messages.length === 0) {
      toast.error("No previous messages to summarize");
      return;
    }

    setIsSummarizing(true);
    try {
      const emailMessages = messages.filter(m => m.message_type === 'email');
      const messageHistory = emailMessages.slice(0, 10).map(m => 
        `[${new Date(m.created_date).toLocaleDateString()}] ${m.subject || 'No subject'}: ${m.content.substring(0, 200)}...`
      ).join('\n\n');

      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `Summarize this email conversation history with ${contact.name}:

${messageHistory}

Provide:
1. A brief overview of the relationship
2. Key topics discussed
3. Any pending action items or follow-ups
4. Sentiment/relationship status

Return ONLY valid JSON with this structure:
{
  "summary": "Brief overview",
  "key_topics": ["topic 1", "topic 2"],
  "action_items": ["item 1", "item 2"],
  "relationship_notes": "relationship insights"
}`,
        response_json_schema: {
          type: "object",
          properties: {
            summary: { type: "string" },
            key_topics: { type: "array", items: { type: "string" } },
            action_items: { type: "array", items: { type: "string" } },
            relationship_notes: { type: "string" }
          }
        }
      });

      setThreadSummary(result);
      toast.success("Thread summary generated!");
    } catch (error) {
      console.error("Error summarizing thread:", error);
      toast.error("Failed to summarize thread: " + error.message);
    } finally {
      setIsSummarizing(false);
    }
  };

  const handleApplySuggestion = () => {
    if (toneAnalysis?.suggested_revisions) {
      // Keep the existing signature when applying suggestions
      const currentSignature = messageContent.match(/\n\n---\n[\s\S]*$/);
      const newContent = toneAnalysis.suggested_revisions;
      
      if (currentSignature) {
        setMessageContent(newContent + currentSignature[0]);
      } else {
        // Add signature if it doesn't exist
        setMessageContent(newContent + generateEmailSignature(currentUser));
      }
      
      setToneAnalysis(null);
      toast.success("Applied AI suggestions with your signature!");
    }
  };

  const handleCopyDraft = () => {
    navigator.clipboard.writeText(messageContent);
    setCopiedDraft(true);
    toast.success("Email draft copied to clipboard!");
    setTimeout(() => setCopiedDraft(false), 2000);
  };

  const handleSendMessage = async () => {
    if (!messageContent.trim()) {
      toast.error("Please enter a message");
      return;
    }

    if (messageType === "email" && !emailSubject.trim()) {
      toast.error("Please enter an email subject");
      return;
    }

    setIsSending(true);
    try {
      let finalContent = messageContent;
      
      // If sending email and signature not present, add it
      if (messageType === "email" && !messageContent.includes('---\n')) {
        finalContent = messageContent + generateEmailSignature(currentUser);
      }

      if (messageType === "email") {
        // ACTUALLY SEND THE EMAIL using Resend with signature
        const emailResult = await base44.functions.invoke('sendEmail', {
          to: contact.email,
          subject: emailSubject,
          html: `<div style="font-family: Arial, sans-serif; line-height: 1.6;">${finalContent.replace(/\n/g, '<br>')}</div>`,
          text: finalContent
        });

        if (!emailResult?.data?.success) {
          throw new Error(emailResult?.data?.error || 'Failed to send email');
        }

        toast.success('‚úÖ Email sent successfully!', {
          description: `Sent to ${contact.email}`,
          duration: 5000
        });
      }

      // Save to message history (for both email and internal notes)
      const messageData = {
        sender_id: currentUser.id,
        recipient_email: contact.email,
        content: finalContent,
        message_type: messageType,
        subject: messageType === "email" ? emailSubject : undefined
      };

      await base44.entities.Message.create(messageData);
      
      // Update last contact date
      await base44.entities.Contact.update(contactId, {
        last_contact_date: new Date().toISOString()
      });

      if (messageType === "internal") {
        toast.success('Internal note saved successfully');
      }
      
      setMessageContent("");
      setEmailSubject("");
      setToneAnalysis(null);
      setThreadSummary(null);
      await loadData();
      queryClient.invalidateQueries({ queryKey: ['contacts'] });
    } catch (error) {
      console.error("Error sending message:", error);
      
      // Better error messages
      if (messageType === "email") {
        const errorMsg = error.message || 'Unknown error';
        if (errorMsg.includes('Domain') || errorMsg.includes('verified')) {
          toast.error('üö´ Email Domain Not Verified', {
            description: 'Please configure your Resend settings in Settings ‚Üí Email (Resend)',
            duration: 8000
          });
        } else if (errorMsg.includes('API key')) {
          toast.error('‚ö†Ô∏è Resend Not Configured', {
            description: 'Please set up Resend in Settings ‚Üí Email (Resend)',
            duration: 8000
          });
        } else {
          toast.error('‚ùå Failed to send email', {
            description: errorMsg,
            duration: 6000
          });
        }
      } else {
        toast.error("Failed to save message");
      }
    } finally {
      setIsSending(false);
    }
  };

  const handleSaveNote = async () => {
    if (!newNote.trim()) {
      toast.error("Please enter a note");
      return;
    }

    setIsSavingNote(true);
    try {
      const currentNotes = contact.notes || "";
      const timestamp = new Date().toISOString();
      const updatedNotes = currentNotes + `\n\n[${new Date(timestamp).toLocaleString()}]\n${newNote}`;

      await base44.entities.Contact.update(contactId, {
        notes: updatedNotes
      });

      toast.success("Note added successfully");
      setNewNote("");
      await loadData();
      queryClient.invalidateQueries({ queryKey: ['contacts'] });
    } catch (error) {
      console.error("Error saving note:", error);
      toast.error("Failed to save note");
    } finally {
      setIsSavingNote(false);
    }
  };

  const handleLogContact = async () => {
    try {
      await base44.entities.Contact.update(contactId, {
        last_contact_date: new Date().toISOString(),
        next_contact_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
      });
      toast.success("Contact logged successfully");
      await loadData();
      queryClient.invalidateQueries({ queryKey: ['contacts'] });
    } catch (error) {
      console.error("Error logging contact:", error);
      toast.error("Failed to log contact");
    }
  };

  const handleDelete = async () => {
    if (!confirm("Are you sure you want to delete this contact?")) {
      return;
    }

    try {
      await base44.entities.Contact.delete(contactId);
      toast.success("Contact deleted successfully");
      navigate(createPageUrl("Contacts"));
      queryClient.invalidateQueries({ queryKey: ['contacts'] });
    } catch (error) {
      console.error("Error deleting contact:", error);
      toast.error("Failed to delete contact");
    }
  };

  const handleSendEmail = () => {
    window.location.href = `mailto:${contact.email}`;
  };

  const handleSendSMS = () => {
    window.open(`sms:${contact.phone}`, '_blank');
  };

  const getRelationshipStrength = (contact) => {
    let strength = 0;
    
    strength += (contact.referrals_sent || 0) * 20;
    strength += (contact.referrals_received || 0) * 15;
    
    if (contact.last_contact_date) {
      const daysSince = Math.floor((Date.now() - new Date(contact.last_contact_date)) / (1000 * 60 * 60 * 24));
      if (daysSince < 30) strength += 30;
      else if (daysSince < 60) strength += 20;
      else if (daysSince < 90) strength += 10;
    }
    
    if (contact.categories?.includes('vip')) {
      strength += 25;
    }
    
    return Math.min(strength, 100);
  };

  const getRelationshipLabel = (strength) => {
    if (strength >= 80) return { label: 'Strong', color: 'text-green-600', bg: 'bg-green-100' };
    if (strength >= 50) return { label: 'Good', color: 'text-blue-600', bg: 'bg-blue-100' };
    if (strength >= 20) return { label: 'Fair', color: 'text-yellow-600', bg: 'bg-yellow-100' };
    return { label: 'Weak', color: 'text-red-600', bg: 'bg-red-100' };
  };

  const getRelationshipColor = (relationship) => {
    const colors = {
      past_client: '#10b981',
      family: '#ec4899',
      friend: '#3b82f6',
      professional: '#8b5cf6',
      vendor: '#f59e0b'
    };
    return colors[relationship] || '#6b7280';
  };

  const getRelationshipLabel2 = (relationship) => {
    const labels = {
      past_client: 'Past Client',
      family: 'Family',
      friend: 'Friend',
      professional: 'Professional',
      vendor: 'Vendor'
    };
    return labels[relationship] || relationship;
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  if (!contact) {
    return (
      <div className="flex items-center justify-center h-screen">
        <p>Contact not found</p>
      </div>
    );
  }

  const relationshipStrength = getRelationshipStrength(contact);
  const strengthData = getRelationshipLabel(relationshipStrength);
  const needsFollowUp = contact.next_contact_date && new Date(contact.next_contact_date) <= new Date();
  
  // Parse intent data and social profiles
  const intentData = contact?.intent_data ? JSON.parse(contact.intent_data) : null;
  const socialProfiles = contact?.social_media_profiles ? JSON.parse(contact.social_media_profiles) : {};
  const lifeEvents = contact?.life_events ? JSON.parse(contact.life_events) : [];
  const interests = contact?.interests_hobbies ? JSON.parse(contact.interests_hobbies) : [];

  // Get profile picture from social media or stored URL
  const getProfilePicture = () => {
    if (contact?.profile_photo_url) {
      return contact.profile_photo_url;
    }
    return null;
  };

  const profilePicture = getProfilePicture();

  // Sort messages - newest first (reverse chronological order)
  const sortedMessages = [...messages].sort((a, b) => {
    return new Date(b.created_date) - new Date(a.created_date);
  });

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
      {/* Header */}
      <div className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          <div className="flex items-center gap-4 mb-6">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(-1)}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Contact Profile</h1>
              <p className="text-slate-500 dark:text-slate-400 mt-1">Manage contact information and communication history</p>
            </div>
            <Button onClick={() => setShowEditModal(true)} className="gap-2">
              <Edit className="w-4 h-4" />
              Edit Contact
            </Button>
          </div>

          {/* Contact Header Card */}
          <div className="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white">
            <div className="flex items-start justify-between">
              <div className="flex items-center gap-4">
                <Avatar className="h-20 w-20 border-4 border-white/30 ring-2 ring-white/20">
                  {profilePicture ? (
                    <AvatarImage 
                      src={profilePicture} 
                      alt={contact.name}
                      className="object-cover"
                    />
                  ) : null}
                  <AvatarFallback className="text-2xl bg-white/20 text-white font-bold">
                    {contact.name?.charAt(0)}
                  </AvatarFallback>
                </Avatar>
                <div>
                  <h2 className="text-2xl font-bold">{contact.name}</h2>
                  <div className="flex items-center gap-3 mt-2">
                    <Badge
                      className="text-white border-white/30"
                      style={{ backgroundColor: getRelationshipColor(contact.relationship)} }
                    >
                      {getRelationshipLabel2(contact.relationship)}
                    </Badge>
                    {needsFollowUp && (
                      <Badge variant="destructive" className="gap-1">
                        <AlertCircle className="w-3 h-3" />
                        Follow-up Due
                      </Badge>
                    )}
                    {profilePicture && (
                      <Badge variant="secondary" className="bg-white/20 text-white border-white/30 gap-1">
                        <CheckCircle2 className="w-3 h-3" />
                        Photo
                      </Badge>
                    )}
                  </div>
                  {contact.property_address && (
                    <p className="text-white/80 mt-2 flex items-center gap-2">
                      <Home className="w-4 h-4" />
                      {contact.property_address}
                    </p>
                  )}
                </div>
              </div>

              {/* Quick Actions */}
              <div className="flex gap-2">
                {contact.email && (
                  <Button
                    variant="secondary"
                    size="sm"
                    onClick={handleSendEmail}
                    className="gap-2 bg-white/20 hover:bg-white/30 text-white border-white/30"
                  >
                    <Mail className="w-4 h-4" />
                    Email
                  </Button>
                )}
                {contact.phone && (
                  <Button
                    variant="secondary"
                    size="sm"
                    onClick={handleSendSMS}
                    className="gap-2 bg-white/20 hover:bg-white/30 text-white border-white/30"
                  >
                    <MessageSquare className="w-4 h-4" />
                    Text
                  </Button>
                )}
                <Button
                  variant="secondary"
                  size="sm"
                  onClick={handleLogContact}
                  className="gap-2 bg-white/20 hover:bg-white/30 text-white border-white/30"
                >
                  <CheckCircle2 className="w-4 h-4" />
                  Log Contact
                </Button>
              </div>
            </div>

            {/* Contact Details Grid */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
              {contact.email && (
                <div className="flex items-center gap-2">
                  <Mail className="w-4 h-4" />
                  <span className="text-sm">{contact.email}</span>
                </div>
              )}
              {contact.phone && (
                <div className="flex items-center gap-2">
                  <Phone className="w-4 h-4" />
                  <span className="text-sm">{contact.phone}</span>
                </div>
              )}
              {contact.last_contact_date && (
                <div className="flex items-center gap-2">
                  <Clock className="w-4 h-4" />
                  <span className="text-sm">
                    Last contact: {formatDistanceToNow(new Date(contact.last_contact_date), { addSuffix: true })}
                  </span>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column - Profile & Stats */}
          <div className="space-y-6">
            {/* Relationship Strength */}
            <Card>
              <CardHeader>
                <CardTitle className="text-lg flex items-center gap-2">
                  <TrendingUp className="w-5 h-5 text-indigo-600" />
                  Relationship Strength
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className={`font-semibold ${strengthData.color}`}>{strengthData.label}</span>
                    <span className="text-sm text-slate-600">{relationshipStrength}/100</span>
                  </div>
                  <Progress value={relationshipStrength} className="h-3" />
                  <div className="text-xs text-slate-500 space-y-1">
                    <p>‚Ä¢ Recent contact activity</p>
                    <p>‚Ä¢ Referral engagement</p>
                    <p>‚Ä¢ Communication frequency</p>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Referrals */}
            {((contact.referrals_sent || 0) + (contact.referrals_received || 0)) > 0 && (
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg flex items-center gap-2">
                    <Share2 className="w-5 h-5 text-indigo-600" />
                    Referral Activity
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                      <div className="flex items-center gap-2">
                        <ArrowUpRight className="w-4 h-4 text-green-600" />
                        <span className="text-sm font-medium">Referrals Sent</span>
                      </div>
                      <span className="text-lg font-bold text-green-600">{contact.referrals_sent || 0}</span>
                    </div>
                    <div className="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                      <div className="flex items-center gap-2">
                        <ArrowDownRight className="w-4 h-4 text-blue-600" />
                        <span className="text-sm font-medium">Referrals Received</span>
                      </div>
                      <span className="text-lg font-bold text-blue-600">{contact.referrals_received || 0}</span>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}

            {/* Social Media Profiles */}
            {Object.keys(socialProfiles).length > 0 && (
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg flex items-center gap-2">
                    <Sparkles className="w-5 h-5 text-indigo-600" />
                    Social Media
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2">
                    {Object.entries(socialProfiles).map(([platform, url]) => (
                      <a
                        key={platform}
                        href={url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                      >
                        <SocialIcon platform={platform} />
                        <span className="text-sm capitalize flex-1">{platform}</span>
                        <ExternalLink className="w-3 h-3 text-slate-400" />
                      </a>
                    ))}
                  </div>
                </CardContent>
              </Card>
            )}

            {/* Life Events */}
            {lifeEvents.length > 0 && (
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg flex items-center gap-2">
                    <Calendar className="w-5 h-5 text-indigo-600" />
                    Life Events
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2">
                    {lifeEvents.slice(0, 5).map((event, index) => (
                      <div key={index} className="flex items-start gap-2 p-2 bg-slate-50 dark:bg-slate-800 rounded-lg">
                        <div className="w-2 h-2 bg-indigo-600 rounded-full mt-1.5"></div>
                        <div className="flex-1">
                          <p className="text-sm font-medium text-slate-900 dark:text-white">{event.event}</p>
                          {event.date && (
                            <p className="text-xs text-slate-500">{new Date(event.date).toLocaleDateString()}</p>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>
            )}

            {/* Interests */}
            {interests.length > 0 && (
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg flex items-center gap-2">
                    <Heart className="w-5 h-5 text-indigo-600" />
                    Interests & Hobbies
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="flex flex-wrap gap-2">
                    {interests.map((interest, index) => (
                      <Badge key={index} variant="secondary" className="text-xs">
                        {interest}
                      </Badge>
                    ))}
                  </div>
                </CardContent>
              </Card>
            )}

            {/* Tags */}
            {contact.tags && (
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg flex items-center gap-2">
                    <Tag className="w-5 h-5 text-indigo-600" />
                    Tags
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="flex flex-wrap gap-2">
                    {contact.tags.split(',').map((tag, index) => (
                      <Badge key={index} variant="outline" className="text-xs">
                        {tag.trim()}
                      </Badge>
                    ))}
                  </div>
                </CardContent>
              </Card>
            )}

            {/* Delete Button */}
            <Button
              variant="destructive"
              className="w-full"
              onClick={handleDelete}
            >
              <Trash2 className="w-4 h-4 mr-2" />
              Delete Contact
            </Button>
          </div>

          {/* Middle & Right Columns - Tabs */}
          <div className="lg:col-span-2">
            <Tabs defaultValue="overview" className="space-y-6">
              <TabsList className="grid w-full grid-cols-4">
                <TabsTrigger value="overview">Overview</TabsTrigger>
                <TabsTrigger value="intent">Intent Analysis</TabsTrigger>
                <TabsTrigger value="communication">Communication</TabsTrigger>
                <TabsTrigger value="notes">Notes</TabsTrigger>
              </TabsList>

              {/* Overview Tab */}
              <TabsContent value="overview" className="space-y-6">
                {/* Client Love Meter - for buyers and sellers */}
                {(() => {
                  // Find properties where contact is a BUYER (pending/sold status with buyer match)
                  const buyerProperties = properties.filter(p => 
                    (p.buyer_email === contact.email || p.buyer_name === contact.name) &&
                    (p.status === 'pending' || p.status === 'sold' || p.status === 'closed')
                  );
                  
                  // Find properties where contact is a SELLER (check sellers_info JSON)
                  const sellerProperties = properties.filter(p => {
                    if (!p.sellers_info) return false;
                    try {
                      const sellers = JSON.parse(p.sellers_info);
                      return sellers.some(s => 
                        s.email === contact.email || 
                        s.name === contact.name
                      );
                    } catch {
                      return false;
                    }
                  });
                  
                  // Combine all relevant properties
                  const allContactProperties = [...buyerProperties, ...sellerProperties];
                  
                  // Find active/pending transactions for these properties
                  const activeTransactions = transactions.filter(t => 
                    allContactProperties.some(p => p.id === t.property_id) && 
                    (t.status === 'active' || t.status === 'pending')
                  );
                  
                  if (allContactProperties.length > 0 && activeTransactions.length > 0) {
                    return allContactProperties.map((property, idx) => {
                      const transaction = activeTransactions.find(t => t.property_id === property.id);
                      if (!transaction) return null;
                      
                      const isBuyer = buyerProperties.some(p => p.id === property.id);
                      const isSeller = sellerProperties.some(p => p.id === property.id);
                      const role = isBuyer && isSeller ? 'Buyer & Seller' : isBuyer ? 'Buyer' : 'Seller';
                      
                      return (
                        <Card key={property.id} className="shadow-lg border-2 border-pink-200 dark:border-pink-800 bg-gradient-to-r from-pink-50 to-purple-50 dark:from-pink-900/20 dark:to-purple-900/20">
                          <CardContent className="p-6">
                            <div className="flex items-center justify-between">
                              <div>
                                <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-1">Client Relationship Health</h3>
                                <p className="text-sm text-slate-600 dark:text-slate-400">
                                  {role} ‚Ä¢ {property.address}
                                </p>
                              </div>
                              <ClientLoveMeter
                                property={property}
                                transaction={transaction}
                                clientPortalAccess={clientPortalAccess.filter(a => 
                                  (isBuyer && a.access_type === 'buyer') || 
                                  (isSeller && a.access_type === 'seller')
                                )}
                                documents={documents}
                                communications={communications}
                              />
                            </div>
                          </CardContent>
                        </Card>
                      );
                    }).filter(Boolean);
                  }
                  return null;
                })()}

                {/* Imported CRM Fields */}
                <ImportedFieldsCard contact={contact} />

                {/* AI Relationship Insights */}
                <RelationshipInsightsPanel contact={contact} onRefresh={() => queryClient.invalidateQueries({ queryKey: ['contacts'] })} />

                {/* Intent Scores */}
                {intentData && (intentData.buyer_intent_score > 0 || intentData.seller_intent_score > 0) && (
                  <Card>
                    <CardHeader>
                      <CardTitle className="text-lg flex items-center gap-2">
                        <Target className="w-5 h-5 text-indigo-600" />
                        Intent Scores
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {intentData.buyer_intent_score > 0 && (
                          <div className="space-y-2">
                            <IntentScoreBadge score={intentData.buyer_intent_score} type="Buyer" />
                            <Progress value={intentData.buyer_intent_score} className="h-2" />
                          </div>
                        )}
                        {intentData.seller_intent_score > 0 && (
                          <div className="space-y-2">
                            <IntentScoreBadge score={intentData.seller_intent_score} type="Seller" />
                            <Progress value={intentData.seller_intent_score} className="h-2" />
                          </div>
                        )}
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Intent Signals */}
                {intentData && intentData.signals && intentData.signals.length > 0 && (
                  <Card>
                    <CardHeader>
                      <CardTitle className="text-lg flex items-center gap-2">
                        <Activity className="w-5 h-5 text-indigo-600" />
                        Intent Signals
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="space-y-3">
                        {intentData.signals.map((signal, index) => (
                          <IntentSignalCard key={index} signal={signal} />
                        ))}
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Recommended Actions */}
                {intentData && intentData.recommended_actions && intentData.recommended_actions.length > 0 && (
                  <Card>
                    <CardHeader>
                      <CardTitle className="text-lg flex items-center gap-2">
                        <Zap className="w-5 h-5 text-indigo-600" />
                        Recommended Actions
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="space-y-2">
                        {intentData.recommended_actions.map((action, index) => (
                          <div key={index} className="flex items-start gap-3 p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">
                            <CheckCircle2 className="w-5 h-5 text-indigo-600 flex-shrink-0 mt-0.5" />
                            <p className="text-sm text-slate-700 dark:text-slate-300">{action}</p>
                          </div>
                        ))}
                      </div>
                    </CardContent>
                  </Card>
                )}
              </TabsContent>

              {/* Intent Analysis Tab */}
              <TabsContent value="intent" className="space-y-6">
                <PredictiveDataPoints contact={contact} />
              </TabsContent>

              {/* Communication Tab */}
              <TabsContent value="communication" className="space-y-6">
                {/* Activity Logger */}
                <ActivityLogger
                  entityType="contact"
                  entityId={contactId}
                  entityData={{
                    name: contact.name,
                    email: contact.email,
                    phone: contact.phone,
                    address: contact.property_address
                  }}
                  activities={contactActivities}
                  onActivityLogged={() => {
                    queryClient.invalidateQueries({ queryKey: ['contactActivities', contactId] });
                  }}
                />
                {/* AI Assistant Toggle */}
                <Card className="border-2 border-purple-200 dark:border-purple-800 bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20">
                  <CardHeader>
                    <div className="flex items-center justify-between">
                      <CardTitle className="text-lg flex items-center gap-2">
                        <Sparkles className="w-5 h-5 text-purple-600" />
                        AI Email Assistant
                      </CardTitle>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setShowAITools(!showAITools)}
                      >
                        {showAITools ? <X className="w-4 h-4 mr-2" /> : <Wand2 className="w-4 h-4 mr-2" />}
                        {showAITools ? 'Hide' : 'Show'} AI Tools
                      </Button>
                    </div>
                  </CardHeader>
                  {showAITools && (
                    <CardContent className="space-y-4">
                      {/* Thread Summary */}
                      {messages.length > 0 && (
                        <div className="space-y-3">
                          <Button
                            onClick={handleSummarizeThread}
                            disabled={isSummarizing}
                            variant="outline"
                            className="w-full"
                          >
                            {isSummarizing ? (
                              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            ) : (
                              <ListOrdered className="w-4 h-4 mr-2" />
                            )}
                            Summarize Email Thread
                          </Button>

                          {threadSummary && (
                            <div className="p-4 bg-white dark:bg-slate-800 rounded-lg border border-purple-200 dark:border-purple-700 space-y-3">
                              <div>
                                <h4 className="font-semibold text-sm mb-1">Summary</h4>
                                <p className="text-sm text-slate-700 dark:text-slate-300">{threadSummary.summary}</p>
                              </div>
                              
                              {threadSummary.key_topics && threadSummary.key_topics.length > 0 && (
                                <div>
                                  <h4 className="font-semibold text-sm mb-1">Key Topics</h4>
                                  <div className="flex flex-wrap gap-1">
                                    {threadSummary.key_topics.map((topic, i) => (
                                      <Badge key={i} variant="secondary" className="text-xs">
                                        {topic}
                                      </Badge>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {threadSummary.action_items && threadSummary.action_items.length > 0 && (
                                <div>
                                  <h4 className="font-semibold text-sm mb-1">Action Items</h4>
                                  <ul className="text-sm space-y-1">
                                    {threadSummary.action_items.map((item, i) => (
                                      <li key={i} className="flex items-start gap-2">
                                        <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                                        <span className="text-slate-700 dark:text-slate-300">{item}</span>
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              )}

                              {threadSummary.relationship_notes && (
                                <div>
                                  <h4 className="font-semibold text-sm mb-1">Relationship Insights</h4>
                                  <p className="text-sm text-slate-700 dark:text-slate-300">{threadSummary.relationship_notes}</p>
                                </div>
                              )}

                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => setThreadSummary(null)}
                                className="w-full"
                              >
                                <X className="w-4 h-4 mr-2" />
                                Dismiss
                              </Button>
                            </div>
                          )}
                        </div>
                      )}

                      {/* AI Draft Generator */}
                      <div className="space-y-3">
                        <div className="flex gap-2">
                          <Input
                            placeholder="What do you want to write about? (e.g., 'follow up on house viewing')"
                            value={aiPrompt}
                            onChange={(e) => setAiPrompt(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleGenerateDraft()}
                          />
                          <Button
                            onClick={handleGenerateDraft}
                            disabled={isGenerating}
                          >
                            {isGenerating ? (
                              <Loader2 className="w-4 h-4 animate-spin" />
                            ) : (
                              <Wand2 className="w-4 h-4" />
                            )}
                          </Button>
                        </div>
                        <p className="text-xs text-slate-500">
                          AI will generate a personalized email with your signature
                        </p>
                      </div>

                      {/* Tone Analyzer */}
                      {messageContent.trim() && (
                        <div className="space-y-3">
                          <Button
                            onClick={handleAnalyzeTone}
                            disabled={isAnalyzing}
                            variant="outline"
                            className="w-full"
                          >
                            {isAnalyzing ? (
                              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            ) : (
                              <Brain className="w-4 h-4 mr-2" />
                            )}
                            Analyze Tone & Professionalism
                          </Button>

                          {toneAnalysis && (
                            <div className="p-4 bg-white dark:bg-slate-800 rounded-lg border border-purple-200 dark:border-purple-700 space-y-3">
                              <div className="flex items-center justify-between">
                                <div>
                                  <h4 className="font-semibold text-sm">Overall Tone</h4>
                                  <p className="text-sm text-slate-600 dark:text-slate-400">{toneAnalysis.overall_tone}</p>
                                </div>
                                <div className="text-right">
                                  <div className="text-2xl font-bold text-purple-600">{toneAnalysis.professionalism_score}</div>
                                  <div className="text-xs text-slate-500">/ 100</div>
                                </div>
                              </div>

                              {toneAnalysis.strengths && toneAnalysis.strengths.length > 0 && (
                                <div>
                                  <h4 className="font-semibold text-sm mb-1 flex items-center gap-1">
                                    <ThumbsUp className="w-4 h-4 text-green-600" />
                                    Strengths
                                  </h4>
                                  <ul className="text-sm space-y-1">
                                    {toneAnalysis.strengths.map((strength, i) => (
                                      <li key={i} className="text-slate-700 dark:text-slate-300">‚Ä¢ {strength}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}

                              {toneAnalysis.improvements && toneAnalysis.improvements.length > 0 && (
                                <div>
                                  <h4 className="font-semibold text-sm mb-1 flex items-center gap-1">
                                    <ThumbsDown className="w-4 h-4 text-orange-600" />
                                    Suggested Improvements
                                  </h4>
                                  <ul className="text-sm space-y-1">
                                    {toneAnalysis.improvements.map((improvement, i) => (
                                      <li key={i} className="text-slate-700 dark:text-slate-300">‚Ä¢ {improvement}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}

                              <div className="flex gap-2">
                                {toneAnalysis.suggested_revisions && (
                                  <Button
                                    onClick={handleApplySuggestion}
                                    size="sm"
                                    className="flex-1"
                                  >
                                    <CheckCircle2 className="w-4 h-4 mr-2" />
                                    Apply Suggestions
                                  </Button>
                                )}
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => setToneAnalysis(null)}
                                >
                                  <X className="w-4 h-4" />
                                </Button>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </CardContent>
                  )}
                </Card>

                {/* Send Message */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg flex items-center gap-2">
                      <Send className="w-5 h-5 text-indigo-600" />
                      Send Message
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="flex gap-2">
                      <Button
                        variant={messageType === "internal" ? "default" : "outline"}
                        size="sm"
                        onClick={() => setMessageType("internal")}
                      >
                        Internal Note
                      </Button>
                      <Button
                        variant={messageType === "email" ? "default" : "outline"}
                        size="sm"
                        onClick={() => setMessageType("email")}
                      >
                        Email
                      </Button>
                      {messageContent.trim() && (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={handleCopyDraft}
                          className="ml-auto"
                        >
                          {copiedDraft ? (
                            <Check className="w-4 h-4 mr-2 text-green-600" />
                          ) : (
                            <Copy className="w-4 h-4 mr-2" />
                          )}
                          {copiedDraft ? 'Copied!' : 'Copy Draft'}
                        </Button>
                      )}
                    </div>

                    {messageType === "email" && (
                      <Input
                        placeholder="Email Subject"
                        value={emailSubject}
                        onChange={(e) => setEmailSubject(e.target.value)}
                      />
                    )}

                    <Textarea
                      placeholder="Type your message..."
                      value={messageContent}
                      onChange={(e) => setMessageContent(e.target.value)}
                      rows={6}
                    />

                    {messageType === "email" && (
                      <div className="text-xs text-slate-500 bg-slate-50 dark:bg-slate-800 p-3 rounded-lg">
                        <strong>Your signature will be automatically added:</strong>
                        <pre className="mt-2 text-slate-600 dark:text-slate-400 whitespace-pre-wrap">
                          {currentUser ? generateEmailSignature(currentUser) : 'Loading signature...'}
                        </pre>
                      </div>
                    )}

                    <Button
                      onClick={handleSendMessage}
                      disabled={isSending}
                      className="w-full"
                    >
                      {isSending ? (
                        <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      ) : (
                        <Send className="w-4 h-4 mr-2" />
                      )}
                      Send {messageType === 'email' ? 'Email' : 'Message'}
                    </Button>
                  </CardContent>
                </Card>

                {/* Message History */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg flex items-center gap-2">
                      <MessageSquare className="w-5 h-5 text-indigo-600" />
                      Communication History
                      {sortedMessages.length > 0 && (
                        <Badge variant="secondary" className="ml-auto">
                          {sortedMessages.length} {sortedMessages.length === 1 ? 'message' : 'messages'}
                        </Badge>
                      )}
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    {sortedMessages.length === 0 ? (
                      <p className="text-center text-slate-500 py-8">No messages yet</p>
                    ) : (
                      <div className="space-y-3">
                        {sortedMessages.map((message) => {
                          const messageDate = new Date(message.created_date);
                          const now = new Date();
                          const diffMinutes = Math.floor((now - messageDate) / (1000 * 60));
                          
                          // Better time display
                          let timeDisplay = '';
                          if (diffMinutes < 1) {
                            timeDisplay = 'Just now';
                          } else if (diffMinutes < 60) {
                            timeDisplay = `${diffMinutes} ${diffMinutes === 1 ? 'minute' : 'minutes'} ago`;
                          } else if (diffMinutes < 1440) {
                            const hours = Math.floor(diffMinutes / 60);
                            timeDisplay = `${hours} ${hours === 1 ? 'hour' : 'hours'} ago`;
                          } else {
                            timeDisplay = formatDistanceToNow(messageDate, { addSuffix: true });
                          }

                          return (
                            <div
                              key={message.id}
                              className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 hover:shadow-md transition-shadow"
                            >
                              <div className="flex items-start justify-between mb-2">
                                <Badge variant="outline" className="text-xs">
                                  {message.message_type === 'email' ? 'üìß Email' : 'üìù Internal'}
                                </Badge>
                                <div className="text-right">
                                  <p className="text-xs font-semibold text-slate-700 dark:text-slate-300">
                                    {timeDisplay}
                                  </p>
                                  <p className="text-xs text-slate-500 mt-0.5">
                                    {messageDate.toLocaleString('en-US', {
                                      month: 'short',
                                      day: 'numeric',
                                      hour: 'numeric',
                                      minute: '2-digit',
                                      hour12: true
                                    })}
                                  </p>
                                </div>
                              </div>
                              {message.subject && (
                                <p className="font-semibold text-sm mb-1 text-slate-900 dark:text-white">{message.subject}</p>
                              )}
                              <p className="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">{message.content}</p>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </CardContent>
                </Card>
              </TabsContent>

              {/* Notes Tab */}
              <TabsContent value="notes" className="space-y-6">
                {/* Add New Note */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg flex items-center gap-2">
                      <Plus className="w-5 h-5 text-indigo-600" />
                      Add Note
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <Textarea
                      placeholder="Add a note about this contact..."
                      value={newNote}
                      onChange={(e) => setNewNote(e.target.value)}
                      rows={4}
                    />
                    <Button
                      onClick={handleSaveNote}
                      disabled={isSavingNote}
                      className="w-full"
                    >
                      {isSavingNote ? (
                        <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      ) : (
                        <CheckCircle2 className="w-4 h-4 mr-2" />
                      )}
                      Save Note
                    </Button>
                  </CardContent>
                </Card>

                {/* Existing Notes */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg flex items-center gap-2">
                      <FileText className="w-5 h-5 text-indigo-600" />
                      Notes History
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    {!contact.notes ? (
                      <p className="text-center text-slate-500 py-8">No notes yet</p>
                    ) : (
                      <div className="prose prose-sm dark:prose-invert max-w-none">
                        <pre className="whitespace-pre-wrap text-sm text-slate-700 dark:text-slate-300 font-sans">
                          {contact.notes}
                        </pre>
                      </div>
                    )}
                  </CardContent>
                </Card>
              </TabsContent>
            </Tabs>
          </div>
        </div>
      </div>

      {/* Edit Modal */}
      {showEditModal && (
        <ContactModal
          contact={contact}
          onSave={async (updatedData) => {
            try {
              await base44.entities.Contact.update(contactId, updatedData);
              toast.success("Contact updated successfully");
              setShowEditModal(false);
              await loadData();
              queryClient.invalidateQueries({ queryKey: ['contacts'] });
            } catch (error) {
              console.error("Error updating contact:", error);
              toast.error("Failed to update contact");
            }
          }}
          onClose={() => setShowEditModal(false)}
        />
      )}
    </div>
  );
}
import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card } from '@/components/ui/card';
import { Plus, Search, Upload, Filter, Users, TrendingUp, AlertCircle, AlertTriangle, Brain, Grid3x3, List, ArrowUpDown, ArrowUp, ArrowDown, ArrowLeft, Trash2, Copy, CheckCircle, XCircle, Loader2 } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { toast } from 'sonner';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';

import ContactCard from '../components/contacts/ContactCard';
import ContactModal from '../components/contacts/ContactModal';
import ContactStats from '../components/contacts/ContactStats';
import ContactCSVImportModal from '../components/contacts/ContactCSVImportModal';
import AdvancedSegmentation from '../components/contacts/AdvancedSegmentation';
import LoadingSpinner from '../components/common/LoadingSpinner';

export default function Contacts() {
    const navigate = useNavigate();
    const queryClient = useQueryClient();
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedRelationship, setSelectedRelationship] = useState('all');
    const [selectedHealthFilter, setSelectedHealthFilter] = useState('all');
    const [showModal, setShowModal] = useState(false);
    const [showImportModal, setShowImportModal] = useState(false);
    const [editingContact, setEditingContact] = useState(null);
    const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'list'
    const [showDuplicatesModal, setShowDuplicatesModal] = useState(false);
    const [sortBy, setSortBy] = useState({ column: 'name', direction: 'asc' });
    const [selectedContacts, setSelectedContacts] = useState([]);
    const [advancedFilters, setAdvancedFilters] = useState({
        tags: [],
        leadSources: [],
        industries: [],
        minEngagement: 0,
        maxEngagement: 100,
        relationship: 'all',
        relationshipHealth: 'all'
    });

    // Optimize query with longer staleTime and no auto-refetch
    const { data: contacts = [], isLoading, error } = useQuery({
        queryKey: ['contacts'],
        queryFn: () => base44.entities.Contact.list('-last_contact_date', 500),
        staleTime: 30 * 1000,
        refetchInterval: 30 * 1000,
    });

    const createContactMutation = useMutation({
        mutationFn: (contactData) => base44.entities.Contact.create(contactData),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['contacts'] });
            toast.success('Contact created successfully!');
            setShowModal(false);
            setEditingContact(null);
        },
        onError: (error) => {
            toast.error(`Failed to create contact: ${error.message}`);
        },
    });

    const updateContactMutation = useMutation({
        mutationFn: ({ id, data }) => base44.entities.Contact.update(id, data),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['contacts'] });
            toast.success('Contact updated successfully!');
            setShowModal(false);
            setEditingContact(null);
        },
        onError: (error) => {
            toast.error(`Failed to update contact: ${error.message}`);
        },
    });

    const deleteContactMutation = useMutation({
        mutationFn: (id) => base44.entities.Contact.delete(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['contacts'] });
            setSelectedContacts([]);
            toast.success('Contact deleted successfully!');
        },
        onError: (error) => {
            toast.error(`Failed to delete contact: ${error.message}`);
        },
    });

    const bulkDeleteMutation = useMutation({
        mutationFn: async (ids) => {
            const results = await Promise.allSettled(
                ids.map(id => base44.entities.Contact.delete(id))
            );
            
            const succeeded = results.filter(r => r.status === 'fulfilled').length;
            const failed = results.filter(r => r.status === 'rejected').length;
            
            return { succeeded, failed, total: ids.length };
        },
        onSuccess: (result) => {
            queryClient.invalidateQueries({ queryKey: ['contacts'] });
            setSelectedContacts([]);
            
            if (result.failed > 0) {
                toast.warning(`${result.succeeded} contacts deleted, ${result.failed} failed`);
            } else {
                toast.success(`${result.succeeded} contact${result.succeeded !== 1 ? 's' : ''} deleted successfully!`);
            }
        },
        onError: (error) => {
            toast.error(`Failed to delete contacts: ${error.message}`);
        },
    });

    const handleSave = (contactData) => {
        if (editingContact) {
            updateContactMutation.mutate({ id: editingContact.id, data: contactData });
        } else {
            createContactMutation.mutate(contactData);
        }
    };

    const handleEdit = (contact) => {
        setEditingContact(contact);
        setShowModal(true);
    };

    const handleDelete = (id) => {
        if (window.confirm('Are you sure you want to delete this contact?')) {
            deleteContactMutation.mutate(id);
        }
    };

    const handleBulkDelete = () => {
        if (window.confirm(`Are you sure you want to delete ${selectedContacts.length} selected contacts?`)) {
            bulkDeleteMutation.mutate(selectedContacts);
        }
    };

    const toggleSelectAll = () => {
        if (selectedContacts.length === filteredContacts.length) {
            setSelectedContacts([]);
        } else {
            setSelectedContacts(filteredContacts.map(c => c.id));
        }
    };

    const toggleSelectContact = (id) => {
        setSelectedContacts(prev => 
            prev.includes(id) ? prev.filter(cid => cid !== id) : [...prev, id]
        );
    };

    const handleImportComplete = async () => {
        // Force immediate refresh
        await queryClient.invalidateQueries({ queryKey: ['contacts'] });
        await queryClient.refetchQueries({ queryKey: ['contacts'], type: 'active' });
        setShowImportModal(false);
        toast.success('Contacts imported successfully!');
    };

    const findDuplicates = () => {
        const emailMap = new Map();
        const nameMap = new Map();
        const duplicates = [];
        
        // Find email duplicates
        contacts.forEach(contact => {
            if (!contact.email) return;
            const email = contact.email.toLowerCase().trim();
            
            if (emailMap.has(email)) {
                emailMap.get(email).push(contact);
            } else {
                emailMap.set(email, [contact]);
            }
        });
        
        // Find name duplicates
        contacts.forEach(contact => {
            if (!contact.name) return;
            const name = contact.name.toLowerCase().trim();
            
            if (nameMap.has(name)) {
                nameMap.get(name).push(contact);
            } else {
                nameMap.set(name, [contact]);
            }
        });
        
        // Process email duplicates
        emailMap.forEach((group) => {
            if (group.length > 1) {
                group.sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
                const toDelete = group.slice(1);
                duplicates.push({
                    type: 'email',
                    email: group[0].email,
                    keepContact: group[0],
                    deleteContacts: toDelete,
                    count: group.length
                });
            }
        });
        
        // Process name duplicates
        nameMap.forEach((group) => {
            if (group.length > 1) {
                group.sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
                const toDelete = group.slice(1);
                duplicates.push({
                    type: 'name',
                    name: group[0].name,
                    keepContact: group[0],
                    deleteContacts: toDelete,
                    count: group.length
                });
            }
        });
        
        return duplicates;
    };

    const duplicates = useMemo(() => findDuplicates(), [contacts]);

    const handleRemoveDuplicates = async () => {
        if (duplicates.length === 0) {
            toast.info('No duplicates found!');
            return;
        }

        const idsToDelete = duplicates.flatMap(dup => dup.deleteContacts.map(c => c.id));
        
        toast.info(`Removing ${idsToDelete.length} duplicate contacts...`);
        setShowDuplicatesModal(false);
        bulkDeleteMutation.mutate(idsToDelete);
    };

    const handleSort = (column) => {
        setSortBy(prev => ({
            column,
            direction: prev.column === column && prev.direction === 'asc' ? 'desc' : 'asc'
        }));
    };

    const SortableHeader = ({ column, children }) => (
        <th 
            className="text-left px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-300 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 select-none"
            onClick={() => handleSort(column)}
        >
            <div className="flex items-center gap-2">
                {children}
                {sortBy.column === column && (
                    sortBy.direction === 'asc' 
                        ? <ArrowUp className="w-4 h-4" style={{ color: 'var(--theme-primary)' }} />
                        : <ArrowDown className="w-4 h-4" style={{ color: 'var(--theme-primary)' }} />
                )}
            </div>
        </th>
    );

    const filteredContacts = useMemo(() => {
        let filtered = contacts.filter(contact => {
            const searchLower = searchTerm.toLowerCase().trim();
            const matchesSearch = !searchLower || 
                contact.name?.toLowerCase().includes(searchLower) ||
                contact.email?.toLowerCase().includes(searchLower) ||
                contact.phone?.toLowerCase().includes(searchLower) ||
                contact.tags?.toLowerCase().includes(searchLower);
            
            const matchesRelationship = selectedRelationship === 'all' || contact.relationship === selectedRelationship;
            
            const matchesHealth = selectedHealthFilter === 'all' || 
                (selectedHealthFilter === 'needs_attention' && 
                    (contact.relationship_health === 'at-risk' || contact.relationship_health === 'at_risk' || contact.relationship_health === 'weak')) ||
                contact.relationship_health === selectedHealthFilter;
            
            // Advanced filters
            if (advancedFilters.tags.length > 0) {
                const contactTags = contact.tags ? contact.tags.split(',').map(t => t.trim()) : [];
                const hasMatchingTag = advancedFilters.tags.some(tag => contactTags.includes(tag));
                if (!hasMatchingTag) return false;
            }

            if (advancedFilters.leadSources.length > 0 && !advancedFilters.leadSources.includes(contact.lead_source)) {
                return false;
            }

            if (advancedFilters.industries.length > 0 && !advancedFilters.industries.includes(contact.industry)) {
                return false;
            }

            const engagement = contact.engagement_score || 0;
            if (engagement < advancedFilters.minEngagement || engagement > advancedFilters.maxEngagement) {
                return false;
            }

            if (advancedFilters.relationship !== 'all' && contact.relationship !== advancedFilters.relationship) {
                return false;
            }

            if (advancedFilters.relationshipHealth !== 'all' && contact.relationship_health !== advancedFilters.relationshipHealth) {
                return false;
            }
            
            return matchesSearch && matchesRelationship && matchesHealth;
        });

        // Dynamic sorting
        filtered.sort((a, b) => {
            let aVal, bVal;
            
            switch (sortBy.column) {
                case 'name':
                    aVal = a.name || '';
                    bVal = b.name || '';
                    break;
                case 'email':
                    aVal = a.email || '';
                    bVal = b.email || '';
                    break;
                case 'phone':
                    aVal = a.phone || '';
                    bVal = b.phone || '';
                    break;
                case 'relationship':
                    aVal = a.relationship || '';
                    bVal = b.relationship || '';
                    break;
                case 'health':
                    const healthOrder = { strong: 1, cooling: 2, at_risk: 3, unknown: 4 };
                    aVal = healthOrder[a.relationship_health] || 4;
                    bVal = healthOrder[b.relationship_health] || 4;
                    break;
                case 'tags':
                    aVal = a.tags || '';
                    bVal = b.tags || '';
                    break;
                default:
                    return 0;
            }
            
            const comparison = typeof aVal === 'string' 
                ? aVal.localeCompare(bVal)
                : aVal - bVal;
            
            return sortBy.direction === 'asc' ? comparison : -comparison;
        });

        return filtered;
    }, [contacts, searchTerm, selectedRelationship, selectedHealthFilter, advancedFilters, sortBy]);

    // Calculate contacts needing attention
    const contactsNeedingAttention = contacts.filter(c => 
        c.relationship_health === 'at-risk' || 
        c.relationship_health === 'at_risk' || 
        c.relationship_health === 'weak'
    ).length;

    // Show error message if query failed
    if (error && contacts.length === 0) {
        return (
            <div className="page-container space-y-6">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="page-title">Contacts</h1>
                        <p className="text-slate-600 dark:text-slate-400">
                            Manage your sphere of influence
                        </p>
                    </div>
                </div>

                <Card className="p-8 text-center">
                    <AlertCircle className="w-12 h-12 text-amber-500 mx-auto mb-4" />
                    <h3 className="text-lg font-semibold mb-2">Unable to Load Contacts</h3>
                    <p className="text-slate-600 dark:text-slate-400 mb-4">
                        We're experiencing high traffic. Please try again in a moment.
                    </p>
                    <Button onClick={() => queryClient.invalidateQueries({ queryKey: ['contacts'] })}>
                        Try Again
                    </Button>
                </Card>
            </div>
        );
    }

    if (isLoading) {
        return <LoadingSpinner icon={Users} title="Loading Contacts..." description="Loading your sphere of influence contacts" />;
    }

    return (
        <div className="space-y-6">
            {/* Hero Header */}
            <div 
                className="rounded-2xl p-6 md:p-8 text-white relative overflow-hidden"
                style={{ background: 'linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%)' }}
            >
                <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4xIj48cGF0aCBkPSJNMzYgMzRoLTJ2LTRoMnY0em0wLTZ2LTRoLTJ2NGgyem0tNiA2di00aC00djRoNHptMC02di00aC00djRoNHptLTYgNnYtNGgtNHY0aDR6bTAtNnYtNGgtNHY0aDR6Ii8+PC9nPjwvZz48L3N2Zz4=')] opacity-30"></div>
                <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <div className="flex items-center gap-3 mb-2">
                            <Button 
                                variant="ghost" 
                                size="sm" 
                                onClick={() => navigate(-1)}
                                className="text-white hover:bg-white/20 -ml-2"
                            >
                                <ArrowLeft className="w-5 h-5" />
                            </Button>
                            <div className="w-12 h-12 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center">
                                <Users className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold">Contacts</h1>
                                <p className="text-white/80 text-sm">
                                    Manage your sphere of influence
                                </p>
                            </div>
                        </div>
                    </div>
                    <div className="flex flex-wrap gap-2">
                        <AdvancedSegmentation
                            contacts={contacts}
                            currentFilters={advancedFilters}
                            onFilterChange={setAdvancedFilters}
                            onApplySegment={() => {}}
                        />
                        <Button
                            variant="outline"
                            onClick={() => {
                                const dupes = findDuplicates();
                                if (dupes.length === 0) {
                                    toast.success('No duplicates found!');
                                } else {
                                    const emailCount = dupes.filter(d => d.type === 'email').length;
                                    const nameCount = dupes.filter(d => d.type === 'name').length;
                                    toast.success(`Found ${dupes.length} duplicate groups: ${emailCount} by email, ${nameCount} by name`);
                                    setShowDuplicatesModal(true);
                                }
                            }}
                            className="border-white/30 text-white hover:bg-white/20 bg-white/10"
                        >
                            <Copy className="w-4 h-4 mr-2" />
                            Find Duplicates
                        </Button>
                        <Button
                            variant="outline"
                            onClick={() => setShowImportModal(true)}
                            className="border-white/30 text-white hover:bg-white/20 bg-white/10"
                        >
                            <Upload className="w-4 h-4 mr-2" />
                            Import CSV
                        </Button>
                        <Button 
                            onClick={() => { setEditingContact(null); setShowModal(true); }}
                            className="bg-white hover:bg-white/90"
                            style={{ color: 'var(--theme-primary)' }}
                        >
                            <Plus className="w-4 h-4 mr-2" />
                            Add Contact
                        </Button>
                    </div>
                </div>

            </div>

            {/* Colorful Stats Cards */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <Card className="bg-gradient-to-br from-slate-600 to-slate-800 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl">
                    <div className="p-4">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-white/80">Total Contacts</p>
                                <p className="text-2xl font-bold">{contacts.length}</p>
                            </div>
                            <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                <Users className="w-5 h-5" />
                            </div>
                        </div>
                    </div>
                </Card>

                <Card 
                    className={`bg-gradient-to-br from-green-500 to-emerald-600 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl ${selectedHealthFilter === 'strong' ? 'ring-2 ring-white ring-offset-2' : ''}`}
                    onClick={() => setSelectedHealthFilter(selectedHealthFilter === 'strong' ? 'all' : 'strong')}
                >
                    <div className="p-4">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-white/80">Strong Relations</p>
                                <p className="text-2xl font-bold">{contacts.filter(c => c.relationship_health === 'strong').length}</p>
                            </div>
                            <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                <TrendingUp className="w-5 h-5" />
                            </div>
                        </div>
                    </div>
                </Card>

                <Card 
                    className={`bg-gradient-to-br from-blue-500 to-cyan-600 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl ${selectedRelationship === 'past_client' ? 'ring-2 ring-white ring-offset-2' : ''}`}
                    onClick={() => setSelectedRelationship(selectedRelationship === 'past_client' ? 'all' : 'past_client')}
                >
                    <div className="p-4">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-white/80">Past Clients</p>
                                <p className="text-2xl font-bold">{contacts.filter(c => c.relationship === 'past_client').length}</p>
                            </div>
                            <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                <Users className="w-5 h-5" />
                            </div>
                        </div>
                    </div>
                </Card>

                <Card 
                    className={`bg-gradient-to-br from-amber-500 to-orange-600 text-white border-0 shadow-lg cursor-pointer transition-all hover:scale-105 hover:shadow-xl ${selectedHealthFilter === 'needs_attention' ? 'ring-2 ring-white ring-offset-2' : ''}`}
                    onClick={() => setSelectedHealthFilter(selectedHealthFilter === 'needs_attention' ? 'all' : 'needs_attention')}
                >
                    <div className="p-4">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-white/80">Needs Attention</p>
                                <p className="text-2xl font-bold">{contactsNeedingAttention}</p>
                            </div>
                            <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                <AlertTriangle className="w-5 h-5" />
                            </div>
                        </div>
                    </div>
                </Card>
            </div>



            {/* Attention Banner */}
            {contactsNeedingAttention > 0 && (
                <Card className="border-l-4 border-l-amber-500 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20">
                    <div className="p-4 flex items-center gap-4">
                        <div className="w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-900/50 flex items-center justify-center flex-shrink-0">
                            <AlertTriangle className="w-5 h-5 text-amber-600" />
                        </div>
                        <div className="flex-1">
                            <h3 className="font-semibold text-amber-900 dark:text-amber-100">
                                {contactsNeedingAttention} {contactsNeedingAttention === 1 ? 'Contact Needs' : 'Contacts Need'} Attention
                            </h3>
                            <p className="text-sm text-amber-700 dark:text-amber-300">
                                AI has identified relationships at risk. Review and take action to strengthen connections.
                            </p>
                        </div>
                        <Button
                            size="sm"
                            onClick={() => setSelectedHealthFilter('needs_attention')}
                            className="bg-amber-600 hover:bg-amber-700 text-white"
                        >
                            <Brain className="w-4 h-4 mr-2" />
                            View All
                        </Button>
                    </div>
                </Card>
            )}

            {/* Filters Card */}
            <Card className="p-4">
                <div className="flex flex-col lg:flex-row gap-4">
                    <div className="relative flex-1">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                        <Input
                            placeholder="Search contacts by name, email or phone..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="pl-10"
                        />
                    </div>
                    <div className="flex flex-wrap gap-2">
                        {viewMode === 'grid' && (
                            <select
                                value={`${sortBy.column}-${sortBy.direction}`}
                                onChange={(e) => {
                                    const [column, direction] = e.target.value.split('-');
                                    setSortBy({ column, direction });
                                }}
                                className="px-3 py-2 border rounded-lg text-sm bg-white dark:bg-slate-800 dark:border-slate-700"
                            >
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                            </select>
                        )}
                        <select
                            value={selectedRelationship}
                            onChange={(e) => setSelectedRelationship(e.target.value)}
                            className="px-3 py-2 border rounded-lg text-sm bg-white dark:bg-slate-800 dark:border-slate-700"
                        >
                            <option value="all">All Relationships</option>
                            <option value="past_client">Past Clients</option>
                            <option value="family">Family</option>
                            <option value="friend">Friends</option>
                            <option value="professional">Professional</option>
                            <option value="vendor">Vendors</option>
                        </select>
                        <select
                            value={selectedHealthFilter}
                            onChange={(e) => setSelectedHealthFilter(e.target.value)}
                            className="px-3 py-2 border rounded-lg text-sm bg-white dark:bg-slate-800 dark:border-slate-700"
                        >
                            <option value="all">All Health Levels</option>
                            <option value="needs_attention">‚ö†Ô∏è Needs Attention</option>
                            <option value="strong">üíö Strong</option>
                            <option value="moderate">üíõ Moderate</option>
                            <option value="weak">üß° Weak</option>
                            <option value="at_risk">‚ù§Ô∏è At Risk</option>
                        </select>
                        <div className="flex gap-1 border rounded-lg p-1 bg-slate-50 dark:bg-slate-800 dark:border-slate-700">
                            <Button
                                variant={viewMode === 'grid' ? 'default' : 'ghost'}
                                size="sm"
                                onClick={() => setViewMode('grid')}
                                className={viewMode === 'grid' ? '' : ''}
                                style={viewMode === 'grid' ? { background: 'var(--theme-primary)' } : {}}
                            >
                                <Grid3x3 className="w-4 h-4" />
                            </Button>
                            <Button
                                variant={viewMode === 'list' ? 'default' : 'ghost'}
                                size="sm"
                                onClick={() => setViewMode('list')}
                                style={viewMode === 'list' ? { background: 'var(--theme-primary)' } : {}}
                            >
                                <List className="w-4 h-4" />
                            </Button>
                        </div>
                    </div>
                </div>
                <div className="flex items-center justify-between mt-3">
                    <div className="flex items-center gap-3 text-sm text-slate-500">
                        <div className="flex items-center gap-2">
                            <input
                                type="checkbox"
                                checked={selectedContacts.length === filteredContacts.length && filteredContacts.length > 0}
                                onChange={toggleSelectAll}
                                className="w-4 h-4 rounded border-slate-300 cursor-pointer"
                            />
                            <span className="font-medium text-slate-700 dark:text-slate-300">Select All</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <Filter className="w-4 h-4" />
                            <span>Showing {filteredContacts.length} of {contacts.length} contacts</span>
                            {selectedContacts.length > 0 && (
                                <span className="ml-2 text-indigo-600 dark:text-indigo-400 font-medium">
                                    ‚Ä¢ {selectedContacts.length} selected
                                </span>
                            )}
                        </div>
                    </div>
                    {selectedContacts.length > 0 && (
                        <Button
                            size="sm"
                            variant="destructive"
                            onClick={handleBulkDelete}
                            disabled={bulkDeleteMutation.isLoading}
                        >
                            <Trash2 className="w-4 h-4 mr-2" />
                            Delete Selected ({selectedContacts.length})
                        </Button>
                    )}
                </div>
            </Card>

            {filteredContacts.length === 0 ? (
                <Card className="p-8 text-center">
                    <Users className="w-12 h-12 text-slate-400 mx-auto mb-4" />
                    <h3 className="text-lg font-semibold mb-2">No Contacts Found</h3>
                    <p className="text-slate-600 dark:text-slate-400 mb-4">
                        {searchTerm || selectedRelationship !== 'all' || selectedHealthFilter !== 'all'
                            ? 'Try adjusting your filters'
                            : 'Start building your sphere of influence by adding contacts'}
                    </p>
                    {!searchTerm && selectedRelationship === 'all' && selectedHealthFilter === 'all' && (
                        <Button onClick={() => setShowModal(true)}>
                            <Plus className="w-4 h-4 mr-2" />
                            Add Your First Contact
                        </Button>
                    )}
                </Card>
            ) : viewMode === 'grid' ? (
                <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                    {filteredContacts.map(contact => (
                        <ContactCard
                            key={contact.id}
                            contact={contact}
                            onEdit={handleEdit}
                            onDelete={handleDelete}
                            onClick={() => navigate(createPageUrl(`ContactDetail?id=${contact.id}`))}
                            isSelected={selectedContacts.includes(contact.id)}
                            onSelect={toggleSelectContact}
                        />
                    ))}
                </div>
            ) : (
                <Card>
                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead className="bg-slate-50 dark:bg-slate-800 border-b">
                                <tr>
                                    <th className="px-4 py-3 text-left">
                                        <input
                                            type="checkbox"
                                            checked={selectedContacts.length === filteredContacts.length && filteredContacts.length > 0}
                                            onChange={toggleSelectAll}
                                            className="w-4 h-4 rounded border-slate-300 cursor-pointer"
                                        />
                                    </th>
                                    <SortableHeader column="name">Name</SortableHeader>
                                    <SortableHeader column="email">Email</SortableHeader>
                                    <SortableHeader column="phone">Phone</SortableHeader>
                                    <SortableHeader column="relationship">Relationship</SortableHeader>
                                    <SortableHeader column="health">Health</SortableHeader>
                                    <SortableHeader column="tags">Tags</SortableHeader>
                                    <th className="text-right px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-300">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredContacts.map(contact => (
                                   <tr 
                                       key={contact.id} 
                                       className="border-b hover:bg-slate-50 dark:hover:bg-slate-800/50 cursor-pointer"
                                       onClick={() => navigate(createPageUrl(`ContactDetail?id=${contact.id}`))}
                                   >
                                       <td className="px-4 py-3" onClick={(e) => e.stopPropagation()}>
                                           <input
                                               type="checkbox"
                                               checked={selectedContacts.includes(contact.id)}
                                               onChange={() => toggleSelectContact(contact.id)}
                                               className="w-4 h-4 rounded border-slate-300 cursor-pointer"
                                           />
                                       </td>
                                       <td className="px-4 py-3">
                                            <div className="flex items-center gap-3">
                                                <div 
                                                    className="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold"
                                                    style={{ background: 'linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%)' }}
                                                >
                                                    {contact.name?.charAt(0)}
                                                </div>
                                                <span className="font-medium text-slate-900 dark:text-white">{contact.name}</span>
                                            </div>
                                        </td>
                                        <td className="px-4 py-3 text-sm text-slate-600 dark:text-slate-400">{contact.email}</td>
                                        <td className="px-4 py-3 text-sm text-slate-600 dark:text-slate-400">{contact.phone || '-'}</td>
                                        <td className="px-4 py-3">
                                            <span className="text-sm capitalize">{contact.relationship?.replace('_', ' ') || '-'}</span>
                                        </td>
                                        <td className="px-4 py-3">
                                            {contact.relationship_health === 'strong' && <span className="text-green-600">üíö Strong</span>}
                                            {contact.relationship_health === 'cooling' && <span className="text-yellow-600">üíõ Cooling</span>}
                                            {contact.relationship_health === 'at_risk' && <span className="text-red-600">‚ù§Ô∏è At Risk</span>}
                                            {!contact.relationship_health && <span className="text-slate-400">-</span>}
                                        </td>
                                        <td className="px-4 py-3">
                                            <div className="flex flex-wrap gap-1">
                                                {contact.tags?.split(',').slice(0, 2).map((tag, idx) => (
                                                    <span key={idx} className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded">
                                                        {tag.trim()}
                                                    </span>
                                                ))}
                                                {contact.tags?.split(',').length > 2 && (
                                                    <span className="text-xs text-slate-500">+{contact.tags.split(',').length - 2}</span>
                                                )}
                                            </div>
                                        </td>
                                        <td className="px-4 py-3 text-right" onClick={(e) => e.stopPropagation()}>
                                            <div className="flex justify-end gap-1">
                                                <Button size="sm" variant="ghost" onClick={() => handleEdit(contact)}>
                                                    Edit
                                                </Button>
                                                <Button size="sm" variant="ghost" onClick={() => handleDelete(contact.id)} className="text-red-600">
                                                    Delete
                                                </Button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            )}

            {showModal && (
                <ContactModal
                    contact={editingContact}
                    onSave={handleSave}
                    onClose={() => {
                        setShowModal(false);
                        setEditingContact(null);
                    }}
                />
            )}

            {showImportModal && (
                <ContactCSVImportModal
                    onClose={() => setShowImportModal(false)}
                    onComplete={handleImportComplete}
                />
            )}

            {showDuplicatesModal && (
                <Dialog open={showDuplicatesModal} onOpenChange={setShowDuplicatesModal}>
                    <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
                        <DialogHeader>
                            <DialogTitle className="flex items-center gap-2">
                                <Copy className="w-5 h-5" />
                                Duplicate Contacts Preview
                            </DialogTitle>
                            <DialogDescription>
                                Found {duplicates.length} duplicate group{duplicates.length !== 1 ? 's' : ''} by email and name. 
                                We'll keep the NEWEST contact and remove {duplicates.reduce((sum, dup) => sum + dup.deleteContacts.length, 0)} older duplicate{duplicates.reduce((sum, dup) => sum + dup.deleteContacts.length, 0) !== 1 ? 's' : ''}.
                            </DialogDescription>
                        </DialogHeader>

                        {/* Filter Tabs */}
                        <div className="flex gap-2 mt-4">
                            <Button
                                size="sm"
                                variant="outline"
                                onClick={() => {
                                    const emailDupes = duplicates.filter(d => d.type === 'email');
                                    const nameOnly = duplicates.filter(d => d.type === 'name');
                                    toast.info(`${emailDupes.length} email duplicates, ${nameOnly.length} name duplicates`);
                                }}
                                className="flex-1"
                            >
                                üìß {duplicates.filter(d => d.type === 'email').length} Email Duplicates
                            </Button>
                            <Button
                                size="sm"
                                variant="outline"
                                className="flex-1"
                            >
                                üë§ {duplicates.filter(d => d.type === 'name').length} Name Duplicates
                            </Button>
                        </div>

                        <div className="space-y-4 mt-4">
                            {duplicates.map((dup, idx) => (
                                <Card key={idx} className="p-4">
                                    <div className="font-semibold text-lg mb-3 flex items-center gap-2">
                                        <span className="text-slate-700 dark:text-slate-300">
                                            {dup.type === 'email' ? 'Email:' : 'Name:'}
                                        </span>
                                        <span className="text-blue-600">{dup.type === 'email' ? dup.email : dup.name}</span>
                                        <span className="text-sm text-slate-500">({dup.count} contacts)</span>
                                    </div>

                                    {/* Contact to KEEP */}
                                    <div className="bg-green-50 dark:bg-green-900/20 border-2 border-green-500 rounded-lg p-3 mb-3">
                                        <div className="flex items-start gap-3">
                                            <CheckCircle className="w-5 h-5 text-green-600 flex-shrink-0 mt-1" />
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="font-semibold text-green-700 dark:text-green-300">KEEPING (Newest)</span>
                                                    <span className="text-xs bg-green-200 dark:bg-green-800 px-2 py-0.5 rounded">
                                                        Created: {new Date(dup.keepContact.created_date).toLocaleString()}
                                                    </span>
                                                </div>
                                                <p className="font-medium text-slate-900 dark:text-white">{dup.keepContact.name}</p>
                                                <div className="text-sm text-slate-600 dark:text-slate-400 mt-1">
                                                    <p>Phone: {dup.keepContact.phone || 'N/A'}</p>
                                                    {dup.keepContact.tags && <p>Tags: {dup.keepContact.tags}</p>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Contacts to DELETE */}
                                    <div className="space-y-2">
                                        {dup.deleteContacts.map((contact, cidx) => (
                                            <div key={cidx} className="bg-red-50 dark:bg-red-900/20 border-2 border-red-500 rounded-lg p-3">
                                                <div className="flex items-start gap-3">
                                                    <XCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-1" />
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="font-semibold text-red-700 dark:text-red-300">WILL DELETE (Older)</span>
                                                            <span className="text-xs bg-red-200 dark:bg-red-800 px-2 py-0.5 rounded">
                                                                Created: {new Date(contact.created_date).toLocaleString()}
                                                            </span>
                                                        </div>
                                                        <p className="font-medium text-slate-900 dark:text-white">{contact.name}</p>
                                                        <div className="text-sm text-slate-600 dark:text-slate-400 mt-1">
                                                            <p>Phone: {contact.phone || 'N/A'}</p>
                                                            {contact.tags && <p>Tags: {contact.tags}</p>}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </Card>
                            ))}
                        </div>

                        <div className="flex gap-3 mt-6 pt-4 border-t">
                            <Button
                                variant="outline"
                                onClick={() => setShowDuplicatesModal(false)}
                                className="flex-1"
                            >
                                Cancel
                            </Button>
                            <Button
                                onClick={handleRemoveDuplicates}
                                disabled={bulkDeleteMutation.isLoading}
                                className="flex-1 bg-red-600 hover:bg-red-700 text-white"
                            >
                                <Trash2 className="w-4 h-4 mr-2" />
                                Delete {duplicates.reduce((sum, dup) => sum + dup.deleteContacts.length, 0)} Duplicate{duplicates.reduce((sum, dup) => sum + dup.deleteContacts.length, 0) !== 1 ? 's' : ''}
                            </Button>
                        </div>
                    </DialogContent>
                </Dialog>
            )}
        </div>
    );
}
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { FileSpreadsheet, Home, Users, UserPlus, Building, Cloud, Download, Link2, Zap } from 'lucide-react';
import CSVImporter from '../components/common/CSVImporter';
import CRMConnectionModal from '../components/settings/CRMConnectionModal';
import { toast } from 'sonner';

const ENTITY_CONFIGS = {
    Property: {
        icon: Home,
        color: 'from-green-500 to-emerald-600',
        fieldDefinitions: [
            { key: 'address', label: 'Address', required: true, type: 'string', example: '123 Main St' },
            { key: 'city', label: 'City', required: false, type: 'string', example: 'Springfield' },
            { key: 'state', label: 'State', required: false, type: 'string', example: 'IL' },
            { key: 'zip_code', label: 'Zip Code', required: false, type: 'string', example: '62701' },
            { key: 'parcel_id', label: 'Parcel ID / PID', required: false, type: 'string', example: 'PID123456' },
            { key: 'price', label: 'Price', required: true, type: 'number', example: '250000' },
            { key: 'bedrooms', label: 'Bedrooms', required: false, type: 'number', example: '3' },
            { key: 'bathrooms', label: 'Bathrooms', required: false, type: 'number', example: '2' },
            { key: 'square_feet', label: 'Square Feet', required: false, type: 'number', example: '1800' },
            { key: 'lot_size', label: 'Lot Size (acres)', required: false, type: 'number', example: '0.25' },
            { key: 'year_built', label: 'Year Built', required: false, type: 'number', example: '2010' },
            { key: 'property_type', label: 'Property Type', required: false, type: 'string', example: 'single_family' },
            { key: 'dwelling_type', label: 'Dwelling Type', required: false, type: 'string', example: 'Single Family' },
            { key: 'status', label: 'Status', required: false, type: 'string', example: 'active' },
            { key: 'mls_number', label: 'MLS Number', required: false, type: 'string', example: 'MLS123456' },
            { key: 'description', label: 'Description', required: false, type: 'string', example: 'Beautiful home' },
            // Owner Information
            { key: 'owner_name', label: 'Owner Name', required: false, type: 'string', example: 'John Smith' },
            { key: 'owner_first_name', label: 'Owner First Name', required: false, type: 'string', example: 'John' },
            { key: 'owner_last_name', label: 'Owner Last Name', required: false, type: 'string', example: 'Smith' },
            { key: 'owner_mailing_address', label: 'Owner Mailing Address', required: false, type: 'string', example: '456 Oak Ave' },
            { key: 'owner_mailing_city', label: 'Owner Mailing City', required: false, type: 'string', example: 'Another City' },
            { key: 'owner_mailing_state', label: 'Owner Mailing State', required: false, type: 'string', example: 'IL' },
            { key: 'owner_mailing_zip', label: 'Owner Mailing ZIP', required: false, type: 'string', example: '54321' },
            { key: 'owner_phone', label: 'Owner Phone', required: false, type: 'string', example: '555-1234' },
            { key: 'owner_email', label: 'Owner Email', required: false, type: 'string', example: 'john@example.com' },
            { key: 'owner_dob', label: 'Owner Date of Birth', required: false, type: 'string', example: '1970-05-15' },
            { key: 'owner_age', label: 'Owner Age', required: false, type: 'number', example: '54' },
            { key: 'absentee_owner', label: 'Absentee Owner', required: false, type: 'string', example: 'Yes' },
        ],
        sample: [
            { address: '123 Main St', city: 'Springfield', state: 'IL', zip_code: '62701', parcel_id: 'PID123456', price: '250000', bedrooms: '3', bathrooms: '2', square_feet: '1800', lot_size: '0.25', year_built: '2010', property_type: 'single_family', dwelling_type: 'Single Family', status: 'active', mls_number: 'MLS123456', owner_name: 'John Smith', owner_first_name: 'John', owner_last_name: 'Smith', owner_mailing_address: '456 Oak Ave', owner_mailing_city: 'Another City', owner_mailing_state: 'IL', owner_mailing_zip: '54321', owner_phone: '555-1234', owner_email: 'john@example.com', owner_dob: '1970-05-15', owner_age: '54', absentee_owner: 'Yes' },
            { address: '456 Oak Ave', city: 'Springfield', state: 'IL', zip_code: '62702', price: '325000', bedrooms: '4', bathrooms: '2.5', square_feet: '2200', property_type: 'single_family', status: 'active' }
        ]
    },
    Lead: {
        icon: Users,
        color: 'from-blue-500 to-indigo-600',
        fieldDefinitions: [
            { key: 'name', label: 'Name', required: true, type: 'string', example: 'John Doe' },
            { key: 'email', label: 'Email', required: true, type: 'string', example: 'john@example.com' },
            { key: 'phone', label: 'Phone', required: false, type: 'string', example: '555-0100' },
            { key: 'status', label: 'Status', required: false, type: 'string', example: 'new' },
            { key: 'lead_source', label: 'Lead Source', required: false, type: 'string', example: 'Website' },
            { key: 'score', label: 'Score', required: false, type: 'number', example: '75' },
            { key: 'notes', label: 'Notes', required: false, type: 'string', example: 'Interested in downtown condos' },
        ],
        sample: [
            { name: 'John Doe', email: 'john@example.com', phone: '555-0100', status: 'new', lead_source: 'Website', score: '75' },
            { name: 'Jane Smith', email: 'jane@example.com', phone: '555-0101', status: 'contacted', lead_source: 'Referral', score: '85' }
        ]
    },
    Contact: {
        icon: UserPlus,
        color: 'from-purple-500 to-pink-600',
        fieldDefinitions: [
            { key: 'name', label: 'Name', required: true, type: 'string', example: 'Bob Johnson' },
            { key: 'first_name', label: 'First Name', required: false, type: 'string', example: 'Bob' },
            { key: 'last_name', label: 'Last Name', required: false, type: 'string', example: 'Johnson' },
            { key: 'email', label: 'Email', required: false, type: 'string', example: 'bob@example.com' },
            { key: 'phone', label: 'Phone', required: false, type: 'string', example: '555-0200' },
            { key: 'home_phone', label: 'Home Phone', required: false, type: 'string', example: '555-0201' },
            { key: 'cell_phone', label: 'Cell Phone', required: false, type: 'string', example: '555-0202' },
            { key: 'lead_source', label: 'Lead Source', required: false, type: 'string', example: 'Website' },
            { key: 'industry', label: 'Industry', required: false, type: 'string', example: 'Technology' },
            { key: 'relationship', label: 'Relationship', required: false, type: 'string', example: 'past_client' },
            { key: 'property_address', label: 'Property Address', required: false, type: 'string', example: '789 Elm St' },
            { key: 'city', label: 'City', required: false, type: 'string', example: 'Springfield' },
            { key: 'state', label: 'State', required: false, type: 'string', example: 'IL' },
            { key: 'zip_code', label: 'ZIP Code', required: false, type: 'string', example: '62701' },
            { key: 'date_of_birth', label: 'Date of Birth', required: false, type: 'string', example: '1980-05-15' },
            { key: 'age', label: 'Age', required: false, type: 'number', example: '43' },
            { key: 'gender', label: 'Gender', required: false, type: 'string', example: 'Male' },
            { key: 'marital_status', label: 'Marital Status', required: false, type: 'string', example: 'Married' },
            { key: 'income', label: 'Income', required: false, type: 'string', example: '$75,000' },
            { key: 'net_worth', label: 'Net Worth', required: false, type: 'string', example: '$250,000' },
            { key: 'credit_rating', label: 'Credit Rating', required: false, type: 'string', example: 'Good' },
            { key: 'home_value', label: 'Home Value', required: false, type: 'number', example: '350000' },
            { key: 'mortgage_amount', label: 'Mortgage Amount', required: false, type: 'number', example: '200000' },
            { key: 'year_built', label: 'Year Built', required: false, type: 'number', example: '2005' },
            { key: 'bedrooms', label: 'Bedrooms', required: false, type: 'number', example: '3' },
            { key: 'square_feet', label: 'Square Feet', required: false, type: 'number', example: '2000' },
            { key: 'dwelling_type', label: 'Dwelling Type', required: false, type: 'string', example: 'Single Family' },
            { key: 'absentee_owner', label: 'Absentee Owner', required: false, type: 'string', example: 'No' },
            { key: 'language', label: 'Language', required: false, type: 'string', example: 'English' },
            { key: 'last_contact_date', label: 'Last Contact Date', required: false, type: 'string', example: '2024-01-15' },
            { key: 'next_contact_date', label: 'Next Contact Date', required: false, type: 'string', example: '2024-03-15' },
            { key: 'referrals_sent', label: 'Referrals Sent', required: false, type: 'number', example: '5' },
            { key: 'referrals_received', label: 'Referrals Received', required: false, type: 'number', example: '3' },
            { key: 'tags', label: 'Tags', required: false, type: 'string', example: 'vip,referral' },
            { key: 'categories', label: 'Categories', required: false, type: 'string', example: 'frequent,past_client' },
            { key: 'notes', label: 'Notes', required: false, type: 'string', example: 'Great referral source' },
        ],
        sample: [
            { name: 'Bob Johnson', email: 'bob@example.com', phone: '555-0200', relationship: 'past_client', property_address: '789 Elm St' },
            { name: 'Alice Williams', email: 'alice@example.com', phone: '555-0201', relationship: 'family', tags: 'vip,referral' }
        ]
    },
    Buyer: {
        icon: Building,
        color: 'from-orange-500 to-red-600',
        fieldDefinitions: [
            { key: 'first_name', label: 'First Name', required: true, type: 'string', example: 'Michael' },
            { key: 'last_name', label: 'Last Name', required: true, type: 'string', example: 'Brown' },
            { key: 'email', label: 'Email', required: true, type: 'string', example: 'michael@example.com' },
            { key: 'phone', label: 'Phone', required: false, type: 'string', example: '555-0300' },
            { key: 'budget_min', label: 'Min Budget', required: false, type: 'number', example: '200000' },
            { key: 'budget_max', label: 'Max Budget', required: false, type: 'number', example: '350000' },
            { key: 'min_bedrooms', label: 'Min Bedrooms', required: false, type: 'number', example: '3' },
            { key: 'status', label: 'Status', required: false, type: 'string', example: 'active' },
            { key: 'preferred_locations', label: 'Preferred Locations', required: false, type: 'string', example: 'Downtown,Suburbs' },
        ],
        sample: [
            { first_name: 'Michael', last_name: 'Brown', email: 'michael@example.com', phone: '555-0300', budget_min: '200000', budget_max: '350000', min_bedrooms: '3', status: 'active' },
            { first_name: 'Sarah', last_name: 'Davis', email: 'sarah@example.com', phone: '555-0301', budget_min: '300000', budget_max: '450000', min_bedrooms: '4', status: 'active' }
        ]
    }
};

const CRM_INTEGRATIONS = [
    // Real Estate-Specific CRMs
    { id: 'followupboss', name: 'Follow Up Boss', icon: Users, color: 'from-blue-500 to-blue-700', description: 'Import contacts, leads, and transactions', category: 'Real Estate' },
    { id: 'liondesk', name: 'LionDesk', icon: Building, color: 'from-yellow-500 to-orange-600', description: 'Import contacts, leads, and deals', category: 'Real Estate' },
    { id: 'wiseagent', name: 'Wise Agent', icon: UserPlus, color: 'from-green-500 to-green-700', description: 'Import contacts, transactions, and listings', category: 'Real Estate' },
    { id: 'kvcore', name: 'kvCORE', icon: Home, color: 'from-purple-500 to-purple-700', description: 'Import leads, contacts, and properties', category: 'Real Estate' },
    { id: 'boomtown', name: 'BoomTown', icon: Zap, color: 'from-red-500 to-red-700', description: 'Import leads and contacts', category: 'Real Estate' },
    { id: 'contactually', name: 'Contactually', icon: Users, color: 'from-pink-500 to-pink-700', description: 'Import contacts and relationships', category: 'Real Estate' },
    { id: 'topproducer', name: 'Top Producer', icon: Building, color: 'from-indigo-500 to-indigo-700', description: 'Import contacts, leads, and listings', category: 'Real Estate' },
    { id: 'realvolve', name: 'Realvolve', icon: Cloud, color: 'from-teal-500 to-teal-700', description: 'Import contacts and workflows', category: 'Real Estate' },
    { id: 'ixactcontact', name: 'IXACT Contact', icon: UserPlus, color: 'from-cyan-500 to-cyan-700', description: 'Import contacts and sphere', category: 'Real Estate' },
    { id: 'realtyjuggler', name: 'Realty Juggler', icon: Home, color: 'from-amber-500 to-amber-700', description: 'Import contacts and transactions', category: 'Real Estate' },
    { id: 'propertybase', name: 'Propertybase', icon: Building, color: 'from-blue-600 to-blue-800', description: 'Import contacts, listings, and deals', category: 'Real Estate' },
    { id: 'chime', name: 'Chime', icon: Zap, color: 'from-green-600 to-green-800', description: 'Import leads and contacts', category: 'Real Estate' },
    { id: 'zurple', name: 'Zurple', icon: Users, color: 'from-purple-600 to-purple-800', description: 'Import leads and contacts', category: 'Real Estate' },
    { id: 'marketleader', name: 'Market Leader', icon: Cloud, color: 'from-orange-600 to-orange-800', description: 'Import leads and contacts', category: 'Real Estate' },
    { id: 'realgeeks', name: 'Real Geeks', icon: Home, color: 'from-red-600 to-red-800', description: 'Import leads and contacts', category: 'Real Estate' },
    { id: 'ylopo', name: 'Ylopo', icon: Zap, color: 'from-pink-600 to-pink-800', description: 'Import leads and contacts', category: 'Real Estate' },
    { id: 'cinc', name: 'CINC', icon: Building, color: 'from-indigo-600 to-indigo-800', description: 'Import leads and opportunities', category: 'Real Estate' },
    { id: 'commissioninc', name: 'Commission Inc.', icon: UserPlus, color: 'from-teal-600 to-teal-800', description: 'Import leads and contacts', category: 'Real Estate' },
    
    // General CRMs Popular in Real Estate
    { id: 'salesforce', name: 'Salesforce', icon: Cloud, color: 'from-blue-400 to-blue-600', description: 'Import contacts, leads, and opportunities', category: 'General' },
    { id: 'hubspot', name: 'HubSpot', icon: Zap, color: 'from-orange-400 to-red-500', description: 'Import contacts, deals, and companies', category: 'General' },
    { id: 'zoho', name: 'Zoho CRM', icon: Link2, color: 'from-red-400 to-red-600', description: 'Import contacts, leads, and accounts', category: 'General' },
    { id: 'pipedrive', name: 'Pipedrive', icon: Cloud, color: 'from-green-400 to-green-600', description: 'Import persons, organizations, and deals', category: 'General' },
    { id: 'monday', name: 'Monday.com', icon: Users, color: 'from-pink-400 to-pink-600', description: 'Import contacts and deals', category: 'General' },
    { id: 'agentboxcrm', name: 'AgentBox CRM', icon: Building, color: 'from-slate-500 to-slate-700', description: 'Import contacts and listings', category: 'Real Estate' },
];

export default function CSVImport() {
    const navigate = useNavigate();
    const [selectedEntity, setSelectedEntity] = useState(null);
    const [importMode, setImportMode] = useState(null); // 'csv' or 'crm'
    const [selectedCRM, setSelectedCRM] = useState(null);

    const handleComplete = () => {
        setSelectedEntity(null);
        setImportMode(null);
        navigate(createPageUrl('Dashboard'));
    };

    const handleCRMConnect = (crm) => {
        setSelectedCRM(crm);
    };

    if (selectedEntity) {
        const config = ENTITY_CONFIGS[selectedEntity];
        return (
            <div className="page-container">
                <Button 
                    variant="ghost" 
                    onClick={() => { setSelectedEntity(null); setImportMode(null); }}
                    className="mb-4"
                >
                    ‚Üê Back to Import Options
                </Button>
                <CSVImporter
                    entityName={selectedEntity}
                    fieldDefinitions={config.fieldDefinitions}
                    sampleData={config.sample}
                    onComplete={handleComplete}
                    onCancel={() => { setSelectedEntity(null); setImportMode(null); }}
                />
            </div>
        );
    }

    if (importMode === 'crm') {
        return (
            <div className="page-container">
                <Button 
                    variant="ghost" 
                    onClick={() => setImportMode(null)}
                    className="mb-4"
                >
                    ‚Üê Back to Import Options
                </Button>
                
                <header className="mb-8">
                    <h1 className="text-3xl font-bold text-slate-900 dark:text-white">CRM Integrations</h1>
                    <p className="text-slate-600 dark:text-slate-400 mt-2">
                        Connect your existing CRM to import contacts, leads, and deals directly. We support all major real estate CRMs.
                    </p>
                </header>

                {/* Real Estate CRMs */}
                <div className="mb-8">
                    <h2 className="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                        <Home className="w-5 h-5" />
                        Real Estate CRMs
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {CRM_INTEGRATIONS.filter(crm => crm.category === 'Real Estate').map((crm) => {
                            const Icon = crm.icon;
                            return (
                                <Card 
                                    key={crm.id}
                                    className="group cursor-pointer transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5"
                                    onClick={() => handleCRMConnect(crm)}
                                >
                                    <CardContent className="p-5">
                                        <div className="flex items-start gap-3">
                                            <div className={`w-12 h-12 rounded-lg bg-gradient-to-br ${crm.color} flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform`}>
                                                <Icon className="w-6 h-6 text-white" />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <h3 className="text-base font-bold text-slate-900 dark:text-white mb-1">
                                                    {crm.name}
                                                </h3>
                                                <p className="text-xs text-slate-600 dark:text-slate-400 mb-2 line-clamp-2">
                                                    {crm.description}
                                                </p>
                                                <Button size="sm" variant="outline" className="gap-1 h-7 text-xs">
                                                    <Link2 className="w-3 h-3" />
                                                    Connect
                                                </Button>
                                            </div>
                                        </div>
                                    </CardContent>
                                </Card>
                            );
                        })}
                    </div>
                </div>

                {/* General CRMs */}
                <div>
                    <h2 className="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                        <Cloud className="w-5 h-5" />
                        General CRMs
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {CRM_INTEGRATIONS.filter(crm => crm.category === 'General').map((crm) => {
                            const Icon = crm.icon;
                            return (
                                <Card 
                                    key={crm.id}
                                    className="group cursor-pointer transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5"
                                    onClick={() => handleCRMConnect(crm)}
                                >
                                    <CardContent className="p-5">
                                        <div className="flex items-start gap-3">
                                            <div className={`w-12 h-12 rounded-lg bg-gradient-to-br ${crm.color} flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform`}>
                                                <Icon className="w-6 h-6 text-white" />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <h3 className="text-base font-bold text-slate-900 dark:text-white mb-1">
                                                    {crm.name}
                                                </h3>
                                                <p className="text-xs text-slate-600 dark:text-slate-400 mb-2 line-clamp-2">
                                                    {crm.description}
                                                </p>
                                                <Button size="sm" variant="outline" className="gap-1 h-7 text-xs">
                                                    <Link2 className="w-3 h-3" />
                                                    Connect
                                                </Button>
                                            </div>
                                        </div>
                                    </CardContent>
                                </Card>
                            );
                        })}
                    </div>
                </div>

                <Card className="mt-8">
                    <CardContent className="p-6">
                        <h3 className="font-semibold text-lg mb-4">How CRM Integration Works</h3>
                        <div className="space-y-3 text-sm text-slate-600 dark:text-slate-400">
                            <div className="flex items-start gap-2">
                                <div className="w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span className="text-indigo-600 dark:text-indigo-400 font-bold text-xs">1</span>
                                </div>
                                <div>
                                    <p className="font-medium text-slate-900 dark:text-white">Connect Your CRM</p>
                                    <p>Securely authenticate with your CRM account using OAuth.</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-2">
                                <div className="w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span className="text-indigo-600 dark:text-indigo-400 font-bold text-xs">2</span>
                                </div>
                                <div>
                                    <p className="font-medium text-slate-900 dark:text-white">Select Data to Import</p>
                                    <p>Choose which contacts, leads, and deals you want to bring over.</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-2">
                                <div className="w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span className="text-indigo-600 dark:text-indigo-400 font-bold text-xs">3</span>
                                </div>
                                <div>
                                    <p className="font-medium text-slate-900 dark:text-white">Automatic Sync</p>
                                    <p>Data is imported and mapped to your RealtyMind entities automatically.</p>
                                </div>
                            </div>
                        </div>
                    </CardContent>
                </Card>

                {selectedCRM && (
                    <CRMConnectionModal
                        crm={selectedCRM}
                        onClose={() => setSelectedCRM(null)}
                        onImportComplete={handleComplete}
                    />
                )}
            </div>
        );
    }

    if (importMode === 'csv') {
        return (
            <div className="page-container">
                <Button 
                    variant="ghost" 
                    onClick={() => setImportMode(null)}
                    className="mb-4"
                >
                    ‚Üê Back to Import Options
                </Button>
                
                <header className="mb-8">
                    <h1 className="text-3xl font-bold text-slate-900 dark:text-white">CSV Import</h1>
                    <p className="text-slate-600 dark:text-slate-400 mt-2">
                        Import data from CSV files into your database. Select an entity type to begin.
                    </p>
                </header>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    {Object.keys(ENTITY_CONFIGS).map((entityName) => {
                        const config = ENTITY_CONFIGS[entityName];
                        const Icon = config.icon;

                        return (
                            <Card 
                                key={entityName}
                                className="group cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1"
                                onClick={() => setSelectedEntity(entityName)}
                            >
                                <CardContent className="p-6">
                                    <div className={`w-16 h-16 rounded-2xl bg-gradient-to-br ${config.color} flex items-center justify-center mb-4 group-hover:scale-110 transition-transform`}>
                                        <Icon className="w-8 h-8 text-white" />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
                                        {entityName}
                                    </h3>
                                    <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                                        Import {entityName.toLowerCase()} records from a CSV file
                                    </p>
                                    <div className="flex items-center gap-2 text-xs text-slate-500">
                                        <FileSpreadsheet className="w-4 h-4" />
                                        <span>CSV Format Required</span>
                                    </div>
                                </CardContent>
                            </Card>
                        );
                    })}
                </div>

                <Card className="mt-8">
                    <CardContent className="p-6">
                        <h3 className="font-semibold text-lg mb-4">Import Guidelines</h3>
                        <div className="space-y-3 text-sm text-slate-600 dark:text-slate-400">
                            <div className="flex items-start gap-2">
                                <div className="w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span className="text-indigo-600 dark:text-indigo-400 font-bold text-xs">1</span>
                                </div>
                                <div>
                                    <p className="font-medium text-slate-900 dark:text-white">Prepare Your CSV</p>
                                    <p>Ensure your CSV file has headers in the first row. Download a sample template for the correct format.</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-2">
                                <div className="w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span className="text-indigo-600 dark:text-indigo-400 font-bold text-xs">2</span>
                                </div>
                                <div>
                                    <p className="font-medium text-slate-900 dark:text-white">Map Your Columns</p>
                                    <p>Match each CSV column to the appropriate field. Required fields must be mapped.</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-2">
                                <div className="w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span className="text-indigo-600 dark:text-indigo-400 font-bold text-xs">3</span>
                                </div>
                                <div>
                                    <p className="font-medium text-slate-900 dark:text-white">Review and Import</p>
                                    <p>Review your mappings and start the import. You'll see a summary when complete.</p>
                                </div>
                            </div>
                        </div>
                    </CardContent>
                </Card>
            </div>
        );
    }

    return (
        <div className="page-container">
            <header className="mb-8">
                <h1 className="text-3xl font-bold text-slate-900 dark:text-white">CRM Import</h1>
                <p className="text-slate-600 dark:text-slate-400 mt-2">
                    Import your contacts, leads, and properties from CSV files or other CRM systems.
                </p>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <Card 
                    className="group cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1"
                    onClick={() => setImportMode('csv')}
                >
                    <CardContent className="p-8">
                        <div className="w-20 h-20 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform mx-auto">
                            <FileSpreadsheet className="w-10 h-10 text-white" />
                        </div>
                        <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-3 text-center">
                            CSV File Import
                        </h3>
                        <p className="text-slate-600 dark:text-slate-400 mb-6 text-center">
                            Upload CSV files to import properties, contacts, leads, and buyers into your database
                        </p>
                        <div className="flex items-center justify-center gap-2 text-sm text-slate-500">
                            <Download className="w-4 h-4" />
                            <span>Supports all entity types</span>
                        </div>
                    </CardContent>
                </Card>

                <Card 
                    className="group cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 relative overflow-hidden"
                    onClick={() => setImportMode('crm')}
                >
                    <CardContent className="p-8">
                        <div className="absolute top-4 right-4">
                            <Badge className="bg-green-600 text-white">Auto-Map All Fields</Badge>
                        </div>
                        <div className="w-20 h-20 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform mx-auto">
                            <Cloud className="w-10 h-10 text-white" />
                        </div>
                        <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-3 text-center">
                            Import from CRM
                        </h3>
                        <p className="text-slate-600 dark:text-slate-400 mb-6 text-center">
                            Connect to any CRM system - ALL fields automatically imported and mapped to your contacts
                        </p>
                        <div className="flex items-center justify-center gap-2 text-sm text-slate-500">
                            <Zap className="w-4 h-4" />
                            <span>25+ CRM integrations</span>
                        </div>
                    </CardContent>
                </Card>
            </div>

            <Card className="mt-8">
                <CardContent className="p-6">
                    <h3 className="font-semibold text-lg mb-4">Why Import Your Data?</h3>
                    <div className="grid md:grid-cols-3 gap-6 text-sm text-slate-600 dark:text-slate-400">
                        <div>
                            <div className="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center mb-3">
                                <Users className="w-5 h-5 text-green-600 dark:text-green-400" />
                            </div>
                            <p className="font-medium text-slate-900 dark:text-white mb-2">Centralize Your Data</p>
                            <p>Bring all your contacts, leads, and properties into one powerful platform</p>
                        </div>
                        <div>
                            <div className="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mb-3">
                                <Zap className="w-5 h-5 text-blue-600 dark:text-blue-400" />
                            </div>
                            <p className="font-medium text-slate-900 dark:text-white mb-2">Save Time</p>
                            <p>No manual data entry - import hundreds or thousands of records instantly</p>
                        </div>
                        <div>
                            <div className="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center mb-3">
                                <Link2 className="w-5 h-5 text-purple-600 dark:text-purple-400" />
                            </div>
                            <p className="font-medium text-slate-900 dark:text-white mb-2">Seamless Migration</p>
                            <p>Switch from your old CRM without losing any valuable customer data</p>
                        </div>
                    </div>
                </CardContent>
            </Card>
        </div>
    );
}
import React, { useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import LoadingSpinner from "../components/common/LoadingSpinner";
import {
  Sparkles,
  ArrowLeft,
  CheckCircle2,
  Circle,
  Target,
  Home,
  Eye,
  Calendar,
  Phone,
  Loader2,
  RefreshCw,
  TrendingUp,
  Trash2,
  Users,
  Mail,
  Megaphone,
  ArrowRight,
  Clock,
  Printer
} from "lucide-react";
import { Progress } from "@/components/ui/progress";
import { toast } from "sonner";

const getCategoryIcon = (category) => {
  const icons = {
    task: CheckCircle2,
    lead: Target,
    property: Home,
    showing: Eye,
    open_house: Home,
    appointment: Calendar,
    follow_up: Phone,
    general: Sparkles,
    buyer: Users,
    contact: Users,
    marketing: Megaphone,
    message: Mail,
    investor: Printer
  };
  return icons[category] || Sparkles;
};

const getCategoryLabel = (category) => {
  const labels = {
    task: 'Task',
    lead: 'Lead',
    property: 'Property',
    showing: 'Showing',
    open_house: 'Open House',
    appointment: 'Appointment',
    follow_up: 'Follow-up',
    general: 'General',
    buyer: 'Buyer',
    contact: 'Contact',
    marketing: 'Marketing',
    message: 'Message',
    investor: 'Investor Letter'
  };
  return labels[category] || category;
};

const getPriorityColor = (priority) => {
  const colors = {
    critical: "bg-red-500",
    high: "bg-orange-500",
    medium: "bg-blue-500",
    low: "bg-slate-400"
  };
  return colors[priority] || colors.medium;
};

export default function DailyAdvice() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [isGenerating, setIsGenerating] = useState(false);
  const hasAutoGeneratedRef = React.useRef(false);

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me(),
  });

  const { data: allAdvice = [], isLoading: adviceLoading, refetch: refetchAdvice } = useQuery({
    queryKey: ['dailyAdvice'],
    queryFn: async () => {
      try {
        const result = await base44.entities.DailyAIAdvice.list('-created_date');
        return result || [];
      } catch (error) {
        // Silently handle rate limits - return empty array
        return [];
      }
    },
    enabled: !!user,
    staleTime: 60 * 60 * 1000, // 1 hour
    cacheTime: 2 * 60 * 60 * 1000, // 2 hours
    retry: false,
    refetchOnWindowFocus: false,
    refetchOnMount: false,
  });

  // Show all advice for current user (not filtered by date)
  const todayAdvice = useMemo(() => {
    if (!user) return [];
    
    const filtered = allAdvice.filter(advice => advice.user_id === user.id).sort((a, b) => {
      const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    });
    
    return filtered;
  }, [allAdvice, user]);

  const completedCount = todayAdvice.filter(a => a.is_completed).length;
  const pendingCount = todayAdvice.length - completedCount;

  // Check for advice regeneration every 3 weeks
  React.useEffect(() => {
    const checkAdviceUpdate = () => {
      const now = new Date();
      const lastUpdate = localStorage.getItem('daily_advice_last_update');
      
      // Check if we need to regenerate (every 3 weeks)
      if (!lastUpdate) {
        // First time - generate now
        localStorage.setItem('daily_advice_last_update', now.toISOString());
        if (user && !isGenerating && todayAdvice.length === 0) {
          console.log("üïê First-time advice generation");
          generateAdvice();
        }
      } else {
        const lastUpdateDate = new Date(lastUpdate);
        const daysSinceLastUpdate = (now - lastUpdateDate) / (1000 * 60 * 60 * 24);
        
        // Regenerate if 3 weeks (21 days) have passed
        if (daysSinceLastUpdate >= 21) {
          localStorage.setItem('daily_advice_last_update', now.toISOString());
          console.log("üïê 3-week auto-update triggered (last update was", Math.floor(daysSinceLastUpdate), "days ago)");
          if (user && !isGenerating) {
            generateAdvice();
          }
        }
      }
    };

    // Check every hour
    const interval = setInterval(checkAdviceUpdate, 60 * 60 * 1000);
    checkAdviceUpdate(); // Check immediately on mount

    return () => clearInterval(interval);
  }, [user, isGenerating, todayAdvice.length]);

  // Auto-generate advice on mount only if none exists at all
  React.useEffect(() => {
    if (user && !adviceLoading && allAdvice.length === 0 && !hasAutoGeneratedRef.current) {
      hasAutoGeneratedRef.current = true;
      console.log("ü§ñ Auto-generating advice (no records found)...");
      generateAdvice();
    }
  }, [user, adviceLoading, allAdvice.length]);

  // Listen for manual generation trigger only
  React.useEffect(() => {
    const handleAutoGenerate = () => {
      if (user && !isGenerating) {
        generateAdvice();
      }
    };
    
    window.addEventListener('autoGenerateAdvice', handleAutoGenerate);
    return () => window.removeEventListener('autoGenerateAdvice', handleAutoGenerate);
  }, [user, isGenerating]);

  const completeMutation = useMutation({
    mutationFn: async (adviceId) => {
      return await base44.entities.DailyAIAdvice.update(adviceId, {
        is_completed: true,
        completed_at: new Date().toISOString()
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['dailyAdvice'] });
      refetchAdvice();
    },
  });

  const deleteOldAdviceMutation = useMutation({
    mutationFn: async () => {
      // Delete all advice records that are not from today
      const today = new Date().toISOString().split('T')[0];
      const oldAdvice = allAdvice.filter(advice => {
        try {
          let adviceDateStr;
          if (advice.advice_date.includes('T')) {
            adviceDateStr = advice.advice_date.split('T')[0];
          } else {
            adviceDateStr = advice.advice_date;
          }
          return adviceDateStr !== today && advice.user_id === user.id;
        } catch {
          return false;
        }
      });
      
      console.log("Deleting old advice:", oldAdvice.length);
      await Promise.all(oldAdvice.map(a => base44.entities.DailyAIAdvice.delete(a.id)));
      return oldAdvice.length;
    },
    onSuccess: (count) => {
      queryClient.invalidateQueries({ queryKey: ['dailyAdvice'] });
      refetchAdvice();
      toast.success(`Deleted ${count} old recommendations`);
    },
  });

  const handleAdviceClick = async (advice) => {
    try {
      if (!advice.is_completed) {
        await completeMutation.mutateAsync(advice.id);
      }
      if (advice.action_url) {
        navigate(advice.action_url);
      }
    } catch (error) {
      console.error("Error:", error);
    }
  };

  const generateAdvice = async () => {
    if (!user) {
      toast.error("Please wait for user to load");
      return;
    }

    setIsGenerating(true);
    
    // Play sound effect when generation starts
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAo=');
    audio.volume = 0.3;
    audio.play().catch(() => {});
    
    console.log("üöÄ Starting advice generation for user:", user.id);
    
    try {
      const today = new Date().toISOString().split('T')[0];
      console.log("üìÖ Generating for date:", today);

      // Delete ALL existing advice for this user before generating new ones
      const existingAdvice = allAdvice.filter(advice => advice.user_id === user.id);
      
      if (existingAdvice.length > 0) {
        console.log("üóëÔ∏è Deleting all existing advice:", existingAdvice.length);
        await Promise.all(existingAdvice.map(a => base44.entities.DailyAIAdvice.delete(a.id)));
      }

      // Fetch only essential data with limits to avoid 502 errors
      console.log("üìä Fetching data...");
      const [tasks, leads, properties, showings, appointments, buyers, contacts, investorProperties] = await Promise.all([
        base44.entities.Task.list('-created_date', 100).catch(() => []),
        base44.entities.Lead.list('-created_date', 50).catch(() => []),
        base44.entities.Property.list('-created_date', 50).catch(() => []),
        base44.entities.Showing.list('-created_date', 50).catch(() => []),
        base44.entities.Appointment.list('-created_date', 50).catch(() => []),
        base44.entities.Buyer.list('-created_date', 50).catch(() => []),
        base44.entities.Contact.list('-created_date', 100).catch(() => []),
        base44.entities.InvestorProperty.list('-created_date', 50).catch(() => []),
      ]);

      console.log("‚úÖ Data fetched:", {
        tasks: tasks.length,
        leads: leads.length,
        properties: properties.length,
        showings: showings.length,
        appointments: appointments.length
      });

      // Analyze data
      const userTasks = tasks.filter(t => 
        (t.assigned_to === user.id || t.created_by === user.email) &&
        t.status !== 'completed' && t.status !== 'cancelled'
      );

      const overdueTasks = userTasks.filter(t => {
        if (!t.due_date) return false;
        return new Date(t.due_date) < new Date();
      });

      const todayTasks = userTasks.filter(t => {
        if (!t.due_date) return false;
        const dueDate = new Date(t.due_date).toISOString().split('T')[0];
        return dueDate === today;
      });

      const userLeads = leads.filter(l => 
        (l.owner_id === user.id || l.assigned_agent_id === user.id) &&
        l.status !== 'lost'
      );

      const hotLeads = userLeads.filter(l => (l.score || 0) >= 70);
      
      const coldLeads = userLeads.filter(l => {
        if (!l.updated_date) return false;
        const daysSince = (new Date() - new Date(l.updated_date)) / (1000 * 60 * 60 * 24);
        return daysSince > 7;
      });

      const activeProperties = properties.filter(p => 
        p.listing_agent_id === user.id && p.status === 'active'
      );

      const todayShowings = showings.filter(s => 
        s.scheduled_date === today && s.status !== 'cancelled'
      );

      const todayAppointments = appointments.filter(a => 
        a.scheduled_date === today && a.status !== 'cancelled'
      );

      const activeBuyers = buyers.filter(b => b.status === 'active' && b.assigned_agent_id === user.id);

      // Calculate investor letters due today
      const lettersDueToday = investorProperties.filter(p => {
        if (!p.mail_campaign_id || !p.next_followup_date) return false;
        const followupDate = new Date(p.next_followup_date);
        followupDate.setHours(0, 0, 0, 0);
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);
        return followupDate <= todayDate && (p.mail_campaign_step || 0) < 12;
      });

      console.log("üìà Analysis:", {
        userTasks: userTasks.length,
        overdueTasks: overdueTasks.length,
        hotLeads: hotLeads.length,
        activeProperties: activeProperties.length,
        lettersDueToday: lettersDueToday.length
      });

      // Get agent profile type for personalized advice
      const profileType = user.profile_type || 'dual_agent';
      const profileGoals = user.profile_goals ? JSON.parse(user.profile_goals) : [];
      
      // Build profile-specific context
      let profileContext = '';
      if (profileType === 'new_agent') {
        profileContext = `
**AGENT PROFILE: New Agent (Learning & Building)**
Focus on: Learning fundamentals, building sphere of influence, prospecting skills, and getting first deals.
Emphasize: Training opportunities, networking, door knocking, FSBO leads, sphere contacts, and foundational activities.`;
      } else if (profileType === 'listing_specialist') {
        profileContext = `
**AGENT PROFILE: Listing Specialist**
Focus on: Getting and managing listings, pricing strategies, marketing properties, seller relationships.
Emphasize: Active listings, property marketing, open houses, pricing analysis, seller communication, and listing presentations.`;
      } else if (profileType === 'buyer_specialist') {
        profileContext = `
**AGENT PROFILE: Buyer Agent**
Focus on: Working with buyers, property searches, showings, buyer consultations, market knowledge.
Emphasize: Buyer follow-ups, showings, property matching, buyer education, financing coordination.`;
      } else if (profileType === 'dual_agent') {
        profileContext = `
**AGENT PROFILE: Full Service Agent**
Focus on: Balanced approach - both buyers and sellers, managing full transactions.
Emphasize: Transaction management, both buyer and seller activities, pipeline balance.`;
      } else if (profileType === 'advanced_agent') {
        profileContext = `
**AGENT PROFILE: Advanced Agent**
Focus on: High-volume business, team management, automation, investment properties, luxury market.
Emphasize: Team coordination, advanced marketing, investment opportunities, luxury listings, business growth.`;
      }

      // Create AI prompt
      const prompt = `You are an AI business advisor for a real estate agent. Generate 5-8 specific, actionable recommendations for TODAY based on this data:

${profileContext}

**Agent's Current Situation:**
- Pending Tasks: ${userTasks.length}
- Overdue Tasks: ${overdueTasks.length}
- Today's Tasks: ${todayTasks.length}
- Hot Leads (score ‚â•70): ${hotLeads.length}
- Total Active Leads: ${userLeads.length}
- Cold Leads (no activity >7 days): ${coldLeads.length}
- Active Listings: ${activeProperties.length}
- Today's Showings: ${todayShowings.length}
- Today's Appointments: ${todayAppointments.length}
- Active Buyers: ${activeBuyers.length}
- Sphere Contacts: ${contacts.length}
- Investor Letters Due Today: ${lettersDueToday.length}

**Priority Rules:**
1. Overdue tasks = CRITICAL priority
2. Investor letters due today = HIGH priority (revenue generating!)
3. Hot leads = HIGH priority
4. Today's appointments/showings = HIGH priority
5. Cold leads needing follow-up = MEDIUM priority
6. Sphere of influence outreach = MEDIUM/LOW priority

**Generate 5-8 recommendations TAILORED TO THEIR AGENT PROFILE** focusing on REVENUE-GENERATING activities specific to their role.

**IMPORTANT: action_url MUST be one of these EXACT page names:**
- "Tasks" (for task-related actions)
- "Leads" (for lead follow-ups)
- "Properties" (for listing actions)
- "Showings" (for scheduling/viewing showings)
- "Calendar" (for appointments)
- "Contacts" (for sphere of influence)
- "Buyers" (for buyer engagement)
- "OpenHouses" (for open house planning)
- "MarketingCampaigns" (for marketing)
- "Messages" (for communication)
- "InvestorHub" (for investor property letters)

Return JSON array with this EXACT structure:
[
  {
    "title": "Short action title (max 60 chars)",
    "description": "Why this matters and what to do (2-3 sentences)",
    "priority": "critical" | "high" | "medium" | "low",
    "category": "task" | "lead" | "property" | "showing" | "appointment" | "follow_up" | "general" | "investor",
    "action_url": "Tasks"
  }
]

**IMPORTANT: If there are investor letters due today (${lettersDueToday.length}), ALWAYS include a HIGH priority recommendation to print them with action_url "InvestorHub" and category "investor".**`;

      console.log("ü§ñ Calling AI...");
      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        response_json_schema: {
          type: "object",
          properties: {
            recommendations: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  title: { type: "string" },
                  description: { type: "string" },
                  priority: { type: "string" },
                  category: { type: "string" },
                  action_url: { type: "string" }
                }
              }
            }
          }
        }
      });

      console.log("‚úÖ AI Response:", response);

      const recommendations = response.recommendations || [];
      console.log("üìù Recommendations:", recommendations.length);
      
      // Valid page names mapping
      const validPages = ['Tasks', 'Leads', 'Properties', 'Showings', 'Calendar', 'Contacts', 'Buyers', 'OpenHouses', 'MarketingCampaigns', 'Messages', 'InvestorHub'];
      
      // Create advice records with today's date
      console.log("üíæ Creating advice records...");
      const advicePromises = recommendations.map((rec, index) => {
        // Validate action_url - only use if it's a valid page name
        let actionUrl = null;
        if (rec.action_url && validPages.includes(rec.action_url)) {
          actionUrl = createPageUrl(rec.action_url);
        }
        
        const adviceData = {
          user_id: user.id,
          advice_date: today, // YYYY-MM-DD format
          title: rec.title,
          description: rec.description,
          priority: rec.priority,
          category: rec.category,
          action_url: actionUrl,
          is_completed: false,
          order_index: index
        };
        console.log("Creating advice:", adviceData);
        return base44.entities.DailyAIAdvice.create(adviceData);
      });

      const createdAdvice = await Promise.all(advicePromises);
      console.log("‚úÖ Created advice records:", createdAdvice.length);
      
      // Play success sound
      const successAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=');
      successAudio.volume = 0.4;
      successAudio.play().catch(() => {});
      
      // Force refetch
      await queryClient.invalidateQueries({ queryKey: ['dailyAdvice'] });
      await refetchAdvice();
      
      toast.success(`Generated ${recommendations.length} recommendations for today!`);
      
    } catch (error) {
      console.error("‚ùå Error generating advice:", error);
      toast.error("Failed to generate advice: " + error.message);
    }
    
    setIsGenerating(false);
  };

  if (!user) {
    return <LoadingSpinner icon={Sparkles} title="Loading..." description="Loading your daily action plan" />;
  }

  const progressPercent = todayAdvice.length > 0 ? Math.round((completedCount / todayAdvice.length) * 100) : 0;

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 p-4 md:p-8">
      <div className="max-w-4xl mx-auto">
        {/* Header Card */}
        <div className="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
          {/* Gradient Header */}
          <div className="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 p-6 md:p-8 text-white">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div className="flex items-center gap-4">
                <div className="w-14 h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
                  <Sparkles className="w-7 h-7 text-white" />
                </div>
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold">
                    Your Daily Action Plan ‚ú®
                  </h1>
                  <p className="text-white/80 mt-1 text-sm md:text-base">
                    {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} ‚Ä¢ Let's make today count!
                  </p>
                </div>
              </div>
              
              <div className="flex gap-2">
                <Button
                  onClick={generateAdvice}
                  disabled={isGenerating}
                  className="bg-white text-indigo-700 hover:bg-white/90 font-semibold"
                >
                  {isGenerating ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Generating...
                    </>
                  ) : (
                    <>
                      <RefreshCw className="w-4 h-4 mr-2" />
                      {todayAdvice.length > 0 ? 'Regenerate' : 'Generate Plan'}
                    </>
                  )}
                </Button>
              </div>
            </div>
          </div>

          {/* Progress Section */}
          {todayAdvice.length > 0 && (
            <div className="p-6 border-b border-slate-100">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-2">
                  <TrendingUp className="w-5 h-5 text-indigo-600" />
                  <span className="font-semibold text-slate-800">Today's Progress</span>
                </div>
                <span className="text-2xl font-bold text-indigo-600">{progressPercent}%</span>
              </div>
              <Progress value={progressPercent} className="h-3" />
              <div className="flex justify-between mt-3 text-sm">
                <div className="flex items-center gap-4">
                  <span className="flex items-center gap-1.5">
                    <span className="w-2.5 h-2.5 rounded-full bg-orange-500"></span>
                    <span className="text-slate-600">{pendingCount} Pending</span>
                  </span>
                  <span className="flex items-center gap-1.5">
                    <span className="w-2.5 h-2.5 rounded-full bg-green-500"></span>
                    <span className="text-slate-600">{completedCount} Completed</span>
                  </span>
                </div>
                <span className="text-slate-500">{todayAdvice.length} total actions</span>
              </div>
            </div>
          )}
        </div>

        {adviceLoading ? (
          <div className="flex flex-col items-center justify-center py-16 bg-white rounded-2xl shadow-lg">
            <Loader2 className="w-10 h-10 animate-spin text-indigo-600 mb-4" />
            <p className="text-slate-600">Loading your action plan...</p>
          </div>
        ) : todayAdvice.length === 0 ? (
          <Card className="bg-white rounded-2xl shadow-lg border-0 overflow-hidden">
            <CardContent className="p-10 md:p-16 text-center relative">
              {isGenerating && (
                <div className="absolute inset-0 bg-gradient-to-br from-indigo-500/10 via-purple-500/10 to-pink-500/10 backdrop-blur-sm z-10 flex items-center justify-center">
                  <div className="relative">
                    {/* Animated Brain Icon with Pulse */}
                    <div className="w-32 h-32 relative mx-auto mb-6 animate-pulse">
                      <div className="absolute inset-0 bg-gradient-to-br from-indigo-400 to-purple-600 rounded-full opacity-20 animate-ping"></div>
                      <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-700 rounded-full flex items-center justify-center">
                        <Sparkles className="w-16 h-16 text-white animate-spin" style={{ animationDuration: '3s' }} />
                      </div>
                    </div>
                    <div className="space-y-3">
                      <p className="text-xl font-bold text-indigo-700 animate-pulse">Analyzing Your Business...</p>
                      <div className="flex items-center justify-center gap-2">
                        <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                        <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                        <div className="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              <div className="w-20 h-20 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <Sparkles className="w-10 h-10 text-indigo-600" />
              </div>
              <h3 className="text-2xl font-bold text-slate-900 mb-3">
                Ready to Crush It Today? üí™
              </h3>
              <p className="text-slate-600 mb-8 max-w-md mx-auto">
                I'll analyze your tasks, leads, and appointments to create a personalized action plan just for you. Takes about 10 seconds!
              </p>
              <Button
                onClick={generateAdvice}
                disabled={isGenerating}
                size="lg"
                className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-lg px-8 py-6"
              >
                {isGenerating ? (
                  <>
                    <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                    Analyzing Your Data...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-5 h-5 mr-2" />
                    Generate My Action Plan
                  </>
                )}
              </Button>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-4">
            {todayAdvice.map((advice, index) => {
              const Icon = getCategoryIcon(advice.category);
              const priorityColor = getPriorityColor(advice.priority);
              const isCompleted = advice.is_completed;

              return (
                <Card
                  key={advice.id}
                  className={`cursor-pointer transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5 border-0 shadow-md ${
                    isCompleted 
                      ? 'bg-gradient-to-r from-green-50 to-emerald-50 ring-1 ring-green-200' 
                      : 'bg-white hover:ring-1 hover:ring-indigo-200'
                  }`}
                  onClick={() => handleAdviceClick(advice)}
                >
                  <CardContent className="p-5">
                    <div className="flex items-start gap-4">
                      {/* Priority indicator & Icon */}
                      <div className="flex flex-col items-center gap-2">
                        <div className={`w-12 h-12 rounded-xl ${isCompleted ? 'bg-green-500' : priorityColor} flex items-center justify-center shadow-sm`}>
                          {isCompleted ? (
                            <CheckCircle2 className="w-6 h-6 text-white" />
                          ) : (
                            <Icon className="w-6 h-6 text-white" />
                          )}
                        </div>
                        <span className="text-xs font-medium text-slate-400">#{index + 1}</span>
                      </div>
                      
                      <div className="flex-1 min-w-0">
                        {/* Title row */}
                        <div className="flex items-start justify-between gap-3 mb-2">
                          <h3 className={`font-semibold text-base md:text-lg leading-tight ${isCompleted ? 'text-green-800 line-through opacity-75' : 'text-slate-900'}`}>
                            {advice.title}
                          </h3>
                          <div className="flex gap-1.5 flex-shrink-0">
                            <Badge className={`${isCompleted ? 'bg-green-600' : priorityColor} text-white text-xs px-2 py-0.5 capitalize`}>
                              {advice.priority}
                            </Badge>
                          </div>
                        </div>
                        
                        {/* Description */}
                        <p className={`text-sm leading-relaxed mb-3 ${isCompleted ? 'text-green-700 opacity-75' : 'text-slate-600'}`}>
                          {advice.description}
                        </p>
                        
                        {/* Footer */}
                        <div className="flex items-center justify-between">
                          <Badge variant="outline" className="text-xs capitalize bg-slate-50">
                            {getCategoryLabel(advice.category)}
                          </Badge>
                          
                          {isCompleted ? (
                            <span className="flex items-center gap-1.5 text-sm text-green-600 font-medium">
                              <CheckCircle2 className="w-4 h-4" />
                              Done! üéâ
                            </span>
                          ) : (
                            <span className="flex items-center gap-1.5 text-sm text-indigo-600 font-semibold group-hover:text-indigo-700">
                              {advice.action_url ? 'Tap to complete ‚Üí' : 'Tap when done ‚Üí'}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              );
            })}

            {/* Completion celebration */}
            {completedCount === todayAdvice.length && todayAdvice.length > 0 && (
              <Card className="bg-gradient-to-r from-green-500 to-emerald-600 text-white border-0 shadow-lg">
                <CardContent className="p-8 text-center">
                  <div className="text-5xl mb-3">üéâ</div>
                  <h3 className="text-2xl font-bold mb-2">Amazing Work!</h3>
                  <p className="text-green-100 text-lg">You've completed everything on your list today. You're a rockstar! üåü</p>
                  <p className="text-green-200 text-sm mt-3">Take a moment to celebrate ‚Äî you've earned it!</p>
                </CardContent>
              </Card>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

import React, { useState, useEffect } from "react";
// Added as per outline
import { Transaction } from "@/api/entities";
import { TeamMember } from "@/api/entities";
import { Property } from "@/api/entities";
// Added as per outline
import { Button } from "@/components/ui/button";
import { RefreshCw, AlertCircle } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { toast } from "sonner";

export default function DiagnoseCommissions() {
  const navigate = useNavigate();
  const [transactions, setTransactions] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [properties, setProperties] = useState([]);
  const [diagnostics, setDiagnostics] = useState([]);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [trans, members, props] = await Promise.all([
        Transaction.list(),
        TeamMember.list(),
        Property.list()
      ]);
      
      setTransactions(trans || []);
      setTeamMembers(members || []);
      setProperties(props || []);
      
      runDiagnostics(trans || [], members || [], props || []);
    } catch (error) {
      console.error("Error loading data:", error);
      toast.error("Failed to load data");
    }
    setIsLoading(false);
  };

  const runDiagnostics = (trans, members, props) => {
    const results = [];

    // Check each transaction
    trans.forEach(t => {
      const property = props.find(p => p.id === t.property_id);
      const result = {
        transactionId: t.id,
        propertyAddress: property?.address || "Unknown",
        status: t.status,
        contractPrice: t.contract_price,
        issues: []
      };

      // Check listing agent
      if (t.listing_agent_id) {
        const listingAgent = members.find(m => m.id === t.listing_agent_id);
        result.listingAgent = listingAgent?.full_name || `ID: ${t.listing_agent_id}`;
        result.listingNetCommission = t.listing_net_commission;
        
        if (!t.listing_net_commission || t.listing_net_commission === 0) {
          result.issues.push("‚ö†Ô∏è Listing commission is 0 or missing");
        }
      } else {
        result.issues.push("‚ùå No listing agent assigned");
      }

      // Check selling agent
      if (t.selling_agent_email) {
        const sellingAgent = members.find(m => 
          m.email && m.email.toLowerCase() === t.selling_agent_email.toLowerCase()
        );
        result.sellingAgent = sellingAgent?.full_name || t.selling_agent_name || t.selling_agent_email;
        result.sellingAgentEmail = t.selling_agent_email;
        result.sellingAgentMatchedInTeam = !!sellingAgent;
        result.sellingNetCommission = t.selling_net_commission;
        
        if (!sellingAgent) {
          result.issues.push(`‚ö†Ô∏è Selling agent email "${t.selling_agent_email}" not found in team members`);
        }
        
        if (!t.selling_net_commission || t.selling_net_commission === 0) {
          result.issues.push("‚ö†Ô∏è Selling commission is 0 or missing");
        }
      } else if (t.selling_agent_id) {
        const sellingAgent = members.find(m => m.id === t.selling_agent_id);
        result.sellingAgent = sellingAgent?.full_name || `ID: ${t.selling_agent_id}`;
        result.sellingNetCommission = t.selling_net_commission;
        
        if (!t.selling_net_commission || t.selling_net_commission === 0) {
          result.issues.push("‚ö†Ô∏è Selling commission is 0 or missing");
        }
      } else {
        result.issues.push("‚ùå No selling agent assigned");
      }

      // Check commission calculations
      if (t.contract_price && (!t.listing_net_commission && !t.selling_net_commission)) {
        result.issues.push("üî¥ Contract price exists but no commissions calculated");
      }

      results.push(result);
    });

    setDiagnostics(results);
  };

  const recalculateCommissions = async () => {
    if (!window.confirm("This will recalculate commissions for all transactions. Continue?")) {
      return;
    }

    setIsLoading(true);
    let updated = 0;
    let errors = 0;

    try {
      for (const trans of transactions) {
        if (!trans.contract_price || trans.contract_price === 0) continue;

        const price = parseFloat(trans.contract_price);
        const listingRate = parseFloat(trans.commission_listing) || 3;
        const sellingRate = parseFloat(trans.commission_selling) || 3;
        const split = parseFloat(trans.agent_split_percentage) || 50;

        const listingGross = price * (listingRate / 100);
        const listingNet = listingGross * (split / 100);
        
        const sellingGross = price * (sellingRate / 100);
        const sellingNet = sellingGross * (split / 100);

        try {
          await Transaction.update(trans.id, {
            listing_gross_commission: Math.round(listingGross),
            listing_net_commission: Math.round(listingNet),
            selling_gross_commission: Math.round(sellingGross),
            selling_net_commission: Math.round(sellingNet),
            commission_total: Math.round(listingGross + sellingGross)
          });
          updated++;
        } catch (error) {
          console.error(`Failed to update transaction ${trans.id}:`, error);
          errors++;
        }
      }

      toast.success(`Updated ${updated} transactions${errors > 0 ? `, ${errors} errors` : ''}`);
      await loadData();
    } catch (error) {
      console.error("Error recalculating commissions:", error);
      toast.error("Failed to recalculate commissions");
    }
    setIsLoading(false);
  };

  return (
    <div className="p-4 space-y-6"> {/* Changed outer div class as per outline */}
      <div className="app-card p-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h1 className="app-title text-2xl">Commission Diagnostics</h1>
            <p className="app-subtitle">Debug commission tracking issues</p>
          </div>
          <div className="flex gap-3">
            <Button onClick={recalculateCommissions} variant="outline" disabled={isLoading}>
              <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
              Recalculate All Commissions
            </Button>
            <Button onClick={() => navigate(createPageUrl("TeamMembers"))}>
              Back to Team Members
            </Button>
          </div>
        </div>
      </div>

      <div className="app-card p-6">
        <h2 className="text-lg font-semibold mb-4">Team Members</h2>
        <div className="space-y-2">
          {teamMembers.map(member => (
            <div key={member.id} className="p-3 bg-slate-50 rounded-lg">
              <p className="font-semibold">{member.full_name}</p>
              <p className="text-sm text-slate-600">Email: {member.email}</p>
              <p className="text-sm text-slate-600">ID: {member.id}</p>
            </div>
          ))}
        </div>
      </div>

      <div className="app-card p-6">
        <h2 className="text-lg font-semibold mb-4">Transaction Analysis</h2>
        <div className="space-y-4">
          {diagnostics.map((diag, idx) => (
            <div key={idx} className="p-4 border border-slate-200 rounded-lg">
              <div className="flex justify-between items-start mb-2">
                <div>
                  <p className="font-semibold">{diag.propertyAddress}</p>
                  <p className="text-sm text-slate-600">Status: {diag.status} | Price: ${diag.contractPrice?.toLocaleString()}</p>
                </div>
                {diag.issues.length > 0 && (
                  <AlertCircle className="w-5 h-5 text-amber-500" />
                )}
              </div>

              <div className="grid grid-cols-2 gap-4 mt-3 text-sm">
                <div>
                  <p className="font-semibold text-blue-600">Listing Agent:</p>
                  <p>{diag.listingAgent || "Not assigned"}</p>
                  <p className="text-green-600">Commission: ${diag.listingNetCommission?.toLocaleString() || 0}</p>
                </div>
                <div>
                  <p className="font-semibold text-purple-600">Selling Agent:</p>
                  <p>{diag.sellingAgent || "Not assigned"}</p>
                  {diag.sellingAgentEmail && (
                    <p className="text-xs text-slate-500">Email: {diag.sellingAgentEmail}</p>
                  )}
                  {diag.sellingAgentMatchedInTeam !== undefined && (
                    <p className="text-xs">
                      {diag.sellingAgentMatchedInTeam ? "‚úÖ Matched in team" : "‚ùå Not in team"}
                    </p>
                  )}
                  <p className="text-green-600">Commission: ${diag.sellingNetCommission?.toLocaleString() || 0}</p>
                </div>
              </div>

              {diag.issues.length > 0 && (
                <div className="mt-3 p-3 bg-amber-50 rounded-lg">
                  <p className="font-semibold text-amber-800 mb-1">Issues:</p>
                  {diag.issues.map((issue, i) => (
                    <p key={i} className="text-sm text-amber-700">{issue}</p>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

import React, { useState, useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Loader2, BrainCircuit, ArrowLeft, RefreshCw, Users, DollarSign, Briefcase, Activity } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import ReactMarkdown from 'react-markdown';

export default function DiagnoseTeam() {
    const navigate = useNavigate();
    const [analysis, setAnalysis] = useState(null);
    const [isAnalyzing, setIsAnalyzing] = useState(false);

    // Load all necessary data
    const { data: teamMembers = [], isLoading: loadingMembers } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: async () => {
            try {
                const members = await base44.entities.TeamMember.list() || [];
                console.log('‚úÖ DiagnoseTeam: Loaded team members:', members.length);
                return members;
            } catch (error) {
                console.error('‚ùå DiagnoseTeam: Error loading team members:', error);
                return [];
            }
        }
    });

    const { data: users = [], isLoading: loadingUsers } = useQuery({
        queryKey: ['users'],
        queryFn: async () => {
            try {
                return await base44.entities.User.list() || [];
            } catch (error) {
                console.error('Error loading users:', error);
                return [];
            }
        }
    });

    const { data: transactions = [], isLoading: loadingTransactions } = useQuery({
        queryKey: ['transactions'],
        queryFn: async () => {
            try {
                return await base44.entities.Transaction.list() || [];
            } catch (error) {
                console.error('Error loading transactions:', error);
                return [];
            }
        }
    });

    const { data: properties = [], isLoading: loadingProperties } = useQuery({
        queryKey: ['properties'],
        queryFn: async () => {
            try {
                return await base44.entities.Property.list() || [];
            } catch (error) {
                console.error('Error loading properties:', error);
                return [];
            }
        }
    });

    const { data: leads = [], isLoading: loadingLeads } = useQuery({
        queryKey: ['leads'],
        queryFn: async () => {
            try {
                return await base44.entities.Lead.list() || [];
            } catch (error) {
                console.error('Error loading leads:', error);
                return [];
            }
        }
    });

    const { data: leadActivities = [], isLoading: loadingActivities } = useQuery({
        queryKey: ['leadActivities'],
        queryFn: async () => {
            try {
                return await base44.entities.LeadActivity.list() || [];
            } catch (error) {
                console.error('Error loading activities:', error);
                return [];
            }
        }
    });

    const isLoadingData = loadingMembers || loadingUsers || loadingTransactions || 
                          loadingProperties || loadingLeads || loadingActivities;

    // Calculate comprehensive performance data (EXACT SAME LOGIC AS TEAM MEMBERS PAGE)
    const performanceData = useMemo(() => {
        console.log('üìä DiagnoseTeam: Calculating team performance...', {
            teamMembers: teamMembers.length,
            users: users.length,
            transactions: transactions.length,
            properties: properties.length,
            leads: leads.length,
            activities: leadActivities.length
        });

        if (!teamMembers || teamMembers.length === 0) {
            console.log('‚ö†Ô∏è DiagnoseTeam: No team members found');
            return [];
        }

        return teamMembers.map(member => {
            const user = users.find(u => u.email === member.email);
            console.log(`\nüë§ DiagnoseTeam analyzing ${member.full_name}...`);

            // Find transactions (METHOD 1 & 2: notes or selling_agent_name)
            const memberTransactions = transactions.filter(t => {
                try {
                    if (t.notes) {
                        const notes = JSON.parse(t.notes);
                        if (notes.listing_team_member_id === member.id || 
                            notes.selling_team_member_id === member.id) {
                            console.log(`  ‚úÖ Transaction matched via notes: Property ${t.property_id}`);
                            return true;
                        }
                    }
                } catch (e) {}
                
                if (t.selling_agent_name && t.selling_agent_name === member.full_name) {
                    console.log(`  ‚úÖ Transaction matched via selling_agent_name: ${t.selling_agent_name}`);
                    return true;
                }
                
                if (t.listing_agent_id === user?.id || t.selling_agent_id === user?.id) {
                    console.log(`  ‚úÖ Transaction matched via agent ID`);
                    return true;
                }
                
                return false;
            });

            // Calculate revenue
            let revenue = 0;
            memberTransactions.forEach(t => {
                let transactionRevenue = 0;
                
                try {
                    if (t.notes) {
                        const notes = JSON.parse(t.notes);
                        
                        if (notes.listing_team_member_id === member.id) {
                            transactionRevenue += (t.listing_net_commission || 0);
                            console.log(`    üí∞ Listing commission (via notes): $${t.listing_net_commission || 0}`);
                        }
                        
                        if (notes.selling_team_member_id === member.id) {
                            transactionRevenue += (t.selling_net_commission || 0);
                            console.log(`    üí∞ Selling commission (via notes): $${t.selling_net_commission || 0}`);
                        }
                    }
                } catch (e) {
                    console.error('    ‚ùå Error parsing transaction notes:', e);
                }
                
                if (transactionRevenue === 0) {
                    if (t.listing_agent_id === user?.id) {
                        transactionRevenue += (t.listing_net_commission || 0);
                        console.log(`    üí∞ Listing commission (via agent ID): $${t.listing_net_commission || 0}`);
                    }
                    if (t.selling_agent_id === user?.id) {
                        transactionRevenue += (t.selling_net_commission || 0);
                        console.log(`    üí∞ Selling commission (via agent ID): $${t.selling_net_commission || 0}`);
                    }
                }
                
                if (transactionRevenue === 0 && t.selling_agent_name === member.full_name) {
                    transactionRevenue += (t.selling_net_commission || 0);
                    console.log(`    üí∞ Selling commission (by name): $${t.selling_net_commission || 0}`);
                }
                
                revenue += transactionRevenue;
            });

            // Calculate properties managed (METHOD 3)
            const memberProperties = properties.filter(p => {
                if (p.listing_agent_id === user?.id) return true;
                if (p.tags && p.tags.includes(`listing_agent:${member.id}`)) {
                    console.log(`  ‚úÖ Property matched via tags: ${p.address}`);
                    return true;
                }
                return false;
            });

            // Calculate leads assigned (METHOD 4)
            const memberLeads = leads.filter(l => {
                if (l.assigned_agent_id === user?.id) return true;
                if (l.owner_id === user?.id) return true;
                if (l.notes && l.notes.includes(member.id)) {
                    console.log(`  ‚úÖ Lead matched via notes: ${l.name}`);
                    return true;
                }
                return false;
            });

            // Calculate activities
            const memberActivities = leadActivities.filter(a => {
                if (a.user_id === user?.id) return true;
                if (a.description && a.description.includes(member.full_name)) return true;
                return false;
            });

            const deals = memberTransactions.length;
            const activities = memberActivities.length;
            const propertiesCount = memberProperties.length;
            const leadsCount = memberLeads.length;

            console.log(`  üìä ${member.full_name} Stats:`, {
                deals,
                revenue: `$${revenue.toFixed(0)}`,
                properties: propertiesCount,
                leads: leadsCount,
                activities
            });

            return {
                name: member.full_name,
                role: member.role,
                email: member.email,
                deals,
                revenue,
                activities,
                properties: propertiesCount,
                leads: leadsCount,
                conversion_rate: leadsCount > 0 ? ((deals / leadsCount) * 100).toFixed(1) : 0,
                avg_deal_size: deals > 0 ? Math.round(revenue / deals) : 0,
            };
        });
    }, [teamMembers, users, transactions, properties, leads, leadActivities]);

    // Calculate team stats
    const teamStats = useMemo(() => {
        const totalRevenue = performanceData.reduce((sum, m) => sum + m.revenue, 0);
        const totalDeals = performanceData.reduce((sum, m) => sum + m.deals, 0);
        const totalActivities = performanceData.reduce((sum, m) => sum + m.activities, 0);
        const totalLeads = performanceData.reduce((sum, m) => sum + m.leads, 0);
        const totalProperties = performanceData.reduce((sum, m) => sum + m.properties, 0);

        console.log('üìà DiagnoseTeam Team Stats:', {
            totalRevenue: `$${totalRevenue.toFixed(0)}`,
            totalDeals,
            totalProperties,
            totalLeads,
            totalActivities,
            memberCount: performanceData.length
        });

        return {
            totalRevenue,
            totalDeals,
            totalActivities,
            totalLeads,
            totalProperties
        };
    }, [performanceData]);

    const runAnalysis = async () => {
        setIsAnalyzing(true);
        setAnalysis(null);
        
        try {
            const prompt = `As an expert real estate brokerage management consultant, analyze this team's comprehensive performance data.

**TEAM OVERVIEW:**
- Total Team Members: ${teamMembers.length}
- Total Revenue Generated: $${teamStats.totalRevenue.toLocaleString()}
- Total Closed Deals: ${teamStats.totalDeals}
- Total Properties Managed: ${teamStats.totalProperties}
- Total Active Leads: ${teamStats.totalLeads}
- Total Activities Logged: ${teamStats.totalActivities}

**INDIVIDUAL AGENT PERFORMANCE:**
${performanceData.map((agent, idx) => `
${idx + 1}. **${agent.name}** (${agent.role})
   - Revenue: $${agent.revenue.toLocaleString()}
   - Closed Deals: ${agent.deals}
   - Properties Managed: ${agent.properties}
   - Active Leads: ${agent.leads}
   - Activities: ${agent.activities}
   - Lead Conversion Rate: ${agent.conversion_rate}%
   - Average Deal Size: $${agent.avg_deal_size.toLocaleString()}
`).join('\n')}

**REQUIRED ANALYSIS:**

### 1. Overall Team Health (2-3 sentences)
Provide a high-level assessment of the team's performance and dynamics.

### 2. Top Performers (Identify 2-3 agents)
Who are the standout performers and why? Consider revenue, deal count, conversion rates, and consistency.

### 3. Agents Needing Support (Identify specific agents)
Which agents need immediate attention or support? What specific challenges are they facing?

### 4. Performance Gaps & Imbalances
- Are there agents with high activity but low conversions?
- Are there agents with low activity that need coaching?
- Is revenue distributed fairly or concentrated in few agents?
- Are there skill gaps across the team?

### 5. Actionable Recommendations (5-7 specific items)
Provide concrete, actionable steps the broker should take immediately. Examples:
- "Pair [Agent A] with [Agent B] for mentorship on [specific skill]"
- "Launch a team competition focused on [specific metric]"
- "Schedule 1-on-1 coaching with [Agent C] to address [specific issue]"
- "Create a training session on [specific topic] for the whole team"
- "Implement weekly check-ins with agents who have < X activities"

### 6. Key Metrics to Monitor
What 3-4 metrics should the broker track weekly to improve team performance?

Format your response in Markdown with clear headers, bullet points, and bold text for emphasis.`;

            const response = await base44.integrations.Core.InvokeLLM({ 
                prompt,
                add_context_from_internet: false 
            });
            setAnalysis(response);

        } catch (error) {
            console.error("Error running analysis:", error);
            setAnalysis("**Analysis Failed**\n\nUnable to generate analysis. Please ensure you have team members, transactions, and activity data in the system, then try again.");
        } finally {
            setIsAnalyzing(false);
        }
    };

    return (
        <div className="page-container space-y-6">
            <div className="flex items-center gap-4">
                <Button variant="outline" size="icon" onClick={() => navigate(createPageUrl('TeamMembers'))}>
                    <ArrowLeft className="w-4 h-4"/>
                </Button>
                <div>
                    <h1 className="text-2xl font-bold">AI Team Performance Analyst</h1>
                    <p className="text-slate-500">Comprehensive AI-powered analysis of your team's performance and recommendations.</p>
                </div>
            </div>

            {/* Quick Stats */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Team Members</p>
                                <p className="text-2xl font-bold text-slate-900 dark:text-white">{teamMembers.length}</p>
                            </div>
                            <Users className="w-8 h-8 text-blue-500" />
                        </div>
                    </CardContent>
                </Card>
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Revenue</p>
                                <p className="text-2xl font-bold text-slate-900 dark:text-white">
                                    ${(teamStats.totalRevenue / 1000).toFixed(0)}k
                                </p>
                            </div>
                            <DollarSign className="w-8 h-8 text-green-500" />
                        </div>
                    </CardContent>
                </Card>
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Deals</p>
                                <p className="text-2xl font-bold text-slate-900 dark:text-white">{teamStats.totalDeals}</p>
                            </div>
                            <Briefcase className="w-8 h-8 text-purple-500" />
                        </div>
                    </CardContent>
                </Card>
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Avg per Agent</p>
                                <p className="text-2xl font-bold text-slate-900 dark:text-white">
                                    ${performanceData.length > 0 ? (teamStats.totalRevenue / performanceData.length / 1000).toFixed(0) : 0}k
                                </p>
                            </div>
                            <Activity className="w-8 h-8 text-orange-500" />
                        </div>
                    </CardContent>
                </Card>
            </div>

            <Card>
                <CardHeader>
                    <CardTitle>Run Team Diagnosis</CardTitle>
                    <CardDescription>
                        Click the button to analyze your team's performance data and receive detailed insights and actionable recommendations.
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <Button 
                        onClick={runAnalysis} 
                        disabled={isAnalyzing || isLoadingData || teamMembers.length === 0}
                    >
                        {isAnalyzing ? (
                            <><Loader2 className="w-4 h-4 mr-2 animate-spin"/>Analyzing Team Performance...</>
                        ) : (
                            <><BrainCircuit className="w-4 h-4 mr-2"/>Run Comprehensive Analysis</>
                        )}
                    </Button>
                     {analysis && (
                        <Button variant="ghost" onClick={runAnalysis} disabled={isAnalyzing} className="ml-2">
                            <RefreshCw className="w-4 h-4 mr-2"/>Re-run Analysis
                        </Button>
                    )}
                    {teamMembers.length === 0 && !isLoadingData && (
                        <p className="text-sm text-amber-600 mt-4">
                            ‚ö†Ô∏è No team members found. Please add team members in Settings ‚Üí Team Management first.
                        </p>
                    )}
                </CardContent>
            </Card>

            {(isAnalyzing || isLoadingData) && (
                <div className="text-center p-8">
                    <Loader2 className="w-8 h-8 mx-auto animate-spin text-indigo-600"/>
                    <p className="mt-4 text-slate-600">
                        {isLoadingData ? "Loading team performance data..." : "AI is analyzing your team's performance across all metrics..."}
                    </p>
                </div>
            )}

            {analysis && (
                <Card>
                    <CardHeader>
                        <CardTitle>Analysis Results</CardTitle>
                    </CardHeader>
                    <CardContent className="prose dark:prose-invert max-w-none">
                        <ReactMarkdown>{analysis}</ReactMarkdown>
                    </CardContent>
                </Card>
            )}
        </div>
    );
}
import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import {
    FileText, Upload, Search, Download, Eye, Trash2, Check, X,
    Sparkles, RefreshCw, MessageCircle, Filter, FileCheck,
    AlertCircle, Loader2, ChevronDown, ChevronUp, BookOpen, Edit, CheckCircle, CheckCircle2, Tag
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogFooter,
} from '@/components/ui/dialog';
import { Textarea } from '@/components/ui/textarea';
import DocumentUploadModal from '../components/documents/DocumentUploadModal';
import DocumentPreviewModal from '../components/documents/DocumentPreviewModal';
import ExtractedDataEditor from '../components/documents/ExtractedDataEditor';
import ContractDataDisplay from '../components/documents/ContractDataDisplay';
import ClausesViewer from '../components/documents/ClausesViewer';
import RelatedDocuments from '../components/documents/RelatedDocuments';
import ConfidenceIndicator from '../components/documents/ConfidenceIndicator';
import DocumentTagEditor from '../components/documents/DocumentTagEditor';
import DocumentCompareModal from '../components/documents/DocumentCompareModal';
import LoadingSpinner from '../components/common/LoadingSpinner';
import { format, parseISO } from 'date-fns';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';

export default function Documents() {
    const queryClient = useQueryClient();
    const navigate = useNavigate();

    const [showUploadModal, setShowUploadModal] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [searchResults, setSearchResults] = useState(null);
    const [isSearching, setIsSearching] = useState(false);
    const [selectedDocument, setSelectedDocument] = useState(null);
    const [showQuestionDialog, setShowQuestionDialog] = useState(false);
    const [question, setQuestion] = useState('');
    const [answer, setAnswer] = useState(null);
    const [isAsking, setIsAsking] = useState(false);
    const [expandedDoc, setExpandedDoc] = useState(null);
    const [filterType, setFilterType] = useState('all');
    const [filterStatus, setFilterStatus] = useState('all');
    const [filterProperty, setFilterProperty] = useState('all');
    const [processingDocId, setProcessingDocId] = useState(null);
    const [processingAll, setProcessingAll] = useState(false);
    const [justProcessedDocs, setJustProcessedDocs] = useState(new Set());

    const [showPreviewModal, setShowPreviewModal] = useState(false);
    const [previewDocument, setPreviewDocument] = useState(null);
    const [showDataEditor, setShowDataEditor] = useState(false);
    const [showTagEditor, setShowTagEditor] = useState(false);
    const [showCompareModal, setShowCompareModal] = useState(false);
    const [editingDocument, setEditingDocument] = useState(null);
    const [isCreatingTransaction, setIsCreatingTransaction] = useState(false);
    const [creationProgress, setCreationProgress] = useState({ step: 0, total: 5, message: '' });

    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me(),
    });

    const { data: documents = [], isLoading } = useQuery({
        queryKey: ['documents', user?.id],
        queryFn: () => base44.entities.Document.filter({ uploaded_by: user.id }, '-upload_date'),
        enabled: !!user?.id,
        staleTime: 5 * 60 * 1000,
        refetchOnMount: false,
        refetchOnWindowFocus: false
    });

    const { data: allTasks = [] } = useQuery({
        queryKey: ['tasks'],
        queryFn: () => base44.entities.Task.list(),
        enabled: !!user,
        staleTime: 5 * 60 * 1000,
        refetchOnMount: false,
        refetchOnWindowFocus: false
    });

    const { data: properties = [] } = useQuery({
        queryKey: ['properties'],
        queryFn: async () => {
            try {
                return await base44.entities.Property.list();
            } catch (error) {
                console.error('Error fetching properties:', error);
                return [];
            }
        },
        enabled: !!user,
        staleTime: 30 * 60 * 1000,
        gcTime: 60 * 60 * 1000,
        refetchOnMount: false,
        refetchOnWindowFocus: false
    });

    const { data: transactions = [] } = useQuery({
        queryKey: ['transactions'],
        queryFn: async () => {
            try {
                return await base44.entities.Transaction.list();
            } catch (error) {
                console.error('Error fetching transactions:', error);
                return [];
            }
        },
        enabled: !!user,
        staleTime: 30 * 60 * 1000,
        gcTime: 60 * 60 * 1000,
        refetchOnMount: false,
        refetchOnWindowFocus: false
    });

    // Process document with AI
    const processDocumentMutation = useMutation({
        mutationFn: async (documentId) => {
            setProcessingDocId(documentId);
            const response = await base44.functions.invoke('processDocumentEnhanced', { document_id: documentId });
            return response.data;
        },
        onSuccess: (data, variables) => {
            queryClient.invalidateQueries({ queryKey: ['documents'] });

            // Mark as just processed
            setJustProcessedDocs(prev => new Set(prev).add(variables));
            setTimeout(() => {
                setJustProcessedDocs(prev => {
                    const newSet = new Set(prev);
                    newSet.delete(variables);
                    return newSet;
                });
            }, 5000);

            let message = '‚ú® Document processed successfully!';
            if (data.matched_property_id) {
                message += ' Property matched!';
            }
            if (data.tasks_created > 0) {
                message += ` ${data.tasks_created} tasks created.`;
            }
            if (data.clauses_extracted > 0) {
                message += ` ${data.clauses_extracted} clauses extracted.`;
            }
            if (data.confidence?.needs_review) {
                message += ' ‚ö†Ô∏è Review recommended.';
            }

            toast.success(message, { duration: 6000 });
            setProcessingDocId(null);
        },
        onError: (error) => {
            toast.error(`Failed to process document: ${error.message}`);
            setProcessingDocId(null);
        },
    });

    // Process all pending documents
    const handleProcessAll = async () => {
        const pendingDocs = documents.filter(d => d.ai_processing_status === 'pending');
        
        if (pendingDocs.length === 0) {
            toast.error('No pending documents to process');
            return;
        }

        setProcessingAll(true);
        let successCount = 0;
        let errorCount = 0;

        for (const doc of pendingDocs) {
            try {
                await base44.functions.invoke('processDocumentEnhanced', { document_id: doc.id });
                successCount++;
            } catch (error) {
                errorCount++;
            }
        }

        setProcessingAll(false);
        queryClient.invalidateQueries({ queryKey: ['documents'] });
        
        if (successCount > 0) {
            toast.success(`Processed ${successCount} document${successCount > 1 ? 's' : ''} successfully!`);
        }
        if (errorCount > 0) {
            toast.error(`Failed to process ${errorCount} document${errorCount > 1 ? 's' : ''}`);
        }
    };

    // Search documents
    const handleSearch = async () => {
        if (!searchQuery.trim()) {
            toast.error('Please enter a search query');
            return;
        }

        setIsSearching(true);
        try {
            const response = await base44.functions.invoke('searchDocuments', {
                query: searchQuery
            });
            setSearchResults(response.data);
            if (response.data.results.length === 0) {
                toast.info('No matching documents found');
            }
        } catch (error) {
            toast.error('Search failed: ' + error.message);
        } finally {
            setIsSearching(false);
        }
    };

    // Ask question about document
    const handleAskQuestion = async () => {
        if (!question.trim()) {
            toast.error('Please enter a question');
            return;
        }

        setIsAsking(true);
        try {
            const response = await base44.functions.invoke('askDocument', {
                document_id: selectedDocument.id,
                question: question
            });
            setAnswer(response.data);
        } catch (error) {
            toast.error('Failed to get answer: ' + error.message);
        } finally {
            setIsAsking(false);
        }
    };

    const deleteDocumentMutation = useMutation({
        mutationFn: (id) => base44.entities.Document.delete(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['documents'] });
            toast.success('Document deleted successfully');
        },
        onError: (error) => {
            toast.error(`Failed to delete document: ${error.message}`);
        },
    });

    // Approve document
    const approveDocumentMutation = useMutation({
        mutationFn: (id) => base44.entities.Document.update(id, {
            status: 'approved',
            approved_date: new Date().toISOString()
        }),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['documents'] });
            toast.success('Document approved successfully!');
        },
        onError: (error) => {
            toast.error(`Failed to approve document: ${error.message}`);
        },
    });

    // Reject document
    const rejectDocumentMutation = useMutation({
        mutationFn: (id) => base44.entities.Document.update(id, {
            status: 'archived'
        }),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['documents'] });
            toast.success('Document archived');
        },
        onError: (error) => {
            toast.error(`Failed to archive document: ${error.message}`);
        },
    });

    // Handle viewing/previewing document
    const handleViewDocument = (doc) => {
        setPreviewDocument(doc);
        setShowPreviewModal(true);
    };

    // Handle file upload
    const handleUpload = async (file, propertyId, transactionId, category, manualAddress = null) => {
        try {
            // Upload the file
            const { file_url } = await base44.integrations.Core.UploadFile({ file });

            // Create document record
            const newDoc = await base44.entities.Document.create({
                file_url: file_url,
                document_name: file.name,
                transaction_id: transactionId || null,
                property_id: propertyId || null,
                document_type: category,
                category: category,
                uploaded_by: user?.id,
                upload_date: new Date().toISOString(),
                status: 'pending',
                ai_processing_status: 'pending'
            });

            // Create initial version
            await base44.entities.DocumentVersion.create({
                document_id: newDoc.id,
                version_number: 1,
                file_url: file_url,
                document_name: file.name,
                ai_summary: '',
                ai_key_points: '[]', // Changed to string for JSON field
                ai_clauses: '[]',     // Changed to string for JSON field
                ai_category: '',
                extracted_text: '',
                change_type: 'created',
                change_description: 'Initial document upload',
                changed_by: user?.id,
                changed_by_name: user?.full_name,
                is_current: true,
            });

            // Refresh documents list
            queryClient.invalidateQueries({ queryKey: ['documents'] });
            toast.success('Document uploaded successfully!');
            return true;
        } catch (error) {
            console.error('Upload error:', error);
            toast.error('Failed to upload document: ' + error.message);
            throw error;
        }
    };

    const filteredDocuments = useMemo(() => {
        let filtered = documents;

        if (filterType !== 'all') {
            filtered = filtered.filter(d => d.document_type === filterType);
        }

        if (filterStatus !== 'all') {
            filtered = filtered.filter(d => d.status === filterStatus);
        }

        if (filterProperty !== 'all') {
            filtered = filtered.filter(d => d.property_id === filterProperty);
        }

        return filtered;
    }, [documents, filterType, filterStatus, filterProperty]);

    const stats = useMemo(() => {
        const processed = documents.filter(d => d.ai_processing_status === 'completed').length;
        const pending = documents.filter(d => d.ai_processing_status === 'pending').length;
        const failed = documents.filter(d => d.ai_processing_status === 'failed').length;

        return { total: documents.length, processed, pending, failed };
    }, [documents]);

    const getPropertyName = (propertyId) => {
        const property = properties.find(p => p.id === propertyId);
        return property?.address || 'Unknown Property';
    };

    const getStatusColor = (status) => {
        const colors = {
            pending: 'bg-yellow-100 text-yellow-800',
            approved: 'bg-green-100 text-green-800',
            signed: 'bg-blue-100 text-blue-800',
            archived: 'bg-gray-100 text-gray-800',
        };
        return colors[status] || colors.pending;
    };

    const getProcessingStatusBadge = (status) => {
        const config = {
            pending: { icon: AlertCircle, color: 'bg-yellow-100 text-yellow-800', text: 'Not Processed' },
            processing: { icon: Loader2, color: 'bg-blue-100 text-blue-800', text: 'Processing...', spin: true },
            completed: { icon: Check, color: 'bg-green-100 text-green-800', text: 'AI Processed' },
            failed: { icon: X, color: 'bg-red-100 text-red-800', text: 'Failed' },
        };

        const { icon: Icon, color, text, spin } = config[status] || config.pending;

        return (
            <Badge className={color}>
                <Icon className={`w-3 h-3 mr-1 ${spin ? 'animate-spin' : ''}`} />
                {text}
            </Badge>
        );
    };

    const highlightAddresses = (text) => {
        if (!text) return text;

        // Pattern to match addresses (numbers followed by street names and optional city/state)
        const addressPattern = /(\d+\s+[A-Z][a-zA-Z\s]+(?:Street|St|Avenue|Ave|Road|Rd|Drive|Dr|Lane|Ln|Boulevard|Blvd|Court|Ct|Circle|Cir|Way|Place|Pl|Parkway|Pkwy|Park)(?:\s+[A-Z][a-zA-Z]+)?(?:,\s*[A-Z]{2})?)/gi;

        const parts = [];
        let lastIndex = 0;
        let match;

        while ((match = addressPattern.exec(text)) !== null) {
            // Add text before the match
            if (match.index > lastIndex) {
                parts.push(text.substring(lastIndex, match.index));
            }
            // Add the highlighted address
            parts.push(
                <span key={match.index} className="font-semibold text-red-600">
                    {match[0]}
                </span>
            );
            lastIndex = match.index + match[0].length;
        }

        // Add remaining text
        if (lastIndex < text.length) {
            parts.push(text.substring(lastIndex));
        }

        return parts.length > 0 ? parts : text;
    };

    const DocumentCard = ({ doc }) => {
        const isExpanded = expandedDoc === doc.id;
        const isJustProcessed = justProcessedDocs.has(doc.id);

        // Safely parse JSON fields with error handling
        const keyPoints = useMemo(() => {
            try {
                if (!doc.ai_key_points) return [];
                const parsed = JSON.parse(doc.ai_key_points);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.error('Error parsing ai_key_points:', e);
                return [];
            }
        }, [doc.ai_key_points]);

        const clauses = useMemo(() => {
            try {
                if (!doc.ai_clauses) return [];
                const parsed = JSON.parse(doc.ai_clauses);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.error('Error parsing ai_clauses:', e);
                return [];
            }
        }, [doc.ai_clauses]);

        // Safely format upload date
        const uploadDate = useMemo(() => {
            try {
                if (!doc.upload_date && !doc.created_date) return 'Unknown date';
                const dateStr = doc.upload_date || doc.created_date;
                return format(parseISO(dateStr), 'MMM d, yyyy h:mm a');
            } catch (e) {
                console.error('Error formatting date:', e);
                return 'Unknown date';
            }
        }, [doc.upload_date, doc.created_date]);

        return (
            <Card className={`hover:shadow-lg transition-all ${isJustProcessed ? 'ring-2 ring-green-500 shadow-green-200 dark:shadow-green-900' : ''}`}>
                <CardContent className="p-4">
                    <div className="mb-3">
                        <div className="flex items-center gap-2 mb-2">
                            <FileText className="w-5 h-5 text-blue-600" />
                            <h3 className="font-semibold text-slate-900">{doc.document_name || 'Untitled Document'}</h3>
                        </div>

                        <div className="flex flex-wrap gap-2 mb-3">
                            {doc.ai_processing_status === 'pending' && (
                                <Button
                                    type="button"
                                    size="sm"
                                    variant="outline"
                                    onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        processDocumentMutation.mutate(doc.id);
                                    }}
                                    disabled={processingDocId === doc.id}
                                    className="gap-1"
                                >
                                    {processingDocId === doc.id ? (
                                        <>
                                            <Loader2 className="w-4 h-4 animate-spin" />
                                            <span className="text-xs">Processing...</span>
                                        </>
                                    ) : (
                                        <>
                                            <Sparkles className="w-4 h-4" />
                                            <span className="text-xs">AI Process</span>
                                        </>
                                    )}
                                </Button>
                            )}
                            {doc.status === 'pending' && (
                                <Button
                                    size="sm"
                                    className="bg-green-600 hover:bg-green-700 text-white"
                                    onClick={() => approveDocumentMutation.mutate(doc.id)}
                                    disabled={approveDocumentMutation.isLoading}
                                >
                                    <Check className="w-4 h-4 mr-1" />
                                    Approve
                                </Button>
                            )}
                            {doc.ai_processing_status === 'completed' && doc.enriched_data && (
                                <>
                                    <Button
                                        size="sm"
                                        variant="outline"
                                        onClick={() => {
                                            setEditingDocument(doc);
                                            setShowDataEditor(true);
                                        }}
                                        className="border-blue-200 text-blue-700 hover:bg-blue-50"
                                    >
                                        <Edit className="w-4 h-4 mr-1" />
                                        Edit Data
                                    </Button>
                                    <Button
                                        size="sm"
                                        variant="outline"
                                        onClick={() => {
                                            setEditingDocument(doc);
                                            setShowTagEditor(true);
                                        }}
                                        className="border-purple-200 text-purple-700 hover:bg-purple-50"
                                    >
                                        <Tag className="w-4 h-4 mr-1" />
                                        Tags & Links
                                    </Button>
                                    {!doc.transaction_id && (
                                        <Button
                                            size="sm"
                                            className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:from-indigo-700 hover:to-purple-700"
                                            disabled={isCreatingTransaction}
                                            onClick={async () => {
                                            setIsCreatingTransaction(true);
                                            
                                            try {
                                                setCreationProgress({ step: 1, total: 5, message: 'Parsing document data...' });
                                                await new Promise(resolve => setTimeout(resolve, 500));

                                                const enrichedData = typeof doc.enriched_data === 'string' ? JSON.parse(doc.enriched_data) : doc.enriched_data;

                                                // Check if property already exists in system by matching address
                                                let matchedProperty = null;
                                                if (enrichedData.property_address && !doc.property_id) {
                                                    const addressToMatch = enrichedData.property_address.toLowerCase();
                                                    matchedProperty = properties.find(p => 
                                                        p.address && p.address.toLowerCase().includes(addressToMatch.substring(0, 20))
                                                    );
                                                    if (matchedProperty) {
                                                        toast.success(`‚úÖ Found existing property: ${matchedProperty.address}`);
                                                    }
                                                }
                                                
                                                setCreationProgress({ step: 2, total: 5, message: 'Calculating commissions...' });
                                                await new Promise(resolve => setTimeout(resolve, 400));
                                                
                                                const price = parseFloat(enrichedData.contract_price) || 0;
                                                const listingRate = parseFloat(enrichedData.listing_commission_rate) || 3;
                                                const sellingRate = parseFloat(enrichedData.selling_commission_rate) || 3;
                                                const split = 50;
                                                const transFee = 0;
                                                
                                                // Get matched agent IDs from enriched data
                                                const matchedListingAgentId = enrichedData.matched_listing_agent_id;
                                                const matchedSellingAgentId = enrichedData.matched_selling_agent_id;
                                                
                                                const total = price * ((listingRate + sellingRate) / 100);
                                                const listingGross = price * (listingRate / 100);
                                                const listingNet = (listingGross * (split / 100)) - transFee;
                                                const sellingGross = price * (sellingRate / 100);
                                                const sellingNet = (sellingGross * (split / 100)) - transFee;
                                                
                                                let buyerAgentArray = [];
                                                if (enrichedData.buyer_agent_info) {
                                                    if (Array.isArray(enrichedData.buyer_agent_info)) {
                                                        buyerAgentArray = enrichedData.buyer_agent_info;
                                                    } else if (enrichedData.selling_agent) {
                                                        buyerAgentArray = [{ name: enrichedData.selling_agent, email: "", cell_phone: "", home_phone: "", role: "agent" }];
                                                    }
                                                }
                                                
                                                let sellersArray = [];
                                                if (enrichedData.seller_names && Array.isArray(enrichedData.seller_names)) {
                                                    sellersArray = enrichedData.seller_names.map(name => ({
                                                        name: name,
                                                        email: "",
                                                        cell_phone: "",
                                                        home_phone: ""
                                                    }));
                                                }
                                                
                                                let buyersArray = [];
                                                if (enrichedData.buyer_names && Array.isArray(enrichedData.buyer_names)) {
                                                    buyersArray = enrichedData.buyer_names.map(name => ({
                                                        name: name,
                                                        email: "",
                                                        cell_phone: "",
                                                        home_phone: ""
                                                    }));
                                                }
                                                
                                                setCreationProgress({ step: 3, total: 5, message: 'Creating transaction record...' });
                                                await new Promise(resolve => setTimeout(resolve, 400));
                                                
                                                const newTransaction = await base44.entities.Transaction.create({
                                                    property_id: matchedProperty?.id || doc.property_id || null,
                                                    manual_address: (matchedProperty?.id || doc.property_id) ? null : enrichedData.property_address,
                                                    status: 'pending',
                                                    transaction_type: 'sale',
                                                    contract_price: price,
                                                    commission_listing: listingRate,
                                                    commission_selling: sellingRate,
                                                    agent_split_percentage: split,
                                                    transaction_fee: transFee,
                                                    commission_total: Math.round(total),
                                                    listing_gross_commission: Math.round(listingGross),
                                                    listing_net_commission: Math.round(listingNet),
                                                    selling_gross_commission: Math.round(sellingGross),
                                                    selling_net_commission: Math.round(sellingNet),
                                                    title_company: enrichedData.title_company || enrichedData.escrow_company || null,
                                                    escrow_number: enrichedData.escrow_number || null,
                                                    sellers_info: JSON.stringify(sellersArray),
                                                    buyers_info: JSON.stringify(buyersArray),
                                                    selling_agents_info: JSON.stringify(buyerAgentArray),
                                                    listing_agent_id: matchedListingAgentId || user?.id,
                                                    selling_agent_id: matchedSellingAgentId || null,
                                                    selling_agent_name: matchedSellingAgentId ? null : enrichedData.selling_agent,
                                                    selling_agent_email: matchedSellingAgentId ? null : enrichedData.selling_agent_email,
                                                    selling_agent_phone: matchedSellingAgentId ? null : enrichedData.selling_agent_phone,
                                                    selling_agent_office: matchedSellingAgentId ? null : enrichedData.selling_agent_company,
                                                    roles: {
                                                        listing_agent_id: matchedListingAgentId || user?.id,
                                                        selling_agent_id: matchedSellingAgentId || null
                                                    },
                                                    important_dates: {
                                                        offer_date: enrichedData.offer_date || null,
                                                        acceptance_date: enrichedData.acceptance_date || null,
                                                        inspection_deadline: enrichedData.inspection_deadline || null,
                                                        inspection_date: enrichedData.inspection_date || null,
                                                        appraisal_date: enrichedData.appraisal_date || null,
                                                        financing_deadline: enrichedData.financing_deadline || enrichedData.loan_approval_deadline || null,
                                                        mortgage_approval_date: enrichedData.mortgage_approval_date || null,
                                                        title_search_date: enrichedData.title_search_date || null,
                                                        final_walkthrough_date: enrichedData.final_walkthrough_date || null,
                                                        closing_date: enrichedData.closing_date || null
                                                    },
                                                    notes: enrichedData.special_provisions ? `Special Provisions:\n${enrichedData.special_provisions}` : null
                                                });
                                                
                                                setCreationProgress({ step: 4, total: 5, message: 'Linking document to transaction...' });
                                                await new Promise(resolve => setTimeout(resolve, 300));
                                                
                                                await base44.entities.Document.update(doc.id, {
                                                    transaction_id: newTransaction.id
                                                });
                                                
                                                setCreationProgress({ step: 5, total: 5, message: 'Finalizing...' });
                                                await new Promise(resolve => setTimeout(resolve, 300));
                                                
                                                queryClient.invalidateQueries({ queryKey: ['transactions'] });
                                                queryClient.invalidateQueries({ queryKey: ['documents'] });
                                                
                                                setIsCreatingTransaction(false);
                                                toast.success('‚ú® Transaction created with all extracted data!');
                                                
                                                const finalPropertyId = matchedProperty?.id || doc.property_id;
                                                if (finalPropertyId) {
                                                    navigate(createPageUrl(`PropertyDetail?id=${finalPropertyId}`));
                                                } else {
                                                    navigate(createPageUrl('Transactions'));
                                                }
                                            } catch (error) {
                                                console.error('Error creating transaction:', error);
                                                setIsCreatingTransaction(false);
                                                toast.error('Failed to create transaction: ' + error.message);
                                            }
                                        }}
                                    >
                                        {isCreatingTransaction ? (
                                            <>
                                                <Loader2 className="w-4 h-4 mr-1 animate-spin" />
                                                Creating...
                                            </>
                                        ) : (
                                            <>
                                                <CheckCircle className="w-4 h-4 mr-1" />
                                                Create Transaction
                                            </>
                                        )}
                                    </Button>
                                    )}
                                </>
                            )}
                            {doc.ai_processing_status === 'completed' && (
                                <Button
                                    size="sm"
                                    variant="outline"
                                    onClick={() => {
                                        setSelectedDocument(doc);
                                        setShowQuestionDialog(true);
                                        setAnswer(null);
                                        setQuestion('');
                                    }}
                                >
                                    <MessageCircle className="w-4 h-4 mr-1" />
                                    Ask
                                </Button>
                            )}
                            <Button
                                size="sm"
                                variant="outline"
                                onClick={() => handleViewDocument(doc)}
                            >
                                <Eye className="w-4 h-4" />
                            </Button>
                            <Button
                                size="sm"
                                variant="outline"
                                onClick={() => deleteDocumentMutation.mutate(doc.id)}
                            >
                                <Trash2 className="w-4 h-4 text-red-600" />
                            </Button>
                        </div>

                        <div className="flex flex-wrap gap-2 mb-2">
                            <Badge variant="outline" className="capitalize">
                                {doc.document_type || 'other'}
                            </Badge>
                            <Badge className={getStatusColor(doc.status || 'pending')}>
                                {doc.status || 'pending'}
                            </Badge>
                            {getProcessingStatusBadge(doc.ai_processing_status || 'pending')}
                            {isJustProcessed && (
                                <Badge className="bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-200 animate-pulse">
                                    <Sparkles className="w-3 h-3 mr-1" />
                                    Just Processed
                                </Badge>
                            )}
                        </div>

                        {/* AI Tags Display */}
                        {(doc.ai_tags || doc.manual_tags) && (
                            <div className="flex flex-wrap gap-1.5 mb-2">
                                {(doc.ai_tags || '').split(',').filter(Boolean).map((tag, idx) => (
                                    <Badge key={`ai-${idx}`} variant="outline" className="text-xs bg-purple-50 text-purple-700 border-purple-200">
                                        <Sparkles className="w-3 h-3 mr-1" />
                                        {tag.trim()}
                                    </Badge>
                                ))}
                                {(doc.manual_tags || '').split(',').filter(Boolean).map((tag, idx) => (
                                    <Badge key={`manual-${idx}`} variant="outline" className="text-xs bg-blue-50 text-blue-700 border-blue-200">
                                        {tag.trim()}
                                    </Badge>
                                ))}
                            </div>
                        )}

                        {/* Suggested Task Links */}
                        {doc.suggested_task_ids && doc.suggested_task_ids.split(',').filter(Boolean).length > 0 && (
                            <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 rounded-lg p-2 mb-2">
                                <p className="text-xs text-amber-800 dark:text-amber-200 flex items-center gap-1">
                                    <Sparkles className="w-3 h-3" />
                                    AI suggests linking to {doc.suggested_task_ids.split(',').filter(Boolean).length} task(s)
                                </p>
                            </div>
                        )}
                        {doc.property_id && (
                            <p className="text-sm flex items-center gap-1">
                                <span>üìç</span>
                                <span className="font-semibold text-red-600">{getPropertyName(doc.property_id)}</span>
                                {doc.ai_category && (
                                    <Badge variant="outline" className="ml-2 text-xs">
                                        {doc.ai_category}
                                    </Badge>
                                )}
                            </p>
                        )}
                        {!doc.property_id && !doc.transaction_id && doc.ai_processing_status === 'completed' && (() => {
                            try {
                                const analysis = doc.enriched_data ? JSON.parse(doc.enriched_data) : null;
                                const propertyAddress = analysis?.property_address;
                                
                                if (propertyAddress) {
                                    // Check for matching property
                                    const matchedProperty = properties.find(p => 
                                        p.address && p.address.toLowerCase().includes(propertyAddress.toLowerCase().substring(0, 20))
                                    );
                                    
                                    // Check for matching transaction
                                    const matchedTransaction = transactions.find(t => 
                                        (t.manual_address && t.manual_address.toLowerCase().includes(propertyAddress.toLowerCase().substring(0, 20))) ||
                                        (t.property_id === matchedProperty?.id)
                                    );
                                    
                                    if (matchedProperty || matchedTransaction) {
                                        return (
                                            <div className="text-sm bg-green-50 dark:bg-green-900/20 p-3 rounded border border-green-200 dark:border-green-800">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="flex items-center gap-2">
                                                        <CheckCircle2 className="w-4 h-4 text-green-600" />
                                                        <p className="font-semibold text-green-900 dark:text-green-100">
                                                            Match Found!
                                                        </p>
                                                    </div>
                                                </div>
                                                <p className="text-xs text-green-800 dark:text-green-200 mb-2">
                                                    üìç {matchedProperty?.address || matchedTransaction?.manual_address}
                                                </p>
                                                <Button
                                                    size="sm"
                                                    className="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white"
                                                    onClick={async () => {
                                                        try {
                                                            await base44.entities.Document.update(doc.id, {
                                                                property_id: matchedProperty?.id || null,
                                                                transaction_id: matchedTransaction?.id || null
                                                            });
                                                            queryClient.invalidateQueries({ queryKey: ['documents'] });
                                                            toast.success(`‚úÖ Document linked to ${matchedProperty?.address || matchedTransaction?.manual_address}`);
                                                        } catch (error) {
                                                            toast.error('Failed to link document');
                                                        }
                                                    }}
                                                >
                                                    <CheckCircle2 className="w-4 h-4 mr-2" />
                                                    Add to {matchedProperty?.address.substring(0, 30) || matchedTransaction?.manual_address.substring(0, 30)}
                                                </Button>
                                            </div>
                                        );
                                    } else {
                                        return (
                                            <div className="text-sm bg-amber-50 dark:bg-amber-900/20 p-2 rounded flex items-start gap-2 border border-amber-200">
                                                <AlertCircle className="w-4 h-4 flex-shrink-0 mt-0.5 text-amber-600" />
                                                <div>
                                                    <p className="font-medium text-slate-700 dark:text-slate-300">Address found:</p>
                                                    <p className="text-xs font-semibold text-amber-700 dark:text-amber-300">{propertyAddress}</p>
                                                    <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">No matching property/transaction</p>
                                                </div>
                                            </div>
                                        );
                                    }
                                }
                            } catch (e) {
                                return null;
                            }
                            return null;
                        })()}
                        <p className="text-xs text-slate-500 mt-1">
                            Uploaded {uploadDate}
                        </p>
                        </div>

                    {doc.ai_processing_status === 'completed' && (
                        <>
                            {doc.ai_summary && (
                                <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
                                    <div className="flex items-center gap-2 mb-2">
                                        <Sparkles className="w-4 h-4 text-blue-600" />
                                        <span className="text-sm font-semibold text-blue-900 dark:text-blue-100">
                                            AI Summary
                                        </span>
                                    </div>
                                    <p className="text-sm text-slate-700 dark:text-slate-300">
                                        {highlightAddresses(doc.ai_summary)}
                                    </p>
                                </div>
                            )}

                            {/* Display extracted contract data - ALWAYS show re-process button */}
                            {(() => {
                                try {
                                    const data = doc.enriched_data ? (typeof doc.enriched_data === 'string' ? JSON.parse(doc.enriched_data) : doc.enriched_data) : null;
                                    const hasDetailedData = data?.buyer_names || data?.seller_names || data?.contract_price || data?.closing_date;
                                    
                                    return (
                                        <>
                                            {hasDetailedData ? (
                                                <ContractDataDisplay enrichedData={doc.enriched_data} />
                                            ) : (
                                                <div className="bg-amber-50 dark:bg-amber-900/20 border-2 border-amber-400 rounded-lg p-4 mt-3">
                                                    <p className="text-base font-semibold text-amber-900 dark:text-amber-100 mb-2">
                                                        ‚ö†Ô∏è Limited data extracted - Click below to get full details
                                                    </p>
                                                    <p className="text-sm text-amber-800 dark:text-amber-200 mb-3">
                                                        Enhanced AI will extract: Buyers, Sellers, Property Address, Contract Price, Deposits, Closing Date, Contingencies, and auto-create tasks!
                                                    </p>
                                                    <Button
                                                        size="sm"
                                                        onClick={(e) => {
                                                            e.preventDefault();
                                                            e.stopPropagation();
                                                            processDocumentMutation.mutate(doc.id);
                                                        }}
                                                        className="bg-amber-600 hover:bg-amber-700 text-white"
                                                        disabled={processDocumentMutation.isPending}
                                                    >
                                                        {processDocumentMutation.isPending ? (
                                                            <>
                                                                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                                                Processing...
                                                            </>
                                                        ) : (
                                                            <>
                                                                <RefreshCw className="w-4 h-4 mr-2" />
                                                                Extract Full Contract Details Now
                                                            </>
                                                        )}
                                                    </Button>
                                                </div>
                                            )}
                                        </>
                                    );
                                } catch (e) {
                                    return null;
                                }
                            })()}

                            <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => setExpandedDoc(isExpanded ? null : doc.id)}
                                className="w-full justify-between"
                            >
                                <span className="text-sm font-medium">
                                    {isExpanded ? 'Hide' : 'Show'} Details
                                </span>
                                {isExpanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                            </Button>

                            {isExpanded && (
                                <div className="mt-3 space-y-3">
                                    {keyPoints.length > 0 && (
                                        <div>
                                            <h4 className="text-sm font-semibold mb-2 flex items-center gap-2">
                                                <FileCheck className="w-4 h-4 text-green-600" />
                                                Key Points
                                            </h4>
                                            <ul className="space-y-1">
                                                {keyPoints.map((point, idx) => (
                                                    <li key={idx} className="text-sm text-slate-700 flex items-start gap-2">
                                                        <span className="text-green-600 mt-0.5">‚Ä¢</span>
                                                        {point}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}

                                    {clauses.length > 0 && (
                                        <div>
                                            <h4 className="text-sm font-semibold mb-2 flex items-center gap-2">
                                                <BookOpen className="w-4 h-4 text-purple-600" />
                                                Important Clauses
                                            </h4>
                                            <div className="space-y-2">
                                                {clauses.map((clause, idx) => (
                                                    <div key={idx} className="bg-slate-50 rounded p-2">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="text-sm font-medium">{clause.title || 'Untitled'}</span>
                                                            {clause.importance && (
                                                                <Badge variant="outline" className="text-xs">
                                                                    {clause.importance}
                                                                </Badge>
                                                            )}
                                                        </div>
                                                        <p className="text-xs text-slate-600">{clause.description || ''}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </>
                    )}

                    {doc.ai_processing_status === 'failed' && doc.ai_processing_error && (
                        <div className="bg-red-50 rounded-lg p-3 mt-3">
                            <p className="text-sm text-red-800">
                                <strong>Error:</strong> {doc.ai_processing_error}
                            </p>
                            <Button
                                size="sm"
                                variant="outline"
                                onClick={() => processDocumentMutation.mutate(doc.id)}
                                className="mt-2"
                            >
                                <RefreshCw className="w-4 h-4 mr-1" />
                                Retry
                            </Button>
                        </div>
                    )}
                </CardContent>
            </Card>
        );
    };

    if (isLoading) {
        return <LoadingSpinner icon={FileText} title="Loading Documents..." description="Loading your documents and AI insights" />;
    }

    return (
        <div className="page-container p-6 bg-slate-50 dark:bg-slate-950 min-h-screen">
            <div className="max-w-7xl mx-auto space-y-6">
                {/* Header */}
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-3xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                            <FileText className="w-8 h-8 text-blue-600" />
                            AI-Powered Documents
                        </h1>
                        <p className="text-slate-600 dark:text-slate-400 mt-1">
                            Intelligent document management with AI summaries and search
                        </p>
                    </div>
                    <div className="flex gap-3">
                        {stats.pending > 0 && (
                            <Button 
                                onClick={handleProcessAll} 
                                size="lg"
                                variant="outline"
                                disabled={processingAll}
                            >
                                {processingAll ? (
                                    <>
                                        <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                        Processing All...
                                    </>
                                ) : (
                                    <>
                                        <Sparkles className="w-5 h-5 mr-2" />
                                        Process All ({stats.pending})
                                    </>
                                )}
                            </Button>
                        )}
                        {documents.length >= 2 && (
                            <Button 
                                onClick={() => setShowCompareModal(true)} 
                                size="lg"
                                variant="outline"
                                className="border-purple-200 text-purple-700 hover:bg-purple-50"
                            >
                                <FileText className="w-5 h-5 mr-2" />
                                Compare Documents
                            </Button>
                        )}
                        <Button onClick={() => setShowUploadModal(true)} size="lg">
                            <Upload className="w-5 h-5 mr-2" />
                            Upload Document
                        </Button>
                    </div>
                </div>

                {/* Stats Cards */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <Card>
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm text-slate-600">Total Documents</p>
                                    <p className="text-2xl font-bold text-slate-900">{stats.total}</p>
                                </div>
                                <FileText className="w-8 h-8 text-blue-600" />
                            </div>
                        </CardContent>
                    </Card>
                    <Card>
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm text-slate-600">AI Processed</p>
                                    <p className="text-2xl font-bold text-green-600">{stats.processed}</p>
                                </div>
                                <Sparkles className="w-8 h-8 text-green-600" />
                            </div>
                        </CardContent>
                    </Card>
                    <Card>
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm text-slate-600">Pending</p>
                                    <p className="text-2xl font-bold text-yellow-600">{stats.pending}</p>
                                </div>
                                <AlertCircle className="w-8 h-8 text-yellow-600" />
                            </div>
                        </CardContent>
                    </Card>
                    <Card>
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm text-slate-600">Failed</p>
                                    <p className="text-2xl font-bold text-red-600">{stats.failed}</p>
                                </div>
                                <X className="w-8 h-8 text-red-600" />
                            </div>
                        </CardContent>
                    </Card>
                </div>

                {/* AI Search */}
                <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                            <Search className="w-5 h-5 text-purple-600" />
                            AI-Powered Document Search
                        </CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div className="flex gap-3">
                            <Input
                                placeholder="Ask anything... e.g., 'Find documents with closing date in January' or 'Show me inspection reports'"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                className="flex-1"
                            />
                            <Button onClick={handleSearch} disabled={isSearching}>
                                {isSearching ? (
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                ) : (
                                    <Search className="w-4 h-4" />
                                )}
                            </Button>
                        </div>

                        {searchResults && (
                            <div className="mt-4">
                                <div className="flex items-center justify-between mb-3">
                                    <p className="text-sm text-slate-600">
                                        Found {searchResults.results_found} results in {searchResults.total_searched} documents
                                    </p>
                                    <Button
                                        variant="ghost"
                                        size="sm"
                                        onClick={() => setSearchResults(null)}
                                    >
                                        Clear
                                    </Button>
                                </div>
                                <div className="space-y-3">
                                    {searchResults.results.map((result) => (
                                        <div key={result.document_id} className="bg-white rounded-lg border p-4">
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex-1">
                                                    <h4 className="font-semibold text-slate-900">{result.document_name}</h4>
                                                    <Badge variant="outline" className="mt-1">{result.document_type}</Badge>
                                                </div>
                                                <Badge className="bg-purple-100 text-purple-800">
                                                    {result.relevance_score}% match
                                                </Badge>
                                            </div>
                                            <p className="text-sm text-slate-700 mb-2">{result.explanation}</p>
                                            {result.matching_sections.length > 0 && (
                                                <div className="bg-blue-50 rounded p-2">
                                                    <p className="text-xs font-semibold text-blue-900 mb-1">Matching sections:</p>
                                                    {result.matching_sections.map((section, idx) => (
                                                        <p key={idx} className="text-xs text-blue-800">‚Ä¢ {section}</p>
                                                    ))}
                                                </div>
                                            )}
                                            <div className="flex gap-2 mt-3">
                                                <Button
                                                    size="sm"
                                                    variant="outline"
                                                    onClick={() => handleViewDocument(documents.find(d => d.id === result.document_id))}
                                                >
                                                    <Eye className="w-4 h-4 mr-1" />
                                                    View
                                                </Button>
                                                <Button
                                                    size="sm"
                                                    variant="outline"
                                                    onClick={() => {
                                                        const doc = documents.find(d => d.id === result.document_id);
                                                        setSelectedDocument(doc);
                                                        setShowQuestionDialog(true);
                                                    }}
                                                >
                                                    <MessageCircle className="w-4 h-4 mr-1" />
                                                    Ask Question
                                                </Button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </CardContent>
                </Card>

                {/* Filters */}
                <div className="flex flex-wrap gap-3">
                    <select
                        value={filterType}
                        onChange={(e) => setFilterType(e.target.value)}
                        className="px-4 py-2 border rounded-lg"
                    >
                        <option value="all">All Types</option>
                        <option value="contract">Contracts</option>
                        <option value="disclosure">Disclosures</option>
                        <option value="inspection">Inspections</option>
                        <option value="appraisal">Appraisals</option>
                        <option value="title">Title</option>
                        <option value="closing">Closing</option>
                        <option value="other">Other</option>
                    </select>
                    <select
                        value={filterStatus}
                        onChange={(e) => setFilterStatus(e.target.value)}
                        className="px-4 py-2 border rounded-lg"
                    >
                        <option value="all">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="signed">Signed</option>
                        <option value="archived">Archived</option>
                    </select>
                    <select
                        value={filterProperty}
                        onChange={(e) => setFilterProperty(e.target.value)}
                        className="px-4 py-2 border rounded-lg"
                    >
                        <option value="all">All Properties</option>
                        {properties.map((property) => (
                            <option key={property.id} value={property.id}>
                                {property.address}
                            </option>
                        ))}
                    </select>
                </div>

                {/* Documents Grid */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {filteredDocuments.map((doc) => (
                        <DocumentCard key={doc.id} doc={doc} />
                    ))}
                </div>

                {filteredDocuments.length === 0 && (
                    <Card>
                        <CardContent className="p-12 text-center">
                            <FileText className="w-16 h-16 text-slate-300 mx-auto mb-4" />
                            <h3 className="text-lg font-semibold text-slate-900 mb-2">No documents found</h3>
                            <p className="text-slate-600 mb-4">Upload your first document to get started</p>
                            <Button onClick={() => setShowUploadModal(true)}>
                                <Upload className="w-4 h-4 mr-2" />
                                Upload Document
                            </Button>
                        </CardContent>
                    </Card>
                )}
            </div>

            {/* Upload Modal */}
            {showUploadModal && (
                <DocumentUploadModal
                    onClose={() => setShowUploadModal(false)}
                    onUpload={handleUpload}
                    properties={properties}
                    transactions={transactions}
                />
            )}

            {/* Preview Modal */}
            {showPreviewModal && previewDocument && (
                <DocumentPreviewModal
                    document={previewDocument}
                    onClose={() => {
                        setShowPreviewModal(false);
                        setPreviewDocument(null);
                    }}
                    onApprove={() => {
                        approveDocumentMutation.mutate(previewDocument.id);
                        setShowPreviewModal(false);
                        setPreviewDocument(null);
                    }}
                    onReject={() => {
                        rejectDocumentMutation.mutate(previewDocument.id);
                        setShowPreviewModal(false);
                        setPreviewDocument(null);
                    }}
                />
            )}

            {/* Data Editor Modal */}
            {showDataEditor && editingDocument && (
                <ExtractedDataEditor
                    document={editingDocument}
                    onClose={() => {
                        setShowDataEditor(false);
                        setEditingDocument(null);
                    }}
                    onSave={() => {
                        queryClient.invalidateQueries({ queryKey: ['documents'] });
                    }}
                />
            )}

            {/* Tag Editor Modal */}
            {showTagEditor && editingDocument && (
                <DocumentTagEditor
                    document={editingDocument}
                    tasks={allTasks.filter(t => t.property_id === editingDocument.property_id)}
                    onClose={() => {
                        setShowTagEditor(false);
                        setEditingDocument(null);
                    }}
                    onSave={() => {
                        queryClient.invalidateQueries({ queryKey: ['documents'] });
                        setShowTagEditor(false);
                        setEditingDocument(null);
                    }}
                />
            )}

            {/* Document Compare Modal */}
            {showCompareModal && (
                <DocumentCompareModal
                    documents={documents}
                    onClose={() => setShowCompareModal(false)}
                />
            )}

            {/* Transaction Creation Progress Modal */}
            <Dialog open={isCreatingTransaction} onOpenChange={() => {}}>
                <DialogContent className="max-w-md" onPointerDownOutside={(e) => e.preventDefault()}>
                    <DialogHeader>
                        <DialogTitle className="flex items-center gap-2">
                            <Sparkles className="w-5 h-5 text-indigo-600 animate-pulse" />
                            Creating Transaction
                        </DialogTitle>
                    </DialogHeader>
                    <div className="space-y-4 py-4">
                        <div className="space-y-2">
                            <div className="flex items-center justify-between text-sm">
                                <span className="font-medium text-slate-700">{creationProgress.message}</span>
                                <span className="text-slate-500">{creationProgress.step}/{creationProgress.total}</span>
                            </div>
                            <div className="h-2 w-full bg-slate-200 rounded-full overflow-hidden">
                                <div
                                    className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500 ease-out"
                                    style={{ width: `${(creationProgress.step / creationProgress.total) * 100}%` }}
                                />
                            </div>
                        </div>
                        <div className="space-y-1 text-xs text-slate-600">
                            <div className="flex items-center gap-2">
                                {creationProgress.step > 0 ? <CheckCircle2 className="w-4 h-4 text-green-600" /> : <div className="w-4 h-4 rounded-full border-2 border-slate-300" />}
                                <span className={creationProgress.step > 0 ? 'text-green-600 font-medium' : ''}>Parse document data</span>
                            </div>
                            <div className="flex items-center gap-2">
                                {creationProgress.step > 1 ? <CheckCircle2 className="w-4 h-4 text-green-600" /> : creationProgress.step === 1 ? <Loader2 className="w-4 h-4 animate-spin text-indigo-600" /> : <div className="w-4 h-4 rounded-full border-2 border-slate-300" />}
                                <span className={creationProgress.step > 1 ? 'text-green-600 font-medium' : ''}>Calculate commissions</span>
                            </div>
                            <div className="flex items-center gap-2">
                                {creationProgress.step > 2 ? <CheckCircle2 className="w-4 h-4 text-green-600" /> : creationProgress.step === 2 ? <Loader2 className="w-4 h-4 animate-spin text-indigo-600" /> : <div className="w-4 h-4 rounded-full border-2 border-slate-300" />}
                                <span className={creationProgress.step > 2 ? 'text-green-600 font-medium' : ''}>Create transaction record</span>
                            </div>
                            <div className="flex items-center gap-2">
                                {creationProgress.step > 3 ? <CheckCircle2 className="w-4 h-4 text-green-600" /> : creationProgress.step === 3 ? <Loader2 className="w-4 h-4 animate-spin text-indigo-600" /> : <div className="w-4 h-4 rounded-full border-2 border-slate-300" />}
                                <span className={creationProgress.step > 3 ? 'text-green-600 font-medium' : ''}>Link document to transaction</span>
                            </div>
                            <div className="flex items-center gap-2">
                                {creationProgress.step > 4 ? <CheckCircle2 className="w-4 h-4 text-green-600" /> : creationProgress.step === 4 ? <Loader2 className="w-4 h-4 animate-spin text-indigo-600" /> : <div className="w-4 h-4 rounded-full border-2 border-slate-300" />}
                                <span className={creationProgress.step > 4 ? 'text-green-600 font-medium' : ''}>Finalize and redirect</span>
                            </div>
                        </div>
                    </div>
                </DialogContent>
            </Dialog>

            {/* Question Dialog */}
            <Dialog open={showQuestionDialog} onOpenChange={setShowQuestionDialog}>
                <DialogContent className="max-w-2xl">
                    <DialogHeader>
                        <DialogTitle>Ask a Question</DialogTitle>
                        <DialogDescription>
                            Ask anything about {selectedDocument?.document_name}
                        </DialogDescription>
                    </DialogHeader>
                    <div className="space-y-4">
                        <Textarea
                            placeholder="e.g., What is the closing date? What are the seller's obligations? Are there any contingencies?"
                            value={question}
                            onChange={(e) => setQuestion(e.target.value)}
                            rows={3}
                        />
                        <Button onClick={handleAskQuestion} disabled={isAsking} className="w-full">
                            {isAsking ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                    Getting Answer...
                                </>
                            ) : (
                                <>
                                    <MessageCircle className="w-4 h-4 mr-2" />
                                    Get Answer
                                </>
                            )}
                        </Button>

                        {answer && (
                            <div className="bg-slate-50 rounded-lg p-4 space-y-3">
                                <div className="flex items-center gap-2">
                                    {answer.found_in_document ? (
                                        <Badge className="bg-green-100 text-green-800">
                                            <Check className="w-3 h-3 mr-1" />
                                            Found in document
                                        </Badge>
                                    ) : (
                                        <Badge className="bg-yellow-100 text-yellow-800">
                                            <AlertCircle className="w-3 h-3 mr-1" />
                                            Not found
                                        </Badge>
                                    )}
                                    <Badge variant="outline">
                                        {answer.confidence} confidence
                                    </Badge>
                                </div>
                                <div>
                                    <p className="text-sm font-semibold text-slate-900 mb-2">Answer:</p>
                                    <p className="text-sm text-slate-700">{answer.answer}</p>
                                </div>
                                {answer.relevant_sections && answer.relevant_sections.length > 0 && (
                                    <div>
                                        <p className="text-sm font-semibold text-slate-900 mb-2">Relevant sections:</p>
                                        <div className="space-y-1">
                                            {answer.relevant_sections.map((section, idx) => (
                                                <p key={idx} className="text-xs text-slate-600 bg-white rounded p-2">
                                                    {section}
                                                </p>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </DialogContent>
            </Dialog>
        </div>
    );
}
import React from "react";
import { base44 } from "@/api/base44Client";
import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  Home,
  Phone,
  ArrowLeft,
  DollarSign,
  AlertCircle,
  Target,
  TrendingDown,
  Users,
  FileText,
  Sun,
  CloudRain
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { format, differenceInDays } from "date-fns";

export default function DoorKnockingGuide() {
  const navigate = useNavigate();

  const { data: user } = useQuery({
    queryKey: ["user"],
    queryFn: () => base44.auth.me()
  });

  const { data: properties = [] } = useQuery({
    queryKey: ["properties"],
    queryFn: () => base44.entities.Property.list(),
    enabled: !!user
  });

  const { data: fsboLeads = [] } = useQuery({
    queryKey: ["fsboLeads"],
    queryFn: () => base44.entities.FSBOLead.list(),
    enabled: !!user
  });

  const { data: weatherData } = useQuery({
    queryKey: ["weather"],
    queryFn: async () => {
      if (!user?.office_address) return null;
      try {
        const result = await base44.integrations.Core.InvokeLLM({
          prompt: `What's the weather like today in ${user.office_address}? Return temperature and condition.`,
          add_context_from_internet: true,
          response_json_schema: {
            type: "object",
            properties: {
              temperature: { type: "number" },
              condition: { type: "string" },
              suitable_for_outdoor: { type: "boolean" }
            }
          }
        });
        return result;
      } catch (e) {
        return null;
      }
    },
    enabled: !!user?.office_address,
    staleTime: 60 * 60 * 1000
  });

  const expiredListings = properties.filter(p => {
    if (p.status !== 'expired') return false;
    const expirationDate = new Date(p.expiration_date);
    const daysSince = differenceInDays(new Date(), expirationDate);
    return daysSince <= 90;
  });

  const activeFSBOs = fsboLeads.filter(f => f.status !== 'converted' && f.status !== 'lost');

  const doorKnockingTips = [
    {
      title: "Best Time to Door Knock",
      content: "Weekday evenings (5-7pm) and Saturday mornings (10am-12pm) typically yield the best results. Avoid meal times and early mornings."
    },
    {
      title: "Opening Line",
      content: "Hi, I'm [Name], a local real estate agent. I recently helped sell a home on [nearby street]. Have you thought about what your home might be worth in today's market?"
    },
    {
      title: "Value Proposition",
      content: "Offer a free market analysis, share recent sales data for the neighborhood, mention upcoming open houses, or provide local market reports."
    },
    {
      title: "Handle Objections",
      content: "If they say 'not interested': Ask if they know anyone who might be. Leave your card. Be respectful and friendly - you're building long-term relationships."
    },
    {
      title: "Follow Up",
      content: "Log every interaction in your CRM. Send a handwritten note or market report within 24 hours. Set a reminder to follow up in 3-6 months."
    }
  ];

  return (
    <div className="space-y-6">
      <Card>
        <CardContent className="p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(-1)}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-green-600 to-teal-600 flex items-center justify-center">
              <Home className="w-7 h-7 text-white" />
            </div>
            <div className="flex-1">
              <h1 className="text-3xl font-bold">Door Knocking Guide</h1>
              <p className="text-slate-600 dark:text-slate-400">
                Target expired listings and FSBOs in your area
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      {weatherData && (
        <Card className={weatherData.suitable_for_outdoor ? "bg-green-50 dark:bg-green-900/20 border-green-200" : "bg-red-50 dark:bg-red-900/20 border-red-200"}>
          <CardContent className="p-6">
            <div className="flex items-center gap-3">
              {weatherData.suitable_for_outdoor ? (
                <Sun className="w-8 h-8 text-green-600" />
              ) : (
                <CloudRain className="w-8 h-8 text-red-600" />
              )}
              <div>
                <h3 className="font-semibold text-lg">
                  {weatherData.suitable_for_outdoor ? "Perfect Door Knocking Weather!" : "Weather Advisory"}
                </h3>
                <p className="text-sm text-slate-600">
                  {weatherData.temperature}¬∞F, {weatherData.condition}
                  {!weatherData.suitable_for_outdoor && " - Consider rescheduling or do phone calls instead"}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-slate-600 mb-1">Expired Listings (90 days)</p>
                <p className="text-3xl font-bold text-orange-600">{expiredListings.length}</p>
              </div>
              <TrendingDown className="w-10 h-10 text-orange-600 opacity-20" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-slate-600 mb-1">Active FSBOs</p>
                <p className="text-3xl font-bold text-purple-600">{activeFSBOs.length}</p>
              </div>
              <Users className="w-10 h-10 text-purple-600 opacity-20" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-slate-600 mb-1">Total Targets</p>
                <p className="text-3xl font-bold text-green-600">{expiredListings.length + activeFSBOs.length}</p>
              </div>
              <Target className="w-10 h-10 text-green-600 opacity-20" />
            </div>
          </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <TrendingDown className="w-5 h-5 text-orange-600" />
              Expired Listings ({expiredListings.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            {expiredListings.length > 0 ? (
              <div className="space-y-3">
                {expiredListings.map((property) => {
                  const daysSinceExpired = differenceInDays(new Date(), new Date(property.expiration_date));
                  return (
                    <div
                      key={property.id}
                      className="p-4 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 rounded-lg cursor-pointer hover:shadow-md transition-shadow"
                      onClick={() => navigate(createPageUrl(`PropertyDetail?id=${property.id}`))}
                    >
                      <div className="flex items-start justify-between mb-2">
                        <div className="flex-1">
                          <h4 className="font-semibold">{property.address}</h4>
                          <p className="text-sm text-slate-600">{property.city}, {property.state}</p>
                        </div>
                        <Badge className="bg-orange-100 text-orange-700">
                          {daysSinceExpired} days ago
                        </Badge>
                      </div>
                      <div className="flex items-center gap-4 text-sm text-slate-600">
                        <span className="flex items-center gap-1">
                          <DollarSign className="w-4 h-4" />
                          ${property.price?.toLocaleString()}
                        </span>
                        <span>{property.bedrooms} bed ‚Ä¢ {property.bathrooms} bath</span>
                      </div>
                      <p className="text-xs text-slate-500 mt-2">
                        Expired: {format(new Date(property.expiration_date), "MMM d, yyyy")}
                      </p>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-center py-8">
                <TrendingDown className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                <p className="text-slate-600">No expired listings in the last 90 days</p>
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Users className="w-5 h-5 text-purple-600" />
              For Sale By Owner ({activeFSBOs.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            {activeFSBOs.length > 0 ? (
              <div className="space-y-3">
                {activeFSBOs.map((fsbo) => (
                  <div
                    key={fsbo.id}
                    className="p-4 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 rounded-lg cursor-pointer hover:shadow-md transition-shadow"
                    onClick={() => navigate(createPageUrl(`FSBODetail?id=${fsbo.id}`))}
                  >
                    <div className="flex items-start justify-between mb-2">
                      <div className="flex-1">
                        <h4 className="font-semibold">{fsbo.property_address}</h4>
                        <p className="text-sm text-slate-600">{fsbo.owner_name}</p>
                      </div>
                      <Badge className={
                        fsbo.status === 'new' ? "bg-green-100 text-green-700" :
                        fsbo.status === 'contacted' ? "bg-blue-100 text-blue-700" :
                        "bg-yellow-100 text-yellow-700"
                      }>
                        {fsbo.status}
                      </Badge>
                    </div>
                    <div className="flex items-center gap-4 text-sm text-slate-600">
                      {fsbo.asking_price && (
                        <span className="flex items-center gap-1">
                          <DollarSign className="w-4 h-4" />
                          ${fsbo.asking_price?.toLocaleString()}
                        </span>
                      )}
                      {fsbo.owner_phone && (
                        <span className="flex items-center gap-1">
                          <Phone className="w-4 h-4" />
                          {fsbo.owner_phone}
                        </span>
                      )}
                    </div>
                    {fsbo.last_contact_date && (
                      <p className="text-xs text-slate-500 mt-2">
                        Last contact: {format(new Date(fsbo.last_contact_date), "MMM d, yyyy")}
                      </p>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8">
                <Users className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                <p className="text-slate-600">No active FSBO leads</p>
                <Button
                  className="mt-4"
                  onClick={() => navigate(createPageUrl("FSBO"))}
                >
                  Find FSBOs
                </Button>
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Door Knocking Best Practices</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {doorKnockingTips.map((tip, idx) => (
              <div
                key={idx}
                className="p-4 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 rounded-lg border"
              >
                <h4 className="font-semibold mb-2 flex items-center gap-2">
                  <AlertCircle className="w-4 h-4 text-indigo-600" />
                  {tip.title}
                </h4>
                <p className="text-sm text-slate-600 dark:text-slate-400">
                  {tip.content}
                </p>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
        <CardHeader>
          <CardTitle>Quick Actions</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-3">
            <Button onClick={() => navigate(createPageUrl("FSBO"))}>
              <Users className="w-4 h-4 mr-2" />
              Find More FSBOs
            </Button>
            <Button variant="outline" onClick={() => navigate(createPageUrl("Properties"))}>
              <Home className="w-4 h-4 mr-2" />
              View All Properties
            </Button>
            <Button variant="outline" onClick={() => navigate(createPageUrl("Tasks"))}>
              <FileText className="w-4 h-4 mr-2" />
              Create Follow-up Tasks
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Mail,
  Plus,
  Trash2,
  CheckCircle2,
  AlertCircle,
  RefreshCw,
  Star,
  Settings,
  Globe,
  Shield,
  Zap,
  Clock,
  Check,
  X,
  Loader2,
  Send,
  Inbox,
  Search,
  Building2,
  ArrowRight,
  Calendar as CalendarIcon,
  Sparkles,
  User,
  Target,
  FileText
} from "lucide-react";
import { toast } from "sonner";
import { format, formatDistanceToNow } from "date-fns";
import { syncEmails } from "@/api/functions";
import { gmailOAuth } from "@/api/functions";
import { processEmailWithAI } from "@/api/functions";
import MeetingScheduler from "../components/scheduling/MeetingScheduler";
import EmailComposeModal from "../components/messages/EmailComposeModal";

export default function EmailIntegration() {
  const queryClient = useQueryClient();
  const [showAddModal, setShowAddModal] = useState(false);
  const [editingAccount, setEditingAccount] = useState(null);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
  const [activeTab, setActiveTab] = useState("accounts");
  const [selectedMessage, setSelectedMessage] = useState(null);
  const [searchQuery, setSearchQuery] = useState("");
  const [messageTypeFilter, setMessageTypeFilter] = useState("all");
  const [categoryFilter, setCategoryFilter] = useState("all");
  const [syncingAccountId, setSyncingAccountId] = useState(null);
  const [showMeetingScheduler, setShowMeetingScheduler] = useState(false);
  const [meetingPreFill, setMeetingPreFill] = useState({});
  const [selectedMessageIds, setSelectedMessageIds] = useState(new Set());
  const [showReplyModal, setShowReplyModal] = useState(false);
  const [replyingTo, setReplyingTo] = useState(null);
  const [processingEmailId, setProcessingEmailId] = useState(null);
  const [isRefreshing, setIsRefreshing] = useState(false);

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me()
  });

  const { data: emailAccounts = [], isLoading } = useQuery({
    queryKey: ['emailAccounts'],
    queryFn: () => base44.entities.EmailAccount.filter({ user_id: user?.id }),
    enabled: !!user,
    initialData: []
  });

  const { data: emailMessages = [], isLoading: emailMessagesLoading } = useQuery({
    queryKey: ['emailMessages'],
    queryFn: () => base44.entities.EmailMessage.list('-received_date'),
    enabled: !!user,
    initialData: []
  });

  const { data: allMessages = [] } = useQuery({
    queryKey: ['messages'],
    queryFn: () => base44.entities.Message.list('-created_date'),
    initialData: []
  });

  const { data: properties = [] } = useQuery({
    queryKey: ['properties'],
    queryFn: () => base44.entities.Property.list(),
    initialData: []
  });

  const { data: users = [] } = useQuery({
    queryKey: ['users'],
    queryFn: () => base44.entities.User.list(),
    initialData: []
  });

  const createAccountMutation = useMutation({
    mutationFn: (accountData) => base44.entities.EmailAccount.create(accountData),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['emailAccounts'] });
      setShowAddModal(false);
      setEditingAccount(null);
      toast.success("Email account connected successfully!");
    },
    onError: (error) => {
      toast.error("Failed to connect email account: " + error.message);
    }
  });

  const updateAccountMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.EmailAccount.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['emailAccounts'] });
      toast.success("Email account updated!");
    },
    onError: (error) => {
      toast.error("Failed to update: " + error.message);
    }
  });

  const deleteAccountMutation = useMutation({
    mutationFn: (id) => base44.entities.EmailAccount.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['emailAccounts'] });
      setShowDeleteConfirm(null);
      toast.success("Email account removed");
    },
    onError: (error) => {
      toast.error("Failed to delete: " + error.message);
    }
  });

  const deleteMessagesMutation = useMutation({
    mutationFn: async (messageIds) => {
      const deletePromises = Array.from(messageIds).map(async (id) => {
        const [type, originalId] = id.split('-');
        if (type === 'synced') {
          return base44.entities.EmailMessage.delete(originalId);
        } else if (type === 'internal') {
          return base44.entities.Message.delete(originalId);
        }
      });
      return Promise.all(deletePromises);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['emailMessages'] });
      queryClient.invalidateQueries({ queryKey: ['messages'] });
      setSelectedMessageIds(new Set());
      toast.success(`Deleted ${selectedMessageIds.size} message${selectedMessageIds.size > 1 ? 's' : ''}`);
    },
    onError: (error) => {
      toast.error("Failed to delete messages: " + error.message);
    }
  });

  const handleSetPrimary = async (accountId) => {
    const updatePromises = emailAccounts.map(acc =>
      updateAccountMutation.mutateAsync({
        id: acc.id,
        data: { is_primary: acc.id === accountId }
      })
    );
  
    try {
      await Promise.all(updatePromises);
      queryClient.invalidateQueries({ queryKey: ['emailAccounts'] });
      toast.success("Primary email account updated.");
    } catch (error) {
      toast.error("Failed to set primary account: " + error.message);
    }
  };

  const handleToggleSync = async (account) => {
    await updateAccountMutation.mutateAsync({
      id: account.id,
      data: { sync_enabled: !account.sync_enabled }
    });
  };

  const handleToggleActive = async (account) => {
    await updateAccountMutation.mutateAsync({
      id: account.id,
      data: { is_active: !account.is_active }
    });
  };

  const handleSyncEmails = async (accountId, demoMode = false) => {
    setSyncingAccountId(accountId);
    try {
      const result = await syncEmails({ 
        email_account_id: accountId,
        demo_mode: demoMode 
      });
      
      if (result.data.success) {
        // Force immediate refresh
        await queryClient.invalidateQueries({ queryKey: ['emailMessages'] });
        await queryClient.invalidateQueries({ queryKey: ['emailAccounts'] });
        
        // Wait a moment for data to update
        await new Promise(resolve => setTimeout(resolve, 500));
        
        if (result.data.demo_mode) {
          toast.success(`üìß Generated ${result.data.synced_count} demo emails!`, {
            description: 'Click "All Messages" tab to view them',
            duration: 5000
          });
          
          // Auto-switch to messages tab after sync
          setTimeout(() => setActiveTab('messages'), 1000);
        } else {
          toast.success(`‚úÖ Synced ${result.data.synced_count} new emails!`);
          setTimeout(() => setActiveTab('messages'), 1000);
        }
      } else {
        toast.error(result.data.error || 'Failed to sync emails');
      }
    } catch (error) {
      console.error('Sync error:', error);
      
      if (error.message?.includes('401') || error.message?.includes('token') || error.message?.includes('OAuth')) {
        toast.error('Authentication failed - try Demo Mode', {
          description: 'Click "Try Demo Mode" to see sample emails',
          action: {
            label: 'Try Demo Mode',
            onClick: () => handleSyncEmails(accountId, true)
          }
        });
      } else {
        toast.error('Failed to sync: ' + error.message);
      }
    } finally {
      setSyncingAccountId(null);
    }
  };

  const handleScheduleMeetingFromEmail = (message) => {
    const senderName = message.from_name || message.from_email;
    const senderEmail = message.from_email;
    
    setMeetingPreFill({
      clientName: senderName,
      clientEmail: senderEmail,
      title: `Meeting with ${senderName}`,
      notes: `Regarding: ${message.subject}\n\nOriginal message:\n${message.body_text?.substring(0, 200)}...`
    });
    setShowMeetingScheduler(true);
  };

  const handleProcessWithAI = async (messageId) => {
    setProcessingEmailId(messageId);
    try {
      const result = await processEmailWithAI({ email_message_id: messageId });
      
      if (result.data.success) {
        await queryClient.invalidateQueries({ queryKey: ['emailMessages'] });
        toast.success('‚ú® AI processed email successfully!');
      } else {
        toast.error('Failed to process: ' + result.data.error);
      }
    } catch (error) {
      toast.error('AI processing failed: ' + error.message);
    } finally {
      setProcessingEmailId(null);
    }
  };

  const handleReplyWithAI = (message) => {
    setReplyingTo(message);
    setShowReplyModal(true);
  };

  const handleRefresh = async () => {
    setIsRefreshing(true);
    await queryClient.invalidateQueries({ queryKey: ['emailMessages'] });
    await queryClient.invalidateQueries({ queryKey: ['messages'] });
    await queryClient.invalidateQueries({ queryKey: ['emailAccounts'] });
    toast.success('Messages refreshed!');
    setTimeout(() => setIsRefreshing(false), 1000);
  };

  // Auto-refresh every 5 minutes
  useEffect(() => {
    const interval = setInterval(() => {
      queryClient.invalidateQueries({ queryKey: ['emailMessages'] });
      queryClient.invalidateQueries({ queryKey: ['messages'] });
    }, 5 * 60 * 1000); // 5 minutes

    return () => clearInterval(interval);
  }, [queryClient]);

  const getProviderInfo = (provider) => {
    const providers = {
      gmail: {
        name: 'Gmail',
        icon: 'üìß',
        color: 'bg-red-500',
        instructions: 'Click "Connect Gmail" to authorize access to your Gmail account via Google OAuth.'
      },
      outlook: {
        name: 'Outlook',
        icon: 'üì®',
        color: 'bg-blue-500',
        instructions: 'Click "Connect Outlook" to authorize access to your Outlook/Hotmail account via Microsoft OAuth.'
      },
      yahoo: {
        name: 'Yahoo Mail',
        icon: 'üíå',
        color: 'bg-purple-500',
        instructions: 'Click "Connect Yahoo" to authorize access to your Yahoo Mail account.'
      },
      imap: {
        name: 'Custom IMAP',
        icon: '‚öôÔ∏è',
        color: 'bg-slate-500',
        instructions: 'Configure your email provider\'s IMAP/SMTP settings manually.'
      }
    };
    return providers[provider] || providers.imap;
  };

  const filteredMessages = React.useMemo(() => {
    let combinedMessages = [];

    const internalMessages = allMessages
      .filter(m => m && (m.sender_id === user?.id || m.recipient_id === user?.id))
      .map(m => ({
        id: `internal-${m.id}`,
        originalId: m.id,
        type: 'internal',
        date: new Date(m.created_date),
        sender_id: m.sender_id,
        recipient_id: m.recipient_id,
        sender_email: users.find(u => u.id === m.sender_id)?.email || m.sender_email,
        recipient_email: m.recipient_email,
        subject: m.subject,
        content: m.content,
        message_type: m.message_type,
        is_read: true,
        property_id: m.property_id,
        linked_property_id: m.property_id,
        ai_sentiment: m.ai_sentiment,
      }));

    const syncedMessages = emailMessages
      .filter(m => {
        const account = emailAccounts.find(a => a.id === m.email_account_id);
        return account && account.user_id === user?.id;
      })
      .map(m => ({
        id: `synced-${m.id}`,
        originalId: m.id,
        type: 'synced',
        date: new Date(m.received_date),
        from_email: m.from_email,
        from_name: m.from_name,
        to_email: m.to_email,
        to_name: m.to_name,
        subject: m.subject,
        body_text: m.body_text,
        body_html: m.body_html,
        content: m.body_text,
        is_read: m.is_read,
        ai_summary: m.ai_summary,
        ai_sentiment: m.ai_sentiment,
        ai_category: m.ai_category,
        ai_suggested_reply: m.ai_suggested_reply,
        ai_action_items: m.ai_action_items,
        ai_processed: m.ai_processed,
        linked_property_id: m.linked_property_id,
        linked_contact_id: m.linked_contact_id,
        linked_lead_id: m.linked_lead_id,
        suggested_properties: m.suggested_properties,
        suggested_contacts: m.suggested_contacts,
        suggested_leads: m.suggested_leads,
      }));

    combinedMessages = [...internalMessages, ...syncedMessages];

    let filtered = combinedMessages;

    if (messageTypeFilter === 'email') {
      filtered = filtered.filter(m => m.type === 'synced' || m.message_type === 'email');
    } else if (messageTypeFilter === 'internal') {
      filtered = filtered.filter(m => m.type === 'internal' && m.message_type === 'internal');
    } else if (messageTypeFilter === 'sms') {
      filtered = filtered.filter(m => m.message_type === 'sms');
    }

    if (categoryFilter !== 'all') {
      filtered = filtered.filter(m => m.ai_category === categoryFilter);
    }

    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(m => {
        const subjectMatch = m.subject?.toLowerCase().includes(query);
        const contentMatch = m.content?.toLowerCase().includes(query);
        const bodyTextMatch = m.body_text?.toLowerCase().includes(query);
        const aiSummaryMatch = m.ai_summary?.toLowerCase().includes(query);
        const recipientEmailMatch = m.recipient_email?.toLowerCase().includes(query);
        const toEmailMatch = m.to_email?.toLowerCase().includes(query);
        const fromEmailMatch = m.from_email?.toLowerCase().includes(query);

        return subjectMatch || contentMatch || bodyTextMatch || aiSummaryMatch || recipientEmailMatch || toEmailMatch || fromEmailMatch;
      });
    }

    return filtered.sort((a, b) => b.date.getTime() - a.date.getTime());
  }, [allMessages, emailMessages, emailAccounts, user, messageTypeFilter, categoryFilter, searchQuery, users]);

  const emailStats = React.useMemo(() => {
    const userInternalMessages = allMessages.filter(m => m.sender_id === user?.id || m.recipient_id === user?.id);
    const userSyncedEmails = emailMessages.filter(m => {
      const account = emailAccounts.find(a => a.id === m.email_account_id);
      return account && account.user_id === user?.id;
    });

    const sentCount = userInternalMessages.filter(m => m.sender_id === user?.id).length;
    const receivedCount = userInternalMessages.filter(m => m.recipient_id === user?.id).length + userSyncedEmails.length;
    const emailTypeCount = userInternalMessages.filter(m => m.message_type === 'email').length + userSyncedEmails.length;

    return {
      total: userInternalMessages.length + userSyncedEmails.length,
      sent: sentCount,
      received: receivedCount,
      email: emailTypeCount,
      internal: userInternalMessages.filter(m => m.message_type === 'internal').length,
      sms: userInternalMessages.filter(m => m.message_type === 'sms').length,
      synced: userSyncedEmails.length,
      unread: userSyncedEmails.filter(m => !m.is_read).length
    };
  }, [allMessages, emailMessages, emailAccounts, user]);

  const categoryCounts = React.useMemo(() => {
    // Combine all messages like in filteredMessages
    const internalMessages = allMessages
      .filter(m => m && (m.sender_id === user?.id || m.recipient_id === user?.id))
      .map(m => ({ ...m, ai_category: m.ai_category }));

    const syncedMessages = emailMessages
      .filter(m => {
        const account = emailAccounts.find(a => a.id === m.email_account_id);
        return account && account.user_id === user?.id;
      })
      .map(m => ({ ...m, ai_category: m.ai_category }));

    const combined = [...internalMessages, ...syncedMessages];

    return {
      all: combined.length,
      property_inquiry: combined.filter(m => m.ai_category === 'property_inquiry').length,
      showing_request: combined.filter(m => m.ai_category === 'showing_request').length,
      offer_negotiation: combined.filter(m => m.ai_category === 'offer_negotiation').length,
      document_request: combined.filter(m => m.ai_category === 'document_request').length,
      client_question: combined.filter(m => m.ai_category === 'client_question').length,
      transaction_update: combined.filter(m => m.ai_category === 'transaction_update').length,
      marketing: combined.filter(m => m.ai_category === 'marketing').length,
    };
  }, [allMessages, emailMessages, emailAccounts, user]);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  const primaryAccount = emailAccounts.find(acc => acc.is_primary);
  const activeAccounts = emailAccounts.filter(acc => acc.is_active);

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-3">
            <Mail className="w-8 h-8 text-indigo-600" />
            Email Integration
          </h1>
          <p className="text-slate-600 dark:text-slate-400">
            Connect your email accounts and manage all messages in one place
          </p>
        </div>

        {/* Success Banner - Show after syncing */}
        {emailMessages.length > 0 && activeTab === 'accounts' && (
          <Card className="mb-6 border-2 border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <CheckCircle2 className="w-6 h-6 text-green-600" />
                  <div>
                    <h3 className="font-bold text-green-900 dark:text-green-100 mb-1">
                      ‚úÖ {emailMessages.length} Emails Synced Successfully!
                    </h3>
                    <p className="text-sm text-green-700 dark:text-green-300">
                      Your emails are ready to view. Switch to the "All Messages" tab.
                    </p>
                  </div>
                </div>
                <Button
                  onClick={() => setActiveTab('messages')}
                  className="bg-green-600 hover:bg-green-700 text-white"
                >
                  <ArrowRight className="w-4 h-4 mr-2" />
                  View Messages
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {emailAccounts.length > 0 && emailAccounts.some(acc => acc.oauth_access_token?.startsWith('simulated_')) && (
          <Card className="mb-6 border-2 border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20">
            <CardContent className="p-4">
              <div className="flex items-start gap-3">
                <AlertCircle className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
                <div className="flex-1">
                  <h3 className="font-semibold text-amber-900 dark:text-amber-100 mb-1">
                    üîß OAuth Setup Required for Real Email Sync
                  </h3>
                  <p className="text-sm text-amber-800 dark:text-amber-200 mb-2">
                    To sync real emails from Gmail/Outlook, you need to set up OAuth credentials:
                  </p>
                  <ol className="text-xs text-amber-700 dark:text-amber-300 space-y-1 list-decimal list-inside ml-2">
                    <li>Set GMAIL_CLIENT_ID and GMAIL_CLIENT_SECRET in Environment Variables</li>
                    <li>Reconnect your email account with real OAuth</li>
                    <li>Or use <strong>"Demo Mode"</strong> to test with sample emails</li>
                  </ol>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="grid w-full grid-cols-2 mb-6">
            <TabsTrigger value="accounts" className="flex items-center gap-2">
              <Settings className="w-4 h-4" />
              Email Accounts
              <Badge variant="secondary">{emailAccounts.length}</Badge>
            </TabsTrigger>
            <TabsTrigger value="messages" className="flex items-center gap-2">
              <Inbox className="w-4 h-4" />
              All Messages
              <Badge variant="secondary">{emailStats.total}</Badge>
              {emailStats.unread > 0 && (
                <Badge className="bg-red-500 text-white ml-1">{emailStats.unread}</Badge>
              )}
            </TabsTrigger>
          </TabsList>

          <TabsContent value="accounts" className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <div className="text-3xl font-bold text-indigo-600">{emailAccounts.length}</div>
                    <div className="text-sm text-slate-500">Connected</div>
                  </div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <div className="text-3xl font-bold text-green-600">{activeAccounts.length}</div>
                    <div className="text-sm text-slate-500">Active</div>
                  </div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <div className="text-3xl font-bold text-purple-600">
                      {emailAccounts.filter(a => a.sync_enabled).length}
                    </div>
                    <div className="text-sm text-slate-500">Syncing</div>
                  </div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-amber-600">
                      {primaryAccount ? '‚úì' : '‚àí'}
                    </div>
                    <div className="text-sm text-slate-500">Primary Set</div>
                  </div>
                </CardContent>
              </Card>
            </div>

            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Zap className="w-5 h-5 text-indigo-600" />
                  Connect Your Email
                </CardTitle>
                <CardDescription>
                  One-click connection - no passwords needed!
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <Button
                    onClick={() => {
                      setEditingAccount({ 
                        provider: 'gmail',
                        imap_host: 'imap.gmail.com',
                        imap_port: 993,
                        smtp_host: 'smtp.gmail.com',
                        smtp_port: 587
                      });
                      setShowAddModal(true);
                    }}
                    className="w-full h-24 bg-gradient-to-br from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white"
                  >
                    <div className="text-center">
                      <div className="text-4xl mb-2">üìß</div>
                      <div className="font-semibold text-lg">Connect Gmail</div>
                      <div className="text-xs opacity-90">Uses App Password - Simple & Secure!</div>
                    </div>
                  </Button>

                  <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 rounded-lg">
                    <div className="flex items-start gap-3">
                      <Mail className="w-5 h-5 text-blue-600 mt-0.5" />
                      <div className="text-sm space-y-2">
                        <p className="font-semibold text-blue-900 dark:text-blue-100">Quick Setup Guide:</p>
                        <ol className="list-decimal list-inside space-y-1 text-blue-700 dark:text-blue-300">
                          <li>Go to <a href="https://myaccount.google.com/apppasswords" target="_blank" className="underline">myaccount.google.com/apppasswords</a></li>
                          <li>Create a new App Password for "Mail"</li>
                          <li>Copy the 16-character password</li>
                          <li>Click "Connect Gmail" above and paste it</li>
                        </ol>
                      </div>
                    </div>
                  </div>

                  <div className="relative">
                    <div className="absolute inset-0 flex items-center">
                      <div className="w-full border-t border-slate-300"></div>
                    </div>
                    <div className="relative flex justify-center text-sm">
                      <span className="px-2 bg-white text-slate-500">or test first</span>
                    </div>
                  </div>

                  <Button
                    variant="outline"
                    onClick={() => {
                      const demoAccount = {
                        provider: 'gmail',
                        email_address: user?.email || 'demo@example.com',
                        display_name: 'Demo Email Account',
                        imap_host: 'imap.gmail.com',
                        imap_port: 993,
                        smtp_host: 'smtp.gmail.com',
                        smtp_port: 587,
                        smtp_password: 'demo_mode_password',
                        oauth_access_token: 'simulated_demo_token',
                        sync_enabled: true,
                        is_active: true
                      };
                      createAccountMutation.mutate({ ...demoAccount, user_id: user.id });
                    }}
                    className="w-full"
                  >
                    <Mail className="w-4 h-4 mr-2" />
                    Try Demo Mode First
                  </Button>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <span className="flex items-center gap-2">
                    <Globe className="w-5 h-5 text-indigo-600" />
                    Connected Email Accounts
                  </span>
                  <div className="flex gap-2">
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={handleRefresh}
                      disabled={isRefreshing}
                      className="border-indigo-300 text-indigo-700 hover:bg-indigo-50"
                    >
                      <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                      Refresh
                    </Button>
                    <Button onClick={() => {
                      setEditingAccount(null);
                      setShowAddModal(true);
                    }} size="sm">
                      <Plus className="w-4 h-4 mr-2" />
                      Add Account
                    </Button>
                  </div>
                </CardTitle>
              </CardHeader>
              <CardContent>
                {emailAccounts.length === 0 ? (
                  <div className="text-center py-12">
                    <Mail className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                    <h3 className="text-lg font-semibold mb-2">No email accounts connected</h3>
                    <p className="text-slate-500 mb-4">
                      Connect your email to send and receive messages directly from RealtyMind
                    </p>
                    <Button onClick={() => setShowAddModal(true)}>
                      <Plus className="w-4 h-4 mr-2" />
                      Connect First Account
                    </Button>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {emailAccounts.map(account => {
                      const providerInfo = getProviderInfo(account.provider);
                      const accountMessages = emailMessages.filter(m => m.email_account_id === account.id);
                      const unreadCount = accountMessages.filter(m => !m.is_read).length;
                      const isDemoMode = account.oauth_access_token?.startsWith('simulated_');
                      
                      return (
                        <Card key={account.id} className="border-2">
                          <CardContent className="pt-6">
                            <div className="flex items-start justify-between">
                              <div className="flex items-start gap-4 flex-1">
                                <div className={`w-12 h-12 ${providerInfo.color} rounded-lg flex items-center justify-center text-2xl`}>
                                  {providerInfo.icon}
                                </div>
                                
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-1 flex-wrap">
                                    <h4 className="font-bold text-slate-900 dark:text-white">
                                      {account.display_name || account.email_address}
                                    </h4>
                                    {account.is_primary && (
                                      <Badge className="bg-amber-500 text-white">
                                        <Star className="w-3 h-3 mr-1" />
                                        Primary
                                      </Badge>
                                    )}
                                    {isDemoMode && (
                                      <Badge className="bg-purple-500 text-white">
                                        Demo Mode
                                      </Badge>
                                    )}
                                    <Badge variant={account.is_active ? "default" : "secondary"}>
                                      {account.is_active ? (
                                        <>
                                          <CheckCircle2 className="w-3 h-3 mr-1" />
                                          Active
                                        </>
                                      ) : (
                                        <>
                                          <X className="w-3 h-3 mr-1" />
                                          Inactive
                                        </>
                                      )}
                                    </Badge>
                                  </div>

                                  <p className="text-sm text-slate-600 dark:text-slate-400 mb-2">
                                    {account.email_address}
                                  </p>

                                  <div className="flex items-center gap-3 flex-wrap text-xs text-slate-500">
                                    <Badge variant="outline" className="text-xs">
                                      {providerInfo.name}
                                    </Badge>
                                    <Badge variant="outline" className="text-xs bg-blue-50 text-blue-700 dark:bg-blue-900/30">
                                      <Inbox className="w-3 h-3 mr-1" />
                                      {accountMessages.length} emails
                                    </Badge>
                                    {unreadCount > 0 && (
                                      <Badge className="bg-red-500 text-white text-xs">
                                        {unreadCount} unread
                                      </Badge>
                                    )}
                                    {account.sync_enabled && (
                                      <div className="flex items-center gap-1 text-green-600">
                                        <RefreshCw className="w-3 h-3" />
                                        Sync Enabled
                                      </div>
                                    )}
                                    {account.last_sync_date && (
                                      <div className="flex items-center gap-1">
                                        <Clock className="w-3 h-3" />
                                        Last synced {formatDistanceToNow(new Date(account.last_sync_date), { addSuffix: true })}
                                      </div>
                                    )}
                                  </div>

                                  {account.sync_error && (
                                    <div className="mt-2 p-2 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded text-xs text-amber-700 dark:text-amber-400">
                                      <AlertCircle className="w-3 h-3 inline mr-1" />
                                      {account.sync_error}
                                    </div>
                                  )}
                                </div>
                              </div>

                              <div className="flex flex-col gap-2">
                                <div className="flex gap-1">
                                  <Button
                                    size="sm"
                                    onClick={() => handleSyncEmails(account.id, false)}
                                    disabled={syncingAccountId === account.id}
                                    className="bg-green-600 hover:bg-green-700 text-white flex-1"
                                  >
                                    {syncingAccountId === account.id ? (
                                      <>
                                        <Loader2 className="w-4 h-4 mr-1 animate-spin" />
                                        Syncing...
                                      </>
                                    ) : (
                                      <>
                                        <RefreshCw className="w-4 h-4 mr-1" />
                                        Sync
                                      </>
                                    )}
                                  </Button>
                                  {isDemoMode && (
                                    <Button
                                      size="sm"
                                      onClick={() => handleSyncEmails(account.id, true)}
                                      disabled={syncingAccountId === account.id}
                                      variant="outline"
                                      className="border-purple-300 text-purple-600 hover:bg-purple-50"
                                      title="Generate demo emails for testing"
                                    >
                                      Demo
                                    </Button>
                                  )}
                                </div>

                                {!account.is_primary && (
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    onClick={() => handleSetPrimary(account.id)}
                                  >
                                    <Star className="w-4 h-4 mr-1" />
                                    Set Primary
                                  </Button>
                                )}
                                
                                <div className="flex items-center gap-2">
                                  <Label className="text-xs">Active</Label>
                                  <Switch
                                    checked={account.is_active}
                                    onCheckedChange={() => handleToggleActive(account)}
                                  />
                                </div>

                                <div className="flex items-center gap-2">
                                  <Label className="text-xs">Auto-Sync</Label>
                                  <Switch
                                    checked={account.sync_enabled}
                                    onCheckedChange={() => handleToggleSync(account)}
                                  />
                                </div>

                                <Button
                                  size="sm"
                                  variant="ghost"
                                  onClick={() => {
                                    setEditingAccount(account);
                                    setShowAddModal(true);
                                  }}
                                >
                                  <Settings className="w-4 h-4" />
                                </Button>

                                <Button
                                  size="sm"
                                  variant="ghost"
                                  onClick={() => setShowDeleteConfirm(account)}
                                  className="text-red-600 hover:text-red-700"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </Button>
                              </div>
                            </div>
                          </CardContent>
                        </Card>
                      );
                    })}
                  </div>
                )}
              </CardContent>
            </Card>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <Card className="border-2 border-blue-200 dark:border-blue-800">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2 text-blue-700 dark:text-blue-400">
                    <Shield className="w-5 h-5" />
                    Secure & Private
                  </CardTitle>
                </CardHeader>
                <CardContent className="text-sm text-slate-600 dark:text-slate-400 space-y-2">
                  <p>‚úì OAuth authentication (no passwords stored)</p>
                  <p>‚úì Encrypted token storage</p>
                  <p>‚úì Read-only access for syncing</p>
                  <p>‚úì Revoke access anytime</p>
                </CardContent>
              </Card>

              <Card className="border-2 border-purple-200 dark:border-purple-800">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2 text-purple-700 dark:text-purple-400">
                    <Zap className="w-5 h-5" />
                    Features
                  </CardTitle>
                </CardHeader>
                <CardContent className="text-sm text-slate-600 dark:text-slate-400 space-y-2">
                  <p>‚úì Send emails from your own address</p>
                  <p>‚úì Automatic email syncing (optional)</p>
                  <p>‚úì Custom signatures</p>
                  <p>‚úì Thread management</p>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          <TabsContent value="messages">
            <div className="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
              <Card>
                <CardContent className="pt-6 text-center">
                  <div className="text-2xl font-bold text-indigo-600">{emailStats.total}</div>
                  <div className="text-xs text-slate-500">Total</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6 text-center">
                  <div className="text-2xl font-bold text-blue-600">{emailStats.synced}</div>
                  <div className="text-xs text-slate-500">Synced Emails</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6 text-center">
                  <div className="text-2xl font-bold text-red-600">{emailStats.unread}</div>
                  <div className="text-xs text-slate-500">Unread</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6 text-center">
                  <div className="text-2xl font-bold text-green-600">{emailStats.sent}</div>
                  <div className="text-xs text-slate-500">Sent</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6 text-center">
                  <div className="text-2xl font-bold text-purple-600">{emailStats.internal}</div>
                  <div className="text-xs text-slate-500">Internal</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6 text-center">
                  <div className="text-2xl font-bold text-orange-600">{emailStats.email}</div>
                  <div className="text-xs text-slate-500">Email Total</div>
                </CardContent>
              </Card>
            </div>

            <Card className="mb-6">
              <CardContent className="pt-6">
                <div className="space-y-4">
                  <div className="flex flex-col sm:flex-row gap-4">
                    <div className="flex-1 relative">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                      <Input
                        placeholder="Search messages..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="pl-10"
                      />
                    </div>
                    <div className="flex gap-2">
                      {selectedMessageIds.size > 0 && (
                        <Button
                          variant="destructive"
                          size="sm"
                          onClick={() => {
                            if (confirm(`Delete ${selectedMessageIds.size} selected message${selectedMessageIds.size > 1 ? 's' : ''}?`)) {
                              deleteMessagesMutation.mutate(selectedMessageIds);
                            }
                          }}
                        >
                          <Trash2 className="w-4 h-4 mr-1" />
                          Delete ({selectedMessageIds.size})
                        </Button>
                      )}
                      <Button
                        variant={messageTypeFilter === 'all' ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => setMessageTypeFilter('all')}
                      >
                        All
                      </Button>
                      <Button
                        variant={messageTypeFilter === 'email' ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => setMessageTypeFilter('email')}
                        className={messageTypeFilter === 'email' ? 'bg-red-600 hover:bg-red-700' : ''}
                      >
                        <Mail className="w-4 h-4 mr-1" />
                        Email
                      </Button>
                      <Button
                        variant={messageTypeFilter === 'internal' ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => setMessageTypeFilter('internal')}
                        className={messageTypeFilter === 'internal' ? 'bg-indigo-600 hover:bg-indigo-700' : ''}
                      >
                        <Send className="w-4 h-4 mr-1" />
                        Internal
                      </Button>
                      <Button
                        variant={messageTypeFilter === 'sms' ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => setMessageTypeFilter('sms')}
                        className={messageTypeFilter === 'sms' ? 'bg-purple-600 hover:bg-purple-700' : ''}
                      >
                        SMS
                      </Button>
                    </div>
                  </div>

                  {/* Category Filter Buttons */}
                  <div className="flex flex-wrap gap-2">
                    <Button
                      variant={categoryFilter === 'all' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setCategoryFilter('all')}
                      className={categoryFilter === 'all' ? 'bg-slate-700 hover:bg-slate-800 text-white' : 'border-slate-300 text-slate-700 hover:bg-slate-50'}
                    >
                      <Inbox className="w-3.5 h-3.5 mr-1" />
                      All
                      <Badge variant={categoryFilter === 'all' ? 'secondary' : 'outline'} className="ml-1.5">
                        {categoryCounts.all}
                      </Badge>
                    </Button>
                    
                    <Button
                      variant={categoryFilter === 'property_inquiry' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setCategoryFilter('property_inquiry')}
                      className={categoryFilter === 'property_inquiry' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'border-blue-300 text-blue-700 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/20'}
                    >
                      <Building2 className="w-3.5 h-3.5 mr-1" />
                      Property Inquiries
                      <Badge variant={categoryFilter === 'property_inquiry' ? 'secondary' : 'outline'} className="ml-1.5">
                        {categoryCounts.property_inquiry}
                      </Badge>
                    </Button>

                    <Button
                      variant={categoryFilter === 'showing_request' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setCategoryFilter('showing_request')}
                      className={categoryFilter === 'showing_request' ? 'bg-green-600 hover:bg-green-700 text-white' : 'border-green-300 text-green-700 hover:bg-green-50 dark:text-green-400 dark:hover:bg-green-900/20'}
                    >
                      <CalendarIcon className="w-3.5 h-3.5 mr-1" />
                      Showings
                      <Badge variant={categoryFilter === 'showing_request' ? 'secondary' : 'outline'} className="ml-1.5">
                        {categoryCounts.showing_request}
                      </Badge>
                    </Button>

                    <Button
                      variant={categoryFilter === 'offer_negotiation' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setCategoryFilter('offer_negotiation')}
                      className={categoryFilter === 'offer_negotiation' ? 'bg-amber-600 hover:bg-amber-700 text-white' : 'border-amber-300 text-amber-700 hover:bg-amber-50 dark:text-amber-400 dark:hover:bg-amber-900/20'}
                    >
                      <Target className="w-3.5 h-3.5 mr-1" />
                      Offers
                      <Badge variant={categoryFilter === 'offer_negotiation' ? 'secondary' : 'outline'} className="ml-1.5">
                        {categoryCounts.offer_negotiation}
                      </Badge>
                    </Button>

                    <Button
                      variant={categoryFilter === 'document_request' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setCategoryFilter('document_request')}
                      className={categoryFilter === 'document_request' ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'border-purple-300 text-purple-700 hover:bg-purple-50 dark:text-purple-400 dark:hover:bg-purple-900/20'}
                    >
                      <FileText className="w-3.5 h-3.5 mr-1" />
                      Documents
                      <Badge variant={categoryFilter === 'document_request' ? 'secondary' : 'outline'} className="ml-1.5">
                        {categoryCounts.document_request}
                      </Badge>
                    </Button>

                    <Button
                      variant={categoryFilter === 'client_question' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setCategoryFilter('client_question')}
                      className={categoryFilter === 'client_question' ? 'bg-indigo-600 hover:bg-indigo-700 text-white' : 'border-indigo-300 text-indigo-700 hover:bg-indigo-50 dark:text-indigo-400 dark:hover:bg-indigo-900/20'}
                    >
                      <AlertCircle className="w-3.5 h-3.5 mr-1" />
                      Questions
                      <Badge variant={categoryFilter === 'client_question' ? 'secondary' : 'outline'} className="ml-1.5">
                        {categoryCounts.client_question}
                      </Badge>
                    </Button>

                    <Button
                      variant={categoryFilter === 'transaction_update' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setCategoryFilter('transaction_update')}
                      className={categoryFilter === 'transaction_update' ? 'bg-teal-600 hover:bg-teal-700 text-white' : 'border-teal-300 text-teal-700 hover:bg-teal-50 dark:text-teal-400 dark:hover:bg-teal-900/20'}
                    >
                      <CheckCircle2 className="w-3.5 h-3.5 mr-1" />
                      Transactions
                      <Badge variant={categoryFilter === 'transaction_update' ? 'secondary' : 'outline'} className="ml-1.5">
                        {categoryCounts.transaction_update}
                      </Badge>
                    </Button>

                    <Button
                      variant={categoryFilter === 'marketing' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setCategoryFilter('marketing')}
                      className={categoryFilter === 'marketing' ? 'bg-pink-600 hover:bg-pink-700 text-white' : 'border-pink-300 text-pink-700 hover:bg-pink-50 dark:text-pink-400 dark:hover:bg-pink-900/20'}
                    >
                      <Sparkles className="w-3.5 h-3.5 mr-1" />
                      Marketing
                      <Badge variant={categoryFilter === 'marketing' ? 'secondary' : 'outline'} className="ml-1.5">
                        {categoryCounts.marketing}
                      </Badge>
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Inbox className="w-5 h-5 text-indigo-600" />
                    Message History
                    <Badge variant="secondary">{filteredMessages.length}</Badge>
                    {emailStats.unread > 0 && (
                      <Badge className="bg-red-500 text-white">{emailStats.unread} unread</Badge>
                    )}
                  </div>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={handleRefresh}
                    disabled={isRefreshing}
                    className="border-indigo-300 text-indigo-700 hover:bg-indigo-50"
                  >
                    <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                    Refresh
                  </Button>
                </CardTitle>
              </CardHeader>
              <CardContent>
                {filteredMessages.length === 0 ? (
                  <div className="text-center py-12">
                    <Mail className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                    <h3 className="text-lg font-semibold mb-2">No messages found</h3>
                    <p className="text-slate-500">
                      {searchQuery || messageTypeFilter !== 'all' 
                        ? 'Try adjusting your filters'
                        : 'Connect an email account and click "Sync Now" to view your emails here'}
                    </p>
                  </div>
                ) : (
                  <div className="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-white dark:bg-slate-900">
                   {/* Gmail-style toolbar */}
                   {filteredMessages.length > 0 && (
                     <div className="flex items-center gap-3 px-4 py-2 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
                       <input
                         type="checkbox"
                         checked={selectedMessageIds.size === filteredMessages.length && filteredMessages.length > 0}
                         onChange={(e) => {
                           if (e.target.checked) {
                             setSelectedMessageIds(new Set(filteredMessages.map(m => m.id)));
                           } else {
                             setSelectedMessageIds(new Set());
                           }
                         }}
                         className="w-4 h-4 rounded border-slate-300 cursor-pointer"
                       />
                       {selectedMessageIds.size > 0 ? (
                         <>
                           <Button
                             size="sm"
                             variant="ghost"
                             onClick={() => {
                               if (confirm(`Delete ${selectedMessageIds.size} selected message${selectedMessageIds.size > 1 ? 's' : ''}?`)) {
                                 deleteMessagesMutation.mutate(selectedMessageIds);
                               }
                             }}
                             className="h-8"
                           >
                             <Trash2 className="w-4 h-4 mr-1" />
                             Delete
                           </Button>
                           <span className="text-sm text-slate-600 dark:text-slate-400">
                             {selectedMessageIds.size} selected
                           </span>
                         </>
                       ) : (
                         <span className="text-sm text-slate-600 dark:text-slate-400">
                           {filteredMessages.length} message{filteredMessages.length !== 1 ? 's' : ''}
                         </span>
                       )}
                     </div>
                   )}

                   {/* Gmail-style message list */}
                   <div className="divide-y divide-slate-200 dark:divide-slate-700">
                   {filteredMessages.map(message => {
                      const isSyncedEmail = message.type === 'synced';
                      const isSentInternal = !isSyncedEmail && message.sender_id === user?.id;

                      let senderRecipientDisplay, avatarIcon, avatarBgClass;

                      if (isSyncedEmail) {
                        senderRecipientDisplay = `From: ${message.from_name || message.from_email || 'Unknown'}`;
                        avatarIcon = <Mail className="w-5 h-5" />;
                        avatarBgClass = 'bg-blue-600 text-white';
                      } else {
                        const senderUser = users.find(u => u.id === message.sender_id);
                        const recipientUser = users.find(u => u.id === message.recipient_id);

                        if (isSentInternal) {
                          senderRecipientDisplay = `To: ${recipientUser?.full_name || message.recipient_email || 'Unknown'}`;
                          avatarIcon = <Send className="w-5 h-5" />;
                          avatarBgClass = 'bg-indigo-600 text-white';
                        } else {
                          senderRecipientDisplay = `From: ${senderUser?.full_name || senderUser?.email || 'Unknown'}`;
                          avatarIcon = <Inbox className="w-5 h-5" />;
                          avatarBgClass = 'bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300';
                        }
                      }

                      const property = properties.find(p => p.id === message.linked_property_id);

                      const messageTypeColors = isSyncedEmail 
                        ? 'border-blue-200 bg-blue-50 dark:bg-blue-900/10 dark:border-blue-800'
                        : {
                            email: 'border-red-200 bg-red-50 dark:bg-red-900/10 dark:border-red-800',
                            internal: 'border-indigo-200 bg-indigo-50 dark:bg-indigo-900/10 dark:border-indigo-800',
                            sms: 'border-purple-200 bg-purple-50 dark:bg-purple-900/10 dark:border-purple-800'
                          }[message.message_type] || '';

                      return (
                        <div
                          key={message.id}
                          className={`flex items-center gap-3 px-4 py-3 cursor-pointer transition-colors ${
                            selectedMessageIds.has(message.id) 
                              ? 'bg-blue-50 dark:bg-blue-900/20' 
                              : 'hover:bg-slate-50 dark:hover:bg-slate-800'
                          } ${!message.is_read ? 'bg-slate-50 dark:bg-slate-800/50' : ''}`}
                          onClick={() => setSelectedMessage(message)}
                        >
                          {/* Checkbox */}
                          <input
                            type="checkbox"
                            checked={selectedMessageIds.has(message.id)}
                            onChange={(e) => {
                              e.stopPropagation();
                              const newSelected = new Set(selectedMessageIds);
                              if (e.target.checked) {
                                newSelected.add(message.id);
                              } else {
                                newSelected.delete(message.id);
                              }
                              setSelectedMessageIds(newSelected);
                            }}
                            className="w-4 h-4 rounded border-slate-300 cursor-pointer flex-shrink-0"
                            onClick={(e) => e.stopPropagation()}
                          />

                          {/* Star icon placeholder */}
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              toast.info('Star feature coming soon!');
                            }}
                            className="flex-shrink-0 text-slate-400 hover:text-yellow-500 transition-colors"
                          >
                            <Star className="w-4 h-4" />
                          </button>

                          {/* Sender/Recipient name */}
                          <div className={`w-48 flex-shrink-0 truncate ${!message.is_read ? 'font-bold' : 'font-normal'}`}>
                            <span className="text-sm text-slate-900 dark:text-white">
                              {isSyncedEmail 
                                ? (message.from_name || message.from_email || 'Unknown')
                                : (isSentInternal 
                                    ? (users.find(u => u.id === message.recipient_id)?.full_name || message.recipient_email || 'Unknown')
                                    : (users.find(u => u.id === message.sender_id)?.full_name || 'Unknown')
                                  )}
                            </span>
                          </div>

                          {/* Subject and preview */}
                          <div className="flex-1 min-w-0 flex items-baseline gap-2">
                            <span className={`text-sm truncate ${!message.is_read ? 'font-bold text-slate-900 dark:text-white' : 'font-normal text-slate-700 dark:text-slate-300'}`}>
                              {message.subject || '(No Subject)'}
                            </span>
                            <span className="text-sm text-slate-500 dark:text-slate-400 truncate flex-shrink">
                              ‚Äî {(message.content || message.body_text || message.ai_summary || '').substring(0, 100)}
                            </span>
                          </div>

                          {/* Badges and date */}
                          <div className="flex items-center gap-2 flex-shrink-0">
                          {message.ai_category && (
                            <Badge variant="outline" className={`text-xs ${
                              message.ai_category === 'property_inquiry' ? 'bg-blue-50 text-blue-700 border-blue-300 dark:bg-blue-900/20 dark:text-blue-400' :
                              message.ai_category === 'showing_request' ? 'bg-green-50 text-green-700 border-green-300 dark:bg-green-900/20 dark:text-green-400' :
                              message.ai_category === 'offer_negotiation' ? 'bg-amber-50 text-amber-700 border-amber-300 dark:bg-amber-900/20 dark:text-amber-400' :
                              message.ai_category === 'document_request' ? 'bg-purple-50 text-purple-700 border-purple-300 dark:bg-purple-900/20 dark:text-purple-400' :
                              message.ai_category === 'client_question' ? 'bg-indigo-50 text-indigo-700 border-indigo-300 dark:bg-indigo-900/20 dark:text-indigo-400' :
                              message.ai_category === 'transaction_update' ? 'bg-teal-50 text-teal-700 border-teal-300 dark:bg-teal-900/20 dark:text-teal-400' :
                              message.ai_category === 'marketing' ? 'bg-pink-50 text-pink-700 border-pink-300 dark:bg-pink-900/20 dark:text-pink-400' :
                              'bg-slate-50 text-slate-700 border-slate-300 dark:bg-slate-800 dark:text-slate-400'
                            }`}>
                              {message.ai_category.replace(/_/g, ' ')}
                            </Badge>
                          )}
                          {property && (
                            <Badge variant="outline" className="text-xs flex items-center gap-1 bg-blue-50 text-blue-700 border-blue-300">
                              <Building2 className="w-3 h-3" />
                            </Badge>
                          )}
                           {message.ai_sentiment && (
                             <Badge variant="outline" className={`text-xs ${
                               message.ai_sentiment === 'urgent' ? 'bg-red-100 text-red-700 border-red-300' :
                               message.ai_sentiment === 'positive' ? 'bg-green-100 text-green-700 border-green-300' :
                               message.ai_sentiment === 'negative' ? 'bg-amber-100 text-amber-700 border-amber-300' :
                               'bg-slate-100 text-slate-700'
                             }`}>
                               {message.ai_sentiment.charAt(0).toUpperCase()}
                             </Badge>
                           )}
                           <span className="text-xs text-slate-500 dark:text-slate-400 whitespace-nowrap">
                             {format(message.date, 'MMM d')}
                           </span>
                          </div>
                        </div>
                      );
                    })}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>

      {selectedMessage && (
        <MessageDetailModal
          message={selectedMessage}
          users={users}
          properties={properties}
          currentUser={user}
          onClose={() => setSelectedMessage(null)}
          onScheduleMeeting={handleScheduleMeetingFromEmail}
          processingEmailId={processingEmailId}
          onProcessWithAI={handleProcessWithAI}
          onReplyWithAI={handleReplyWithAI}
        />
      )}

      {showAddModal && (
        <EmailAccountModal
          account={editingAccount}
          onSave={(accountData) => {
            if (editingAccount?.id) {
              updateAccountMutation.mutate({ id: editingAccount.id, data: accountData });
            } else {
              createAccountMutation.mutate({ ...accountData, user_id: user.id });
            }
          }}
          onClose={() => {
            setShowAddModal(false);
            setEditingAccount(null);
          }}
        />
      )}

      {showDeleteConfirm && (
        <Dialog open={true} onOpenChange={() => setShowDeleteConfirm(null)}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Remove Email Account</DialogTitle>
              <DialogDescription>
                Are you sure you want to remove {showDeleteConfirm.email_address}? This will stop email syncing and sending from this account.
              </DialogDescription>
            </DialogHeader>
            <div className="flex justify-end gap-3 mt-4">
              <Button variant="outline" onClick={() => setShowDeleteConfirm(null)}>
                Cancel
              </Button>
              <Button
                variant="destructive"
                onClick={() => deleteAccountMutation.mutate(showDeleteConfirm.id)}
              >
                Remove Account
              </Button>
            </div>
          </DialogContent>
        </Dialog>
      )}

      {showMeetingScheduler && (
        <MeetingScheduler
          isOpen={showMeetingScheduler}
          onClose={() => {
            setShowMeetingScheduler(false);
            setMeetingPreFill({});
          }}
          preFilledData={meetingPreFill}
          onMeetingCreated={() => {
            queryClient.invalidateQueries({ queryKey: ['appointments'] });
            toast.success('Meeting scheduled successfully!');
          }}
        />
      )}

      {showReplyModal && replyingTo && (
        <EmailComposeModal
          recipient={replyingTo.from_email || replyingTo.sender_email}
          property={properties.find(p => p.id === replyingTo.linked_property_id)}
          onClose={() => {
            setShowReplyModal(false);
            setReplyingTo(null);
          }}
          prefilledSubject={`Re: ${replyingTo.subject || ''}`}
          prefilledBody={replyingTo.ai_suggested_reply || ''}
        />
      )}
    </div>
  );
}

function MessageDetailModal({ message, users, properties, currentUser, onClose, onScheduleMeeting, processingEmailId, onProcessWithAI, onReplyWithAI }) {
  const queryClient = useQueryClient();
  const [showLinkSuggestions, setShowLinkSuggestions] = useState(false);
  const [isRecategorizing, setIsRecategorizing] = useState(false);
  const isSyncedEmail = message.type === 'synced';
  const isInternalMessage = message.type === 'internal';

  const { data: contacts = [] } = useQuery({
    queryKey: ['contacts'],
    queryFn: () => base44.entities.Contact.list(),
    initialData: []
  });

  const { data: leads = [] } = useQuery({
    queryKey: ['leads'],
    queryFn: () => base44.entities.Lead.list(),
    initialData: []
  });

  const linkEntityMutation = useMutation({
    mutationFn: ({ entity_type, entity_id }) => {
      return base44.entities.EmailMessage.update(message.originalId, {
        [`linked_${entity_type}_id`]: entity_id
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['emailMessages'] });
      toast.success('Link updated!');
    }
  });

  const recategorizeMutation = useMutation({
    mutationFn: (newCategory) => {
      return base44.entities.EmailMessage.update(message.originalId, {
        ai_category: newCategory
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['emailMessages'] });
      toast.success('Category updated! System will learn from this.');
      setIsRecategorizing(false);
    }
  });

  let senderInfo, recipientInfo, messageTypeDisplay, contentDisplay, subjectDisplay;
  let property;

  if (isSyncedEmail) {
    senderInfo = {
      name: message.from_name || message.from_email || 'Unknown',
      email: message.from_email
    };
    recipientInfo = {
      name: message.to_name || message.to_email || 'Unknown',
      email: message.to_email
    };
    messageTypeDisplay = 'Synced Email';
    subjectDisplay = message.subject;
    // Handle body_text that might be an object or string
    contentDisplay = typeof message.body_text === 'object' 
      ? JSON.stringify(message.body_text, null, 2) 
      : (message.body_text || '(No content available)');
    property = properties.find(p => p.id === message.linked_property_id);
  } else if (isInternalMessage) {
    const senderUser = users.find(u => u.id === message.sender_id);
    const recipientUser = users.find(u => u.id === message.recipient_id);
    senderInfo = {
      name: senderUser?.full_name || senderUser?.email || 'Unknown',
      email: senderUser?.email
    };
    recipientInfo = {
      name: recipientUser?.full_name || message.recipient_email || 'Unknown',
      email: recipientUser?.email || message.recipient_email
    };
    messageTypeDisplay = message.message_type || 'internal';
    subjectDisplay = message.subject;
    contentDisplay = message.content || '(No content available)';
    property = properties.find(p => p.id === message.property_id);
  }

  const headerIcon = isSyncedEmail ? <Mail className="w-5 h-5 text-blue-600" /> : (message.sender_id === currentUser?.id ? <Send className="w-5 h-5 text-indigo-600" /> : <Inbox className="w-5 h-5 text-blue-600" />);
  const badgeIcon = isSyncedEmail ? <Mail className="w-3 h-3 mr-1" /> : (message.sender_id === currentUser?.id ? <Send className="w-3 h-3 mr-1" /> : <Inbox className="w-3 h-3 mr-1" />);


  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-5xl max-h-[95vh] overflow-hidden p-0">
        {/* Gmail-style header */}
        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3">
            <Button
              variant="ghost"
              size="sm"
              onClick={onClose}
              className="h-8 w-8 p-0"
            >
              <ArrowRight className="w-4 h-4 rotate-180" />
            </Button>
            <h2 className="text-xl font-normal text-slate-900 dark:text-white truncate max-w-md">
              {subjectDisplay || '(No Subject)'}
            </h2>
          </div>
          
          <div className="flex items-center gap-2">
            {message.ai_processed && message.ai_suggested_reply && (
              <Badge className="bg-green-100 text-green-700 border-green-300 flex items-center gap-1">
                <Sparkles className="w-3 h-3" />
                AI Analyzed
              </Badge>
            )}
            {message.type === 'synced' && message.from_email && (
              <Button
                size="sm"
                onClick={() => {
                  onScheduleMeeting(message);
                  onClose();
                }}
                className="bg-blue-600 hover:bg-blue-700"
              >
                <CalendarIcon className="w-4 h-4 mr-2" />
                Schedule
              </Button>
            )}
            <Button size="sm" variant="ghost" onClick={onClose}>
              <X className="w-4 h-4" />
            </Button>
          </div>
        </div>

        <div className="overflow-y-auto max-h-[calc(95vh-80px)]">
          {/* Gmail-style message header */}
          <div className="px-6 py-4 space-y-4">
            {/* Sender info */}
            <div className="flex items-start justify-between">
              <div className="flex items-start gap-3">
                <Avatar className="w-10 h-10 flex-shrink-0">
                  <AvatarFallback className="bg-blue-600 text-white">
                    {senderInfo.name?.charAt(0)?.toUpperCase() || 'U'}
                  </AvatarFallback>
                </Avatar>
                <div className="flex-1 min-w-0">
                  <div className="flex items-baseline gap-2 mb-1">
                    <span className="font-semibold text-slate-900 dark:text-white">
                      {senderInfo.name}
                    </span>
                    {message.ai_sentiment && (
                      <Badge variant="outline" className={`text-xs ${
                        message.ai_sentiment === 'urgent' ? 'bg-red-100 text-red-700 border-red-300' :
                        message.ai_sentiment === 'positive' ? 'bg-green-100 text-green-700 border-green-300' :
                        message.ai_sentiment === 'negative' ? 'bg-amber-100 text-amber-700 border-amber-300' :
                        'bg-slate-100 text-slate-700'
                      }`}>
                        {message.ai_sentiment}
                      </Badge>
                    )}
                  </div>
                  <div className="text-sm text-slate-600 dark:text-slate-400">
                    <span>to {recipientInfo.name}</span>
                  </div>
                  {senderInfo.email && (
                    <div className="text-xs text-slate-500 mt-1">
                      {senderInfo.email}
                    </div>
                  )}
                </div>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400 text-right">
                {format(new Date(message.date), 'MMM d, yyyy, h:mm a')}
              </div>
            </div>

            {/* Linked Entities */}
            {(message.linked_property_id || message.linked_contact_id || message.linked_lead_id || 
              (message.suggested_properties && JSON.parse(message.suggested_properties || '[]').length > 0) ||
              (message.suggested_contacts && JSON.parse(message.suggested_contacts || '[]').length > 0)) && (
              <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 border-indigo-200 dark:border-indigo-800">
                <CardHeader className="pb-3">
                  <CardTitle className="text-sm flex items-center justify-between">
                    <span className="flex items-center gap-2">
                      <Sparkles className="w-4 h-4 text-indigo-600" />
                      Smart Links
                    </span>
                    {message.ai_processed && (
                      <Button
                        size="sm"
                        variant="ghost"
                        onClick={() => setShowLinkSuggestions(!showLinkSuggestions)}
                        className="h-7 text-xs"
                      >
                        {showLinkSuggestions ? 'Hide' : 'Show'} Suggestions
                      </Button>
                    )}
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  {/* Confirmed Links */}
                  {property && (
                    <a 
                      href={`#/PropertyDetail?id=${property.id}`}
                      className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-lg border border-blue-300 dark:border-blue-700 hover:shadow-md transition-all group"
                    >
                      <Building2 className="w-5 h-5 text-blue-600 flex-shrink-0" />
                      <div className="flex-1 min-w-0">
                        <p className="font-semibold text-sm text-blue-900 dark:text-blue-300">{property.address}</p>
                        <p className="text-xs text-slate-600 dark:text-slate-400">{property.city}, {property.state}</p>
                      </div>
                      <Badge className="bg-green-600 text-white">Linked</Badge>
                      <ArrowRight className="w-4 h-4 text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" />
                    </a>
                  )}

                  {message.linked_contact_id && (() => {
                    const contact = contacts.find(c => c.id === message.linked_contact_id);
                    return contact && (
                      <a 
                        href={`#/ContactDetail?id=${contact.id}`}
                        className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-lg border border-purple-300 dark:border-purple-700 hover:shadow-md transition-all group"
                      >
                        <User className="w-5 h-5 text-purple-600 flex-shrink-0" />
                        <div className="flex-1 min-w-0">
                          <p className="font-semibold text-sm text-purple-900 dark:text-purple-300">{contact.name}</p>
                          <p className="text-xs text-slate-600 dark:text-slate-400">{contact.email}</p>
                        </div>
                        <Badge className="bg-green-600 text-white">Linked</Badge>
                        <ArrowRight className="w-4 h-4 text-purple-600 opacity-0 group-hover:opacity-100 transition-opacity" />
                      </a>
                    );
                  })()}

                  {message.linked_lead_id && (() => {
                    const lead = leads.find(l => l.id === message.linked_lead_id);
                    return lead && (
                      <a 
                        href={`#/Leads?leadId=${lead.id}`}
                        className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-lg border border-amber-300 dark:border-amber-700 hover:shadow-md transition-all group"
                      >
                        <Target className="w-5 h-5 text-amber-600 flex-shrink-0" />
                        <div className="flex-1 min-w-0">
                          <p className="font-semibold text-sm text-amber-900 dark:text-amber-300">{lead.name}</p>
                          <p className="text-xs text-slate-600 dark:text-slate-400">{lead.email}</p>
                        </div>
                        <Badge className="bg-green-600 text-white">Linked</Badge>
                        <ArrowRight className="w-4 h-4 text-amber-600 opacity-0 group-hover:opacity-100 transition-opacity" />
                      </a>
                    );
                  })()}

                  {/* AI Suggested Links */}
                  {showLinkSuggestions && message.suggested_properties && JSON.parse(message.suggested_properties || '[]').length > 0 && (
                    <div className="space-y-2 pt-2 border-t border-indigo-200 dark:border-indigo-700">
                      <p className="text-xs font-semibold text-indigo-700 dark:text-indigo-300">Suggested Properties:</p>
                      {JSON.parse(message.suggested_properties).slice(0, 3).map((suggestion, idx) => {
                        const suggestedProp = properties.find(p => p.id === suggestion.id);
                        if (!suggestedProp) return null;
                        const isAlreadyLinked = message.linked_property_id === suggestion.id;
                        
                        return (
                          <div key={idx} className="flex items-center gap-2 p-2 bg-white/50 dark:bg-slate-800/50 rounded border border-indigo-100 dark:border-indigo-800">
                            <Building2 className="w-4 h-4 text-indigo-600 flex-shrink-0" />
                            <div className="flex-1 min-w-0">
                              <p className="text-xs font-medium truncate">{suggestedProp.address}</p>
                              <p className="text-[10px] text-slate-500">{suggestion.reason}</p>
                            </div>
                            <Badge variant="outline" className="text-[10px]">{suggestion.confidence_score}% match</Badge>
                            {!isAlreadyLinked && (
                              <Button
                                size="sm"
                                onClick={() => linkEntityMutation.mutate({ entity_type: 'property', entity_id: suggestion.id })}
                                className="h-6 text-xs bg-indigo-600 hover:bg-indigo-700"
                              >
                                Link
                              </Button>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {showLinkSuggestions && message.suggested_contacts && JSON.parse(message.suggested_contacts || '[]').length > 0 && (
                    <div className="space-y-2 pt-2 border-t border-purple-200 dark:border-purple-700">
                      <p className="text-xs font-semibold text-purple-700 dark:text-purple-300">Suggested Contacts:</p>
                      {JSON.parse(message.suggested_contacts).slice(0, 3).map((suggestion, idx) => {
                        const suggestedContact = contacts.find(c => c.id === suggestion.id);
                        if (!suggestedContact) return null;
                        const isAlreadyLinked = message.linked_contact_id === suggestion.id;
                        
                        return (
                          <div key={idx} className="flex items-center gap-2 p-2 bg-white/50 dark:bg-slate-800/50 rounded border border-purple-100 dark:border-purple-800">
                            <User className="w-4 h-4 text-purple-600 flex-shrink-0" />
                            <div className="flex-1 min-w-0">
                              <p className="text-xs font-medium truncate">{suggestedContact.name}</p>
                              <p className="text-[10px] text-slate-500">{suggestion.reason}</p>
                            </div>
                            <Badge variant="outline" className="text-[10px]">{suggestion.confidence_score}% match</Badge>
                            {!isAlreadyLinked && (
                              <Button
                                size="sm"
                                onClick={() => linkEntityMutation.mutate({ entity_type: 'contact', entity_id: suggestion.id })}
                                className="h-6 text-xs bg-purple-600 hover:bg-purple-700"
                              >
                                Link
                              </Button>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </CardContent>
              </Card>
            )}

            {/* AI Insights */}
            {!message.ai_processed && isSyncedEmail && (
              <Button
                onClick={() => onProcessWithAI(message.originalId)}
                disabled={processingEmailId === message.originalId}
                className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700"
              >
                {processingEmailId === message.originalId ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Processing with AI...
                  </>
                ) : (
                  <>
                    <Zap className="w-4 h-4 mr-2" />
                    Analyze with AI
                  </>
                )}
              </Button>
            )}

            {message.ai_summary && (
              <div className="p-4 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg">
                <div className="flex items-center gap-2 mb-2">
                  <Zap className="w-4 h-4 text-indigo-600" />
                  <span className="text-sm font-semibold text-indigo-900 dark:text-indigo-300">AI Summary</span>
                </div>
                <p className="text-sm text-indigo-700 dark:text-indigo-300">
                  {message.ai_summary}
                </p>
              </div>
            )}

            {message.ai_category && (
              <div className="p-3 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <Badge className="bg-purple-600 text-white">
                      {message.ai_category.replace(/_/g, ' ').toUpperCase()}
                    </Badge>
                    {message.ai_action_items && JSON.parse(message.ai_action_items).length > 0 && (
                      <div className="text-xs text-purple-700 dark:text-purple-300">
                        {JSON.parse(message.ai_action_items).length} action item(s) detected
                      </div>
                    )}
                  </div>
                  {isSyncedEmail && (
                    <Button
                      size="sm"
                      variant="ghost"
                      onClick={() => setIsRecategorizing(!isRecategorizing)}
                      className="h-7 text-xs"
                    >
                      {isRecategorizing ? 'Cancel' : 'Change Category'}
                    </Button>
                  )}
                </div>
                
                {isRecategorizing && (
                  <div className="mt-3 p-3 bg-white dark:bg-slate-800 rounded-lg border border-purple-200">
                    <Label className="text-xs mb-2 block">Recategorize this email:</Label>
                    <div className="grid grid-cols-2 gap-2">
                      {[
                        { value: 'property_inquiry', label: 'Property Inquiry' },
                        { value: 'showing_request', label: 'Showing Request' },
                        { value: 'offer_negotiation', label: 'Offer/Negotiation' },
                        { value: 'document_request', label: 'Document Request' },
                        { value: 'client_question', label: 'Client Question' },
                        { value: 'transaction_update', label: 'Transaction Update' },
                        { value: 'marketing', label: 'Marketing' },
                        { value: 'spam', label: 'Spam' },
                        { value: 'personal', label: 'Personal' },
                        { value: 'other', label: 'Other' }
                      ].map(cat => (
                        <Button
                          key={cat.value}
                          size="sm"
                          variant={message.ai_category === cat.value ? 'default' : 'outline'}
                          onClick={() => recategorizeMutation.mutate(cat.value)}
                          disabled={recategorizeMutation.isPending}
                          className="text-xs"
                        >
                          {cat.label}
                        </Button>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {message.ai_action_items && JSON.parse(message.ai_action_items).length > 0 && (
              <div className="p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                <div className="flex items-center gap-2 mb-2">
                  <CheckCircle2 className="w-4 h-4 text-amber-600" />
                  <span className="text-sm font-semibold text-amber-900 dark:text-amber-300">Action Items</span>
                </div>
                <ul className="space-y-1">
                  {JSON.parse(message.ai_action_items).map((item, idx) => (
                    <li key={idx} className="text-sm text-amber-700 dark:text-amber-300 flex items-start gap-2">
                      <span className="text-amber-500">‚Ä¢</span>
                      {item}
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {message.ai_suggested_reply && (
              <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <Send className="w-4 h-4 text-green-600" />
                    <span className="text-sm font-semibold text-green-900 dark:text-green-300">AI Suggested Reply</span>
                  </div>
                  <Button
                    size="sm"
                    onClick={() => onReplyWithAI(message)}
                    className="bg-green-600 hover:bg-green-700"
                  >
                    Use This Reply
                  </Button>
                </div>
                <p className="text-sm text-green-700 dark:text-green-300 whitespace-pre-wrap">
                  {message.ai_suggested_reply}
                </p>
              </div>
            )}
          </div>

          {/* Message body */}
          <div className="px-6 pb-6">
            {/* Render HTML email if available */}
            {isSyncedEmail && message.body_html ? (
              <div className="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-white">
                <iframe
                  srcDoc={message.body_html}
                  className="w-full border-0"
                  sandbox="allow-same-origin allow-popups"
                  style={{ 
                    minHeight: '400px',
                    height: '100%',
                    display: 'block'
                  }}
                  onLoad={(e) => {
                    // Auto-resize iframe to content height
                    try {
                      const iframe = e.target;
                      const height = iframe.contentWindow.document.body.scrollHeight;
                      iframe.style.height = Math.max(400, height + 20) + 'px';
                    } catch (err) {
                      console.log('Could not resize iframe:', err);
                    }
                  }}
                />
              </div>
            ) : (
              <div className="prose prose-sm max-w-none dark:prose-invert">
                <div className="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap break-words leading-relaxed">
                  {typeof contentDisplay === 'string' ? contentDisplay : (typeof contentDisplay === 'object' ? JSON.stringify(contentDisplay, null, 2) : '(No content available)')}
                </div>
              </div>
            )}
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}

function EmailAccountModal({ account, onSave, onClose }) {
  const [formData, setFormData] = useState({
    provider: account?.provider || 'gmail',
    email_address: account?.email_address || '',
    display_name: account?.display_name || '',
    smtp_host: account?.smtp_host || account?.imap_host || '',
    smtp_port: account?.smtp_port || 587,
    smtp_username: account?.smtp_username || '',
    smtp_password: account?.smtp_password || '',
    imap_host: account?.imap_host || account?.smtp_host || '',
    imap_port: account?.imap_port || 993,
    signature: account?.signature || '',
    auto_bcc: account?.auto_bcc || '',
    sync_enabled: account?.sync_enabled !== false,
    is_active: account?.is_active !== false
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    
    if (!formData.email_address || !formData.smtp_password) {
      toast.error("Email address and password are required");
      return;
    }

    // Default username to email if not provided
    const dataToSave = {
      ...formData,
      smtp_username: formData.smtp_username || formData.email_address
    };

    onSave(dataToSave);
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            {account?.id ? 'Edit' : 'Add'} Email Account
          </DialogTitle>
          <DialogDescription>
            Connect your email account using IMAP/SMTP with an app-specific password
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-6 pt-4">
          {formData.provider === 'gmail' && (
            <Card className="bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800">
              <CardContent className="pt-4">
                <h4 className="font-semibold text-sm mb-2 flex items-center gap-2">
                  <Shield className="w-4 h-4 text-blue-600" />
                  Gmail Setup Instructions
                </h4>
                <ol className="text-xs text-slate-700 dark:text-slate-300 space-y-1 list-decimal list-inside">
                  <li>Go to <a href="https://myaccount.google.com/apppasswords" target="_blank" className="text-blue-600 underline">Google App Passwords</a></li>
                  <li>Create a new app password (name it "RealtyMind")</li>
                  <li>Copy the 16-character password</li>
                  <li>Paste it in the "App Password" field below</li>
                </ol>
              </CardContent>
            </Card>
          )}

          <div className="space-y-2">
            <Label>Email Provider *</Label>
            <Select 
              value={formData.provider} 
              onValueChange={(value) => {
                const providerDefaults = {
                  gmail: { imap_host: 'imap.gmail.com', imap_port: 993, smtp_host: 'smtp.gmail.com', smtp_port: 587 },
                  outlook: { imap_host: 'outlook.office365.com', imap_port: 993, smtp_host: 'smtp.office365.com', smtp_port: 587 },
                  yahoo: { imap_host: 'imap.mail.yahoo.com', imap_port: 993, smtp_host: 'smtp.mail.yahoo.com', smtp_port: 587 },
                  imap: { imap_host: '', imap_port: 993, smtp_host: '', smtp_port: 587 }
                };
                setFormData({ ...formData, provider: value, ...providerDefaults[value] });
              }}
            >
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="gmail">üìß Gmail</SelectItem>
                <SelectItem value="outlook">üì® Outlook / Office 365</SelectItem>
                <SelectItem value="yahoo">üíå Yahoo Mail</SelectItem>
                <SelectItem value="imap">‚öôÔ∏è Other (Custom IMAP)</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label>Email Address *</Label>
            <Input
              type="email"
              value={formData.email_address}
              onChange={(e) => setFormData({ ...formData, email_address: e.target.value })}
              placeholder="you@gmail.com"
              required
            />
          </div>

          <div className="space-y-2">
            <Label>Display Name (Optional)</Label>
            <Input
              value={formData.display_name}
              onChange={(e) => setFormData({ ...formData, display_name: e.target.value })}
              placeholder="My Work Email"
            />
          </div>

          <div className="space-y-2">
            <Label>App-Specific Password *</Label>
            <Input
              type="password"
              value={formData.smtp_password}
              onChange={(e) => setFormData({ ...formData, smtp_password: e.target.value })}
              placeholder="Enter your app password"
              required
            />
            <p className="text-xs text-slate-500">
              {formData.provider === 'gmail' ? 'Generate at myaccount.google.com/apppasswords' : 
               formData.provider === 'outlook' ? 'Generate at account.microsoft.com/security' :
               'Your email provider\'s app password'}
            </p>
          </div>

          {formData.provider === 'imap' && (
            <>
              <div className="space-y-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                <h4 className="font-semibold text-sm">Server Settings</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label>IMAP Host *</Label>
                    <Input
                      value={formData.imap_host}
                      onChange={(e) => setFormData({ ...formData, imap_host: e.target.value })}
                      placeholder="imap.example.com"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>IMAP Port *</Label>
                    <Input
                      type="number"
                      value={formData.imap_port}
                      onChange={(e) => setFormData({ ...formData, imap_port: parseInt(e.target.value) })}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>SMTP Host *</Label>
                    <Input
                      value={formData.smtp_host}
                      onChange={(e) => setFormData({ ...formData, smtp_host: e.target.value })}
                      placeholder="smtp.example.com"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>SMTP Port *</Label>
                    <Input
                      type="number"
                      value={formData.smtp_port}
                      onChange={(e) => setFormData({ ...formData, smtp_port: parseInt(e.target.value) })}
                      required
                    />
                  </div>
                </div>
              </div>
            </>
          )}

          <div className="space-y-2">
            <Label>Email Signature (Optional)</Label>
            <Textarea
              value={formData.signature}
              onChange={(e) => setFormData({ ...formData, signature: e.target.value })}
              placeholder="Best regards,\nYour Name\nYour Company"
              rows={4}
            />
          </div>

          <div className="space-y-2">
            <Label>Auto BCC (Optional)</Label>
            <Input
              type="email"
              value={formData.auto_bcc}
              onChange={(e) => setFormData({ ...formData, auto_bcc: e.target.value })}
              placeholder="bcc@example.com"
            />
            <p className="text-xs text-slate-500">
              Automatically BCC this address on all outgoing emails
            </p>
          </div>

          <div className="flex items-center justify-between p-3 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg">
            <div>
              <Label className="font-semibold">Enable Email Syncing</Label>
              <p className="text-xs text-slate-600 dark:text-slate-400">
                Automatically sync emails from this account
              </p>
            </div>
            <Switch
              checked={formData.sync_enabled}
              onCheckedChange={(checked) => setFormData({ ...formData, sync_enabled: checked })}
            />
          </div>

          <div className="flex justify-end gap-3 pt-4 border-t">
            <Button type="button" variant="outline" onClick={onClose}>
              Cancel
            </Button>
            <Button type="submit" className="bg-indigo-600 hover:bg-indigo-700">
              <CheckCircle2 className="w-4 h-4 mr-2" />
              Connect Email Account
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState, useMemo, useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { MapContainer, TileLayer, Marker, Popup, useMap } from 'react-leaflet';
import L from 'leaflet';
import {
  MapPin,
  Calendar,
  Car,
  DoorOpen,
  Briefcase,
  CheckSquare,
  Filter,
  Loader2,
  Navigation,
  Clock
} from 'lucide-react';
import { format, parseISO, isToday, isFuture, isPast } from 'date-fns';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import 'leaflet/dist/leaflet.css';

// Fix Leaflet default icon issue
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png',
  iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
});

const createColoredIcon = (color) => {
  return L.divIcon({
    className: 'custom-marker',
    html: `<div style="background-color: ${color}; width: 25px; height: 25px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
    iconSize: [25, 25],
    iconAnchor: [12, 24],
    popupAnchor: [0, -24],
  });
};

const eventIcons = {
  showing: createColoredIcon('#3b82f6'),
  openhouse: createColoredIcon('#8b5cf6'),
  appointment: createColoredIcon('#10b981'),
  task: createColoredIcon('#f59e0b'),
};

const MapUpdater = ({ center, zoom }) => {
  const map = useMap();
  useEffect(() => {
    if (center) {
      map.setView(center, zoom, { animate: true });
    }
  }, [center, zoom, map]);
  return null;
};

// Cache for geocoded addresses
const getGeoCache = () => {
  try {
    const cache = localStorage.getItem('geocache');
    return cache ? JSON.parse(cache) : {};
  } catch {
    return {};
  }
};

const saveToGeoCache = (address, coords) => {
  try {
    const cache = getGeoCache();
    cache[address] = coords;
    localStorage.setItem('geocache', JSON.stringify(cache));
  } catch (e) {
    console.error('Failed to save to geocache:', e);
  }
};

// Calculate travel time from office
const calculateTravelTime = async (officeLat, officeLng, destLat, destLng) => {
  try {
    const response = await fetch(
      `https://router.project-osrm.org/route/v1/driving/${officeLng},${officeLat};${destLng},${destLat}?overview=false`
    );
    const data = await response.json();

    if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
      const route = data.routes[0];
      const durationMinutes = Math.round(route.duration / 60);
      const distanceMiles = (route.distance * 0.000621371).toFixed(1); // Convert meters to miles

      return {
        duration: durationMinutes,
        distance: distanceMiles,
        success: true
      };
    }
    return { success: false };
  } catch (error) {
    console.error('Travel time calculation error:', error);
    return { success: false };
  }
};

// Travel Time Display Component
const TravelTimeInfo = ({ officeLoc, markerLat, markerLng }) => {
  const [travelInfo, setTravelInfo] = React.useState(null);
  const [loading, setLoading] = React.useState(true);

  React.useEffect(() => {
    if (officeLoc && markerLat && markerLng) {
      calculateTravelTime(officeLoc.lat, officeLoc.lng, markerLat, markerLng)
        .then(info => {
          setTravelInfo(info);
          setLoading(false);
        })
        .catch(() => setLoading(false)); // Ensure loading stops on error
    } else {
      setLoading(false);
    }
  }, [officeLoc, markerLat, markerLng]);

  if (!officeLoc) {
    return (
      <div className="mt-2 p-2 bg-amber-50 dark:bg-amber-900/20 rounded border border-amber-200 dark:border-amber-800 text-xs">
        <div className="text-amber-700 dark:text-amber-300">
          üí° Set your office location in Settings to see travel time
        </div>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-200 dark:border-blue-800 text-xs">
        <div className="flex items-center gap-2 text-blue-700 dark:text-blue-300">
          <Loader2 className="w-3 h-3 animate-spin" />
          <span>Calculating travel time...</span>
        </div>
      </div>
    );
  }

  if (travelInfo && travelInfo.success) {
    return (
      <div className="mt-2 p-2 bg-green-50 dark:bg-green-900/20 rounded border border-green-200 dark:border-green-800">
        <div className="text-xs font-semibold text-green-900 dark:text-green-100 mb-1">
          üöó From Office
        </div>
        <div className="flex items-center justify-between text-xs">
          <span className="text-green-700 dark:text-green-300">
            <Clock className="w-3 h-3 inline mr-1" />
            {travelInfo.duration} min
          </span>
          <span className="text-green-700 dark:text-green-300">
            <Navigation className="w-3 h-3 inline mr-1" />
            {travelInfo.distance} mi
          </span>
        </div>
      </div>
    );
  }

  return null;
};

export default function EventsMap() {
  const navigate = useNavigate();
  const [filters, setFilters] = useState({
    showings: true,
    openhouses: true,
    appointments: true,
    tasks: true,
    timeFilter: 'all'
  });
  const [mapCenter, setMapCenter] = useState([39.8283, -98.5795]);
  const [mapZoom, setMapZoom] = useState(4);
  const [currentLocation, setCurrentLocation] = useState(null);
  const [geocodedMarkers, setGeocodedMarkers] = useState([]);
  const [geocodingProgress, setGeocodingProgress] = useState({ current: 0, total: 0 });
  const [officeLocation, setOfficeLocation] = useState(null);

  // Fetch user data for office location
  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me()
  });

  // Set office location from user data - CHECK ALL POSSIBLE FIELDS
  useEffect(() => {
    if (user) {
      console.log('üë§ User data:', user);
      
      // Priority 1: Custom from address (for travel calculations)
      if (user.custom_from_lat && user.custom_from_lng) {
        console.log('‚úÖ Using custom_from location');
        setOfficeLocation({
          lat: user.custom_from_lat,
          lng: user.custom_from_lng,
          address: user.custom_from_address || 'Custom Location'
        });
      }
      // Priority 2: Private office address
      else if (user.private_office_lat && user.private_office_lng) {
        console.log('‚úÖ Using private_office location');
        setOfficeLocation({
          lat: user.private_office_lat,
          lng: user.private_office_lng,
          address: user.private_office_address || 'Private Office'
        });
      }
      // Priority 3: Company office address
      else if (user.office_lat && user.office_lng) {
        console.log('‚úÖ Using office location');
        setOfficeLocation({
          lat: user.office_lat,
          lng: user.office_lng,
          address: user.company_office_address || user.office || 'Office'
        });
      }
      // No office location set
      else {
        console.log('‚ùå No office location found in user data');
        setOfficeLocation(null);
      }
    }
  }, [user]);

  const { data: showings = [], isLoading: loadingShowings } = useQuery({
    queryKey: ['showings'],
    queryFn: () => base44.entities.Showing.list('-scheduled_date'),
  });

  const { data: openHouses = [], isLoading: loadingOpenHouses } = useQuery({
    queryKey: ['openHouses'],
    queryFn: () => base44.entities.OpenHouse.list('-date'),
  });

  const { data: appointments = [], isLoading: loadingAppointments } = useQuery({
    queryKey: ['appointments'],
    queryFn: () => base44.entities.Appointment.list('-scheduled_date'),
  });

  const { data: tasks = [], isLoading: loadingTasks } = useQuery({
    queryKey: ['tasks'],
    queryFn: () => base44.entities.Task.list('-due_date'),
  });

  const { data: properties = [] } = useQuery({
    queryKey: ['properties'],
    queryFn: () => base44.entities.Property.list(),
  });

  const isLoading = loadingShowings || loadingOpenHouses || loadingAppointments || loadingTasks;

  useEffect(() => {
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLoc = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          setCurrentLocation(userLoc);
          setMapCenter([userLoc.lat, userLoc.lng]);
          setMapZoom(12);
        },
        (error) => {
          console.log('Location unavailable:', error.message);
        }
      );
    }
  }, []);

  const eventMarkers = useMemo(() => {
    const markers = [];

    const filterByTime = (date, status) => {
      if (filters.timeFilter === 'all') return true;
      const eventDate = new Date(date);
      if (filters.timeFilter === 'today') return isToday(eventDate);
      if (filters.timeFilter === 'upcoming') return isFuture(eventDate) && status !== 'completed' && status !== 'cancelled';
      if (filters.timeFilter === 'past') return isPast(eventDate) || status === 'completed';
      return true;
    };

    if (filters.showings) {
      showings.forEach(showing => {
        if (!showing.scheduled_date || !filterByTime(showing.scheduled_date, showing.status)) return;
        const property = properties.find(p => p.id === showing.property_id);
        if (property) {
          markers.push({
            type: 'showing',
            id: showing.id,
            title: `Showing: ${property.address}`,
            address: property.address,
            fullAddress: `${property.address}, ${property.city}, ${property.state} ${property.zip_code}`,
            date: showing.scheduled_date,
            time: showing.scheduled_time,
            status: showing.status,
            icon: eventIcons.showing,
            property,
            data: showing
          });
        }
      });
    }

    if (filters.openhouses) {
      openHouses.forEach(oh => {
        if (!oh.date || !filterByTime(oh.date, oh.status)) return;
        const property = properties.find(p => p.id === oh.property_id);
        if (property) {
          markers.push({
            type: 'openhouse',
            id: oh.id,
            title: `Open House: ${property.address}`,
            address: property.address,
            fullAddress: `${property.address}, ${property.city}, ${property.state} ${property.zip_code}`,
            date: oh.date,
            time: `${oh.start_time} - ${oh.end_time}`,
            status: oh.status,
            icon: eventIcons.openhouse,
            property,
            data: oh
          });
        }
      });
    }

    if (filters.appointments) {
      appointments.forEach(apt => {
        if (!apt.scheduled_date || !filterByTime(apt.scheduled_date, apt.status)) return;

        // Use appointment's own coordinates if available
        if (apt.location_lat && apt.location_lng) {
          markers.push({
            type: 'appointment',
            id: apt.id,
            title: apt.title,
            address: apt.location_address,
            fullAddress: apt.location_address,
            date: apt.scheduled_date,
            time: apt.scheduled_time,
            status: apt.status,
            icon: eventIcons.appointment,
            lat: apt.location_lat,
            lng: apt.location_lng,
            data: apt
          });
        } else if (apt.location_address) {
          markers.push({
            type: 'appointment',
            id: apt.id,
            title: apt.title,
            address: apt.location_address,
            fullAddress: apt.location_address,
            date: apt.scheduled_date,
            time: apt.scheduled_time,
            status: apt.status,
            icon: eventIcons.appointment,
            data: apt
          });
        } else if (apt.property_id) {
          const property = properties.find(p => p.id === apt.property_id);
          if (property) {
            markers.push({
              type: 'appointment',
              id: apt.id,
              title: apt.title,
              address: property.address,
              fullAddress: `${property.address}, ${property.city}, ${property.state} ${property.zip_code}`,
              date: apt.scheduled_date,
              time: apt.scheduled_time,
              status: apt.status,
              icon: eventIcons.appointment,
              property,
              data: apt
            });
          }
        }
      });
    }

    if (filters.tasks) {
      tasks.forEach(task => {
        if (!task.due_date || task.status === 'completed' || task.status === 'cancelled') return;
        if (!filterByTime(task.due_date, task.status)) return;
        if (task.property_id) {
          const property = properties.find(p => p.id === task.property_id);
          if (property) {
            markers.push({
              type: 'task',
              id: task.id,
              title: task.title,
              address: property.address,
              fullAddress: `${property.address}, ${property.city}, ${property.state} ${property.zip_code}`,
              date: task.due_date,
              time: null,
              status: task.status,
              icon: eventIcons.task,
              property,
              data: task
            });
          }
        }
      });
    }

    return markers;
  }, [showings, openHouses, appointments, tasks, properties, filters]);

  useEffect(() => {
    const geocodeAll = async () => {
      if (eventMarkers.length === 0) {
        setGeocodedMarkers([]);
        setGeocodingProgress({ current: 0, total: 0 });
        return;
      }

      console.log('üó∫Ô∏è Starting geocoding for', eventMarkers.length, 'events...');
      setGeocodingProgress({ current: 0, total: eventMarkers.length });

      const cache = getGeoCache();
      const results = [];
      let needsGeocoding = [];

      // First pass: check cache and existing coordinates
      eventMarkers.forEach(marker => {
        // If marker already has coordinates (from appointment), use them
        if (marker.lat && marker.lng) {
          results.push(marker);
          console.log('‚úÖ Using existing coords:', marker.title);
        }
        // Check cache
        else if (cache[marker.fullAddress]) {
          const coords = cache[marker.fullAddress];
          if (coords && coords.lat && coords.lng) {
            results.push({ ...marker, ...coords });
            console.log('‚úÖ Using cached coords:', marker.fullAddress);
          } else {
            needsGeocoding.push(marker);
          }
        } else {
          needsGeocoding.push(marker);
        }
      });

      console.log(`üìä Stats: ${results.length} have coords, ${needsGeocoding.length} need geocoding`);

      // Second pass: geocode remaining addresses in batches
      if (needsGeocoding.length > 0) {
        console.log('üîç Geocoding', needsGeocoding.length, 'addresses...');

        for (let i = 0; i < needsGeocoding.length; i++) {
          const marker = needsGeocoding[i];
          setGeocodingProgress({ current: results.length + i + 1, total: eventMarkers.length });

          try {
            // Small delay to respect rate limits
            if (i > 0) await new Promise(resolve => setTimeout(resolve, 1200));

            const response = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(marker.fullAddress)}&limit=1`,
              {
                headers: {
                  'User-Agent': 'RealtyMind-CRM/1.0'
                }
              }
            ).catch(err => {
              console.warn(`Fetch failed for ${marker.fullAddress}:`, err.message);
              return null;
            });

            if (!response || !response.ok) {
              console.warn(`Geocoding service unavailable for: ${marker.fullAddress}`);
              continue;
            }

            const data = await response.json();
            if (data && data.length > 0) {
              const coords = {
                lat: parseFloat(data[0].lat),
                lng: parseFloat(data[0].lon)
              };

              // Save to cache
              saveToGeoCache(marker.fullAddress, coords);

              results.push({ ...marker, ...coords });
              console.log(`‚úÖ Geocoded ${i + 1}/${needsGeocoding.length}:`, marker.fullAddress);
            } else {
              console.log(`‚ùå No results for:`, marker.fullAddress);
            }
          } catch (error) {
            console.warn(`Geocoding error for ${marker.fullAddress}:`, error.message);
            // Continue with next address even if this one fails
          }
        }
      }

      console.log('‚úÖ Geocoding complete. Mapped', results.length, 'out of', eventMarkers.length, 'events');
      setGeocodedMarkers(results);
      setGeocodingProgress({ current: eventMarkers.length, total: eventMarkers.length });

      // Center map on first result if no user location
      if (results.length > 0 && !currentLocation) {
        setMapCenter([results[0].lat, results[0].lng]);
        setMapZoom(12);
      }
    };

    if (eventMarkers.length > 0 || isLoading) { // Run geocoding if there are markers or still loading (in case markers appear after initial empty state)
      geocodeAll();
    } else {
      setGeocodedMarkers([]);
      setGeocodingProgress({ current: 0, total: 0 });
    }
  }, [eventMarkers, currentLocation, isLoading]);


  const handleMarkerClick = (marker) => {
    // Navigate to Calendar page for all event types
    navigate(createPageUrl('Calendar'));
  };

  const stats = useMemo(() => ({
    total: geocodedMarkers.length,
    showings: geocodedMarkers.filter(m => m.type === 'showing').length,
    openhouses: geocodedMarkers.filter(m => m.type === 'openhouse').length,
    appointments: geocodedMarkers.filter(m => m.type === 'appointment').length,
    tasks: geocodedMarkers.filter(m => m.type === 'task').length,
  }), [geocodedMarkers]);

  const centerOnLocation = () => {
    if (currentLocation) {
      setMapCenter([currentLocation.lat, currentLocation.lng]);
      setMapZoom(12);
    }
  };

  const isGeocoding = geocodingProgress.current > 0 && geocodingProgress.current < geocodingProgress.total;

  return (
    <div className="page-container space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="page-title">Events Map</h1>
          <p className="text-slate-600 dark:text-slate-400">
            View all your scheduled events on an interactive map
          </p>
        </div>
        {currentLocation && (
          <Button variant="outline" onClick={centerOnLocation}>
            <Navigation className="w-4 h-4 mr-2" />
            My Location
          </Button>
        )}
      </div>

      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <Card className="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 border-2">
          <CardContent className="p-4">
            <div className="text-2xl font-bold text-slate-900 dark:text-white">{stats.total}</div>
            <div className="text-sm text-slate-600 dark:text-slate-400">Total Events</div>
          </CardContent>
        </Card>
        <Card className="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950 dark:to-blue-900 border-2 border-blue-200 dark:border-blue-800">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-2xl font-bold text-blue-900 dark:text-blue-100">{stats.showings}</div>
                <div className="text-sm text-blue-700 dark:text-blue-300">Showings</div>
              </div>
              <Car className="w-8 h-8 text-blue-500" />
            </div>
          </CardContent>
        </Card>
        <Card className="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-950 dark:to-purple-900 border-2 border-purple-200 dark:border-purple-800">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-2xl font-bold text-purple-900 dark:text-purple-100">{stats.openhouses}</div>
                <div className="text-sm text-purple-700 dark:text-purple-300">Open Houses</div>
              </div>
              <DoorOpen className="w-8 h-8 text-purple-500" />
            </div>
          </CardContent>
        </Card>
        <Card className="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-950 dark:to-green-900 border-2 border-green-200 dark:border-green-800">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-2xl font-bold text-green-900 dark:text-green-100">{stats.appointments}</div>
                <div className="text-sm text-green-700 dark:text-green-300">Appointments</div>
              </div>
              <Briefcase className="w-8 h-8 text-green-500" />
            </div>
          </CardContent>
        </Card>
        <Card className="bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-950 dark:to-amber-900 border-2 border-amber-200 dark:border-amber-800">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-2xl font-bold text-amber-900 dark:text-amber-100">{stats.tasks}</div>
                <div className="text-sm text-amber-700 dark:text-amber-300">Tasks</div>
              </div>
              <CheckSquare className="w-8 h-8 text-amber-500" />
            </div>
          </CardContent>
        </Card>
      </div>

      {isGeocoding && (
        <Card className="bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <Loader2 className="w-5 h-5 animate-spin text-blue-600 dark:text-blue-400" />
              <div className="flex-1">
                <div className="font-semibold text-blue-900 dark:text-blue-100">
                  Finding event locations... ({geocodingProgress.current}/{geocodingProgress.total})
                </div>
                <div className="text-sm text-blue-700 dark:text-blue-300">
                  {geocodedMarkers.length} events already mapped
                </div>
                <div className="w-full bg-blue-200 dark:bg-blue-900/40 rounded-full h-2 mt-2">
                  <div
                    className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${(geocodingProgress.current / geocodingProgress.total) * 100}%` }}
                  />
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-lg">
            <Filter className="w-5 h-5" />
            Filters
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-3">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setFilters(f => ({ ...f, showings: !f.showings }))}
              className={filters.showings ? 'bg-blue-500 hover:bg-blue-600 text-white border-blue-600' : 'hover:bg-blue-50 dark:hover:bg-blue-950'}
            >
              <Car className="w-4 h-4 mr-2" />
              Showings
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setFilters(f => ({ ...f, openhouses: !f.openhouses }))}
              className={filters.openhouses ? 'bg-purple-500 hover:bg-purple-600 text-white border-purple-600' : 'hover:bg-purple-50 dark:hover:bg-purple-950'}
            >
              <DoorOpen className="w-4 h-4 mr-2" />
              Open Houses
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setFilters(f => ({ ...f, appointments: !f.appointments }))}
              className={filters.appointments ? 'bg-green-500 hover:bg-green-600 text-white border-green-600' : 'hover:bg-green-50 dark:hover:bg-green-950'}
            >
              <Briefcase className="w-4 h-4 mr-2" />
              Appointments
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setFilters(f => ({ ...f, tasks: !f.tasks }))}
              className={filters.tasks ? 'bg-amber-500 hover:bg-amber-600 text-white border-amber-600' : 'hover:bg-amber-50 dark:hover:bg-amber-950'}
            >
              <CheckSquare className="w-4 h-4 mr-2" />
              Tasks
            </Button>
            <div className="border-l mx-2"></div>
            <Button
              variant={filters.timeFilter === 'all' ? 'default' : 'outline'}
              size="sm"
              onClick={() => setFilters(f => ({ ...f, timeFilter: 'all' }))}
            >
              All
            </Button>
            <Button
              variant={filters.timeFilter === 'today' ? 'default' : 'outline'}
              size="sm"
              onClick={() => setFilters(f => ({ ...f, timeFilter: 'today' }))}
            >
              Today
            </Button>
            <Button
              variant={filters.timeFilter === 'upcoming' ? 'default' : 'outline'}
              size="sm"
              onClick={() => setFilters(f => ({ ...f, timeFilter: 'upcoming' }))}
            >
              Upcoming
            </Button>
            <Button
              variant={filters.timeFilter === 'past' ? 'default' : 'outline'}
              size="sm"
              onClick={() => setFilters(f => ({ ...f, timeFilter: 'past' }))}
            >
              Past
            </Button>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardContent className="p-0">
          {isLoading ? (
            <div className="h-[600px] flex items-center justify-center bg-slate-100 dark:bg-slate-800">
              <Loader2 className="w-8 h-8 animate-spin text-primary" />
            </div>
          ) : geocodedMarkers.length === 0 && eventMarkers.length > 0 && !isGeocoding ? (
            <div className="h-[600px] flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 text-center p-8">
              <MapPin className="w-16 h-16 text-slate-300 dark:text-slate-600 mb-4" />
              <h3 className="text-xl font-semibold mb-2">Still loading locations...</h3>
              <p className="text-slate-600 dark:text-slate-400 max-w-md">
                Found {eventMarkers.length} events. Geocoding in progress...
              </p>
            </div>
          ) : geocodedMarkers.length === 0 ? (
            <div className="h-[600px] flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 text-center p-8">
              <Calendar className="w-16 h-16 text-slate-300 dark:text-slate-600 mb-4" />
              <h3 className="text-xl font-semibold mb-2">No events to display</h3>
              <p className="text-slate-600 dark:text-slate-400 max-w-md">
                Schedule some showings, open houses, or appointments to see them on the map.
              </p>
            </div>
          ) : (
            <div className="h-[600px] rounded-lg overflow-hidden">
              <MapContainer center={mapCenter} zoom={mapZoom} style={{ height: '100%', width: '100%' }}>
                <TileLayer
                  url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                  attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                />
                <MapUpdater center={mapCenter} zoom={mapZoom} />

                {currentLocation && (
                  <Marker position={[currentLocation.lat, currentLocation.lng]}>
                    <Popup>
                      <div className="text-center">
                        <strong>Your Location</strong>
                      </div>
                    </Popup>
                  </Marker>
                )}

                {officeLocation && (
                  <Marker
                    position={[officeLocation.lat, officeLocation.lng]}
                    icon={createColoredIcon('#ef4444')}
                  >
                    <Popup>
                      <div className="text-center">
                        <div className="font-semibold mb-1">üè¢ Office</div>
                        <div className="text-xs text-slate-600 dark:text-slate-400">
                          {officeLocation.address}
                        </div>
                      </div>
                    </Popup>
                  </Marker>
                )}

                {geocodedMarkers.map((marker, idx) => (
                  <Marker
                    key={`${marker.type}-${marker.id}-${idx}`}
                    position={[marker.lat, marker.lng]}
                    icon={marker.icon}
                  >
                    <Popup>
                      <div className="min-w-[220px]">
                        <div className="font-semibold mb-2">{marker.title}</div>
                        <div className="text-sm space-y-1">
                          <div className="flex items-center gap-2">
                            <MapPin className="w-4 h-4 text-slate-400" />
                            <span>{marker.address}</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <Calendar className="w-4 h-4 text-slate-400" />
                            <span>{format(parseISO(marker.date), 'MMM d, yyyy')}</span>
                          </div>
                          {marker.time && (
                            <div className="flex items-center gap-2">
                              <Clock className="w-4 h-4 text-slate-400" />
                              <span>{marker.time}</span>
                            </div>
                          )}
                          {marker.status && (
                            <Badge variant="outline" className="mt-2">
                              {marker.status}
                            </Badge>
                          )}
                        </div>

                        <TravelTimeInfo
                          officeLoc={officeLocation}
                          markerLat={marker.lat}
                          markerLng={marker.lng}
                        />

                        <Button
                          size="sm"
                          className="w-full mt-3"
                          onClick={() => handleMarkerClick(marker)}
                        >
                          View Details
                        </Button>
                      </div>
                    </Popup>
                  </Marker>
                ))}
              </MapContainer>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  ExternalLink,
  Search,
  Home,
  TrendingUp,
  MapPin,
  Globe,
  ArrowLeft,
  RefreshCw,
  Maximize2,
  Copy,
  Loader2
} from "lucide-react";
import { toast } from "sonner";
import { useNavigate } from "react-router-dom";

export default function ExternalViewer() {
  const navigate = useNavigate();
  const [currentUrl, setCurrentUrl] = useState("");
  const [inputUrl, setInputUrl] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [isFullscreen, setIsFullscreen] = useState(false);

  useEffect(() => {
    // Check for URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const url = urlParams.get('url');
    
    if (url) {
      const decodedUrl = decodeURIComponent(url);
      setCurrentUrl(decodedUrl);
      setInputUrl(decodedUrl);
    }
  }, []);

  const quickLinks = [
    {
      name: "Zillow",
      url: "https://www.zillow.com",
      icon: Home,
      color: "bg-blue-600",
      description: "Property search and listings"
    },
    {
      name: "Realtor.com",
      url: "https://www.realtor.com",
      icon: Home,
      color: "bg-red-600",
      description: "MLS listings and data"
    },
    {
      name: "Redfin",
      url: "https://www.redfin.com",
      icon: Home,
      color: "bg-red-500",
      description: "Real estate brokerage"
    },
    {
      name: "Trulia",
      url: "https://www.trulia.com",
      icon: MapPin,
      color: "bg-green-600",
      description: "Neighborhood insights"
    },
    {
      name: "NAR",
      url: "https://www.nar.realtor",
      icon: TrendingUp,
      color: "bg-indigo-600",
      description: "National Association of Realtors"
    },
    {
      name: "Mortgage Calculator",
      url: "https://www.mortgagecalculator.org",
      icon: TrendingUp,
      color: "bg-purple-600",
      description: "Mortgage tools"
    },
    {
      name: "Google Maps",
      url: "https://www.google.com/maps",
      icon: MapPin,
      color: "bg-blue-500",
      description: "Maps and directions"
    },
    {
      name: "Canva",
      url: "https://www.canva.com",
      icon: Globe,
      color: "bg-cyan-500",
      description: "Design marketing materials"
    }
  ];

  const handleLoadUrl = () => {
    if (!inputUrl.trim()) {
      toast.error("Please enter a URL");
      return;
    }

    let urlToLoad = inputUrl.trim();
    
    // Add https:// if no protocol is specified
    if (!urlToLoad.startsWith('http://') && !urlToLoad.startsWith('https://')) {
      urlToLoad = 'https://' + urlToLoad;
    }

    setIsLoading(true);
    setCurrentUrl(urlToLoad);
    
    // Update URL parameter
    window.history.pushState({}, '', `?url=${encodeURIComponent(urlToLoad)}`);
    
    // Clear loading after a short delay
    setTimeout(() => setIsLoading(false), 1000);
  };

  const handleQuickLink = (url) => {
    setInputUrl(url);
    setCurrentUrl(url);
    setIsLoading(true);
    
    // Update URL parameter
    window.history.pushState({}, '', `?url=${encodeURIComponent(url)}`);
    
    setTimeout(() => setIsLoading(false), 1000);
  };

  const handleRefresh = () => {
    setIsLoading(true);
    // Force iframe reload
    const iframe = document.getElementById('external-iframe');
    if (iframe) {
      iframe.src = iframe.src;
    }
    setTimeout(() => setIsLoading(false), 1000);
  };

  const handleCopyUrl = () => {
    if (currentUrl) {
      navigator.clipboard.writeText(currentUrl);
      toast.success("URL copied to clipboard!");
    }
  };

  const toggleFullscreen = () => {
    setIsFullscreen(!isFullscreen);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        {!isFullscreen && (
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center gap-4 mb-4">
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => navigate(-1)}
                  className="rounded-full"
                >
                  <ArrowLeft className="w-5 h-5" />
                </Button>
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center">
                  <Globe className="w-6 h-6 text-white" />
                </div>
                <div className="flex-1">
                  <h1 className="text-2xl font-bold text-slate-900 dark:text-white">External Browser</h1>
                  <p className="text-sm text-slate-600 dark:text-slate-400">Browse external websites without leaving RealtyMind</p>
                </div>
              </div>

              {/* URL Input */}
              <div className="flex gap-3">
                <div className="relative flex-1">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" />
                  <Input
                    placeholder="Enter website URL (e.g., zillow.com, realtor.com)"
                    value={inputUrl}
                    onChange={(e) => setInputUrl(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleLoadUrl()}
                    className="pl-10"
                  />
                </div>
                <Button
                  onClick={handleLoadUrl}
                  className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                >
                  <ExternalLink className="w-4 h-4 mr-2" />
                  Load
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Quick Links */}
        {!isFullscreen && !currentUrl && (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Globe className="w-5 h-5" />
                Quick Links
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {quickLinks.map((link) => {
                  const Icon = link.icon;
                  return (
                    <button
                      key={link.name}
                      onClick={() => handleQuickLink(link.url)}
                      className="flex items-start gap-3 p-4 rounded-lg border-2 border-slate-200 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 transition-all hover:shadow-lg bg-white dark:bg-slate-800 text-left"
                    >
                      <div className={`w-10 h-10 rounded-lg ${link.color} flex items-center justify-center flex-shrink-0`}>
                        <Icon className="w-5 h-5 text-white" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <h3 className="font-semibold text-sm text-slate-900 dark:text-white">{link.name}</h3>
                        <p className="text-xs text-slate-600 dark:text-slate-400 mt-0.5">{link.description}</p>
                      </div>
                    </button>
                  );
                })}
              </div>
            </CardContent>
          </Card>
        )}

        {/* Iframe Viewer */}
        {currentUrl && (
          <Card className={isFullscreen ? "fixed inset-0 z-50 rounded-none" : ""}>
            <CardContent className="p-4">
              {/* Toolbar */}
              <div className="flex items-center justify-between mb-4 gap-3">
                <div className="flex items-center gap-2 flex-1 min-w-0">
                  <Badge variant="outline" className="flex items-center gap-1 text-xs">
                    <Globe className="w-3 h-3" />
                    <span className="truncate max-w-[200px] md:max-w-md">{currentUrl}</span>
                  </Badge>
                </div>
                
                <div className="flex items-center gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={handleCopyUrl}
                    title="Copy URL"
                  >
                    <Copy className="w-4 h-4" />
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={handleRefresh}
                    disabled={isLoading}
                    title="Refresh"
                  >
                    <RefreshCw className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} />
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={toggleFullscreen}
                    title={isFullscreen ? "Exit Fullscreen" : "Fullscreen"}
                  >
                    <Maximize2 className="w-4 h-4" />
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => window.open(currentUrl, '_blank')}
                    title="Open in New Tab"
                  >
                    <ExternalLink className="w-4 h-4" />
                  </Button>
                  {isFullscreen && (
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={toggleFullscreen}
                      title="Close"
                    >
                      <ArrowLeft className="w-4 h-4" />
                    </Button>
                  )}
                </div>
              </div>

              {/* Loading Indicator */}
              {isLoading && (
                <div className="flex items-center justify-center py-8">
                  <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
                  <span className="ml-2 text-slate-600 dark:text-slate-400">Loading website...</span>
                </div>
              )}

              {/* Iframe */}
              <div className={`relative bg-white dark:bg-slate-900 rounded-lg overflow-hidden border-2 border-slate-200 dark:border-slate-700 ${isFullscreen ? 'h-[calc(100vh-100px)]' : 'h-[calc(100vh-300px)]'}`}>
                <iframe
                  id="external-iframe"
                  src={currentUrl}
                  className="w-full h-full"
                  title="External Website Viewer"
                  sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-downloads"
                  onLoad={() => setIsLoading(false)}
                  onError={() => {
                    setIsLoading(false);
                    toast.error("Failed to load website. Some sites may block embedding.");
                  }}
                />
              </div>

              {/* Info Banner */}
              <div className="mt-4 text-xs text-slate-500 dark:text-slate-400 text-center">
                üí° Tip: Some websites may not load due to security restrictions. Click "Open in New Tab" to view them in your browser.
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { 
  ArrowLeft, 
  Send, 
  Heart, 
  Bug, 
  Lightbulb, 
  TrendingUp, 
  HelpCircle,
  MessageSquare,
  Upload,
  CheckCircle2,
  Loader2,
  Sparkles,
  Star,
  ThumbsUp
} from "lucide-react";
import { toast } from "sonner";

export default function FeedbackSuggestions() {
  const navigate = useNavigate();
  const [user, setUser] = useState(null);
  const [feedbacks, setFeedbacks] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showForm, setShowForm] = useState(true);
  const [uploadingFile, setUploadingFile] = useState(false);
  
  const [formData, setFormData] = useState({
    title: "",
    description: "",
    feedback_type: "improvement",
    category: "general",
    priority: "medium",
    is_anonymous: false,
    attachments: ""
  });

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const currentUser = await base44.auth.me();
      setUser(currentUser);
      
      const allFeedback = await base44.entities.Feedback.list("-created_date");
      // Show user's own feedback
      const userFeedback = allFeedback.filter(f => f.created_by === currentUser.email);
      setFeedbacks(userFeedback);
    } catch (error) {
      console.error("Error loading feedback:", error);
    }
    setIsLoading(false);
  };

  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setUploadingFile(true);
    try {
      const result = await base44.integrations.Core.UploadFile({ file });
      const newAttachments = formData.attachments 
        ? `${formData.attachments},${result.file_url}` 
        : result.file_url;
      
      setFormData(prev => ({ ...prev, attachments: newAttachments }));
      toast.success("File uploaded successfully!");
    } catch (error) {
      console.error("Error uploading file:", error);
      toast.error("Failed to upload file");
    }
    setUploadingFile(false);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!formData.title.trim() || !formData.description.trim()) {
      toast.error("Please fill in all required fields");
      return;
    }

    setIsSubmitting(true);
    try {
      const feedbackData = {
        ...formData,
        user_name: formData.is_anonymous ? "Anonymous" : user?.full_name || user?.email,
        user_email: formData.is_anonymous ? "anonymous@user.com" : user?.email
      };

      await base44.entities.Feedback.create(feedbackData);
      
      // Send email notification to admin
      try {
        const typeConfig = feedbackTypeConfig[formData.feedback_type] || feedbackTypeConfig.other;
        const priorityEmoji = formData.priority === 'high' ? 'üî¥' : formData.priority === 'medium' ? 'üü°' : 'üü¢';
        const typeEmoji = formData.feedback_type === 'bug_report' ? 'üêõ' : formData.feedback_type === 'feature_request' ? '‚ú®' : formData.feedback_type === 'compliment' ? 'üíú' : 'üí°';
        
        await base44.integrations.Core.SendEmail({
          to: "simongedz@gmail.com",
          subject: `${typeEmoji} RealtyMind Feedback: ${formData.title}`,
          body: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 0; background: #f8fafc; }
    .container { max-width: 600px; margin: 0 auto; background: white; }
    .header { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); padding: 32px; text-align: center; }
    .header h1 { color: white; margin: 0; font-size: 28px; font-weight: 700; }
    .header p { color: rgba(255, 255, 255, 0.9); margin: 8px 0 0; font-size: 14px; }
    .content { padding: 32px; }
    .badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-right: 8px; }
    .badge-type { background: ${typeConfig.bg?.replace('bg-', '#') || '#f1f5f9'}; color: ${typeConfig.text?.replace('text-', '#') || '#334155'}; }
    .badge-priority { background: ${formData.priority === 'high' ? '#fee2e2' : formData.priority === 'medium' ? '#fef3c7' : '#dcfce7'}; color: ${formData.priority === 'high' ? '#991b1b' : formData.priority === 'medium' ? '#92400e' : '#166534'}; }
    .badge-category { background: #f1f5f9; color: #475569; }
    .section { margin-bottom: 24px; }
    .section-title { font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .section-content { background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #4F46E5; }
    .user-info { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 16px; border-radius: 8px; margin-bottom: 24px; }
    .footer { background: #f8fafc; padding: 24px 32px; text-align: center; border-top: 1px solid #e2e8f0; }
    .footer p { color: #64748b; font-size: 12px; margin: 0; }
    .emoji { font-size: 24px; }
    .title { font-size: 20px; font-weight: 700; color: #1e293b; margin: 16px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="emoji">${typeEmoji}</div>
      <h1>New Feedback Received</h1>
      <p>Someone shared their thoughts on RealtyMind</p>
    </div>
    
    <div class="content">
      <div style="margin-bottom: 20px;">
        <span class="badge badge-type">${typeConfig.label}</span>
        <span class="badge badge-priority">${priorityEmoji} ${formData.priority.toUpperCase()}</span>
        <span class="badge badge-category">${formData.category}</span>
      </div>

      <div class="user-info">
        <p style="margin: 0; font-weight: 600; color: #0c4a6e;">üë§ ${feedbackData.user_name}</p>
        <p style="margin: 4px 0 0; color: #0369a1; font-size: 14px;">${feedbackData.user_email}</p>
      </div>

      <h2 class="title">${formData.title}</h2>

      <div class="section">
        <div class="section-title">Description</div>
        <div class="section-content">
          <p style="margin: 0; line-height: 1.6; color: #334155; white-space: pre-wrap;">${formData.description}</p>
        </div>
      </div>

      ${formData.attachments ? `
      <div class="section">
        <div class="section-title">Attachments</div>
        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
          <p style="margin: 0; font-size: 14px; color: #92400e;">üìé <a href="${formData.attachments}" style="color: #d97706; text-decoration: none; font-weight: 500;">View Attachment</a></p>
        </div>
      </div>
      ` : ''}

      <div style="background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); padding: 16px; border-radius: 8px; margin-top: 24px;">
        <p style="margin: 0; font-size: 13px; color: #86198f; text-align: center;">
          ‚≠ê Take action in your RealtyMind admin dashboard
        </p>
      </div>
    </div>

    <div class="footer">
      <p>¬© ${new Date().getFullYear()} RealtyMind - The Mind Behind Every Deal</p>
      <p style="margin-top: 8px;">Sent from RealtyMind Feedback System</p>
    </div>
  </div>
</body>
</html>
          `
        });
      } catch (emailError) {
        console.error("Error sending admin notification:", emailError);
        // Don't fail the whole operation if email fails
      }
      
      toast.success("Thank you for your feedback! We appreciate your input. üéâ");
      
      // Reset form
      setFormData({
        title: "",
        description: "",
        feedback_type: "improvement",
        category: "general",
        priority: "medium",
        is_anonymous: false,
        attachments: ""
      });
      
      await loadData();
      setShowForm(false);
      
      // Show thank you message
      setTimeout(() => {
        setShowForm(true);
      }, 3000);
    } catch (error) {
      console.error("Error submitting feedback:", error);
      toast.error("Failed to submit feedback. Please try again.");
    }
    setIsSubmitting(false);
  };

  const feedbackTypeConfig = {
    bug_report: { 
      icon: Bug, 
      color: "from-red-500 to-rose-600", 
      label: "Bug Report",
      bg: "bg-red-50",
      text: "text-red-700",
      border: "border-red-200"
    },
    feature_request: { 
      icon: Sparkles, 
      color: "from-purple-500 to-indigo-600", 
      label: "Feature Request",
      bg: "bg-purple-50",
      text: "text-purple-700",
      border: "border-purple-200"
    },
    compliment: { 
      icon: Heart, 
      color: "from-pink-500 to-rose-600", 
      label: "Compliment",
      bg: "bg-pink-50",
      text: "text-pink-700",
      border: "border-pink-200"
    },
    improvement: { 
      icon: TrendingUp, 
      color: "from-blue-500 to-cyan-600", 
      label: "Improvement",
      bg: "bg-blue-50",
      text: "text-blue-700",
      border: "border-blue-200"
    },
    question: { 
      icon: HelpCircle, 
      color: "from-amber-500 to-orange-600", 
      label: "Question",
      bg: "bg-amber-50",
      text: "text-amber-700",
      border: "border-amber-200"
    },
    other: { 
      icon: MessageSquare, 
      color: "from-slate-500 to-gray-600", 
      label: "Other",
      bg: "bg-slate-50",
      text: "text-slate-700",
      border: "border-slate-200"
    }
  };

  const statusConfig = {
    new: { label: "New", color: "bg-blue-100 text-blue-800" },
    reviewing: { label: "Under Review", color: "bg-yellow-100 text-yellow-800" },
    planned: { label: "Planned", color: "bg-purple-100 text-purple-800" },
    in_progress: { label: "In Progress", color: "bg-indigo-100 text-indigo-800" },
    completed: { label: "Completed", color: "bg-green-100 text-green-800" },
    declined: { label: "Declined", color: "bg-gray-100 text-gray-800" }
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
      {/* Header */}
      <div className="app-card p-4">
        <div className="flex items-center gap-4">
          <Button
            variant="ghost"
            size="icon"
            onClick={() => navigate(createPageUrl("Dashboard"))}
            className="rounded-full h-10 w-10"
          >
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div className="flex-1">
            <h1 className="app-title text-2xl mb-1">Feedback & Suggestions</h1>
            <p className="app-subtitle">
              Help us improve PropertySync! Share your ideas, report bugs, or send us a compliment üíú
            </p>
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-3 gap-6">
        {/* Feedback Form */}
        <div className="md:col-span-2">
          {showForm ? (
            <Card className="app-card">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Lightbulb className="w-6 h-6 text-yellow-500" />
                  Share Your Feedback
                </CardTitle>
              </CardHeader>
              <CardContent>
                <form onSubmit={handleSubmit} className="space-y-6">
                  {/* Feedback Type */}
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {Object.entries(feedbackTypeConfig).map(([key, config]) => {
                      const Icon = config.icon;
                      const isSelected = formData.feedback_type === key;
                      return (
                        <button
                          key={key}
                          type="button"
                          onClick={() => setFormData(prev => ({ ...prev, feedback_type: key }))}
                          className={`p-4 rounded-xl border-2 transition-all ${
                            isSelected 
                              ? `${config.border} ${config.bg}` 
                              : 'border-slate-200 hover:border-slate-300'
                          }`}
                        >
                          <Icon className={`w-6 h-6 mx-auto mb-2 ${isSelected ? config.text : 'text-slate-400'}`} />
                          <p className={`text-sm font-medium ${isSelected ? config.text : 'text-slate-600'}`}>
                            {config.label}
                          </p>
                        </button>
                      );
                    })}
                  </div>

                  {/* Title */}
                  <div>
                    <label className="block text-sm font-semibold mb-2">Title *</label>
                    <Input
                      value={formData.title}
                      onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                      placeholder="Brief summary of your feedback"
                      required
                    />
                  </div>

                  {/* Description */}
                  <div>
                    <label className="block text-sm font-semibold mb-2">Description *</label>
                    <Textarea
                      value={formData.description}
                      onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                      placeholder="Tell us more about your feedback, suggestion, or compliment..."
                      rows={6}
                      required
                    />
                  </div>

                  {/* Category & Priority */}
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-semibold mb-2">Category</label>
                      <Select
                        value={formData.category}
                        onValueChange={(value) => setFormData(prev => ({ ...prev, category: value }))}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="general">General</SelectItem>
                          <SelectItem value="properties">Properties</SelectItem>
                          <SelectItem value="tasks">Tasks</SelectItem>
                          <SelectItem value="leads">Leads</SelectItem>
                          <SelectItem value="buyers">Buyers</SelectItem>
                          <SelectItem value="messages">Messages</SelectItem>
                          <SelectItem value="documents">Documents</SelectItem>
                          <SelectItem value="photos">Photos</SelectItem>
                          <SelectItem value="analytics">Analytics</SelectItem>
                          <SelectItem value="ai_tools">AI Tools</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold mb-2">Priority</label>
                      <Select
                        value={formData.priority}
                        onValueChange={(value) => setFormData(prev => ({ ...prev, priority: value }))}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="low">Low</SelectItem>
                          <SelectItem value="medium">Medium</SelectItem>
                          <SelectItem value="high">High</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>

                  {/* File Upload */}
                  <div>
                    <label className="block text-sm font-semibold mb-2">
                      Attachments (Optional)
                      <span className="text-xs font-normal text-slate-500 ml-2">
                        Screenshots or files that help explain
                      </span>
                    </label>
                    <div className="flex items-center gap-3">
                      <Button
                        type="button"
                        variant="outline"
                        disabled={uploadingFile}
                        onClick={() => document.getElementById('feedback-file').click()}
                      >
                        {uploadingFile ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Uploading...
                          </>
                        ) : (
                          <>
                            <Upload className="w-4 h-4 mr-2" />
                            Upload File
                          </>
                        )}
                      </Button>
                      <input
                        id="feedback-file"
                        type="file"
                        onChange={handleFileUpload}
                        className="hidden"
                        accept="image/*,.pdf,.doc,.docx"
                      />
                      {formData.attachments && (
                        <span className="text-sm text-green-600">
                          ‚úì File attached
                        </span>
                      )}
                    </div>
                  </div>

                  {/* Anonymous Option */}
                  <div className="flex items-center gap-3">
                    <input
                      type="checkbox"
                      id="anonymous"
                      checked={formData.is_anonymous}
                      onChange={(e) => setFormData(prev => ({ ...prev, is_anonymous: e.target.checked }))}
                      className="w-4 h-4 rounded border-slate-300"
                    />
                    <label htmlFor="anonymous" className="text-sm text-slate-600">
                      Submit anonymously
                    </label>
                  </div>

                  {/* Submit Button */}
                  <div className="flex justify-end gap-3 pt-4 border-t">
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => navigate(createPageUrl("Dashboard"))}
                    >
                      Cancel
                    </Button>
                    <Button
                      type="submit"
                      disabled={isSubmitting}
                      className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white"
                    >
                      {isSubmitting ? (
                        <>
                          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                          Submitting...
                        </>
                      ) : (
                        <>
                          <Send className="w-4 h-4 mr-2" />
                          Submit Feedback
                        </>
                      )}
                    </Button>
                  </div>
                </form>
              </CardContent>
            </Card>
          ) : (
            <Card className="app-card bg-gradient-to-br from-green-50 to-emerald-50 border-green-200">
              <CardContent className="p-12 text-center">
                <CheckCircle2 className="w-16 h-16 text-green-600 mx-auto mb-4" />
                <h2 className="text-2xl font-bold text-green-900 mb-2">Thank You!</h2>
                <p className="text-green-700 mb-6">
                  Your feedback has been submitted successfully. We'll review it soon! üéâ
                </p>
                <Button
                  onClick={() => setShowForm(true)}
                  variant="outline"
                  className="border-green-600 text-green-600 hover:bg-green-600 hover:text-white"
                >
                  Submit Another
                </Button>
              </CardContent>
            </Card>
          )}
        </div>

        {/* Sidebar */}
        <div className="space-y-6">
          {/* Quick Stats */}
          <Card className="app-card bg-gradient-to-br from-indigo-50 to-purple-50">
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <Star className="w-5 h-5 text-yellow-500" />
                Your Impact
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <div className="flex items-center justify-between mb-1">
                  <span className="text-sm text-slate-600">Total Submissions</span>
                  <span className="text-2xl font-bold text-indigo-600">{feedbacks.length}</span>
                </div>
              </div>
              <div>
                <div className="flex items-center justify-between mb-1">
                  <span className="text-sm text-slate-600">Implemented</span>
                  <span className="text-2xl font-bold text-green-600">
                    {feedbacks.filter(f => f.status === 'completed').length}
                  </span>
                </div>
              </div>
              <div className="pt-4 border-t">
                <p className="text-xs text-slate-500 text-center">
                  Thank you for helping us improve PropertySync! üíú
                </p>
              </div>
            </CardContent>
          </Card>

          {/* Tips */}
          <Card className="app-card">
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <ThumbsUp className="w-5 h-5 text-blue-500" />
                Feedback Tips
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3 text-sm text-slate-600">
                <div className="flex gap-2">
                  <span className="text-indigo-600">‚Ä¢</span>
                  <p>Be specific about what you'd like to see improved</p>
                </div>
                <div className="flex gap-2">
                  <span className="text-indigo-600">‚Ä¢</span>
                  <p>Include screenshots for bug reports when possible</p>
                </div>
                <div className="flex gap-2">
                  <span className="text-indigo-600">‚Ä¢</span>
                  <p>Tell us how a feature would help your workflow</p>
                </div>
                <div className="flex gap-2">
                  <span className="text-indigo-600">‚Ä¢</span>
                  <p>Don't hold back on compliments - they fuel us! üöÄ</p>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>

      {/* Your Previous Feedback */}
      {feedbacks.length > 0 && (
        <Card className="app-card">
          <CardHeader>
            <CardTitle>Your Previous Feedback</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {feedbacks.map((feedback) => {
                const typeConfig = feedbackTypeConfig[feedback.feedback_type] || feedbackTypeConfig.other;
                const Icon = typeConfig.icon;
                const status = statusConfig[feedback.status] || statusConfig.new;

                return (
                  <div
                    key={feedback.id}
                    className="p-4 border rounded-lg hover:shadow-md transition-shadow"
                  >
                    <div className="flex items-start justify-between mb-2">
                      <div className="flex items-center gap-2">
                        <Icon className={`w-5 h-5 ${typeConfig.text}`} />
                        <h3 className="font-semibold">{feedback.title}</h3>
                      </div>
                      <Badge className={status.color}>
                        {status.label}
                      </Badge>
                    </div>
                    <p className="text-sm text-slate-600 mb-2">{feedback.description}</p>
                    <div className="flex items-center gap-4 text-xs text-slate-500">
                      <span>{new Date(feedback.created_date).toLocaleDateString()}</span>
                      <span>Category: {feedback.category}</span>
                      <span>Priority: {feedback.priority}</span>
                    </div>
                    {feedback.admin_response && (
                      <div className="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <p className="text-xs font-semibold text-blue-900 mb-1">Response from Team:</p>
                        <p className="text-sm text-blue-800">{feedback.admin_response}</p>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </CardContent>
        </Card>
      )}
    </div>
    </div>
  );
}
import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  Search,
  Loader2,
  Home,
  MapPin,
  Phone,
  Mail,
  ExternalLink,
  Sparkles,
  TrendingUp,
  AlertCircle,
  Target,
  Clock,
  ArrowLeft,
  Globe,
  Trash2,
  Flame,
  RefreshCw,
  UserX,
  PhoneOff,
  PhoneCall,
  MessageSquare,
  Bell,
  CalendarClock
} from "lucide-react";
import { toast } from "sonner";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { differenceInDays } from "date-fns";

export default function FSBO() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [searchLocation, setSearchLocation] = useState("");
  const [isSearching, setIsSearching] = useState(false);
  const [isRefreshing, setIsRefreshing] = useState(false);

  const { data: user } = useQuery({
    queryKey: ["user"],
    queryFn: () => base44.auth.me()
  });

  const { data: fsboLeads = [], isLoading } = useQuery({
    queryKey: ["fsboLeads"],
    queryFn: () => base44.entities.FSBOLead.list(),
    enabled: !!user
  });

  const { data: fsboActivities = [] } = useQuery({
    queryKey: ["fsboActivities"],
    queryFn: () => base44.entities.FSBOActivity.list(),
    enabled: !!user
  });

  // Get leads that need follow-up (next_followup_date is today or past)
  const leadsNeedingFollowUp = fsboLeads.filter(lead => {
    if (!lead.next_followup_date) return false;
    const followUpDate = new Date(lead.next_followup_date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    followUpDate.setHours(0, 0, 0, 0);
    return followUpDate <= today && lead.status !== 'listing_signed' && lead.status !== 'lost' && lead.status !== 'not_interested';
  });

  const leadsNeedingAttention = fsboLeads.filter(lead => {
    const missingName = !lead.owner_name || lead.owner_name.trim() === "";
    const missingPhone = !lead.owner_phone || lead.owner_phone.trim() === "";
    const isPending = lead.status === "contacted" || lead.status === "interested";
    const isUnderContract = lead.status === "meeting_scheduled" || lead.status === "listing_signed";
    return missingName || missingPhone || isPending || isUnderContract;
  });

  const deleteFSBOMutation = useMutation({
    mutationFn: (leadId) => base44.entities.FSBOLead.delete(leadId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["fsboLeads"] });
      toast.success("FSBO lead deleted");
    }
  });

  const getMotivationLevel = (daysOnMarket) => {
    if (daysOnMarket >= 90) return { level: "Very High", color: "bg-red-500", icon: Flame };
    if (daysOnMarket >= 60) return { level: "High", color: "bg-orange-500", icon: Flame };
    if (daysOnMarket >= 30) return { level: "Medium", color: "bg-yellow-500", icon: TrendingUp };
    return { level: "Low", color: "bg-green-500", icon: Clock };
  };

  const isNewLead = (lead) => {
    const createdDate = new Date(lead.created_date);
    const daysSince = differenceInDays(new Date(), createdDate);
    return daysSince <= 3;
  };

  const generateFallbackData = (location) => {
    const cities = location.includes(',') ? location.split(',')[0].trim() : location.trim();
    const stateMatch = location.match(/\b(FL|CA|TX|NY|AZ)\b/i);
    const state = stateMatch ? stateMatch[1].toUpperCase() : 'FL';
    
    return [
      {
        property_address: `123 Main Street`,
        city: cities,
        state: state,
        zip_code: state === 'FL' ? '33301' : '90001',
        price: 450000,
        bedrooms: 3,
        bathrooms: 2,
        square_feet: 1800,
        year_built: 2015,
        property_type: "single_family",
        listing_source: "fsbo.com",
        listing_url: "https://fsbo.com",
        owner_name: "John Smith",
        owner_phone: "555-0101",
        owner_email: "owner1@example.com",
        days_on_market: 45,
        description: `Beautiful 3 bed, 2 bath home in ${cities}. Great location close to amenities.`
      },
      {
        property_address: `456 Oak Avenue`,
        city: cities,
        state: state,
        zip_code: state === 'FL' ? '33302' : '90002',
        price: 375000,
        bedrooms: 2,
        bathrooms: 2,
        square_feet: 1400,
        year_built: 2018,
        property_type: "condo",
        listing_source: "zillow_fsbo",
        listing_url: "https://zillow.com",
        owner_name: "Mary Johnson",
        owner_phone: "555-0102",
        owner_email: "owner2@example.com",
        days_on_market: 95,
        description: `Modern 2 bed condo in ${cities} with great city views and community pool.`
      },
      {
        property_address: `789 Palm Drive`,
        city: cities,
        state: state,
        zip_code: state === 'FL' ? '33303' : '90003',
        price: 550000,
        bedrooms: 4,
        bathrooms: 3,
        square_feet: 2200,
        year_built: 2012,
        property_type: "single_family",
        listing_source: "craigslist",
        listing_url: "https://craigslist.org",
        owner_name: "Robert Williams",
        owner_phone: "555-0103",
        owner_email: "",
        days_on_market: 15,
        description: `Spacious 4 bed home in ${cities} perfect for a growing family. Large backyard.`
      }
    ];
  };

  const searchFSBOProperties = async () => {
    if (!searchLocation.trim()) {
      toast.error("Please enter a location to search");
      return;
    }

    setIsSearching(true);

    try {
      const prompt = `Find ALL For Sale By Owner (FSBO) properties currently listed in ${searchLocation}.

SEARCH THESE SOURCES THOROUGHLY:
1. FSBO.com - search "${searchLocation}" 
2. Zillow.com - search "${searchLocation}", filter "For Sale by Owner"
3. ForSaleByOwner.com - search "${searchLocation}"
4. Craigslist ${searchLocation} - Real Estate "by owner"
5. Realtor.com - search "${searchLocation}", filter FSBO
6. Homes.com - search "${searchLocation}", filter by owner
7. Facebook Marketplace - "${searchLocation}" property for sale by owner

COLLECT EVERY FSBO LISTING YOU FIND:
- Property address (full street address)
- City, State, ZIP code
- Asking price
- Bedrooms, bathrooms, square feet
- Year built
- Property type (single_family, condo, townhouse, multi_family)
- Owner/seller name (from listing)
- Phone number (look in contact section, description, seller info)
- Email if available
- Days on market or listing date
- Source website and listing URL
- Property description

Return as many FSBO properties as you can find (aim for 10-20+ if available).

JSON format for each:
{
  "property_address": "123 Main St",
  "city": "City Name",
  "state": "ST",
  "zip_code": "12345",
  "price": 350000,
  "bedrooms": 3,
  "bathrooms": 2,
  "square_feet": 1800,
  "year_built": 2010,
  "property_type": "single_family",
  "listing_source": "fsbo.com",
  "listing_url": "https://...",
  "owner_name": "Owner Name",
  "owner_phone": "555-123-4567",
  "owner_email": "email@example.com",
  "days_on_market": 30,
  "description": "Property description..."
}

IMPORTANT: Return ALL active FSBO listings in ${searchLocation}. Include properties even if some contact info is missing - we can research it later. The goal is to find every available FSBO opportunity in this market.`;

      let response;
      try {
        response = await Promise.race([
          base44.integrations.Core.InvokeLLM({
            prompt,
            add_context_from_internet: true,
            response_json_schema: {
              type: "object",
              properties: {
                properties: {
                  type: "array",
                  items: {
                    type: "object",
                    properties: {
                      property_address: { type: "string" },
                      city: { type: "string" },
                      state: { type: "string" },
                      zip_code: { type: "string" },
                      price: { type: "number" },
                      bedrooms: { type: "number" },
                      bathrooms: { type: "number" },
                      square_feet: { type: "number" },
                      year_built: { type: "number" },
                      property_type: { type: "string" },
                      listing_source: { type: "string" },
                      listing_url: { type: "string" },
                      owner_name: { type: "string" },
                      owner_phone: { type: "string" },
                      owner_email: { type: "string" },
                      days_on_market: { type: "number" },
                      description: { type: "string" }
                    }
                  }
                }
              }
            }
          }),
          new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Timeout')), 45000)
          )
        ]);
      } catch (timeoutError) {
        toast.error("Search timed out. Please try again.");
        setIsSearching(false);
        return;
      }

      let properties = [];
      
      if (!response) {
        toast.error("No response from search service. Please try again.");
        setIsSearching(false);
        return;
      }

      if (response.properties && Array.isArray(response.properties)) {
        properties = response.properties;
      } else if (Array.isArray(response)) {
        properties = response;
      } else {
        toast.error("Unexpected response format. Please try again.");
        setIsSearching(false);
        return;
      }
      
      if (properties.length === 0) {
        toast.error("No active FSBO properties found in this area. Try a different location.");
        setIsSearching(false);
        return;
      }
      
      // Include all properties - we'll track which ones need contact info
      const propertiesWithContact = properties.filter(prop => 
        (prop.owner_phone && prop.owner_phone.trim() !== "") || 
        (prop.owner_email && prop.owner_email.trim() !== "")
      );
      const propertiesWithoutContact = properties.filter(prop => 
        (!prop.owner_phone || prop.owner_phone.trim() === "") && 
        (!prop.owner_email || prop.owner_email.trim() === "")
      );
      
      if (propertiesWithoutContact.length > 0) {
        toast.info(`Found ${properties.length} FSBOs (${propertiesWithContact.length} with contact info, ${propertiesWithoutContact.length} need research)`);
      }
      
      // Save all properties to database
      const savedLeads = await Promise.all(
        properties.map(async (prop, index) => {
          // Ensure numeric fields are properly parsed
          const cleanedProp = {
            ...prop,
            price: typeof prop.price === 'string' ? parseFloat(prop.price.replace(/[^0-9.]/g, '')) || 0 : (prop.price || 0),
            bedrooms: typeof prop.bedrooms === 'string' ? parseInt(prop.bedrooms) || 0 : (prop.bedrooms || 0),
            bathrooms: typeof prop.bathrooms === 'string' ? parseFloat(prop.bathrooms) || 0 : (prop.bathrooms || 0),
            square_feet: typeof prop.square_feet === 'string' ? parseInt(prop.square_feet.replace(/[^0-9]/g, '')) || 0 : (prop.square_feet || 0),
            year_built: typeof prop.year_built === 'string' ? parseInt(prop.year_built) || null : (prop.year_built || null),
            days_on_market: typeof prop.days_on_market === 'string' ? parseInt(prop.days_on_market) || 0 : (prop.days_on_market || 0)
          };
          
          try {
            if (index < 2) {
              const intelligence = await base44.integrations.Core.InvokeLLM({
                prompt: `Brief analysis of FSBO at ${prop.property_address} for $${prop.price}: market value estimate, top 3 selling points, top 2 concerns, contact approach.`,
                response_json_schema: {
                  type: "object",
                  properties: {
                    market_value: { type: "string" },
                    selling_points: { type: "array", items: { type: "string" } },
                    concerns: { type: "array", items: { type: "string" } },
                    recommended_strategy: { type: "string" }
                  }
                }
              });

              return await base44.entities.FSBOLead.create({
                ...cleanedProp,
                ai_intelligence: JSON.stringify({
                  ...intelligence,
                  pricing_analysis: `Estimated market value is ${intelligence.market_value}.`,
                  estimated_commission: `$${(cleanedProp.price * 0.025).toFixed(0)} - $${(cleanedProp.price * 0.03).toFixed(0)}`
                }),
                status: "new",
                contact_attempts: 0,
                assigned_agent_id: user?.id
              });
            } else {
              return await base44.entities.FSBOLead.create({
                ...cleanedProp,
                ai_intelligence: JSON.stringify({
                  market_value: `$${Math.round(cleanedProp.price * 0.95).toLocaleString()} - $${Math.round(cleanedProp.price * 1.05).toLocaleString()}`,
                  selling_points: ["Good location", "Potentially negotiable price", "Direct owner contact"],
                  concerns: ["Owner inexperienced", "Limited exposure"],
                  recommended_strategy: "Offer free market analysis",
                  estimated_commission: `$${(cleanedProp.price * 0.025).toFixed(0)} - $${(cleanedProp.price * 0.03).toFixed(0)}`
                }),
                status: "new",
                contact_attempts: 0,
                assigned_agent_id: user?.id
              });
            }
          } catch (error) {
            return await base44.entities.FSBOLead.create({
              ...cleanedProp,
              ai_intelligence: JSON.stringify({
                market_value: "Analysis pending",
                selling_points: ["Active FSBO", "Owner motivated"],
                concerns: ["Limited exposure", "Potential pitfalls"],
                recommended_strategy: "Discuss professional services",
                estimated_commission: `$${(cleanedProp.price * 0.025).toFixed(0)} - $${(cleanedProp.price * 0.03).toFixed(0)}`
              }),
              status: "new",
              contact_attempts: 0,
              assigned_agent_id: user?.id
            });
          }
        })
      );

      queryClient.invalidateQueries({ queryKey: ["fsboLeads"] });
      toast.success(`Found and saved ${savedLeads.length} FSBO properties`);
      
    } catch (error) {
      console.error("Error searching FSBO properties:", error);
      toast.error("Search failed");
    }

    setIsSearching(false);
  };

  const refreshAllLeads = async () => {
    if (!fsboLeads.length) return;
    
    setIsRefreshing(true);
    toast.info(`Refreshing ${fsboLeads.length} FSBO leads...`);
    
    try {
      // Get unique locations from existing leads
      const locations = [...new Set(fsboLeads.map(lead => `${lead.city}, ${lead.state}`))];
      
      for (const location of locations) {
        const leadsInLocation = fsboLeads.filter(l => `${l.city}, ${l.state}` === location);
        
        try {
          const prompt = `Check if these properties are STILL active FSBO in ${location}: ${leadsInLocation.map(l => l.property_address).join(', ')}

Search FSBO.com, Zillow FSBO section, Craigslist "by owner" in ${location}.

FOR EACH PROPERTY:
1. Is status "Active" or "For Sale"? (if Sold/Pending ‚Üí SKIP)
2. Does it say "Listed by: Property Owner"? (if agent ‚Üí SKIP)
3. Is listing date recent (last 6 months)? (if old ‚Üí SKIP)
4. Is phone visible in contact section? (if no ‚Üí SKIP)

If ALL YES ‚Üí include updated data
If ANY NO ‚Üí skip (will be marked off market)

Return:
{
  "property_address": "exact",
  "owner_phone": "from contact",
  "owner_name": "from Listed by",
  "price": current,
  "days_on_market": current,
  "listing_url": "URL"
}

Only return ACTIVE FSBO properties with phones.`;

          const response = await Promise.race([
            base44.integrations.Core.InvokeLLM({
              prompt,
              add_context_from_internet: true,
              response_json_schema: {
                type: "object",
                properties: {
                  properties: {
                    type: "array",
                    items: {
                      type: "object",
                      properties: {
                        property_address: { type: "string" },
                        city: { type: "string" },
                        state: { type: "string" },
                        zip_code: { type: "string" },
                        price: { type: "number" },
                        bedrooms: { type: "number" },
                        bathrooms: { type: "number" },
                        square_feet: { type: "number" },
                        year_built: { type: "number" },
                        property_type: { type: "string" },
                        listing_source: { type: "string" },
                        listing_url: { type: "string" },
                        owner_name: { type: "string" },
                        owner_phone: { type: "string" },
                        owner_email: { type: "string" },
                        days_on_market: { type: "number" },
                        description: { type: "string" }
                      }
                    }
                  }
                }
              }
            }),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error('Timeout')), 30000)
            )
          ]);

          const properties = response?.properties || [];
          const foundAddresses = new Set();
          
          // Update existing leads with new information
          for (const prop of properties) {
            const existingLead = leadsInLocation.find(l => 
              l.property_address.toLowerCase().includes(prop.property_address.toLowerCase()) ||
              prop.property_address.toLowerCase().includes(l.property_address.toLowerCase())
            );
            
            if (existingLead) {
              foundAddresses.add(existingLead.id);
              await base44.entities.FSBOLead.update(existingLead.id, {
                price: prop.price || existingLead.price,
                days_on_market: prop.days_on_market || existingLead.days_on_market,
                owner_name: prop.owner_name || existingLead.owner_name,
                owner_phone: prop.owner_phone || existingLead.owner_phone,
                owner_email: prop.owner_email || existingLead.owner_email,
                listing_url: prop.listing_url || existingLead.listing_url,
                description: prop.description || existingLead.description,
                status: existingLead.status === 'lost' ? existingLead.status : 'new'
              });
            }
          }
          
          // Mark properties not found as off market
          for (const lead of leadsInLocation) {
            if (!foundAddresses.has(lead.id) && lead.status !== 'listing_signed') {
              await base44.entities.FSBOLead.update(lead.id, {
                status: 'lost',
                notes: (lead.notes || '') + `\n[${new Date().toLocaleDateString()}] Property no longer appears in FSBO listings - marked as off market.`
              });
            }
          }
        } catch (error) {
          console.error(`Error refreshing leads in ${location}:`, error);
        }
      }
      
      queryClient.invalidateQueries({ queryKey: ["fsboLeads"] });
      toast.success("FSBO leads refreshed with latest information!");
      
    } catch (error) {
      console.error("Error refreshing leads:", error);
      toast.error("Failed to refresh some leads");
    }
    
    setIsRefreshing(false);
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <Loader2 className="w-8 h-8 animate-spin text-orange-600" />
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-4">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center gap-4 mb-4">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => navigate(-1)}
                className="rounded-full"
              >
                <ArrowLeft className="w-5 h-5" />
              </Button>
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-600 to-red-600 flex items-center justify-center">
                <Target className="w-6 h-6 text-white" />
              </div>
              <div className="flex-1">
                <h1 className="text-2xl font-bold">FSBO Lead Finder</h1>
                <p className="text-slate-600 dark:text-slate-400">Find For Sale By Owner properties</p>
              </div>
            </div>

            <div className="flex gap-3">
              <div className="relative flex-1">
                <MapPin className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" />
                <Input
                  placeholder="Enter city or neighborhood (e.g., 'Fort Lauderdale, FL')"
                  value={searchLocation}
                  onChange={(e) => setSearchLocation(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && searchFSBOProperties()}
                  className="pl-10"
                />
              </div>
              <Button
                onClick={searchFSBOProperties}
                disabled={isSearching || !searchLocation.trim()}
                className="bg-gradient-to-r from-orange-600 to-red-600"
              >
                {isSearching ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Searching...
                  </>
                ) : (
                  <>
                    <Search className="w-4 h-4 mr-2" />
                    Find FSBOs
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-r from-orange-50 to-red-50 border-orange-200">
          <CardContent className="p-4">
            <div className="flex items-start gap-3">
              <Globe className="w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5" />
              <div>
                <h3 className="font-semibold text-slate-900 mb-1">Real FSBO Data</h3>
                <p className="text-sm text-slate-600">
                  Searches FSBO.com, Zillow, Craigslist, and Facebook for actual listings. New searches add to your saved list.
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        {isSearching && (
          <Card>
            <CardContent className="p-12 text-center">
              <Loader2 className="w-12 h-12 mx-auto mb-4 animate-spin text-orange-600" />
              <h3 className="text-xl font-semibold mb-2">Searching FSBO Websites...</h3>
              <p className="text-slate-600">
                Scanning listings in {searchLocation}
              </p>
            </CardContent>
          </Card>
        )}

        {fsboLeads.length > 0 && !isSearching && (
          <div>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold">{fsboLeads.length} FSBO Leads</h2>
              <Button
                variant="outline"
                size="sm"
                onClick={refreshAllLeads}
                disabled={isRefreshing}
              >
                <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                {isRefreshing ? 'Updating...' : 'Refresh All'}
              </Button>
            </div>

            {/* CRITICAL: Follow-up Reminders */}
            {leadsNeedingFollowUp.length > 0 && (
              <Card className="mb-4 border-2 border-red-400 bg-gradient-to-r from-red-50 to-orange-50 animate-pulse">
                <CardHeader className="pb-2">
                  <CardTitle className="flex items-center gap-2 text-red-900">
                    <Bell className="w-5 h-5 text-red-600" />
                    üî• {leadsNeedingFollowUp.length} CRITICAL Follow-Up{leadsNeedingFollowUp.length !== 1 ? 's' : ''} Due
                  </CardTitle>
                  <p className="text-sm text-red-700">These leads require immediate attention - don't lose the opportunity!</p>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    {leadsNeedingFollowUp.map(lead => {
                      const lastActivity = fsboActivities
                        .filter(a => a.fsbo_lead_id === lead.id)
                        .sort((a, b) => new Date(b.created_date) - new Date(a.created_date))[0];
                      const daysSinceFollowUp = lead.next_followup_date 
                        ? differenceInDays(new Date(), new Date(lead.next_followup_date))
                        : 0;
                      
                      return (
                        <div
                          key={lead.id}
                          className="bg-white rounded-lg p-4 border-l-4 border-red-500 hover:shadow-lg transition-all cursor-pointer"
                          onClick={() => navigate(createPageUrl(`FSBODetail?id=${lead.id}`))}
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <h4 className="font-bold text-slate-900">{lead.property_address}</h4>
                                {daysSinceFollowUp > 0 && (
                                  <Badge className="bg-red-600 text-white text-xs animate-pulse">
                                    {daysSinceFollowUp} day{daysSinceFollowUp !== 1 ? 's' : ''} OVERDUE
                                  </Badge>
                                )}
                              </div>
                              <p className="text-sm text-slate-600 mb-2">
                                {lead.city}, {lead.state} ‚Ä¢ ${(lead.price / 1000).toFixed(0)}K
                              </p>
                              <div className="flex items-center gap-3 text-xs text-slate-500">
                                <span className="flex items-center gap-1">
                                  <Phone className="w-3 h-3" />
                                  {lead.owner_phone || 'No phone'}
                                </span>
                                <span className="flex items-center gap-1">
                                  <CalendarClock className="w-3 h-3" />
                                  Due: {new Date(lead.next_followup_date).toLocaleDateString()}
                                </span>
                                {lastActivity && (
                                  <span className="flex items-center gap-1">
                                    <MessageSquare className="w-3 h-3" />
                                    Last: {lastActivity.activity_type} ({lastActivity.outcome})
                                  </span>
                                )}
                              </div>
                            </div>
                            <div className="flex gap-2">
                              {lead.owner_phone && (
                                <Button 
                                  size="sm" 
                                  className="bg-green-600 hover:bg-green-700"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    window.open(`tel:${lead.owner_phone}`);
                                  }}
                                >
                                  <PhoneCall className="w-4 h-4" />
                                </Button>
                              )}
                              <Button 
                                size="sm" 
                                variant="outline"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  navigate(createPageUrl(`FSBODetail?id=${lead.id}`));
                                }}
                              >
                                View
                              </Button>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </CardContent>
              </Card>
            )}

            {leadsNeedingAttention.length > 0 && (
              <Card className="mb-4 border-2 border-orange-300 bg-orange-50">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2 text-orange-900">
                    <AlertCircle className="w-5 h-5" />
                    {leadsNeedingAttention.length} Lead{leadsNeedingAttention.length !== 1 ? 's' : ''} Need Attention
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2">
                    {leadsNeedingAttention.map(lead => {
                      const missingInfo = [];
                      if (!lead.owner_name || lead.owner_name.trim() === "") missingInfo.push("name");
                      if (!lead.owner_phone || lead.owner_phone.trim() === "") missingInfo.push("phone");
                      
                      return (
                        <div
                          key={lead.id}
                          className="bg-white rounded-lg p-3 flex items-center justify-between hover:shadow-md transition-shadow cursor-pointer"
                          onClick={() => navigate(createPageUrl(`FSBODetail?id=${lead.id}`))}
                        >
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <h4 className="font-semibold text-slate-900">{lead.property_address}</h4>
                              <Badge variant="outline" className="capitalize">
                                {lead.status.replace(/_/g, ' ')}
                              </Badge>
                            </div>
                            <p className="text-sm text-slate-600">
                              {lead.city}, {lead.state}
                            </p>
                            {missingInfo.length > 0 && (
                              <div className="flex items-center gap-2 mt-2">
                                {missingInfo.includes("name") && (
                                  <Badge className="bg-red-100 text-red-800 text-xs flex items-center gap-1">
                                    <UserX className="w-3 h-3" />
                                    Missing Name
                                  </Badge>
                                )}
                                {missingInfo.includes("phone") && (
                                  <Badge className="bg-red-100 text-red-800 text-xs flex items-center gap-1">
                                    <PhoneOff className="w-3 h-3" />
                                    Missing Phone
                                  </Badge>
                                )}
                              </div>
                            )}
                            {(lead.status === "contacted" || lead.status === "interested") && (
                              <Badge className="bg-yellow-100 text-yellow-800 text-xs mt-2">
                                Pending Follow-up
                              </Badge>
                            )}
                            {(lead.status === "meeting_scheduled" || lead.status === "listing_signed") && (
                              <Badge className="bg-green-100 text-green-800 text-xs mt-2">
                                Under Contract
                              </Badge>
                            )}
                          </div>
                          <Button size="sm" variant="outline">
                            Update
                          </Button>
                        </div>
                      );
                    })}
                  </div>
                </CardContent>
              </Card>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {fsboLeads.map((lead) => {
                const intelligence = lead.ai_intelligence ? JSON.parse(lead.ai_intelligence) : null;
                const motivation = getMotivationLevel(lead.days_on_market || 0);
                const MotivationIcon = motivation.icon;
                const isNew = isNewLead(lead);
                
                return (
                  <Card
                    key={lead.id}
                    className="hover:shadow-xl transition-all border-2 border-slate-200 hover:border-orange-500 relative"
                  >
                    <div className="relative h-48 overflow-hidden cursor-pointer" onClick={() => navigate(createPageUrl(`FSBODetail?id=${lead.id}`))}>
                      <div className="w-full h-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center">
                        <Home className="w-16 h-16 text-slate-300" />
                      </div>
                      
                      {isNew && (
                        <div className="absolute top-3 left-3 bg-green-500 text-white px-2 py-1 rounded-lg text-xs font-bold animate-pulse">
                          NEW
                        </div>
                      )}

                      <div className="absolute top-3 right-3 bg-white px-3 py-1.5 rounded-lg shadow-lg">
                        <span className="text-lg font-bold text-slate-900">
                          ${((lead.price || 0) / 1000).toFixed(0)}K
                        </span>
                      </div>

                      <div className={`absolute bottom-3 left-3 ${motivation.color} text-white px-2 py-1 rounded-lg text-xs font-semibold flex items-center gap-1`}>
                        <MotivationIcon className="w-3 h-3" />
                        {lead.days_on_market} days ‚Ä¢ {motivation.level} motivation
                      </div>
                    </div>

                    <CardContent className="p-4">
                      <div className="flex items-start justify-between mb-2">
                        <div className="flex-1">
                          <h3 className="font-bold text-lg truncate cursor-pointer" onClick={() => navigate(createPageUrl(`FSBODetail?id=${lead.id}`))}>
                            {lead.property_address}
                          </h3>
                          <Badge className={
                            lead.status === 'new' ? 'bg-blue-100 text-blue-800 text-xs' :
                            lead.status === 'contacted' ? 'bg-yellow-100 text-yellow-800 text-xs' :
                            lead.status === 'interested' ? 'bg-green-100 text-green-800 text-xs' :
                            lead.status === 'not_interested' ? 'bg-red-100 text-red-800 text-xs' :
                            lead.status === 'lost' ? 'bg-slate-500 text-white text-xs' :
                            'bg-slate-100 text-slate-800 text-xs'
                          }>
                            {lead.status === 'lost' ? 'üö´ OFF MARKET' : lead.status.replace(/_/g, ' ').toUpperCase()}
                          </Badge>
                        </div>
                        <Button
                          variant="ghost"
                          size="icon"
                          className="text-red-500 hover:text-red-700 hover:bg-red-50 h-8 w-8"
                          onClick={(e) => {
                            e.stopPropagation();
                            if (confirm('Delete this FSBO lead?')) {
                              deleteFSBOMutation.mutate(lead.id);
                            }
                          }}
                        >
                          <Trash2 className="w-4 h-4" />
                        </Button>
                      </div>
                      <p className="text-sm text-slate-600 mb-3">
                        {lead.city}, {lead.state} {lead.zip_code}
                      </p>

                      <div className="flex gap-4 text-sm mb-3">
                        <span>{lead.bedrooms} bed</span>
                        <span>{lead.bathrooms} bath</span>
                        <span>{((lead.square_feet || 0) / 1000).toFixed(1)}K sqft</span>
                      </div>

                      <div className="border-t pt-3 mb-3 space-y-1">
                        <div className="flex items-center gap-2 text-sm">
                          <span className="font-semibold text-slate-700">Owner:</span>
                          <span>{lead.owner_name}</span>
                        </div>
                        {lead.owner_phone && (
                          <div className="flex items-center gap-2 text-xs text-slate-600">
                            <Phone className="w-3 h-3 text-green-600" />
                            <span className="font-semibold">{lead.owner_phone}</span>
                          </div>
                        )}
                        {lead.owner_email && (
                          <div className="flex items-center gap-2 text-xs text-slate-600">
                            <Mail className="w-3 h-3 text-blue-600" />
                            <span className="truncate font-semibold">{lead.owner_email}</span>
                          </div>
                        )}
                        {lead.listing_url && (
                          <a
                            href={lead.listing_url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="flex items-center gap-2 text-xs text-blue-600 hover:text-blue-800 hover:underline"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <ExternalLink className="w-3 h-3" />
                            <span className="font-semibold">View on {lead.listing_source}</span>
                          </a>
                        )}
                      </div>

                      {intelligence && (
                        <div className="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-3 mb-3">
                          <div className="flex items-center gap-2 mb-2">
                            <Sparkles className="w-4 h-4 text-purple-600" />
                            <span className="text-xs font-semibold text-purple-900">AI Analysis</span>
                          </div>
                          <p className="text-xs text-slate-700 line-clamp-2">
                            {intelligence.recommended_strategy}
                          </p>
                        </div>
                      )}

                      <Button 
                        className="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700"
                        onClick={() => navigate(createPageUrl(`FSBODetail?id=${lead.id}`))}
                      >
                        <Target className="w-4 h-4 mr-2" />
                        View Details & Call Script
                      </Button>
                    </CardContent>
                  </Card>
                );
              })}
            </div>
          </div>
        )}

        {!isSearching && fsboLeads.length === 0 && (
          <Card>
            <CardContent className="p-12 text-center">
              <Target className="w-16 h-16 mx-auto mb-4 text-slate-300" />
              <h2 className="text-2xl font-bold text-slate-900 mb-2">Find FSBO Opportunities</h2>
              <p className="text-slate-600 mb-6 max-w-md mx-auto">
                Search for For Sale By Owner properties and get instant AI insights, contact info, and call scripts.
              </p>
              <div className="flex flex-wrap gap-2 justify-center">
                <Badge variant="outline" className="py-2 px-4 flex items-center gap-1">
                  <Globe className="w-3 h-3" />
                  Real Data
                </Badge>
                <Badge variant="outline" className="py-2 px-4">Market Analysis</Badge>
                <Badge variant="outline" className="py-2 px-4">Call Scripts</Badge>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}
import React, { useState, useMemo } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  LineChart,
  Line,
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer
} from "recharts";
import {
  TrendingUp,
  Target,
  Clock,
  DollarSign,
  MapPin,
  Loader2,
  Filter,
  BarChart3,
  Flame,
  AlertCircle,
  CheckCircle2
} from "lucide-react";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { differenceInDays } from "date-fns";

const COLORS = ['#f97316', '#ef4444', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6'];

export default function FSBOAnalytics() {
  const [locationFilter, setLocationFilter] = useState("all");
  const [sourceFilter, setSourceFilter] = useState("all");
  const [motivationFilter, setMotivationFilter] = useState("all");

  const { data: leads = [], isLoading } = useQuery({
    queryKey: ["fsboLeads"],
    queryFn: () => base44.entities.FSBOLead.list()
  });

  const analytics = useMemo(() => {
    if (!leads.length) return null;

    // Calculate conversion rate
    const converted = leads.filter(l => l.status === "listing_signed").length;
    const conversionRate = ((converted / leads.length) * 100).toFixed(1);

    // Average time to convert
    const convertedLeads = leads.filter(l => l.status === "listing_signed" && l.last_contact_date);
    const avgTimeToConvert = convertedLeads.length > 0
      ? Math.round(
          convertedLeads.reduce((acc, l) => {
            const created = new Date(l.created_date);
            const converted = new Date(l.last_contact_date);
            return acc + differenceInDays(converted, created);
          }, 0) / convertedLeads.length
        )
      : 0;

    // Lead source performance
    const sourcePerformance = {};
    leads.forEach(lead => {
      const source = lead.listing_source || "other";
      if (!sourcePerformance[source]) {
        sourcePerformance[source] = { total: 0, converted: 0, contacted: 0 };
      }
      sourcePerformance[source].total++;
      if (lead.status === "listing_signed") sourcePerformance[source].converted++;
      if (lead.contact_attempts > 0) sourcePerformance[source].contacted++;
    });

    // Location performance
    const locationPerformance = {};
    leads.forEach(lead => {
      const location = `${lead.city}, ${lead.state}`;
      if (!locationPerformance[location]) {
        locationPerformance[location] = { total: 0, avgPrice: 0, converted: 0 };
      }
      locationPerformance[location].total++;
      locationPerformance[location].avgPrice += lead.price || 0;
      if (lead.status === "listing_signed") locationPerformance[location].converted++;
    });

    Object.keys(locationPerformance).forEach(loc => {
      locationPerformance[loc].avgPrice = Math.round(
        locationPerformance[loc].avgPrice / locationPerformance[loc].total
      );
    });

    // Status distribution
    const statusDist = {};
    leads.forEach(lead => {
      statusDist[lead.status] = (statusDist[lead.status] || 0) + 1;
    });

    // Motivation levels
    const motivationDist = { low: 0, medium: 0, high: 0, very_high: 0 };
    leads.forEach(lead => {
      const days = lead.days_on_market || 0;
      if (days >= 90) motivationDist.very_high++;
      else if (days >= 60) motivationDist.high++;
      else if (days >= 30) motivationDist.medium++;
      else motivationDist.low++;
    });

    // Timeline data - leads created over time
    const timelineData = {};
    leads.forEach(lead => {
      const date = new Date(lead.created_date).toISOString().split('T')[0];
      timelineData[date] = (timelineData[date] || 0) + 1;
    });

    // Estimated commission potential
    const potentialCommission = leads
      .filter(l => l.status !== "lost" && l.status !== "not_interested")
      .reduce((acc, l) => acc + (l.price || 0) * 0.03, 0);

    return {
      conversionRate,
      avgTimeToConvert,
      totalLeads: leads.length,
      activeLeads: leads.filter(l => l.status === "new" || l.status === "contacted" || l.status === "interested").length,
      converted,
      sourcePerformance: Object.entries(sourcePerformance).map(([source, data]) => ({
        source,
        ...data,
        conversionRate: data.total > 0 ? ((data.converted / data.total) * 100).toFixed(1) : 0
      })),
      locationPerformance: Object.entries(locationPerformance).map(([location, data]) => ({
        location,
        ...data,
        conversionRate: data.total > 0 ? ((data.converted / data.total) * 100).toFixed(1) : 0
      })),
      statusData: Object.entries(statusDist).map(([name, value]) => ({ name, value })),
      motivationData: [
        { name: "Low (<30 days)", value: motivationDist.low },
        { name: "Medium (30-59)", value: motivationDist.medium },
        { name: "High (60-89)", value: motivationDist.high },
        { name: "Very High (90+)", value: motivationDist.very_high }
      ],
      timelineData: Object.entries(timelineData)
        .sort((a, b) => a[0].localeCompare(b[0]))
        .map(([date, count]) => ({ date, count })),
      potentialCommission
    };
  }, [leads]);

  const filteredLeads = useMemo(() => {
    return leads.filter(lead => {
      if (locationFilter !== "all" && `${lead.city}, ${lead.state}` !== locationFilter) return false;
      if (sourceFilter !== "all" && lead.listing_source !== sourceFilter) return false;
      
      if (motivationFilter !== "all") {
        const days = lead.days_on_market || 0;
        if (motivationFilter === "very_high" && days < 90) return false;
        if (motivationFilter === "high" && (days < 60 || days >= 90)) return false;
        if (motivationFilter === "medium" && (days < 30 || days >= 60)) return false;
        if (motivationFilter === "low" && days >= 30) return false;
      }
      
      return true;
    });
  }, [leads, locationFilter, sourceFilter, motivationFilter]);

  const uniqueLocations = useMemo(() => {
    return [...new Set(leads.map(l => `${l.city}, ${l.state}`))];
  }, [leads]);

  const uniqueSources = useMemo(() => {
    return [...new Set(leads.map(l => l.listing_source))];
  }, [leads]);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-96">
        <Loader2 className="w-12 h-12 animate-spin text-orange-600" />
      </div>
    );
  }

  if (!leads.length) {
    return (
      <div className="page-container">
        <Card>
          <CardContent className="p-12 text-center">
            <BarChart3 className="w-16 h-16 mx-auto mb-4 text-slate-300" />
            <h2 className="text-2xl font-bold mb-2">No FSBO Data Yet</h2>
            <p className="text-slate-600">Start searching for FSBO properties to see analytics</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">FSBO Analytics</h1>
            <p className="text-slate-600">Performance metrics and insights</p>
          </div>
        </div>

        {/* Key Metrics */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-600">Conversion Rate</span>
                <TrendingUp className="w-5 h-5 text-green-600" />
              </div>
              <div className="text-3xl font-bold text-green-600">{analytics.conversionRate}%</div>
              <p className="text-xs text-slate-500 mt-1">
                {analytics.converted} of {analytics.totalLeads} leads converted
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-600">Avg Time to Convert</span>
                <Clock className="w-5 h-5 text-blue-600" />
              </div>
              <div className="text-3xl font-bold text-blue-600">{analytics.avgTimeToConvert} days</div>
              <p className="text-xs text-slate-500 mt-1">From first contact to listing signed</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-600">Active Leads</span>
                <Target className="w-5 h-5 text-orange-600" />
              </div>
              <div className="text-3xl font-bold text-orange-600">{analytics.activeLeads}</div>
              <p className="text-xs text-slate-500 mt-1">New, contacted, or interested</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-600">Potential Commission</span>
                <DollarSign className="w-5 h-5 text-purple-600" />
              </div>
              <div className="text-3xl font-bold text-purple-600">
                ${(analytics.potentialCommission / 1000).toFixed(0)}K
              </div>
              <p className="text-xs text-slate-500 mt-1">From active pipeline</p>
            </CardContent>
          </Card>
        </div>

        {/* Filters */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Filter className="w-5 h-5" />
              Filter Leads
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="text-sm font-medium mb-2 block">Location</label>
                <Select value={locationFilter} onValueChange={setLocationFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Locations</SelectItem>
                    {uniqueLocations.map(loc => (
                      <SelectItem key={loc} value={loc}>{loc}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div>
                <label className="text-sm font-medium mb-2 block">Source</label>
                <Select value={sourceFilter} onValueChange={setSourceFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Sources</SelectItem>
                    {uniqueSources.map(source => (
                      <SelectItem key={source} value={source}>{source}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div>
                <label className="text-sm font-medium mb-2 block">Motivation Level</label>
                <Select value={motivationFilter} onValueChange={setMotivationFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Levels</SelectItem>
                    <SelectItem value="very_high">Very High (90+ days)</SelectItem>
                    <SelectItem value="high">High (60-89 days)</SelectItem>
                    <SelectItem value="medium">Medium (30-59 days)</SelectItem>
                    <SelectItem value="low">Low (&lt;30 days)</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="mt-4 flex items-center gap-2">
              <span className="text-sm text-slate-600">
                Showing {filteredLeads.length} of {leads.length} leads
              </span>
              {(locationFilter !== "all" || sourceFilter !== "all" || motivationFilter !== "all") && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    setLocationFilter("all");
                    setSourceFilter("all");
                    setMotivationFilter("all");
                  }}
                >
                  Clear Filters
                </Button>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Charts Row 1 */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Lead Source Performance */}
          <Card>
            <CardHeader>
              <CardTitle>Lead Source Performance</CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={analytics.sourcePerformance}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="source" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="total" fill="#f97316" name="Total Leads" />
                  <Bar dataKey="converted" fill="#22c55e" name="Converted" />
                  <Bar dataKey="contacted" fill="#3b82f6" name="Contacted" />
                </BarChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          {/* Status Distribution */}
          <Card>
            <CardHeader>
              <CardTitle>Lead Status Distribution</CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={analytics.statusData}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
                    outerRadius={80}
                    fill="#8884d8"
                    dataKey="value"
                  >
                    {analytics.statusData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>

        {/* Charts Row 2 */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Motivation Distribution */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Flame className="w-5 h-5 text-orange-600" />
                Seller Motivation Levels
              </CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={analytics.motivationData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="value" fill="#ef4444" />
                </BarChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          {/* Lead Timeline */}
          <Card>
            <CardHeader>
              <CardTitle>Lead Generation Timeline</CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={analytics.timelineData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="date" />
                  <YAxis />
                  <Tooltip />
                  <Line type="monotone" dataKey="count" stroke="#f97316" strokeWidth={2} />
                </LineChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>

        {/* Location Performance Table */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <MapPin className="w-5 h-5" />
              Performance by Location
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left p-3">Location</th>
                    <th className="text-right p-3">Total Leads</th>
                    <th className="text-right p-3">Converted</th>
                    <th className="text-right p-3">Conversion Rate</th>
                    <th className="text-right p-3">Avg Price</th>
                  </tr>
                </thead>
                <tbody>
                  {analytics.locationPerformance
                    .sort((a, b) => b.total - a.total)
                    .map(loc => (
                      <tr key={loc.location} className="border-b hover:bg-slate-50">
                        <td className="p-3 font-medium">{loc.location}</td>
                        <td className="text-right p-3">{loc.total}</td>
                        <td className="text-right p-3">{loc.converted}</td>
                        <td className="text-right p-3">
                          <Badge className={
                            loc.conversionRate >= 10 ? "bg-green-100 text-green-800" :
                            loc.conversionRate >= 5 ? "bg-yellow-100 text-yellow-800" :
                            "bg-slate-100 text-slate-800"
                          }>
                            {loc.conversionRate}%
                          </Badge>
                        </td>
                        <td className="text-right p-3 font-semibold">
                          ${(loc.avgPrice / 1000).toFixed(0)}K
                        </td>
                      </tr>
                    ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>

        {/* AI Insights Summary */}
        <Card className="border-2 border-purple-200">
          <CardHeader className="bg-gradient-to-r from-purple-50 to-pink-50">
            <CardTitle className="flex items-center gap-2">
              <AlertCircle className="w-5 h-5 text-purple-600" />
              Key Insights
            </CardTitle>
          </CardHeader>
          <CardContent className="p-6">
            <div className="space-y-3">
              {analytics.conversionRate > 10 && (
                <div className="flex items-start gap-3 p-3 bg-green-50 rounded-lg">
                  <CheckCircle2 className="w-5 h-5 text-green-600 mt-0.5" />
                  <div>
                    <p className="font-semibold text-green-900">Strong Performance</p>
                    <p className="text-sm text-green-700">
                      Your {analytics.conversionRate}% conversion rate is above industry average
                    </p>
                  </div>
                </div>
              )}

              {analytics.motivationData.find(m => m.name.includes("Very High"))?.value > 0 && (
                <div className="flex items-start gap-3 p-3 bg-orange-50 rounded-lg">
                  <Flame className="w-5 h-5 text-orange-600 mt-0.5" />
                  <div>
                    <p className="font-semibold text-orange-900">High Motivation Leads</p>
                    <p className="text-sm text-orange-700">
                      {analytics.motivationData.find(m => m.name.includes("Very High")).value} leads have been on market 90+ days - prime for conversion
                    </p>
                  </div>
                </div>
              )}

              {analytics.activeLeads > 0 && (
                <div className="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                  <Target className="w-5 h-5 text-blue-600 mt-0.5" />
                  <div>
                    <p className="font-semibold text-blue-900">Active Pipeline</p>
                    <p className="text-sm text-blue-700">
                      {analytics.activeLeads} active leads worth ${(analytics.potentialCommission / 1000).toFixed(0)}K in potential commission
                    </p>
                  </div>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import {
  ArrowLeft,
  Home,
  DollarSign,
  Phone,
  Mail,
  Calendar,
  Target,
  Sparkles,
  TrendingUp,
  AlertCircle,
  CheckCircle2,
  Save,
  Loader2,
  MessageSquare,
  ClipboardList,
  PhoneCall,
  Bell,
  CalendarClock,
  CalendarPlus
} from "lucide-react";
import { toast } from "sonner";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { attomPropertyData } from "@/api/functions";

export default function FSBODetail() {
  const navigate = useNavigate();
  const urlParams = new URLSearchParams(window.location.search);
  const leadId = urlParams.get("id");

  const [lead, setLead] = useState(null);
  const [intelligence, setIntelligence] = useState(null);
  const [callScript, setCallScript] = useState(null);
  const [activities, setActivities] = useState([]);
  const [taxRecordInfo, setTaxRecordInfo] = useState(null);
  const [attomData, setAttomData] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [isLoadingAttom, setIsLoadingAttom] = useState(false);

  // Activity Form
  const [activityType, setActivityType] = useState("call");
  const [activityOutcome, setActivityOutcome] = useState("");
  const [activityNotes, setActivityNotes] = useState("");
  const [followUpNeeded, setFollowUpNeeded] = useState(false);
  const [followUpDate, setFollowUpDate] = useState("");

  // Lead Notes
  const [leadNotes, setLeadNotes] = useState("");

  useEffect(() => {
    if (leadId) {
      loadLeadDetails();
    }
  }, [leadId]);

  const loadLeadDetails = async () => {
    setIsLoading(true);
    try {
      const leadData = await base44.entities.FSBOLead.filter({ id: leadId });
      if (leadData && leadData.length > 0) {
        const fsboLead = leadData[0];
        setLead(fsboLead);
        setLeadNotes(fsboLead.notes || "");

        // Parse AI intelligence
        if (fsboLead.ai_intelligence) {
          try {
            const intel = JSON.parse(fsboLead.ai_intelligence);
            setIntelligence(intel);
          } catch (e) {
            console.error("Error parsing intelligence:", e);
          }
        }

        // Parse tax record info
        if (fsboLead.tax_record_info) {
          try {
            const taxData = JSON.parse(fsboLead.tax_record_info);
            setTaxRecordInfo(taxData);
          } catch (e) {
            console.error("Error parsing tax records:", e);
          }
        } else {
          // Fetch tax records if not already available
          fetchTaxRecords(fsboLead);
        }

        // Generate call script if not exists
        if (!fsboLead.call_script) {
          await generateCallScript(fsboLead);
        } else {
          // Apply replacements to existing cached scripts too
          const currentUser = await base44.auth.me();
          const agentName = currentUser?.full_name || "Agent";
          const companyName = currentUser?.office || "your brokerage";
          
          let scriptText = fsboLead.call_script;
          scriptText = scriptText.replace(/\[Your Name\]/gi, agentName);
          scriptText = scriptText.replace(/\[Agent Name\]/gi, agentName);
          scriptText = scriptText.replace(/\[Your Realty Company\]/gi, companyName);
          scriptText = scriptText.replace(/\[Your Company\]/gi, companyName);
          scriptText = scriptText.replace(/\[Company Name\]/gi, companyName);
          scriptText = scriptText.replace(/\[Your Brokerage\]/gi, companyName);
          scriptText = scriptText.replace(/\[Brokerage\]/gi, companyName);
          
          setCallScript(scriptText);
        }

        // Load activities
        const activitiesData = await base44.entities.FSBOActivity.filter({
          fsbo_lead_id: leadId
        });
        setActivities(activitiesData || []);

        // Fetch ATTOM property data
        fetchAttomData(fsboLead);
      }
    } catch (error) {
      console.error("Error loading lead:", error);
      toast.error("Failed to load FSBO lead details");
    }
    setIsLoading(false);
  };

  const fetchAttomData = async (fsboLead) => {
    if (!fsboLead.property_address || !fsboLead.city || !fsboLead.state) return;
    
    setIsLoadingAttom(true);
    try {
      console.log('Fetching ATTOM data for:', fsboLead.property_address);
      
      const [detailWithOwner, expandedProfile, avmData] = await Promise.all([
        attomPropertyData({
          action: 'propertyDetailWithOwner',
          address: fsboLead.property_address,
          city: fsboLead.city,
          state: fsboLead.state,
          zip: fsboLead.zip_code
        }).catch((e) => { console.log('Owner fetch error:', e); return null; }),
        attomPropertyData({
          action: 'propertyExpandedProfile',
          address: fsboLead.property_address,
          city: fsboLead.city,
          state: fsboLead.state,
          zip: fsboLead.zip_code
        }).catch((e) => { console.log('Expanded fetch error:', e); return null; }),
        attomPropertyData({
          action: 'avm',
          address: fsboLead.property_address,
          city: fsboLead.city,
          state: fsboLead.state,
          zip: fsboLead.zip_code
        }).catch((e) => { console.log('AVM fetch error:', e); return null; })
      ]);

      console.log('ATTOM raw responses:', { detailWithOwner, expandedProfile, avmData });
      
      // The function returns axios response, so data is in response.data
      // Backend returns { success: true, data: {...} }
      const ownerResponse = detailWithOwner?.data?.data || detailWithOwner?.data;
      const expandedResponse = expandedProfile?.data?.data || expandedProfile?.data;
      const avmResponse = avmData?.data?.data || avmData?.data;
      
      console.log('ATTOM parsed responses:', { ownerResponse, expandedResponse, avmResponse });
      
      const ownerData = ownerResponse?.property?.[0];
      const expandedData = expandedResponse?.property?.[0];
      const avmInfo = avmResponse?.property?.[0]?.avm;
      
      console.log('ATTOM final data:', { ownerData, expandedData, avmInfo });

      const combined = ownerData || expandedData;
      if (combined) {
        const owner = combined.owner || {};
        const building = combined.building || {};
        const summary = combined.summary || {};
        const lot = combined.lot || {};

        setAttomData({
          // Owner info
          owner1Name: owner.owner1?.fullName || owner.owner1?.name,
          owner2Name: owner.owner2?.fullName || owner.owner2?.name,
          mailingAddress: owner.mailingAddress?.oneLine,
          absenteeOwner: summary.absenteeInd === 'Y' || owner.mailingAddress?.oneLine !== `${fsboLead.property_address}, ${fsboLead.city}, ${fsboLead.state} ${fsboLead.zip_code}`,
          // Property info
          parcelId: summary.apn?.apnOneLine,
          yearBuilt: summary.yearbuilt,
          bedrooms: building.rooms?.beds,
          bathrooms: building.rooms?.bathstotal,
          squareFeet: building.size?.livingsize,
          lotSize: lot.lotsize2 ? (lot.lotsize2 / 43560).toFixed(2) : null,
          propertyClass: summary.propclass,
          propertyType: summary.proptype,
          zoning: lot.zoning,
          subdivision: summary.subdivision,
          // AVM
          estimatedValue: avmInfo?.amount?.value,
          avmLow: avmInfo?.amount?.low,
          avmHigh: avmInfo?.amount?.high,
          // Tax info
          assessedValue: combined.assessment?.assessed?.assdttlvalue,
          taxAmount: combined.assessment?.tax?.taxamt
        });
      }
    } catch (error) {
      console.error("Error fetching ATTOM data:", error);
    }
    setIsLoadingAttom(false);
  };

  const fetchTaxRecords = async (fsboLead) => {
    try {
      const taxRecordPrompt = `Search county property tax records and property appraiser records for:
Address: ${fsboLead.property_address}, ${fsboLead.city}, ${fsboLead.state} ${fsboLead.zip_code}

CRITICAL: Find the owner's MAILING ADDRESS from tax records. This is usually listed as "Tax Mailing Address" or "Owner Mailing Address" in property records.

Look for:
1. Owner's full legal name(s) from deed/tax records
2. Owner's MAILING ADDRESS (the address where tax bills are sent) - this is REQUIRED
3. Does mailing address match the property address? (Yes/No)
4. Look for additional properties owned by same owner in county
5. Property use classification from tax records

Property Type Analysis:
- If mailing address = property address ‚Üí PRIMARY RESIDENCE
- If mailing address is different but nearby/same city ‚Üí Could be INVESTMENT or multiple properties
- If mailing address is out of state/far away ‚Üí VACATION HOME or INVESTMENT
- If owner has multiple properties ‚Üí INVESTMENT PROPERTY

IMPORTANT: The mailing_address field must contain the actual mailing address from tax records, not just "matches property" or similar text.`;

      const taxInfo = await base44.integrations.Core.InvokeLLM({
        prompt: taxRecordPrompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            owner_details: { type: "string" },
            mailing_address: { type: "string" },
            property_classification: { 
              type: "string",
              enum: ["primary_residence", "investment_property", "vacation_home", "unknown"]
            },
            reasoning: { type: "string" },
            additional_properties: { type: "string" }
          }
        }
      });

      setTaxRecordInfo(taxInfo);

      // Save tax info to lead
      await base44.entities.FSBOLead.update(leadId, {
        tax_record_info: JSON.stringify(taxInfo)
      });
    } catch (e) {
      console.error("Error fetching tax records:", e);
    }
  };

  const generateCallScript = async (fsboLead) => {
    try {
      const currentUser = await base44.auth.me();
      const agentName = currentUser?.full_name || "Agent";
      const companyName = currentUser?.company || currentUser?.brokerage || currentUser?.office || currentUser?.company_office || "your brokerage";

      // Fetch tax records if not already available
      let taxInfo = taxRecordInfo;
      if (!taxInfo) {
        await fetchTaxRecords(fsboLead);
        taxInfo = taxRecordInfo;
      }

      const prompt = `Create a call script for real estate agent to contact a FSBO seller.

THE AGENT'S ACTUAL INFORMATION:
Agent's name is: ${agentName}
Agent's company is: ${companyName}

Property: ${fsboLead.property_address}, ${fsboLead.city}
Price: $${fsboLead.price}
Days on Market: ${fsboLead.days_on_market}
Owner: ${fsboLead.owner_name}

${taxInfo ? `
TAX RECORD INSIGHTS:
- Property Classification: ${taxInfo.property_classification}
- Reasoning: ${taxInfo.reasoning}
- Mailing Address: ${taxInfo.mailing_address}

Use this information to tailor your approach. For investment properties, emphasize ROI and tenant issues. For vacation homes, discuss management complexity.
` : ''}

WRONG EXAMPLE - DO NOT DO THIS:
"Hi there! This is [Your Name] with [Your Realty Company]"
"Hi there! This is [Agent Name] with [Company Name]"

CORRECT EXAMPLE - DO THIS INSTEAD:
"Hi there! This is ${agentName} with ${companyName}"

Create script with:
1. opening - Must start with: "Hi there! This is ${agentName} with ${companyName}. I hope you're having a great day! I came across your listing for ${fsboLead.property_address}..."
2. value_proposition - Explain benefits using agent name ${agentName} and company ${companyName}
3. objection_responses - Array of {objection, response}
4. market_insight - Market conditions
5. call_to_action - Request meeting
6. tips - Array of tips

Use ${agentName} and ${companyName} everywhere. NO placeholders or brackets.`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        response_json_schema: {
          type: "object",
          properties: {
            opening: { type: "string" },
            value_proposition: { type: "string" },
            objection_responses: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  objection: { type: "string" },
                  response: { type: "string" }
                }
              }
            },
            market_insight: { type: "string" },
            call_to_action: { type: "string" },
            tips: { type: "array", items: { type: "string" } }
          }
        }
      });

      // Replace any placeholders that the LLM might have used
      let scriptText = JSON.stringify(response);
      scriptText = scriptText.replace(/\[Your Name\]/gi, agentName);
      scriptText = scriptText.replace(/\[Agent Name\]/gi, agentName);
      scriptText = scriptText.replace(/\[Your Realty Company\]/gi, companyName);
      scriptText = scriptText.replace(/\[Your Company\]/gi, companyName);
      scriptText = scriptText.replace(/\[Company Name\]/gi, companyName);
      scriptText = scriptText.replace(/\[Your Brokerage\]/gi, companyName);
      scriptText = scriptText.replace(/\[Brokerage\]/gi, companyName);
      
      setCallScript(scriptText);

      // Save to lead
      await base44.entities.FSBOLead.update(leadId, {
        call_script: scriptText
      });
    } catch (error) {
      console.error("Error generating call script:", error);
    }
  };

  const logActivity = async () => {
    if (!activityOutcome || !activityNotes) {
      toast.error("Please fill in outcome and notes");
      return;
    }

    setIsSaving(true);
    try {
      await base44.entities.FSBOActivity.create({
        fsbo_lead_id: leadId,
        activity_type: activityType,
        outcome: activityOutcome,
        notes: activityNotes,
        follow_up_needed: followUpNeeded,
        follow_up_date: followUpDate || null
      });

      // Update lead
      const updates = {
        contact_attempts: (lead.contact_attempts || 0) + 1,
        last_contact_date: new Date().toISOString()
      };

      if (followUpNeeded && followUpDate) {
        updates.next_followup_date = followUpDate;
      }

      await base44.entities.FSBOLead.update(leadId, updates);

      // Create task if follow-up needed
      if (followUpNeeded && followUpDate) {
        const currentUser = await base44.auth.me();
        await base44.entities.Task.create({
          title: `Follow up: ${lead.owner_name} - ${lead.property_address}`,
          description: `FSBO Follow-up\n\nProperty: ${lead.property_address}\nOwner: ${lead.owner_name}\nPhone: ${lead.owner_phone}\n\nLast Contact Notes:\n${activityNotes}`,
          priority: "high",
          status: "pending",
          due_date: followUpDate,
          task_type: "follow_up",
          assigned_to: currentUser.id
        });
        toast.success("Activity logged and follow-up task created!");
      } else {
        toast.success("Activity logged successfully!");
      }

      // Reset form and reload
      setActivityNotes("");
      setActivityOutcome("");
      setFollowUpNeeded(false);
      setFollowUpDate("");
      loadLeadDetails(); // Reload to get updated lead info and activities
    } catch (error) {
      console.error("Error logging activity:", error);
      toast.error("Failed to log activity");
    }
    setIsSaving(false);
  };

  const saveLeadNotes = async () => {
    setIsSaving(true);
    try {
      await base44.entities.FSBOLead.update(leadId, {
        notes: leadNotes
      });
      toast.success("Notes saved!");
    } catch (error) {
      console.error("Error saving notes:", error);
      toast.error("Failed to save notes");
    }
    setIsSaving(false);
  };

  const updateLeadStatus = async (newStatus) => {
    try {
      await base44.entities.FSBOLead.update(leadId, {
        status: newStatus
      });
      setLead({ ...lead, status: newStatus });
      toast.success("Status updated!");
    } catch (error) {
      console.error("Error updating status:", error);
      toast.error("Failed to update status");
    }
  };

  const convertToListing = async () => {
    try {
      const currentUser = await base44.auth.me();
      
      // Create property
      const property = await base44.entities.Property.create({
        address: lead.property_address,
        city: lead.city,
        state: lead.state,
        zip_code: lead.zip_code,
        price: lead.price,
        bedrooms: lead.bedrooms,
        bathrooms: lead.bathrooms,
        square_feet: lead.square_feet,
        year_built: lead.year_built,
        property_type: lead.property_type,
        listing_status: "active",
        listing_agent: currentUser.id,
        description: lead.description
      });

      // Update FSBO lead
      await base44.entities.FSBOLead.update(leadId, {
        status: "listing_signed",
        converted_to_property_id: property.id
      });

      toast.success("Converted to listing! Redirecting...");
      setTimeout(() => {
        navigate(createPageUrl(`PropertyDetail?id=${property.id}`));
      }, 1500);
    } catch (error) {
      console.error("Error converting to listing:", error);
      toast.error("Failed to convert to listing");
    }
  };

  if (isLoading) {
    return (
      <div className="page-container">
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-12 h-12 animate-spin text-orange-600" />
        </div>
      </div>
    );
  }

  if (!lead) {
    return (
      <div className="page-container">
        <Card>
          <CardContent className="p-12 text-center">
            <AlertCircle className="w-16 h-16 mx-auto mb-4 text-slate-300" />
            <h2 className="text-2xl font-bold mb-2">FSBO Lead Not Found</h2>
            <Button onClick={() => navigate(createPageUrl("FSBO"))}>
              Back to FSBO Search
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  const script = callScript ? JSON.parse(callScript) : null;
  const statusColors = {
    new: "bg-blue-100 text-blue-800",
    contacted: "bg-yellow-100 text-yellow-800",
    interested: "bg-green-100 text-green-800",
    meeting_scheduled: "bg-purple-100 text-purple-800",
    listing_signed: "bg-emerald-100 text-emerald-800",
    not_interested: "bg-red-100 text-red-800",
    lost: "bg-slate-100 text-slate-800"
  };

  return (
    <div className="page-container">
      <div className="space-y-4">
        {/* Header with Quick Actions */}
        <Card className="border-2 border-orange-500">
          <CardContent className="p-6">
            <div className="flex items-center gap-4 mb-6">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => navigate(-1)}
                className="rounded-full"
              >
                <ArrowLeft className="w-5 h-5" />
              </Button>
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2 flex-wrap">
                  <h1 className="text-2xl font-bold">{lead.property_address}</h1>
                  <Badge className={statusColors[lead.status]}>
                    {lead.status.replace(/_/g, ' ').toUpperCase()}
                  </Badge>
                  {lead.days_on_market > 60 && (
                    <Badge variant="destructive" className="animate-pulse">
                      üî• {lead.days_on_market} Days on Market
                    </Badge>
                  )}
                </div>
                <p className="text-slate-600 text-lg">
                  {lead.city}, {lead.state} {lead.zip_code}
                </p>
                <p className="text-3xl font-bold text-green-600 mt-2">
                  ${lead.price.toLocaleString()}
                </p>
              </div>
            </div>

            {/* Quick Contact Section - Prominent at Top */}
            <div className="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-300 rounded-xl p-6">
              <div className="flex items-center gap-2 mb-4">
                <Phone className="w-6 h-6 text-orange-600" />
                <h2 className="text-xl font-bold text-slate-900">Owner Contact Information</h2>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div className="bg-white rounded-lg p-4 shadow-sm">
                  <Label className="text-sm text-slate-600 mb-1 block">Owner Name</Label>
                  <p className="text-lg font-bold text-slate-900">
                    {taxRecordInfo?.owner_details || lead.owner_name}
                  </p>
                </div>

                <div className="bg-white rounded-lg p-4 shadow-sm">
                  <Label className="text-sm text-slate-600 mb-1 block">Phone Number</Label>
                  <p className="text-2xl font-bold text-green-600">{lead.owner_phone}</p>
                </div>

                <div className="bg-white rounded-lg p-4 shadow-sm">
                  <Label className="text-sm text-slate-600 mb-1 block">Property Type</Label>
                  <p className="text-xl font-semibold text-slate-900 capitalize">
                    {lead.property_type?.replace(/_/g, ' ')} ‚Ä¢ {lead.bedrooms}bed / {lead.bathrooms}bath
                  </p>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                {/* Phone Button */}
                <a
                  href={`tel:${lead.owner_phone}`}
                  className="bg-green-600 hover:bg-green-700 text-white rounded-lg p-4 flex items-center justify-center gap-3 transition-all shadow-lg hover:shadow-xl"
                >
                  <Phone className="w-6 h-6" />
                  <div className="text-left">
                    <div className="text-xs opacity-90">Call Now</div>
                    <div className="text-lg font-bold">{lead.owner_phone}</div>
                  </div>
                </a>

                {/* Email Button */}
                <a
                  href={`mailto:${lead.owner_email}`}
                  className="bg-blue-600 hover:bg-blue-700 text-white rounded-lg p-4 flex items-center justify-center gap-3 transition-all shadow-lg hover:shadow-xl"
                >
                  <Mail className="w-6 h-6" />
                  <div className="text-left">
                    <div className="text-xs opacity-90">Email</div>
                    <div className="text-sm font-semibold truncate max-w-[180px]">
                      {lead.owner_email}
                    </div>
                  </div>
                </a>

                {/* SMS Button */}
                <a
                  href={`sms:${lead.owner_phone}`}
                  className="bg-purple-600 hover:bg-purple-700 text-white rounded-lg p-4 flex items-center justify-center gap-3 transition-all shadow-lg hover:shadow-xl"
                >
                  <MessageSquare className="w-6 h-6" />
                  <div className="text-left">
                    <div className="text-xs opacity-90">Text Message</div>
                    <div className="text-lg font-bold">SMS</div>
                  </div>
                </a>
              </div>

              {/* Contact Stats */}
              <div className="grid grid-cols-3 gap-3 mt-4">
                <div className="bg-white rounded-lg p-3 text-center">
                  <div className="text-2xl font-bold text-orange-600">
                    {lead.contact_attempts || 0}
                  </div>
                  <div className="text-xs text-slate-600">Contact Attempts</div>
                </div>
                
                {lead.last_contact_date && (
                  <div className="bg-white rounded-lg p-3 text-center">
                    <div className="text-sm font-bold text-slate-900">
                      {new Date(lead.last_contact_date).toLocaleDateString()}
                    </div>
                    <div className="text-xs text-slate-600">Last Contact</div>
                  </div>
                )}
                
                <div className="bg-white rounded-lg p-3 text-center">
                  <div className="text-sm font-bold text-slate-900">
                    {lead.listing_source}
                  </div>
                  <div className="text-xs text-slate-600">Source</div>
                </div>
              </div>

              {/* Next Follow-up Alert */}
              {lead.next_followup_date ? (
                <div className={`mt-4 rounded-lg p-4 flex items-center justify-between ${
                  new Date(lead.next_followup_date) <= new Date() 
                    ? 'bg-red-100 border-2 border-red-400 animate-pulse' 
                    : 'bg-amber-100 border-2 border-amber-400'
                }`}>
                  <div className="flex items-center gap-3">
                    <Bell className={`w-6 h-6 ${new Date(lead.next_followup_date) <= new Date() ? 'text-red-700' : 'text-amber-700'}`} />
                    <div>
                      <div className={`font-bold ${new Date(lead.next_followup_date) <= new Date() ? 'text-red-900' : 'text-amber-900'}`}>
                        {new Date(lead.next_followup_date) <= new Date() ? 'üî• FOLLOW-UP OVERDUE!' : 'Next Follow-up Scheduled'}
                      </div>
                      <div className={`text-sm ${new Date(lead.next_followup_date) <= new Date() ? 'text-red-700' : 'text-amber-700'}`}>
                        {new Date(lead.next_followup_date).toLocaleString()}
                      </div>
                    </div>
                  </div>
                  {lead.owner_phone && (
                    <a
                      href={`tel:${lead.owner_phone}`}
                      className="bg-green-600 hover:bg-green-700 text-white rounded-lg px-4 py-2 flex items-center gap-2 transition-all shadow-lg"
                    >
                      <PhoneCall className="w-5 h-5" />
                      Call Now
                    </a>
                  )}
                </div>
              ) : (
                <div className="mt-4 bg-slate-100 border-2 border-slate-300 rounded-lg p-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <CalendarClock className="w-5 h-5 text-slate-500" />
                      <span className="text-slate-600 font-medium">No follow-up scheduled</span>
                    </div>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={() => {
                        setFollowUpNeeded(true);
                        document.getElementById('followUpNeeded')?.scrollIntoView({ behavior: 'smooth' });
                      }}
                    >
                      <CalendarPlus className="w-4 h-4 mr-2" />
                      Schedule Follow-up
                    </Button>
                  </div>
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          {/* Left Column - Property Details */}
          <div className="lg:col-span-1 space-y-4">
            {/* Property Photo */}
            {lead.photo_url && (
              <Card>
                <img
                  src={lead.photo_url}
                  alt={lead.property_address}
                  className="w-full h-48 object-cover rounded-t-lg"
                />
              </Card>
            )}

            {/* Property Details */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Home className="w-5 h-5" />
                  Property Details
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex justify-between">
                  <span className="text-slate-600">Price:</span>
                  <span className="font-bold text-lg">${lead.price.toLocaleString()}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-slate-600">Bedrooms:</span>
                  <span className="font-semibold">{lead.bedrooms}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-slate-600">Bathrooms:</span>
                  <span className="font-semibold">{lead.bathrooms}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-slate-600">Square Feet:</span>
                  <span className="font-semibold">{lead.square_feet.toLocaleString()}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-slate-600">Year Built:</span>
                  <span className="font-semibold">{lead.year_built}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-slate-600">Days on Market:</span>
                  <Badge variant={lead.days_on_market > 60 ? "destructive" : "default"}>
                    {lead.days_on_market} days
                  </Badge>
                </div>
                <div className="flex justify-between">
                  <span className="text-slate-600">Type:</span>
                  <Badge variant="outline" className="capitalize">
                    {lead.property_type?.replace(/_/g, ' ')}
                  </Badge>
                </div>
                
                {lead.description && (
                  <div className="pt-3 border-t">
                    <Label className="text-sm text-slate-600 mb-2 block">Description</Label>
                    <p className="text-sm text-slate-600">{lead.description}</p>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Status Actions */}
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Update Status</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <Select value={lead.status} onValueChange={updateLeadStatus}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="new">New</SelectItem>
                    <SelectItem value="contacted">Contacted</SelectItem>
                    <SelectItem value="interested">Interested</SelectItem>
                    <SelectItem value="meeting_scheduled">Meeting Scheduled</SelectItem>
                    <SelectItem value="listing_signed">Listing Signed</SelectItem>
                    <SelectItem value="not_interested">Not Interested</SelectItem>
                    <SelectItem value="lost">Lost</SelectItem>
                  </SelectContent>
                </Select>
                
                {lead.status === "interested" && (
                  <Button
                    onClick={convertToListing}
                    className="w-full bg-green-600 hover:bg-green-700"
                  >
                    <CheckCircle2 className="w-4 h-4 mr-2" />
                    Convert to Listing
                  </Button>
                )}
              </CardContent>
            </Card>
          </div>

          {/* Middle Column - Call Script & AI Intelligence */}
          <div className="lg:col-span-1 space-y-4">
            {/* ATTOM Property Data */}
            <Card className="border-2 border-teal-200">
              <CardHeader className="bg-gradient-to-r from-teal-50 to-cyan-50">
                <CardTitle className="flex items-center gap-2">
                  <Home className="w-5 h-5 text-teal-600" />
                  ATTOM Property Data
                  {isLoadingAttom && <Loader2 className="w-4 h-4 animate-spin text-teal-600" />}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-6 space-y-4">
                {attomData ? (
                  <>
                    {/* Owner Information */}
                    <div className="bg-teal-50 border border-teal-200 rounded-lg p-4">
                      <h3 className="font-semibold text-sm text-teal-800 mb-3 flex items-center gap-2">
                        <Target className="w-4 h-4" />
                        Owner Information (ATTOM)
                      </h3>
                      <div className="space-y-2">
                        {attomData.owner1Name && (
                          <div className="flex justify-between">
                            <span className="text-sm text-slate-600">Primary Owner:</span>
                            <span className="text-sm font-semibold text-slate-900">{attomData.owner1Name}</span>
                          </div>
                        )}
                        {attomData.owner2Name && attomData.owner2Name !== attomData.owner1Name && (
                          <div className="flex justify-between">
                            <span className="text-sm text-slate-600">Co-Owner:</span>
                            <span className="text-sm font-semibold text-slate-900">{attomData.owner2Name}</span>
                          </div>
                        )}
                        {attomData.mailingAddress && (
                          <div className="pt-2 border-t border-teal-200">
                            <span className="text-xs text-teal-700 font-medium">Mailing Address:</span>
                            <p className="text-sm font-semibold text-slate-900 mt-1">{attomData.mailingAddress}</p>
                            {attomData.absenteeOwner && (
                              <Badge className="mt-2 bg-amber-100 text-amber-800">Absentee Owner</Badge>
                            )}
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Property Details */}
                    <div>
                      <h3 className="font-semibold text-sm text-slate-700 mb-3">Property Details (ATTOM)</h3>
                      <div className="grid grid-cols-2 gap-2 text-sm">
                        {attomData.parcelId && (
                          <div className="bg-slate-50 p-2 rounded">
                            <span className="text-slate-500 text-xs">Parcel ID</span>
                            <p className="font-semibold">{attomData.parcelId}</p>
                          </div>
                        )}
                        {attomData.yearBuilt && (
                          <div className="bg-slate-50 p-2 rounded">
                            <span className="text-slate-500 text-xs">Year Built</span>
                            <p className="font-semibold">{attomData.yearBuilt}</p>
                          </div>
                        )}
                        {attomData.squareFeet && (
                          <div className="bg-slate-50 p-2 rounded">
                            <span className="text-slate-500 text-xs">Square Feet</span>
                            <p className="font-semibold">{attomData.squareFeet?.toLocaleString()}</p>
                          </div>
                        )}
                        {attomData.lotSize && (
                          <div className="bg-slate-50 p-2 rounded">
                            <span className="text-slate-500 text-xs">Lot Size (acres)</span>
                            <p className="font-semibold">{attomData.lotSize}</p>
                          </div>
                        )}
                        {attomData.propertyClass && (
                          <div className="bg-slate-50 p-2 rounded">
                            <span className="text-slate-500 text-xs">Property Class</span>
                            <p className="font-semibold">{attomData.propertyClass}</p>
                          </div>
                        )}
                        {attomData.zoning && (
                          <div className="bg-slate-50 p-2 rounded">
                            <span className="text-slate-500 text-xs">Zoning</span>
                            <p className="font-semibold">{attomData.zoning}</p>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* AVM / Estimated Value */}
                    {attomData.estimatedValue && (
                      <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 className="font-semibold text-sm text-green-800 mb-2 flex items-center gap-2">
                          <DollarSign className="w-4 h-4" />
                          ATTOM Estimated Value
                        </h3>
                        <p className="text-2xl font-bold text-green-700">${attomData.estimatedValue?.toLocaleString()}</p>
                        {attomData.avmLow && attomData.avmHigh && (
                          <p className="text-xs text-green-600 mt-1">
                            Range: ${attomData.avmLow?.toLocaleString()} - ${attomData.avmHigh?.toLocaleString()}
                          </p>
                        )}
                        {lead.price && attomData.estimatedValue && (
                          <div className="mt-2 pt-2 border-t border-green-200">
                            <span className="text-xs text-slate-600">
                              Listed price is {((lead.price - attomData.estimatedValue) / attomData.estimatedValue * 100).toFixed(1)}%
                              {lead.price > attomData.estimatedValue ? ' above' : ' below'} ATTOM estimate
                            </span>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Tax Assessment */}
                    {(attomData.assessedValue || attomData.taxAmount) && (
                      <div>
                        <h3 className="font-semibold text-sm text-slate-700 mb-2">Tax Information</h3>
                        <div className="grid grid-cols-2 gap-2 text-sm">
                          {attomData.assessedValue && (
                            <div className="bg-slate-50 p-2 rounded">
                              <span className="text-slate-500 text-xs">Assessed Value</span>
                              <p className="font-semibold">${attomData.assessedValue?.toLocaleString()}</p>
                            </div>
                          )}
                          {attomData.taxAmount && (
                            <div className="bg-slate-50 p-2 rounded">
                              <span className="text-slate-500 text-xs">Annual Tax</span>
                              <p className="font-semibold">${attomData.taxAmount?.toLocaleString()}</p>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </>
                ) : !isLoadingAttom ? (
                  <p className="text-sm text-slate-500 text-center py-4">No ATTOM data available for this property</p>
                ) : null}
              </CardContent>
            </Card>

            {/* Tax Record Information */}
            {taxRecordInfo && (
              <Card className="border-2 border-green-200">
                <CardHeader className="bg-gradient-to-r from-green-50 to-emerald-50">
                  <CardTitle className="flex items-center gap-2">
                    <Home className="w-5 h-5 text-green-600" />
                    AI Property Intelligence
                  </CardTitle>
                </CardHeader>
                <CardContent className="p-6 space-y-4">
                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Property Type</h3>
                    <Badge className={
                      taxRecordInfo.property_classification === 'primary_residence' ? 'bg-blue-100 text-blue-800' :
                      taxRecordInfo.property_classification === 'investment_property' ? 'bg-purple-100 text-purple-800' :
                      taxRecordInfo.property_classification === 'vacation_home' ? 'bg-amber-100 text-amber-800' :
                      'bg-slate-100 text-slate-800'
                    }>
                      {taxRecordInfo.property_classification?.replace(/_/g, ' ').toUpperCase()}
                    </Badge>
                  </div>

                  {taxRecordInfo.owner_details && (
                    <div>
                      <h3 className="font-semibold text-sm text-slate-700 mb-2">Owner Details</h3>
                      <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
                        {taxRecordInfo.owner_details}
                      </p>
                    </div>
                  )}

                  {taxRecordInfo.mailing_address && (
                    <div>
                      <h3 className="font-semibold text-sm text-slate-700 mb-2">Mailing Address</h3>
                      <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
                        {taxRecordInfo.mailing_address}
                      </p>
                    </div>
                  )}

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Analysis</h3>
                    <p className="text-sm text-slate-600 bg-green-50 p-3 rounded-lg border border-green-200">
                      {taxRecordInfo.reasoning}
                    </p>
                  </div>

                  {taxRecordInfo.additional_properties && (
                    <div>
                      <h3 className="font-semibold text-sm text-slate-700 mb-2">Other Properties</h3>
                      <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
                        {taxRecordInfo.additional_properties}
                      </p>
                    </div>
                  )}
                </CardContent>
              </Card>
            )}

            {/* Call Script */}
            {script && (
              <Card className="border-2 border-orange-200">
                <CardHeader className="bg-gradient-to-r from-orange-50 to-red-50">
                  <CardTitle className="flex items-center gap-2">
                    <PhoneCall className="w-5 h-5 text-orange-600" />
                    Call Script
                  </CardTitle>
                </CardHeader>
                <CardContent className="p-6 space-y-4">
                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Opening</h3>
                    <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
                      {script.opening}
                    </p>
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Value Proposition</h3>
                    <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
                      {script.value_proposition}
                    </p>
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Handling Objections</h3>
                    <div className="space-y-2">
                      {script.objection_responses?.map((obj, idx) => (
                        <div key={idx} className="bg-slate-50 p-3 rounded-lg">
                          <p className="text-xs font-semibold text-orange-600 mb-1">
                            "{obj.objection}"
                          </p>
                          <p className="text-sm text-slate-600">{obj.response}</p>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Market Insight</h3>
                    <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
                      {script.market_insight}
                    </p>
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Call to Action</h3>
                    <p className="text-sm text-slate-600 bg-green-50 p-3 rounded-lg border border-green-200">
                      {script.call_to_action}
                    </p>
                  </div>

                  {script.tips && script.tips.length > 0 && (
                    <div>
                      <h3 className="font-semibold text-sm text-slate-700 mb-2">Pro Tips</h3>
                      <ul className="space-y-1">
                        {script.tips.map((tip, idx) => (
                          <li key={idx} className="text-xs text-slate-600 flex items-start gap-2">
                            <span className="text-orange-500">‚Ä¢</span>
                            <span>{tip}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </CardContent>
              </Card>
            )}

            {/* AI Intelligence */}
            {intelligence && (
              <Card className="border-2 border-purple-200">
                <CardHeader className="bg-gradient-to-r from-purple-50 to-pink-50">
                  <CardTitle className="flex items-center gap-2">
                    <Sparkles className="w-5 h-5 text-purple-600" />
                    AI Market Intelligence
                  </CardTitle>
                </CardHeader>
                <CardContent className="p-6 space-y-4">
                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Market Value</h3>
                    <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
                      {intelligence.market_value}
                    </p>
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Pricing Analysis</h3>
                    <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
                      {intelligence.pricing_analysis}
                    </p>
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2 flex items-center gap-2">
                      <TrendingUp className="w-4 h-4 text-green-600" />
                      Selling Points
                    </h3>
                    <ul className="space-y-1">
                      {intelligence.selling_points?.map((point, idx) => (
                        <li key={idx} className="text-sm text-slate-600 flex items-start gap-2">
                          <span className="text-green-500 font-bold">‚úì</span>
                          <span>{point}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2 flex items-center gap-2">
                      <AlertCircle className="w-4 h-4 text-orange-600" />
                      Concerns
                    </h3>
                    <ul className="space-y-1">
                      {intelligence.concerns?.map((concern, idx) => (
                        <li key={idx} className="text-sm text-slate-600 flex items-start gap-2">
                          <span className="text-orange-500">‚ö†</span>
                          <span>{concern}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Recommended Strategy</h3>
                    <p className="text-sm text-slate-600 bg-purple-50 p-3 rounded-lg border border-purple-200">
                      {intelligence.recommended_strategy}
                    </p>
                  </div>

                  <div>
                    <h3 className="font-semibold text-sm text-slate-700 mb-2">Time to Sell Comparison</h3>
                    <p className="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">
                      {intelligence.time_to_sell_comparison}
                    </p>
                  </div>
                </CardContent>
              </Card>
            )}
          </div>

          {/* Right Column - Activities & Notes */}
          <div className="lg:col-span-1 space-y-4">
            {/* Log Activity */}
            <Card className="border-2 border-blue-200">
              <CardHeader className="bg-blue-50">
                <CardTitle className="flex items-center gap-2">
                  <ClipboardList className="w-5 h-5 text-blue-600" />
                  Log Activity
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 space-y-3">
                <div>
                  <Label>Activity Type</Label>
                  <Select value={activityType} onValueChange={setActivityType}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="call">Phone Call</SelectItem>
                      <SelectItem value="email">Email</SelectItem>
                      <SelectItem value="text">Text Message</SelectItem>
                      <SelectItem value="meeting">Meeting</SelectItem>
                      <SelectItem value="property_visit">Property Visit</SelectItem>
                      <SelectItem value="note">Note</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label>Outcome</Label>
                  <Select value={activityOutcome} onValueChange={setActivityOutcome}>
                    <SelectTrigger>
                      <SelectValue placeholder="Select outcome" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="positive">Positive</SelectItem>
                      <SelectItem value="neutral">Neutral</SelectItem>
                      <SelectItem value="negative">Negative</SelectItem>
                      <SelectItem value="no_answer">No Answer</SelectItem>
                      <SelectItem value="voicemail">Voicemail</SelectItem>
                      <SelectItem value="callback_requested">Callback Requested</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label>Notes</Label>
                  <Textarea
                    value={activityNotes}
                    onChange={(e) => setActivityNotes(e.target.value)}
                    placeholder="What happened during this activity?"
                    rows={4}
                  />
                </div>

                <div className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    id="followUpNeeded"
                    checked={followUpNeeded}
                    onChange={(e) => setFollowUpNeeded(e.target.checked)}
                    className="rounded"
                  />
                  <Label htmlFor="followUpNeeded" className="cursor-pointer">
                    Follow-up needed
                  </Label>
                </div>

                {followUpNeeded && (
                  <div>
                    <Label>Follow-up Date</Label>
                    <Input
                      type="datetime-local"
                      value={followUpDate}
                      onChange={(e) => setFollowUpDate(e.target.value)}
                    />
                  </div>
                )}

                <Button
                  onClick={logActivity}
                  disabled={isSaving}
                  className="w-full bg-blue-600 hover:bg-blue-700"
                >
                  {isSaving ? (
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  ) : (
                    <Save className="w-4 h-4 mr-2" />
                  )}
                  Log Activity
                </Button>
              </CardContent>
            </Card>

            {/* Activity History */}
            <Card>
              <CardHeader>
                <CardTitle>Activity History</CardTitle>
              </CardHeader>
              <CardContent>
                {activities.length === 0 ? (
                  <p className="text-center text-slate-500 py-8">No activities yet</p>
                ) : (
                  <div className="space-y-3">
                    {activities.map((activity) => (
                      <div
                        key={activity.id}
                        className="border-l-4 border-l-blue-500 bg-slate-50 p-3 rounded"
                      >
                        <div className="flex items-center justify-between mb-2">
                          <Badge variant="outline">{activity.activity_type}</Badge>
                          <Badge
                            className={
                              activity.outcome === "positive"
                                ? "bg-green-100 text-green-800"
                                : activity.outcome === "negative"
                                ? "bg-red-100 text-red-800"
                                : "bg-slate-100 text-slate-800"
                            }
                          >
                            {activity.outcome}
                          </Badge>
                        </div>
                        <p className="text-sm text-slate-600 mb-2">{activity.notes}</p>
                        <p className="text-xs text-slate-500">
                          {new Date(activity.created_date).toLocaleString()}
                        </p>
                        {activity.follow_up_needed && (
                          <div className="mt-2 flex items-center gap-2 text-xs text-orange-600">
                            <Calendar className="w-3 h-3" />
                            Follow-up:{" "}
                            {new Date(activity.follow_up_date).toLocaleDateString()}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Lead Notes */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <MessageSquare className="w-5 h-5" />
                  Lead Notes
                </CardTitle>
              </CardHeader>
              <CardContent>
                <Textarea
                  value={leadNotes}
                  onChange={(e) => setLeadNotes(e.target.value)}
                  placeholder="Add your notes about this FSBO lead..."
                  rows={6}
                  className="mb-3"
                />
                <Button
                  onClick={saveLeadNotes}
                  disabled={isSaving}
                  className="w-full"
                >
                  {isSaving ? (
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  ) : (
                    <Save className="w-4 h-4 mr-2" />
                  )}
                  Save Notes
                </Button>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}
import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { 
    Target, Plus, Edit, Trash2, TrendingUp, TrendingDown, 
    Calendar, DollarSign, Briefcase, Activity, AlertTriangle
} from 'lucide-react';
import SetGoalModal from '../components/goals/SetGoalModal';
import { toast } from 'sonner';

export default function GoalsManagement() {
    const [selectedGoal, setSelectedGoal] = useState(null);
    const [showModal, setShowModal] = useState(false);
    const [selectedPeriod, setSelectedPeriod] = useState('monthly');
    const queryClient = useQueryClient();

    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me()
    });

    const { data: goals = [], isLoading } = useQuery({
        queryKey: ['performanceGoals'],
        queryFn: async () => {
            try {
                return await base44.entities.PerformanceGoal.list() || [];
            } catch (error) {
                console.error('Error loading goals:', error);
                return [];
            }
        }
    });

    const { data: teamMembers = [] } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: async () => {
            try {
                return await base44.entities.TeamMember.list() || [];
            } catch (error) {
                console.error('Error loading team members:', error);
                return [];
            }
        }
    });

    const deleteGoalMutation = useMutation({
        mutationFn: (id) => base44.entities.PerformanceGoal.delete(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['performanceGoals'] });
            toast.success('Goal deleted successfully');
        },
        onError: (error) => {
            toast.error(`Failed to delete goal: ${error.message}`);
        }
    });

    // Filter goals by selected period
    const filteredGoals = useMemo(() => {
        return goals.filter(g => g.period_type === selectedPeriod);
    }, [goals, selectedPeriod]);

    // Calculate team overview stats
    const teamStats = useMemo(() => {
        const activeGoals = filteredGoals.filter(g => g.status !== 'completed');
        const onTrack = activeGoals.filter(g => g.status === 'on_track' || g.status === 'exceeded').length;
        const atRisk = activeGoals.filter(g => g.status === 'at_risk').length;
        const behind = activeGoals.filter(g => g.status === 'behind').length;

        return { total: activeGoals.length, onTrack, atRisk, behind };
    }, [filteredGoals]);

    const getStatusColor = (status) => {
        const colors = {
            on_track: 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300',
            exceeded: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300',
            at_risk: 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300',
            behind: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300',
            completed: 'bg-slate-100 text-slate-700 border-slate-200 dark:bg-slate-800/30 dark:text-slate-300'
        };
        return colors[status] || colors.on_track;
    };

    const getProgressPercentage = (current, goal) => {
        if (!goal || goal === 0) return 0;
        return Math.min(Math.round((current / goal) * 100), 100);
    };

    return (
        <div className="page-container space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold">Performance Goals Management</h1>
                    <p className="text-slate-500 dark:text-slate-400 mt-1">
                        Set and track performance goals for your team
                    </p>
                </div>
                <Button onClick={() => { setSelectedGoal(null); setShowModal(true); }}>
                    <Plus className="w-4 h-4 mr-2" />
                    Set New Goal
                </Button>
            </div>

            {/* Period Filter */}
            <div className="flex gap-2">
                {['monthly', 'quarterly', 'annual'].map(period => (
                    <Button
                        key={period}
                        variant={selectedPeriod === period ? 'default' : 'outline'}
                        onClick={() => setSelectedPeriod(period)}
                        size="sm"
                    >
                        <Calendar className="w-4 h-4 mr-2" />
                        {period.charAt(0).toUpperCase() + period.slice(1)}
                    </Button>
                ))}
            </div>

            {/* Team Overview Stats */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Goals</p>
                                <p className="text-2xl font-bold">{teamStats.total}</p>
                            </div>
                            <Target className="w-8 h-8 text-indigo-500" />
                        </div>
                    </CardContent>
                </Card>
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">On Track</p>
                                <p className="text-2xl font-bold text-green-600">{teamStats.onTrack}</p>
                            </div>
                            <TrendingUp className="w-8 h-8 text-green-500" />
                        </div>
                    </CardContent>
                </Card>
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">At Risk</p>
                                <p className="text-2xl font-bold text-yellow-600">{teamStats.atRisk}</p>
                            </div>
                            <AlertTriangle className="w-8 h-8 text-yellow-500" />
                        </div>
                    </CardContent>
                </Card>
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Behind</p>
                                <p className="text-2xl font-bold text-red-600">{teamStats.behind}</p>
                            </div>
                            <TrendingDown className="w-8 h-8 text-red-500" />
                        </div>
                    </CardContent>
                </Card>
            </div>

            {/* Goals List */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {filteredGoals.map(goal => {
                    const revenueProgress = getProgressPercentage(goal.current_revenue, goal.revenue_goal);
                    const dealsProgress = getProgressPercentage(goal.current_deals, goal.deals_goal);

                    return (
                        <Card key={goal.id} className="relative">
                            <CardHeader>
                                <div className="flex justify-between items-start">
                                    <div>
                                        <CardTitle className="text-xl">{goal.agent_name}</CardTitle>
                                        <p className="text-sm text-slate-500 mt-1">
                                            {new Date(goal.period_start).toLocaleDateString()} - {new Date(goal.period_end).toLocaleDateString()}
                                        </p>
                                    </div>
                                    <div className="flex gap-2">
                                        <Badge className={getStatusColor(goal.status)}>
                                            {goal.status.replace('_', ' ').toUpperCase()}
                                        </Badge>
                                        <Button
                                            variant="ghost"
                                            size="icon"
                                            onClick={() => { setSelectedGoal(goal); setShowModal(true); }}
                                        >
                                            <Edit className="w-4 h-4" />
                                        </Button>
                                        <Button
                                            variant="ghost"
                                            size="icon"
                                            onClick={() => deleteGoalMutation.mutate(goal.id)}
                                            className="text-red-600 hover:text-red-700"
                                        >
                                            <Trash2 className="w-4 h-4" />
                                        </Button>
                                    </div>
                                </div>
                            </CardHeader>
                            <CardContent className="space-y-4">
                                {/* Revenue Goal */}
                                {goal.revenue_goal > 0 && (
                                    <div>
                                        <div className="flex justify-between text-sm mb-2">
                                            <span className="flex items-center gap-2">
                                                <DollarSign className="w-4 h-4 text-green-500" />
                                                Revenue
                                            </span>
                                            <span className="font-semibold">
                                                ${(goal.current_revenue || 0).toLocaleString()} / ${goal.revenue_goal.toLocaleString()}
                                            </span>
                                        </div>
                                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                            <div
                                                className="bg-green-500 h-2 rounded-full transition-all"
                                                style={{ width: `${revenueProgress}%` }}
                                            />
                                        </div>
                                        <p className="text-xs text-slate-500 mt-1">{revenueProgress}% complete</p>
                                    </div>
                                )}

                                {/* Deals Goal */}
                                {goal.deals_goal > 0 && (
                                    <div>
                                        <div className="flex justify-between text-sm mb-2">
                                            <span className="flex items-center gap-2">
                                                <Briefcase className="w-4 h-4 text-blue-500" />
                                                Deals Closed
                                            </span>
                                            <span className="font-semibold">
                                                {goal.current_deals || 0} / {goal.deals_goal}
                                            </span>
                                        </div>
                                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                            <div
                                                className="bg-blue-500 h-2 rounded-full transition-all"
                                                style={{ width: `${dealsProgress}%` }}
                                            />
                                        </div>
                                        <p className="text-xs text-slate-500 mt-1">{dealsProgress}% complete</p>
                                    </div>
                                )}

                                {/* Activities Goal */}
                                {goal.activities_goal > 0 && (
                                    <div>
                                        <div className="flex justify-between text-sm mb-2">
                                            <span className="flex items-center gap-2">
                                                <Activity className="w-4 h-4 text-purple-500" />
                                                Activities
                                            </span>
                                            <span className="font-semibold">
                                                {goal.current_activities || 0} / {goal.activities_goal}
                                            </span>
                                        </div>
                                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                            <div
                                                className="bg-purple-500 h-2 rounded-full transition-all"
                                                style={{ width: `${getProgressPercentage(goal.current_activities, goal.activities_goal)}%` }}
                                            />
                                        </div>
                                    </div>
                                )}

                                {/* AI Insights */}
                                {goal.ai_insights && goal.status !== 'on_track' && goal.status !== 'exceeded' && (
                                    <div className="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                                        <p className="text-xs font-semibold text-amber-800 dark:text-amber-300 mb-1">
                                            ‚ö†Ô∏è AI Recommendation
                                        </p>
                                        <p className="text-xs text-amber-700 dark:text-amber-400">
                                            {JSON.parse(goal.ai_insights).recommendation}
                                        </p>
                                    </div>
                                )}
                            </CardContent>
                        </Card>
                    );
                })}
            </div>

            {filteredGoals.length === 0 && !isLoading && (
                <Card>
                    <CardContent className="p-12 text-center">
                        <Target className="w-16 h-16 mx-auto text-slate-300 dark:text-slate-600 mb-4" />
                        <h3 className="text-lg font-semibold mb-2">No Goals Set</h3>
                        <p className="text-slate-500 dark:text-slate-400 mb-4">
                            Start setting performance goals for your team to track progress and drive results.
                        </p>
                        <Button onClick={() => setShowModal(true)}>
                            <Plus className="w-4 h-4 mr-2" />
                            Set Your First Goal
                        </Button>
                    </CardContent>
                </Card>
            )}

            {showModal && (
                <SetGoalModal
                    goal={selectedGoal}
                    teamMembers={teamMembers}
                    onClose={() => { setShowModal(false); setSelectedGoal(null); }}
                />
            )}
        </div>
    );
}
import React from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Star } from 'lucide-react';

export default function HolidayDebug() {
    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me(),
    });

    const { data: holidays = [] } = useQuery({
        queryKey: ['holidays'],
        queryFn: async () => {
            try {
                return await base44.entities.Holiday.list();
            } catch {
                return [];
            }
        },
    });

    const userPrefs = user?.holiday_preferences ? JSON.parse(user.holiday_preferences) : null;

    const jewishHolidays = holidays.filter(h => h.religion === 'jewish');
    const federalHolidays = holidays.filter(h => h.is_federal);
    const culturalHolidays = holidays.filter(h => h.holiday_type === 'cultural');

    return (
        <div className="page-container space-y-6">
            <div>
                <h1 className="page-title">Holiday Debug Info</h1>
                <p className="text-slate-600 dark:text-slate-400">
                    Check what holidays are loaded and your preferences
                </p>
            </div>

            <Card>
                <CardHeader>
                    <CardTitle>Your Holiday Preferences</CardTitle>
                </CardHeader>
                <CardContent>
                    <pre className="bg-slate-100 dark:bg-slate-900 p-4 rounded-lg overflow-auto">
                        {JSON.stringify(userPrefs, null, 2)}
                    </pre>
                </CardContent>
            </Card>

            <div className="grid md:grid-cols-3 gap-6">
                <Card>
                    <CardHeader>
                        <CardTitle className="text-lg">Federal Holidays</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <p className="text-3xl font-bold text-blue-600">{federalHolidays.length}</p>
                        <p className="text-sm text-slate-500 mt-2">Total loaded</p>
                    </CardContent>
                </Card>

                <Card>
                    <CardHeader>
                        <CardTitle className="text-lg">Jewish Holidays</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <p className="text-3xl font-bold text-purple-600">{jewishHolidays.length}</p>
                        <p className="text-sm text-slate-500 mt-2">Total loaded</p>
                    </CardContent>
                </Card>

                <Card>
                    <CardHeader>
                        <CardTitle className="text-lg">Cultural Holidays</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <p className="text-3xl font-bold text-pink-600">{culturalHolidays.length}</p>
                        <p className="text-sm text-slate-500 mt-2">Total loaded</p>
                    </CardContent>
                </Card>
            </div>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Star className="w-5 h-5 text-purple-600" />
                        Jewish Holidays (First 10)
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="space-y-2">
                        {jewishHolidays.slice(0, 10).map(holiday => (
                            <div key={holiday.id} className="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="font-semibold">{holiday.name}</p>
                                        <p className="text-sm text-slate-500">{holiday.date}</p>
                                    </div>
                                    <div className="text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded">
                                        {holiday.religion}
                                    </div>
                                </div>
                            </div>
                        ))}
                        {jewishHolidays.length === 0 && (
                            <p className="text-slate-500">No Jewish holidays found. Run Initialize Holidays first.</p>
                        )}
                    </div>
                </CardContent>
            </Card>

            <Card>
                <CardHeader>
                    <CardTitle>All Holidays by Religion</CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="space-y-4">
                        {['christian', 'jewish', 'muslim', 'hindu', 'buddhist', 'secular'].map(religion => {
                            const count = holidays.filter(h => h.religion === religion).length;
                            return (
                                <div key={religion} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                                    <span className="font-medium capitalize">{religion}</span>
                                    <span className="text-2xl font-bold text-indigo-600">{count}</span>
                                </div>
                            );
                        })}
                    </div>
                </CardContent>
            </Card>
        </div>
    );
}
import React from "react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { CheckCircle, ArrowRight, Calendar, FileText, Users, TrendingUp } from "lucide-react";

export default function Home() {
  const navigate = useNavigate();

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100">
      {/* Hero Section */}
      <div className="max-w-6xl mx-auto px-6 py-20">
        <div className="text-center mb-16">
          <div className="flex items-center justify-center mb-8">
            <div
              className="w-20 h-20 rounded-3xl flex items-center justify-center shadow-2xl"
              style={{
                background: 'linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%)'
              }}
            >
              <svg width="48" height="48" viewBox="0 0 28 28" fill="none">
                <path d="M14 4L24 12H20V22H8V12H4L14 4Z" fill="white" fillOpacity="0.95" />
              </svg>
            </div>
          </div>

          <h1 className="text-5xl md:text-6xl font-bold text-slate-900 mb-6">
            Property Mind
          </h1>
          
          <p className="text-xl md:text-2xl text-slate-600 max-w-3xl mx-auto leading-relaxed">
            A smart transaction workflow system that keeps every real estate deal moving by showing everyone what's done and what's next.
          </p>

          <div className="flex items-center justify-center gap-4 mt-12">
            <Button
              onClick={() => navigate(createPageUrl("Dashboard"))}
              size="lg"
              className="text-lg px-8 py-6 shadow-lg hover:shadow-xl transition-all"
              style={{
                background: 'linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%)'
              }}
            >
              Get Started
              <ArrowRight className="w-5 h-5 ml-2" />
            </Button>
          </div>
        </div>

        {/* Features Grid */}
        <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mt-20">
          {[
            {
              icon: Calendar,
              title: "Smart Scheduling",
              description: "Manage tasks, appointments, and showings in one place"
            },
            {
              icon: FileText,
              title: "Transaction Pipeline",
              description: "Track every deal from listing to closing"
            },
            {
              icon: Users,
              title: "Team Collaboration",
              description: "Everyone sees the same progress in real-time"
            },
            {
              icon: TrendingUp,
              title: "Clear Visibility",
              description: "Know exactly what's done and what's next"
            }
          ].map((feature, i) => (
            <div
              key={i}
              className="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all border border-slate-200"
            >
              <div
                className="w-12 h-12 rounded-xl flex items-center justify-center mb-4"
                style={{
                  background: 'linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%)'
                }}
              >
                <feature.icon className="w-6 h-6 text-white" />
              </div>
              <h3 className="text-lg font-bold text-slate-900 mb-2">
                {feature.title}
              </h3>
              <p className="text-slate-600 text-sm">
                {feature.description}
              </p>
            </div>
          ))}
        </div>

        {/* Key Benefits */}
        <div className="mt-20 bg-white rounded-3xl p-12 shadow-xl border border-slate-200">
          <h2 className="text-3xl font-bold text-slate-900 mb-8 text-center">
            Why Property Mind?
          </h2>
          <div className="grid md:grid-cols-2 gap-8">
            {[
              "Track all transactions in one centralized system",
              "Automated task workflows keep deals on track",
              "Real-time visibility for the entire team",
              "Never miss a deadline or important milestone",
              "Streamlined communication with all parties",
              "Complete transaction history and analytics"
            ].map((benefit, i) => (
              <div key={i} className="flex items-start gap-3">
                <CheckCircle className="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" />
                <p className="text-slate-700 text-lg">{benefit}</p>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { motion } from 'framer-motion';
import {
  Home, DollarSign, Loader2, CheckCircle2, TrendingUp, MapPin,
  User, Mail, Phone, Sparkles, ArrowRight, BarChart3, Calendar, AlertTriangle, 
  Printer, Send, Camera, Hammer, Clock, FileText, Target } from
'lucide-react';
import { toast } from 'sonner';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";


export default function HouseWorthEstimator() {
  const [step, setStep] = useState(1);
  const [isLoading, setIsLoading] = useState(false);

  // Property address
  const [address, setAddress] = useState('');
  const [city, setCity] = useState('');
  const [state, setState] = useState('');
  const [zipCode, setZipCode] = useState('');

  // Autocomplete
  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [isSearching, setIsSearching] = useState(false);
  const searchTimeoutRef = React.useRef(null);
  
  // Address not found state
  const [showManualEntry, setShowManualEntry] = useState(false);
  const [addressNotFound, setAddressNotFound] = useState(false);

  // Seller info
  const [sellerName, setSellerName] = useState('');
  const [sellerEmail, setSellerEmail] = useState('');
  const [sellerPhone, setSellerPhone] = useState('');

  // Valuation result
  const [valuation, setValuation] = useState(null);
  const [detailedReport, setDetailedReport] = useState(null);
  
  // Email modal
  const [showEmailModal, setShowEmailModal] = useState(false);
  const [emailTo, setEmailTo] = useState('');
  const [isSendingEmail, setIsSendingEmail] = useState(false);
  
  // Custom plan request modal
  const [showCustomPlanModal, setShowCustomPlanModal] = useState(false);

  const handleGetEstimate = async () => {
    // Parse address if it's in full format
    let addr = address;
    let cty = city;
    let st = state;
    let zip = zipCode;

    if (!city && !state && address.includes(',')) {
      const parts = address.split(',').map((p) => p.trim());
      if (parts.length >= 2) {
        addr = parts[0];
        const lastPart = parts[parts.length - 1];
        const stateZip = lastPart.split(/\s+/);
        if (stateZip.length >= 2) {
          st = stateZip[0];
          zip = stateZip[1];
        }
        if (parts.length >= 3) {
          cty = parts[1];
        } else {
          cty = parts[parts.length - 2] || '';
        }
      }
    }

    if (!addr) {
      toast.error('Please enter a property address');
      return;
    }

    setIsLoading(true);

    try {
      console.log('Fetching comprehensive property data for:', { addr, cty, st, zip });
      console.log('Original input:', { address, city, state, zipCode });

      const [avmResult, assessmentResult, salesResult, expandedProfileResult, schoolsResult, ownerResult] = await Promise.all([
      base44.functions.invoke('attomPropertyData', {
        action: 'avm',
        address: addr,
        city: cty,
        state: st,
        zip: zip
      }).catch((err) => {
        console.error('AVM error:', err);
        return { data: null, error: err.message };
      }),
      base44.functions.invoke('attomPropertyData', {
        action: 'assessmentSnapshot',
        address: addr,
        city: cty,
        state: st,
        zip: zip
      }).catch((err) => {
        console.error('Assessment error:', err);
        return { data: null, error: err.message };
      }),
      base44.functions.invoke('attomPropertyData', {
        action: 'salesHistory',
        address: addr,
        city: cty,
        state: st,
        zip: zip
      }).catch((err) => {
        console.error('Sales history error:', err);
        return { data: null, error: err.message };
      }),
      base44.functions.invoke('attomPropertyData', {
        action: 'propertyExpandedProfile',
        address: addr,
        city: cty,
        state: st,
        zip: zip
      }).catch((err) => {
        console.error('Expanded profile error:', err);
        return { data: null, error: err.message };
      }),
      base44.functions.invoke('attomPropertyData', {
        action: 'propertyDetailWithSchools',
        address: addr,
        city: cty,
        state: st,
        zip: zip
      }).catch((err) => {
        console.error('Schools error:', err);
        return { data: null, error: err.message };
      }),
      base44.functions.invoke('attomPropertyData', {
        action: 'propertyDetailWithOwner',
        address: addr,
        city: cty,
        state: st,
        zip: zip
      }).catch((err) => {
        console.error('Owner data error:', err);
        return { data: null, error: err.message };
      })]
      );

      console.log('Full API Results:', { avmResult, assessmentResult, salesResult, expandedProfileResult, schoolsResult, ownerResult });

      // Extract data - backend returns {success, data: {...}}
      const avmData = avmResult?.data?.data?.property?.[0];
      const assessmentData = assessmentResult?.data?.data?.property?.[0];
      const salesData = salesResult?.data?.data?.property?.[0];
      const expandedData = expandedProfileResult?.data?.data?.property?.[0];
      const schoolsData = schoolsResult?.data?.data?.property?.[0];
      const ownerData = ownerResult?.data?.data?.property?.[0];

      console.log('Extracted data:', { avmData, assessmentData, salesData, expandedData, schoolsData, ownerData });

      // Check for API errors
      if (avmResult?.error || assessmentResult?.error) {
        console.error('API Errors:', { 
          avm: avmResult?.error, 
          assessment: assessmentResult?.error 
        });
      }

      if (avmData || assessmentData || expandedData || salesData || ownerData) {
        setValuation({
          avm: avmData?.avm,
          assessment: assessmentData?.assessment,
          salesHistory: salesData?.salehistory || [],
          building: avmData?.building || assessmentData?.building || expandedData?.building || ownerData?.building,
          address: avmData?.address || assessmentData?.address || expandedData?.address || ownerData?.address,
          expanded: expandedData,
          schools: schoolsData?.school || [],
          owner: ownerData?.owner
        });

        console.log('Setting step to 2');
        setAddressNotFound(false);
        setStep(2);
        toast.success('Property valuation retrieved!');
      } else {
        console.error('No property data found');
        console.error('Address sent to API:', { addr, cty, st, zip });
        console.error('Full response structure:', JSON.stringify({ 
          avmResult: avmResult?.data, 
          assessmentResult: assessmentResult?.data,
          salesResult: salesResult?.data 
        }, null, 2));
        
        setAddressNotFound(true);
        toast.error('Property not found - see suggestions below', { duration: 5000 });
      }
    } catch (error) {
      console.error('Error fetching valuation:', error);
      toast.error('Error getting estimate: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  const handleSubmitContact = async () => {
    if (!sellerName || !sellerEmail) {
      toast.error('Please provide your name and email');
      return;
    }

    setIsLoading(true);

    try {
      // Save as a HOT lead (score 85 - highly motivated)
      const newLead = await base44.entities.Lead.create({
        name: sellerName,
        email: sellerEmail,
        phone: sellerPhone,
        property_address: address,
        city: city,
        state: state,
        zip_code: zipCode,
        status: 'new',
        lead_source: 'Website - House Worth',
        lead_type: 'seller',
        score: 85,
        notes: `üî• HOT LEAD - Requested home valuation. Estimated value: $${valuation?.avm?.amount?.value?.toLocaleString() || 'N/A'}`
      });

      console.log('Created hot lead:', newLead);

      // Force immediate refresh of all lead-related data
      window.dispatchEvent(new CustomEvent('refreshGlobalData'));
      window.dispatchEvent(new CustomEvent('refreshCounts'));

      toast.success('Generating your report...');

      // Generate comprehensive report with ALL available data
      const propertyDetails = valuation?.expanded || valuation?.building || {};
      const utilities = propertyDetails?.utilities || {};
      const interior = propertyDetails?.interior || {};
      const construction = propertyDetails?.construction || {};
      const parking = propertyDetails?.parking || {};
      const lot = propertyDetails?.lot || valuation?.building?.lot || {};

      const schoolInfo = valuation?.schools?.length > 0 ?
      valuation.schools.map((s) => `${s.filetitle || s.institutionname} (${s.gsrating || 'N/A'} rating, ${s.distance?.toFixed(2) || 'N/A'} mi away)`).join(', ') :
      'School information not available';

      const report = await base44.integrations.Core.InvokeLLM({
        prompt: `Generate an ultra-comprehensive real estate market analysis report for ${address}, ${city}, ${state}. 

      ==================== COMPLETE ATTOM PROPERTY DATA ====================

      PROPERTY VALUATION (AVM DATA):
      - Current Market Value: $${valuation?.avm?.amount?.value?.toLocaleString()}
      - Value Range: $${valuation?.avm?.amount?.low?.toLocaleString()} - $${valuation?.avm?.amount?.high?.toLocaleString()}
      - Price per Sqft: $${valuation?.avm?.amount?.value && valuation?.building?.size?.livingsize ? Math.round(valuation.avm.amount.value / valuation.building.size.livingsize).toLocaleString() : 'N/A'}
      - FSD (Foreclosure Score): ${valuation?.avm?.fsd || 'N/A'}
      - Confidence Score: ${valuation?.avm?.fsd || 'N/A'}
      - Valuation Date: ${valuation?.avm?.eventDate || 'N/A'}

      PROPERTY SPECIFICATIONS:
      - Property Type: ${valuation?.building?.summary?.proptype || 'N/A'}
      - Property Class: ${valuation?.building?.summary?.propclass || 'N/A'}
      - Property Subtype: ${valuation?.building?.summary?.propsubtype || 'N/A'}
      - Bedrooms: ${valuation?.building?.rooms?.beds || 'N/A'}
      - Bathrooms: ${valuation?.building?.rooms?.bathstotal || 'N/A'} (Full: ${valuation?.building?.rooms?.bathsfull || 'N/A'}, Half: ${valuation?.building?.rooms?.bathshalf || 'N/A'}, 3/4: ${valuation?.building?.rooms?.baths3qtr || 'N/A'})
      - Total Rooms: ${valuation?.building?.rooms?.roomsTotal || 'N/A'}
      - Living Area: ${valuation?.building?.size?.livingsize?.toLocaleString() || 'N/A'} sqft
      - Total Finished Area: ${valuation?.building?.size?.grosssize?.toLocaleString() || 'N/A'} sqft
      - Ground Floor Area: ${valuation?.building?.size?.groundfloorsize?.toLocaleString() || 'N/A'} sqft
      - Basement: ${valuation?.building?.size?.bsmtsize?.toLocaleString() || 'N/A'} sqft
      - Garage: ${valuation?.building?.size?.garagesize?.toLocaleString() || 'N/A'} sqft
      - Stories: ${valuation?.building?.summary?.levels || 'N/A'}
      - Units Count: ${valuation?.building?.summary?.unitscount || '1'}
      - Year Built: ${valuation?.building?.summary?.yearbuilt || 'N/A'}
      - Effective Year Built: ${valuation?.building?.summary?.yearbuilteffective || 'N/A'}
      - Architectural Style: ${valuation?.building?.summary?.archStyle || 'N/A'}
      - Quality: ${valuation?.building?.construction?.quality || 'N/A'}
      - Condition: ${valuation?.building?.construction?.condition || 'N/A'}

      LOT & EXTERIOR:
      - Lot Size: ${lot?.lotsize2?.toLocaleString() || 'N/A'} sqft (${(lot?.lotsize2 / 43560)?.toFixed(2) || 'N/A'} acres)
      - Lot Dimensions: ${lot?.lotsize1 || 'N/A'}
      - Frontage: ${lot?.frontage || 'N/A'}
      - Depth: ${lot?.depth || 'N/A'}
      - Foundation: ${construction?.foundationtype || 'N/A'}
      - Roof Type: ${construction?.roofcover || 'N/A'}
      - Roof Shape: ${construction?.roofshape || 'N/A'}
      - Exterior Walls: ${construction?.walltype || 'N/A'}
      - Frame Type: ${construction?.frametype || 'N/A'}
      - Pool: ${propertyDetails?.pool?.pooltype || 'None'}
      - View: ${valuation?.building?.summary?.view || 'N/A'}
      - Topography: ${lot?.topography || 'N/A'}

      INTERIOR FEATURES:
      - Flooring: ${interior?.flrtype || 'N/A'}
      - Heating: ${utilities?.heatingtype || 'N/A'}
      - Cooling: ${utilities?.coolingtype || 'N/A'}
      - Fireplace: ${interior?.fplctype || interior?.fplccount ? `Yes (${interior?.fplccount || '1'})` : 'No'}
      - Amenities: ${valuation?.building?.interior?.amenities || 'N/A'}

      PARKING & GARAGE:
      - Garage Type: ${parking?.garagetype || 'N/A'}
      - Garage Spaces: ${parking?.garagespaces || 'N/A'}
      - Parking Spaces: ${parking?.prkgSpaces || 'N/A'}
      - Parking Type: ${parking?.prkgType || 'N/A'}

      TAX ASSESSMENT:
      - Tax Assessed Value: $${valuation?.assessment?.assessed?.assdttlvalue?.toLocaleString() || 'N/A'}
      - Tax Year: ${valuation?.assessment?.tax?.taxyear || 'N/A'}
      - Annual Tax Amount: $${valuation?.assessment?.tax?.taxamt?.toLocaleString() || 'N/A'}
      - Land Value: $${valuation?.assessment?.assessed?.assdlandvalue?.toLocaleString() || 'N/A'}
      - Improvement Value: $${valuation?.assessment?.assessed?.assdimpvalue?.toLocaleString() || 'N/A'}
      - Tax Rate Area: ${valuation?.assessment?.tax?.taxratearea || 'N/A'}

      COMPLETE SALES HISTORY (ALL RECORDED SALES):
      ${valuation?.salesHistory?.map((sale, i) => {
        const salePrice = sale?.amount?.saleamt;
        const saleDate = sale?.amount?.salerecdate;
        const saleType = sale?.amount?.saletranstype;
        const pricePerSqft = salePrice && valuation?.building?.size?.livingsize ? 
          Math.round(salePrice / valuation.building.size.livingsize) : null;
        return `Sale ${i + 1}: $${salePrice?.toLocaleString() || 'N/A'} on ${saleDate || 'N/A'} (${saleType || 'N/A'})${pricePerSqft ? ` - $${pricePerSqft}/sqft` : ''}`;
      }).join('\n') || 'No sales history available'}

      ${valuation?.salesHistory?.length > 1 ? `
      PRICE APPRECIATION ANALYSIS:
      - First Sale: $${valuation.salesHistory[valuation.salesHistory.length - 1]?.amount?.saleamt?.toLocaleString()} (${valuation.salesHistory[valuation.salesHistory.length - 1]?.amount?.salerecdate})
      - Latest Sale: $${valuation.salesHistory[0]?.amount?.saleamt?.toLocaleString()} (${valuation.salesHistory[0]?.amount?.salerecdate})
      - Total Appreciation: ${valuation.salesHistory[0]?.amount?.saleamt && valuation.salesHistory[valuation.salesHistory.length - 1]?.amount?.saleamt ? 
        `$${(valuation.salesHistory[0].amount.saleamt - valuation.salesHistory[valuation.salesHistory.length - 1].amount.saleamt).toLocaleString()} (${
          Math.round((valuation.salesHistory[0].amount.saleamt / valuation.salesHistory[valuation.salesHistory.length - 1].amount.saleamt - 1) * 100)
        }%)` : 'N/A'}
      ` : ''}

      SCHOOLS NEARBY:
      ${schoolInfo}

      LOCATION & ADDRESS:
      - Full Address: ${valuation?.address?.oneLine || address}
      - County: ${valuation?.address?.countyfips || valuation?.address?.county || 'N/A'}
      - Subdivision/Community: ${valuation?.address?.subdivision || 'N/A'}

      OWNER INFORMATION:
      ${valuation?.owner ? `
      Owner 1:
      - Name: ${valuation.owner.owner1?.firstname || ''} ${valuation.owner.owner1?.middlename || ''} ${valuation.owner.owner1?.lastname || ''}
      - Full Name: ${valuation.owner.owner1?.owner1FullName || 'N/A'}
      - Mailing Address: ${valuation.owner.mailingAddress?.oneLine || 
        `${valuation.owner.mailingAddress?.line1 || ''} ${valuation.owner.mailingAddress?.line2 || ''}, ${valuation.owner.mailingAddress?.locality || ''} ${valuation.owner.mailingAddress?.countrySubd || ''} ${valuation.owner.mailingAddress?.postal1 || ''}`.trim() || 'N/A'}
      ${valuation.owner.owner2?.owner2FullName ? `
      Owner 2:
      - Name: ${valuation.owner.owner2.firstname || ''} ${valuation.owner.owner2.middlename || ''} ${valuation.owner.owner2.lastname || ''}
      - Full Name: ${valuation.owner.owner2.owner2FullName}
      ` : ''}
      Ownership Details:
      - Ownership Type: ${valuation.owner.ownershiptype || 'N/A'}
      - Ownership Rights: ${valuation.owner.ownershiprights || 'N/A'}
      - Vesting Type: ${valuation.owner.vestingowner || 'N/A'}
      - Purchase Date: ${valuation.owner.purchasedate || 'N/A'}
      - Purchase Price: $${valuation.owner.purchaseprice?.toLocaleString() || 'N/A'}
      - Deed Date: ${valuation.owner.deeddate || 'N/A'}
      - Corporate Owner: ${valuation.owner.corporateOwner === 'Y' ? 'Yes' : 'No'}
      - Absentee Owner: ${valuation.owner.absenteeOwner === 'Y' ? 'Yes' : 'No'}
      ` : 'Owner information not available in database'}

      ADDITIONAL ATTOM DATA:
      - Parcel ID: ${valuation?.address?.apn || 'N/A'}
      - Census Tract: ${valuation?.address?.censustractid || 'N/A'}
      - County FIPS: ${valuation?.address?.countyfips || 'N/A'}
      - Zoning: ${valuation?.building?.summary?.zoning || 'N/A'}
      - Land Use: ${valuation?.building?.summary?.landusecode || 'N/A'}
      - Occupancy Status: ${valuation?.building?.summary?.occupancystatus || 'N/A'}
      - Last Modification Date: ${valuation?.building?.summary?.lastModified || 'N/A'}

      ==================== END ATTOM DATA ====================

      Using ALL this comprehensive ATTOM data and current real estate market data from the internet, provide an ULTRA-DETAILED analysis:

      1. **Market Overview**: Analyze current market conditions in ${city}, ${state} - supply/demand dynamics, average days on market, inventory levels, buyer demand trends, seasonal patterns

      2. **Price Trends & Analysis**: Historical price appreciation in the area, recent comparable sales with specific addresses and prices, price per square foot trends, how this property compares to similar homes

      3. **Neighborhood Analysis**: Detailed demographics, school quality ratings and performance, nearby amenities (shopping, dining, parks), planned developments, crime rates, walkability score

      4. **Investment Outlook & Projections**: 5-year appreciation forecast with percentages, rental potential and estimated rental income, cap rate analysis, market cycle position, economic indicators

      5. **Selling Strategy**: Optimal list price recommendation with reasoning, staging suggestions specific to this property type, best time of year to list, anticipated days on market, negotiation leverage points

      6. **Marketing Recommendations**: Target buyer demographic profile, key selling points to emphasize, recommended advertising channels, virtual tour importance, professional photography needs, open house strategy

      7. **Financial Analysis**: Estimated net proceeds after 6% commission and closing costs, breakdown of typical seller costs, potential tax implications, equity position if owned for X years

      8. **Competitive Positioning**: How this property stacks up against active listings, strengths compared to competition, areas where it may fall short, recommended improvements before listing

      9. **Risk Factors**: Current market risks (interest rates, economic conditions), property-specific concerns, timing risks, disclosure requirements specific to ${state}

      10. **Your Action Plan**: Month-by-month timeline from today to listing day, specific steps for preparation (repairs, staging, photography), when to interview agents, optimal listing timing, contingency plans`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            market_overview: { type: "string" },
            price_trends: { type: "string" },
            neighborhood_analysis: { type: "string" },
            investment_outlook: { type: "string" },
            selling_strategy: { type: "string" },
            marketing_recommendations: { type: "string" },
            financial_analysis: { type: "string" },
            competitive_positioning: { type: "string" },
            risk_factors: { type: "string" },
            action_plan: { type: "string" }
          }
        }
      });

      setDetailedReport(report);

      // Save to HomeWorthRequest entity
      await base44.entities.HomeWorthRequest.create({
        name: sellerName,
        email: sellerEmail,
        phone: sellerPhone,
        property_address: address,
        city: city,
        state: state,
        zip_code: zipCode,
        estimated_value: valuation?.avm?.amount?.value,
        value_range_low: valuation?.avm?.amount?.low,
        value_range_high: valuation?.avm?.amount?.high,
        property_data: JSON.stringify(valuation),
        ai_report: JSON.stringify(report),
        status: 'new'
      });

      // Send email to client automatically
      await base44.functions.invoke('sendEmail', {
        to: sellerEmail,
        subject: `Your Home Valuation Report - ${address}`,
        body: `
          <div style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; background: #ffffff; color: #1e293b;">
            <div style="background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); padding: 40px; text-align: center; color: white;">
              <h1 style="margin: 0; font-size: 32px;">Your Home Valuation Report</h1>
              <p style="margin: 10px 0 0 0; opacity: 0.9;">${address}</p>
            </div>

            <div style="padding: 40px;">
              <h2 style="color: #1e293b; margin-bottom: 20px;">Dear ${sellerName},</h2>
              <p style="line-height: 1.8; color: #475569;">Thank you for requesting a valuation for your property. Here's your comprehensive market analysis:</p>

              <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 30px; border-radius: 12px; text-align: center; margin: 30px 0;">
                <h2 style="margin: 0 0 15px 0; font-size: 18px; opacity: 0.9;">Estimated Market Value</h2>
                <p style="font-size: 48px; font-weight: bold; margin: 0;">$${valuation?.avm?.amount?.value?.toLocaleString()}</p>
                ${valuation?.avm?.amount?.high && valuation?.avm?.amount?.low ? `<p style="margin: 15px 0 0 0; opacity: 0.9; font-size: 16px;">Range: $${valuation.avm.amount.low.toLocaleString()} - $${valuation.avm.amount.high.toLocaleString()}</p>` : ''}
              </div>

              <h3 style="color: #1e293b; margin: 30px 0 15px 0; font-size: 20px;">Key Highlights</h3>
              <p style="line-height: 1.8; color: #475569;">${report.market_overview.substring(0, 300)}...</p>

              <div style="background: #f1f5f9; padding: 25px; border-radius: 10px; margin-top: 40px; text-align: center;">
                <p style="margin: 0; color: #475569; line-height: 1.8;">A real estate expert will contact you shortly to provide a FREE customized plan for your specific property.</p>
              </div>

              <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e2e8f0; text-align: center;">
                <p style="color: #1e293b; font-weight: 600; margin: 0;">Best regards,<br>Your Real Estate Team</p>
              </div>
            </div>
          </div>
        `
      });

      setStep(3);
      toast.success('Report ready! A copy has been sent to your email.');
    } catch (error) {
      console.error('Error:', error);
      toast.error('Error generating report: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  const formatCurrency = (value) => {
    if (!value) return 'N/A';
    return `$${value.toLocaleString()}`;
  };

  const formatDate = (dateStr) => {
    if (!dateStr) return 'N/A';
    return new Date(dateStr).toLocaleDateString();
  };

  const searchAddress = async (query) => {
    if (!query || query.length < 5) {
      setSuggestions([]);
      setShowSuggestions(false);
      return;
    }

    setIsSearching(true);
    try {
      const response = await base44.integrations.Core.InvokeLLM({
        prompt: `You are an address lookup assistant. The user is typing a property address: "${query}"

Provide 5 complete, valid US property addresses that match or are similar to what the user typed.
Include a mix of exact matches and nearby alternatives.

For each address, provide SEPARATELY:
- street_address: Just the street number and name (e.g., "123 Main Street")
- city: City name
- state: State (2-letter code)
- zip_code: 5-digit ZIP code

Return ONLY valid, real-looking addresses.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            addresses: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  street_address: { type: "string" },
                  city: { type: "string" },
                  state: { type: "string" },
                  zip_code: { type: "string" }
                }
              }
            }
          }
        }
      });

      if (response?.addresses && response.addresses.length > 0) {
        setSuggestions(response.addresses);
        setShowSuggestions(true);
      } else {
        setSuggestions([]);
      }
    } catch (error) {
      console.error('Address search error:', error);
      setSuggestions([]);
    }
    setIsSearching(false);
  };

  const handleAddressChange = (value) => {
    setAddress(value);

    if (searchTimeoutRef.current) {
      clearTimeout(searchTimeoutRef.current);
    }

    if (value.length < 5) {
      setSuggestions([]);
      setShowSuggestions(false);
      return;
    }

    searchTimeoutRef.current = setTimeout(() => {
      searchAddress(value);
    }, 500);
  };

  const selectAddress = (addressObj) => {
    const fullAddress = `${addressObj.street_address}, ${addressObj.city}, ${addressObj.state} ${addressObj.zip_code}`;
    setAddress(fullAddress);
    setCity(addressObj.city);
    setState(addressObj.state);
    setZipCode(addressObj.zip_code);
    setSuggestions([]);
    setShowSuggestions(false);
  };

  const handlePrint = () => {
    window.print();
  };

  const handleEmailReport = async () => {
    if (!emailTo) {
      toast.error('Please enter an email address');
      return;
    }

    setIsSendingEmail(true);
    try {
      await base44.functions.invoke('sendEmail', {
        to: emailTo,
        subject: `Home Valuation Report - ${address}`,
        body: `
          <div style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; background: #ffffff; color: #1e293b;">
            <div style="background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); padding: 40px; text-align: center; color: white;">
              <h1 style="margin: 0; font-size: 32px;">Home Valuation Report</h1>
              <p style="margin: 10px 0 0 0; opacity: 0.9;">${address}</p>
            </div>

            <div style="padding: 40px;">
              <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 30px; border-radius: 12px; text-align: center; margin: 30px 0;">
                <h2 style="margin: 0 0 15px 0; font-size: 18px;">Estimated Market Value</h2>
                <p style="font-size: 48px; font-weight: bold; margin: 0;">$${valuation?.avm?.amount?.value?.toLocaleString()}</p>
                ${valuation?.avm?.amount?.high && valuation?.avm?.amount?.low ? `<p style="margin: 15px 0 0 0; opacity: 0.9;">Range: $${valuation.avm.amount.low.toLocaleString()} - $${valuation.avm.amount.high.toLocaleString()}</p>` : ''}
              </div>

              ${detailedReport ? `
                <h3 style="color: #1e293b; margin: 30px 0 15px 0;">Market Overview</h3>
                <p style="line-height: 1.8; color: #475569;">${detailedReport.market_overview}</p>

                <h3 style="color: #1e293b; margin: 30px 0 15px 0;">Selling Strategy</h3>
                <p style="line-height: 1.8; color: #475569;">${detailedReport.selling_strategy}</p>
              ` : ''}

              <div style="background: #f1f5f9; padding: 25px; border-radius: 10px; margin-top: 40px; text-align: center;">
                <p style="margin: 0; color: #475569;">This report was shared with you from ${sellerEmail}</p>
              </div>
            </div>
          </div>
        `
      });

      toast.success('Report sent successfully!');
      setShowEmailModal(false);
      setEmailTo('');
    } catch (error) {
      console.error('Email error:', error);
      toast.error('Failed to send email: ' + error.message);
    } finally {
      setIsSendingEmail(false);
    }
  };

  const handleRequestCustomPlan = async () => {
    try {
      // Update the HomeWorthRequest to indicate they want a custom plan
      const requests = await base44.entities.HomeWorthRequest.filter({ 
        email: sellerEmail,
        property_address: address 
      });
      
      if (requests && requests.length > 0) {
        await base44.entities.HomeWorthRequest.update(requests[0].id, {
          status: 'qualified',
          notes: 'Requested FREE customized action plan'
        });
      }

      setShowCustomPlanModal(true);
    } catch (error) {
      console.error('Error updating request:', error);
      setShowCustomPlanModal(true); // Still show modal even if update fails
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-950 via-purple-950 to-slate-950 text-white py-12 px-6">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <motion.div
          className="text-center mb-12"
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}>

          <div className="inline-flex items-center gap-3 mb-6">
            <div className="relative w-12 h-12">
              <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl blur-md animate-pulse" />
              <div className="relative w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                <Home className="w-6 h-6 text-white" />
              </div>
            </div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-white to-indigo-200 bg-clip-text text-transparent">
              What's My House Worth?
            </h1>
          </div>
          <p className="text-lg text-indigo-200">
            Get an instant AI-powered valuation of your home using official tax records and recent sales data
          </p>
        </motion.div>

        {/* Progress Indicator */}
        <div className="mb-12">
          <div className="flex items-center justify-center gap-4">
            <div className={`flex items-center gap-2 ${step >= 1 ? 'text-white' : 'text-indigo-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
              step >= 1 ? 'bg-gradient-to-r from-indigo-600 to-purple-600' : 'bg-white/10'}`
              }>
                {step > 1 ? <CheckCircle2 className="w-5 h-5" /> : '1'}
              </div>
              <span className="text-sm font-medium">Property Address</span>
            </div>
            <div className="w-12 h-0.5 bg-white/20" />
            <div className={`flex items-center gap-2 ${step >= 2 ? 'text-white' : 'text-indigo-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
              step >= 2 ? 'bg-gradient-to-r from-indigo-600 to-purple-600' : 'bg-white/10'}`
              }>
                {step > 2 ? <CheckCircle2 className="w-5 h-5" /> : '2'}
              </div>
              <span className="text-sm font-medium">Your Info</span>
            </div>
            <div className="w-12 h-0.5 bg-white/20" />
            <div className={`flex items-center gap-2 ${step >= 3 ? 'text-white' : 'text-indigo-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
              step >= 3 ? 'bg-gradient-to-r from-indigo-600 to-purple-600' : 'bg-white/10'}`
              }>
                {step >= 3 ? <CheckCircle2 className="w-5 h-5" /> : '3'}
              </div>
              <span className="text-sm font-medium">Results</span>
            </div>
          </div>
        </div>

        {/* Step 1: Property Address */}
        {step === 1 &&
        <motion.div
          initial={{ opacity: 0, x: 20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.5 }}>

            <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
              <CardHeader>
                <CardTitle className="text-2xl text-white flex items-center gap-2">
                  <MapPin className="w-6 h-6 text-indigo-400" />
                  Enter Your Property Address
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="relative">
                  <label className="text-sm text-indigo-200 mb-2 block">Property Address</label>
                  <div className="relative">
                    <Input
                    type="text"
                    placeholder="Start typing address... (e.g., 123 Main St, Los Angeles)"
                    value={address}
                    onChange={(e) => handleAddressChange(e.target.value)}
                    onFocus={() => suggestions.length > 0 && setShowSuggestions(true)}
                    className="bg-white/5 border-white/20 text-white placeholder:text-indigo-300 text-base pr-10"
                    autoComplete="off" />

                    {isSearching &&
                  <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 animate-spin text-indigo-400" />
                  }
                  </div>
                  
                  {/* Address Suggestions Dropdown */}
                  {showSuggestions && suggestions.length > 0 &&
                <div
                  className="absolute z-50 w-full mt-2 bg-slate-900 border border-white/20 rounded-lg shadow-2xl max-h-80 overflow-y-auto"
                  onMouseDown={(e) => e.preventDefault()}>

                      {suggestions.map((addr, idx) =>
                  <button
                    key={idx}
                    type="button"
                    onMouseDown={(e) => {
                      e.preventDefault();
                      selectAddress(addr);
                    }}
                    className="w-full text-left px-4 py-3 hover:bg-indigo-600/30 transition-colors border-b border-white/10 last:border-0 cursor-pointer">

                          <div className="flex items-start gap-3">
                            <MapPin className="w-5 h-5 text-indigo-400 mt-0.5 flex-shrink-0" />
                            <div className="flex-1 min-w-0">
                              <p className="text-sm text-white font-medium">{addr.street_address}</p>
                              <p className="text-xs text-indigo-300 mt-0.5">
                                {addr.city}, {addr.state} {addr.zip_code}
                              </p>
                            </div>
                          </div>
                        </button>
                  )}
                    </div>
                }
                </div>
                
                <Button
                onClick={handleGetEstimate}
                disabled={isLoading || !address}
                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 shadow-lg shadow-indigo-500/50"
                size="lg">

                  {isLoading ?
                <>
                      <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                      Getting Your Estimate...
                    </> :

                <>
                      <Sparkles className="w-5 h-5 mr-2" />
                      Get Free Estimate
                    </>
                }
                </Button>

                {/* Manual Entry Toggle */}
                <div className="text-center">
                  <button
                    onClick={() => setShowManualEntry(!showManualEntry)}
                    className="text-sm text-indigo-300 hover:text-white transition-colors underline"
                  >
                    {showManualEntry ? 'Hide' : 'Show'} separate address fields
                  </button>
                </div>

                {/* Manual Entry Fields */}
                {showManualEntry && (
                  <div className="grid grid-cols-2 gap-3 pt-4 border-t border-white/10">
                    <div className="col-span-2">
                      <label className="text-xs text-indigo-200 mb-1 block">City</label>
                      <Input
                        type="text"
                        placeholder="Los Angeles"
                        value={city}
                        onChange={(e) => setCity(e.target.value)}
                        className="bg-white/5 border-white/20 text-white placeholder:text-indigo-300"
                      />
                    </div>
                    <div>
                      <label className="text-xs text-indigo-200 mb-1 block">State</label>
                      <Input
                        type="text"
                        placeholder="CA"
                        value={state}
                        onChange={(e) => setState(e.target.value)}
                        className="bg-white/5 border-white/20 text-white placeholder:text-indigo-300"
                        maxLength={2}
                      />
                    </div>
                    <div>
                      <label className="text-xs text-indigo-200 mb-1 block">ZIP Code</label>
                      <Input
                        type="text"
                        placeholder="90001"
                        value={zipCode}
                        onChange={(e) => setZipCode(e.target.value.replace(/\D/g, '').slice(0, 5))}
                        className="bg-white/5 border-white/20 text-white placeholder:text-indigo-300"
                        maxLength={5}
                      />
                    </div>
                  </div>
                )}

                {/* Address Not Found Helper */}
                {addressNotFound && (
                  <motion.div
                    initial={{ opacity: 0, height: 0 }}
                    animate={{ opacity: 1, height: 'auto' }}
                    className="bg-yellow-900/30 border border-yellow-500/40 rounded-lg p-4 space-y-3"
                  >
                    <div className="flex items-start gap-3">
                      <AlertTriangle className="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5" />
                      <div className="flex-1">
                        <h4 className="font-semibold text-yellow-200 mb-2">Property Not Found</h4>
                        <p className="text-sm text-yellow-100 mb-3">
                          We couldn't locate this property. Try these tips:
                        </p>
                        <ul className="space-y-2 text-sm text-yellow-100">
                          <li className="flex items-start gap-2">
                            <span className="text-yellow-400">‚Ä¢</span>
                            <span>Use separate fields above to enter city, state, and ZIP</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <span className="text-yellow-400">‚Ä¢</span>
                            <span>Try "Highway 12" instead of "NC-12" or "Route 12"</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <span className="text-yellow-400">‚Ä¢</span>
                            <span>Check for typos in street name or number</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <span className="text-yellow-400">‚Ä¢</span>
                            <span>Some rural properties may not be in our database</span>
                          </li>
                          <li className="flex items-start gap-2">
                            <span className="text-yellow-400">‚Ä¢</span>
                            <span>Try searching without apartment/unit numbers</span>
                          </li>
                        </ul>
                        <div className="mt-3 pt-3 border-t border-yellow-500/30">
                          <p className="text-xs text-yellow-200">
                            <strong>Example:</strong> "123 Main Street" works better than "123 Main St Apt 2"
                          </p>
                        </div>
                      </div>
                    </div>
                  </motion.div>
                )}
              </CardContent>
            </Card>
          </motion.div>
        }

        {/* Step 2: Show Estimate & Collect Contact Info */}
        {step === 2 && valuation &&
        <motion.div
          initial={{ opacity: 0, x: 20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.5 }}
          className="space-y-6">

            {/* Valuation Display */}
            <Card className="bg-gradient-to-br from-green-900/40 to-emerald-900/40 backdrop-blur-xl border-2 border-green-500/30 shadow-2xl shadow-green-500/20">
              <CardHeader>
                <CardTitle className="text-3xl text-white text-center flex items-center justify-center gap-3">
                  <Home className="w-8 h-8 text-green-400" />
                  Your Home Estimate
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* AVM Estimate */}
                {valuation.avm?.amount?.value &&
              <div className="text-center p-8 bg-white/10 rounded-2xl border border-white/20">
                    <p className="text-sm text-green-300 mb-2">Estimated Market Value</p>
                    <p className="text-6xl font-bold bg-gradient-to-r from-green-300 to-emerald-400 bg-clip-text text-transparent">
                      {formatCurrency(valuation.avm.amount.value)}
                    </p>
                    {valuation.avm.amount.high && valuation.avm.amount.low &&
                <p className="text-sm text-indigo-200 mt-4">
                        Range: {formatCurrency(valuation.avm.amount.low)} - {formatCurrency(valuation.avm.amount.high)}
                      </p>
                }
                    {valuation.avm.eventDate &&
                <p className="text-xs text-indigo-300 mt-2">
                        As of {formatDate(valuation.avm.eventDate)}
                      </p>
                }
                  </div>
              }

                {/* Property Details */}
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  {valuation.building?.rooms?.beds &&
                <div className="bg-white/5 p-4 rounded-lg border border-white/10">
                      <p className="text-xs text-indigo-300 mb-1">Bedrooms</p>
                      <p className="text-2xl font-bold text-white">{valuation.building.rooms.beds}</p>
                    </div>
                }
                  {valuation.building?.rooms?.bathstotal &&
                <div className="bg-white/5 p-4 rounded-lg border border-white/10">
                      <p className="text-xs text-indigo-300 mb-1">Bathrooms</p>
                      <p className="text-2xl font-bold text-white">{valuation.building.rooms.bathstotal}</p>
                    </div>
                }
                  {valuation.building?.size?.livingsize &&
                <div className="bg-white/5 p-4 rounded-lg border border-white/10">
                      <p className="text-xs text-indigo-300 mb-1">Square Feet</p>
                      <p className="text-2xl font-bold text-white">{valuation.building.size.livingsize.toLocaleString()}</p>
                    </div>
                }
                </div>

                {/* Tax Assessment */}
                {valuation.assessment?.assessed?.assdttlvalue &&
              <div className="bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-blue-300 mb-1">Tax Assessed Value</p>
                        <p className="text-2xl font-bold text-white">
                          {formatCurrency(valuation.assessment.assessed.assdttlvalue)}
                        </p>
                      </div>
                      <BarChart3 className="w-8 h-8 text-blue-400" />
                    </div>
                  </div>
              }

                {/* Recent Sale */}
                {valuation.salesHistory?.length > 0 && valuation.salesHistory[0]?.amount?.saleamt &&
              <div className="bg-purple-900/30 p-4 rounded-lg border border-purple-500/30">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-purple-300 mb-1">Last Sale Price</p>
                        <p className="text-2xl font-bold text-white">
                          {formatCurrency(valuation.salesHistory[0].amount.saleamt)}
                        </p>
                        <p className="text-xs text-purple-200 mt-1">
                          {formatDate(valuation.salesHistory[0].amount.salerecdate)}
                        </p>
                      </div>
                      <Calendar className="w-8 h-8 text-purple-400" />
                    </div>
                  </div>
              }
              </CardContent>
            </Card>

            {/* Contact Form */}
            <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
              <CardHeader>
                <CardTitle className="text-2xl text-white flex items-center gap-2">
                  <User className="w-6 h-6 text-indigo-400" />
                  Get Your Full Detailed Report
                </CardTitle>
                <p className="text-sm text-indigo-200">
                  Enter your contact information to receive a comprehensive market analysis
                </p>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <label className="text-sm text-indigo-200 mb-2 block">Full Name *</label>
                  <Input
                  type="text"
                  placeholder="John Doe"
                  value={sellerName}
                  onChange={(e) => setSellerName(e.target.value)}
                  className="bg-white/5 border-white/20 text-white placeholder:text-indigo-300" />

                </div>
                <div>
                  <label className="text-sm text-indigo-200 mb-2 block">Email Address *</label>
                  <Input
                  type="email"
                  placeholder="john@example.com"
                  value={sellerEmail}
                  onChange={(e) => setSellerEmail(e.target.value)}
                  className="bg-white/5 border-white/20 text-white placeholder:text-indigo-300" />

                </div>
                <div>
                  <label className="text-sm text-indigo-200 mb-2 block">Phone Number (Optional)</label>
                  <Input
                  type="tel"
                  placeholder="5551234567"
                  value={sellerPhone}
                  onChange={(e) => {
                    const value = e.target.value.replace(/\D/g, '').slice(0, 10);
                    setSellerPhone(value);
                  }}
                  maxLength={10}
                  className="bg-white/5 border-white/20 text-white placeholder:text-indigo-300" />

                </div>
                <Button
                onClick={handleSubmitContact}
                disabled={isLoading || !sellerName || !sellerEmail}
                className="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 shadow-lg shadow-green-500/50"
                size="lg">

                  {isLoading ?
                <>
                      <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                      Submitting...
                    </> :

                <>
                      Get Full Report
                      <ArrowRight className="w-5 h-5 ml-2" />
                    </>
                }
                </Button>
                <p className="text-xs text-indigo-300 text-center">
                  We respect your privacy. Your information will never be shared.
                </p>
              </CardContent>
            </Card>
          </motion.div>
        }

        {/* Step 3: Detailed Report */}
        {step === 3 &&
        <motion.div
          initial={{ opacity: 0, x: 20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.5 }}
          className="space-y-6">

            {/* Action Buttons at Top */}
            <div className="flex justify-between items-center flex-wrap gap-3">
              <Button
                onClick={() => {
                  setStep(1);
                  setAddress('');
                  setCity('');
                  setState('');
                  setZipCode('');
                  setSellerName('');
                  setSellerEmail('');
                  setSellerPhone('');
                  setValuation(null);
                  setDetailedReport(null);
                }}
                variant="outline"
                size="lg"
                className="border-white/30 text-white hover:bg-white/10"
              >
                <ArrowRight className="w-5 h-5 mr-2 rotate-180" />
                Check Another Property
              </Button>

              <div className="flex gap-3">
                <Button
                  onClick={handlePrint}
                  variant="outline"
                  className="border-white/30 text-white hover:bg-white/10"
                >
                  <Printer className="w-4 h-4 mr-2" />
                  Print Report
                </Button>
                <Button
                  onClick={() => setShowEmailModal(true)}
                  className="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500"
                >
                  <Send className="w-4 h-4 mr-2" />
                  Email Report
                </Button>
              </div>
            </div>

            {/* Thank You Header */}
            <Card className="bg-gradient-to-br from-green-900/40 to-emerald-900/40 backdrop-blur-xl border-2 border-green-500/30">
              <CardContent className="p-8">
                <div className="flex items-center justify-between mb-4">
                  <Button
                  onClick={() => {
                    setStep(1);
                    setAddress('');
                    setCity('');
                    setState('');
                    setZipCode('');
                    setSellerName('');
                    setSellerEmail('');
                    setSellerPhone('');
                    setValuation(null);
                    setDetailedReport(null);
                  }}
                  variant="outline" className="bg-slate-500 text-white px-4 py-2 text-sm font-medium rounded-md inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border shadow-sm hover:text-accent-foreground h-9 border-white/30 hover:bg-white/10">


                    <ArrowRight className="w-4 h-4 mr-2 rotate-180" />
                    Check Another Property
                  </Button>
                </div>
                <div className="text-center">
                  <div className="w-16 h-16 bg-gradient-to-r from-green-600 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-green-500/50">
                    <CheckCircle2 className="w-8 h-8 text-white" />
                  </div>
                  <h2 className="text-2xl font-bold text-white mb-2">
                    Thank You, {sellerName}!
                  </h2>
                  <p className="text-indigo-200">
                    {detailedReport ? "Here's your comprehensive property analysis report" : "Generating your detailed report..."}
                  </p>
                </div>
              </CardContent>
            </Card>



            {/* Property Summary - Enhanced */}
            <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
              <CardHeader>
                <CardTitle className="text-2xl text-white flex items-center gap-2">
                  <Home className="w-6 h-6 text-green-400" />
                  Complete Property Overview
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Main Valuation */}
                <div className="text-center p-6 bg-gradient-to-br from-green-900/40 to-emerald-900/40 rounded-xl">
                  <p className="text-sm text-green-300 mb-2">Estimated Market Value</p>
                  <p className="text-5xl font-bold text-white">
                    {formatCurrency(valuation?.avm?.amount?.value)}
                  </p>
                  {valuation?.avm?.amount?.high && valuation?.avm?.amount?.low &&
                <p className="text-sm text-indigo-200 mt-3">
                      Range: {formatCurrency(valuation.avm.amount.low)} - {formatCurrency(valuation.avm.amount.high)}
                    </p>
                }
                  {valuation?.avm?.eventDate &&
                <p className="text-xs text-indigo-300 mt-2">
                      Valuation Date: {formatDate(valuation.avm.eventDate)}
                    </p>
                }
                </div>

                {/* Detailed Property Info Grid */}
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                  {valuation?.building?.rooms?.beds &&
                <div className="bg-white/5 p-3 rounded-lg border border-white/10">
                      <p className="text-xs text-indigo-300 mb-1">Bedrooms</p>
                      <p className="text-xl font-bold text-white">{valuation.building.rooms.beds}</p>
                    </div>
                }
                  {valuation?.building?.rooms?.bathstotal &&
                <div className="bg-white/5 p-3 rounded-lg border border-white/10">
                      <p className="text-xs text-indigo-300 mb-1">Bathrooms</p>
                      <p className="text-xl font-bold text-white">{valuation.building.rooms.bathstotal}</p>
                    </div>
                }
                  {valuation?.building?.size?.livingsize &&
                <div className="bg-white/5 p-3 rounded-lg border border-white/10">
                      <p className="text-xs text-indigo-300 mb-1">Living Area</p>
                      <p className="text-xl font-bold text-white">{valuation.building.size.livingsize.toLocaleString()} sqft</p>
                    </div>
                }
                  {valuation?.building?.lot?.lotsize2 &&
                <div className="bg-white/5 p-3 rounded-lg border border-white/10">
                      <p className="text-xs text-indigo-300 mb-1">Lot Size</p>
                      <p className="text-xl font-bold text-white">{valuation.building.lot.lotsize2.toLocaleString()} sqft</p>
                    </div>
                }
                  {valuation?.building?.summary?.yearbuilt &&
                <div className="bg-white/5 p-3 rounded-lg border border-white/10">
                      <p className="text-xs text-indigo-300 mb-1">Year Built</p>
                      <p className="text-xl font-bold text-white">{valuation.building.summary.yearbuilt}</p>
                    </div>
                }
                  {valuation?.building?.summary?.proptype &&
                <div className="bg-white/5 p-3 rounded-lg border border-white/10">
                      <p className="text-xs text-indigo-300 mb-1">Property Type</p>
                      <p className="text-xl font-bold text-white">{valuation.building.summary.proptype}</p>
                    </div>
                }
                </div>

                {/* Tax Assessment */}
                {valuation?.assessment?.assessed?.assdttlvalue &&
              <div className="bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <p className="text-sm text-blue-300 mb-1">Tax Assessed Value</p>
                        <p className="text-2xl font-bold text-white">
                          {formatCurrency(valuation.assessment.assessed.assdttlvalue)}
                        </p>
                        {valuation?.assessment?.tax?.taxyear &&
                    <p className="text-xs text-blue-200 mt-1">Tax Year: {valuation.assessment.tax.taxyear}</p>
                    }
                      </div>
                      <BarChart3 className="w-8 h-8 text-blue-400" />
                    </div>
                  </div>
              }

                {/* Owner Information Section */}
                {valuation?.owner && (() => {
                  console.log('=== OWNER DATA STRUCTURE ===');
                  console.log(JSON.stringify(valuation.owner, null, 2));
                  return true;
                })() && (
                  <div className="bg-indigo-900/30 p-4 rounded-lg border border-indigo-500/30">
                    <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                      <User className="w-5 h-5 text-indigo-400" />
                      Property Owner Information
                    </h3>
                    
                    <div className="space-y-4">
                      {/* Owner 1 - Try all possible field combinations */}
                      <div className="bg-white/5 p-4 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-2 font-semibold">Primary Owner</p>
                        <p className="text-lg font-bold text-white mb-2">
                          {valuation.owner.owner1FullName || 
                           valuation.owner.owner1?.owner1FullName || 
                           valuation.owner.owner1?.FullName ||
                           `${valuation.owner.owner1?.FirstName || valuation.owner.owner1?.firstname || ''} ${valuation.owner.owner1?.MiddleName || valuation.owner.owner1?.middlename || ''} ${valuation.owner.owner1?.LastName || valuation.owner.owner1?.lastname || ''}`.trim() ||
                           'Owner name not available'}
                        </p>
                        {/* Mailing Address - Try all variations */}
                        {(() => {
                          const mailAddr = valuation.owner.mailingAddress || valuation.owner.MailingAddress || valuation.owner.mailingaddress;
                          if (!mailAddr) return null;
                          
                          const addressLine = mailAddr.oneLine || mailAddr.OneLine ||
                                            `${mailAddr.line1 || mailAddr.Line1 || ''} ${mailAddr.line2 || mailAddr.Line2 || ''}`.trim();
                          const cityStateZip = `${mailAddr.locality || mailAddr.Locality || ''} ${mailAddr.countrySubd || mailAddr.CountrySubd || ''} ${mailAddr.postal1 || mailAddr.Postal1 || ''}`.trim();
                          
                          return (
                            <div className="mt-2">
                              <p className="text-xs text-indigo-300 mb-1">Mailing Address:</p>
                              <p className="text-sm text-white">
                                {addressLine && cityStateZip ? `${addressLine}, ${cityStateZip}` : addressLine || cityStateZip || 'Not available'}
                              </p>
                            </div>
                          );
                        })()}
                      </div>

                      {/* Owner 2 if exists */}
                      {(() => {
                        const owner2Name = valuation.owner.owner2FullName || 
                                         valuation.owner.owner2?.owner2FullName || 
                                         valuation.owner.owner2?.FullName ||
                                         `${valuation.owner.owner2?.FirstName || valuation.owner.owner2?.firstname || ''} ${valuation.owner.owner2?.LastName || valuation.owner.owner2?.lastname || ''}`.trim();
                        
                        if (!owner2Name) return null;
                        
                        return (
                          <div className="bg-white/5 p-4 rounded-lg">
                            <p className="text-xs text-indigo-300 mb-2 font-semibold">Secondary Owner</p>
                            <p className="text-lg font-bold text-white">{owner2Name}</p>
                          </div>
                        );
                      })()}

                      {/* Ownership Details */}
                      <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                        {(valuation.owner.ownershiptype || valuation.owner.OwnershipType) && (
                          <div className="bg-white/5 p-2 rounded-lg">
                            <p className="text-xs text-indigo-300 mb-1">Ownership Type</p>
                            <p className="text-sm font-semibold text-white">{valuation.owner.ownershiptype || valuation.owner.OwnershipType}</p>
                          </div>
                        )}
                        {(valuation.owner.purchasedate || valuation.owner.PurchaseDate) && (
                          <div className="bg-white/5 p-2 rounded-lg">
                            <p className="text-xs text-indigo-300 mb-1">Purchase Date</p>
                            <p className="text-sm font-semibold text-white">{formatDate(valuation.owner.purchasedate || valuation.owner.PurchaseDate)}</p>
                          </div>
                        )}
                        {(valuation.owner.purchaseprice || valuation.owner.PurchasePrice) && (
                          <div className="bg-white/5 p-2 rounded-lg">
                            <p className="text-xs text-indigo-300 mb-1">Purchase Price</p>
                            <p className="text-sm font-semibold text-white">{formatCurrency(valuation.owner.purchaseprice || valuation.owner.PurchasePrice)}</p>
                          </div>
                        )}
                        {(valuation.owner.corporateOwner === 'Y' || valuation.owner.CorporateOwner === 'Y') && (
                          <div className="bg-yellow-900/30 p-2 rounded-lg border border-yellow-500/30">
                            <p className="text-xs text-yellow-300">Corporate Owner</p>
                          </div>
                        )}
                        {(valuation.owner.absenteeOwner === 'Y' || valuation.owner.AbsenteeOwner === 'Y') && (
                          <div className="bg-orange-900/30 p-2 rounded-lg border border-orange-500/30">
                            <p className="text-xs text-orange-300">Absentee Owner</p>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {/* Additional Property Details from ATTOM */}
                <div className="bg-slate-900/30 p-4 rounded-lg border border-slate-500/30">
                  <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <FileText className="w-5 h-5 text-slate-400" />
                    Complete Property Details
                  </h3>
                  
                  {/* Debug: Log valuation structure */}
                  {console.log('=== VALUATION DATA FOR PROPERTY DETAILS ===', {
                    address: valuation?.address,
                    building: valuation?.building,
                    buildingSummary: valuation?.building?.summary
                  })}
                  
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {(valuation?.address?.apn || valuation?.address?.APN) && (
                      <div className="bg-white/5 p-2 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-1">Parcel ID (APN)</p>
                        <p className="text-sm font-semibold text-white">{valuation.address.apn || valuation.address.APN}</p>
                      </div>
                    )}
                    {(valuation?.address?.subdivision || valuation?.address?.Subdivision) && (
                      <div className="bg-white/5 p-2 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-1">Subdivision</p>
                        <p className="text-sm font-semibold text-white">{valuation.address.subdivision || valuation.address.Subdivision}</p>
                      </div>
                    )}
                    {(valuation?.building?.summary?.zoning || valuation?.building?.summary?.Zoning) && (
                      <div className="bg-white/5 p-2 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-1">Zoning</p>
                        <p className="text-sm font-semibold text-white">{valuation.building.summary.zoning || valuation.building.summary.Zoning}</p>
                      </div>
                    )}
                    {(valuation?.building?.summary?.landusecode || valuation?.building?.summary?.LandUseCode) && (
                      <div className="bg-white/5 p-2 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-1">Land Use</p>
                        <p className="text-sm font-semibold text-white">{valuation.building.summary.landusecode || valuation.building.summary.LandUseCode}</p>
                      </div>
                    )}
                    {(valuation?.building?.summary?.occupancystatus || valuation?.building?.summary?.OccupancyStatus) && (
                      <div className="bg-white/5 p-2 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-1">Occupancy</p>
                        <p className="text-sm font-semibold text-white">{valuation.building.summary.occupancystatus || valuation.building.summary.OccupancyStatus}</p>
                      </div>
                    )}
                    {(valuation?.address?.countyfips || valuation?.address?.CountyFIPS) && (
                      <div className="bg-white/5 p-2 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-1">County FIPS</p>
                        <p className="text-sm font-semibold text-white">{valuation.address.countyfips || valuation.address.CountyFIPS}</p>
                      </div>
                    )}
                    {(valuation?.address?.county || valuation?.address?.County) && (
                      <div className="bg-white/5 p-2 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-1">County</p>
                        <p className="text-sm font-semibold text-white">{valuation.address.county || valuation.address.County}</p>
                      </div>
                    )}
                    {(valuation?.building?.summary?.propclass || valuation?.building?.summary?.PropClass) && (
                      <div className="bg-white/5 p-2 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-1">Property Class</p>
                        <p className="text-sm font-semibold text-white">{valuation.building.summary.propclass || valuation.building.summary.PropClass}</p>
                      </div>
                    )}
                    {(valuation?.building?.summary?.propsubtype || valuation?.building?.summary?.PropSubType) && (
                      <div className="bg-white/5 p-2 rounded-lg">
                        <p className="text-xs text-indigo-300 mb-1">Property Subtype</p>
                        <p className="text-sm font-semibold text-white">{valuation.building.summary.propsubtype || valuation.building.summary.PropSubType}</p>
                      </div>
                    )}
                  </div>
                  
                  {/* If no details found, show debug info */}
                  {!valuation?.address?.apn && !valuation?.building?.summary?.zoning && (
                    <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3 mt-3">
                      <p className="text-xs text-yellow-300">
                        Additional property details are being retrieved. Check browser console for data structure.
                      </p>
                    </div>
                  )}
                </div>

                {/* Sales History with Value Trend Chart */}
                {valuation?.salesHistory?.length > 0 && (
                  <div className="bg-purple-900/30 p-4 rounded-lg border border-purple-500/30">
                    <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                      <TrendingUp className="w-5 h-5 text-purple-400" />
                      Complete Sales History & Value Trend
                    </h3>

                    {/* Value Trend Chart */}
                    {valuation.salesHistory.length > 1 && (
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <p className="text-xs text-purple-300 mb-3">Historical Price Appreciation</p>
                        <ResponsiveContainer width="100%" height={300}>
                          <LineChart 
                            data={valuation.salesHistory.slice().reverse().map(sale => ({
                              date: sale.amount?.salerecdate,
                              displayDate: sale.amount?.salerecdate ? new Date(sale.amount.salerecdate).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : '',
                              value: sale.amount?.saleamt || 0,
                              pricePerSqft: sale.amount?.saleamt && valuation.building?.size?.livingsize ? 
                                Math.round(sale.amount.saleamt / valuation.building.size.livingsize) : null
                            }))}
                            margin={{ top: 5, right: 20, bottom: 5, left: 0 }}
                          >
                            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                            <XAxis 
                              dataKey="displayDate" 
                              stroke="#cbd5e1" 
                              style={{ fontSize: '11px' }}
                            />
                            <YAxis 
                              stroke="#cbd5e1"
                              style={{ fontSize: '11px' }}
                              tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
                            />
                            <Tooltip 
                              contentStyle={{ 
                                background: '#1e293b', 
                                border: '1px solid rgba(255,255,255,0.2)',
                                borderRadius: '8px',
                                color: '#fff',
                                padding: '12px'
                              }}
                              formatter={(value, name, props) => {
                                const pricePerSqft = props.payload.pricePerSqft;
                                return [
                                  <div key="tooltip">
                                    <div className="font-bold">${value.toLocaleString()}</div>
                                    {pricePerSqft && <div className="text-xs text-purple-300">${pricePerSqft}/sqft</div>}
                                  </div>, 
                                  'Sale Price'
                                ];
                              }}
                              labelStyle={{ color: '#cbd5e1', marginBottom: '4px' }}
                            />
                            <Line 
                              type="monotone" 
                              dataKey="value" 
                              stroke="#a78bfa" 
                              strokeWidth={3}
                              dot={{ fill: '#a78bfa', r: 6, strokeWidth: 2, stroke: '#1e293b' }}
                              activeDot={{ r: 9, strokeWidth: 2 }}
                            />
                          </LineChart>
                        </ResponsiveContainer>
                        
                        {/* Appreciation Stats */}
                        {valuation.salesHistory.length > 1 && valuation.salesHistory[0]?.amount?.saleamt && valuation.salesHistory[valuation.salesHistory.length - 1]?.amount?.saleamt && (
                          <div className="mt-4 grid grid-cols-3 gap-3">
                            <div className="bg-white/5 p-2 rounded text-center">
                              <p className="text-xs text-purple-300 mb-1">First Sale</p>
                              <p className="text-sm font-bold text-white">
                                ${valuation.salesHistory[valuation.salesHistory.length - 1].amount.saleamt.toLocaleString()}
                              </p>
                            </div>
                            <div className="bg-white/5 p-2 rounded text-center">
                              <p className="text-xs text-purple-300 mb-1">Latest Sale</p>
                              <p className="text-sm font-bold text-white">
                                ${valuation.salesHistory[0].amount.saleamt.toLocaleString()}
                              </p>
                            </div>
                            <div className="bg-green-900/30 p-2 rounded text-center border border-green-500/30">
                              <p className="text-xs text-green-300 mb-1">Total Gain</p>
                              <p className="text-sm font-bold text-green-200">
                                {Math.round((valuation.salesHistory[0].amount.saleamt / valuation.salesHistory[valuation.salesHistory.length - 1].amount.saleamt - 1) * 100)}%
                              </p>
                            </div>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Complete Sales List - Show ALL sales */}
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      <p className="text-xs text-purple-300 mb-2 font-semibold">All Recorded Sales ({valuation.salesHistory.length})</p>
                      {valuation.salesHistory.map((sale, idx) => {
                        const pricePerSqft = sale.amount?.saleamt && valuation.building?.size?.livingsize ? 
                          Math.round(sale.amount.saleamt / valuation.building.size.livingsize) : null;
                        
                        return (
                          <div key={idx} className="bg-white/5 p-3 rounded-lg border border-white/10 hover:bg-white/10 transition-colors">
                            <div className="flex items-center justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                  <p className="text-sm font-semibold text-purple-300">
                                    {formatDate(sale.amount?.salerecdate)}
                                  </p>
                                  {sale.amount?.saletranstype && (
                                    <Badge className="bg-purple-700/50 text-purple-200 border-purple-500/30 text-xs">
                                      {sale.amount.saletranstype}
                                    </Badge>
                                  )}
                                </div>
                                <p className="text-xl font-bold text-white">
                                  {formatCurrency(sale.amount?.saleamt)}
                                </p>
                                {pricePerSqft && (
                                  <p className="text-xs text-purple-300 mt-1">
                                    ${pricePerSqft}/sqft
                                  </p>
                                )}
                              </div>
                              {sale.amount?.saledocnum && (
                                <div className="text-right text-xs text-purple-400">
                                  Doc #{sale.amount.saledocnum}
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* AI Analysis Section - Enhanced */}
            {detailedReport ?
          <>
                <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
                  <CardHeader>
                    <CardTitle className="text-xl text-white flex items-center gap-2">
                      <TrendingUp className="w-5 h-5 text-blue-400" />
                      Market Overview
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line">{detailedReport.market_overview}</p>
                  </CardContent>
                </Card>

                <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
                  <CardHeader>
                    <CardTitle className="text-xl text-white flex items-center gap-2">
                      <BarChart3 className="w-5 h-5 text-purple-400" />
                      Price Trends & Analysis
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line">{detailedReport.price_trends}</p>
                  </CardContent>
                </Card>

                <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
                  <CardHeader>
                    <CardTitle className="text-xl text-white flex items-center gap-2">
                      <MapPin className="w-5 h-5 text-cyan-400" />
                      Neighborhood Analysis
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line">{detailedReport.neighborhood_analysis}</p>
                  </CardContent>
                </Card>

                <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
                  <CardHeader>
                    <CardTitle className="text-xl text-white flex items-center gap-2">
                      <DollarSign className="w-5 h-5 text-yellow-400" />
                      Investment Outlook & Projections
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line">{detailedReport.investment_outlook}</p>
                  </CardContent>
                </Card>

                <Card className="bg-gradient-to-br from-indigo-900/40 to-purple-900/40 backdrop-blur-xl border-2 border-indigo-500/30">
                  <CardHeader>
                    <CardTitle className="text-xl text-white flex items-center gap-2">
                      <Sparkles className="w-5 h-5 text-indigo-400" />
                      Selling Strategy
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line">{detailedReport.selling_strategy}</p>
                  </CardContent>
                </Card>

                <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
                  <CardHeader>
                    <CardTitle className="text-xl text-white flex items-center gap-2">
                      <TrendingUp className="w-5 h-5 text-green-400" />
                      Marketing Recommendations
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line">{detailedReport.marketing_recommendations}</p>
                  </CardContent>
                </Card>

                <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
                  <CardHeader>
                    <CardTitle className="text-xl text-white flex items-center gap-2">
                      <DollarSign className="w-5 h-5 text-emerald-400" />
                      Financial Analysis
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line">{detailedReport.financial_analysis}</p>
                  </CardContent>
                </Card>

                <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
                  <CardHeader>
                    <CardTitle className="text-xl text-white flex items-center gap-2">
                      <BarChart3 className="w-5 h-5 text-orange-400" />
                      Competitive Positioning
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line">{detailedReport.competitive_positioning}</p>
                  </CardContent>
                </Card>

                <Card className="bg-red-900/30 backdrop-blur-xl border border-red-500/30">
                  <CardHeader>
                    <CardTitle className="text-xl text-white flex items-center gap-2">
                      <AlertTriangle className="w-5 h-5 text-red-400" />
                      Risk Factors
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line">{detailedReport.risk_factors}</p>
                  </CardContent>
                </Card>

                <Card className="bg-gradient-to-br from-green-900/40 to-teal-900/40 backdrop-blur-xl border-2 border-green-500/30">
                  <CardHeader>
                    <CardTitle className="text-2xl text-white flex items-center gap-3">
                      <CheckCircle2 className="w-6 h-6 text-green-400" />
                      Your Personalized Action Plan
                    </CardTitle>
                    <p className="text-sm text-green-200 mt-2">
                      Step-by-step roadmap to maximize your property's value and achieve a successful sale
                    </p>
                  </CardHeader>
                  <CardContent className="space-y-6">
                    {/* Professional Action Steps with Icons */}
                    <div className="space-y-3">
                      {detailedReport.action_plan.split('\n').filter(line => line.trim()).map((step, idx) => {
                        // Smart icon selection based on content
                        let StepIcon = CheckCircle2;
                        let iconColor = 'text-green-300';
                        let bgColor = 'bg-green-500/20';
                        let borderColor = 'border-green-500/30';
                        
                        const lowerStep = step.toLowerCase();
                        if (lowerStep.includes('price') || lowerStep.includes('list')) {
                          StepIcon = DollarSign;
                          iconColor = 'text-yellow-300';
                          bgColor = 'bg-yellow-500/20';
                          borderColor = 'border-yellow-500/30';
                        } else if (lowerStep.includes('photo') || lowerStep.includes('picture') || lowerStep.includes('image')) {
                          StepIcon = Camera;
                          iconColor = 'text-purple-300';
                          bgColor = 'bg-purple-500/20';
                          borderColor = 'border-purple-500/30';
                        } else if (lowerStep.includes('repair') || lowerStep.includes('improve') || lowerStep.includes('fix') || lowerStep.includes('renovation')) {
                          StepIcon = Hammer;
                          iconColor = 'text-orange-300';
                          bgColor = 'bg-orange-500/20';
                          borderColor = 'border-orange-500/30';
                        } else if (lowerStep.includes('agent') || lowerStep.includes('interview') || lowerStep.includes('realtor')) {
                          StepIcon = User;
                          iconColor = 'text-blue-300';
                          bgColor = 'bg-blue-500/20';
                          borderColor = 'border-blue-500/30';
                        } else if (lowerStep.includes('stage') || lowerStep.includes('staging') || lowerStep.includes('clean') || lowerStep.includes('declutter')) {
                          StepIcon = Sparkles;
                          iconColor = 'text-pink-300';
                          bgColor = 'bg-pink-500/20';
                          borderColor = 'border-pink-500/30';
                        } else if (lowerStep.includes('timing') || lowerStep.includes('schedule') || lowerStep.includes('timeline') || lowerStep.includes('month')) {
                          StepIcon = Clock;
                          iconColor = 'text-cyan-300';
                          bgColor = 'bg-cyan-500/20';
                          borderColor = 'border-cyan-500/30';
                        } else if (lowerStep.includes('market') || lowerStep.includes('advertis') || lowerStep.includes('promotion')) {
                          StepIcon = TrendingUp;
                          iconColor = 'text-emerald-300';
                          bgColor = 'bg-emerald-500/20';
                          borderColor = 'border-emerald-500/30';
                        } else if (lowerStep.includes('document') || lowerStep.includes('paper') || lowerStep.includes('disclosure')) {
                          StepIcon = FileText;
                          iconColor = 'text-indigo-300';
                          bgColor = 'bg-indigo-500/20';
                          borderColor = 'border-indigo-500/30';
                        }

                        return (
                          <div 
                            key={idx} 
                            className="flex items-start gap-4 bg-white/5 p-4 rounded-lg border border-white/10 hover:bg-white/10 hover:shadow-lg transition-all group"
                          >
                            <div className={`flex-shrink-0 w-12 h-12 ${bgColor} rounded-xl flex items-center justify-center border ${borderColor} group-hover:scale-110 transition-transform`}>
                              <StepIcon className={`w-6 h-6 ${iconColor}`} />
                            </div>
                            <div className="flex-1 pt-1">
                              <p className="text-white leading-relaxed font-medium">{step}</p>
                            </div>
                          </div>
                        );
                      })}
                    </div>

                    {/* Premium CTA for Fully Customized Plan */}
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 rounded-2xl text-center mt-8 border-2 border-white/20 shadow-2xl">
                      <div className="relative">
                        <div className="absolute -top-12 left-1/2 -translate-x-1/2 w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center shadow-2xl">
                          <Sparkles className="w-10 h-10 text-white" />
                        </div>
                      </div>
                      
                      <h3 className="text-3xl font-bold text-white mb-3 mt-4">Get Your FREE Customized Plan</h3>
                      <p className="text-white/90 mb-6 text-lg">
                        This is a general roadmap. Want a plan specifically tailored to YOUR property and goals?
                      </p>
                      
                      <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-6">
                        <h4 className="text-white font-semibold mb-4 text-lg">What You'll Get (100% FREE):</h4>
                        <div className="space-y-3 text-left">
                          <div className="flex items-start gap-3">
                            <div className="flex-shrink-0 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                              <CheckCircle2 className="w-4 h-4 text-white" />
                            </div>
                            <span className="text-white/90">Room-by-room staging recommendations specific to YOUR home's layout</span>
                          </div>
                          <div className="flex items-start gap-3">
                            <div className="flex-shrink-0 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                              <CheckCircle2 className="w-4 h-4 text-white" />
                            </div>
                            <span className="text-white/90">Custom pricing strategy analyzing YOUR neighborhood's exact market conditions</span>
                          </div>
                          <div className="flex items-start gap-3">
                            <div className="flex-shrink-0 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                              <CheckCircle2 className="w-4 h-4 text-white" />
                            </div>
                            <span className="text-white/90">Personalized timeline with YOUR specific deadlines and milestones</span>
                          </div>
                          <div className="flex items-start gap-3">
                            <div className="flex-shrink-0 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                              <CheckCircle2 className="w-4 h-4 text-white" />
                            </div>
                            <span className="text-white/90">Custom repair priority list to maximize ROI for YOUR budget</span>
                          </div>
                          <div className="flex items-start gap-3">
                            <div className="flex-shrink-0 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                              <CheckCircle2 className="w-4 h-4 text-white" />
                            </div>
                            <span className="text-white/90">Marketing strategy designed for YOUR target buyer demographic</span>
                          </div>
                        </div>
                      </div>

                      <Button
                        className="bg-white text-indigo-600 hover:bg-white/90 font-bold text-xl px-10 py-7 shadow-2xl hover:scale-105 transition-transform"
                        onClick={handleRequestCustomPlan}
                      >
                        <Target className="w-6 h-6 mr-3" />
                        Request My FREE Custom Plan Now
                      </Button>
                      
                      <div className="flex items-center justify-center gap-6 mt-6 text-white/70 text-sm">
                        <div className="flex items-center gap-1">
                          <CheckCircle2 className="w-4 h-4" />
                          <span>No Obligation</span>
                        </div>
                        <div className="flex items-center gap-1">
                          <CheckCircle2 className="w-4 h-4" />
                          <span>100% Free</span>
                        </div>
                        <div className="flex items-center gap-1">
                          <CheckCircle2 className="w-4 h-4" />
                          <span>Expert Guidance</span>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </> :

          <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
                <CardContent className="p-8 text-center">
                  <Loader2 className="w-8 h-8 animate-spin text-indigo-400 mx-auto mb-3" />
                  <p className="text-white text-sm">Generating enhanced market analysis...</p>
                </CardContent>
              </Card>
          }

            {/* Contact CTA */}
            <Card className="bg-gradient-to-br from-green-900/40 to-emerald-900/40 backdrop-blur-xl border-2 border-green-500/30">
              <CardContent className="p-8 text-center">
                <h3 className="text-2xl font-bold text-white mb-3">Ready to Take the Next Step?</h3>
                <p className="text-indigo-200 mb-6">
                  A real estate expert will contact you at {sellerEmail} 
                  {sellerPhone && ` or ${sellerPhone}`} to discuss your property in detail.
                </p>
                <div className="flex gap-3 justify-center">
                  <Button
                  onClick={() => {
                    setStep(1);
                    setAddress('');
                    setCity('');
                    setState('');
                    setZipCode('');
                    setSellerName('');
                    setSellerEmail('');
                    setSellerPhone('');
                    setValuation(null);
                    setDetailedReport(null);
                  }}
                  variant="outline"
                  className="border-white/20 text-white hover:bg-white/10">

                    <ArrowRight className="w-4 h-4 mr-2 rotate-180" />
                    Check Another Property
                  </Button>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        }

        {/* Back to Website Button */}
        <div className="text-center mt-12">
          <Button
            variant="ghost"
            onClick={() => window.history.back()}
            className="text-indigo-300 hover:text-white hover:bg-white/10">

            ‚Üê Back to Website
          </Button>
        </div>
      </div>

      {/* Email Modal */}
      <Dialog open={showEmailModal} onOpenChange={setShowEmailModal}>
        <DialogContent className="bg-slate-900 border-white/20 text-white">
          <DialogHeader>
            <DialogTitle className="text-white">Email This Report</DialogTitle>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <label className="text-sm text-slate-300 mb-2 block">Send report to:</label>
              <Input
                type="email"
                placeholder="recipient@example.com"
                value={emailTo}
                onChange={(e) => setEmailTo(e.target.value)}
                className="bg-white/5 border-white/20 text-white placeholder:text-slate-400"
              />
            </div>
            <Button
              onClick={handleEmailReport}
              disabled={isSendingEmail || !emailTo}
              className="w-full bg-gradient-to-r from-blue-600 to-cyan-600"
            >
              {isSendingEmail ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Sending...
                </>
              ) : (
                <>
                  <Send className="w-4 h-4 mr-2" />
                  Send Report
                </>
              )}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Custom Plan Request Modal */}
      <Dialog open={showCustomPlanModal} onOpenChange={setShowCustomPlanModal}>
        <DialogContent className="bg-gradient-to-br from-green-900 to-emerald-900 border-green-500/30 text-white max-w-2xl">
          <DialogHeader>
            <DialogTitle className="text-3xl text-white text-center flex flex-col items-center gap-4">
              <div className="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center">
                <CheckCircle2 className="w-12 h-12 text-white" />
              </div>
              Request Confirmed!
            </DialogTitle>
          </DialogHeader>
          
          <div className="space-y-6 py-4">
            <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
              <h3 className="text-xl font-bold text-white mb-4 text-center">
                üéâ Your FREE Customized Plan is On The Way!
              </h3>
              
              <div className="space-y-4">
                <div className="flex items-start gap-3">
                  <div className="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mt-1">
                    <CheckCircle2 className="w-5 h-5 text-white" />
                  </div>
                  <div>
                    <p className="text-white font-semibold">Within 24 Hours</p>
                    <p className="text-green-100 text-sm">A real estate specialist will contact you at <strong>{sellerEmail}</strong></p>
                  </div>
                </div>

                <div className="flex items-start gap-3">
                  <div className="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mt-1">
                    <CheckCircle2 className="w-5 h-5 text-white" />
                  </div>
                  <div>
                    <p className="text-white font-semibold">Personalized Analysis</p>
                    <p className="text-green-100 text-sm">We'll review your specific property at <strong>{address}</strong></p>
                  </div>
                </div>

                <div className="flex items-start gap-3">
                  <div className="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mt-1">
                    <CheckCircle2 className="w-5 h-5 text-white" />
                  </div>
                  <div>
                    <p className="text-white font-semibold">Custom Strategy Session</p>
                    <p className="text-green-100 text-sm">Get room-by-room recommendations, pricing strategy, and timeline</p>
                  </div>
                </div>

                <div className="flex items-start gap-3">
                  <div className="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mt-1">
                    <CheckCircle2 className="w-5 h-5 text-white" />
                  </div>
                  <div>
                    <p className="text-white font-semibold">100% Free - No Obligation</p>
                    <p className="text-green-100 text-sm">There's absolutely no cost or commitment required</p>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-yellow-500/20 border border-yellow-500/40 rounded-lg p-4 text-center">
              <p className="text-yellow-100 font-medium">
                üìß Check your email - we've sent you a copy of your valuation report!
              </p>
            </div>

            <Button
              onClick={() => setShowCustomPlanModal(false)}
              className="w-full bg-white text-green-600 hover:bg-white/90 font-bold text-lg py-6"
            >
              Got It - Looking Forward To It!
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Print Styles */}
      <style>{`
        @media print {
          button, .no-print {
            display: none !important;
          }
          body {
            background: white !important;
          }
          .bg-gradient-to-br, .bg-gradient-to-r {
            background: white !important;
            color: black !important;
          }
          * {
            color: black !important;
            border-color: #e5e7eb !important;
          }
          .bg-white\\/10, .bg-white\\/5 {
            background: #f9fafb !important;
          }
        }
      `}</style>
    </div>);

}
import Layout from "./Layout.jsx";

import AIBuyerPropertyMatcher from "./AIBuyerPropertyMatcher";

import AIDocumentIntelligence from "./AIDocumentIntelligence";

import AIEmailAssistant from "./AIEmailAssistant";

import AIInsights from "./AIInsights";

import AILeadNurturing from "./AILeadNurturing";

import AILeadScoring from "./AILeadScoring";

import AIPropertyDescriptionGenerator from "./AIPropertyDescriptionGenerator";

import AIPropertyWhisperer from "./AIPropertyWhisperer";

import AITeamAdvisor from "./AITeamAdvisor";

import AgentClub from "./AgentClub";

import AgentSearch from "./AgentSearch";

import Analytics from "./Analytics";

import AutomatedFollowups from "./AutomatedFollowups";

import BackupRestore from "./BackupRestore";

import BuyerDetail from "./BuyerDetail";

import BuyerReport from "./BuyerReport";

import Buyers from "./Buyers";

import CSVImport from "./CSVImport";

import CalculateGoalProgress from "./CalculateGoalProgress";

import Calendar from "./Calendar";

import Chat from "./Chat";

import ClientDashboard from "./ClientDashboard";

import ClientPortal from "./ClientPortal";

import ClientPortalSetup from "./ClientPortalSetup";

import ClientTransactionDetail from "./ClientTransactionDetail";

import CoachingResources from "./CoachingResources";

import Commissions from "./Commissions";

import ContactDetail from "./ContactDetail";

import Contacts from "./Contacts";

import DailyAdvice from "./DailyAdvice";

import Dashboard from "./Dashboard";

import DiagnoseCommissions from "./DiagnoseCommissions";

import DiagnoseTeam from "./DiagnoseTeam";

import Documents from "./Documents";

import DoorKnockingGuide from "./DoorKnockingGuide";

import EmailIntegration from "./EmailIntegration";

import EventsMap from "./EventsMap";

import ExternalViewer from "./ExternalViewer";

import FSBO from "./FSBO";

import FSBOAnalytics from "./FSBOAnalytics";

import FSBODetail from "./FSBODetail";

import FeedbackSuggestions from "./FeedbackSuggestions";

import GoalsManagement from "./GoalsManagement";

import HolidayDebug from "./HolidayDebug";

import Home from "./Home";

import HouseWorthEstimator from "./HouseWorthEstimator";

import InitializeComprehensiveDemo from "./InitializeComprehensiveDemo";

import InitializeDemoData from "./InitializeDemoData";

import InitializeHolidays from "./InitializeHolidays";

import InitializeMessagingDemo from "./InitializeMessagingDemo";

import InitializeRMEI from "./InitializeRMEI";

import InitializeTeamMembers from "./InitializeTeamMembers";

import InvestorHub from "./InvestorHub";

import JackieAI from "./JackieAI";

import JackieFollowups from "./JackieFollowups";

import JackieVoiceAssistant from "./JackieVoiceAssistant";

import KnowledgeBase from "./KnowledgeBase";

import LeadScoring from "./LeadScoring";

import Leads from "./Leads";

import LocationIntelligence from "./LocationIntelligence";

import MarketingCampaigns from "./MarketingCampaigns";

import MarketingDesignStudio from "./MarketingDesignStudio";

import Messages from "./Messages";

import MortgageCalculator from "./MortgageCalculator";

import MyGoals from "./MyGoals";

import NetSheetGenerator from "./NetSheetGenerator";

import News from "./News";

import NewsletterBuilder from "./NewsletterBuilder";

import Notifications from "./Notifications";

import OpenHouseFeedback from "./OpenHouseFeedback";

import OpenHouses from "./OpenHouses";

import Photos from "./Photos";

import PlanNextDay from "./PlanNextDay";

import Properties from "./Properties";

import PropertyAdd from "./PropertyAdd";

import PropertyAdviceAI from "./PropertyAdviceAI";

import PropertyAdvisor from "./PropertyAdvisor";

import PropertyAnalysis from "./PropertyAnalysis";

import PropertyDetail from "./PropertyDetail";

import RealtorTips from "./RealtorTips";

import Reports from "./Reports";

import ResetDemo from "./ResetDemo";

import ScamAlerts from "./ScamAlerts";

import ScheduleShowing from "./ScheduleShowing";

import ServiceAIInsights from "./ServiceAIInsights";

import ServiceAutomatedFollowups from "./ServiceAutomatedFollowups";

import ServiceDocumentIntelligence from "./ServiceDocumentIntelligence";

import ServiceLeadManagement from "./ServiceLeadManagement";

import ServiceMarketingAutomation from "./ServiceMarketingAutomation";

import ServiceTransactionPipeline from "./ServiceTransactionPipeline";

import Settings from "./Settings";

import Showings from "./Showings";

import SocialIntelligence from "./SocialIntelligence";

import SocialMediaPosting from "./SocialMediaPosting";

import SphereAutopilot from "./SphereAutopilot";

import SubdivisionPropertyDetail from "./SubdivisionPropertyDetail";

import SubdivisionSearch from "./SubdivisionSearch";

import TaskPackages from "./TaskPackages";

import Tasks from "./Tasks";

import TeamChat from "./TeamChat";

import TeamCollaboration from "./TeamCollaboration";

import TeamHub from "./TeamHub";

import TeamMemberDetail from "./TeamMemberDetail";

import TeamMembers from "./TeamMembers";

import TeamSurvey from "./TeamSurvey";

import TeamSurveyResults from "./TeamSurveyResults";

import TransactionDetail from "./TransactionDetail";

import TransactionEdit from "./TransactionEdit";

import Transactions from "./Transactions";

import Website from "./Website";

import WhatMyHomeWorth from "./WhatMyHomeWorth";

import WhyDidntItSell from "./WhyDidntItSell";

import WorkflowBuilder from "./WorkflowBuilder";

import Workflows from "./Workflows";

import dashboard from "./dashboard";

import { BrowserRouter as Router, Route, Routes, useLocation } from 'react-router-dom';

const PAGES = {
    
    AIBuyerPropertyMatcher: AIBuyerPropertyMatcher,
    
    AIDocumentIntelligence: AIDocumentIntelligence,
    
    AIEmailAssistant: AIEmailAssistant,
    
    AIInsights: AIInsights,
    
    AILeadNurturing: AILeadNurturing,
    
    AILeadScoring: AILeadScoring,
    
    AIPropertyDescriptionGenerator: AIPropertyDescriptionGenerator,
    
    AIPropertyWhisperer: AIPropertyWhisperer,
    
    AITeamAdvisor: AITeamAdvisor,
    
    AgentClub: AgentClub,
    
    AgentSearch: AgentSearch,
    
    Analytics: Analytics,
    
    AutomatedFollowups: AutomatedFollowups,
    
    BackupRestore: BackupRestore,
    
    BuyerDetail: BuyerDetail,
    
    BuyerReport: BuyerReport,
    
    Buyers: Buyers,
    
    CSVImport: CSVImport,
    
    CalculateGoalProgress: CalculateGoalProgress,
    
    Calendar: Calendar,
    
    Chat: Chat,
    
    ClientDashboard: ClientDashboard,
    
    ClientPortal: ClientPortal,
    
    ClientPortalSetup: ClientPortalSetup,
    
    ClientTransactionDetail: ClientTransactionDetail,
    
    CoachingResources: CoachingResources,
    
    Commissions: Commissions,
    
    ContactDetail: ContactDetail,
    
    Contacts: Contacts,
    
    DailyAdvice: DailyAdvice,
    
    Dashboard: Dashboard,
    
    DiagnoseCommissions: DiagnoseCommissions,
    
    DiagnoseTeam: DiagnoseTeam,
    
    Documents: Documents,
    
    DoorKnockingGuide: DoorKnockingGuide,
    
    EmailIntegration: EmailIntegration,
    
    EventsMap: EventsMap,
    
    ExternalViewer: ExternalViewer,
    
    FSBO: FSBO,
    
    FSBOAnalytics: FSBOAnalytics,
    
    FSBODetail: FSBODetail,
    
    FeedbackSuggestions: FeedbackSuggestions,
    
    GoalsManagement: GoalsManagement,
    
    HolidayDebug: HolidayDebug,
    
    Home: Home,
    
    HouseWorthEstimator: HouseWorthEstimator,
    
    InitializeComprehensiveDemo: InitializeComprehensiveDemo,
    
    InitializeDemoData: InitializeDemoData,
    
    InitializeHolidays: InitializeHolidays,
    
    InitializeMessagingDemo: InitializeMessagingDemo,
    
    InitializeRMEI: InitializeRMEI,
    
    InitializeTeamMembers: InitializeTeamMembers,
    
    InvestorHub: InvestorHub,
    
    JackieAI: JackieAI,
    
    JackieFollowups: JackieFollowups,
    
    JackieVoiceAssistant: JackieVoiceAssistant,
    
    KnowledgeBase: KnowledgeBase,
    
    LeadScoring: LeadScoring,
    
    Leads: Leads,
    
    LocationIntelligence: LocationIntelligence,
    
    MarketingCampaigns: MarketingCampaigns,
    
    MarketingDesignStudio: MarketingDesignStudio,
    
    Messages: Messages,
    
    MortgageCalculator: MortgageCalculator,
    
    MyGoals: MyGoals,
    
    NetSheetGenerator: NetSheetGenerator,
    
    News: News,
    
    NewsletterBuilder: NewsletterBuilder,
    
    Notifications: Notifications,
    
    OpenHouseFeedback: OpenHouseFeedback,
    
    OpenHouses: OpenHouses,
    
    Photos: Photos,
    
    PlanNextDay: PlanNextDay,
    
    Properties: Properties,
    
    PropertyAdd: PropertyAdd,
    
    PropertyAdviceAI: PropertyAdviceAI,
    
    PropertyAdvisor: PropertyAdvisor,
    
    PropertyAnalysis: PropertyAnalysis,
    
    PropertyDetail: PropertyDetail,
    
    RealtorTips: RealtorTips,
    
    Reports: Reports,
    
    ResetDemo: ResetDemo,
    
    ScamAlerts: ScamAlerts,
    
    ScheduleShowing: ScheduleShowing,
    
    ServiceAIInsights: ServiceAIInsights,
    
    ServiceAutomatedFollowups: ServiceAutomatedFollowups,
    
    ServiceDocumentIntelligence: ServiceDocumentIntelligence,
    
    ServiceLeadManagement: ServiceLeadManagement,
    
    ServiceMarketingAutomation: ServiceMarketingAutomation,
    
    ServiceTransactionPipeline: ServiceTransactionPipeline,
    
    Settings: Settings,
    
    Showings: Showings,
    
    SocialIntelligence: SocialIntelligence,
    
    SocialMediaPosting: SocialMediaPosting,
    
    SphereAutopilot: SphereAutopilot,
    
    SubdivisionPropertyDetail: SubdivisionPropertyDetail,
    
    SubdivisionSearch: SubdivisionSearch,
    
    TaskPackages: TaskPackages,
    
    Tasks: Tasks,
    
    TeamChat: TeamChat,
    
    TeamCollaboration: TeamCollaboration,
    
    TeamHub: TeamHub,
    
    TeamMemberDetail: TeamMemberDetail,
    
    TeamMembers: TeamMembers,
    
    TeamSurvey: TeamSurvey,
    
    TeamSurveyResults: TeamSurveyResults,
    
    TransactionDetail: TransactionDetail,
    
    TransactionEdit: TransactionEdit,
    
    Transactions: Transactions,
    
    Website: Website,
    
    WhatMyHomeWorth: WhatMyHomeWorth,
    
    WhyDidntItSell: WhyDidntItSell,
    
    WorkflowBuilder: WorkflowBuilder,
    
    Workflows: Workflows,
    
    dashboard: dashboard,
    
}

function _getCurrentPage(url) {
    if (url.endsWith('/')) {
        url = url.slice(0, -1);
    }
    let urlLastPart = url.split('/').pop();
    if (urlLastPart.includes('?')) {
        urlLastPart = urlLastPart.split('?')[0];
    }

    const pageName = Object.keys(PAGES).find(page => page.toLowerCase() === urlLastPart.toLowerCase());
    return pageName || Object.keys(PAGES)[0];
}

// Create a wrapper component that uses useLocation inside the Router context
function PagesContent() {
    const location = useLocation();
    const currentPage = _getCurrentPage(location.pathname);
    
    return (
        <Layout currentPageName={currentPage}>
            <Routes>            
                
                    <Route path="/" element={<AIBuyerPropertyMatcher />} />
                
                
                <Route path="/AIBuyerPropertyMatcher" element={<AIBuyerPropertyMatcher />} />
                
                <Route path="/AIDocumentIntelligence" element={<AIDocumentIntelligence />} />
                
                <Route path="/AIEmailAssistant" element={<AIEmailAssistant />} />
                
                <Route path="/AIInsights" element={<AIInsights />} />
                
                <Route path="/AILeadNurturing" element={<AILeadNurturing />} />
                
                <Route path="/AILeadScoring" element={<AILeadScoring />} />
                
                <Route path="/AIPropertyDescriptionGenerator" element={<AIPropertyDescriptionGenerator />} />
                
                <Route path="/AIPropertyWhisperer" element={<AIPropertyWhisperer />} />
                
                <Route path="/AITeamAdvisor" element={<AITeamAdvisor />} />
                
                <Route path="/AgentClub" element={<AgentClub />} />
                
                <Route path="/AgentSearch" element={<AgentSearch />} />
                
                <Route path="/Analytics" element={<Analytics />} />
                
                <Route path="/AutomatedFollowups" element={<AutomatedFollowups />} />
                
                <Route path="/BackupRestore" element={<BackupRestore />} />
                
                <Route path="/BuyerDetail" element={<BuyerDetail />} />
                
                <Route path="/BuyerReport" element={<BuyerReport />} />
                
                <Route path="/Buyers" element={<Buyers />} />
                
                <Route path="/CSVImport" element={<CSVImport />} />
                
                <Route path="/CalculateGoalProgress" element={<CalculateGoalProgress />} />
                
                <Route path="/Calendar" element={<Calendar />} />
                
                <Route path="/Chat" element={<Chat />} />
                
                <Route path="/ClientDashboard" element={<ClientDashboard />} />
                
                <Route path="/ClientPortal" element={<ClientPortal />} />
                
                <Route path="/ClientPortalSetup" element={<ClientPortalSetup />} />
                
                <Route path="/ClientTransactionDetail" element={<ClientTransactionDetail />} />
                
                <Route path="/CoachingResources" element={<CoachingResources />} />
                
                <Route path="/Commissions" element={<Commissions />} />
                
                <Route path="/ContactDetail" element={<ContactDetail />} />
                
                <Route path="/Contacts" element={<Contacts />} />
                
                <Route path="/DailyAdvice" element={<DailyAdvice />} />
                
                <Route path="/Dashboard" element={<Dashboard />} />
                
                <Route path="/DiagnoseCommissions" element={<DiagnoseCommissions />} />
                
                <Route path="/DiagnoseTeam" element={<DiagnoseTeam />} />
                
                <Route path="/Documents" element={<Documents />} />
                
                <Route path="/DoorKnockingGuide" element={<DoorKnockingGuide />} />
                
                <Route path="/EmailIntegration" element={<EmailIntegration />} />
                
                <Route path="/EventsMap" element={<EventsMap />} />
                
                <Route path="/ExternalViewer" element={<ExternalViewer />} />
                
                <Route path="/FSBO" element={<FSBO />} />
                
                <Route path="/FSBOAnalytics" element={<FSBOAnalytics />} />
                
                <Route path="/FSBODetail" element={<FSBODetail />} />
                
                <Route path="/FeedbackSuggestions" element={<FeedbackSuggestions />} />
                
                <Route path="/GoalsManagement" element={<GoalsManagement />} />
                
                <Route path="/HolidayDebug" element={<HolidayDebug />} />
                
                <Route path="/Home" element={<Home />} />
                
                <Route path="/HouseWorthEstimator" element={<HouseWorthEstimator />} />
                
                <Route path="/InitializeComprehensiveDemo" element={<InitializeComprehensiveDemo />} />
                
                <Route path="/InitializeDemoData" element={<InitializeDemoData />} />
                
                <Route path="/InitializeHolidays" element={<InitializeHolidays />} />
                
                <Route path="/InitializeMessagingDemo" element={<InitializeMessagingDemo />} />
                
                <Route path="/InitializeRMEI" element={<InitializeRMEI />} />
                
                <Route path="/InitializeTeamMembers" element={<InitializeTeamMembers />} />
                
                <Route path="/InvestorHub" element={<InvestorHub />} />
                
                <Route path="/JackieAI" element={<JackieAI />} />
                
                <Route path="/JackieFollowups" element={<JackieFollowups />} />
                
                <Route path="/JackieVoiceAssistant" element={<JackieVoiceAssistant />} />
                
                <Route path="/KnowledgeBase" element={<KnowledgeBase />} />
                
                <Route path="/LeadScoring" element={<LeadScoring />} />
                
                <Route path="/Leads" element={<Leads />} />
                
                <Route path="/LocationIntelligence" element={<LocationIntelligence />} />
                
                <Route path="/MarketingCampaigns" element={<MarketingCampaigns />} />
                
                <Route path="/MarketingDesignStudio" element={<MarketingDesignStudio />} />
                
                <Route path="/Messages" element={<Messages />} />
                
                <Route path="/MortgageCalculator" element={<MortgageCalculator />} />
                
                <Route path="/MyGoals" element={<MyGoals />} />
                
                <Route path="/NetSheetGenerator" element={<NetSheetGenerator />} />
                
                <Route path="/News" element={<News />} />
                
                <Route path="/NewsletterBuilder" element={<NewsletterBuilder />} />
                
                <Route path="/Notifications" element={<Notifications />} />
                
                <Route path="/OpenHouseFeedback" element={<OpenHouseFeedback />} />
                
                <Route path="/OpenHouses" element={<OpenHouses />} />
                
                <Route path="/Photos" element={<Photos />} />
                
                <Route path="/PlanNextDay" element={<PlanNextDay />} />
                
                <Route path="/Properties" element={<Properties />} />
                
                <Route path="/PropertyAdd" element={<PropertyAdd />} />
                
                <Route path="/PropertyAdviceAI" element={<PropertyAdviceAI />} />
                
                <Route path="/PropertyAdvisor" element={<PropertyAdvisor />} />
                
                <Route path="/PropertyAnalysis" element={<PropertyAnalysis />} />
                
                <Route path="/PropertyDetail" element={<PropertyDetail />} />
                
                <Route path="/RealtorTips" element={<RealtorTips />} />
                
                <Route path="/Reports" element={<Reports />} />
                
                <Route path="/ResetDemo" element={<ResetDemo />} />
                
                <Route path="/ScamAlerts" element={<ScamAlerts />} />
                
                <Route path="/ScheduleShowing" element={<ScheduleShowing />} />
                
                <Route path="/ServiceAIInsights" element={<ServiceAIInsights />} />
                
                <Route path="/ServiceAutomatedFollowups" element={<ServiceAutomatedFollowups />} />
                
                <Route path="/ServiceDocumentIntelligence" element={<ServiceDocumentIntelligence />} />
                
                <Route path="/ServiceLeadManagement" element={<ServiceLeadManagement />} />
                
                <Route path="/ServiceMarketingAutomation" element={<ServiceMarketingAutomation />} />
                
                <Route path="/ServiceTransactionPipeline" element={<ServiceTransactionPipeline />} />
                
                <Route path="/Settings" element={<Settings />} />
                
                <Route path="/Showings" element={<Showings />} />
                
                <Route path="/SocialIntelligence" element={<SocialIntelligence />} />
                
                <Route path="/SocialMediaPosting" element={<SocialMediaPosting />} />
                
                <Route path="/SphereAutopilot" element={<SphereAutopilot />} />
                
                <Route path="/SubdivisionPropertyDetail" element={<SubdivisionPropertyDetail />} />
                
                <Route path="/SubdivisionSearch" element={<SubdivisionSearch />} />
                
                <Route path="/TaskPackages" element={<TaskPackages />} />
                
                <Route path="/Tasks" element={<Tasks />} />
                
                <Route path="/TeamChat" element={<TeamChat />} />
                
                <Route path="/TeamCollaboration" element={<TeamCollaboration />} />
                
                <Route path="/TeamHub" element={<TeamHub />} />
                
                <Route path="/TeamMemberDetail" element={<TeamMemberDetail />} />
                
                <Route path="/TeamMembers" element={<TeamMembers />} />
                
                <Route path="/TeamSurvey" element={<TeamSurvey />} />
                
                <Route path="/TeamSurveyResults" element={<TeamSurveyResults />} />
                
                <Route path="/TransactionDetail" element={<TransactionDetail />} />
                
                <Route path="/TransactionEdit" element={<TransactionEdit />} />
                
                <Route path="/Transactions" element={<Transactions />} />
                
                <Route path="/Website" element={<Website />} />
                
                <Route path="/WhatMyHomeWorth" element={<WhatMyHomeWorth />} />
                
                <Route path="/WhyDidntItSell" element={<WhyDidntItSell />} />
                
                <Route path="/WorkflowBuilder" element={<WorkflowBuilder />} />
                
                <Route path="/Workflows" element={<Workflows />} />
                
                <Route path="/dashboard" element={<dashboard />} />
                
            </Routes>
        </Layout>
    );
}

export default function Pages() {
    return (
        <Router>
            <PagesContent />
        </Router>
    );
}
import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { Button } from "@/components/ui/button";
import { Database, Zap, PartyPopper, Loader2, AlertCircle, Trash2 } from "lucide-react";
import { format, subDays, addDays } from 'date-fns';
import { toast } from 'sonner';

export default function InitializeComprehensiveDemo() {
    const [isLoading, setIsLoading] = useState(false);
    const [isDeleting, setIsDeleting] = useState(false);
    const [logs, setLogs] = useState([]);
    const [isComplete, setIsComplete] = useState(false);
    const [stats, setStats] = useState({});

    const addLog = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        setLogs(prev => [...prev, { timestamp, message, type }]);
    };

    const updateStats = (key, value) => {
        setStats(prev => ({ ...prev, [key]: value }));
    };

    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const retryOperation = async (operation, maxRetries = 3) => {
        for (let i = 0; i < maxRetries; i++) {
            try {
                return await operation();
            } catch (error) {
                if (i === maxRetries - 1) throw error;
                addLog(`Retry attempt ${i + 1}/${maxRetries}...`, 'info');
                await delay(1000 * (i + 1));
            }
        }
    };

    const handleDeleteDemoData = async () => {
        if (!confirm("‚ö†Ô∏è DELETE ALL Southeast Florida Demo Data?\n\nThis will permanently delete:\n‚Ä¢ All properties\n‚Ä¢ All team members\n‚Ä¢ All transactions\n‚Ä¢ All leads\n‚Ä¢ All buyers\n‚Ä¢ All contacts\n‚Ä¢ All tasks\n‚Ä¢ All messages\n‚Ä¢ All photos\n\nThis action CANNOT be undone!")) {
            return;
        }

        setIsDeleting(true);
        setLogs([]);
        addLog("üóëÔ∏è Starting deletion of Southeast Florida demo data...", 'warning');

        try {
            // Delete in reverse order of creation to avoid dependencies
            
            // 1. Delete Messages
            addLog("Deleting messages...");
            const allMessages = await base44.entities.Message.list();
            for (const msg of allMessages) {
                try {
                    await base44.entities.Message.delete(msg.id);
                } catch (e) {
                    console.error("Error deleting message:", e);
                }
            }
            addLog(`‚úì Deleted ${allMessages.length} messages`, 'success');
            await delay(500);

            // 2. Delete Photos
            addLog("Deleting photos...");
            const allPhotos = await base44.entities.Photo.list();
            for (const photo of allPhotos) {
                try {
                    await base44.entities.Photo.delete(photo.id);
                } catch (e) {
                    console.error("Error deleting photo:", e);
                }
            }
            addLog(`‚úì Deleted ${allPhotos.length} photos`, 'success');
            await delay(500);

            // 3. Delete Transactions
            addLog("Deleting transactions...");
            const allTransactions = await base44.entities.Transaction.list();
            for (const tx of allTransactions) {
                try {
                    await base44.entities.Transaction.delete(tx.id);
                } catch (e) {
                    console.error("Error deleting transaction:", e);
                }
            }
            addLog(`‚úì Deleted ${allTransactions.length} transactions`, 'success');
            await delay(500);

            // 4. Delete Tasks
            addLog("Deleting tasks...");
            const allTasks = await base44.entities.Task.list();
            for (const task of allTasks) {
                try {
                    await base44.entities.Task.delete(task.id);
                } catch (e) {
                    console.error("Error deleting task:", e);
                }
            }
            addLog(`‚úì Deleted ${allTasks.length} tasks`, 'success');
            await delay(500);

            // 5. Delete Lead Activities
            addLog("Deleting lead activities...");
            const allActivities = await base44.entities.LeadActivity.list();
            for (const activity of allActivities) {
                try {
                    await base44.entities.LeadActivity.delete(activity.id);
                } catch (e) {
                    console.error("Error deleting activity:", e);
                }
            }
            addLog(`‚úì Deleted ${allActivities.length} lead activities`, 'success');
            await delay(500);

            // 6. Delete Properties
            addLog("Deleting properties...");
            const allProperties = await base44.entities.Property.list();
            for (const prop of allProperties) {
                try {
                    await base44.entities.Property.delete(prop.id);
                } catch (e) {
                    console.error("Error deleting property:", e);
                }
            }
            addLog(`‚úì Deleted ${allProperties.length} properties`, 'success');
            await delay(500);

            // 7. Delete Buyers
            addLog("Deleting buyers...");
            const allBuyers = await base44.entities.Buyer.list();
            for (const buyer of allBuyers) {
                try {
                    await base44.entities.Buyer.delete(buyer.id);
                } catch (e) {
                    console.error("Error deleting buyer:", e);
                }
            }
            addLog(`‚úì Deleted ${allBuyers.length} buyers`, 'success');
            await delay(500);

            // 8. Delete Leads
            addLog("Deleting leads...");
            const allLeads = await base44.entities.Lead.list();
            for (const lead of allLeads) {
                try {
                    await base44.entities.Lead.delete(lead.id);
                } catch (e) {
                    console.error("Error deleting lead:", e);
                }
            }
            addLog(`‚úì Deleted ${allLeads.length} leads`, 'success');
            await delay(500);

            // 9. Delete Contacts
            addLog("Deleting contacts...");
            const allContacts = await base44.entities.Contact.list();
            for (const contact of allContacts) {
                try {
                    await base44.entities.Contact.delete(contact.id);
                } catch (e) {
                    console.error("Error deleting contact:", e);
                }
            }
            addLog(`‚úì Deleted ${allContacts.length} contacts`, 'success');
            await delay(500);

            // 10. Delete Team Members
            addLog("Deleting team members...");
            const allTeamMembers = await base44.entities.TeamMember.list();
            for (const member of allTeamMembers) {
                try {
                    await base44.entities.TeamMember.delete(member.id);
                } catch (e) {
                    console.error("Error deleting team member:", e);
                }
            }
            addLog(`‚úì Deleted ${allTeamMembers.length} team members`, 'success');

            addLog("", 'info');
            addLog("‚úÖ All Southeast Florida demo data has been deleted!", 'success');
            toast.success("Demo data deleted successfully!");

        } catch (error) {
            console.error("Error deleting demo data:", error);
            addLog(`‚ùå Deletion Error: ${error.message}`, 'error');
            toast.error(`Deletion failed: ${error.message}`);
        } finally {
            setIsDeleting(false);
        }
    };

    const handleInitialization = async () => {
        if (!confirm("This will create comprehensive Southeast Florida demo data with 15 properties, full details, photos, and messages. Continue?")) {
            return;
        }

        setIsLoading(true);
        setIsComplete(false);
        setLogs([]);
        setStats({});

        try {
            const today = new Date();
            addLog("üöÄ Starting comprehensive Southeast Florida demo data initialization...", 'success');

            let user;
            try {
                user = await retryOperation(() => base44.auth.me());
                addLog(`‚úì Logged in as: ${user.full_name}`, 'success');
            } catch (error) {
                addLog(`‚ùå Failed to authenticate user: ${error.message}`, 'error');
                throw new Error("Authentication failed");
            }

            // STEP 1: CREATE TEAM MEMBERS
            addLog("üë• Creating Southeast Florida team members...");
            const teamMembers = [];
            const teamMemberData = [
                { name: "Sarah Martinez", email: "sarah.martinez@sefla.com", phone: "305-555-0101", role: "listing_agent", specialization: "luxury", city: "Miami Beach" },
                { name: "Michael Chen", email: "michael.chen@sefla.com", phone: "954-555-0102", role: "selling_agent", specialization: "residential", city: "Fort Lauderdale" },
                { name: "Jennifer Lopez", email: "jennifer.lopez@sefla.com", phone: "561-555-0103", role: "listing_agent", specialization: "luxury", city: "Palm Beach" },
                { name: "David Thompson", email: "david.thompson@sefla.com", phone: "954-555-0104", role: "selling_agent", specialization: "residential", city: "Boca Raton" },
                { name: "Maria Rodriguez", email: "maria.rodriguez@sefla.com", phone: "561-555-0105", role: "listing_agent", specialization: "residential", city: "Delray Beach" },
            ];

            for (const memberData of teamMemberData) {
                try {
                    const teamMember = await retryOperation(() => base44.entities.TeamMember.create({
                        full_name: memberData.name,
                        email: memberData.email,
                        phone: memberData.phone,
                        role: memberData.role,
                        specialization: memberData.specialization,
                        bio: `${memberData.specialization} specialist in ${memberData.city}`,
                        license_number: `FL${Math.floor(100000 + Math.random() * 900000)}`,
                        office: "Southeast Florida Realty Group",
                        commission_split: 70,
                        is_active: true,
                    }));
                    teamMembers.push(teamMember);
                    addLog(`  ‚úì Created: ${memberData.name}`, 'info');
                    await delay(400);
                } catch (error) {
                    addLog(`  ‚ö†Ô∏è Failed: ${memberData.name}`, 'error');
                }
            }
            updateStats('teamMembers', teamMembers.length);
            addLog(`‚úì Created ${teamMembers.length} team members`, 'success');

            // STEP 2: CREATE 15 PROPERTIES WITH FULL DETAILS
            addLog("üè† Creating 15 Southeast Florida properties with full details...");
            const properties = [];
            const propertyData = [
                { address: "123 Ocean Drive", city: "Miami Beach", state: "FL", zip: "33139", price: 1250000, beds: 3, baths: 3, sqft: 2200, type: "condo", status: "active", year: 2018, features: "Ocean Views,Balcony,Gym,Pool,Valet", description: "Stunning oceanfront condo in iconic Miami Beach building with breathtaking Atlantic views", photos: 4 },
                { address: "456 Las Olas Blvd", city: "Fort Lauderdale", state: "FL", zip: "33301", price: 875000, beds: 4, baths: 3, sqft: 2800, type: "single_family", status: "active", year: 2016, features: "Pool,Updated Kitchen,Impact Windows,2-Car Garage", description: "Beautiful single-family home in prime Las Olas location with pool and modern updates", photos: 5 },
                { address: "789 Worth Avenue", city: "Palm Beach", state: "FL", zip: "33480", price: 2950000, beds: 5, baths: 4.5, sqft: 4200, type: "single_family", status: "sold", year: 2020, features: "Waterfront,Private Dock,Guest House,Wine Cellar", description: "Magnificent Palm Beach estate with direct Intracoastal access and private dock", photos: 6 },
                { address: "321 Brickell Ave", city: "Miami", state: "FL", zip: "33131", price: 725000, beds: 2, baths: 2.5, sqft: 1650, type: "condo", status: "sold", year: 2019, features: "City Views,Concierge,Spa,Rooftop Pool", description: "Modern Brickell high-rise condo with stunning city and bay views", photos: 3 },
                { address: "654 Atlantic Blvd", city: "Pompano Beach", state: "FL", zip: "33062", price: 495000, beds: 3, baths: 2, sqft: 1850, type: "townhouse", status: "active", year: 2017, features: "Beach Access,Community Pool,Updated", description: "Charming townhouse just steps from Pompano Beach with community amenities", photos: 4 },
                { address: "987 Spanish River Rd", city: "Boca Raton", state: "FL", zip: "33432", price: 1575000, beds: 4, baths: 3.5, sqft: 3400, type: "single_family", status: "pending", year: 2015, features: "Golf Course,Pool,Smart Home,Upgraded", description: "Luxury home on Spanish River golf course with smart home technology", photos: 5 },
                { address: "147 Clematis Street", city: "West Palm Beach", state: "FL", zip: "33401", price: 625000, beds: 3, baths: 2, sqft: 1900, type: "condo", status: "active", year: 2021, features: "Downtown,Walkable,Rooftop Terrace", description: "Urban luxury condo in heart of downtown West Palm Beach", photos: 3 },
                { address: "258 Beach Road", city: "Deerfield Beach", state: "FL", zip: "33441", price: 550000, beds: 3, baths: 2.5, sqft: 2100, type: "single_family", status: "active", year: 2014, features: "Beach Access,Renovated Kitchen,Backyard", description: "Renovated beach house with direct beach access and tropical landscaping", photos: 4 },
                { address: "369 Mizner Blvd", city: "Boca Raton", state: "FL", zip: "33432", price: 985000, beds: 3, baths: 3, sqft: 2600, type: "condo", status: "active", year: 2019, features: "Waterfront,Marina,Gym,Concierge", description: "Waterfront condo with marina access and resort-style amenities", photos: 4 },
                { address: "741 Collins Ave", city: "Miami Beach", state: "FL", zip: "33140", price: 1895000, beds: 4, baths: 4, sqft: 3100, type: "condo", status: "pending", year: 2020, features: "Penthouse,Ocean Views,Private Elevator", description: "Spectacular penthouse with 360-degree ocean and city views", photos: 6 },
                { address: "852 SE 5th Avenue", city: "Delray Beach", state: "FL", zip: "33483", price: 695000, beds: 3, baths: 2, sqft: 2000, type: "single_family", status: "active", year: 2016, features: "Pool,Impact Windows,Open Floor Plan", description: "Charming Delray Beach home with pool and modern open concept", photos: 4 },
                { address: "963 Bayshore Drive", city: "Fort Lauderdale", state: "FL", zip: "33304", price: 1450000, beds: 4, baths: 3.5, sqft: 3200, type: "single_family", status: "active", year: 2017, features: "Waterfront,Boat Dock,Pool,Renovated", description: "Waterfront estate with private dock and stunning Intracoastal views", photos: 5 },
                { address: "159 Sunset Drive", city: "Coral Gables", state: "FL", zip: "33143", price: 1125000, beds: 4, baths: 3, sqft: 2900, type: "single_family", status: "active", year: 2015, features: "Historic District,Pool,Mature Trees", description: "Classic Coral Gables home in historic district with lush landscaping", photos: 4 },
                { address: "357 Royal Palm Way", city: "Boca Raton", state: "FL", zip: "33432", price: 825000, beds: 3, baths: 2.5, sqft: 2300, type: "single_family", status: "sold", year: 2018, features: "Gated Community,Pool,Lake Views", description: "Beautiful home in exclusive gated community with serene lake views", photos: 4 },
                { address: "486 Ocean Blvd", city: "Delray Beach", state: "FL", zip: "33483", price: 2250000, beds: 5, baths: 4, sqft: 3800, type: "single_family", status: "active", year: 2021, features: "Beachfront,Pool,Spa,Chef's Kitchen", description: "Stunning beachfront estate with resort-style pool and gourmet kitchen", photos: 6 },
            ];

            const photoUrls = [
                "https://images.unsplash.com/photo-1613490493576-7fde63acd811?w=800",
                "https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=800",
                "https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=800",
                "https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800",
                "https://images.unsplash.com/photo-1600566753190-17f0baa2a6c3?w=800",
                "https://images.unsplash.com/photo-1600585154526-990dced4db0d?w=800",
            ];

            for (let i = 0; i < propertyData.length; i++) {
                try {
                    const prop = propertyData[i];
                    const assignedAgent = teamMembers[i % teamMembers.length];
                    
                    const property = await retryOperation(() => base44.entities.Property.create({
                        address: prop.address,
                        city: prop.city,
                        state: prop.state,
                        zip_code: prop.zip,
                        price: prop.price,
                        property_type: prop.type,
                        bedrooms: prop.beds,
                        bathrooms: prop.baths,
                        square_feet: prop.sqft,
                        year_built: prop.year,
                        status: prop.status,
                        listing_agent_id: user.id,
                        listing_date: format(subDays(today, 30 + i * 3), 'yyyy-MM-dd'),
                        description: prop.description,
                        features: prop.features,
                        days_on_market: prop.status === 'active' ? Math.floor(Math.random() * 45) : 0,
                        commission_rate: 6,
                        listing_side_commission: 3,
                        selling_side_commission: 3,
                        agent_split_percentage: 70,
                        primary_photo_url: photoUrls[i % photoUrls.length],
                        mls_number: `MLS${100000 + i}`,
                        sellers_info: JSON.stringify([{
                            name: `${['Robert', 'Patricia', 'James', 'Mary', 'William'][i % 5]} ${['Anderson', 'Taylor', 'Thomas', 'Moore', 'Jackson'][i % 5]}`,
                            email: `seller${i + 1}@example.com`,
                            phone: `305-555-${1000 + i * 100}`,
                            mailing_address: `${prop.address}, ${prop.city}, FL ${prop.zip}`
                        }]),
                    }));
                    properties.push(property);
                    addLog(`  ‚úì Property ${i + 1}/15: ${prop.address} - $${(prop.price / 1000).toFixed(0)}K`, 'info');
                    
                    // CREATE PHOTOS FOR EACH PROPERTY
                    const photosToCreate = prop.photos || 3;
                    for (let j = 0; j < photosToCreate; j++) {
                        try {
                            await retryOperation(() => base44.entities.Photo.create({
                                property_id: property.id,
                                file_url: photoUrls[(i + j) % photoUrls.length],
                                caption: j === 0 ? 'Main Photo' : `Interior View ${j}`,
                                category: j === 0 ? 'exterior' : ['interior', 'kitchen', 'bathroom'][j % 3],
                                uploaded_by: user.id,
                                approval_status: 'approved',
                                is_primary: j === 0,
                                display_order: j,
                            }));
                        } catch (e) {
                            console.error("Error creating photo:", e);
                        }
                    }
                    await delay(600);
                } catch (error) {
                    addLog(`  ‚ö†Ô∏è Failed property ${i + 1}: ${error.message}`, 'error');
                }
            }
            updateStats('properties', properties.length);
            updateStats('photos', properties.reduce((sum, p) => sum + (propertyData.find(pd => pd.address === p.address)?.photos || 3), 0));
            addLog(`‚úì Created ${properties.length} properties with photos`, 'success');

            // STEP 3: CREATE BUYERS
            addLog("üë• Creating buyers...");
            const buyers = [];
            const buyerData = [
                { first: "John", last: "Smith", email: "john.smith@example.com", phone: "954-555-2001", budget: [400000, 700000] },
                { first: "Emily", last: "Johnson", email: "emily.johnson@example.com", phone: "954-555-2002", budget: [600000, 1000000] },
                { first: "Michael", last: "Williams", email: "michael.williams@example.com", phone: "305-555-2003", budget: [800000, 1500000] },
                { first: "Sarah", last: "Brown", email: "sarah.brown@example.com", phone: "561-555-2004", budget: [500000, 900000] },
                { first: "David", last: "Jones", email: "david.jones@example.com", phone: "954-555-2005", budget: [450000, 750000] },
                { first: "Lisa", last: "Garcia", email: "lisa.garcia@example.com", phone: "305-555-2006", budget: [1000000, 2000000] },
            ];

            for (const b of buyerData) {
                try {
                    const buyer = await retryOperation(() => base44.entities.Buyer.create({
                        first_name: b.first,
                        last_name: b.last,
                        email: b.email,
                        phone: b.phone,
                        budget_min: b.budget[0],
                        budget_max: b.budget[1],
                        pre_approved: true,
                        pre_approval_amount: b.budget[1],
                        min_bedrooms: 3,
                        min_bathrooms: 2,
                        preferred_locations: "Miami Beach,Fort Lauderdale,Boca Raton",
                        property_type_preference: "single_family",
                        timeline: "3_6_months",
                        status: "active",
                        assigned_agent_id: user.id,
                    }));
                    buyers.push(buyer);
                    await delay(300);
                } catch (error) {
                    addLog(`  ‚ö†Ô∏è Failed buyer: ${b.first} ${b.last}`, 'error');
                }
            }
            updateStats('buyers', buyers.length);
            addLog(`‚úì Created ${buyers.length} buyers`, 'success');

            // STEP 4: CREATE TRANSACTIONS (for sold/pending properties)
            addLog("üíº Creating transactions...");
            const transactions = [];
            const transactionProperties = properties.filter(p => p.status === 'sold' || p.status === 'pending');

            for (let i = 0; i < transactionProperties.length; i++) {
                try {
                    const property = transactionProperties[i];
                    const buyerIndex = i % buyers.length;
                    const sellingAgentIndex = (i + 1) % teamMembers.length;
                    
                    const contractPrice = property.price;
                    const listingGross = contractPrice * 0.03;
                    const sellingGross = contractPrice * 0.03;
                    const listingNet = listingGross * 0.70;
                    const sellingNet = sellingGross * 0.70;

                    const transaction = await retryOperation(() => base44.entities.Transaction.create({
                        property_id: property.id,
                        listing_agent_id: user.id,
                        selling_agent_id: user.id,
                        buyer_id: buyers[buyerIndex]?.id,
                        transaction_type: "sale",
                        status: property.status === 'sold' ? 'closed' : 'active',
                        contract_price: contractPrice,
                        commission_listing: 3,
                        commission_selling: 3,
                        agent_split_percentage: 70,
                        commission_total: contractPrice * 0.06,
                        listing_gross_commission: listingGross,
                        listing_net_commission: listingNet,
                        selling_gross_commission: sellingGross,
                        selling_net_commission: sellingNet,
                        selling_agent_name: teamMembers[sellingAgentIndex]?.full_name || "External Agent",
                        important_dates: {
                            offer_date: format(subDays(today, 45), 'yyyy-MM-dd'),
                            acceptance_date: format(subDays(today, 40), 'yyyy-MM-dd'),
                            inspection_date: format(subDays(today, 30), 'yyyy-MM-dd'),
                            financing_deadline: format(subDays(today, 15), 'yyyy-MM-dd'),
                            closing_date: property.status === 'sold' ? format(subDays(today, 5), 'yyyy-MM-dd') : format(addDays(today, 10), 'yyyy-MM-dd'),
                        },
                    }));
                    transactions.push(transaction);
                    addLog(`  ‚úì Transaction ${i + 1}: ${property.address}`, 'info');
                    await delay(500);
                } catch (error) {
                    addLog(`  ‚ö†Ô∏è Failed transaction ${i + 1}`, 'error');
                }
            }
            updateStats('transactions', transactions.length);
            addLog(`‚úì Created ${transactions.length} transactions`, 'success');

            // STEP 5: CREATE MESSAGES BETWEEN ALL PARTIES
            addLog("üí¨ Creating messages between all parties involved...");
            let messagesCreated = 0;
            
            for (const property of properties.slice(0, 10)) {
                try {
                    const threadId = `property_${property.id}`;
                    
                    // Parse sellers
                    let sellers = [];
                    try {
                        sellers = JSON.parse(property.sellers_info || '[]');
                    } catch (e) {}
                    
                    // Message 1: Listing Agent ‚Üí Seller
                    if (sellers.length > 0) {
                        await retryOperation(() => base44.entities.Message.create({
                            thread_id: `${threadId}_listing_seller`,
                            sender_id: user.id,
                            recipient_email: sellers[0].email,
                            subject: `Update on ${property.address}`,
                            content: `Hi ${sellers[0].name.split(' ')[0]}, I wanted to update you on the interest we're getting for your property at ${property.address}. We've had ${Math.floor(2 + Math.random() * 5)} showings this week and the feedback has been very positive!`,
                            property_id: property.id,
                            message_type: 'internal',
                            is_read: Math.random() > 0.5,
                        }));
                        messagesCreated++;
                        await delay(300);
                        
                        // Message 2: Seller ‚Üí Listing Agent (Reply)
                        await retryOperation(() => base44.entities.Message.create({
                            thread_id: `${threadId}_listing_seller`,
                            sender_id: user.id, // Using user as sender (simulated)
                            recipient_id: user.id,
                            subject: `RE: Update on ${property.address}`,
                            content: `That's great news! Thank you for keeping me informed. Do you think we should consider any price adjustments?`,
                            property_id: property.id,
                            message_type: 'internal',
                            is_read: true,
                        }));
                        messagesCreated++;
                        await delay(300);
                    }
                    
                    // Message 3: Listing Agent ‚Üí Selling Agent (for pending/sold properties)
                    if (property.status === 'pending' || property.status === 'sold') {
                        const transaction = transactions.find(t => t.property_id === property.id);
                        if (transaction) {
                            await retryOperation(() => base44.entities.Message.create({
                                thread_id: `${threadId}_agents`,
                                sender_id: user.id,
                                recipient_id: user.id,
                                subject: `Coordinating closing for ${property.address}`,
                                content: `Hi ${transaction.selling_agent_name}, the inspection came back clean and we're on track for closing on ${transaction.important_dates?.closing_date}. Please confirm your buyer has completed their final walkthrough.`,
                                property_id: property.id,
                                message_type: 'internal',
                                is_read: true,
                            }));
                            messagesCreated++;
                            await delay(300);
                            
                            // Message 4: Selling Agent ‚Üí Listing Agent (Reply)
                            await retryOperation(() => base44.entities.Message.create({
                                thread_id: `${threadId}_agents`,
                                sender_id: user.id,
                                recipient_id: user.id,
                                subject: `RE: Coordinating closing for ${property.address}`,
                                content: `Perfect! My buyer is very excited. We'll do the final walkthrough tomorrow. All financing is approved and we're ready to close.`,
                                property_id: property.id,
                                message_type: 'internal',
                                is_read: Math.random() > 0.3,
                            }));
                            messagesCreated++;
                            await delay(300);
                        }
                    }
                    
                } catch (error) {
                    console.error("Error creating messages for property:", error);
                }
            }
            updateStats('messages', messagesCreated);
            addLog(`‚úì Created ${messagesCreated} messages between parties`, 'success');

            // STEP 6: CREATE LEADS
            addLog("üéØ Creating leads...");
            const leads = [];
            for (let i = 0; i < 15; i++) {
                try {
                    const lead = await retryOperation(() => base44.entities.Lead.create({
                        name: `${['Daniel', 'Jessica', 'Ryan', 'Amanda', 'Kevin'][i % 5]} ${['Martinez', 'Thompson', 'Garcia', 'Miller', 'Wilson'][i % 5]}`,
                        email: `lead${i + 1}@example.com`,
                        phone: `954-555-${3000 + i * 10}`,
                        status: ["new", "contacted", "qualified"][i % 3],
                        score: 50 + Math.floor(Math.random() * 40),
                        lead_source: ["website", "zillow", "referral"][i % 3],
                        assigned_agent_id: user.id,
                        owner_id: user.id,
                        notes: `Interested in ${['Miami Beach', 'Fort Lauderdale', 'Boca Raton'][i % 3]} properties`,
                    }));
                    leads.push(lead);
                    await delay(200);
                } catch (error) {
                    addLog(`  ‚ö†Ô∏è Failed lead ${i + 1}`, 'error');
                }
            }
            updateStats('leads', leads.length);
            addLog(`‚úì Created ${leads.length} leads`, 'success');

            // STEP 7: CREATE TASKS
            addLog("‚úÖ Creating tasks...");
            const tasks = [];
            for (let i = 0; i < 20; i++) {
                try {
                    const task = await retryOperation(() => base44.entities.Task.create({
                        title: `${['Schedule photos', 'Order sign', 'Send documents', 'Follow up', 'Schedule showing'][i % 5]} - ${properties[i % properties.length].address}`,
                        description: "Complete this task for the property.",
                        property_id: properties[i % properties.length]?.id,
                        assigned_to: user.id,
                        task_type: ["contract", "marketing", "documentation"][i % 3],
                        priority: ["high", "medium", "low"][i % 3],
                        status: i < 10 ? "completed" : "pending",
                        due_date: format(addDays(today, -5 + i), 'yyyy-MM-dd'),
                    }));
                    tasks.push(task);
                    await delay(150);
                } catch (error) {
                    addLog(`  ‚ö†Ô∏è Failed task ${i + 1}`, 'error');
                }
            }
            updateStats('tasks', tasks.length);
            addLog(`‚úì Created ${tasks.length} tasks`, 'success');

            // STEP 8: CREATE CONTACTS
            addLog("üìá Creating contacts...");
            const contacts = [];
            for (let i = 0; i < 12; i++) {
                try {
                    const contact = await retryOperation(() => base44.entities.Contact.create({
                        name: `${['Alex', 'Jordan', 'Taylor', 'Casey', 'Morgan'][i % 5]} ${['Davis', 'Miller', 'Wilson', 'Moore', 'Anderson'][i % 5]}`,
                        email: `contact${i + 1}@example.com`,
                        phone: `561-555-${4000 + i * 10}`,
                        relationship: ["past_client", "professional"][i % 2],
                        last_contact_date: format(subDays(today, Math.floor(Math.random() * 60)), 'yyyy-MM-dd'),
                        notes: "Valuable contact in Southeast Florida network.",
                    }));
                    contacts.push(contact);
                    await delay(200);
                } catch (error) {
                    addLog(`  ‚ö†Ô∏è Failed contact ${i + 1}`, 'error');
                }
            }
            updateStats('contacts', contacts.length);
            addLog(`‚úì Created ${contacts.length} contacts`, 'success');

            // Summary
            addLog("", 'info');
            addLog("üìä Southeast Florida Demo Data Summary:", 'success');
            addLog(`  ‚Ä¢ ${stats.teamMembers} team members`, 'info');
            addLog(`  ‚Ä¢ ${stats.properties} properties with full details`, 'info');
            addLog(`  ‚Ä¢ ${stats.photos} property photos`, 'info');
            addLog(`  ‚Ä¢ ${stats.transactions} transactions`, 'info');
            addLog(`  ‚Ä¢ ${stats.messages} messages between parties`, 'info');
            addLog(`  ‚Ä¢ ${stats.buyers} buyers`, 'info');
            addLog(`  ‚Ä¢ ${stats.leads} leads`, 'info');
            addLog(`  ‚Ä¢ ${stats.tasks} tasks`, 'info');
            addLog(`  ‚Ä¢ ${stats.contacts} contacts`, 'info');
            addLog("", 'info');
            addLog("üéâ Comprehensive Southeast Florida demo data created!", 'success');
            
            setIsComplete(true);
            toast.success("Demo data initialized successfully!");

        } catch (error) {
            console.error("Initialization error:", error);
            addLog(`‚ùå Critical Error: ${error.message}`, 'error');
            toast.error(`Failed: ${error.message}`);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="page-container space-y-6">
            <div className="app-card p-8">
                <div className="text-center mb-8">
                    <div className="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <Database className="w-10 h-10 text-white" />
                    </div>
                    <h1 className="app-title text-3xl mb-2">Southeast Florida Demo Data</h1>
                    <p className="app-subtitle max-w-2xl mx-auto">
                        Create comprehensive Southeast Florida demo data with 15 properties, full details, multiple photos, and messages between all parties.
                    </p>
                </div>

                <div className="flex justify-center gap-4">
                    <Button
                        onClick={handleDeleteDemoData}
                        disabled={isDeleting || isLoading}
                        size="lg"
                        variant="destructive"
                    >
                        {isDeleting ? (
                            <>
                                <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                Deleting...
                            </>
                        ) : (
                            <>
                                <Trash2 className="w-5 h-5 mr-2" />
                                Delete All Demo Data
                            </>
                        )}
                    </Button>

                    <Button
                        onClick={handleInitialization}
                        disabled={isLoading || isDeleting}
                        size="lg"
                        className="app-button-primary"
                    >
                        {isLoading ? (
                            <>
                                <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                Creating...
                            </>
                        ) : (
                            <>
                                <Zap className="w-5 h-5 mr-2" />
                                Create Demo Data
                            </>
                        )}
                    </Button>
                </div>

                {Object.keys(stats).length > 0 && (
                    <div className="mt-8 grid grid-cols-2 md:grid-cols-5 gap-4">
                        {Object.entries(stats).map(([key, value]) => (
                            <div key={key} className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                                <div className="text-3xl font-bold text-indigo-600">{value}</div>
                                <div className="text-xs text-slate-600 dark:text-slate-400 capitalize mt-1">
                                    {key.replace(/([A-Z])/g, ' $1').trim()}
                                </div>
                            </div>
                        ))}
                    </div>
                )}

                {isComplete && !isLoading && (
                    <div className="mt-8 p-6 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                        <PartyPopper className="w-12 h-12 text-green-600 mx-auto mb-4" />
                        <h3 className="text-xl font-semibold text-green-800 dark:text-green-200 text-center">Success!</h3>
                        <p className="text-green-700 dark:text-green-300 text-center">Your Southeast Florida demo is ready!</p>
                    </div>
                )}

                {logs.length > 0 && (
                    <div className="mt-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg max-h-96 overflow-y-auto">
                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                            <AlertCircle className="w-4 h-4" />
                            Activity Log
                        </h3>
                        <ul className="space-y-1">
                            {logs.map((log, index) => (
                                <li 
                                    key={index} 
                                    className={`text-sm ${
                                        log.type === 'error' ? 'text-red-600 dark:text-red-400' :
                                        log.type === 'success' ? 'text-green-600 dark:text-green-400' :
                                        log.type === 'warning' ? 'text-yellow-600 dark:text-yellow-400' :
                                        'text-slate-600 dark:text-slate-300'
                                    }`}
                                >
                                    <span className="font-mono text-xs bg-slate-200 dark:bg-slate-700 rounded px-1.5 py-0.5 mr-2">
                                        {log.timestamp}
                                    </span>
                                    {log.message}
                                </li>
                            ))}
                        </ul>
                    </div>
                )}
            </div>
        </div>
    );
}

import React, { useState } from "react";
import { Property } from "@/api/entities";
import { Transaction } from "@/api/entities";
import { Task } from "@/api/entities";
import { Document } from "@/api/entities";
import { Photo } from "@/api/entities";
import { User } from "@/api/entities";
import { Button } from "@/components/ui/button";
import { Loader2, CheckCircle, Database, AlertCircle } from "lucide-react";

export default function InitializeDemoData() {
  const [isLoading, setIsLoading] = useState(false);
  const [status, setStatus] = useState("");
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState("");

  const initializeDemoData = async () => {
    setIsLoading(true);
    setStatus("Initializing demo data...");
    setError("");
    setSuccess(false);

    try {
      // Get current user
      setStatus("Getting current user...");
      const currentUser = await User.me();
      
      // Get all properties
      setStatus("Loading properties...");
      const properties = await Property.list();
      
      if (properties.length === 0) {
        setError("No properties found. Please add properties first.");
        setIsLoading(false);
        return;
      }

      const property1 = properties[0];
      const property2 = properties[1] || properties[0];
      const property3 = properties[2] || properties[0];

      // Create Transactions
      setStatus("Creating transactions...");
      const transaction1 = await Transaction.create({
        property_id: property1.id,
        transaction_type: "sale",
        status: "active",
        contract_price: property1.price * 0.95,
        listing_side_progress: 45,
        selling_side_progress: 35,
        commission_listing: 2.5,
        commission_selling: 2.5,
        important_dates: {
          offer_date: "2025-01-10",
          acceptance_date: "2025-01-12",
          inspection_deadline: "2025-01-25",
          financing_deadline: "2025-02-01",
          closing_date: "2025-02-15"
        }
      });

      await Transaction.create({
        property_id: property2.id,
        transaction_type: "sale",
        status: "pending",
        contract_price: property2.price * 0.97,
        listing_side_progress: 75,
        selling_side_progress: 70,
        commission_listing: 2.5,
        commission_selling: 2.5,
        important_dates: {
          offer_date: "2025-01-05",
          acceptance_date: "2025-01-07",
          inspection_deadline: "2025-01-20",
          financing_deadline: "2025-01-27",
          closing_date: "2025-02-10"
        }
      });

      // Create Tasks
      setStatus("Creating tasks...");
      await Task.create({
        title: "Schedule property inspection",
        description: "Coordinate with inspector for home inspection",
        property_id: property1.id,
        task_type: "inspection",
        priority: "high",
        status: "pending",
        due_date: "2025-01-25",
        assigned_to: currentUser.id
      });

      await Task.create({
        title: "Upload professional photos",
        description: "Upload high-quality photos to MLS and website",
        property_id: property1.id,
        task_type: "marketing",
        priority: "critical",
        status: "in_progress",
        due_date: "2025-01-20",
        assigned_to: currentUser.id
      });

      await Task.create({
        title: "Review purchase agreement",
        description: "Review and finalize purchase agreement with client",
        property_id: property2.id,
        task_type: "contract",
        priority: "critical",
        status: "in_progress",
        due_date: "2025-01-22",
        assigned_to: currentUser.id
      });

      await Task.create({
        title: "Prepare closing documents",
        description: "Gather all documents needed for closing",
        property_id: property2.id,
        task_type: "closing",
        priority: "high",
        status: "pending",
        due_date: "2025-02-08",
        assigned_to: currentUser.id
      });

      await Task.create({
        title: "Schedule open house",
        description: "Plan and promote weekend open house event",
        property_id: property3.id,
        task_type: "marketing",
        priority: "medium",
        status: "pending",
        due_date: "2025-01-26",
        assigned_to: currentUser.id
      });

      // Create Photos
      setStatus("Creating photos...");
      const photoUrls = [
        "https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=800",
        "https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800",
        "https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=800",
        "https://images.unsplash.com/photo-1600566753190-17f0baa2a6c3?w=800",
        "https://images.unsplash.com/photo-1600573472591-ee6e6daf5089?w=800"
      ];

      for (let i = 0; i < photoUrls.length; i++) {
        await Photo.create({
          property_id: i < 2 ? property1.id : i < 4 ? property2.id : property3.id,
          file_url: photoUrls[i],
          caption: `Professional photo ${i + 1}`,
          category: i === 0 ? "exterior" : i === 1 ? "interior" : i === 2 ? "kitchen" : i === 3 ? "bathroom" : "bedroom",
          uploaded_by: currentUser.id,
          approval_status: "approved",
          is_primary: i === 0
        });
      }

      // Create Documents
      setStatus("Creating documents...");
      await Document.create({
        property_id: property1.id,
        transaction_id: transaction1.id,
        file_url: "demo-file-url-1",
        document_name: "Purchase Agreement.pdf",
        document_type: "contract",
        uploaded_by: currentUser.id,
        status: "approved"
      });

      await Document.create({
        property_id: property1.id,
        transaction_id: transaction1.id,
        file_url: "demo-file-url-2",
        document_name: "Property Disclosure.pdf",
        document_type: "disclosure",
        uploaded_by: currentUser.id,
        status: "approved"
      });

      await Document.create({
        property_id: property2.id,
        file_url: "demo-file-url-3",
        document_name: "Inspection Report.pdf",
        document_type: "inspection",
        uploaded_by: currentUser.id,
        status: "pending"
      });

      await Document.create({
        property_id: property2.id,
        file_url: "demo-file-url-4",
        document_name: "Appraisal Report.pdf",
        document_type: "appraisal",
        uploaded_by: currentUser.id,
        status: "approved"
      });

      setStatus("Demo data initialized successfully!");
      setSuccess(true);
    } catch (error) {
      console.error("Error initializing demo data:", error);
      setError(`Failed to initialize demo data: ${error.message}`);
    }
    
    setIsLoading(false);
  };

  return (
    <div className="p-4 min-h-screen flex items-center justify-center">
      <div className="app-card max-w-2xl w-full p-8">
        <div className="text-center mb-8">
          <Database className="w-16 h-16 mx-auto mb-4 text-indigo-600" />
          <h1 className="app-title text-3xl mb-2">Initialize Demo Data</h1>
          <p className="app-text-muted">
            Click the button below to populate your property details with demo transactions, tasks, documents, and photos.
          </p>
        </div>

        {status && !success && !error && (
          <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center gap-3">
            <Loader2 className="w-5 h-5 text-blue-600 animate-spin" />
            <span className="text-blue-900 font-medium">{status}</span>
          </div>
        )}

        {success && (
          <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
            <CheckCircle className="w-5 h-5 text-green-600" />
            <div>
              <span className="text-green-900 font-medium block">{status}</span>
              <span className="text-green-700 text-sm">You can now view properties with full details!</span>
            </div>
          </div>
        )}

        {error && (
          <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-3">
            <AlertCircle className="w-5 h-5 text-red-600" />
            <span className="text-red-900 font-medium">{error}</span>
          </div>
        )}

        <div className="space-y-4">
          <Button
            onClick={initializeDemoData}
            disabled={isLoading || success}
            className="w-full app-button py-4 text-lg"
          >
            {isLoading ? (
              <>
                <Loader2 className="w-5 h-5 animate-spin" />
                <span>Initializing...</span>
              </>
            ) : success ? (
              <>
                <CheckCircle className="w-5 h-5" />
                <span>Demo Data Initialized</span>
              </>
            ) : (
              <>
                <Database className="w-5 h-5" />
                <span>Initialize Demo Data</span>
              </>
            )}
          </Button>

          {success && (
            <div className="text-center pt-4">
              <a href="/Properties" className="text-indigo-600 hover:text-indigo-700 font-medium">
                Go to Properties ‚Üí
              </a>
            </div>
          )}
        </div>

        <div className="mt-8 p-4 bg-slate-50 rounded-lg">
          <h3 className="font-semibold text-slate-900 mb-2">What will be created:</h3>
          <ul className="space-y-1 text-sm text-slate-600">
            <li>‚Ä¢ 2 Active transactions with progress tracking</li>
            <li>‚Ä¢ 5 Tasks across multiple properties</li>
            <li>‚Ä¢ 5 Professional property photos</li>
            <li>‚Ä¢ 4 Important documents (contracts, disclosures, etc.)</li>
          </ul>
        </div>
      </div>
    </div>
  );
}


import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Calendar, Loader2, CheckCircle, AlertTriangle, RefreshCw } from 'lucide-react';
import { toast } from 'sonner';

export default function InitializeHolidays() {
    const [isInitializing, setIsInitializing] = useState(false);
    const [progress, setProgress] = useState('');
    const [results, setResults] = useState(null);
    const [debugLog, setDebugLog] = useState([]);

    const addLog = (message, type = 'info') => {
        console.log(`[Holiday Init ${type}]`, message);
        setDebugLog(prev => [...prev, { message, type, time: new Date().toLocaleTimeString() }]);
    };

    const holidays2025 = [
        // US Federal Holidays
        { name: "New Year's Day", date: "2025-01-01", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: true, color: "#3b82f6", observance_level: "major", description: "First day of the year" },
        { name: "Martin Luther King Jr. Day", date: "2025-01-20", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: true, color: "#8b5cf6", observance_level: "major", description: "Honoring civil rights leader" },
        { name: "Presidents' Day", date: "2025-02-17", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: true, color: "#3b82f6", observance_level: "major", description: "Honoring U.S. presidents" },
        { name: "Memorial Day", date: "2025-05-26", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: true, color: "#ef4444", observance_level: "major", description: "Remembering fallen military members" },
        { name: "Juneteenth", date: "2025-06-19", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: true, color: "#10b981", observance_level: "major", description: "Emancipation Day" },
        { name: "Independence Day", date: "2025-07-04", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: true, color: "#ef4444", observance_level: "major", description: "U.S. Independence Day" },
        { name: "Labor Day", date: "2025-09-01", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: true, color: "#f59e0b", observance_level: "major", description: "Honoring American workers" },
        { name: "Columbus Day", date: "2025-10-13", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: false, color: "#3b82f6", observance_level: "minor", description: "Discovery of Americas" },
        { name: "Veterans Day", date: "2025-11-11", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: true, color: "#dc2626", observance_level: "major", description: "Honoring military veterans" },
        { name: "Thanksgiving Day", date: "2025-11-27", holiday_type: "federal", religion: "secular", is_federal: true, businesses_closed: true, color: "#f97316", observance_level: "major", description: "National day of gratitude" },
        { name: "Christmas Day", date: "2025-12-25", holiday_type: "federal", religion: "christian", is_federal: true, businesses_closed: true, color: "#dc2626", observance_level: "major", description: "Birth of Jesus Christ" },

        // Christian Holidays
        { name: "Good Friday", date: "2025-04-18", holiday_type: "religious", religion: "christian", is_federal: false, businesses_closed: false, color: "#dc2626", observance_level: "major", description: "Crucifixion of Jesus" },
        { name: "Easter Sunday", date: "2025-04-20", holiday_type: "religious", religion: "christian", is_federal: false, businesses_closed: false, color: "#f472b6", observance_level: "major", description: "Resurrection of Jesus" },
        { name: "Christmas Eve", date: "2025-12-24", holiday_type: "religious", religion: "christian", is_federal: false, businesses_closed: false, color: "#dc2626", observance_level: "major", description: "Night before Christmas" },

        // Jewish Holidays
        { name: "Passover (First Day)", date: "2025-04-13", holiday_type: "religious", religion: "jewish", is_federal: false, businesses_closed: false, color: "#3b82f6", observance_level: "major", description: "Exodus from Egypt" },
        { name: "Rosh Hashanah (First Day)", date: "2025-09-23", holiday_type: "religious", religion: "jewish", is_federal: false, businesses_closed: false, color: "#3b82f6", observance_level: "major", description: "Jewish New Year" },
        { name: "Yom Kippur", date: "2025-10-02", holiday_type: "religious", religion: "jewish", is_federal: false, businesses_closed: false, color: "#3b82f6", observance_level: "major", description: "Day of Atonement" },
        { name: "Hanukkah (First Day)", date: "2025-12-15", holiday_type: "religious", religion: "jewish", is_federal: false, businesses_closed: false, color: "#3b82f6", observance_level: "major", description: "Festival of Lights" },

        // Muslim Holidays
        { name: "Ramadan Begins", date: "2025-03-01", holiday_type: "religious", religion: "muslim", is_federal: false, businesses_closed: false, color: "#10b981", observance_level: "major", description: "Islamic holy month" },
        { name: "Eid al-Fitr", date: "2025-03-31", holiday_type: "religious", religion: "muslim", is_federal: false, businesses_closed: false, color: "#10b981", observance_level: "major", description: "End of Ramadan" },
        { name: "Eid al-Adha", date: "2025-06-07", holiday_type: "religious", religion: "muslim", is_federal: false, businesses_closed: false, color: "#10b981", observance_level: "major", description: "Festival of Sacrifice" },

        // Hindu Holidays
        { name: "Holi", date: "2025-03-14", holiday_type: "religious", religion: "hindu", is_federal: false, businesses_closed: false, color: "#f59e0b", observance_level: "major", description: "Festival of Colors" },
        { name: "Diwali", date: "2025-10-20", holiday_type: "religious", religion: "hindu", is_federal: false, businesses_closed: false, color: "#f59e0b", observance_level: "major", description: "Festival of Lights" },

        // Buddhist Holidays
        { name: "Vesak", date: "2025-05-12", holiday_type: "religious", religion: "buddhist", is_federal: false, businesses_closed: false, color: "#fbbf24", observance_level: "major", description: "Buddha's Birthday" },

        // Cultural Observances
        { name: "Valentine's Day", date: "2025-02-14", holiday_type: "cultural", religion: "secular", is_federal: false, businesses_closed: false, color: "#ec4899", observance_level: "minor", description: "Day of love" },
        { name: "St. Patrick's Day", date: "2025-03-17", holiday_type: "cultural", religion: "secular", is_federal: false, businesses_closed: false, color: "#10b981", observance_level: "minor", description: "Irish cultural celebration" },
        { name: "Cinco de Mayo", date: "2025-05-05", holiday_type: "cultural", religion: "secular", is_federal: false, businesses_closed: false, color: "#10b981", observance_level: "minor", description: "Mexican cultural celebration" },
        { name: "Halloween", date: "2025-10-31", holiday_type: "cultural", religion: "secular", is_federal: false, businesses_closed: false, color: "#f97316", observance_level: "minor", description: "Spooky celebration" },
    ];

    const deleteAllHolidays = async () => {
        if (!confirm('Are you sure you want to delete ALL holidays? This cannot be undone.')) {
            return;
        }

        setIsInitializing(true);
        setProgress('Deleting all holidays...');
        setDebugLog([]);

        try {
            addLog('Starting holiday deletion...', 'info');
            const existing = await base44.entities.Holiday.list();
            addLog(`Found ${existing.length} holidays to delete`, 'info');

            for (const holiday of existing) {
                try {
                    await base44.entities.Holiday.delete(holiday.id);
                    addLog(`‚úì Deleted ${holiday.name} (ID: ${holiday.id})`, 'success');
                } catch (error) {
                    addLog(`‚úó Error deleting ${holiday.name}: ${error.message}`, 'error');
                }
            }

            addLog('All holidays deleted successfully!', 'success');
            toast.success('All holidays deleted!');
            setResults(null); // Clear results after deletion
        } catch (error) {
            addLog(`Error deleting holidays: ${error.message}`, 'error');
            toast.error(`Failed to delete holidays: ${error.message}`);
        } finally {
            setIsInitializing(false);
            setProgress('');
        }
    };

    const initializeHolidays = async () => {
        setIsInitializing(true);
        setProgress('Starting initialization...');
        setDebugLog([]);
        const created = [];
        const skipped = [];
        const errors = [];

        try {
            addLog('Initialization started', 'info');
            addLog(`Total holidays to process: ${holidays2025.length}`, 'info');

            // Check existing holidays
            setProgress('Checking existing holidays...');
            addLog('Fetching existing holidays from database...', 'info');
            
            let existing = [];
            try {
                existing = await base44.entities.Holiday.list();
                addLog(`Found ${existing.length} existing holidays in database`, 'success');
                
                // Log existing holiday names
                if (existing.length > 0) {
                    addLog(`Existing holidays found: ${existing.map(h => h.name).join(', ')}`, 'info');
                }
            } catch (err) {
                addLog(`Error fetching holidays: ${err.message}`, 'error');
                throw new Error(`Failed to fetch existing holidays: ${err.message}`);
            }

            const existingDates = new Set(existing.map(h => h.date));
            const existingNames = new Set(existing.map(h => h.name));
            addLog(`Unique existing dates: ${existingDates.size}`, 'info');

            // Create holidays
            for (let i = 0; i < holidays2025.length; i++) {
                const holiday = holidays2025[i];
                const progressPct = Math.round(((i + 1) / holidays2025.length) * 100); // Corrected progress calculation
                
                // Check by both date AND name to avoid duplicates
                if (existingDates.has(holiday.date) || existingNames.has(holiday.name)) {
                    addLog(`‚äò Skipping ${holiday.name} on ${holiday.date} (already exists)`, 'warning');
                    skipped.push({ name: holiday.name, date: holiday.date });
                    continue;
                }

                try {
                    setProgress(`Adding ${holiday.name} (${progressPct}%)...`);
                    addLog(`Creating ${holiday.name} on ${holiday.date}...`, 'info');
                    
                    const newHoliday = await base44.entities.Holiday.create(holiday);
                    addLog(`‚úì Successfully created ${holiday.name} (ID: ${newHoliday.id})`, 'success');
                    
                    created.push({ name: holiday.name, date: holiday.date, id: newHoliday.id });
                    
                    // Small delay to avoid rate limits
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    addLog(`‚úó Error creating ${holiday.name}: ${error.message}`, 'error');
                    console.error(`Error creating ${holiday.name}:`, error);
                    errors.push({ name: holiday.name, error: error.message });
                }
            }

            const resultData = {
                created: created.length,
                skipped: skipped.length,
                errors: errors.length,
                details: { created, skipped, errors }
            };
            
            setResults(resultData);
            addLog(`\n=== INITIALIZATION COMPLETE ===`, 'success');
            addLog(`‚úì Created: ${created.length}`, 'success');
            addLog(`‚äò Skipped: ${skipped.length}`, 'warning');
            addLog(`‚úó Errors: ${errors.length}`, errors.length > 0 ? 'error' : 'info');

            if (errors.length === 0 && created.length > 0) {
                toast.success(`Successfully added ${created.length} holidays! üéâ`);
            } else if (created.length === 0 && skipped.length === holidays2025.length) {
                toast.info(`All ${skipped.length} holidays already exist in the system.`);
            } else if (errors.length > 0) {
                toast.warning(`Added ${created.length} holidays with ${errors.length} errors.`);
            } else if (created.length > 0 && skipped.length > 0 && errors.length === 0) {
                toast.success(`Added ${created.length} holidays, ${skipped.length} were already present.`);
            }


        } catch (error) {
            addLog(`Fatal error: ${error.message}`, 'error');
            console.error('Initialization error:', error);
            toast.error(`Failed to initialize holidays: ${error.message}`);
        } finally {
            setIsInitializing(false);
            setProgress('');
        }
    };

    return (
        <div className="min-h-screen p-8 bg-gradient-to-br from-purple-50 to-blue-50 dark:from-slate-900 dark:to-slate-800">
            <div className="max-w-4xl mx-auto space-y-6">
                <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-3">
                            <Calendar className="w-8 h-8 text-purple-600" />
                            Initialize 2025 Holidays
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-6">
                        <div className="space-y-4">
                            <p className="text-slate-600 dark:text-slate-400">
                                This will populate your calendar with all major holidays for 2025:
                            </p>
                            <ul className="list-disc list-inside space-y-2 text-sm text-slate-600 dark:text-slate-400">
                                <li><strong>11 US Federal Holidays</strong> (businesses closed)</li>
                                <li><strong>Christian Holidays</strong> (Easter, Christmas Eve, Good Friday)</li>
                                <li><strong>Jewish Holidays</strong> (Passover, Rosh Hashanah, Yom Kippur, Hanukkah)</li>
                                <li><strong>Muslim Holidays</strong> (Ramadan, Eid al-Fitr, Eid al-Adha)</li>
                                <li><strong>Hindu Holidays</strong> (Holi, Diwali)</li>
                                <li><strong>Buddhist Holidays</strong> (Vesak)</li>
                                <li><strong>Cultural Observances</strong> (Valentine's Day, St. Patrick's Day, Halloween, etc.)</li>
                            </ul>
                        </div>

                        {progress && (
                            <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                <p className="text-sm text-blue-800 dark:text-blue-300 flex items-center gap-2">
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                    {progress}
                                </p>
                            </div>
                        )}

                        {results && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                                        <div className="flex items-center gap-2 text-green-800 dark:text-green-300">
                                            <CheckCircle className="w-5 h-5" />
                                            <span className="font-semibold">Created</span>
                                        </div>
                                        <p className="text-2xl font-bold text-green-900 dark:text-green-200 mt-2">
                                            {results.created}
                                        </p>
                                    </div>
                                    <div className="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
                                        <div className="flex items-center gap-2 text-yellow-800 dark:text-yellow-300">
                                            <AlertTriangle className="w-5 h-5" />
                                            <span className="font-semibold">Skipped</span>
                                        </div>
                                        <p className="text-2xl font-bold text-yellow-900 dark:text-yellow-200 mt-2">
                                            {results.skipped}
                                        </p>
                                        {results.details.skipped.length > 0 && (
                                            <p className="text-xs mt-2 text-yellow-700 dark:text-yellow-400">
                                                Already in system
                                            </p>
                                        )}
                                    </div>
                                    <div className="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                                        <div className="flex items-center gap-2 text-red-800 dark:text-red-300">
                                            <AlertTriangle className="w-5 h-5" />
                                            <span className="font-semibold">Errors</span>
                                        </div>
                                        <p className="text-2xl font-bold text-red-900 dark:text-red-200 mt-2">
                                            {results.errors}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="flex gap-3">
                            <Button
                                onClick={initializeHolidays}
                                disabled={isInitializing}
                                size="lg"
                                className="flex-1"
                            >
                                {isInitializing ? (
                                    <>
                                        <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                        Initializing Holidays...
                                    </>
                                ) : (
                                    <>
                                        <Calendar className="w-5 h-5 mr-2" />
                                        Initialize 2025 Holidays
                                    </>
                                )}
                            </Button>
                            
                            <Button
                                onClick={deleteAllHolidays}
                                disabled={isInitializing}
                                variant="destructive"
                                size="lg"
                            >
                                <AlertTriangle className="w-5 h-5 mr-2" />
                                Clear All
                            </Button>
                            
                            {results && (
                                <Button
                                    onClick={() => {
                                        setResults(null);
                                        setDebugLog([]);
                                    }}
                                    variant="outline"
                                    size="lg"
                                >
                                    <RefreshCw className="w-5 h-5 mr-2" />
                                    Reset
                                </Button>
                            )}
                        </div>
                    </CardContent>
                </Card>

                {/* Debug Log */}
                {debugLog.length > 0 && (
                    <Card>
                        <CardHeader>
                            <CardTitle className="text-sm">Debug Log</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <div className="space-y-1 max-h-96 overflow-y-auto font-mono text-xs">
                                {debugLog.map((log, idx) => (
                                    <div
                                        key={idx}
                                        className={`p-2 rounded ${
                                            log.type === 'error'
                                                ? 'bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-300'
                                                : log.type === 'warning'
                                                ? 'bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-300'
                                                : log.type === 'success'
                                                ? 'bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-300'
                                                : 'bg-slate-50 dark:bg-slate-800 text-slate-800 dark:text-slate-300'
                                        }`}
                                    >
                                        <span className="opacity-60">[{log.time}]</span> {log.message}
                                    </div>
                                ))}
                            </div>
                        </CardContent>
                    </Card>
                )}
            </div>
        </div>
    );
}


import React, { useState, useEffect } from "react";
import { Property } from "@/api/entities";
import { User } from "@/api/entities";
import { Message } from "@/api/entities";
import { Button } from "@/components/ui/button";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Database, CheckCircle2, AlertCircle, ArrowLeft, Loader2, Users, Trash2, Building2 } from "lucide-react";

export default function InitializeMessagingDemo() {
  const navigate = useNavigate();
  const [properties, setProperties] = useState([]);
  const [users, setUsers] = useState([]);
  const [messages, setMessages] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isInitializing, setIsInitializing] = useState(false);
  const [status, setStatus] = useState(null);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [propData, userData, msgData] = await Promise.all([
        Property.list(),
        User.list(),
        Message.list()
      ]);
      setProperties(propData);
      setUsers(userData);
      setMessages(msgData);
    } catch (error) {
      console.error("Error loading data:", error);
    }
    setIsLoading(false);
  };

  const initializeDemoMessages = async () => {
    setIsInitializing(true);
    setStatus({ type: 'loading', message: 'Creating comprehensive demo messages...' });

    try {
      if (users.length < 2) {
        setStatus({ 
          type: 'error', 
          message: 'You need at least 2 users in your app. Please invite users through Dashboard ‚Üí Users.' 
        });
        setIsInitializing(false);
        return;
      }

      if (properties.length < 1) {
        setStatus({ 
          type: 'error', 
          message: 'You need at least 1 property. Please create a property first.' 
        });
        setIsInitializing(false);
        return;
      }

      // Assign users to different roles
      const listingAgent = users[0];
      const sellingAgent = users.length > 1 ? users[1] : users[0];
      const buyer = users.length > 2 ? users[2] : users[0];
      const seller = users.length > 3 ? users[3] : users[1];
      const titleCompanyRep = users.length > 4 ? users[4] : users[0];
      const mortgageOfficer = users.length > 5 ? users[5] : users[1];
      const inspector = users.length > 6 ? users[6] : users[0];

      const prop1 = properties[0];
      const prop2 = properties.length > 1 ? properties[1] : properties[0];
      const prop3 = properties.length > 2 ? properties[2] : properties[0];

      // Update Property 1 with full team
      await Property.update(prop1.id, {
        listing_agent_id: listingAgent.id,
        selling_agent_id: sellingAgent.id,
        buyer_id: buyer.id,
        sellers_info: JSON.stringify([{
          name: seller.full_name || "John & Mary Smith",
          email: seller.email,
          phone: "(415) 555-0104"
        }]),
        title_company: titleCompanyRep.office || "Bay Area Title Company",
        title_company_contact: JSON.stringify({
          name: titleCompanyRep.full_name || "Sarah Johnson",
          email: titleCompanyRep.email,
          phone: "(415) 555-0200"
        }),
        mortgage_company: mortgageOfficer.office || "Premier Mortgage Solutions",
        mortgage_company_contact: JSON.stringify({
          name: mortgageOfficer.full_name || "David Chen",
          email: mortgageOfficer.email,
          phone: "(415) 555-0300"
        }),
        inspection_company: inspector.office || "Professional Home Inspections",
        inspection_company_contact: JSON.stringify({
          name: inspector.full_name || "Mike Anderson",
          email: inspector.email,
          phone: "(415) 555-0400"
        })
      });

      // Property 2 - Different scenario
      if (properties.length > 1) {
        await Property.update(prop2.id, {
          listing_agent_id: listingAgent.id,
          selling_agent_id: sellingAgent.id,
          buyer_id: buyer.id,
          title_company: "Bay Area Title Company",
          mortgage_company: "Premier Mortgage Solutions"
        });
      }

      // Property 3 - Another scenario
      if (properties.length > 2) {
        await Property.update(prop3.id, {
          listing_agent_id: sellingAgent.id,
          selling_agent_id: listingAgent.id,
          title_company: "Bay Area Title Company"
        });
      }

      // === PROPERTY 1: COMPREHENSIVE MESSAGE THREADS ===

      // Thread 1: Listing Agent <-> Selling Agent (Negotiation)
      await Message.create({
        property_id: prop1.id,
        sender_id: sellingAgent.id,
        recipient_id: listingAgent.id,
        content: "Good morning! My clients are very interested in this property. They've been pre-approved for up to $8.7M and are ready to move quickly. Can we schedule a showing for this weekend?",
        is_read: true
      });

      await Message.create({
        property_id: prop1.id,
        sender_id: listingAgent.id,
        recipient_id: sellingAgent.id,
        content: "Excellent! I have Saturday at 2 PM or Sunday at 10 AM available. The sellers are motivated and looking for a quick close. What timeline are your buyers working with?",
        is_read: true
      });

      await Message.create({
        property_id: prop1.id,
        sender_id: sellingAgent.id,
        recipient_id: listingAgent.id,
        content: "Saturday at 2 PM works perfectly. They're looking to close within 45 days if possible. They're relocating from NYC for work and need to be settled by mid-March.",
        is_read: true
      });

      await Message.create({
        property_id: prop1.id,
        sender_id: listingAgent.id,
        recipient_id: sellingAgent.id,
        content: "That timeline works well with the sellers. I'll have the property show-ready. Please let me know if your buyers need any specific information before the showing.",
        is_read: false
      });

      // Thread 2: Listing Agent <-> Seller (Updates)
      if (users.length > 3) {
        await Message.create({
          property_id: prop1.id,
          sender_id: listingAgent.id,
          recipient_id: seller.id,
          content: "Hi John & Mary! Great news - we have a very serious buyer interested in the property. They're pre-approved and looking to move quickly. I've scheduled a showing for Saturday at 2 PM. I recommend making sure the house is in pristine condition.",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: seller.id,
          recipient_id: listingAgent.id,
          content: "That's wonderful news! We'll make sure everything is perfect. Should we be out of the house during the showing? Also, what's their budget range?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: listingAgent.id,
          recipient_id: seller.id,
          content: "Yes, please plan to be out from 1:45 PM to 3:30 PM to give them space. They're pre-approved up to $8.7M, so well within range. I'll call you after the showing with feedback!",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: seller.id,
          recipient_id: listingAgent.id,
          content: "Perfect! We're excited. One question - if they make an offer, how quickly would you recommend we respond? We don't want to lose a good buyer.",
          is_read: false
        });
      }

      // Thread 3: Selling Agent <-> Buyer (Property Details)
      if (users.length > 2) {
        await Message.create({
          property_id: prop1.id,
          sender_id: buyer.id,
          recipient_id: sellingAgent.id,
          content: "Hi! I've been looking at the listing photos and I have a few questions. Is the kitchen fully remodeled? And what's the situation with the HOA fees?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: sellingAgent.id,
          recipient_id: buyer.id,
          content: "Great questions! The kitchen was fully remodeled in 2021 with high-end appliances (Sub-Zero, Wolf range, Bosch dishwasher). It's not in an HOA, so no monthly fees! The property taxes are approximately $7,200/year. Want to schedule that showing for Saturday?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: buyer.id,
          recipient_id: sellingAgent.id,
          content: "That sounds perfect! Yes, let's do Saturday at 2 PM. Also, can you find out about the roof condition and when the HVAC was last serviced?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: sellingAgent.id,
          recipient_id: buyer.id,
          content: "Will do! I'll get that information from the listing agent and have it ready for you at the showing. Also bringing comparable sales data and the neighborhood analysis you requested.",
          is_read: false
        });
      }

      // Thread 4: Listing Agent <-> Title Company (After Offer Accepted)
      if (users.length > 4) {
        await Message.create({
          property_id: prop1.id,
          sender_id: listingAgent.id,
          recipient_id: titleCompanyRep.id,
          content: "Hi Sarah! We just accepted an offer on " + prop1.address + ". Contract price is $8.5M with a 45-day close. Can you open escrow and send me the preliminary title report ASAP?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: titleCompanyRep.id,
          recipient_id: listingAgent.id,
          content: "Congratulations! I'll open escrow today and rush the preliminary title report. You should have it within 3 business days. I'll need the fully executed purchase agreement and earnest money deposit info.",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: listingAgent.id,
          recipient_id: titleCompanyRep.id,
          content: "Perfect! Sending the signed purchase agreement now via email. Earnest money deposit of $250K will be wired tomorrow. Escrow number?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: titleCompanyRep.id,
          recipient_id: listingAgent.id,
          content: "Escrow #2025-SF-1847. Wire instructions attached. I'll send preliminary title tomorrow. Let me know if you need anything else!",
          is_read: false
        });
      }

      // Thread 5: Selling Agent <-> Mortgage Officer (Financing)
      if (users.length > 5) {
        await Message.create({
          property_id: prop1.id,
          sender_id: sellingAgent.id,
          recipient_id: mortgageOfficer.id,
          content: "Hi David! My buyers just got their offer accepted on " + prop1.address + " for $8.5M. They're putting 20% down. Can you confirm their loan approval status and timeline?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: mortgageOfficer.id,
          recipient_id: sellingAgent.id,
          content: "Excellent news! They're fully approved for $6.8M at 6.75% (30-year fixed). I need the purchase agreement and appraisal will be ordered tomorrow. We're on track for a 30-day close.",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: sellingAgent.id,
          recipient_id: mortgageOfficer.id,
          content: "Sending purchase agreement now. The appraisal contingency is 17 days - can you expedite? Also, what documents do the buyers still need to provide?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: mortgageOfficer.id,
          recipient_id: sellingAgent.id,
          content: "I'll rush the appraisal - should have it in 7-10 days. I need their last 2 years tax returns and 3 months bank statements. Can they upload to the secure portal by EOD tomorrow?",
          is_read: false
        });
      }

      // Thread 6: Selling Agent <-> Inspector (Inspection Coordination)
      if (users.length > 6) {
        await Message.create({
          property_id: prop1.id,
          sender_id: sellingAgent.id,
          recipient_id: inspector.id,
          content: "Hi Mike! I need to schedule a home inspection for " + prop1.address + ". It's a 4,200 sq ft single-family home built in 2018. Can you do it next Tuesday or Wednesday?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: inspector.id,
          recipient_id: sellingAgent.id,
          content: "I have Tuesday at 9 AM available. For a home that size, I'll need about 3-4 hours. Cost will be $650. Should I also check the roof and HVAC systems in detail?",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: sellingAgent.id,
          recipient_id: inspector.id,
          content: "Perfect! Book Tuesday at 9 AM. Yes, please do a thorough check of roof, HVAC, foundation, and electrical. My buyers are very detail-oriented. Send the report to both me and the buyers.",
          is_read: true
        });

        await Message.create({
          property_id: prop1.id,
          sender_id: inspector.id,
          recipient_id: sellingAgent.id,
          content: "Will do! I'll send you both the full report within 24 hours of inspection. I'll also include photos and recommendations. See you Tuesday at 9 AM!",
          is_read: false
        });
      }

      // Thread 7: Listing Agent <-> Selling Agent (Post-Inspection Negotiations)
      await Message.create({
        property_id: prop1.id,
        sender_id: sellingAgent.id,
        recipient_id: listingAgent.id,
        content: "Hi! The inspection report came back. Overall the house is in great shape, but the inspector noted the HVAC system is 8 years old and recommends a $3,500 credit for maintenance. The roof also has minor wear - they're requesting a $5,000 credit. Can we discuss?",
        is_read: true
      });

      await Message.create({
        property_id: prop1.id,
        sender_id: listingAgent.id,
        recipient_id: sellingAgent.id,
        content: "Let me talk to my sellers. The HVAC has been serviced annually and works perfectly. The roof was inspected last year with no issues. I think $5K total credit is more reasonable than $8.5K. Let me get back to you by EOD.",
        is_read: true
      });

      await Message.create({
        property_id: prop1.id,
        sender_id: listingAgent.id,
        recipient_id: sellingAgent.id,
        content: "Good news! My sellers will agree to a $6,000 credit to cover both items. That's their final offer. Can your buyers accept this so we can move forward?",
        is_read: false
      });

      // === PROPERTY 2: DIFFERENT TRANSACTION STAGE ===

      if (properties.length > 1) {
        // Early stage inquiries
        await Message.create({
          property_id: prop2.id,
          sender_id: sellingAgent.id,
          recipient_id: listingAgent.id,
          content: "Hi! I have clients interested in " + prop2.address + ". Can you tell me about any upcoming open houses? Also, is the seller open to offers below asking?",
          is_read: true
        });

        await Message.create({
          property_id: prop2.id,
          sender_id: listingAgent.id,
          recipient_id: sellingAgent.id,
          content: "We have an open house this Sunday 1-3 PM. The seller is firm on price but might consider creative terms. Are your buyers pre-approved? What's their timeline?",
          is_read: true
        });

        if (users.length > 2) {
          await Message.create({
            property_id: prop2.id,
            sender_id: buyer.id,
            recipient_id: sellingAgent.id,
            content: "I saw the virtual tour - love the location! Can we see it before the open house? I'm available tomorrow afternoon. Also, what are the property taxes?",
            is_read: false
          });
        }
      }

      // === PROPERTY 3: CLOSING STAGE ===

      if (properties.length > 2) {
        await Message.create({
          property_id: prop3.id,
          sender_id: sellingAgent.id,
          recipient_id: listingAgent.id,
          content: "We're 5 days from closing on " + prop3.address + "! Just confirming final walk-through for tomorrow at 10 AM. All repairs completed?",
          is_read: true
        });

        await Message.create({
          property_id: prop3.id,
          sender_id: listingAgent.id,
          recipient_id: sellingAgent.id,
          content: "Yes! All repairs done and passed re-inspection. The house is in perfect condition. See you tomorrow at 10 AM. Congratulations on a smooth transaction!",
          is_read: false
        });

        if (users.length > 4) {
          await Message.create({
            property_id: prop3.id,
            sender_id: titleCompanyRep.id,
            recipient_id: listingAgent.id,
            content: "Final closing documents are ready! Closing scheduled for Friday at 2 PM. Both parties confirmed. Please remind your sellers to bring valid ID and keys!",
            is_read: false
          });
        }
      }

      setStatus({ 
        type: 'success', 
        message: `Successfully created ${properties.length * 8}+ comprehensive demo messages across all transaction stages!` 
      });
      
      setTimeout(() => {
        navigate(createPageUrl("Messages"));
      }, 2000);

    } catch (error) {
      console.error("Error initializing demo messages:", error);
      setStatus({ 
        type: 'error', 
        message: 'Failed to initialize demo messages. Please try again.' 
      });
    }
    setIsInitializing(false);
  };

  const orphanedMessages = messages.filter(m => {
    const property = properties.find(p => p.id === m.property_id);
    return !property;
  });

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  return (
    <div className="p-4 min-h-screen flex flex-col items-center justify-center space-y-6">
      {/* The content below will now be centered horizontally and vertically as a column within this div, and occupy full width */}
      <div className="w-full max-w-4xl"> {/* This inner div re-introduces the max-width and ensures content within is centered */}
        {/* Header */}
        <div className="app-card p-6">
          <div className="flex items-center gap-4 mb-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(createPageUrl("Messages"))}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <h1 className="app-title text-2xl">Initialize Advanced Messaging Demo</h1>
              <p className="app-subtitle">Set up comprehensive demo messages with all transaction parties</p>
            </div>
          </div>
        </div>

        {/* Status Display */}
        {status && (
          <div className={`app-card p-6 ${
            status.type === 'error' ? 'bg-red-50 border-red-200' :
            status.type === 'success' ? 'bg-green-50 border-green-200' :
            'bg-blue-50 border-blue-200'
          }`}>
            <div className="flex items-start gap-3">
              {status.type === 'loading' && <Loader2 className="w-5 h-5 animate-spin text-blue-600 flex-shrink-0 mt-0.5" />}
              {status.type === 'error' && <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />}
              {status.type === 'success' && <CheckCircle2 className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />}
              <p className={`font-medium ${
                status.type === 'error' ? 'text-red-900' :
                status.type === 'success' ? 'text-green-900' :
                'text-blue-900'
              }`}>{status.message}</p>
            </div>
          </div>
        )}

        {/* Current Status */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="app-card p-6">
            <div className="flex items-center gap-3 mb-2">
              <Users className="w-5 h-5 text-blue-600" />
              <h3 className="font-semibold">Users</h3>
            </div>
            <p className="text-3xl font-bold text-slate-900">{users.length}</p>
            <p className="text-sm text-slate-500 mt-1">Available users</p>
          </div>

          <div className="app-card p-6">
            <div className="flex items-center gap-3 mb-2">
              <Building2 className="w-5 h-5 text-indigo-600" />
              <h3 className="font-semibold">Properties</h3>
            </div>
            <p className="text-3xl font-bold text-slate-900">{properties.length}</p>
            <p className="text-sm text-slate-500 mt-1">Available properties</p>
          </div>

          <div className="app-card p-6">
            <div className="flex items-center gap-3 mb-2">
              <AlertCircle className="w-5 h-5 text-amber-600" />
              <h3 className="font-semibold">Invalid Messages</h3>
            </div>
            <p className="text-3xl font-bold text-slate-900">{orphanedMessages.length}</p>
            <p className="text-sm text-slate-500 mt-1">Need cleanup</p>
          </div>
        </div>

        {/* Warning about Invalid Messages */}
        {orphanedMessages.length > 0 && (
          <div className="app-card p-6 bg-amber-50 border-amber-200">
            <div className="flex items-start gap-3 mb-4">
              <AlertCircle className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
              <div className="flex-1">
                <h3 className="font-semibold text-amber-900 mb-2">
                  {orphanedMessages.length} Invalid Messages Found
                </h3>
                <p className="text-sm text-amber-700 mb-3">
                  These messages reference properties that no longer exist. You need to delete them manually before adding new demo messages.
                </p>
                <Button
                  size="sm"
                  variant="outline"
                  onClick={() => window.open('/dashboard#/data/Message', '_blank')}
                  className="text-amber-700 border-amber-300 hover:bg-amber-100"
                >
                  <Trash2 className="w-4 h-4 mr-2" />
                  Open Dashboard to Delete Invalid Messages
                </Button>
              </div>
            </div>
          </div>
        )}

        {/* Initialize Button */}
        <div className="app-card p-6">
          <h3 className="font-semibold text-lg mb-4">Initialize Advanced Demo Messages</h3>
          <p className="text-slate-600 mb-6">
            This will create comprehensive, realistic conversation threads including:
          </p>
          <div className="grid md:grid-cols-2 gap-4 mb-6">
            <ul className="space-y-2 text-sm text-slate-600">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                <span>Listing agent ‚Üî Selling agent negotiations</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                <span>Agent ‚Üî Buyer property discussions</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                <span>Listing agent ‚Üî Seller updates</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                <span>Title company coordination</span>
              </li>
            </ul>
            <ul className="space-y-2 text-sm text-slate-600">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                <span>Mortgage officer financing discussions</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                <span>Home inspector scheduling & reports</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                <span>Post-inspection negotiations</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                <span>Closing coordination messages</span>
              </li>
            </ul>
          </div>
          <Button
            onClick={initializeDemoMessages}
            disabled={isInitializing || users.length < 2 || properties.length < 1}
            className="app-button w-full py-3"
          >
            {isInitializing ? (
              <>
                <Loader2 className="w-5 h-5 animate-spin mr-2" />
                Creating Advanced Demo Messages...
              </>
            ) : (
              <>
                <Database className="w-5 h-5 mr-2" />
                Initialize Advanced Demo Messages
              </>
            )}
          </Button>
          {(users.length < 2 || properties.length < 1) && (
            <p className="text-sm text-amber-600 mt-3">
              {users.length < 2 && "‚ö†Ô∏è Need at least 2 users. "}
              {properties.length < 1 && "‚ö†Ô∏è Need at least 1 property. "}
            </p>
          )}
          <p className="text-xs text-slate-500 mt-3">
            üí° Tip: For the best demo experience, have 4+ users with different roles (listing agent, selling agent, buyer, seller) and 2+ properties.
          </p>
        </div>
      </div>
    </div>
  );
}

import React, { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { TrendingUp, Loader2, CheckCircle, AlertCircle, X, Info } from 'lucide-react';
import { toast } from 'sonner';
import { subMonths, format, startOfMonth } from 'date-fns';

export default function InitializeRMEI() {
    const [isLoading, setIsLoading] = useState(false);
    const [progress, setProgress] = useState('');
    const [recordsCreated, setRecordsCreated] = useState(0);
    const [existingRecords, setExistingRecords] = useState([]);
    const [isLoadingRecords, setIsLoadingRecords] = useState(true);
    const [selectedRecord, setSelectedRecord] = useState(null);

    useEffect(() => {
        checkAndAutoGenerate();
        loadExistingRecords();
    }, []);

    const loadExistingRecords = async () => {
        try {
            const records = await base44.entities.RMEIRecord.list('-date', 12);
            setExistingRecords(records);
        } catch (error) {
            console.error('Error loading RMEI records:', error);
        } finally {
            setIsLoadingRecords(false);
        }
    };

    const checkAndAutoGenerate = async () => {
        try {
            const lastAutoUpdate = localStorage.getItem('rmei_last_auto_update');
            const now = new Date();
            const targetHour = 4;
            const targetMinute = 45;
            
            // Create today's target time (4:45 AM)
            const todayTarget = new Date();
            todayTarget.setHours(targetHour, targetMinute, 0, 0);
            
            // If last update was before today's 4:45 AM and current time is after 4:45 AM
            if (!lastAutoUpdate || new Date(lastAutoUpdate) < todayTarget) {
                // Check if current time is past 4:45 AM today
                if (now >= todayTarget) {
                    await generateRMEIData();
                    localStorage.setItem('rmei_last_auto_update', now.toISOString());
                }
            }
        } catch (error) {
            console.error('Auto-generate check failed:', error);
        }
    };

    const generateRMEIData = async () => {
        setIsLoading(true);
        setProgress('Clearing existing RMEI data...');
        setRecordsCreated(0);

        try {
            // Delete all existing records first
            const existingRecords = await base44.entities.RMEIRecord.list();
            for (const record of existingRecords) {
                await base44.entities.RMEIRecord.delete(record.id);
            }
            setProgress('Existing data cleared. Generating fresh 12 months...');
            await new Promise(resolve => setTimeout(resolve, 500));

            // Generate 12 months of historical data
            const months = 12;
            const records = [];

            for (let i = months - 1; i >= 0; i--) {
                const date = subMonths(startOfMonth(new Date()), i);
                const dateStr = format(date, 'yyyy-MM-dd');

                setProgress(`Generating data for ${format(date, 'MMMM yyyy')}...`);

                // Generate realistic RMEI value (50-80 range for stable market)
                const baseValue = 65;
                const seasonalVariation = Math.sin((12 - i) * Math.PI / 6) * 5; // Seasonal pattern
                const randomNoise = (Math.random() - 0.5) * 8;
                const value = Math.round(Math.max(45, Math.min(85, baseValue + seasonalVariation + randomNoise)));

                // Determine emotion label based on value
                let emotionLabel;
                if (value < 26) emotionLabel = "Fear / Freeze";
                else if (value < 46) emotionLabel = "Caution";
                else if (value < 56) emotionLabel = "Neutral";
                else if (value < 76) emotionLabel = "Optimism";
                else emotionLabel = "Euphoria";

                // Generate realistic market data
                const mortgageRate = 6.5 + (Math.random() - 0.5) * 1.0; // 6-7%
                const priceGrowth = (Math.random() - 0.3) * 2; // -0.6% to +1.4%
                const inventoryChange = (Math.random() - 0.5) * 10; // -5% to +5%
                const sentimentScore = value + (Math.random() - 0.5) * 10;

                const record = await base44.entities.RMEIRecord.create({
                    date: dateStr,
                    value: value,
                    mortgage_rate: parseFloat(mortgageRate.toFixed(2)),
                    price_growth: parseFloat(priceGrowth.toFixed(2)),
                    inventory_change: parseFloat(inventoryChange.toFixed(2)),
                    sentiment_score: Math.round(sentimentScore),
                    emotion_label: emotionLabel,
                    raw_data: JSON.stringify({
                        mortgage_rate: mortgageRate,
                        price_growth: priceGrowth,
                        inventory_change: inventoryChange,
                        sentiment_score: sentimentScore,
                        market_conditions: "Stable with moderate activity"
                    })
                });

                records.push(record);
                setRecordsCreated(records.length);

                // Small delay to avoid rate limits
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            setProgress(`Successfully created ${records.length} RMEI records!`);
            toast.success(`Created ${records.length} months of RMEI data!`);
            
            // Reload the records list
            await loadExistingRecords();

        } catch (error) {
            console.error('Error generating RMEI data:', error);
            setProgress(`Error: ${error.message}`);
            toast.error('Failed to generate RMEI data');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="page-container space-y-6">
            <div>
                <h1 className="page-title">Initialize RMEI Data</h1>
                <p className="text-slate-600 dark:text-slate-400">
                    Generate Real Estate Market Emotion Index historical data for the dashboard widgets
                </p>
            </div>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <TrendingUp className="w-5 h-5 text-primary" />
                        Market Emotion Index Generator
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                        <p className="text-sm text-blue-900 dark:text-blue-100">
                            <strong>What is RMEI?</strong> Market Emotion Index combines mortgage rates, 
                            price trends, inventory levels, and market sentiment to provide a single emotion score (0-100).
                        </p>
                    </div>

                    <div className="space-y-2">
                        <div className="flex items-center justify-between">
                            <span className="text-sm font-medium">Records to generate:</span>
                            <span className="text-sm text-slate-600 dark:text-slate-400">12 months of historical data</span>
                        </div>
                        
                        {recordsCreated > 0 && (
                            <div className="flex items-center gap-2 text-green-600 dark:text-green-400">
                                <CheckCircle className="w-4 h-4" />
                                <span className="text-sm font-medium">{recordsCreated} records created</span>
                            </div>
                        )}
                    </div>

                    {progress && (
                        <div className={`p-3 rounded-lg ${
                            progress.includes('Error') 
                                ? 'bg-red-50 dark:bg-red-900/20 text-red-900 dark:text-red-100 border border-red-200 dark:border-red-800' 
                                : progress.includes('Successfully')
                                ? 'bg-green-50 dark:bg-green-900/20 text-green-900 dark:text-green-100 border border-green-200 dark:border-green-800'
                                : 'bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-slate-100'
                        }`}>
                            <p className="text-sm font-medium">{progress}</p>
                        </div>
                    )}

                    <Button 
                        onClick={generateRMEIData} 
                        disabled={isLoading}
                        className="w-full"
                        size="lg"
                    >
                        {isLoading ? (
                            <>
                                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                Generating Data...
                            </>
                        ) : (
                            <>
                                <TrendingUp className="w-4 h-4 mr-2" />
                                Generate RMEI Data
                            </>
                        )}
                    </Button>

                    <div className="text-xs text-slate-500 dark:text-slate-400 space-y-1">
                        <p>‚Ä¢ This will create 12 months of historical RMEI data</p>
                        <p>‚Ä¢ Data is generated with realistic market conditions</p>
                        <p>‚Ä¢ Includes emotion labels, mortgage rates, and trends</p>
                        <p>‚Ä¢ Safe to run multiple times (creates new records)</p>
                        <p>‚Ä¢ Auto-updates daily at 4:45 AM</p>
                    </div>
                </CardContent>
            </Card>

            {/* Existing RMEI Records */}
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <TrendingUp className="w-5 h-5 text-primary" />
                        Recent RMEI Data
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    {isLoadingRecords ? (
                        <div className="flex items-center justify-center py-8">
                            <Loader2 className="w-6 h-6 animate-spin text-slate-400" />
                        </div>
                    ) : existingRecords.length > 0 ? (
                        <div className="space-y-3">
                            {existingRecords.map((record) => (
                                <div 
                                    key={record.id} 
                                    className="p-4 border rounded-lg hover:shadow-md transition-all cursor-pointer hover:border-primary"
                                    onClick={() => setSelectedRecord(record)}
                                >
                                    <div className="flex items-start justify-between mb-2">
                                        <div>
                                            <h4 className="font-semibold text-slate-900 dark:text-slate-100">
                                                {format(new Date(record.date), 'MMMM yyyy')}
                                            </h4>
                                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                                Emotion: <span className="font-medium">{record.emotion_label}</span>
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            <div className={`text-2xl font-bold ${
                                                record.value >= 76 ? 'text-green-600' :
                                                record.value >= 56 ? 'text-blue-600' :
                                                record.value >= 46 ? 'text-amber-600' :
                                                'text-red-600'
                                            }`}>
                                                {record.value}
                                            </div>
                                            <p className="text-xs text-slate-500">RMEI Score</p>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-4 mt-3 pt-3 border-t">
                                        <div>
                                            <p className="text-xs text-slate-500">Mortgage Rate</p>
                                            <p className="text-sm font-medium text-slate-900 dark:text-slate-100">
                                                {record.mortgage_rate}%
                                            </p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Price Growth</p>
                                            <p className={`text-sm font-medium ${record.price_growth >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {record.price_growth > 0 ? '+' : ''}{record.price_growth}%
                                            </p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Inventory</p>
                                            <p className={`text-sm font-medium ${record.inventory_change >= 0 ? 'text-blue-600' : 'text-amber-600'}`}>
                                                {record.inventory_change > 0 ? '+' : ''}{record.inventory_change}%
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-center mt-3 pt-2 border-t">
                                        <Info className="w-4 h-4 text-slate-400 mr-1" />
                                        <span className="text-xs text-slate-500">Click for detailed breakdown</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-8">
                            <p className="text-slate-600 dark:text-slate-400">No RMEI data available yet.</p>
                            <p className="text-sm text-slate-500 mt-1">Click "Generate RMEI Data" to create historical records.</p>
                        </div>
                    )}
                </CardContent>
            </Card>

            {/* Detail Modal */}
            {selectedRecord && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedRecord(null)}>
                    <div className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                        <div className="sticky top-0 bg-white dark:bg-slate-900 border-b p-4 flex items-center justify-between">
                            <h3 className="text-xl font-bold text-slate-900 dark:text-slate-100">
                                {format(new Date(selectedRecord.date), 'MMMM yyyy')} - Market Analysis
                            </h3>
                            <button onClick={() => setSelectedRecord(null)} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        
                        <div className="p-6 space-y-6">
                            {/* Overall Score */}
                            <div className="text-center p-6 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg">
                                <div className={`text-6xl font-bold mb-2 ${
                                    selectedRecord.value >= 76 ? 'text-green-600' :
                                    selectedRecord.value >= 56 ? 'text-blue-600' :
                                    selectedRecord.value >= 46 ? 'text-amber-600' :
                                    'text-red-600'
                                }`}>
                                    {selectedRecord.value}
                                </div>
                                <p className="text-lg font-semibold text-slate-900 dark:text-slate-100">
                                    Market Emotion: {selectedRecord.emotion_label}
                                </p>
                                <p className="text-sm text-slate-600 dark:text-slate-400 mt-2">
                                    {selectedRecord.value >= 76 ? 'Strong buyer confidence and market activity' :
                                     selectedRecord.value >= 56 ? 'Positive sentiment with steady growth' :
                                     selectedRecord.value >= 46 ? 'Neutral market with mixed signals' :
                                     selectedRecord.value >= 26 ? 'Cautious sentiment, proceed carefully' :
                                     'Fearful market with low confidence'}
                                </p>
                            </div>

                            {/* Key Metrics Breakdown */}
                            <div className="space-y-4">
                                <h4 className="font-semibold text-slate-900 dark:text-slate-100">Score Components</h4>
                                
                                <div className="space-y-3">
                                    {/* Mortgage Rate */}
                                    <div className="p-4 border rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-medium text-slate-900 dark:text-slate-100">Mortgage Rate</span>
                                            <span className="text-lg font-bold text-slate-900 dark:text-slate-100">{selectedRecord.mortgage_rate}%</span>
                                        </div>
                                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                            <div 
                                                className="bg-blue-600 h-2 rounded-full" 
                                                style={{ width: `${Math.min(100, (10 - selectedRecord.mortgage_rate) * 10)}%` }}
                                            />
                                        </div>
                                        <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">
                                            {selectedRecord.mortgage_rate < 5 ? 'Very favorable rates' :
                                             selectedRecord.mortgage_rate < 6 ? 'Good rates for buyers' :
                                             selectedRecord.mortgage_rate < 7 ? 'Moderate rates' :
                                             'High rates impacting affordability'}
                                        </p>
                                    </div>

                                    {/* Price Growth */}
                                    <div className="p-4 border rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-medium text-slate-900 dark:text-slate-100">Price Growth</span>
                                            <span className={`text-lg font-bold ${selectedRecord.price_growth >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {selectedRecord.price_growth > 0 ? '+' : ''}{selectedRecord.price_growth}%
                                            </span>
                                        </div>
                                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                            <div 
                                                className={`h-2 rounded-full ${selectedRecord.price_growth >= 0 ? 'bg-green-600' : 'bg-red-600'}`}
                                                style={{ width: `${Math.min(100, Math.abs(selectedRecord.price_growth) * 20)}%` }}
                                            />
                                        </div>
                                        <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">
                                            {selectedRecord.price_growth > 1 ? 'Strong appreciation' :
                                             selectedRecord.price_growth > 0 ? 'Steady growth' :
                                             selectedRecord.price_growth > -1 ? 'Slight decline' :
                                             'Significant price pressure'}
                                        </p>
                                    </div>

                                    {/* Inventory Change */}
                                    <div className="p-4 border rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-medium text-slate-900 dark:text-slate-100">Inventory Change</span>
                                            <span className={`text-lg font-bold ${selectedRecord.inventory_change >= 0 ? 'text-blue-600' : 'text-amber-600'}`}>
                                                {selectedRecord.inventory_change > 0 ? '+' : ''}{selectedRecord.inventory_change}%
                                            </span>
                                        </div>
                                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                            <div 
                                                className={`h-2 rounded-full ${selectedRecord.inventory_change >= 0 ? 'bg-blue-600' : 'bg-amber-600'}`}
                                                style={{ width: `${Math.min(100, Math.abs(selectedRecord.inventory_change) * 10)}%` }}
                                            />
                                        </div>
                                        <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">
                                            {selectedRecord.inventory_change > 3 ? 'More choices for buyers' :
                                             selectedRecord.inventory_change > 0 ? 'Balanced inventory' :
                                             selectedRecord.inventory_change > -3 ? 'Tight inventory' :
                                             'Very competitive market'}
                                        </p>
                                    </div>

                                    {/* Market Sentiment */}
                                    <div className="p-4 border rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-medium text-slate-900 dark:text-slate-100">Market Sentiment</span>
                                            <span className="text-lg font-bold text-slate-900 dark:text-slate-100">{selectedRecord.sentiment_score}</span>
                                        </div>
                                        <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                            <div 
                                                className="bg-purple-600 h-2 rounded-full" 
                                                style={{ width: `${selectedRecord.sentiment_score}%` }}
                                            />
                                        </div>
                                        <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">
                                            Overall market confidence and activity level
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Market Interpretation */}
                            <div className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                                <h4 className="font-semibold text-slate-900 dark:text-slate-100 mb-2">What This Means</h4>
                                <p className="text-sm text-slate-700 dark:text-slate-300">
                                    {selectedRecord.value >= 76 ? 
                                        'This is an excellent time for sellers to list properties. Buyer demand is strong, inventory is moving quickly, and prices are rising. Buyers should act fast in this competitive market.' :
                                     selectedRecord.value >= 56 ? 
                                        'The market is healthy and balanced. Both buyers and sellers can find good opportunities. Property values are stable with steady appreciation expected.' :
                                     selectedRecord.value >= 46 ? 
                                        'Market conditions are neutral with no clear advantage for buyers or sellers. Good time for patient buyers to negotiate, while sellers may need to price competitively.' :
                                     selectedRecord.value >= 26 ? 
                                        'Caution is advised. Higher rates and changing conditions favor buyers who have more negotiating power. Sellers may need to adjust expectations.' :
                                        'Market is under pressure with low confidence. Buyers have strong negotiating power. Sellers should focus on realistic pricing and market timing.'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

import React, { useState } from "react";
import { TeamMember } from "@/api/entities";
// Added this import as per the outline
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Users, CheckCircle, AlertCircle, Loader2 } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";

export default function InitializeTeamMembers() {
  const navigate = useNavigate();
  const [status, setStatus] = useState("idle");
  const [message, setMessage] = useState("");

  const demoTeamMembers = [
    {
      full_name: "Sarah Johnson",
      email: "sarah.johnson@realty.com",
      phone: "(555) 123-4567",
      role: "listing_agent",
      specialization: "residential",
      office: "Prime Realty Group",
      commission_split: 70,
      is_active: true,
      license_number: "RE123456"
    },
    {
      full_name: "Michael Chen",
      email: "michael.chen@realty.com",
      phone: "(555) 234-5678",
      role: "selling_agent",
      specialization: "luxury",
      office: "Prime Realty Group",
      commission_split: 65,
      is_active: true,
      license_number: "RE234567"
    },
    {
      full_name: "Emily Rodriguez",
      email: "emily.rodriguez@realty.com",
      phone: "(555) 345-6789",
      role: "broker",
      specialization: "commercial",
      office: "Prime Realty Group",
      commission_split: 80,
      is_active: true,
      license_number: "BR345678"
    },
    {
      full_name: "David Thompson",
      email: "david.thompson@realty.com",
      phone: "(555) 456-7890",
      role: "listing_agent",
      specialization: "first_time_buyers",
      office: "Prime Realty Group",
      commission_split: 60,
      is_active: true,
      license_number: "RE456789"
    },
    {
      full_name: "Lisa Martinez",
      email: "lisa.martinez@realty.com",
      phone: "(555) 567-8901",
      role: "transaction_coordinator",
      office: "Prime Realty Group",
      is_active: true
    }
  ];

  const initializeTeamMembers = async () => {
    setStatus("loading");
    setMessage("Creating team members...");

    try {
      // Check if team members already exist
      const existingMembers = await TeamMember.list();
      
      if (existingMembers && existingMembers.length > 0) {
        setStatus("warning");
        setMessage(`Found ${existingMembers.length} existing team members. Skipping initialization to avoid duplicates.`);
        return;
      }

      // Create team members
      for (const member of demoTeamMembers) {
        await TeamMember.create(member);
        await new Promise(resolve => setTimeout(resolve, 500)); // Delay to avoid rate limits
      }

      setStatus("success");
      setMessage(`Successfully created ${demoTeamMembers.length} team members! You can now select them in property assignments.`);
      
    } catch (error) {
      console.error("Error initializing team members:", error);
      setStatus("error");
      setMessage(`Failed to initialize team members: ${error.message}`);
    }
  };

  return (
    <div className="p-4 min-h-screen flex items-center justify-center">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Users className="w-6 h-6 text-indigo-600" />
            Initialize Demo Team Members
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="text-sm text-slate-600 dark:text-slate-400">
            <p className="mb-4">
              This will create {demoTeamMembers.length} demo team members that you can use to assign to properties and transactions.
            </p>
            <p className="mb-4 font-semibold">Team members to be created:</p>
            <ul className="list-disc pl-5 space-y-1">
              {demoTeamMembers.map((member, index) => (
                <li key={index}>
                  <span className="font-medium">{member.full_name}</span> - {member.role.replace('_', ' ')} 
                  {member.specialization && ` (${member.specialization})`}
                </li>
              ))}
            </ul>
          </div>

          {status === "idle" && (
            <Button 
              onClick={initializeTeamMembers} 
              className="w-full bg-indigo-600 hover:bg-indigo-700"
              size="lg"
            >
              <Users className="w-5 h-5 mr-2" />
              Create Demo Team Members
            </Button>
          )}

          {status === "loading" && (
            <div className="flex items-center justify-center gap-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <Loader2 className="w-5 h-5 animate-spin text-blue-600" />
              <span className="text-blue-700 dark:text-blue-300">{message}</span>
            </div>
          )}

          {status === "success" && (
            <div className="space-y-4">
              <div className="flex items-start gap-3 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                <CheckCircle className="w-5 h-5 text-green-600 mt-0.5" />
                <div className="flex-1">
                  <p className="text-green-700 dark:text-green-300 font-medium">Success!</p>
                  <p className="text-green-600 dark:text-green-400 text-sm">{message}</p>
                </div>
              </div>
              <div className="flex gap-3">
                <Button 
                  onClick={() => navigate(createPageUrl("Settings"))}
                  variant="outline"
                  className="flex-1"
                >
                  Go to Settings
                </Button>
                <Button 
                  onClick={() => navigate(createPageUrl("Properties"))}
                  className="flex-1 bg-indigo-600 hover:bg-indigo-700"
                >
                  Go to Properties
                </Button>
              </div>
            </div>
          )}

          {status === "warning" && (
            <div className="space-y-4">
              <div className="flex items-start gap-3 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                <AlertCircle className="w-5 h-5 text-yellow-600 mt-0.5" />
                <div className="flex-1">
                  <p className="text-yellow-700 dark:text-yellow-300 font-medium">Already Initialized</p>
                  <p className="text-yellow-600 dark:text-yellow-400 text-sm">{message}</p>
                </div>
              </div>
              <div className="flex gap-3">
                <Button 
                  onClick={() => navigate(createPageUrl("Settings"))}
                  variant="outline"
                  className="flex-1"
                >
                  View Team Members
                </Button>
                <Button 
                  onClick={() => navigate(createPageUrl("Properties"))}
                  className="flex-1 bg-indigo-600 hover:bg-indigo-700"
                >
                  Go to Properties
                </Button>
              </div>
            </div>
          )}

          {status === "error" && (
            <div className="space-y-4">
              <div className="flex items-start gap-3 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                <AlertCircle className="w-5 h-5 text-red-600 mt-0.5" />
                <div className="flex-1">
                  <p className="text-red-700 dark:text-red-300 font-medium">Error</p>
                  <p className="text-red-600 dark:text-red-400 text-sm">{message}</p>
                </div>
              </div>
              <Button 
                onClick={() => setStatus("idle")}
                variant="outline"
                className="w-full"
              >
                Try Again
              </Button>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';

import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { 
  Plus, Search, MapPin, Flame, Building, Mail, 
  CheckSquare, Trash2, Download,
  Map, List, DollarSign, Home, AlertTriangle, Loader2, Printer, Bell, Upload,
  TrendingUp, Users, FileText, LayoutGrid, Clock
} from 'lucide-react';

import InvestorPropertyCard from '../components/investor/InvestorPropertyCard';
import InvestorPropertyModal from '../components/investor/InvestorPropertyModal';
import InvestorPropertyMap from '../components/investor/InvestorPropertyMap';
import MailCampaignModal from '../components/investor/MailCampaignModal';
import LetterPrintReminderModal from '../components/investor/LetterPrintReminderModal';
import CSVColumnMapperModal from '../components/investor/CSVColumnMapperModal';
import CSVValidationModal from '../components/investor/CSVValidationModal';

const CATEGORIES = [
  { value: 'all', label: 'All Categories' },
  { value: 'spec_home', label: 'Spec Home' },
  { value: 'vacant', label: 'Vacant' },
  { value: 'neglected', label: 'Neglected' },
  { value: 'foreclosure', label: 'Foreclosure' },
  { value: 'tax_delinquent', label: 'Tax Delinquent' },
  { value: 'other', label: 'Other' }
];

const STATUSES = [
  { value: 'all', label: 'All Statuses' },
  { value: 'active', label: 'Active' },
  { value: 'contacted', label: 'Contacted' },
  { value: 'interested', label: 'Interested' },
  { value: 'not_interested', label: 'Not Interested' },
  { value: 'closed', label: 'Closed' },
  { value: 'archived', label: 'Archived' }
];

export default function InvestorHub() {
  const queryClient = useQueryClient();
  
  const [searchQuery, setSearchQuery] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [statusFilter, setStatusFilter] = useState('all');
  const [hotOnlyFilter, setHotOnlyFilter] = useState(false);
  const [selectedPropertyIds, setSelectedPropertyIds] = useState([]);
  const [viewMode, setViewMode] = useState('list');
  
  const [isPropertyModalOpen, setIsPropertyModalOpen] = useState(false);
  const [editingProperty, setEditingProperty] = useState(null);
  const [isCampaignModalOpen, setIsCampaignModalOpen] = useState(false);
  const [editingCampaign, setEditingCampaign] = useState(null);
  const [detailProperty, setDetailProperty] = useState(null);
  const [previewProperty, setPreviewProperty] = useState(null);
  const [isLetterReminderOpen, setIsLetterReminderOpen] = useState(false);
  const [isImporting, setIsImporting] = useState(false);
  const [csvMapperData, setCsvMapperData] = useState(null);
  const [csvValidationData, setCsvValidationData] = useState(null);

  // Fetch data
  const { data: properties = [], isLoading: isLoadingProperties } = useQuery({
    queryKey: ['investorProperties'],
    queryFn: () => base44.entities.InvestorProperty.list('-created_date')
  });

  const { data: campaigns = [], isLoading: isLoadingCampaigns } = useQuery({
    queryKey: ['investorMailCampaigns'],
    queryFn: () => base44.entities.InvestorMailCampaign.list()
  });

  // Mutations
  const savePropertyMutation = useMutation({
    mutationFn: async (data) => {
      if (editingProperty) {
        return await base44.entities.InvestorProperty.update(editingProperty.id, data);
      } else {
        return await base44.entities.InvestorProperty.create(data);
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['investorProperties'] });
      toast.success(editingProperty ? 'Property updated' : 'Property added');
      setIsPropertyModalOpen(false);
      setEditingProperty(null);
    },
    onError: (error) => {
      toast.error('Failed to save property: ' + error.message);
    }
  });

  const deletePropertyMutation = useMutation({
    mutationFn: (id) => base44.entities.InvestorProperty.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['investorProperties'] });
      toast.success('Property deleted');
    }
  });

  const saveCampaignMutation = useMutation({
    mutationFn: async (data) => {
      if (editingCampaign) {
        return await base44.entities.InvestorMailCampaign.update(editingCampaign.id, data);
      } else {
        return await base44.entities.InvestorMailCampaign.create(data);
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['investorMailCampaigns'] });
      toast.success(editingCampaign ? 'Campaign updated' : 'Campaign created');
      setIsCampaignModalOpen(false);
      setEditingCampaign(null);
    }
  });

  const assignCampaignMutation = useMutation({
    mutationFn: async ({ propertyIds, campaignId }) => {
      const campaign = campaigns.find(c => c.id === campaignId);
      const intervalDays = campaign?.interval_days || 30;
      const nextFollowupDate = new Date();
      nextFollowupDate.setDate(nextFollowupDate.getDate() + intervalDays);
      
      const updates = propertyIds.map(id => 
        base44.entities.InvestorProperty.update(id, { 
          mail_campaign_id: campaignId,
          mail_campaign_step: 0,
          next_followup_date: nextFollowupDate.toISOString().split('T')[0]
        })
      );
      return await Promise.all(updates);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['investorProperties'] });
      toast.success('Campaign assigned to selected properties');
      setSelectedPropertyIds([]);
    }
  });

  const markLettersPrintedMutation = useMutation({
    mutationFn: async (propertyIds) => {
      const updates = propertyIds.map(async (id) => {
        const property = properties.find(p => p.id === id);
        if (!property) return;
        
        const campaign = campaigns.find(c => c.id === property.mail_campaign_id);
        const intervalDays = campaign?.interval_days || 30;
        const nextStep = (property.mail_campaign_step || 0) + 1;
        
        const nextFollowupDate = new Date();
        nextFollowupDate.setDate(nextFollowupDate.getDate() + intervalDays);
        
        return base44.entities.InvestorProperty.update(id, {
          mail_campaign_step: nextStep,
          next_followup_date: nextStep < 12 ? nextFollowupDate.toISOString().split('T')[0] : null,
          last_contact_date: new Date().toISOString().split('T')[0]
        });
      });
      return await Promise.all(updates);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['investorProperties'] });
      toast.success('Letters marked as printed, campaign advanced');
    }
  });

  // Filter properties
  const filteredProperties = useMemo(() => {
    return properties.filter(property => {
      const matchesSearch = !searchQuery || 
        property.address?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        property.city?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        property.owner_name?.toLowerCase().includes(searchQuery.toLowerCase());
      
      const matchesCategory = categoryFilter === 'all' || property.category === categoryFilter;
      const matchesStatus = statusFilter === 'all' || property.status === statusFilter;
      const matchesHot = !hotOnlyFilter || property.is_hot_property;
      
      return matchesSearch && matchesCategory && matchesStatus && matchesHot;
    });
  }, [properties, searchQuery, categoryFilter, statusFilter, hotOnlyFilter]);

  // Calculate letters due today
  const lettersDueToday = useMemo(() => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    return properties
      .filter(p => {
        if (!p.mail_campaign_id || !p.next_followup_date) return false;
        const followupDate = new Date(p.next_followup_date);
        followupDate.setHours(0, 0, 0, 0);
        return followupDate <= today && (p.mail_campaign_step || 0) < 12;
      })
      .map(property => {
        const campaign = campaigns.find(c => c.id === property.mail_campaign_id);
        return { property, campaign };
      })
      .filter(item => item.campaign);
  }, [properties, campaigns]);

  // Stats
  const stats = useMemo(() => ({
    total: properties.length,
    hot: properties.filter(p => p.is_hot_property).length,
    foreclosure: properties.filter(p => p.category === 'foreclosure' || p.is_foreclosure).length,
    taxDelinquent: properties.filter(p => p.category === 'tax_delinquent' || p.tax_delinquent_years > 0).length,
    absenteeOwner: properties.filter(p => p.mailing_address_differs).length,
    totalValue: properties.reduce((sum, p) => sum + (p.estimated_value || 0), 0),
    lettersToPrint: lettersDueToday.length
  }), [properties, lettersDueToday]);

  const handleSelectProperty = (id) => {
    setSelectedPropertyIds(prev => 
      prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
    );
  };

  const handleSelectAll = () => {
    if (selectedPropertyIds.length === filteredProperties.length) {
      setSelectedPropertyIds([]);
    } else {
      setSelectedPropertyIds(filteredProperties.map(p => p.id));
    }
  };

  const handleDeleteSelected = async () => {
    if (!confirm(`Are you sure you want to delete ${selectedPropertyIds.length} properties?`)) return;
    
    for (const id of selectedPropertyIds) {
      await deletePropertyMutation.mutateAsync(id);
    }
    setSelectedPropertyIds([]);
  };

  const handleAssignCampaign = (campaignId) => {
    if (selectedPropertyIds.length === 0) {
      toast.error('Please select properties first');
      return;
    }
    assignCampaignMutation.mutate({ propertyIds: selectedPropertyIds, campaignId });
  };

  // Export to CSV
  const handleExport = () => {
    const dataToExport = selectedPropertyIds.length > 0 
      ? properties.filter(p => selectedPropertyIds.includes(p.id))
      : properties;
    
    const headers = [
      'Address', 'City', 'State', 'ZIP', 'Owner Name', 'Owner Phone', 'Owner Email',
      'Owner Mailing Address', 'Owner Mailing City', 'Owner Mailing State', 'Owner Mailing ZIP',
      'Category', 'Status', 'Property Type', 'Estimated Value', 'Is Hot Property', 'Notes'
    ];
    
    const csvContent = [
      headers.join(','),
      ...dataToExport.map(p => [
        `"${p.address || ''}"`,
        `"${p.city || ''}"`,
        `"${p.state || ''}"`,
        `"${p.zip_code || ''}"`,
        `"${p.owner_name || ''}"`,
        `"${p.owner_phone || ''}"`,
        `"${p.owner_email || ''}"`,
        `"${p.owner_mailing_address || ''}"`,
        `"${p.owner_mailing_city || ''}"`,
        `"${p.owner_mailing_state || ''}"`,
        `"${p.owner_mailing_zip || ''}"`,
        `"${p.category || ''}"`,
        `"${p.status || ''}"`,
        `"${p.property_type || ''}"`,
        p.estimated_value || '',
        p.is_hot_property ? 'Yes' : 'No',
        `"${(p.notes || '').replace(/"/g, '""')}"`
      ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `investor_properties_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    toast.success(`Exported ${dataToExport.length} properties`);
  };

  // Parse CSV line handling quotes
  const parseCSVLine = (line) => {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current.trim());
    return result;
  };

  // Import from CSV - Step 1: Parse and show mapper
  const handleImport = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        toast.error('CSV file must have at least a header row and one data row.');
        return;
      }
      
      const headers = parseCSVLine(lines[0]).map(h => h.replace(/^"|"$/g, '').trim());
      
      // Parse all data rows into objects keyed by header
      const dataRows = [];
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((header, idx) => {
          row[header] = values[idx]?.replace(/^"|"$/g, '') || '';
        });
        dataRows.push(row);
      }
      
      // Open mapper modal with parsed data
      setCsvMapperData({
        headers,
        dataRows,
        totalRows: dataRows.length
      });
      
    } catch (error) {
      console.error('CSV parse error:', error);
      toast.error('Failed to read CSV file: ' + error.message);
    }
    
    e.target.value = '';
  };

  // Import from CSV - Step 2: Show validation modal
  const handleConfirmMapping = (columnMapping) => {
    if (!csvMapperData) return;
    
    // Move to validation step
    setCsvValidationData({
      dataRows: csvMapperData.dataRows,
      columnMapping
    });
    setCsvMapperData(null);
  };

  // Import from CSV - Step 3: Final import with validated data
  const handleConfirmImport = async (validatedData, columnMapping, deletedCount = 0) => {
    setIsImporting(true);
    setCsvValidationData(null);

    try {
      const newProperties = [];
      const updateProperties = [];

      for (const row of validatedData) {
        const property = { status: 'active' };

        Object.entries(columnMapping).forEach(([fieldKey, csvColumn]) => {
          if (csvColumn && row[csvColumn]) {
            let value = row[csvColumn];
            if (fieldKey === 'estimated_value') {
              value = parseFloat(value.replace(/[^0-9.-]/g, '')) || null;
            } else if (fieldKey === 'is_hot_property') {
              value = value.toLowerCase() === 'yes' || value === 'true' || value === '1';
            }
            property[fieldKey] = value;
          }
        });

        if (property.owner_mailing_address && property.owner_mailing_address !== property.address) {
          property.mailing_address_differs = true;
        }

        // Check if this should update an existing property
        if (row._willUpdate && row._duplicateId) {
          updateProperties.push({ id: row._duplicateId, data: property });
        } else {
          newProperties.push(property);
        }
      }

      // Update existing properties
      for (const { id, data } of updateProperties) {
        try {
          await base44.entities.InvestorProperty.update(id, data);
        } catch (err) {
          console.error('Error updating property:', err);
        }
      }

      // Create new properties
      if (newProperties.length > 0) {
        await base44.entities.InvestorProperty.bulkCreate(newProperties);
      }

      queryClient.invalidateQueries({ queryKey: ['investorProperties'] });

      let message = '';
      if (newProperties.length > 0) message += `${newProperties.length} new properties imported`;
      if (updateProperties.length > 0) message += `${message ? ', ' : ''}${updateProperties.length} properties updated`;
      if (deletedCount > 0) message += `${message ? ', ' : ''}${deletedCount} old properties deleted`;

      toast.success(message || 'Import completed!');
    } catch (error) {
      console.error('Import error:', error);
      toast.error('Failed to import: ' + error.message);
    } finally {
      setIsImporting(false);
    }
  };

  // Go back from validation to mapping
  const handleBackToMapping = () => {
    if (csvValidationData) {
      // Reconstruct mapper data from validation data
      const headers = Object.values(csvValidationData.columnMapping);
      setCsvMapperData({
        headers: [...new Set(csvValidationData.dataRows.length > 0 ? Object.keys(csvValidationData.dataRows[0]) : headers)],
        dataRows: csvValidationData.dataRows,
        totalRows: csvValidationData.dataRows.length
      });
      setCsvValidationData(null);
    }
  };

  const handleEditProperty = (property) => {
    setEditingProperty(property);
    setIsPropertyModalOpen(true);
  };

  const handleDeleteProperty = (id) => {
    if (confirm('Are you sure you want to delete this property?')) {
      deletePropertyMutation.mutate(id);
    }
  };

  const isLoading = isLoadingProperties || isLoadingCampaigns;

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center animate-pulse">
            <Building className="w-8 h-8 text-white" />
          </div>
          <p className="text-slate-500 dark:text-slate-400">Loading properties...</p>
        </div>
      </div>
    );
    }

    return (
    <TooltipProvider>
      <div className="space-y-6 pb-24">
        {/* Hero Header */}
        <div className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-slate-900 via-indigo-900 to-purple-900 p-6 md:p-8">
          <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMiIvPjwvZz48L2c+PC9zdmc+')] opacity-50" />
          <div className="relative flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div>
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2.5 rounded-xl bg-white/10 backdrop-blur-sm">
                  <Building className="w-6 h-6 text-white" />
                </div>
                <h1 className="text-2xl md:text-3xl font-bold text-white">Investor Hub</h1>
              </div>
              <p className="text-white/70 text-sm md:text-base">Track and manage investment property opportunities</p>
            </div>
            <div className="flex gap-2 flex-wrap">
              {lettersDueToday.length > 0 && (
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button 
                      variant="outline" 
                      className="relative bg-white/10 border-white/20 text-white hover:bg-white/20" 
                      onClick={() => setIsLetterReminderOpen(true)}
                    >
                      <Printer className="w-4 h-4 mr-2" /> Print Letters
                      <span className="absolute -top-1.5 -right-1.5 flex h-5 w-5 items-center justify-center">
                        <span className="absolute inline-flex h-full w-full animate-ping rounded-full bg-red-400 opacity-75" />
                        <span className="relative inline-flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white">
                          {lettersDueToday.length}
                        </span>
                      </span>
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>{lettersDueToday.length} letters ready to print</TooltipContent>
                </Tooltip>
              )}
              <Button variant="outline" className="bg-white/10 border-white/20 text-white hover:bg-white/20" onClick={handleExport}>
                <Download className="w-4 h-4 mr-2" /> Export
              </Button>
              <label>
                <Button variant="outline" asChild disabled={isImporting} className="bg-white/10 border-white/20 text-white hover:bg-white/20">
                  <span className="cursor-pointer">
                    {isImporting ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Upload className="w-4 h-4 mr-2" />}
                    Import
                  </span>
                </Button>
                <input type="file" accept=".csv" onChange={handleImport} className="hidden" />
              </label>
              <Button variant="outline" className="bg-white/10 border-white/20 text-white hover:bg-white/20" onClick={() => { setEditingCampaign(null); setIsCampaignModalOpen(true); }}>
                <Mail className="w-4 h-4 mr-2" /> Campaigns
              </Button>
              <Button className="bg-white text-indigo-900 hover:bg-white/90 shadow-lg" onClick={() => { setEditingProperty(null); setIsPropertyModalOpen(true); }}>
                <Plus className="w-4 h-4 mr-2" /> Add Property
              </Button>
            </div>
          </div>
        </div>

        {/* Letters Due Banner */}
        {lettersDueToday.length > 0 && (
          <Card className="overflow-hidden border-0 shadow-lg">
            <div className="bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 p-4">
              <div className="flex items-center justify-between flex-wrap gap-4">
                <div className="flex items-center gap-4">
                  <div className="p-3 bg-white/20 backdrop-blur-sm rounded-xl">
                    <Bell className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <h3 className="font-bold text-lg text-white">{lettersDueToday.length} Letters Due Today!</h3>
                    <p className="text-white/80 text-sm">Print and mail your follow-up letters to property owners</p>
                  </div>
                </div>
                <Button 
                  onClick={() => setIsLetterReminderOpen(true)}
                  className="bg-white text-orange-600 hover:bg-white/90 shadow-lg font-semibold"
                >
                  <Printer className="w-4 h-4 mr-2" /> View & Print Letters
                </Button>
              </div>
            </div>
          </Card>
        )}

        {/* Stats Cards - Modern Design */}
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
          <Card className="group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 border-0">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Total</p>
                  <p className="text-3xl font-bold text-slate-900 dark:text-white mt-1">{stats.total}</p>
                </div>
                <div className="p-3 rounded-xl bg-slate-200 dark:bg-slate-700 group-hover:scale-110 transition-transform">
                  <Building className="w-5 h-5 text-slate-600 dark:text-slate-300" />
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Letters to Print */}
          <Card 
            className={`group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 border-0 cursor-pointer ${
              stats.lettersToPrint > 0 
                ? 'bg-gradient-to-br from-orange-50 to-amber-50 dark:from-orange-900/30 dark:to-amber-900/30 ring-2 ring-orange-400 ring-offset-2' 
                : 'bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800'
            }`}
            onClick={() => stats.lettersToPrint > 0 && setIsLetterReminderOpen(true)}
          >
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className={`text-xs font-medium uppercase tracking-wider ${stats.lettersToPrint > 0 ? 'text-orange-600 dark:text-orange-400' : 'text-slate-500 dark:text-slate-400'}`}>To Print</p>
                  <p className={`text-3xl font-bold mt-1 ${stats.lettersToPrint > 0 ? 'text-orange-600 dark:text-orange-400' : 'text-slate-900 dark:text-white'}`}>{stats.lettersToPrint}</p>
                </div>
                <div className={`p-3 rounded-xl group-hover:scale-110 transition-transform ${stats.lettersToPrint > 0 ? 'bg-gradient-to-br from-orange-400 to-amber-500 animate-pulse' : 'bg-slate-200 dark:bg-slate-700'}`}>
                  <Printer className={`w-5 h-5 ${stats.lettersToPrint > 0 ? 'text-white' : 'text-slate-600 dark:text-slate-300'}`} />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 bg-gradient-to-br from-orange-50 to-red-50 dark:from-orange-900/30 dark:to-red-900/30 border-0">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-orange-600 dark:text-orange-400 uppercase tracking-wider">Hot</p>
                  <p className="text-3xl font-bold text-orange-600 dark:text-orange-400 mt-1">{stats.hot}</p>
                </div>
                <div className="p-3 rounded-xl bg-gradient-to-br from-orange-400 to-red-500 group-hover:scale-110 transition-transform">
                  <Flame className="w-5 h-5 text-white" />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 bg-gradient-to-br from-red-50 to-rose-50 dark:from-red-900/30 dark:to-rose-900/30 border-0">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-red-600 dark:text-red-400 uppercase tracking-wider">Foreclosure</p>
                  <p className="text-3xl font-bold text-red-600 dark:text-red-400 mt-1">{stats.foreclosure}</p>
                </div>
                <div className="p-3 rounded-xl bg-gradient-to-br from-red-400 to-rose-500 group-hover:scale-110 transition-transform">
                  <AlertTriangle className="w-5 h-5 text-white" />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/30 dark:to-violet-900/30 border-0">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-purple-600 dark:text-purple-400 uppercase tracking-wider">Tax Delin.</p>
                  <p className="text-3xl font-bold text-purple-600 dark:text-purple-400 mt-1">{stats.taxDelinquent}</p>
                </div>
                <div className="p-3 rounded-xl bg-gradient-to-br from-purple-400 to-violet-500 group-hover:scale-110 transition-transform">
                  <DollarSign className="w-5 h-5 text-white" />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-amber-900/30 dark:to-yellow-900/30 border-0">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-amber-600 dark:text-amber-400 uppercase tracking-wider">Absentee</p>
                  <p className="text-3xl font-bold text-amber-600 dark:text-amber-400 mt-1">{stats.absenteeOwner}</p>
                </div>
                <div className="p-3 rounded-xl bg-gradient-to-br from-amber-400 to-yellow-500 group-hover:scale-110 transition-transform">
                  <Users className="w-5 h-5 text-white" />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="group hover:shadow-lg transition-all duration-300 hover:-translate-y-1 bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/30 dark:to-green-900/30 border-0">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-emerald-600 dark:text-emerald-400 uppercase tracking-wider">Value</p>
                  <p className="text-3xl font-bold text-emerald-600 dark:text-emerald-400 mt-1">${(stats.totalValue / 1000000).toFixed(1)}M</p>
                </div>
                <div className="p-3 rounded-xl bg-gradient-to-br from-emerald-400 to-green-500 group-hover:scale-110 transition-transform">
                  <TrendingUp className="w-5 h-5 text-white" />
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

      {/* Filters and Search - Modernized */}
      <Card className="border-0 shadow-sm bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm">
        <CardContent className="p-4">
          <div className="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
            <div className="flex flex-wrap gap-2 items-center">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                <Input 
                  placeholder="Search properties, owners..." 
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="pl-9 w-64 bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-indigo-500/20"
                />
              </div>
              <Select value={categoryFilter} onValueChange={setCategoryFilter}>
                <SelectTrigger className="w-40 bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {CATEGORIES.map(cat => (
                    <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <Select value={statusFilter} onValueChange={setStatusFilter}>
                <SelectTrigger className="w-40 bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {STATUSES.map(status => (
                    <SelectItem key={status.value} value={status.value}>{status.label}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <Button 
                variant={hotOnlyFilter ? "default" : "outline"} 
                size="sm"
                onClick={() => setHotOnlyFilter(!hotOnlyFilter)}
                className={hotOnlyFilter ? 'bg-gradient-to-r from-orange-500 to-red-500 border-0 hover:from-orange-600 hover:to-red-600' : ''}
              >
                <Flame className={`w-4 h-4 mr-1.5 ${hotOnlyFilter ? 'animate-pulse' : ''}`} /> Hot Only
              </Button>
            </div>

            <div className="flex gap-2 items-center">
              <div className="flex rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={() => setViewMode('list')}
                  className={`rounded-none px-3 ${viewMode === 'list' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600' : ''}`}
                >
                  <List className="w-4 h-4" />
                </Button>
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={() => setViewMode('grid')}
                  className={`rounded-none px-3 border-l border-slate-200 dark:border-slate-700 ${viewMode === 'grid' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600' : ''}`}
                >
                  <LayoutGrid className="w-4 h-4" />
                </Button>
              </div>

              {selectedPropertyIds.length > 0 && (
                <div className="flex items-center gap-2 bg-indigo-50 dark:bg-indigo-900/30 px-3 py-1.5 rounded-xl border border-indigo-200 dark:border-indigo-800">
                  <span className="text-sm font-semibold text-indigo-700 dark:text-indigo-300">{selectedPropertyIds.length} selected</span>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button variant="ghost" size="sm" className="text-indigo-600 hover:text-indigo-700 hover:bg-indigo-100 dark:hover:bg-indigo-900/50">
                        <Mail className="w-4 h-4 mr-1" /> Assign Campaign
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent>
                      {campaigns.map(campaign => (
                        <DropdownMenuItem key={campaign.id} onClick={() => handleAssignCampaign(campaign.id)}>
                          {campaign.name}
                        </DropdownMenuItem>
                      ))}
                      {campaigns.length === 0 && (
                        <DropdownMenuItem disabled>No campaigns available</DropdownMenuItem>
                      )}
                    </DropdownMenuContent>
                  </DropdownMenu>
                  <Button variant="ghost" size="sm" className="text-red-600 hover:text-red-700 hover:bg-red-100 dark:hover:bg-red-900/30" onClick={handleDeleteSelected}>
                    <Trash2 className="w-4 h-4" />
                  </Button>
                </div>
              )}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Property List */}
      <div>
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <Button variant="outline" size="sm" onClick={handleSelectAll} className="border-slate-300 dark:border-slate-600">
              <CheckSquare className="w-4 h-4 mr-1.5" />
              {selectedPropertyIds.length === filteredProperties.length ? 'Deselect All' : 'Select All'}
            </Button>
            <div className="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
              <FileText className="w-4 h-4" />
              <span className="font-medium">{filteredProperties.length}</span> properties
            </div>
          </div>
        </div>

        {filteredProperties.length === 0 ? (
          <Card className="border-dashed border-2 border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50">
            <CardContent className="p-16 text-center">
              <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-700 flex items-center justify-center">
                <Building className="w-10 h-10 text-slate-400" />
              </div>
              <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">No properties found</h3>
              <p className="text-slate-500 dark:text-slate-400 mb-6 max-w-md mx-auto">Add your first investment property to start tracking opportunities and managing mail campaigns.</p>
              <Button onClick={() => { setEditingProperty(null); setIsPropertyModalOpen(true); }} className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700">
                <Plus className="w-4 h-4 mr-2" /> Add Your First Property
              </Button>
            </CardContent>
          </Card>
        ) : (
          <div className={viewMode === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4' : 'space-y-3'}>
            {filteredProperties.map(property => (
              <InvestorPropertyCard
                key={property.id}
                property={property}
                isSelected={selectedPropertyIds.includes(property.id)}
                onSelect={handleSelectProperty}
                onEdit={handleEditProperty}
                onDelete={handleDeleteProperty}
                onViewDetails={setDetailProperty}
              />
            ))}
          </div>
        )}
      </div>

      {/* Map Section */}
      <Card className="relative z-0 overflow-hidden border-0 shadow-lg">
        <CardHeader className="bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 border-b border-slate-200 dark:border-slate-700">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-indigo-100 dark:bg-indigo-900/50">
                <MapPin className="w-5 h-5 text-indigo-600 dark:text-indigo-400" />
              </div>
              <div>
                <CardTitle className="text-lg">Property Map</CardTitle>
                <CardDescription>
                  {selectedPropertyIds.length > 0 
                    ? `Showing ${selectedPropertyIds.length} selected properties` 
                    : `Showing all ${filteredProperties.length} properties`}
                </CardDescription>
              </div>
            </div>
          </div>
        </CardHeader>
        <CardContent className="p-0">
          <div className="h-[500px]">
            <InvestorPropertyMap 
              properties={selectedPropertyIds.length > 0 
                ? filteredProperties.filter(p => selectedPropertyIds.includes(p.id))
                : filteredProperties
              }
              selectedIds={selectedPropertyIds}
              onPropertyClick={(property) => {
                setEditingProperty(property);
                setIsPropertyModalOpen(true);
              }}
            />
          </div>
        </CardContent>
      </Card>

      {/* Mail Campaigns Section */}
      <Card className="relative z-0 overflow-hidden border-0 shadow-lg">
        <CardHeader className="bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/30 dark:to-indigo-900/30 border-b border-purple-100 dark:border-purple-800">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-500">
                <Mail className="w-5 h-5 text-white" />
              </div>
              <div>
                <CardTitle className="text-lg">Mail Campaigns</CardTitle>
                <CardDescription>12-letter follow-up campaigns for property owners</CardDescription>
              </div>
            </div>
            <Button onClick={() => { setEditingCampaign(null); setIsCampaignModalOpen(true); }} className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700">
              <Plus className="w-4 h-4 mr-2" /> New Campaign
            </Button>
          </div>
        </CardHeader>
        <CardContent className="p-6">
          {campaigns.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-purple-100 to-indigo-100 dark:from-purple-900/30 dark:to-indigo-900/30 flex items-center justify-center">
                <Mail className="w-8 h-8 text-purple-500" />
              </div>
              <h3 className="font-semibold text-slate-900 dark:text-white mb-2">No campaigns yet</h3>
              <p className="text-slate-500 dark:text-slate-400 max-w-md mx-auto">Create a 12-letter campaign to start following up with property owners automatically.</p>
            </div>
          ) : (
            <div className="space-y-4">
              <div className="flex items-center gap-4 p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50">
                <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Preview with:</span>
                <Select value={previewProperty?.id || 'sample'} onValueChange={(v) => setPreviewProperty(v === 'sample' ? null : properties.find(p => p.id === v) || null)}>
                  <SelectTrigger className="w-64 bg-white dark:bg-slate-800">
                    <SelectValue placeholder="Select a property for preview" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="sample">Sample Data</SelectItem>
                    {properties.filter(p => p.owner_name).map(prop => (
                      <SelectItem key={prop.id} value={prop.id}>{prop.address} - {prop.owner_name}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {campaigns.map(campaign => (
                  <Card 
                    key={campaign.id} 
                    className="group cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all duration-300 border-0 bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-800" 
                    onClick={() => { setEditingCampaign(campaign); setIsCampaignModalOpen(true); }}
                  >
                    <CardContent className="p-4">
                      <div className="flex items-start justify-between mb-3">
                        <div className="p-2 rounded-lg bg-gradient-to-br from-purple-100 to-indigo-100 dark:from-purple-900/50 dark:to-indigo-900/50 group-hover:scale-110 transition-transform">
                          <Mail className="w-4 h-4 text-purple-600 dark:text-purple-400" />
                        </div>
                        <Badge 
                          className={campaign.is_active 
                            ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300 border-0' 
                            : 'bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400 border-0'
                          }
                        >
                          {campaign.is_active ? 'Active' : 'Inactive'}
                        </Badge>
                      </div>
                      <h4 className="font-semibold text-slate-900 dark:text-white mb-1">{campaign.name}</h4>
                      <p className="text-sm text-slate-500 dark:text-slate-400 mb-2">{campaign.description || '12-letter follow-up sequence'}</p>
                      <div className="flex items-center gap-1 text-xs text-slate-400">
                        <Clock className="w-3 h-3" />
                        Every {campaign.interval_days || 30} days
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Modals */}
      <InvestorPropertyModal
        property={editingProperty}
        isOpen={isPropertyModalOpen}
        onClose={() => { setIsPropertyModalOpen(false); setEditingProperty(null); }}
        onSave={(data) => savePropertyMutation.mutate(data)}
        campaigns={campaigns}
      />

      <MailCampaignModal
        campaign={editingCampaign}
        isOpen={isCampaignModalOpen}
        onClose={() => { setIsCampaignModalOpen(false); setEditingCampaign(null); setPreviewProperty(null); }}
        onSave={(data) => saveCampaignMutation.mutate(data)}
        selectedProperty={previewProperty}
      />

      <LetterPrintReminderModal
        isOpen={isLetterReminderOpen}
        onClose={() => setIsLetterReminderOpen(false)}
        lettersToPrint={lettersDueToday}
        campaigns={campaigns}
        onMarkAsPrinted={(propertyIds) => markLettersPrintedMutation.mutate(propertyIds)}
      />

      {csvMapperData && (
        <CSVColumnMapperModal
          isOpen={true}
          onClose={() => setCsvMapperData(null)}
          csvHeaders={csvMapperData.headers}
          csvPreviewData={csvMapperData.dataRows}
          totalRows={csvMapperData.totalRows}
          onConfirm={handleConfirmMapping}
        />
      )}

      {csvValidationData && (
        <CSVValidationModal
          isOpen={true}
          onClose={() => setCsvValidationData(null)}
          csvData={csvValidationData.dataRows}
          columnMapping={csvValidationData.columnMapping}
          onConfirmImport={handleConfirmImport}
          onBack={handleBackToMapping}
        />
      )}
      </div>
      </TooltipProvider>
      );
      }
import React, { useState, useEffect, useRef } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Sparkles, Send, Loader2, Maximize2, Minimize2, Volume2, VolumeX, RotateCcw, Zap, Calendar } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import ReactMarkdown from 'react-markdown';
import { toast } from 'sonner';
import { format, parseISO, isToday, isTomorrow, isThisWeek, isPast } from 'date-fns';
import JackieVoiceInterface from '../components/jackie/JackieVoiceInterface';

export default function JackieAI() {
    const [messages, setMessages] = useState([]);
    const [inputMessage, setInputMessage] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [isFullscreen, setIsFullscreen] = useState(false);
    const [voiceEnabled, setVoiceEnabled] = useState(false);
    const messagesEndRef = useRef(null);
    const inputRef = useRef(null);

    const { data: currentUser } = useQuery({
        queryKey: ['currentUser'],
        queryFn: () => base44.auth.me(),
    });

    const { data: appointments = [] } = useQuery({
        queryKey: ['appointments'],
        queryFn: () => base44.entities.Appointment.list(),
    });

    const { data: showings = [] } = useQuery({
        queryKey: ['showings'],
        queryFn: () => base44.entities.Showing.list(),
    });

    const { data: openHouses = [] } = useQuery({
        queryKey: ['openHouses'],
        queryFn: () => base44.entities.OpenHouse.list(),
    });

    const { data: tasks = [] } = useQuery({
        queryKey: ['tasks'],
        queryFn: () => base44.entities.Task.list(),
    });

    const { data: properties = [] } = useQuery({
        queryKey: ['properties'],
        queryFn: () => base44.entities.Property.list(),
    });

    const { data: leads = [] } = useQuery({
        queryKey: ['leads'],
        queryFn: () => base44.entities.Lead.list(),
    });

    const { data: buyers = [] } = useQuery({
        queryKey: ['buyers'],
        queryFn: () => base44.entities.Buyer.list(),
    });

    const { data: transactions = [] } = useQuery({
        queryKey: ['transactions'],
        queryFn: () => base44.entities.Transaction.list(),
    });

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    useEffect(() => {
        if (!isLoading) {
            setTimeout(() => inputRef.current?.focus(), 100);
        }
    }, [isLoading]);

    const speakText = (text) => {
        if (!voiceEnabled || !text) return;
        window.speechSynthesis.cancel();
        const cleanText = text.replace(/[#*_~`]/g, '').replace(/\n+/g, '. ');
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.rate = 1.0;
        utterance.pitch = 1.1;
        window.speechSynthesis.speak(utterance);
    };

    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        try {
            const date = parseISO(dateStr);
            if (isToday(date)) return 'Today';
            if (isTomorrow(date)) return 'Tomorrow';
            return format(date, 'EEEE, MMMM d');
        } catch {
            return dateStr;
        }
    };

    const buildDataContext = () => {
        const today = format(new Date(), 'yyyy-MM-dd');
        
        const allEvents = [
            ...appointments.map(a => ({
                type: 'Appointment',
                title: a.title,
                date: a.scheduled_date,
                time: a.scheduled_time,
                location: a.location_address || '',
                client: a.client_name || '',
                status: a.status
            })),
            ...showings.map(s => {
                const prop = properties.find(p => p.id === s.property_id);
                return {
                    type: 'Showing',
                    title: `Property Showing`,
                    date: s.scheduled_date,
                    time: s.scheduled_time,
                    location: prop?.address || '',
                    status: s.status
                };
            }),
            ...openHouses.map(oh => {
                const prop = properties.find(p => p.id === oh.property_id);
                return {
                    type: 'Open House',
                    title: `Open House`,
                    date: oh.date,
                    time: oh.start_time ? `${oh.start_time} - ${oh.end_time}` : '',
                    location: prop?.address || '',
                    status: oh.status
                };
            })
        ].filter(e => e.date);

        const pendingTasks = tasks.filter(t => t.status !== 'completed' && t.status !== 'cancelled');
        
        return {
            today,
            events: allEvents,
            tasks: pendingTasks.map(t => ({
                title: t.title,
                dueDate: t.due_date,
                priority: t.priority,
                status: t.status
            })),
            propertiesCount: properties.length,
            leadsCount: leads.length,
            buyersCount: buyers.length,
            transactionsCount: transactions.length
        };
    };

    const handleSendMessage = async () => {
        if (!inputMessage.trim() || isLoading) return;

        const userMessage = inputMessage.trim();
        setInputMessage('');
        setIsLoading(true);

        const newMessages = [...messages, { role: 'user', content: userMessage }];
        setMessages(newMessages);

        try {
            const data = buildDataContext();
            
            // Detect if message contains an address (with or without valuation keywords)
            const addressMatch = userMessage.match(/\d+\s+[A-Za-z\s]+(?:street|st|avenue|ave|road|rd|drive|dr|lane|ln|boulevard|blvd|way|court|ct)[^,]*/i);
            
            let responseContent = '';
            
            if (addressMatch) {
                // This is a property query - return ATTOM data directly, NO LLM
                const address = addressMatch[0];
                
                // Find property in database
                const matchingProperty = properties.find(p => 
                    p.address && p.address.toLowerCase().includes(address.toLowerCase())
                );
                
                if (matchingProperty?.attom_data) {
                    try {
                        const attomData = typeof matchingProperty.attom_data === 'string' 
                            ? JSON.parse(matchingProperty.attom_data) 
                            : matchingProperty.attom_data;
                        
                        const avm = attomData?.avmSnapshot?.property?.[0]?.avm || attomData?.avmDetail?.property?.[0]?.avm;
                        const owner = attomData?.ownerDetail?.property?.[0]?.owner;
                        
                        const value = avm?.amount?.value ? `$${avm.amount.value.toLocaleString()}` : 'N/A';
                        const ownerName = owner?.owner1?.fullName || 'N/A';
                        
                        // Direct response - NO LLM, NO WEB SEARCH
                        responseContent = `Estimated value: ${value}\nOwner: ${ownerName}`;
                    } catch (e) {
                        console.error('Error parsing ATTOM data:', e);
                        responseContent = "Error reading property data.";
                    }
                } else {
                    responseContent = "No valuation data available for this property.";
                }
            } else {
                // Regular questions about calendar/tasks - use LLM
                const prompt = `You are Jackie, a helpful real estate assistant for ${currentUser?.full_name || 'the user'}.

TODAY IS: ${format(new Date(), 'EEEE, MMMM d, yyyy')}

THE USER'S CALENDAR EVENTS:
${JSON.stringify(data.events, null, 2)}

THE USER'S PENDING TASKS:
${JSON.stringify(data.tasks, null, 2)}

SUMMARY:
- ${data.propertiesCount} properties
- ${data.leadsCount} leads
- ${data.buyersCount} buyers
- ${data.transactionsCount} transactions

INSTRUCTIONS:
- ONLY use the data above
- Answer questions about schedule, calendar, tasks, or business summary
- Be concise and friendly
- Do NOT search the internet

User question: ${userMessage}`;

                responseContent = await base44.integrations.Core.InvokeLLM({ 
                    prompt,
                    add_context_from_internet: false
                });
            }

            const assistantMessage = { role: 'assistant', content: responseContent };
            setMessages([...newMessages, assistantMessage]);
            
            if (voiceEnabled) {
                speakText(responseContent);
            }
        } catch (error) {
            console.error('Error:', error);
            setMessages([...newMessages, { role: 'assistant', content: 'Sorry, something went wrong. Please try again.' }]);
        } finally {
            setIsLoading(false);
        }
    };

    const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
    };

    const quickActions = [
        { label: "üìÖ Today's schedule", prompt: "What do I have scheduled for today?" },
        { label: 'üìÖ This week', prompt: 'What meetings do I have this week?' },
        { label: '‚úÖ My tasks', prompt: 'What tasks do I need to complete?' },
        { label: 'üè° Properties summary', prompt: 'Give me a summary of my properties' },
    ];

    return (
        <div className={`flex flex-col ${isFullscreen ? 'fixed inset-0 z-50' : 'h-[calc(100vh-2rem)]'} bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800`}>
            <Card className="flex flex-col h-full border-0 shadow-2xl">
                <CardHeader className="flex-none border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 py-4">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <Avatar className="h-10 w-10 ring-2 ring-white/50">
                                <AvatarFallback className="bg-gradient-to-br from-amber-400 to-orange-500 text-white font-bold">
                                    J
                                </AvatarFallback>
                            </Avatar>
                            <div>
                                <CardTitle className="text-white flex items-center gap-2 text-lg">
                                    Jackie AI
                                    <Sparkles className="w-4 h-4 text-amber-300" />
                                </CardTitle>
                                <p className="text-white/70 text-xs">Your Executive Assistant</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <Button variant="ghost" size="sm" onClick={() => setMessages([])} className="text-white hover:bg-white/20">
                                <RotateCcw className="w-4 h-4 mr-1" /> New
                            </Button>
                            <Button variant="ghost" size="icon" onClick={() => setVoiceEnabled(!voiceEnabled)} className="text-white hover:bg-white/20">
                                {voiceEnabled ? <Volume2 className="w-4 h-4" /> : <VolumeX className="w-4 h-4" />}
                            </Button>
                            <Button variant="ghost" size="icon" onClick={() => setIsFullscreen(!isFullscreen)} className="text-white hover:bg-white/20">
                                {isFullscreen ? <Minimize2 className="w-4 h-4" /> : <Maximize2 className="w-4 h-4" />}
                            </Button>
                        </div>
                    </div>
                </CardHeader>

                <Tabs defaultValue="calendar" className="flex-1 flex flex-col overflow-hidden">
                    <TabsList className="w-full rounded-none border-b">
                        <TabsTrigger value="calendar" className="flex-1">
                            <Calendar className="w-4 h-4 mr-2" />
                            Calendar & Tasks
                        </TabsTrigger>
                        <TabsTrigger value="voice" className="flex-1">
                            <Zap className="w-4 h-4 mr-2" />
                            Voice Assistant (Beta)
                        </TabsTrigger>
                    </TabsList>

                    <TabsContent value="calendar" className="flex-1 flex flex-col overflow-hidden m-0 data-[state=active]:flex">
                        <CardContent className="flex-1 flex flex-col overflow-hidden p-0">
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.length === 0 && (
                            <div className="text-center py-8">
                                <Sparkles className="w-16 h-16 text-indigo-500 mx-auto mb-4" />
                                <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
                                    Hi {currentUser?.full_name?.split(' ')[0] || 'there'}! üëã
                                </h3>
                                <p className="text-slate-600 dark:text-slate-400 mb-6">
                                    I can help you with your calendar, appointments, and tasks.
                                </p>
                                <div className="grid grid-cols-2 gap-2 max-w-md mx-auto">
                                    {quickActions.map((action, idx) => (
                                        <Button
                                            key={idx}
                                            variant="outline"
                                            size="sm"
                                            onClick={() => setInputMessage(action.prompt)}
                                            className="text-left justify-start"
                                        >
                                            {action.label}
                                        </Button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <AnimatePresence>
                            {messages.map((msg, idx) => (
                                <motion.div
                                    key={idx}
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                >
                                    <div className={`max-w-[80%] rounded-2xl px-4 py-2 ${
                                        msg.role === 'user' 
                                            ? 'bg-indigo-600 text-white' 
                                            : 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700'
                                    }`}>
                                        <ReactMarkdown className="text-sm prose prose-sm max-w-none dark:prose-invert">
                                            {msg.content}
                                        </ReactMarkdown>
                                    </div>
                                </motion.div>
                            ))}
                        </AnimatePresence>

                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl px-4 py-3">
                                    <div className="flex gap-1">
                                        <motion.div className="w-2 h-2 bg-indigo-600 rounded-full" animate={{ scale: [1, 1.5, 1] }} transition={{ duration: 0.6, repeat: Infinity, delay: 0 }} />
                                        <motion.div className="w-2 h-2 bg-indigo-600 rounded-full" animate={{ scale: [1, 1.5, 1] }} transition={{ duration: 0.6, repeat: Infinity, delay: 0.2 }} />
                                        <motion.div className="w-2 h-2 bg-indigo-600 rounded-full" animate={{ scale: [1, 1.5, 1] }} transition={{ duration: 0.6, repeat: Infinity, delay: 0.4 }} />
                                    </div>
                                </div>
                            </div>
                        )}

                        <div ref={messagesEndRef} />
                    </div>

                    <div className="flex-none border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4">
                        <div className="flex gap-2">
                            <Input
                                ref={inputRef}
                                value={inputMessage}
                                onChange={(e) => setInputMessage(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Ask about your schedule, tasks, or properties..."
                                className="flex-1"
                                disabled={isLoading}
                            />
                            <Button onClick={handleSendMessage} disabled={!inputMessage.trim() || isLoading} className="bg-indigo-600 hover:bg-indigo-700">
                                {isLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Send className="w-4 h-4" />}
                            </Button>
                        </div>
                        </div>
                    </CardContent>
                </TabsContent>

                <TabsContent value="voice" className="flex-1 overflow-hidden m-0 data-[state=active]:flex">
                    <JackieVoiceInterface user={currentUser} testMode={true} />
                </TabsContent>
            </Tabs>
            </Card>
        </div>
    );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Brain,
  CheckSquare,
  MessageSquare,
  Clock,
  Sparkles,
  RefreshCw,
  AlertCircle,
  X,
  Send,
  CalendarPlus,
  ListTodo,
  Target
} from "lucide-react";
import { toast } from "sonner";
import { format, parseISO } from "date-fns";

export default function JackieFollowups() {
  const navigate = useNavigate();
  const [isLoading, setIsLoading] = useState(true);
  const [isGenerating, setIsGenerating] = useState(false);
  const [user, setUser] = useState(null);
  const [conversations, setConversations] = useState([]);
  const [learnings, setLearnings] = useState([]);
  const [suggestions, setSuggestions] = useState([]);
  const [pendingActions, setPendingActions] = useState([]);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const currentUser = await base44.auth.me();
      setUser(currentUser);

      const [convos, learns] = await Promise.all([
        base44.entities.JackieConversation.filter({ user_id: currentUser.id }, '-created_date', 50),
        base44.entities.JackieLearning.filter({ user_id: currentUser.id, is_active: true })
      ]);

      setConversations(convos || []);
      setLearnings(learns || []);

      // Auto-generate suggestions if none exist
      if (convos && convos.length > 0) {
        await generateSuggestions(convos, learns);
      }
    } catch (error) {
      console.error("Error loading data:", error);
    }
    setIsLoading(false);
  };

  const generateSuggestions = async (convos = conversations, learns = learnings) => {
    setIsGenerating(true);
    try {
      // Analyze recent completed conversations (last 30 days)
      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
      const recentCompletedConvos = convos.filter(c => 
        c.outcome === 'completed' && 
        new Date(c.created_date) > thirtyDaysAgo
      );

      if (recentCompletedConvos.length === 0) {
        setSuggestions([]);
        setPendingActions([]);
        toast.info("No recent completed conversations to analyze");
        setIsGenerating(false);
        return;
      }

      // Prepare context
      const conversationSummaries = recentCompletedConvos.slice(0, 10).map(c => {
        const messages = JSON.parse(c.messages || '[]');
        const summary = messages.map(m => `${m.role}: ${m.content}`).join('\n');
        return {
          id: c.id,
          type: c.conversation_type,
          date: c.created_date,
          record_type: c.created_record_type,
          record_id: c.created_record_id,
          summary: summary.substring(0, 500) // Limit length
        };
      });

      const learningContext = learns.map(l => 
        `${l.key}: ${l.value} (confidence: ${l.confidence}%)`
      ).join('\n');

      // Generate follow-up suggestions using AI
      const aiResponse = await base44.integrations.Core.InvokeLLM({
        prompt: `You are Jackie's Proactive Follow-up Assistant. Analyze these completed conversations and learned preferences to suggest proactive follow-up actions.

RECENT CONVERSATIONS:
${JSON.stringify(conversationSummaries, null, 2)}

LEARNED USER PREFERENCES:
${learningContext}

Based on these conversations, identify opportunities for:
1. Follow-up meetings (e.g., "You met with John 2 weeks ago, schedule a follow-up?")
2. Follow-up tasks (e.g., "Send property details to Sarah as discussed")
3. Follow-up messages (e.g., "Check in with Gila about the coffee meeting outcome")
4. Reminders about pending actions mentioned in conversations

For each suggestion, provide:
- suggestion_type: "meeting", "task", or "message"
- title: Clear, actionable title
- description: Why this follow-up is suggested
- priority: "high", "medium", or "low"
- suggested_action: Specific action to take
- related_conversation_id: ID of the conversation this relates to
- suggested_date: When to do this (YYYY-MM-DD format)
- context: Relevant details from the conversation

Only suggest meaningful, actionable follow-ups. Max 10 suggestions.`,
        response_json_schema: {
          type: "object",
          properties: {
            suggestions: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  suggestion_type: { type: "string" },
                  title: { type: "string" },
                  description: { type: "string" },
                  priority: { type: "string" },
                  suggested_action: { type: "string" },
                  related_conversation_id: { type: "string" },
                  suggested_date: { type: "string" },
                  context: { type: "string" }
                },
                required: ["suggestion_type", "title", "description", "priority"]
              }
            },
            pending_actions: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  action: { type: "string" },
                  deadline: { type: "string" },
                  priority: { type: "string" }
                }
              }
            }
          }
        }
      });

      if (aiResponse && aiResponse.suggestions) {
        setSuggestions(aiResponse.suggestions || []);
        setPendingActions(aiResponse.pending_actions || []);
        toast.success(`Generated ${aiResponse.suggestions.length} follow-up suggestions!`);
      }
    } catch (error) {
      console.error("Error generating suggestions:", error);
      toast.error("Failed to generate suggestions");
    }
    setIsGenerating(false);
  };

  const handleCreateMeeting = async (suggestion) => {
    try {
      // Use AI to extract appointment details from suggestion
      const appointmentData = await base44.integrations.Core.InvokeLLM({
        prompt: `Based on this follow-up suggestion, create appointment details:

Suggestion: ${suggestion.title}
Description: ${suggestion.description}
Context: ${suggestion.context || ''}
Suggested Date: ${suggestion.suggested_date || new Date().toISOString().split('T')[0]}

Extract and return:
- title: Appointment title
- scheduled_date: Date in YYYY-MM-DD format
- scheduled_time: Suggested time in HH:MM format (use learned preference or 10:00 AM)
- client_name: Person to meet with
- location_address: Meeting location (if mentioned)
- appointment_type: One of: client_meeting, follow_up, general`,
        response_json_schema: {
          type: "object",
          properties: {
            title: { type: "string" },
            scheduled_date: { type: "string" },
            scheduled_time: { type: "string" },
            client_name: { type: "string" },
            location_address: { type: "string" },
            appointment_type: { type: "string" }
          },
          required: ["title", "scheduled_date"]
        }
      });

      if (!appointmentData || !appointmentData.title) {
        throw new Error('Could not extract appointment data');
      }

      await base44.entities.Appointment.create({
        title: appointmentData.title,
        appointment_type: appointmentData.appointment_type || 'follow_up',
        scheduled_date: appointmentData.scheduled_date,
        scheduled_time: appointmentData.scheduled_time || '10:00',
        duration_minutes: 60,
        client_name: appointmentData.client_name || '',
        location_address: appointmentData.location_address || '',
        agent_id: user.id,
        status: 'scheduled',
        notes: `Follow-up from Jackie AI: ${suggestion.description}`
      });

      toast.success('‚úÖ Follow-up meeting created!');
      
      // Remove this suggestion
      setSuggestions(prev => prev.filter(s => s !== suggestion));
    } catch (error) {
      console.error("Error creating meeting:", error);
      toast.error("Failed to create meeting");
    }
  };

  const handleCreateTask = async (suggestion) => {
    try {
      const taskData = await base44.integrations.Core.InvokeLLM({
        prompt: `Based on this follow-up suggestion, create task details:

Suggestion: ${suggestion.title}
Description: ${suggestion.description}
Priority: ${suggestion.priority}
Suggested Date: ${suggestion.suggested_date || new Date().toISOString().split('T')[0]}

Extract and return:
- title: Task title
- description: Task description
- due_date: Date in YYYY-MM-DD format
- priority: One of: critical, high, medium, low`,
        response_json_schema: {
          type: "object",
          properties: {
            title: { type: "string" },
            description: { type: "string" },
            due_date: { type: "string" },
            priority: { type: "string" }
          },
          required: ["title"]
        }
      });

      if (!taskData || !taskData.title) {
        throw new Error('Could not extract task data');
      }

      await base44.entities.Task.create({
        title: taskData.title,
        description: taskData.description || suggestion.description,
        due_date: taskData.due_date || suggestion.suggested_date || new Date().toISOString().split('T')[0],
        priority: taskData.priority || suggestion.priority || 'medium',
        assigned_to: user.id,
        status: 'pending',
        task_type: 'general'
      });

      toast.success('‚úÖ Follow-up task created!');
      
      setSuggestions(prev => prev.filter(s => s !== suggestion));
    } catch (error) {
      console.error("Error creating task:", error);
      toast.error("Failed to create task");
    }
  };

  const handleDraftMessage = async (suggestion) => {
    try {
      // Generate a personalized message using learned communication style
      const messageData = await base44.integrations.Core.InvokeLLM({
        prompt: `Generate a personalized follow-up message based on this suggestion:

Suggestion: ${suggestion.title}
Description: ${suggestion.description}
Context: ${suggestion.context || ''}

User's learned communication style preferences:
${learnings.filter(l => l.category === 'communication_style').map(l => `- ${l.key}: ${l.value}`).join('\n')}

Generate a professional but warm follow-up message. Include:
- subject: Email subject line
- message: The message body (2-3 paragraphs)
- recipient_name: Person to send to (if identified)`,
        response_json_schema: {
          type: "object",
          properties: {
            subject: { type: "string" },
            message: { type: "string" },
            recipient_name: { type: "string" }
          },
          required: ["subject", "message"]
        }
      });

      if (!messageData || !messageData.message) {
        throw new Error('Could not generate message');
      }

      // Create draft message
      await base44.entities.Message.create({
        sender_id: user.id,
        subject: messageData.subject,
        content: messageData.message,
        message_type: 'draft',
        thread_id: `draft_${Date.now()}`
      });

      toast.success('‚úÖ Draft message created! Check your Messages.');
      
      setSuggestions(prev => prev.filter(s => s !== suggestion));
      
      setTimeout(() => {
        navigate(createPageUrl('Messages'));
      }, 2000);
    } catch (error) {
      console.error("Error drafting message:", error);
      toast.error("Failed to draft message");
    }
  };

  const handleDismiss = (suggestion) => {
    setSuggestions(prev => prev.filter(s => s !== suggestion));
    toast.info("Suggestion dismissed");
  };

  const getPriorityColor = (priority) => {
    const colors = {
      critical: "bg-red-100 text-red-700 border-red-300",
      high: "bg-orange-100 text-orange-700 border-orange-300",
      medium: "bg-yellow-100 text-yellow-700 border-yellow-300",
      low: "bg-blue-100 text-blue-700 border-blue-300"
    };
    return colors[priority] || colors.medium;
  };

  const getSuggestionIcon = (type) => {
    if (type === 'meeting') return CalendarPlus;
    if (type === 'task') return ListTodo;
    if (type === 'message') return MessageSquare;
    return Target;
  };

  if (isLoading) {
    return (
      <div className="page-container">
        <div className="flex items-center justify-center min-h-[400px]">
          <RefreshCw className="w-8 h-8 animate-spin text-indigo-600" />
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Header */}
        <Card className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <Brain className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h1 className="text-2xl font-bold mb-1">Jackie's Follow-up Assistant</h1>
                  <p className="text-white/90 text-sm">
                    Proactive suggestions based on {conversations.length} conversations & {learnings.length} learned preferences
                  </p>
                </div>
              </div>
              <Button
                onClick={() => generateSuggestions()}
                disabled={isGenerating}
                className="bg-white text-purple-600 hover:bg-white/90"
              >
                {isGenerating ? (
                  <>
                    <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                    Analyzing...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-4 h-4 mr-2" />
                    Refresh Suggestions
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardContent className="p-4 text-center">
              <Target className="w-8 h-8 mx-auto mb-2 text-purple-600" />
              <p className="text-2xl font-bold">{suggestions.length}</p>
              <p className="text-xs text-slate-600">Active Suggestions</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <MessageSquare className="w-8 h-8 mx-auto mb-2 text-indigo-600" />
              <p className="text-2xl font-bold">{conversations.filter(c => c.outcome === 'completed').length}</p>
              <p className="text-xs text-slate-600">Analyzed Conversations</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <Brain className="w-8 h-8 mx-auto mb-2 text-blue-600" />
              <p className="text-2xl font-bold">{learnings.length}</p>
              <p className="text-xs text-slate-600">Learned Preferences</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <AlertCircle className="w-8 h-8 mx-auto mb-2 text-amber-600" />
              <p className="text-2xl font-bold">{pendingActions.length}</p>
              <p className="text-xs text-slate-600">Pending Actions</p>
            </CardContent>
          </Card>
        </div>

        {/* Main Content */}
        <Tabs defaultValue="suggestions" className="w-full">
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="suggestions">
              <Target className="w-4 h-4 mr-2" />
              Follow-up Suggestions ({suggestions.length})
            </TabsTrigger>
            <TabsTrigger value="pending">
              <Clock className="w-4 h-4 mr-2" />
              Pending Actions ({pendingActions.length})
            </TabsTrigger>
          </TabsList>

          <TabsContent value="suggestions" className="space-y-4 mt-6">
            {suggestions.length > 0 ? (
              suggestions.map((suggestion, idx) => {
                const Icon = getSuggestionIcon(suggestion.suggestion_type);
                const relatedConvo = conversations.find(c => c.id === suggestion.related_conversation_id);

                return (
                  <Card key={idx} className="border-l-4 border-l-purple-500 hover:shadow-lg transition-shadow">
                    <CardContent className="p-6">
                      <div className="flex items-start gap-4">
                        <div className={`p-3 rounded-lg ${getPriorityColor(suggestion.priority)}`}>
                          <Icon className="w-6 h-6" />
                        </div>

                        <div className="flex-1">
                          <div className="flex items-start justify-between mb-2">
                            <div>
                              <h3 className="font-bold text-lg text-slate-900">{suggestion.title}</h3>
                              <div className="flex items-center gap-2 mt-1">
                                <Badge className={getPriorityColor(suggestion.priority)}>
                                  {suggestion.priority} priority
                                </Badge>
                                <Badge variant="outline" className="capitalize">
                                  {suggestion.suggestion_type}
                                </Badge>
                                {suggestion.suggested_date && (
                                  <Badge variant="outline">
                                    <Clock className="w-3 h-3 mr-1" />
                                    {format(parseISO(suggestion.suggested_date), 'MMM d')}
                                  </Badge>
                                )}
                              </div>
                            </div>
                          </div>

                          <p className="text-sm text-slate-600 mb-3">
                            {suggestion.description}
                          </p>

                          {suggestion.suggested_action && (
                            <div className="bg-indigo-50 p-3 rounded-lg mb-3">
                              <p className="text-sm font-semibold text-indigo-900 mb-1">
                                Suggested Action:
                              </p>
                              <p className="text-sm text-indigo-700">
                                {suggestion.suggested_action}
                              </p>
                            </div>
                          )}

                          {suggestion.context && (
                            <div className="bg-slate-50 p-3 rounded-lg mb-3">
                              <p className="text-xs font-semibold text-slate-700 mb-1">Context:</p>
                              <p className="text-xs text-slate-600">{suggestion.context}</p>
                            </div>
                          )}

                          {relatedConvo && (
                            <div className="text-xs text-slate-500 mb-3">
                              Related to conversation on {format(parseISO(relatedConvo.created_date), 'MMM d, yyyy')}
                            </div>
                          )}

                          <div className="flex gap-2">
                            {suggestion.suggestion_type === 'meeting' && (
                              <Button
                                size="sm"
                                onClick={() => handleCreateMeeting(suggestion)}
                                className="bg-green-600 hover:bg-green-700"
                              >
                                <CalendarPlus className="w-4 h-4 mr-1" />
                                Create Meeting
                              </Button>
                            )}

                            {suggestion.suggestion_type === 'task' && (
                              <Button
                                size="sm"
                                onClick={() => handleCreateTask(suggestion)}
                                className="bg-blue-600 hover:bg-blue-700"
                              >
                                <ListTodo className="w-4 h-4 mr-1" />
                                Create Task
                              </Button>
                            )}

                            {suggestion.suggestion_type === 'message' && (
                              <Button
                                size="sm"
                                onClick={() => handleDraftMessage(suggestion)}
                                className="bg-indigo-600 hover:bg-indigo-700"
                              >
                                <Send className="w-4 h-4 mr-1" />
                                Draft Message
                              </Button>
                            )}

                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => handleDismiss(suggestion)}
                            >
                              <X className="w-4 h-4 mr-1" />
                              Dismiss
                            </Button>
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                );
              })
            ) : (
              <Card>
                <CardContent className="p-12 text-center">
                  <Target className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                  <h3 className="text-xl font-semibold text-slate-900 mb-2">
                    No Suggestions Yet
                  </h3>
                  <p className="text-slate-600 mb-6">
                    {conversations.length === 0 
                      ? "Start using Jackie AI to create conversations, and I'll analyze them for follow-up opportunities!"
                      : "Click 'Refresh Suggestions' to analyze your recent conversations."}
                  </p>
                  {conversations.length > 0 && (
                    <Button
                      onClick={() => generateSuggestions()}
                      disabled={isGenerating}
                      className="bg-purple-600 hover:bg-purple-700"
                    >
                      <Sparkles className="w-4 h-4 mr-2" />
                      Analyze Conversations
                    </Button>
                  )}
                </CardContent>
              </Card>
            )}
          </TabsContent>

          <TabsContent value="pending" className="space-y-4 mt-6">
            {pendingActions.length > 0 ? (
              pendingActions.map((action, idx) => (
                <Card key={idx} className="border-l-4 border-l-amber-500">
                  <CardContent className="p-4">
                    <div className="flex items-start justify-between">
                      <div className="flex items-start gap-3">
                        <AlertCircle className={`w-5 h-5 mt-1 ${
                          action.priority === 'high' ? 'text-red-600' : 
                          action.priority === 'medium' ? 'text-amber-600' : 
                          'text-blue-600'
                        }`} />
                        <div>
                          <p className="font-semibold text-slate-900">{action.action}</p>
                          {action.deadline && (
                            <p className="text-sm text-slate-600 mt-1">
                              <Clock className="w-3 h-3 inline mr-1" />
                              Deadline: {format(parseISO(action.deadline), 'MMM d, yyyy')}
                            </p>
                          )}
                        </div>
                      </div>
                      <Badge className={getPriorityColor(action.priority)}>
                        {action.priority}
                      </Badge>
                    </div>
                  </CardContent>
                </Card>
              ))
            ) : (
              <Card>
                <CardContent className="p-12 text-center">
                  <CheckSquare className="w-16 h-16 mx-auto mb-4 text-green-300" />
                  <h3 className="text-xl font-semibold text-slate-900 mb-2">
                    All Caught Up!
                  </h3>
                  <p className="text-slate-600">
                    No pending actions identified from your conversations.
                  </p>
                </CardContent>
              </Card>
            )}
          </TabsContent>
        </Tabs>

        {/* Learned Preferences Summary */}
        {learnings.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Brain className="w-5 h-5 text-purple-600" />
                Learned Preferences Being Used
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {learnings.slice(0, 6).map((learning, idx) => (
                  <div key={idx} className="bg-slate-50 p-3 rounded-lg">
                    <p className="text-xs font-semibold text-slate-700 mb-1 capitalize">
                      {learning.key.replace(/_/g, ' ')}:
                    </p>
                    <p className="text-sm text-slate-900">{learning.value}</p>
                    <div className="flex items-center gap-2 mt-2">
                      <div className="flex-1 bg-slate-200 rounded-full h-1.5">
                        <div 
                          className="bg-purple-600 h-1.5 rounded-full" 
                          style={{ width: `${learning.confidence}%` }}
                        />
                      </div>
                      <span className="text-xs text-slate-500">{learning.confidence}%</span>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}
import React, { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import JackieVoiceInterface from '../components/jackie/JackieVoiceInterface';
import {
    MessageSquare, Zap, TestTube, AlertCircle, CheckCircle,
    TrendingUp, Mic, FileText, Settings, Info
} from 'lucide-react';

export default function JackieVoiceAssistant() {
    const [activeTab, setActiveTab] = useState('chat');

    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me()
    });

    const capabilities = [
        {
            icon: FileText,
            title: 'Property Valuation',
            description: 'Instant CMA reports with automatic office saving',
            examples: [
                '"What\'s 742 Evergreen worth?"',
                '"Get me a valuation on this house"',
                '"How much did 101 Main St sell for?"'
            ]
        },
        {
            icon: CheckCircle,
            title: 'Task Creation',
            description: 'Voice-activated task scheduling and reminders',
            examples: [
                '"Add a task to call the seller tomorrow"',
                '"Remind me to follow up with Sarah"',
                '"Schedule a showing for next Tuesday"'
            ]
        },
        {
            icon: MessageSquare,
            title: 'Contextual Notes',
            description: 'GPS-aware note taking during showings',
            examples: [
                '"Save a note: roof looks brand new"',
                '"Add to showing notes: needs paint"',
                '"Mark this as a hot lead"'
            ]
        },
        {
            icon: TrendingUp,
            title: 'Market Intelligence',
            description: 'Real-time market data and comparables',
            examples: [
                '"Show me comparable sales nearby"',
                '"What\'s the school rating here?"',
                '"Get market trends for this area"'
            ]
        }
    ];

    const testScenarios = [
        {
            title: 'Acoustic Stress Test',
            description: 'Tests Jackie\'s ability to parse commands in noisy environments',
            tests: [
                { name: 'Commute (40mph wind)', status: 'pending', wer: null },
                { name: 'Car Radio (30% volume)', status: 'pending', wer: null },
                { name: 'GPS Interruption', status: 'pending', wer: null },
                { name: 'Multi-tasking', status: 'pending', wer: null }
            ]
        },
        {
            title: 'Contextual Accuracy',
            description: 'Tests GPS integration and automatic address detection',
            tests: [
                { name: 'GPS Location Lookup', status: 'pending', accuracy: null },
                { name: 'Address Extraction', status: 'pending', accuracy: null },
                { name: 'Showing Context', status: 'pending', accuracy: null },
                { name: 'Late Notification', status: 'pending', accuracy: null }
            ]
        },
        {
            title: 'Ambiguity Test',
            description: 'Tests NLP robustness with fragmented speech',
            tests: [
                { name: 'Filler Words (uh, um)', status: 'pending', parsed: null },
                { name: 'Interrupted Commands', status: 'pending', parsed: null },
                { name: 'Multi-part Requests', status: 'pending', parsed: null },
                { name: 'Implicit References', status: 'pending', parsed: null }
            ]
        }
    ];

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950 p-6">
            <div className="max-w-7xl mx-auto">
                {/* Header */}
                <div className="mb-8">
                    <div className="flex items-center justify-between mb-2">
                        <h1 className="text-4xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                            <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                                <Mic className="w-6 h-6 text-white" />
                            </div>
                            Jackie Voice Assistant
                        </h1>
                        <Badge variant="outline" className="text-sm">
                            Beta - Text Mode
                        </Badge>
                    </div>
                    <p className="text-slate-600 dark:text-slate-400">
                        Your AI executive assistant - Voice interface coming soon
                    </p>
                </div>

                {/* Info Banner */}
                <Card className="mb-6 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800">
                    <CardContent className="p-4 flex items-start gap-3">
                        <Info className="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                        <div className="text-sm text-blue-900 dark:text-blue-200">
                            <p className="font-semibold mb-1">Text-Based Demo Active</p>
                            <p>This is the full backend logic for Jackie's voice assistant. All property valuations, CMA reports, task creation, and office saving features are fully functional. Voice input/output will be connected via external services (Deepgram + ElevenLabs) in production.</p>
                        </div>
                    </CardContent>
                </Card>

                {/* Main Content */}
                <Tabs value={activeTab} onValueChange={setActiveTab}>
                    <TabsList className="grid grid-cols-3 w-full max-w-md">
                        <TabsTrigger value="chat">
                            <MessageSquare className="w-4 h-4 mr-2" />
                            Chat
                        </TabsTrigger>
                        <TabsTrigger value="capabilities">
                            <Zap className="w-4 h-4 mr-2" />
                            Capabilities
                        </TabsTrigger>
                        <TabsTrigger value="testing">
                            <TestTube className="w-4 h-4 mr-2" />
                            Testing
                        </TabsTrigger>
                    </TabsList>

                    {/* Chat Interface */}
                    <TabsContent value="chat" className="mt-6">
                        <Card className="h-[700px]">
                            <JackieVoiceInterface user={user} testMode={true} />
                        </Card>
                    </TabsContent>

                    {/* Capabilities */}
                    <TabsContent value="capabilities" className="mt-6">
                        <div className="grid md:grid-cols-2 gap-6">
                            {capabilities.map((capability, idx) => (
                                <Card key={idx} className="hover:shadow-lg transition-shadow">
                                    <CardContent className="p-6">
                                        <div className="flex items-start gap-4">
                                            <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center flex-shrink-0">
                                                <capability.icon className="w-6 h-6 text-white" />
                                            </div>
                                            <div className="flex-1">
                                                <h3 className="font-bold text-lg text-slate-900 dark:text-white mb-2">
                                                    {capability.title}
                                                </h3>
                                                <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                                                    {capability.description}
                                                </p>
                                                <div className="space-y-2">
                                                    <p className="text-xs font-semibold text-slate-700 dark:text-slate-300">
                                                        Example Commands:
                                                    </p>
                                                    {capability.examples.map((example, exIdx) => (
                                                        <div
                                                            key={exIdx}
                                                            className="text-sm bg-slate-50 dark:bg-slate-800 p-2 rounded-lg text-slate-600 dark:text-slate-300"
                                                        >
                                                            {example}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </CardContent>
                                </Card>
                            ))}
                        </div>
                    </TabsContent>

                    {/* Testing Framework */}
                    <TabsContent value="testing" className="mt-6">
                        <div className="space-y-6">
                            <Card className="bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800">
                                <CardContent className="p-6">
                                    <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
                                        <TestTube className="w-5 h-5" />
                                        Developer Testing Framework
                                    </h3>
                                    <p className="text-sm text-slate-700 dark:text-slate-300 mb-4">
                                        Use the chat interface with "Test Panel" enabled to run acoustic stress tests, 
                                        contextual accuracy scenarios, and ambiguity tests. All backend logic is production-ready.
                                    </p>
                                    <Button onClick={() => setActiveTab('chat')}>
                                        <Zap className="w-4 h-4 mr-2" />
                                        Open Test Panel
                                    </Button>
                                </CardContent>
                            </Card>

                            {testScenarios.map((scenario, idx) => (
                                <Card key={idx}>
                                    <CardContent className="p-6">
                                        <h3 className="font-bold text-lg mb-2">{scenario.title}</h3>
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                                            {scenario.description}
                                        </p>
                                        <div className="space-y-2">
                                            {scenario.tests.map((test, testIdx) => (
                                                <div
                                                    key={testIdx}
                                                    className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg"
                                                >
                                                    <span className="text-sm font-medium">
                                                        {test.name}
                                                    </span>
                                                    <Badge variant="outline">
                                                        {test.status === 'passed' ? (
                                                            <CheckCircle className="w-3 h-3 mr-1 text-green-600" />
                                                        ) : test.status === 'failed' ? (
                                                            <AlertCircle className="w-3 h-3 mr-1 text-red-600" />
                                                        ) : null}
                                                        {test.status.toUpperCase()}
                                                    </Badge>
                                                </div>
                                            ))}
                                        </div>
                                    </CardContent>
                                </Card>
                            ))}
                        </div>
                    </TabsContent>
                </Tabs>
            </div>
        </div>
    );
}
import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { 
    Search, 
    Loader2, 
    BookOpen, 
    ThumbsUp, 
    Eye, 
    Sparkles,
    FileText,
    HelpCircle,
    TrendingUp
} from 'lucide-react';
import { toast } from 'sonner';
import ReactMarkdown from 'react-markdown';
import { motion, AnimatePresence } from 'framer-motion';

const CATEGORIES = [
    { value: 'all', label: 'All Topics', icon: BookOpen },
    { value: 'getting_started', label: 'Getting Started', icon: Sparkles },
    { value: 'properties', label: 'Properties', icon: FileText },
    { value: 'leads', label: 'Leads & CRM', icon: TrendingUp },
    { value: 'ai_tools', label: 'AI Tools', icon: Sparkles },
    { value: 'troubleshooting', label: 'Troubleshooting', icon: HelpCircle },
];

export default function KnowledgeBase() {
    const [searchQuery, setSearchQuery] = useState('');
    const [isSearching, setIsSearching] = useState(false);
    const [aiResults, setAiResults] = useState([]);
    const [selectedCategory, setSelectedCategory] = useState('all');
    const queryClient = useQueryClient();

    const { data: articles = [], isLoading } = useQuery({
        queryKey: ['knowledgeBase'],
        queryFn: () => base44.entities.KnowledgeBase.list(),
    });

    const incrementViewMutation = useMutation({
        mutationFn: ({ id, currentCount }) => 
            base44.entities.KnowledgeBase.update(id, { view_count: (currentCount || 0) + 1 }),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['knowledgeBase'] });
        }
    });

    const markHelpfulMutation = useMutation({
        mutationFn: ({ id, currentCount }) => 
            base44.entities.KnowledgeBase.update(id, { helpful_count: (currentCount || 0) + 1 }),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['knowledgeBase'] });
            toast.success('Thank you for your feedback!');
        }
    });

    const handleAISearch = async () => {
        if (!searchQuery.trim()) {
            toast.error('Please enter a question');
            return;
        }

        setIsSearching(true);
        setAiResults([]);

        try {
            // Prepare context from all articles
            const context = articles
                .filter(a => a.is_published)
                .map(a => `Title: ${a.title}\nCategory: ${a.category}\nContent: ${a.content}\n---`)
                .join('\n\n');

            const response = await base44.integrations.Core.InvokeLLM({
                prompt: `You are a helpful assistant for RealtyMind, a real estate CRM platform. 
                
User Question: "${searchQuery}"

Available Knowledge Base Articles:
${context}

Based on the user's question and the knowledge base articles above, provide:
1. A clear, helpful answer to their question
2. List the most relevant article titles that address their question
3. If the question cannot be fully answered from the knowledge base, provide general guidance

Format your response in a friendly, professional tone.`,
                response_json_schema: {
                    type: "object",
                    properties: {
                        answer: { 
                            type: "string", 
                            description: "A detailed answer to the user's question" 
                        },
                        relevant_articles: { 
                            type: "array",
                            items: { type: "string" },
                            description: "List of relevant article titles"
                        },
                        confidence: {
                            type: "string",
                            enum: ["high", "medium", "low"],
                            description: "Confidence level in the answer"
                        }
                    },
                    required: ["answer", "relevant_articles", "confidence"]
                }
            });

            setAiResults([{
                query: searchQuery,
                response: response,
                timestamp: new Date()
            }]);

            // Find and increment view count for relevant articles
            response.relevant_articles.forEach(title => {
                const article = articles.find(a => 
                    a.title.toLowerCase().includes(title.toLowerCase()) ||
                    title.toLowerCase().includes(a.title.toLowerCase())
                );
                if (article) {
                    incrementViewMutation.mutate({ 
                        id: article.id, 
                        currentCount: article.view_count 
                    });
                }
            });

        } catch (error) {
            console.error('AI Search error:', error);
            toast.error('Search failed. Please try again.');
        } finally {
            setIsSearching(false);
        }
    };

    const handleKeyPress = (e) => {
        if (e.key === 'Enter') {
            handleAISearch();
        }
    };

    const filteredArticles = selectedCategory === 'all' 
        ? articles.filter(a => a.is_published)
        : articles.filter(a => a.is_published && a.category === selectedCategory);

    const popularArticles = [...articles]
        .filter(a => a.is_published)
        .sort((a, b) => (b.view_count || 0) - (a.view_count || 0))
        .slice(0, 5);

    const getConfidenceBadge = (confidence) => {
        const colors = {
            high: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
            medium: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
            low: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300'
        };
        return colors[confidence] || colors.medium;
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-6">
            <div className="max-w-7xl mx-auto space-y-6">
                {/* Header */}
                <div className="text-center mb-8">
                    <div className="inline-flex items-center gap-3 mb-4">
                        <div className="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center">
                            <BookOpen className="w-8 h-8 text-white" />
                        </div>
                    </div>
                    <h1 className="text-4xl font-bold text-slate-900 dark:text-white mb-2">
                        AI Knowledge Base
                    </h1>
                    <p className="text-slate-600 dark:text-slate-400 text-lg">
                        Ask anything about RealtyMind in natural language
                    </p>
                </div>

                {/* AI Search Box */}
                <Card className="shadow-xl border-2 border-indigo-100 dark:border-indigo-900">
                    <CardContent className="p-6">
                        <div className="flex gap-3">
                            <div className="relative flex-1">
                                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" />
                                <Input
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    placeholder="Ask me anything... e.g., 'How do I add a new property?' or 'What are the AI tools available?'"
                                    className="pl-10 py-6 text-lg"
                                    disabled={isSearching}
                                />
                            </div>
                            <Button
                                onClick={handleAISearch}
                                disabled={isSearching || !searchQuery.trim()}
                                className="px-8 py-6 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                            >
                                {isSearching ? (
                                    <>
                                        <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                        Searching...
                                    </>
                                ) : (
                                    <>
                                        <Sparkles className="w-5 h-5 mr-2" />
                                        Ask AI
                                    </>
                                )}
                            </Button>
                        </div>
                        <p className="text-xs text-slate-500 mt-2">
                            üí° Powered by advanced AI - ask complex questions in your own words
                        </p>
                    </CardContent>
                </Card>

                {/* AI Results */}
                <AnimatePresence>
                    {aiResults.length > 0 && (
                        <motion.div
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, y: -20 }}
                        >
                            <Card className="shadow-lg border-l-4 border-l-indigo-500">
                                <CardHeader>
                                    <div className="flex items-center justify-between">
                                        <CardTitle className="flex items-center gap-2">
                                            <Sparkles className="w-5 h-5 text-indigo-600" />
                                            AI Answer
                                        </CardTitle>
                                        <Badge className={getConfidenceBadge(aiResults[0].response.confidence)}>
                                            {aiResults[0].response.confidence} confidence
                                        </Badge>
                                    </div>
                                </CardHeader>
                                <CardContent className="space-y-4">
                                    <div className="prose prose-slate dark:prose-invert max-w-none">
                                        <ReactMarkdown>{aiResults[0].response.answer}</ReactMarkdown>
                                    </div>

                                    {aiResults[0].response.relevant_articles.length > 0 && (
                                        <div className="border-t border-slate-200 dark:border-slate-700 pt-4">
                                            <h4 className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
                                                Related Articles:
                                            </h4>
                                            <div className="flex flex-wrap gap-2">
                                                {aiResults[0].response.relevant_articles.map((title, idx) => (
                                                    <Badge key={idx} variant="outline" className="text-xs">
                                                        <FileText className="w-3 h-3 mr-1" />
                                                        {title}
                                                    </Badge>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </CardContent>
                            </Card>
                        </motion.div>
                    )}
                </AnimatePresence>

                {/* Category Filter */}
                <div className="flex flex-wrap gap-2">
                    {CATEGORIES.map(cat => {
                        const Icon = cat.icon;
                        return (
                            <Button
                                key={cat.value}
                                variant={selectedCategory === cat.value ? "default" : "outline"}
                                onClick={() => setSelectedCategory(cat.value)}
                                className="gap-2"
                            >
                                <Icon className="w-4 h-4" />
                                {cat.label}
                            </Button>
                        );
                    })}
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* Main Content - Articles */}
                    <div className="lg:col-span-2 space-y-4">
                        <h2 className="text-2xl font-bold text-slate-900 dark:text-white">
                            {selectedCategory === 'all' ? 'All Articles' : CATEGORIES.find(c => c.value === selectedCategory)?.label}
                        </h2>

                        {isLoading ? (
                            <div className="flex justify-center py-12">
                                <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
                            </div>
                        ) : filteredArticles.length === 0 ? (
                            <Card>
                                <CardContent className="py-12 text-center">
                                    <BookOpen className="w-12 h-12 text-slate-400 mx-auto mb-4" />
                                    <p className="text-slate-600 dark:text-slate-400">
                                        No articles found in this category
                                    </p>
                                </CardContent>
                            </Card>
                        ) : (
                            filteredArticles.map(article => (
                                <Card key={article.id} className="hover:shadow-lg transition-shadow">
                                    <CardHeader>
                                        <div className="flex items-start justify-between">
                                            <div className="flex-1">
                                                <CardTitle className="text-xl mb-2">{article.title}</CardTitle>
                                                <div className="flex flex-wrap gap-2">
                                                    <Badge variant="outline">{article.category.replace('_', ' ')}</Badge>
                                                    {article.is_faq && (
                                                        <Badge className="bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                                                            FAQ
                                                        </Badge>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div className="prose prose-sm prose-slate dark:prose-invert max-w-none">
                                            <ReactMarkdown>
                                                {article.content.length > 300 
                                                    ? article.content.substring(0, 300) + '...' 
                                                    : article.content}
                                            </ReactMarkdown>
                                        </div>

                                        <div className="flex items-center justify-between pt-3 border-t border-slate-200 dark:border-slate-700">
                                            <div className="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400">
                                                <span className="flex items-center gap-1">
                                                    <Eye className="w-4 h-4" />
                                                    {article.view_count || 0}
                                                </span>
                                                <span className="flex items-center gap-1">
                                                    <ThumbsUp className="w-4 h-4" />
                                                    {article.helpful_count || 0}
                                                </span>
                                            </div>
                                            <Button
                                                variant="ghost"
                                                size="sm"
                                                onClick={() => markHelpfulMutation.mutate({ 
                                                    id: article.id, 
                                                    currentCount: article.helpful_count 
                                                })}
                                            >
                                                <ThumbsUp className="w-4 h-4 mr-1" />
                                                Helpful
                                            </Button>
                                        </div>
                                    </CardContent>
                                </Card>
                            ))
                        )}
                    </div>

                    {/* Sidebar - Popular Articles */}
                    <div className="space-y-4">
                        <Card>
                            <CardHeader>
                                <CardTitle className="text-lg flex items-center gap-2">
                                    <TrendingUp className="w-5 h-5 text-indigo-600" />
                                    Popular Articles
                                </CardTitle>
                            </CardHeader>
                            <CardContent className="space-y-3">
                                {popularArticles.map((article, idx) => (
                                    <div 
                                        key={article.id}
                                        className="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer"
                                    >
                                        <div className="flex-shrink-0 w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center text-xs font-bold text-indigo-600">
                                            {idx + 1}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <h4 className="text-sm font-medium text-slate-900 dark:text-white line-clamp-2">
                                                {article.title}
                                            </h4>
                                            <p className="text-xs text-slate-500 mt-1">
                                                {article.view_count || 0} views
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </CardContent>
                        </Card>

                        <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-950 dark:to-purple-950 border-indigo-200 dark:border-indigo-800">
                            <CardContent className="p-6 text-center">
                                <HelpCircle className="w-12 h-12 text-indigo-600 mx-auto mb-3" />
                                <h3 className="font-semibold text-slate-900 dark:text-white mb-2">
                                    Can't find what you need?
                                </h3>
                                <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                                    Try asking Jackie AI for personalized help
                                </p>
                                <Button 
                                    className="w-full bg-gradient-to-r from-indigo-600 to-purple-600"
                                    onClick={() => window.dispatchEvent(new CustomEvent('openJackie'))}
                                >
                                    <Sparkles className="w-4 h-4 mr-2" />
                                    Ask Jackie
                                </Button>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            </div>
        </div>
    );
}

import 'leaflet/dist/leaflet.css';
import React, { useState, useEffect, useMemo, useRef } from "react";
import { Link, useLocation, useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { base44 } from "@/api/base44Client";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';
import AIAssistant from "./components/dashboard/AIAssistant";
import JackieWelcomeModal from "./components/dashboard/JackieWelcomeModal";
import NextEventBanner from "./components/dashboard/NextEventBanner";
import WeatherBanner from "./components/dashboard/WeatherBanner";
import AgentProfileSetup from "./components/settings/AgentProfileSetup";
import BreakReminder from "./components/common/BreakReminder";
import GlobalSearch from './components/common/GlobalSearch';
import NPSWidget from "./components/common/NPSWidget";
import ScrollToTop from "./components/common/ScrollToTop";
import OnboardingTour from "./components/onboarding/OnboardingTour";
import RealTimeNotifications from "./components/common/RealTimeNotifications";
import TaskDueNotification from "./components/common/TaskDueNotification";

      import { WorkflowProvider } from "./components/common/WorkflowProvider";
import {
  Home,
  Building2,
  Users,
  CheckSquare,
  MessageSquare,
  Camera,
  FileText,
  Briefcase,
  Calendar,
  TrendingUp,
  Phone,
  Target,
  Menu,
  X,
  Crown,
  ChevronRight,
  Bell,
  DollarSign,
  Share2,
  Settings,
  Sparkles,
  Mail,
  Heart,
  Lightbulb,
  Moon,
  Sun,
  Palette,
  Database,
  RefreshCw,
  MapPin,
  Brain,
  ArrowLeft,
  LogOut,
  Newspaper,
  Globe,
  GripVertical,
  AlertTriangle,
  HardDrive,
  BrainCircuit,
  LayoutGrid,
  FileCheck2,
  UserSquare,
  ListChecks,
  Car,
  DoorOpen,
  BarChart3,
  Megaphone,
  Folder,
  Contact,
  Beaker,
  ClipboardList,
  BarChart,
  HeartPulse,
  Shield,
  LayoutDashboard,
  UserCheck,
  Users2,
  Eye,
  Plane,
  Workflow,
  Upload,
  BookOpen } from
"lucide-react";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger } from
"@/components/ui/dropdown-menu";

const MENU_THEMES = {
  default: {
    light: { bg: 'linear-gradient(180deg, #ffffff 0%, #f8fafc 100%)', solidBg: '#f8fafc', text: '#475569', border: '#e2e8f0' },
    dark: { bg: 'linear-gradient(180deg, #1a1d2e 0%, #0f1117 100%)', solidBg: '#0f1117', text: '#cbd5e1', border: '#334155' }
  },
  graphite: {
    light: { bg: 'linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%)', solidBg: '#f3f4f6', text: '#374151', border: '#e5e7eb' },
    dark: { bg: 'linear-gradient(180deg, #1f2937 0%, #111827 100%)', solidBg: '#111827', text: '#e5e7eb', border: '#374151' }
  },
  azure: {
    light: { bg: 'linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%)', solidBg: '#e0f2fe', text: '#0c4a6e', border: '#bae6fd' },
    dark: { bg: 'linear-gradient(180deg, #0c4a6e 0%, #082f49 100%)', solidBg: '#082f49', text: '#e0f2fe', border: '#0369a1' }
  },
  sandstone: {
    light: { bg: 'linear-gradient(180deg, #fffbeb 0%, #fef3c7 100%)', solidBg: '#fef3c7', text: '#78350f', border: '#fde68a' },
    dark: { bg: 'linear-gradient(180deg, #78350f 0%, #451a03 100%)', solidBg: '#451a03', text: '#fef3c7', border: '#92400e' }
  },
  evergreen: {
    light: { bg: 'linear-gradient(180deg, #f0fdf4 0%, #dcfce7 100%)', solidBg: '#dcfce7', text: '#14532d', border: '#bbf7d0' },
    dark: { bg: 'linear-gradient(180deg, #064e3b 0%, #052e16 100%)', solidBg: '#052e16', text: '#dcfce7', border: '#059669' }
  }
};

const colorThemes = {
  default: {
    primary: '#4F46E5',
    secondary: '#7C3AED',
    accent: '#06B6D4',
    neutral: '#64748B',
    gradient: 'from-indigo-600 to-purple-700',
    gradientCSS: 'linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%)'
  },
  aesthetic: {
    primary: '#373D3B',
    secondary: '#A08F88',
    accent: '#C1B8B1',
    neutral: '#EFEBEC',
    gradient: 'from-[#373D3B] to-[#A08F88]',
    gradientCSS: 'linear-gradient(135deg, #373D3B 0%, #A08F88 100%)'
  },
  masculine: {
    primary: '#1E293B',
    secondary: '#334155',
    accent: '#0EA5E9',
    neutral: '#475569',
    gradient: 'from-slate-800 to-slate-900',
    gradientCSS: 'linear-gradient(135deg, #1E293B 0%, #0f172a 100%)'
  },
  feminine: {
    primary: '#EC4899',
    secondary: '#F472B6',
    accent: '#A78BFA',
    neutral: '#F3E8FF',
    gradient: 'from-pink-600 to-pink-700',
    gradientCSS: 'linear-gradient(135deg, #EC4899 0%, #DB2777 100%)'
  },
  royal: {
    primary: '#7C3AED',
    secondary: '#A855F7',
    accent: '#FBBF24',
    neutral: '#DDD6FE',
    gradient: 'from-purple-600 to-violet-700',
    gradientCSS: 'linear-gradient(135deg, #7C3AED 0%, #6d28d9 100%)'
  },
  emerald: {
    primary: '#059669',
    secondary: '#10B981',
    accent: '#34D399',
    neutral: '#D1FAE5',
    gradient: 'from-emerald-600 to-green-700',
    gradientCSS: 'linear-gradient(135deg, #059669 0%, #15803d 100%)'
  },
  gold: {
    primary: '#D97706',
    secondary: '#F59E0B',
    accent: '#FBBF24',
    neutral: '#FEF3C7',
    gradient: 'from-amber-600 to-orange-700',
    gradientCSS: 'linear-gradient(135deg, #D97706 0%, #ea580c 100%)'
  }
};

function LayoutContent({ children, currentPageName }) {
  // --- All hooks must be called unconditionally at the top level ---
  const location = useLocation();
  const navigate = useNavigate();
  const queryClient = useQueryClient(); // Call useQueryClient unconditionally
  const mainContentRef = useRef(null);
  const sidebarScrollRef = useRef(null);

  // QueryClient is always ready when we get here
  const isQueryClientReady = true;

  // Query hooks with AGGRESSIVE caching to avoid rate limits
  const { data: user, isLoading: isUserLoading, error: userError } = useQuery({
    queryKey: ["user"],
    queryFn: async () => {
      try {
        return await base44.auth.me();
      } catch (error) {
        console.error("Error loading user:", error);
        return null;
      }
    },
    retry: 1,
    staleTime: 30 * 60 * 1000, // 30 minutes
    cacheTime: 60 * 60 * 1000, // 1 hour
    enabled: isQueryClientReady,
    refetchOnWindowFocus: false,
    refetchOnMount: false,
    refetchOnReconnect: false
  });

  // State hooks
  const [sidebarOpen, setSidebarOpen] = useState(false);
  // Renamed from openCategories to openSections to match new structure
  const [openSections, setOpenSections] = useState(
    new Set(JSON.parse(localStorage.getItem('openSections') || '[]'))
  );
  const [navItems, setNavItems] = useState([]);
  const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
  const [colorTheme, setColorTheme] = useState('default');
  const [menuTheme, setMenuTheme] = useState(localStorage.getItem('menuTheme') || 'default');
  const [counts, setCounts] = useState({
    tasks: 0,
    overdueTasks: 0,
    todayTasks: 0,
    notifications: 0,
    hotLeads: 0,
    todayEvents: 0,
    inactiveMembersCount: 0,
    teamSurveys: 0,
    newsArticles: 0,
    sphereContacts: 0,
    taskPackages: 0,
    pendingTasksCount: 0,
    activeLeadsCount: 0,
    activeBuyersCount: 0,
    upcomingEventsCount: 0,
    unreadMessagesCount: 0,
    contactsCount: 0,
    activeTransactionsCount: 0,
    upcomingOpenHousesCount: 0,
    upcomingShowingsCount: 0,
    activePropertiesCount: 0
  });
  const [showProfileSetup, setShowProfileSetup] = useState(false);
  const [currentLocation, setCurrentLocation] = useState(null);

  // Initialize color theme from user data
  useEffect(() => {
    if (user?.theme_preference) {
      setColorTheme(user.theme_preference);
    } else {
      const savedTheme = localStorage.getItem('colorTheme') || 'default';
      setColorTheme(savedTheme);
    }

    // Redirect clients to their dashboard
    if (user?.role === 'client' && location.pathname !== createPageUrl('ClientDashboard') && location.pathname !== createPageUrl('ClientTransactionDetail')) {
      navigate(createPageUrl('ClientDashboard'));
    }
  }, [user, location.pathname, navigate]);

  // Track user ID for session management
  useEffect(() => {
    if (!user?.id) return;
    sessionStorage.setItem('lastUserId', user.id);
  }, [user?.id]);

  // Apply sharp corners setting
  useEffect(() => {
    if (user?.sharp_corners !== undefined) {
      const root = document.documentElement;
      if (user.sharp_corners) {
        root.classList.add('sharp-corners');
      } else {
        root.classList.remove('sharp-corners');
      }
      localStorage.setItem('sharpCorners', user.sharp_corners);
    }
  }, [user]);

  useEffect(() => {
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setCurrentLocation({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
        },
        (error) => {
          if (error.code !== error.PERMISSION_DENIED) {
            console.log('Geolocation unavailable:', error.message);
          }
        },
        {
          enableHighAccuracy: false,
          timeout: 30000,
          maximumAge: 600000
        }
      );
    }
  }, []);

  // Weather feature disabled - can be re-enabled when API access is available
  const weatherData = null;

  // All data queries with AGGRESSIVE caching to prevent rate limits
  const LONG_STALE_TIME = 30 * 60 * 1000; // 30 minutes
  const LONG_CACHE_TIME = 60 * 60 * 1000; // 1 hour

  const { data: tasks = [] } = useQuery({
    queryKey: ['tasks', user?.id],
    queryFn: async () => {
      try {
        return await base44.entities.Task.filter({ assigned_to: user.id });
      } catch (error) {
        console.warn('Error fetching tasks, using cached data:', error.message);
        return [];
      }
    },
    enabled: !!user?.id && isQueryClientReady,
    staleTime: 60 * 60 * 1000,
    gcTime: 2 * 60 * 60 * 1000,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: notifications = [] } = useQuery({
    queryKey: ['notifications'],
    queryFn: async () => {
      try {
        return await base44.entities.Notification.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for notifications, using cached data');
        } else {
          console.error('Error fetching notifications:', error);
        }
        return [];
      }
    },
    enabled: !!user && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: leads = [] } = useQuery({
    queryKey: ['leads', user?.id],
    queryFn: async () => {
      try {
        const [owned, assigned, created] = await Promise.all([
          base44.entities.Lead.filter({ owner_id: user.id }).catch(() => []),
          base44.entities.Lead.filter({ assigned_agent_id: user.id }).catch(() => []),
          base44.entities.Lead.filter({ created_by: user.email }).catch(() => [])
        ]);
        const combined = [...owned, ...assigned, ...created];
        return Array.from(new Map(combined.map(item => [item.id, item])).values());
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for leads, using cached data');
        } else {
          console.error('Error fetching leads:', error);
        }
        return [];
      }
    },
    enabled: !!user?.id && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: openHouses = [] } = useQuery({
    queryKey: ['openHouses', user?.id],
    queryFn: async () => {
      try {
        return await base44.entities.OpenHouse.filter({ hosting_agent_id: user.id });
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for openHouses, using cached data');
        } else {
          console.error('Error fetching open houses:', error);
        }
        return [];
      }
    },
    enabled: !!user?.id && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: showings = [] } = useQuery({
    queryKey: ['showings', user?.id],
    queryFn: async () => {
      try {
        return await base44.entities.Showing.filter({ showing_agent_id: user.id });
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for showings, using cached data');
        } else {
          console.error('Error fetching showings:', error);
        }
        return [];
      }
    },
    enabled: !!user?.id && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: appointments = [] } = useQuery({
    queryKey: ['appointments', user?.id],
    queryFn: async () => {
      try {
        return await base44.entities.Appointment.filter({ agent_id: user.id });
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for appointments, using cached data');
        } else {
          console.error('Error fetching appointments:', error);
        }
        return [];
      }
    },
    enabled: !!user?.id && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: teamMembers = [] } = useQuery({
    queryKey: ['teamMembers'],
    queryFn: async () => {
      try {
        return await base44.entities.TeamMember.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for teamMembers, using cached data');
        } else {
          console.error('Error fetching team members:', error);
        }
        return [];
      }
    },
    enabled: !!user && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: teamSurveys = [] } = useQuery({
    queryKey: ["teamSurveys"],
    queryFn: async () => {
      try {
        return await base44.entities.TeamSurvey.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for teamSurveys, using cached data');
        } else {
          console.error('Error fetching team surveys:', error);
        }
        return [];
      }
    },
    enabled: !!user && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: taskPackages = [] } = useQuery({
    queryKey: ['taskPackages'],
    queryFn: async () => {
      try {
        return await base44.entities.TaskPackage.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for taskPackages, using cached data');
        } else {
          console.error('Error fetching task packages:', error);
        }
        return [];
      }
    },
    enabled: !!user && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: newsArticles = [] } = useQuery({
    queryKey: ["newsArticles"],
    queryFn: async () => {
      try {
        return await base44.entities.NewsArticle.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for newsArticles, using cached data');
        } else {
          console.error('Error fetching news articles:', error);
        }
        return [];
      }
    },
    enabled: !!user && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: sphereContacts = [] } = useQuery({
    queryKey: ["sphereContacts", user?.id],
    queryFn: async () => {
      try {
        return await base44.entities.Contact.filter({ created_by: user.email });
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for contacts, using cached data');
        } else {
          console.error('Error fetching contacts:', error);
        }
        return [];
      }
    },
    enabled: !!user?.id && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: leadActivities = [] } = useQuery({
    queryKey: ['leadActivities'],
    queryFn: async () => {
      try {
        return await base44.entities.LeadActivity.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for leadActivities, using cached data');
        } else {
          console.error('Error fetching lead activities:', error);
        }
        return [];
      }
    },
    enabled: !!user && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: messages = [] } = useQuery({
    queryKey: ['messages', user?.id],
    queryFn: async () => {
      try {
        const [sent, received] = await Promise.all([
          base44.entities.Message.filter({ sender_id: user.id }).catch(() => []),
          base44.entities.Message.filter({ recipient_id: user.id }).catch(() => [])
        ]);
        const combined = [...sent, ...received];
        return Array.from(new Map(combined.map(item => [item.id, item])).values());
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for messages, using cached data');
        } else {
          console.error('Error fetching messages:', error);
        }
        return [];
      }
    },
    enabled: !!user?.id && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: chatMessages = [] } = useQuery({
    queryKey: ['chatMessages'],
    queryFn: async () => {
      try {
        return await base44.entities.ChatMessage.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for chat messages, using cached data');
        } else {
          console.error('Error fetching chat messages:', error);
        }
        return [];
      }
    },
    enabled: !!user && isQueryClientReady,
    staleTime: 5000, // 5 seconds - refresh more frequently for chat
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchInterval: 10000, // Poll every 10 seconds
    refetchOnMount: true,
    refetchOnWindowFocus: true,
    refetchOnReconnect: false
  });

  const { data: transactions = [] } = useQuery({
    queryKey: ['transactions', user?.id],
    queryFn: async () => {
      try {
        const [listing, selling] = await Promise.all([
          base44.entities.Transaction.filter({ listing_agent_id: user.id }).catch(() => []),
          base44.entities.Transaction.filter({ selling_agent_id: user.id }).catch(() => [])
        ]);
        const combined = [...listing, ...selling];
        return Array.from(new Map(combined.map(item => [item.id, item])).values());
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for transactions, using cached data');
        } else {
          console.error('Error fetching transactions:', error);
        }
        return [];
      }
    },
    enabled: !!user?.id && isQueryClientReady,
    staleTime: LONG_STALE_TIME,
    gcTime: LONG_CACHE_TIME,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false
  });

  const { data: properties = [] } = useQuery({
    queryKey: ['properties', user?.id],
    queryFn: async () => {
      try {
        const [listing, created] = await Promise.all([
          base44.entities.Property.filter({ listing_agent_id: user.id }).catch(() => []),
          base44.entities.Property.filter({ created_by: user.email }).catch(() => [])
        ]);
        const combined = [...listing, ...created];
        return Array.from(new Map(combined.map(item => [item.id, item])).values());
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for properties, using cached data');
        } else {
          console.error('Error fetching properties:', error);
        }
        return [];
      }
    },
    enabled: !!user?.id && isQueryClientReady,
    staleTime: 6 * 60 * 60 * 1000, // 6 hours - extreme caching to prevent rate limits
    gcTime: 12 * 60 * 60 * 1000, // 12 hours
    retry: false,
    retryOnMount: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false,
    refetchInterval: false,
    refetchIntervalInBackground: false
  });

  const { data: realtorTips = [] } = useQuery({
    queryKey: ['realtorTips'],
    queryFn: async () => {
      try {
        const allTips = await base44.entities.RealtorTip.list();
        return allTips.filter(t => !t.is_deleted);
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for realtorTips, using cached data');
        } else {
          console.error('Error fetching realtor tips:', error);
        }
        return [];
      }
    },
    enabled: !!user && isQueryClientReady,
    staleTime: 2 * 60 * 60 * 1000,
    gcTime: 4 * 60 * 60 * 1000,
    retry: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
    refetchOnReconnect: false,
    refetchInterval: false
  });

  // --- All useEffect and useMemo hooks ---

  useEffect(() => {
    if (!mainContentRef.current) return;

    const restoreScrollPosition = () => {
      const savedScrollPos = sessionStorage.getItem(`scrollPos-${location.key}`);
      if (savedScrollPos !== null) {
        mainContentRef.current.scrollTop = parseInt(savedScrollPos, 10);
      } else {
        mainContentRef.current.scrollTo(0, 0);
      }
    };

    restoreScrollPosition();

    return () => {
      if (mainContentRef.current) {
        sessionStorage.setItem(`scrollPos-${location.key}`, mainContentRef.current.scrollTop.toString());
      }
    };
  }, [location.key]);

  // Preserve sidebar scroll position
  useEffect(() => {
    if (!sidebarScrollRef.current) return;

    // Restore scroll position after a short delay to ensure DOM is ready
    const savedSidebarScroll = sessionStorage.getItem('sidebarScrollPos');
    if (savedSidebarScroll !== null) {
      requestAnimationFrame(() => {
        if (sidebarScrollRef.current) {
          sidebarScrollRef.current.scrollTop = parseInt(savedSidebarScroll, 10);
        }
      });
    }

    const saveSidebarScroll = () => {
      if (sidebarScrollRef.current) {
        sessionStorage.setItem('sidebarScrollPos', sidebarScrollRef.current.scrollTop.toString());
      }
    };

    const sidebarElement = sidebarScrollRef.current;
    sidebarElement.addEventListener('scroll', saveSidebarScroll);

    return () => {
      sidebarElement?.removeEventListener('scroll', saveSidebarScroll);
    };
  }, [navItems]);

  useEffect(() => {
    if (!user || !isQueryClientReady) return; // Only run if user is authenticated AND queryClient is ready

    try {
      const handleGlobalRefresh = () => {
        // Debounce refresh to prevent rate limits
        if (window.refreshTimeout) {
          clearTimeout(window.refreshTimeout);
        }

        window.refreshTimeout = setTimeout(() => {
          // Only invalidate critical queries
          const queryKeys = ['tasks', 'notifications', 'transactions'];

          queryKeys.forEach((key) => {
            try {
              queryClient.invalidateQueries({ queryKey: [key] });
            } catch (err) {
              console.error(`Error invalidating ${key}:`, err);
            }
          });

          // Don't invalidate properties - let cache expire naturally
          console.log('üîÑ Refreshed critical data (properties cached)');
        }, 1000); // 1 second debounce
      };

      window.addEventListener('refreshGlobalData', handleGlobalRefresh);
      window.addEventListener('refreshCounts', handleGlobalRefresh);

      const handleMenuThemeChange = () => {
        setMenuTheme(localStorage.getItem('menuTheme') || 'default');
      };
      window.addEventListener('themeChange', handleMenuThemeChange);

      return () => {
        window.removeEventListener('refreshGlobalData', handleGlobalRefresh);
        window.removeEventListener('refreshCounts', handleGlobalRefresh);
        window.removeEventListener('themeChange', handleMenuThemeChange);
      };
    } catch (err) {
      console.error('Error setting up global refresh listeners:', err);
    }
  }, [user, queryClient, isQueryClientReady]); // queryClient is stable, user indicates auth state, isQueryClientReady indicates readiness

  useEffect(() => {
    if (!user || !isQueryClientReady) return; // Depend on user and queryClient readiness

    try {
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);

      const pendingTasksCount = (tasks || []).filter((t) => t && t.status && t.status !== 'completed' && t.status !== 'cancelled').length;

      const overdueTasksCount = Array.isArray(tasks) ? tasks.filter((t) => {
        if (!t || !t.status || t.status === 'completed' || t.status === 'cancelled' || !t.due_date) return false;

        const dueDate = new Date(t.due_date);
        dueDate.setHours(0, 0, 0, 0);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        return dueDate < today;
      }).length : 0;

      const todayTasksCount = Array.isArray(tasks) ? tasks.filter((t) => {
        if (!t || !t.status || t.status === 'completed' || t.status === 'cancelled' || !t.due_date) return false;

        const dueDate = new Date(t.due_date);
        return dueDate >= todayStart && dueDate <= todayEnd;
      }).length : 0;

      const todayOpenHousesCount = (openHouses || []).filter((oh) => {
        if (!oh || !oh.date || !oh.status || oh.status === 'cancelled') return false;
        const eventDate = new Date(oh.date);
        return eventDate >= todayStart && eventDate <= todayEnd;
      }).length;

      const todayShowingsCount = (showings || []).filter((s) => {
        if (!s || !s.scheduled_date || !s.status || s.status === 'cancelled') return false;
        const eventDate = new Date(s.scheduled_date);
        return eventDate >= todayStart && eventDate <= todayEnd;
      }).length;

      const todayAppointmentsCount = (appointments || []).filter((a) => {
        if (!a || !a.scheduled_date || !a.status || a.status === 'cancelled' || a.status === 'completed') return false;
        const eventDate = new Date(a.scheduled_date);
        return eventDate >= todayStart && eventDate <= todayEnd;
      }).length;

      const todayEventsTotal = todayTasksCount + todayOpenHousesCount + todayShowingsCount + todayAppointmentsCount;

      const unreadNotifications = (notifications || []).filter((n) =>
      n && !n.is_read && n.user_id === user.id
      ).length;

      const hotLeadsCount = (leads || []).filter((l) =>
      l && (l.score || 0) >= 70 &&
      l.status && l.status !== 'converted' &&
      l.status !== 'lost' &&
      l.status !== 'closed'
      ).length;

      const activeLeadsCount = (leads || []).filter((l) =>
      l && l.status && l.status !== 'converted' && l.status !== 'lost' && l.status !== 'archived'
      ).length;

      const activeBuyersCount = (sphereContacts || []).filter((c) => c && (c.type === 'buyer' || c.status === 'active_buyer')).length;
      const allContactsCount = (sphereContacts || []).length;


      const upcomingEventsCount = [...(openHouses || []), ...(showings || []), ...(appointments || [])].filter((event) => {
        if (!event) return false;
        const eventDate = new Date(event.date || event.scheduled_date);
        return eventDate > now && event.status && event.status !== 'cancelled' && event.status !== 'completed';
      }).length;

      const unreadMessagesCount = (messages || []).filter((m) => m && !m.is_read && m.recipient_id === user.id).length;

      const unreadChatMessagesCount = (chatMessages || []).filter((m) => {
        if (!m || m.sender_id === user.id) return false;
        const readByList = m.read_by ? m.read_by.split(',') : [];
        return !readByList.includes(user.id);
      }).length;

      const activeTransactionsCount = (transactions || []).filter((t) => t && t.status && t.status !== 'closed' && t.status !== 'cancelled').length;

      const upcomingOpenHousesCount = (openHouses || []).filter((oh) => {
        if (!oh || !oh.date || !oh.status) return false;
        const eventDate = new Date(oh.date);
        return eventDate > now && oh.status !== 'cancelled';
      }).length;

      const upcomingShowingsCount = (showings || []).filter((s) => {
        if (!s || !s.scheduled_date || !s.status) return false;
        const eventDate = new Date(s.scheduled_date);
        return eventDate > now && s.status !== 'cancelled';
      }).length;

      const activePropertiesCount = (properties || []).filter((p) => p && p.status && p.status !== 'sold' && p.status !== 'off_market' && p.status !== 'inactive').length;

      const unreadTipsCount = (realtorTips || []).filter((t) => t && !t.is_read).length;

      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      let inactiveMembersCount = 0;
      if (teamMembers && teamMembers.length > 0) {
        inactiveMembersCount = teamMembers.filter((member) => {
          if (!member) return false;
          const hasRecentLeadActivity = (leadActivities || []).some((a) =>
          a && a.user_id === member.id && a.created_date && new Date(a.created_date) > thirtyDaysAgo
          );
          const hasRecentTransactionActivity = (transactions || []).some((t) =>
          t && (t.listing_agent_id === member.id || t.selling_agent_id === member.id) && (
          t.updated_date && new Date(t.updated_date) > thirtyDaysAgo || t.created_date && new Date(t.created_date) > thirtyDaysAgo)
          );
          const hasRecentMessageActivity = (messages || []).some((m) =>
          m && m.sender_id === member.id && m.created_date && new Date(m.created_date) > thirtyDaysAgo
          );

          return !(hasRecentLeadActivity || hasRecentTransactionActivity || hasRecentMessageActivity);
        }).length;
      }

      setCounts({
        tasks: pendingTasksCount,
        overdueTasks: overdueTasksCount,
        todayTasks: todayTasksCount,
        notifications: unreadNotifications,
        hotLeads: hotLeadsCount,
        todayEvents: todayEventsTotal,
        inactiveMembersCount: inactiveMembersCount,
        teamSurveys: (teamSurveys || []).filter((ts) => ts && !ts.is_archived).length,
        newsArticles: (newsArticles || []).length,
        sphereContacts: (sphereContacts || []).length,
        taskPackages: (taskPackages || []).length,
        pendingTasksCount: pendingTasksCount,
        activeLeadsCount: activeLeadsCount,
        activeBuyersCount: activeBuyersCount > 0 ? activeBuyersCount : allContactsCount,
        upcomingEventsCount: upcomingEventsCount,
        unreadMessagesCount: unreadMessagesCount,
        unreadChatMessagesCount: unreadChatMessagesCount,
        contactsCount: allContactsCount,
        activeTransactionsCount: activeTransactionsCount,
        upcomingOpenHousesCount: upcomingOpenHousesCount,
        upcomingShowingsCount: upcomingShowingsCount,
        activePropertiesCount: activePropertiesCount,
        unreadTipsCount: unreadTipsCount
      });

    } catch (error) {
      console.error("Error calculating counts:", error);
    }
  }, [
  user?.id, tasks?.length, notifications?.length, leads?.length, openHouses?.length, showings?.length, appointments?.length,
  teamMembers?.length, leadActivities?.length, messages?.length, chatMessages?.length, transactions?.length, 
  teamSurveys?.length, newsArticles?.length, sphereContacts?.length, taskPackages?.length, properties?.length, realtorTips?.length, isQueryClientReady]
  );

  const profileTypeNames = {
    new_agent: 'New Agent',
    listing_specialist: 'Listing Specialist',
    buyer_specialist: 'Buyer Agent',
    dual_agent: 'Full Service Agent',
    advanced_agent: 'Advanced Agent'
  };

  const profileTypeIcons = {
    new_agent: '‚ú®',
    listing_specialist: 'üè†',
    buyer_specialist: 'üë•',
    dual_agent: 'üíº',
    advanced_agent: 'üìà'
  };

  // Renamed from toggleCategory to toggleSection
  const toggleSection = (name) => {
    const newSections = new Set(openSections);
    if (newSections.has(name)) {
      newSections.delete(name);
    } else {
      newSections.add(name);
    }
    setOpenSections(newSections);
    localStorage.setItem('openSections', JSON.stringify([...newSections]));
  };



  // Fetch subscription features with aggressive caching to avoid rate limits
  const { data: subscriptionData } = useQuery({
    queryKey: ['subscriptionFeatures', user?.id],
    queryFn: async () => {
      try {
        const { getSubscriptionFeatures } = await import('../components/utils/subscriptionLimits');
        return await getSubscriptionFeatures();
      } catch (error) {
        console.warn('Subscription fetch error, using defaults:', error.message);
        return { features: [], tierLevel: 1 };
      }
    },
    enabled: !!user,
    staleTime: 2 * 60 * 60 * 1000, // 2 hours
    gcTime: 4 * 60 * 60 * 1000, // 4 hours
    retry: false,
    refetchOnWindowFocus: false,
    refetchOnMount: false,
    refetchOnReconnect: false,
    initialData: { features: [], tierLevel: 1 }
  });

  const userFeatures = subscriptionData?.features || [];
  const userTierLevel = subscriptionData?.tierLevel || 1;

  const hasFeature = (featureName) => {
    if (!userFeatures || userFeatures.length === 0) return true; // Show all if no features loaded
    return userFeatures.some((f) => f.toLowerCase().includes(featureName.toLowerCase()));
  };

  const navigationItems = useMemo(() => {
    const items = [
    {
      name: 'Dashboard',
      path: "Dashboard",
      icon: LayoutDashboard,
      requiresRole: []
    },
    {
      name: 'CRM',
      icon: Users,
      requiresRole: [],
      children: [
      { name: 'Properties', path: "Properties", icon: Home, count: counts.activePropertiesCount },
      { name: 'Leads', path: "Leads", icon: Users, badge: counts.hotLeads > 0 ? { text: counts.hotLeads, color: "bg-red-500" } : null },
      { name: 'Buyers', path: "Buyers", icon: UserCheck },
      { name: 'Contacts', path: "Contacts", icon: Users2 },
      { name: 'Transactions', path: "Transactions", icon: FileText },
      { name: 'Messages', path: "Messages", icon: Mail, badge: counts.unreadMessagesCount > 0 ? { text: counts.unreadMessagesCount, color: "bg-green-500" } : null }]
    },
    {
      name: 'Schedule',
      icon: Calendar,
      requiresRole: [],
      children: [
      { name: 'Tasks', path: "Tasks", icon: CheckSquare, badge: counts.overdueTasks > 0 ? { text: counts.overdueTasks, color: "bg-red-500" } : null },
      { name: 'Calendar', path: "Calendar", icon: Calendar },
      { name: 'Open House', path: "OpenHouses", icon: DoorOpen },
      { name: 'Showing', path: "Showings", icon: Eye },
      { name: 'Documents', path: "Documents", icon: FileText },
      { name: 'Photos', path: "Photos", icon: Camera }]
    },
    {
      name: 'Intelligence & Marketing',
      icon: Sparkles,
      requiresRole: [],
      children: [
      { name: 'Marketing Website', path: "Website", icon: Globe },
      { name: 'House Worth Tool', path: "HouseWorthEstimator", icon: DollarSign },
      { name: "Why Didn't It Sell", path: "WhyDidntItSell", icon: Target },
      { name: 'Jackie Assistant', path: "JackieAI", icon: MessageSquare },
      { name: 'Jackie Follow-ups', path: "JackieFollowups", icon: Brain },
      { name: 'Daily Advice', path: "DailyAdvice", icon: Calendar },
      { name: 'Insights', path: "AIInsights", icon: TrendingUp },
      { name: 'Lead Scoring', path: "LeadScoring", icon: TrendingUp },
      { name: 'Lead Nurturing', path: "AILeadNurturing", icon: Brain },
      { name: 'Property Whisperer', path: "AIPropertyWhisperer", icon: Home },
      { name: 'Social Intelligence', path: "SocialIntelligence", icon: Users },
      { name: 'Sphere Autopilot', path: "SphereAutopilot", icon: Plane },
      { name: 'FSBO Leads', path: "FSBO", icon: Target },
      { name: 'Marketing Campaigns', path: "MarketingCampaigns", icon: Megaphone },
      { name: 'Design Studio', path: "MarketingDesignStudio", icon: Sparkles },
      { name: 'Newsletters', path: "NewsletterBuilder", icon: Mail },
      { name: 'Buyer Report', path: "BuyerReport", icon: FileText }]
      },
      {
      name: 'Analytics',
      icon: BarChart3,
      requiresRole: [],
      children: [
      { name: 'Reports', path: "Reports", icon: BarChart3 },
      { name: 'Commissions', path: "Commissions", icon: DollarSign },
      { name: 'Analytics', path: "Analytics", icon: TrendingUp },
      { name: 'FSBO Analytics', path: "FSBOAnalytics", icon: BarChart3 }]
    },
    {
      name: 'Team & Tools',
      icon: Briefcase,
      requiresRole: [],
      children: [
      { name: 'Team Hub', path: "TeamHub", icon: Users },
      { name: 'Agent Club', path: "AgentClub", icon: Users2 },
      { name: 'Investor Hub', path: "InvestorHub", icon: DollarSign },
      { name: 'Team Advisor', path: "AITeamAdvisor", icon: Briefcase },
      { name: 'Mortgage Calculator', path: "MortgageCalculator", icon: DollarSign },
      { name: 'Net Sheet', path: "NetSheetGenerator", icon: FileCheck2 },
      { name: 'Location Intelligence', path: "LocationIntelligence", icon: MapPin },
      { name: 'Community Search', path: "SubdivisionSearch", icon: MapPin },
      { name: 'News', path: "News", icon: Newspaper },
      { name: 'Scam Alerts', path: "ScamAlerts", icon: AlertTriangle }]
    },
    {
      name: 'Settings',
      icon: Settings,
      requiresRole: [],
      children: [
      { name: 'Settings', path: "Settings", icon: Settings },
      { name: 'Notifications', path: "Notifications", icon: Bell, count: counts.notifications },
      { name: 'Client Portal', path: "ClientPortal", icon: Home },
      { name: 'Client Portal Setup', path: "ClientPortalSetup", icon: Settings },
      { name: 'Knowledge Base', path: "KnowledgeBase", icon: BookOpen },
      { name: 'Email Integration', path: "EmailIntegration", icon: Mail },
      { name: 'CSV Import', path: "CSVImport", icon: Upload },
      { name: 'Backup & Restore', path: "BackupRestore", icon: HardDrive },
      { name: 'Workflows', path: "Workflows", icon: Workflow },
      { name: 'Marketing Website', path: "Website", icon: Globe },
      { name: 'Tips & Tricks', path: "RealtorTips", icon: Lightbulb, badge: counts.unreadTipsCount > 0 ? { text: counts.unreadTipsCount, color: "bg-amber-500" } : null },
      { name: 'Feedback', path: "FeedbackSuggestions", icon: Heart },
      { name: 'Initialize Demo', path: "InitializeComprehensiveDemo", icon: Database },
      { name: 'Reset Demo', path: "ResetDemo", icon: RefreshCw }]
      }];

    return items.filter(Boolean);
  }, [
  counts.activePropertiesCount,
  counts.activeTransactionsCount,
  counts.hotLeads,
  counts.activeLeadsCount,
  counts.activeBuyersCount,
  counts.overdueTasks,
  counts.todayTasks,
  counts.pendingTasksCount,
  counts.taskPackages,
  counts.todayEvents,
  counts.upcomingEventsCount,
  counts.unreadMessagesCount,
  counts.contactsCount,
  counts.upcomingOpenHousesCount,
  counts.upcomingShowingsCount,
  counts.inactiveMembersCount,
  counts.teamSurveys,
  counts.newsArticles,
  counts.notifications,
  userFeatures,
  userTierLevel]
  );

  useEffect(() => {
    const savedStructure = JSON.parse(localStorage.getItem('navStructure'));
    if (savedStructure && savedStructure.length > 0) {
      // Restore full structure including child order
      const itemsMap = new Map();
      navigationItems.forEach((item) => {
        itemsMap.set(item.name, item);
      });

      const orderedItems = savedStructure.
      map((savedItem) => {
        const freshItem = itemsMap.get(savedItem.name);
        if (!freshItem) return null;

        // If saved item has custom child order, apply it
        if (savedItem.children && freshItem.children) {
          const childMap = new Map(freshItem.children.map((c) => [c.name, c]));
          const orderedChildren = savedItem.children.
          map((savedChild) => childMap.get(savedChild.name)).
          filter(Boolean);

          // Add any new children not in saved order
          freshItem.children.forEach((child) => {
            if (!orderedChildren.find((c) => c.name === child.name)) {
              orderedChildren.push(child);
            }
          });

          return { ...freshItem, children: orderedChildren };
        }

        return freshItem;
      }).
      filter(Boolean);

      // Add any new top-level items
      const currentNames = new Set(orderedItems.map((item) => item.name));
      navigationItems.forEach((item) => {
        if (!currentNames.has(item.name)) {
          orderedItems.push(item);
        }
      });

      setNavItems(orderedItems);
    } else {
      setNavItems(navigationItems);
    }
  }, [navigationItems]);

  const onDragEnd = (result) => {
    const { source, destination, type } = result;
    if (!destination) return;

    if (type === 'CHILD') {
      // Handle child item reordering within categories
      const items = Array.from(navItems);
      const sourceCategoryName = source.droppableId.replace('category-', '');
      const destCategoryName = destination.droppableId.replace('category-', '');

      const sourceCategory = items.find((item) => item.name === sourceCategoryName);
      const destCategory = items.find((item) => item.name === destCategoryName);

      if (sourceCategory && destCategory && sourceCategory.children && destCategory.children) {
        const sourceChildren = Array.from(sourceCategory.children);
        const [movedChild] = sourceChildren.splice(source.index, 1);

        if (sourceCategoryName === destCategoryName) {
          // Reordering within same category
          sourceChildren.splice(destination.index, 0, movedChild);
          sourceCategory.children = sourceChildren;
        } else {
          // Moving between categories
          const destChildren = Array.from(destCategory.children);
          destChildren.splice(destination.index, 0, movedChild);
          sourceCategory.children = sourceChildren;
          destCategory.children = destChildren;
        }

        setNavItems(items);
        localStorage.setItem('navStructure', JSON.stringify(items));
      }
    } else {
      // Handle top-level category reordering
      const items = Array.from(navItems);
      const [reorderedItem] = items.splice(source.index, 1);
      items.splice(destination.index, 0, reorderedItem);

      setNavItems(items);
      localStorage.setItem('navStructure', JSON.stringify(items));
    }
  };

  const toggleTheme = () => {
    const newTheme = theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    localStorage.setItem('theme', newTheme);
    if (newTheme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  };

  const handleBack = () => {
    if (window.history.length > 1) {
      navigate(-1);
    } else {
      navigate(createPageUrl("Dashboard"));
    }
  };

  const handleLogout = async () => {
    try {
      await base44.auth.logout();
      try {
        // queryClient is always available here
        queryClient.removeQueries({ queryKey: ['user'] });
      } catch (err) {
        console.error('Error removing user query:', err);
      }
      navigate(createPageUrl("Login"));
    } catch (error) {
      console.error("Logout error:", error);
      navigate(createPageUrl("Login"));
    }
  };

  const currentThemeColors = colorThemes[colorTheme] || colorThemes.default;
  const currentMenuTheme = MENU_THEMES[menuTheme] || MENU_THEMES.default;
  const menuColors = theme === 'dark' ? currentMenuTheme.dark : currentMenuTheme.light;

  // Apply theme colors to document root
  useEffect(() => {
    const root = document.documentElement;
    root.style.setProperty('--theme-primary', currentThemeColors.primary);
    root.style.setProperty('--theme-secondary', currentThemeColors.secondary);
    root.style.setProperty('--theme-accent', currentThemeColors.accent);
    root.style.setProperty('--theme-neutral', currentThemeColors.neutral);
  }, [currentThemeColors]);

  // Listen for theme changes from settings
  useEffect(() => {
    const handleThemeChange = (e) => {
      if (e.detail?.colorTheme) {
        setColorTheme(e.detail.colorTheme);
      }
    };

    window.addEventListener('colorThemeChange', handleThemeChange);

    return () => {
      window.removeEventListener('colorThemeChange', handleThemeChange);
    };
  }, []);

  // --- Conditional Rendering (must come AFTER all hooks) ---

  // Show loading screen if user data is loading
  if (isUserLoading || !isQueryClientReady) {
    return (
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', background: colorThemes.default.gradientCSS }}>
        <div style={{ textAlign: 'center', color: 'white' }}>
          <div style={{
            width: '200px',
            height: '200px',
            position: 'relative',
            margin: '0 auto 24px'
          }}>
            {/* Brain circles orbiting around house */}
            {[0, 1, 2, 3, 4, 5].map((i) =>
            <div
              key={i}
              style={{
                position: 'absolute',
                top: '50%',
                left: '50%',
                width: '100%',
                height: '100%',
                animation: `orbit ${3 + i * 0.3}s linear infinite`,
                animationDelay: `${i * 0.5}s`,
                transformOrigin: 'center center'
              }}>

                <div style={{
                position: 'absolute',
                top: '-10px',
                left: '50%',
                transform: 'translateX(-50%)',
                width: '20px',
                height: '20px',
                background: 'rgba(255,255,255,0.9)',
                borderRadius: '50%',
                boxShadow: '0 0 20px rgba(255,255,255,0.6)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '12px'
              }}>
                  üß†
                </div>
              </div>
            )}

            {/* Center house */}
            <div style={{
              position: 'absolute',
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
              width: '80px',
              height: '80px',
              background: 'rgba(255,255,255,0.15)',
              backdropFilter: 'blur(10px)',
              WebkitBackdropFilter: 'blur(10px)',
              borderRadius: '20px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              boxShadow: '0 20px 40px rgba(0,0,0,0.3)',
              border: '1px solid rgba(255,255,255,0.3)',
              animation: 'pulse 2s ease-in-out infinite'
            }}>
              <svg width="48" height="48" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 4L24 12H20V22H8V12H4L14 4Z" fill="white" fillOpacity="0.95" />
                <circle cx="11" cy="14" r="1.5" fill="rgba(255,255,255,0.4)" />
                <circle cx="17" cy="14" r="1.5" fill="rgba(255,255,255,0.4)" />
                <circle cx="14" cy="11" r="1.5" fill="rgba(255,255,255,0.4)" />
                <circle cx="14" cy="17" r="1.5" fill="rgba(255,255,255,0.4)" />
                <line x1="11" y1="14" x2="14" y2="11" stroke="rgba(255,255,255,0.3)" strokeWidth="1" />
                <line x1="17" y1="14" x2="14" y2="11" stroke="rgba(255,255,255,0.3)" strokeWidth="1" />
                <line x1="11" y1="14" x2="14" y2="17" stroke="rgba(255,255,255,0.3)" strokeWidth="1" />
                <line x1="17" y1="14" x2="14" y2="17" stroke="rgba(255,255,255,0.3)" strokeWidth="1" />
              </svg>
            </div>
          </div>

          <p style={{ fontSize: '24px', fontWeight: 700, textShadow: '0 2px 4px rgba(0,0,0,0.2)', marginBottom: '8px' }}>RealtyMind</p>
          <p style={{ fontSize: '16px', fontWeight: 500, opacity: 0.9, textShadow: '0 1px 2px rgba(0,0,0,0.1)' }}>The Mind Behind Every Deal</p>
        </div>
      </div>);

  }

  // Show error screen if user loading failed
  if (userError) {
    return (
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', background: colorThemes.default.gradientCSS }}>
        <div style={{ textAlign: 'center', color: 'white', maxWidth: '400px', padding: '32px' }}>
          <AlertTriangle style={{ width: '64px', height: '64px', margin: '0 auto 24px', opacity: 0.9 }} />
          <h2 style={{ fontSize: '24px', fontWeight: 700, marginBottom: '16px' }}>Connection Error</h2>
          <p style={{ fontSize: '16px', opacity: 0.9, marginBottom: '24px' }}>Unable to load your account. Please refresh the page.</p>
          <Button
            onClick={() => window.location.reload()}
            style={{ background: 'white', color: currentThemeColors.primary }}>

            <RefreshCw className="w-4 h-4 mr-2" />
            Refresh Page
          </Button>
        </div>
      </div>);

  }

  return (
    <div
      className="min-h-screen"
      style={{
        '--theme-primary': currentThemeColors.primary,
        '--theme-secondary': currentThemeColors.secondary,
        '--theme-accent': currentThemeColors.accent,
        '--theme-neutral': currentThemeColors.neutral
      }}>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        @keyframes orbit {
          from { transform: translate(-50%, -50%) rotate(0deg); }
          to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @keyframes shine {
          0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
          100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.8; }
        }

        .animate-pulse {
          animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Sharp Corners Mode - Override ALL rounded corners */
        .sharp-corners *,
        .sharp-corners *::before,
        .sharp-corners *::after {
          border-radius: 0 !important;
        }

        /* Property cards sharp corners */
        .sharp-corners .property-card,
        .sharp-corners .property-card *,
        .sharp-corners .property-card img,
        .sharp-corners .property-card .rounded-lg,
        .sharp-corners .property-card .rounded-xl {
          border-radius: 0 !important;
        }

        /* Properties page sharp corners override */
        .sharp-corners .properties-page-container .grid .group.overflow-hidden,
        .sharp-corners .properties-page-container .grid .group.overflow-hidden *,
        .sharp-corners .properties-page-container Card,
        .sharp-corners .properties-page-container .rounded-lg,
        .sharp-corners .properties-page-container .rounded-xl,
        .sharp-corners .properties-page-container [class*="rounded"] {
          border-radius: 0 !important;
        }

        /* Apply theme colors globally - COMPREHENSIVE COVERAGE */
        .bg-primary {
          background-color: var(--theme-primary) !important;
        }

        .bg-secondary {
          background-color: var(--theme-secondary) !important;
        }

        .text-primary {
          color: var(--theme-primary) !important;
        }

        .border-primary {
          border-color: var(--theme-primary) !important;
        }

        .hover\\:bg-primary:hover {
          background-color: var(--theme-primary) !important;
        }

        /* Override ALL primary color variations */
        .bg-indigo-600,
        .bg-blue-600,
        .bg-purple-600,
        .bg-violet-600,
        .bg-indigo-700,
        .bg-purple-700,
        .bg-violet-700 {
          background: var(--theme-primary) !important;
        }

        .bg-indigo-500,
        .bg-blue-500,
        .bg-purple-500,
        .bg-violet-500 {
          background: color-mix(in srgb, var(--theme-primary) 90%, white) !important;
        }

        .hover\\:bg-indigo-700:hover,
        .hover\\:bg-blue-700:hover,
        .hover\\:bg-purple-700:hover,
        .hover\\:bg-violet-700:hover,
        .hover\\:bg-indigo-800:hover,
        .hover\\:bg-purple-800:hover {
          background: color-mix(in srgb, var(--theme-primary) 85%, black) !important;
        }

        /* Text colors */
        .text-indigo-600,
        .text-blue-600,
        .text-purple-600,
        .text-violet-600,
        .text-indigo-500,
        .text-purple-500,
        .text-violet-500 {
          color: var(--theme-primary) !important;
        }

        .text-indigo-700,
        .text-indigo-800,
        .text-blue-700,
        .text-purple-700,
        .text-purple-800,
        .text-violet-700 {
          color: color-mix(in srgb, var(--theme-primary) 85%, black) !important;
        }

        .dark .text-indigo-700,
        .dark .text-indigo-800,
        .dark .text-purple-700,
        .dark .text-purple-800,
        .dark .text-violet-700 {
          color: color-mix(in srgb, var(--theme-primary) 70%, white) !important;
        }

        /* Border colors */
        .border-indigo-600,
        .border-blue-600,
        .border-purple-600,
        .border-violet-600,
        .border-indigo-500,
        .border-purple-500 {
          border-color: var(--theme-primary) !important;
        }

        /* Badge and light backgrounds */
        .bg-indigo-100,
        .bg-blue-100,
        .bg-purple-100,
        .bg-violet-100 {
          background: color-mix(in srgb, var(--theme-primary) 15%, white) !important;
        }

        .bg-indigo-50,
        .bg-blue-50,
        .bg-purple-50,
        .bg-violet-50 {
          background: color-mix(in srgb, var(--theme-primary) 8%, white) !important;
        }

        .dark .bg-indigo-100,
        .dark .bg-blue-100,
        .dark .bg-purple-100,
        .dark .bg-violet-100 {
          background: color-mix(in srgb, var(--theme-primary) 20%, #020408) !important;
          border: 1px solid color-mix(in srgb, var(--theme-primary) 30%, #020408) !important;
        }

        .dark .bg-indigo-50,
        .dark .bg-blue-50,
        .dark .bg-purple-50,
        .dark .bg-violet-50 {
          background: color-mix(in srgb, var(--theme-primary) 12%, #020408) !important;
        }

        /* Focus rings */
        .focus\\:ring-indigo-500:focus,
        .focus\\:ring-blue-500:focus,
        .focus\\:ring-purple-500:focus,
        .focus\\:ring-violet-500:focus {
          --tw-ring-color: var(--theme-primary) !important;
        }

        .focus\\:border-indigo-500:focus,
        .focus\\:border-blue-500:focus,
        .focus\\:border-purple-500:focus {
          border-color: var(--theme-primary) !important;
        }

        /* Gradient backgrounds - ALL variations */
        .from-indigo-600,
        .from-blue-600,
        .from-purple-600,
        .from-violet-600 {
          --tw-gradient-from: var(--theme-primary) !important;
        }

        .to-purple-700,
        .to-indigo-700,
        .to-blue-700,
        .to-violet-700,
        .to-purple-600,
        .to-indigo-600 {
          --tw-gradient-to: var(--theme-secondary) !important;
        }

        .via-purple-600,
        .via-indigo-600,
        .via-blue-600,
        .via-violet-600 {
          --tw-gradient-via: var(--theme-primary) !important;
        }

        .bg-gradient-to-r.from-indigo-600,
        .bg-gradient-to-br.from-indigo-600,
        .bg-gradient-to-r.from-purple-600,
        .bg-gradient-to-br.from-purple-600,
        .bg-gradient-to-r.from-blue-600,
        .bg-gradient-to-br.from-blue-600,
        .bg-gradient-to-r.from-violet-600,
        .bg-gradient-to-br.from-violet-600 {
          --tw-gradient-from: var(--theme-primary) !important;
        }

        .bg-gradient-to-r.to-purple-700,
        .bg-gradient-to-br.to-purple-700,
        .bg-gradient-to-r.to-indigo-700,
        .bg-gradient-to-br.to-indigo-700,
        .bg-gradient-to-r.to-blue-700,
        .bg-gradient-to-br.to-blue-700,
        .bg-gradient-to-r.to-violet-700,
        .bg-gradient-to-br.to-violet-700 {
          --tw-gradient-to: var(--theme-secondary) !important;
        }

        /* Hover states */
        .hover\\:text-indigo-600:hover,
        .hover\\:text-blue-600:hover,
        .hover\\:text-purple-600:hover,
        .hover\\:text-violet-600:hover {
          color: var(--theme-primary) !important;
        }

        .hover\\:border-indigo-600:hover,
        .hover\\:border-purple-600:hover,
        .hover\\:border-violet-600:hover {
          border-color: var(--theme-primary) !important;
        }

        /* Ring colors for focus states */
        .ring-indigo-500,
        .ring-purple-500,
        .ring-violet-500 {
          --tw-ring-color: var(--theme-primary) !important;
        }

        /* Logo gradient */
        .logo-gradient {
          background: ${currentThemeColors.gradientCSS} !important;
        }

        /* Sidebar visibility - FORCE visible on desktop */
        @media (min-width: 1024px) {
          .sidebar {
            transform: translateX(0) !important;
            visibility: visible !important;
            display: flex !important;
            opacity: 1 !important;
            left: 0 !important;
          }
        }
        
        /* Mobile: hide sidebar unless open */
        @media (max-width: 1023px) {
          .sidebar {
            transform: translateX(-100%);
          }
          .sidebar.open {
            transform: translateX(0) !important;
          }
        }



        .dark {
            color-scheme: dark;
            background: linear-gradient(180deg, #0f1117 0%, #1a1d2e 100%);
            min-height: 100vh;
        }

        .dark .app-card,
        .dark .bg-white {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.50) 0%, rgba(15, 23, 42, 0.70) 100%) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(100, 116, 139, 0.2) !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
        }

        .dark .bg-slate-50 {
            background: transparent !important;
        }

        .dark .bg-slate-100 {
            background: rgba(30, 41, 59, 0.4) !important;
            border: 1px solid rgba(100, 116, 139, 0.2);
        }

        .dark .bg-slate-200 {
            background: rgba(30, 41, 59, 0.5) !important;
        }

        .dark .border-slate-200,
        .dark .border-slate-300 {
            border-color: rgba(71, 85, 105, 0.2) !important;
        }

        .dark .border-slate-700,
        .dark .border-slate-800 {
            border-color: rgba(71, 85, 105, 0.3) !important;
        }

        .dark .hover\\:shadow-lg:hover,
        .dark .hover\\:shadow-xl:hover {
            box-shadow: 0 20px 40px rgba(0,0,0,0.7), 0 0 1px rgba(255,255,255,0.1) !important;
        }

        .dark .text-slate-900,
        .dark .text-gray-900 {
            color: #f8fafc !important;
        }

        .dark .text-slate-800,
        .dark .text-gray-800 {
            color: #f1f5f9 !important;
        }

        .dark .text-slate-700,
        .dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .dark .text-slate-600,
        .dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .dark .text-slate-500,
        .dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .dark .text-slate-400 {
            color: #64748b !important;
        }

        .dark .text-slate-300 {
            color: #cbd5e1 !important;
        }

        .dark .text-muted-foreground {
            color: #94a3b8 !important;
        }

        .dark .bg-white\\/30,
        .dark .bg-white\\/50 {
            background: rgba(15, 23, 42, 0.7) !important;
            backdrop-filter: blur(16px);
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .dark input,
        .dark textarea,
        .dark select {
            background: rgba(30, 41, 59, 0.6) !important;
            border-color: rgba(100, 116, 139, 0.3) !important;
            color: #f1f5f9 !important;
        }

        .dark input:focus,
        .dark textarea:focus,
        .dark select:focus {
            background: rgba(30, 41, 59, 0.8) !important;
            border-color: rgba(99, 102, 241, 0.6) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .dark input::placeholder,
        .dark textarea::placeholder {
            color: #64748b !important;
        }

        .dark .bg-indigo-600,
        .dark .bg-blue-600,
        .dark .bg-primary {
            background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%) !important;
            box-shadow: 0 8px 20px color-mix(in srgb, var(--theme-primary) 40%, black), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .dark .bg-indigo-600:hover,
        .dark .bg-blue-600:hover,
        .dark .bg-primary:hover {
            background: linear-gradient(135deg, color-mix(in srgb, var(--theme-primary) 85%, white) 0%, var(--theme-primary) 100%) !important;
            box-shadow: 0 10px 25px color-mix(in srgb, var(--theme-primary) 50%, black);
            transform: translateY(-1px);
        }

        .dark .bg-white\\/60 {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(2, 6, 23, 0.95) 100%) !important;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .dark .bg-blue-100 {
            background: color-mix(in srgb, var(--theme-primary) 15%, #020408) !important;
            color: color-mix(in srgb, var(--theme-primary) 70%, white) !important;
            border: 1px solid color-mix(in srgb, var(--theme-primary) 20%, #020408) !important;
        }

        .dark .bg-green-100 {
            background: rgba(34, 197, 94, 0.15) !important;
            color: #86efac !important;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .dark .bg-yellow-100,
        .dark .bg-amber-100 {
            background: rgba(251, 191, 36, 0.15) !important;
            color: #fcd34d !important;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .dark .bg-red-100 {
            background: rgba(239, 68, 68, 0.15) !important;
            color: #fca5a5 !important;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .dark .bg-purple-100 {
            background: rgba(168, 85, 247, 0.15) !important;
            color: #c4b5fd !important;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .dark .bg-indigo-100 {
            background: color-mix(in srgb, var(--theme-primary) 15%, #020408) !important;
            color: color-mix(in srgb, var(--theme-primary) 70%, white) !important;
            border: 1px solid color-mix(in srgb, var(--theme-primary) 20%, #020408) !important;
        }

        .dark header {
            background: rgba(15, 17, 23, 0.95) !important;
            backdrop-filter: blur(20px);
            border-bottom-color: rgba(71, 85, 105, 0.3) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .dark [role="menu"],
        .dark .dropdown-content {
            background: linear-gradient(135deg, rgba(26, 29, 46, 0.98) 0%, rgba(15, 17, 23, 1) 100%) !important;
            border: 1px solid rgba(71, 85, 105, 0.3) !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7) !important;
        }

        .dark [role="tooltip"] {
            background: rgba(15, 17, 23, 0.98) !important;
            border: 1px solid rgba(71, 85, 105, 0.4) !important;
            backdrop-filter: blur(16px);
        }

        .dark ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .dark ::-webkit-scrollbar-track {
            background: rgba(10, 15, 30, 0.5);
        }

        .dark ::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.4);
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.6);
        }

        .dark table {
            border-color: rgba(71, 85, 105, 0.2) !important;
        }

        .dark thead {
            background: rgba(15, 23, 42, 0.6) !important;
        }

        .dark tbody tr {
            border-color: rgba(71, 85, 105, 0.15) !important;
        }

        .dark tbody tr:hover {
            background: rgba(15, 23, 42, 0.4) !important;
        }

        .dark .fixed.inset-0 {
            background: rgba(0, 0, 0, 0.85) !important;
            backdrop-filter: blur(8px);
        }

        .properties-page-container .max-w-7xl {
          max-width: none !important;
        }
        .properties-page-container > div:first-child {
          padding: 0 !important;
        }
        .properties-page-container .from-indigo-600 {
          border-radius: 0 !important;
        }

        .properties-page-container .bg-white.dark\\:bg-slate-900\\/50 {
          background-color: #ffffff !important;
          border: 1px solid #e2e8f0 !important;
        }
        .dark .properties-page-container .bg-white.dark\\:bg-slate-900\\/50 {
          background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(2, 6, 23, 0.98) 100%) !important;
          border: 1px solid rgba(71, 85, 105, 0.2) !important;
        }

        .properties-page-container .text-3xl.font-bold.text-slate-900 {
          color: #111827 !important;
        }
        .dark .properties-page-container .text-3xl.font-bold.dark\\:text-white {
          color: #f9fafb !important;
        }
        .properties-page-container .text-slate-500.dark\\:text-slate-400 {
          color: #6b7280 !important;
        }
        .dark .properties-page-container .text-slate-500.dark\\:text-slate-400 {
          color: #9ca3af !important;
        }

        .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button {
          transition: background-color 0.2s, color 0.2s !important;
        }

        .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(1),
        .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(2) {
          background-color: #f3f4f6 !important;
          color: #1f2937 !important;
          border: 1px solid #d1d5db !important;
        }
        .dark .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(1),
        .dark .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(2) {
          background: rgba(15, 23, 42, 0.7) !important;
          color: #e2e8f0 !important;
          border: 1px solid rgba(71, 85, 105, 0.3) !important;
        }

        .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(1):hover,
        .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(2):hover {
          background-color: #e5e7eb !important;
        }
        .dark .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(1):hover,
        .dark .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(2):hover {
          background: rgba(15, 23, 42, 0.9) !important;
        }

         .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(3) {
          background-color: #111827 !important;
          color: #ffffff !important;
        }
        .dark .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(3) {
          background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%) !important;
          color: #ffffff !important;
        }
         .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(3):hover {
          background-color: #374151 !important;
        }
        .dark .properties-page-container .flex.gap-2.w-full.sm\\:w-auto > button:nth-child(3):hover {
          background: linear-gradient(135deg, color-mix(in srgb, var(--theme-primary) 80%, white) 0%, var(--theme-primary) 100%) !important;
        }

        .properties-page-container .grid.grid-cols-2.md\\:grid-cols-4.gap-4 > div {
          background-color: #f9fafb !important;
          border: 1px solid #e5e7eb !important;
          padding: 1.25rem !important;
        }
        .dark .properties-page-container .grid.grid-cols-2.md\\:grid-cols-4.gap-4 > div {
          background: rgba(15, 23, 42, 0.7) !important;
          border: 1px solid rgba(71, 85, 105, 0.2) !important;
        }

        .properties-page-container .grid .text-sm.font-medium {
          color: #6b7280 !important;
        }
        .dark .properties-page-container .grid .text-sm.font-medium {
          color: #94a3b8 !important;
        }

        .properties-page-container .grid > div:nth-child(1) .text-3xl {
            color: #111827 !important;
        }
        .dark .properties-page-container .grid > div:nth-child(1) .text-3xl {
            color: #f8fafc !important;
        }
        .properties-page-container .grid > div:nth-child(2) .text-3xl {
            color: #16a34a !important;
        }
        .properties-page-container .grid > div:nth-child(3) .text-3xl {
            color: #d97706 !important;
        }
        .properties-page-container .grid > div:nth-child(4) .text-3xl {
            color: #2563eb !important;
        }

        .properties-page-container .from-indigo-600 {
          background: ${currentThemeColors.gradientCSS} !important;
          color: white !important;
          border-radius: 1rem !important;
          border: none !important;
          box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1) !important;
        }

        .properties-page-container .from-indigo-600 h1 {
          color: white !important;
        }

        .properties-page-container .from-indigo-600 .text-white\\/90 {
          color: white !important;
          opacity: 0.9;
        }

        .properties-page-container .from-indigo-600 .border-white\\/30 {
          background-color: hsla(0, 0%, 100%, 0.1) !important;
          border-color: hsla(0, 0%, 100%, 0.2) !important;
          color: white !important;
          backdrop-filter: blur(4px);
        }
        .properties-page-container .from-indigo-600 .border-white\\/30:hover {
          background-color: hsla(0, 0%, 100%, 0.2) !important;
        }

        .properties-page-container .from-indigo-600 .bg-white.text-indigo-600 {
          background-color: white !important;
          color: var(--theme-primary) !important;
        }

        .properties-page-container .bg-white\\/10 {
          background: hsla(0, 0%, 100%, 0.1) !important;
          border-color: hsla(0, 0%, 100%, 0.2) !important;
          backdrop-filter: blur(10px);
          transition: background-color 0.3s ease;
        }
        .properties-page-container .bg-white\\/10:hover {
          background: hsla(0, 0%, 100%, 0.2) !important;
        }

        .properties-page-container .bg-white\\/10 .text-white\\/80 {
          color: white !important;
          opacity: 0.85;
          font-weight: 500;
        }
        .properties-page-container .bg-white\\/10 .text-3xl {
          color: white !important;
        }

        .properties-page-container .text-green-300 { color: #bef264 !important; }
        .properties-page-container .text-yellow-300 { color: #fde047 !important; }
        .properties-page-container .text-blue-300 { color: #93c5fd !important; }

        .properties-page-container > div > .space-y-6 > .bg-white {
          border-radius: 1rem !important;
          border: 1px solid #e5e7eb !important;
        }
        .dark .properties-page-container > div > .space-y-6 > .bg-white {
          border: 1px solid rgba(71, 85, 105, 0.2) !important;
        }

        .properties-page-container .grid .group.overflow-hidden {
          border-radius: 1rem !important;
          transition: transform 0.3s ease, box-shadow 0.3s ease !important;
        }
        .properties-page-container .grid .group.overflow-hidden:hover {
          transform: translateY(-5px);
          box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1) !important;
        }
        .dark .properties-page-container .grid .group.overflow-hidden:hover {
          box-shadow: 0 20px 40px rgba(0,0,0,0.7) !important;
        }

        .properties-page-container .space-y-3 > .hover\\:shadow-lg {
          border-radius: 1rem !important;
          transition: transform 0.3s ease, box-shadow 0.3s ease !important;
        }
        .properties-page-container .space-y-3 > .hover\\:shadow-lg:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07) !important;
        }

        /* Sharp corners mode for properties page */
        .sharp-corners .properties-page-container .grid .group.overflow-hidden,
        .sharp-corners .properties-page-container .space-y-3 > .hover\\:shadow-lg,
        .sharp-corners .properties-page-container .from-indigo-600,
        .sharp-corners .properties-page-container > div > .space-y-6 > .bg-white,
        .sharp-corners .properties-page-container .bg-white\\/10,
        .sharp-corners .properties-page-container [class*="rounded"] {
          border-radius: 0 !important;
        }
      ` }} />

      <div className="flex h-screen bg-gray-50 dark:bg-gray-950">
        {/* Left Sidebar */}
        <aside
          className={`sidebar ${sidebarOpen ? 'open' : ''}`}
          style={{
            position: 'fixed',
            left: 0,
            top: 0,
            height: '100vh',
            width: '260px',
            background: menuColors.bg,
            borderRight: `1px solid ${menuColors.border}`,
            display: 'flex',
            flexDirection: 'column',
            zIndex: 40,
            boxShadow: theme === 'dark' ? '2px 0 15px rgba(0,0,0,0.3)' : '2px 0 10px rgba(0,0,0,0.05)'
          }}>

          {/* Logo Header */}
          <div className="p-5 border-b" style={{ borderColor: menuColors.border, background: theme === 'dark' ? 'rgba(0,0,0,0.2)' : 'rgba(0,0,0,0.01)' }}>
            <Link
              to={createPageUrl('Dashboard')}
              className="flex items-center gap-3 no-underline group">

              <div
                className="w-11 h-11 rounded-2xl flex items-center justify-center flex-shrink-0 transition-all duration-300 group-hover:scale-105"
                style={{
                  background: currentThemeColors.gradientCSS,
                  boxShadow: `0 8px 24px ${currentThemeColors.primary}40`
                }}>

                <svg width="24" height="24" viewBox="0 0 28 28" fill="none">
                  <path d="M14 4L24 12H20V22H8V12H4L14 4Z" fill="white" fillOpacity="0.95" />
                </svg>
              </div>
              <div className="flex flex-col">
                <span 
                  className="text-lg font-bold tracking-tight"
                  style={{
                    color: theme === 'dark' ? '#f1f5f9' : '#1e293b'
                  }}
                >
                  RealtyMind
                </span>
                <span className="text-[10px] font-medium tracking-wide" style={{ color: menuColors.text, opacity: 0.6 }}>The Mind Behind Every Deal</span>
              </div>
            </Link>
          </div>

          {/* Navigation */}
          <nav
            ref={sidebarScrollRef}
            style={{ flex: 1, overflowY: 'auto', padding: '12px 10px' }}>

            <DragDropContext onDragEnd={onDragEnd}>
              <Droppable droppableId="sidebarNav">
                {(provided) =>
                <div ref={provided.innerRef} {...provided.droppableProps}>
                    {navItems.map((item, index) => {
                    if (!item || !item.name) return null;
                    const isActive = item.path && location.pathname === createPageUrl(item.path);
                    const isSectionOpen = openSections.has(item.name);

                    return (
                      <Draggable key={item.name} draggableId={item.name} index={index}>
                          {(provided) =>
                        <div
                          ref={provided.innerRef}
                          {...provided.draggableProps}
                          style={{ ...provided.draggableProps.style, marginBottom: '4px' }}>

                              {item.children ?
                          <div>
                                  <div
                              {...provided.dragHandleProps}
                              onClick={() => toggleSection(item.name)}
                              style={{
                                width: '100%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '11px 14px',
                                borderRadius: '12px',
                                color: isSectionOpen ? currentThemeColors.primary : menuColors.text,
                                background: isSectionOpen ? theme === 'dark' ? 'rgba(255,255,255,0.06)' : `${currentThemeColors.primary}08` : 'transparent',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: 600,
                                letterSpacing: '0.01em',
                                transition: 'all 0.2s ease'
                              }}>

                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                      <div style={{
                                        width: '32px',
                                        height: '32px',
                                        borderRadius: '10px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        background: isSectionOpen ? `${currentThemeColors.primary}15` : theme === 'dark' ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)',
                                        transition: 'all 0.2s ease'
                                      }}>
                                        <item.icon className="w-4 h-4" style={{ opacity: isSectionOpen ? 1 : 0.7 }} />
                                      </div>
                                      <span>{item.name}</span>
                                    </div>
                                    <ChevronRight
                                    className="w-4 h-4"
                                    style={{
                                    transform: isSectionOpen ? 'rotate(90deg)' : 'rotate(0deg)',
                                    transition: 'transform 0.25s ease',
                                    opacity: 0.4
                                    }} />

                                  </div>
                                  
                                  {isSectionOpen &&
                                  <Droppable droppableId={`category-${item.name}`} type="CHILD">
                                      {(droppableProvided) =>
                                  <div
                                  ref={droppableProvided.innerRef}
                                  {...droppableProvided.droppableProps}
                                  style={{ marginLeft: '20px', marginTop: '6px', borderLeft: `2px solid ${theme === 'dark' ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)'}`, paddingLeft: '12px' }}>

                                          {item.children.map((childItem, childIndex) => {
                                  if (!childItem || !childItem.name || !childItem.path) return null;
                                  const isChildActive = location.pathname === createPageUrl(childItem.path);

                                  return (
                                    <Draggable key={childItem.name} draggableId={`${item.name}-${childItem.name}`} index={childIndex}>
                                                {(childProvided) =>
                                      <div
                                        ref={childProvided.innerRef}
                                        {...childProvided.draggableProps}
                                        className="group">

                                                    <Link
                                                    to={createPageUrl(childItem.path)}
                                                    style={{
                                                      display: 'flex',
                                                      alignItems: 'center',
                                                      gap: '10px',
                                                      padding: '9px 12px',
                                                      borderRadius: '10px',
                                                      color: isChildActive ? currentThemeColors.primary : menuColors.text,
                                                      background: isChildActive ? theme === 'dark' ? `${currentThemeColors.primary}18` : `${currentThemeColors.primary}10` : 'transparent',
                                                      textDecoration: 'none',
                                                      fontSize: '13px',
                                                      fontWeight: isChildActive ? 600 : 450,
                                                      letterSpacing: '0.005em',
                                                      transition: 'all 0.18s ease'
                                                    }}
                                                    className="hover:bg-slate-100 dark:hover:bg-slate-800/50">

                                                      <span {...childProvided.dragHandleProps} className="opacity-0 group-hover:opacity-30 cursor-grab">
                                                        <GripVertical className="w-3 h-3" />
                                                      </span>
                                                      <childItem.icon className="w-[15px] h-[15px]" style={{ opacity: isChildActive ? 1 : 0.55 }} />
                                                      <span className="flex-1 truncate">{childItem.name}</span>
                                                      {childItem.attentionCount > 0 &&
                                          <span className="text-[10px] font-bold text-red-600 bg-red-100 dark:bg-red-900/50 px-1.5 py-0.5 rounded-full">!</span>
                                          }
                                                      {childItem.badge &&
                                          <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full text-white ${childItem.badge.color}`}>
                                                          {childItem.badge.text}
                                                        </span>
                                          }
                                                      {childItem.count > 0 && !childItem.badge && !childItem.attentionCount &&
                                          <span className="text-[10px] text-slate-500 bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded-full">
                                                          {childItem.count}
                                                        </span>
                                          }
                                                    </Link>
                                                  </div>
                                      }
                                              </Draggable>);

                                })}
                                          {droppableProvided.placeholder}
                                        </div>
                              }
                                    </Droppable>
                            }
                                </div> :

                          <Link
                            to={createPageUrl(item.path)}
                            {...provided.dragHandleProps}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '12px',
                              padding: '11px 14px',
                              borderRadius: '12px',
                              color: isActive ? '#fff' : menuColors.text,
                              background: isActive ? currentThemeColors.gradientCSS : 'transparent',
                              textDecoration: 'none',
                              fontSize: '13px',
                              fontWeight: isActive ? 600 : 500,
                              letterSpacing: '0.01em',
                              boxShadow: isActive ? `0 6px 20px ${currentThemeColors.primary}35` : 'none',
                              transition: 'all 0.2s ease'
                            }}
                            className="hover:bg-slate-100 dark:hover:bg-slate-800/50">

                                  <div style={{
                                    width: '32px',
                                    height: '32px',
                                    borderRadius: '10px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    background: isActive ? 'rgba(255,255,255,0.2)' : theme === 'dark' ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)'
                                  }}>
                                    <item.icon className="w-4 h-4" />
                                  </div>
                                  <span>{item.name}</span>
                                </Link>
                          }
                            </div>
                        }
                        </Draggable>);

                  })}
                    {provided.placeholder}
                  </div>
                }
              </Droppable>
            </DragDropContext>
          </nav>

          {/* Bottom User Section */}
          <div style={{ padding: '14px', borderTop: `1px solid ${menuColors.border}`, background: theme === 'dark' ? 'rgba(0,0,0,0.2)' : 'rgba(0,0,0,0.01)' }}>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <button
                style={{
                  width: '100%',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  padding: '12px',
                  borderRadius: '14px',
                  background: theme === 'dark' ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.02)',
                  border: `1px solid ${theme === 'dark' ? 'rgba(100,116,139,0.3)' : 'rgba(0,0,0,0.04)'}`,
                  cursor: 'pointer',
                  textAlign: 'left',
                  transition: 'all 0.2s ease'
                }}
                className="hover:bg-slate-100 dark:hover:bg-slate-700/50">

                  {user?.profile_photo_url ? (
                    <img 
                      src={user.profile_photo_url} 
                      alt={user.full_name}
                      className="h-10 w-10 rounded-full object-cover"
                      style={{ boxShadow: `0 4px 12px ${currentThemeColors.primary}30` }}
                    />
                  ) : (
                    <Avatar className="h-10 w-10">
                      <AvatarFallback style={{ background: currentThemeColors.gradientCSS, color: '#fff', fontWeight: 600, fontSize: '14px', boxShadow: `0 4px 12px ${currentThemeColors.primary}30` }}>
                        {user?.full_name?.charAt(0) || 'U'}
                      </AvatarFallback>
                    </Avatar>
                  )}
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <p style={{ fontSize: '13px', fontWeight: 600, color: theme === 'dark' ? '#f1f5f9' : '#1e293b', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', letterSpacing: '0.01em' }}>
                      {user?.full_name}
                    </p>
                    <p style={{ fontSize: '11px', color: menuColors.text, opacity: 0.6, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', marginTop: '2px' }}>
                      {user?.email}
                    </p>
                  </div>
                </button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end" className="w-56">
                <DropdownMenuItem onClick={() => navigate(createPageUrl("Settings"))}>
                  <Settings className="w-4 h-4 mr-2" /> Settings
                </DropdownMenuItem>
                <DropdownMenuItem onClick={toggleTheme}>
                  {theme === 'dark' ? <Sun className="w-4 h-4 mr-2" /> : <Moon className="w-4 h-4 mr-2" />}
                  {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem onClick={handleLogout} className="text-red-600">
                  <LogOut className="w-4 h-4 mr-2" /> Logout
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </aside>

        {/* Mobile Overlay */}
        {sidebarOpen &&
        <div
          className="lg:hidden fixed inset-0 bg-black/50 z-30"
          onClick={() => setSidebarOpen(false)} />

        }

        {/* Main Content Area */}
        <div className="flex-1 flex flex-col overflow-hidden main-content-wrapper" style={{ marginLeft: '260px' }}>
          <style dangerouslySetInnerHTML={{ __html: `
            @media (max-width: 1023px) {
              .main-content-wrapper { margin-left: 0 !important; }
            }
          `}} />





          <main
            ref={mainContentRef}
            style={{
              flex: 1, // Main content takes remaining height
              overflowY: 'auto'
            }}
            className={`
              ${currentPageName === 'Properties' ? 'properties-page-container' : ''}
              ${theme === 'light' ? 'bg-slate-50' : ''}
            `}>

            {/* Global Weather/Forecast Banner - show on all pages except Dashboard */}
            {currentPageName !== 'Dashboard' && (
              <div className="px-6 pt-6 pb-2">
                <NextEventBanner />
              </div>
            )}

            <div style={{ padding: currentPageName === 'Properties' ? '0' : currentPageName === 'Dashboard' ? '0' : '24px', paddingTop: currentPageName === 'Dashboard' ? '0' : '16px' }}>
              {children}
            </div>
          </main>

          {/* Scroll to Top Button */}
          <ScrollToTop scrollContainerRef={mainContentRef} />

          {/* Jackie AI - Fixed to Bottom Right Corner */}
          <div
            style={{
              position: 'fixed',
              bottom: '24px',
              right: '24px',
              zIndex: 99999
            }}
            className="pointer-events-auto">

            <AIAssistant />
          </div>

          {/* NPS Widget - Fixed to Bottom Right, below Jackie */}
          <div
            style={{
              position: 'fixed',
              bottom: '100px',
              right: '24px',
              zIndex: 99998
            }}
            className="pointer-events-auto">

            <NPSWidget user={user} currentPageName={currentPageName} />
          </div>
        </div>
      </div>

      {showProfileSetup &&
      <AgentProfileSetup
        user={user}
        onClose={() => setShowProfileSetup(false)}
        onComplete={() => {
          queryClient.invalidateQueries({ queryKey: ['user'] });
          setShowProfileSetup(false);
        }} />

      }

      {/* Onboarding Tour for new users */}
      {user && !user.onboarding_completed &&
      <OnboardingTour
        user={user}
        onComplete={() => {
          queryClient.invalidateQueries({ queryKey: ['user'] });
        }} />

      }

      <BreakReminder />

          {/* Jackie Welcome Modal - Shows once per day */}
          <JackieWelcomeModal />

          {/* Real-time notifications for messages and hot leads */}
          <RealTimeNotifications user={user} />

          {/* Task due notification popup */}
          <TaskDueNotification user={user} />
          </div>);

          }

          export default function Layout({ children, currentPageName }) {
  return (
    <WorkflowProvider>
      <LayoutContent children={children} currentPageName={currentPageName} />
    </WorkflowProvider>);

}

import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import { 
    Plus, Search, Filter, Sparkles, TrendingUp, Phone, Mail, Calendar, 
    User, MapPin, DollarSign, Zap, Clock, Star, AlertCircle, CheckCircle,
    Brain, Target, ArrowRight, MessageSquare, BarChart3, Loader2, ChevronDown,
    Home, Eye, ThumbsUp, ThumbsDown, RefreshCw, Grid3x3, List, ArrowUpDown, ArrowUp, ArrowDown,
    UserCheck, Building2, ArrowLeft, Bell, Activity, Globe, ExternalLink, Facebook, 
    Linkedin, Instagram, Twitter, Heart, Tag, FileText, Edit, X, CheckCircle2
} from 'lucide-react';
import { Progress } from '@/components/ui/progress';
import FollowUpWidget from '../components/leads/FollowUpWidget';
import ClientCommunicationPanel from '../components/communication/ClientCommunicationPanel';
import LoadingSpinner from '../components/common/LoadingSpinner';
import ActivityLogger from '../components/common/ActivityLogger';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { motion, AnimatePresence } from 'framer-motion';
import { format, parseISO, isToday, isThisWeek } from 'date-fns';

const SocialIcon = ({ platform }) => {
    const icons = {
        facebook: <Facebook className="w-4 h-4" />,
        linkedin: <Linkedin className="w-4 h-4" />,
        instagram: <Instagram className="w-4 h-4" />,
        twitter: <Twitter className="w-4 h-4" />,
        default: <Globe className="w-4 h-4" />
    };
    return icons[platform] || icons.default;
};

const IntentScoreBadge = ({ score, type }) => {
    const getScoreConfig = (score) => {
        if (score >= 80) return { label: 'Hot', color: 'bg-red-500', textColor: 'text-white' };
        if (score >= 60) return { label: 'Warm', color: 'bg-orange-500', textColor: 'text-white' };
        if (score >= 40) return { label: 'Lukewarm', color: 'bg-yellow-500', textColor: 'text-white' };
        if (score >= 20) return { label: 'Cool', color: 'bg-blue-500', textColor: 'text-white' };
        return { label: 'Cold', color: 'bg-slate-400', textColor: 'text-white' };
    };

    const config = getScoreConfig(score);
    
    return (
        <div className="flex items-center gap-2">
            <Badge className={`${config.color} ${config.textColor} flex items-center gap-1`}>
                <Target className="w-3 h-3" />
                {config.label} {type}
            </Badge>
            <span className="text-xs font-semibold text-slate-600 dark:text-slate-400">{score}/100</span>
        </div>
    );
};

const IntentSignalCard = ({ signal }) => {
    const getIconAndColor = (category) => {
        if (category === 'buyer') return { Icon: Home, color: 'bg-blue-50 dark:bg-blue-900/20 border-blue-200' };
        if (category === 'seller') return { Icon: DollarSign, color: 'bg-green-50 dark:bg-green-900/20 border-green-200' };
        return { Icon: Activity, color: 'bg-slate-50 dark:bg-slate-900/20 border-slate-200' };
    };
    
    const { Icon, color } = getIconAndColor(signal.category);
    
    return (
        <div className={`flex items-start gap-3 p-3 rounded-lg ${color} border`}>
            <div className="p-2 rounded-lg bg-white dark:bg-slate-800 shadow-sm">
                <Icon className="w-4 h-4 text-indigo-600" />
            </div>
            <div className="flex-1">
                <p className="text-sm font-semibold text-slate-900 dark:text-white">{signal.title}</p>
                <p className="text-xs text-slate-600 dark:text-slate-400 mt-0.5">{signal.description}</p>
                {signal.timestamp && (
                    <p className="text-xs text-slate-500 mt-1">
                        {new Date(signal.timestamp).toLocaleDateString()}
                    </p>
                )}
            </div>
            <Badge variant="outline" className="text-xs">+{signal.score}</Badge>
        </div>
    );
};

const LeadScoreBadge = ({ score }) => {
    const getScoreColor = () => {
        if (score >= 80) return 'bg-green-500';
        if (score >= 60) return 'bg-blue-500';
        if (score >= 40) return 'bg-amber-500';
        return 'bg-red-500';
    };

    const getScoreLabel = () => {
        if (score >= 80) return 'Hot';
        if (score >= 60) return 'Warm';
        if (score >= 40) return 'Cool';
        return 'Cold';
    };

    return (
        <div className="flex items-center gap-2">
            <div className={`w-12 h-12 rounded-full ${getScoreColor()} flex items-center justify-center text-white font-bold text-sm shadow-lg`}>
                {score}
            </div>
            <div className="text-xs">
                <div className="font-semibold text-slate-700 dark:text-slate-200">{getScoreLabel()}</div>
                <div className="text-slate-500">Score</div>
            </div>
        </div>
    );
};

const AIInsightCard = ({ lead, attomData, onAction, onInsightsGenerated }) => {
    const [isGenerating, setIsGenerating] = useState(false);
    const [insights, setInsights] = useState(null);

    const generateInsights = async () => {
        setIsGenerating(true);
        try {
            // Fetch Zillow data for additional market insights
            let zillowInfo = '';
            if (lead.property_address) {
                try {
                    const zillowResponse = await base44.functions.invoke('searchZillow', {
                        address: lead.property_address
                    });
                    
                    if (zillowResponse?.data) {
                        const zillow = zillowResponse.data;
                        zillowInfo = `

Zillow Market Data:
- Current Listing Status: ${zillow.listingStatus || 'N/A'}
- Zillow Estimate: $${zillow.zestimate?.toLocaleString() || 'N/A'}
- Listing Price: $${zillow.price?.toLocaleString() || 'N/A'}
- Days on Zillow: ${zillow.daysOnZillow || 'N/A'}
- Price Change: ${zillow.priceChange || 'None'}
- Views Last 30 Days: ${zillow.pageViewCount || 'N/A'}
- Home Type: ${zillow.homeType || 'N/A'}
- MLS Number: ${zillow.mlsid || 'N/A'}
- Description: ${zillow.description ? zillow.description.substring(0, 200) + '...' : 'N/A'}`;
                    }
                } catch (err) {
                    console.log('Zillow data not available:', err.message);
                }
            }

            const attomInfo = attomData?.avmValue || attomData?.propertyInfo ? `

ATTOM Property Data:
- AVM Estimated Value: $${attomData.avmValue?.toLocaleString() || 'N/A'}
- Building Size: ${attomData.propertyInfo?.building?.size?.bldgSize?.toLocaleString() || 'N/A'} sqft
- Bedrooms: ${attomData.propertyInfo?.building?.rooms?.beds || 'N/A'}
- Bathrooms: ${attomData.propertyInfo?.building?.rooms?.bathstotal || 'N/A'}
- Year Built: ${attomData.propertyInfo?.summary?.yearbuilt || 'N/A'}
- Property Type: ${attomData.propertyInfo?.summary?.proptype?.replace('_', ' ') || 'N/A'}
- Lot Size: ${attomData.propertyInfo?.lot?.lotsize1 || 'N/A'} sqft
- Last Sale Date: ${attomData.propertyInfo?.sale?.saleTransDate || 'N/A'}
- Last Sale Price: $${attomData.propertyInfo?.sale?.amount?.saleAmt?.toLocaleString() || 'N/A'}
- Tax Assessment: $${attomData.propertyInfo?.assessment?.assessed?.assdttlvalue?.toLocaleString() || 'N/A'}
- School District: ${attomData.propertyInfo?.area?.schooldistrict || 'N/A'}
- Neighborhood: ${attomData.propertyInfo?.area?.subdname || 'N/A'}` : '';

            const result = await base44.integrations.Core.InvokeLLM({
                prompt: `Analyze this real estate lead and provide actionable insights${attomInfo || zillowInfo ? ' for why their property may not have sold' : ''}:
                
Lead Info:
- Name: ${lead.name}
- Status: ${lead.status}
- Score: ${lead.score || 'Not scored'}
- Source: ${lead.lead_source || 'Unknown'}
- Email: ${lead.email}
- Phone: ${lead.phone || 'Not provided'}
- Property Address: ${lead.property_address || 'Not provided'}
- Notes: ${lead.notes || 'No notes'}
- Created: ${lead.created_date}${attomInfo}${zillowInfo}

${attomInfo || zillowInfo ? 'Use the ATTOM and Zillow data to provide specific insights about pricing, property condition, market positioning, visibility, and potential issues that may have prevented the sale. Consider days on market, price changes, and view counts.' : 'Provide insights about the lead quality, best contact approach, and conversion potential.'}

Provide concise insights in JSON format.`,
                response_json_schema: {
                    type: "object",
                    properties: {
                        quality_assessment: { type: "string" },
                        best_contact_time: { type: "string" },
                        recommended_action: { type: "string" },
                        conversion_probability: { type: "string" },
                        concerns: { type: "string" },
                        key_strengths: { type: "string" }
                    }
                }
            });
            setInsights(result);
            onInsightsGenerated?.(result);
        } catch (error) {
            toast.error("Failed to generate AI insights");
        } finally {
            setIsGenerating(false);
        }
    };

    return (
        <Card className="mt-4 bg-gradient-to-br from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 border-purple-200 dark:border-purple-800">
            <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-base">
                    <Brain className="w-5 h-5 text-purple-600" />
                    AI Insights
                </CardTitle>
            </CardHeader>
            <CardContent>
                {!insights ? (
                    <Button onClick={generateInsights} disabled={isGenerating} className="w-full bg-purple-600 hover:bg-purple-700">
                        {isGenerating ? (
                            <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Analyzing...</>
                        ) : (
                            <><Sparkles className="w-4 h-4 mr-2" /> Generate AI Insights</>
                        )}
                    </Button>
                ) : (
                    <div className="space-y-3 text-sm">
                        <div>
                            <div className="font-semibold text-purple-900 dark:text-purple-100 mb-1">Quality Assessment</div>
                            <p className="text-slate-700 dark:text-slate-300">{insights.quality_assessment}</p>
                        </div>
                        <div>
                            <div className="font-semibold text-purple-900 dark:text-purple-100 mb-1">Best Contact Time</div>
                            <p className="text-slate-700 dark:text-slate-300">{insights.best_contact_time}</p>
                        </div>
                        <div>
                            <div className="font-semibold text-purple-900 dark:text-purple-100 mb-1">Recommended Action</div>
                            <p className="text-slate-700 dark:text-slate-300">{insights.recommended_action}</p>
                        </div>
                        <div>
                            <div className="font-semibold text-purple-900 dark:text-purple-100 mb-1">Conversion Probability</div>
                            <p className="text-slate-700 dark:text-slate-300">{insights.conversion_probability}</p>
                        </div>
                        {insights.key_strengths && (
                            <div>
                                <div className="font-semibold text-green-900 dark:text-green-100 mb-1 flex items-center gap-1">
                                    <ThumbsUp className="w-4 h-4" /> Key Strengths
                                </div>
                                <p className="text-slate-700 dark:text-slate-300">{insights.key_strengths}</p>
                            </div>
                        )}
                        {insights.concerns && (
                            <div>
                                <div className="font-semibold text-red-900 dark:text-red-100 mb-1 flex items-center gap-1">
                                    <AlertCircle className="w-4 h-4" /> Concerns
                                </div>
                                <p className="text-slate-700 dark:text-slate-300">{insights.concerns}</p>
                            </div>
                        )}
                        <Button onClick={generateInsights} variant="outline" size="sm" className="w-full mt-2">
                            <RefreshCw className="w-3 h-3 mr-2" /> Refresh Insights
                        </Button>
                    </div>
                )}
            </CardContent>
        </Card>
    );
};

const statusConfig = {
    new: { color: 'bg-blue-100 text-blue-700 border-blue-300', icon: Star, label: 'New' },
    contacted: { color: 'bg-purple-100 text-purple-700 border-purple-300', icon: Phone, label: 'Contacted' },
    qualified: { color: 'bg-green-100 text-green-700 border-green-300', icon: CheckCircle, label: 'Qualified' },
    nurturing: { color: 'bg-amber-100 text-amber-700 border-amber-300', icon: Clock, label: 'Nurturing' },
    unqualified: { color: 'bg-red-100 text-red-700 border-red-300', icon: AlertCircle, label: 'Unqualified' },
    closed: { color: 'bg-slate-100 text-slate-700 border-slate-300', icon: CheckCircle, label: 'Closed' },
};

const SortableHeader = ({ field, label, sortField, sortDirection, setSortField, setSortDirection, className }) => {
    const isActive = sortField === field;
    
    const handleClick = () => {
        if (isActive) {
            setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
        } else {
            setSortField(field);
            setSortDirection('desc');
        }
    };

    return (
        <button
            onClick={handleClick}
            className={`flex items-center gap-1 hover:text-slate-700 dark:hover:text-slate-300 transition-colors cursor-pointer ${className} ${isActive ? 'text-primary' : ''}`}
        >
            <span>{label}</span>
            {isActive ? (
                sortDirection === 'asc' ? <ArrowUp className="w-3 h-3" /> : <ArrowDown className="w-3 h-3" />
            ) : (
                <ArrowUpDown className="w-3 h-3 opacity-40" />
            )}
        </button>
    );
};

const LeadListRow = ({ lead, onClick, onQuickAction }) => {
    const config = statusConfig[lead.status] || statusConfig.new;
    const StatusIcon = config.icon;

    const getScoreColor = (score) => {
        if (score >= 80) return 'bg-green-500';
        if (score >= 60) return 'bg-blue-500';
        if (score >= 40) return 'bg-amber-500';
        return 'bg-red-500';
    };

    const getLeadTypeBadges = () => {
        const badges = [];
        const type = lead.lead_type || 'unknown';
        
        if (type === 'buyer' || type === 'buyer_seller' || type === 'buyer_renter' || type === 'all') {
            badges.push(<span key="buyer" className="px-1.5 py-0.5 text-[10px] font-semibold bg-blue-100 text-blue-700 rounded">B</span>);
        }
        if (type === 'seller' || type === 'buyer_seller' || type === 'seller_renter' || type === 'all') {
            badges.push(<span key="seller" className="px-1.5 py-0.5 text-[10px] font-semibold bg-amber-100 text-amber-700 rounded">S</span>);
        }
        if (type === 'renter' || type === 'buyer_renter' || type === 'seller_renter' || type === 'all') {
            badges.push(<span key="renter" className="px-1.5 py-0.5 text-[10px] font-semibold bg-purple-100 text-purple-700 rounded">R</span>);
        }
        
        return badges.length > 0 ? badges : null;
    };

    return (
        <motion.div
            layout
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: 20 }}
            transition={{ duration: 0.2 }}
        >
            <div 
                className="flex items-center gap-3 p-3 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-primary/50 hover:shadow-md transition-all cursor-pointer"
                onClick={onClick}
            >
                {/* Score */}
                <div className={`w-10 h-10 rounded-full ${getScoreColor(lead.score || 0)} flex items-center justify-center text-white font-bold text-xs flex-shrink-0`}>
                    {lead.score || 0}
                </div>

                {/* Name + Type */}
                <div className="w-44 flex-shrink-0">
                    <div className="flex items-center gap-1.5">
                        <p className="font-semibold text-slate-900 dark:text-white truncate">{lead.name}</p>
                        <div className="flex gap-0.5">
                            {getLeadTypeBadges()}
                        </div>
                    </div>
                    {lead.property_address && (
                        <p className="text-xs text-amber-600 truncate flex items-center gap-1">
                            <MapPin className="w-3 h-3" />
                            {lead.property_address}
                        </p>
                    )}
                </div>

                {/* Status */}
                <Badge className={`text-xs ${config.color} border flex-shrink-0 w-24 justify-center`}>
                    <StatusIcon className="w-3 h-3 mr-1" />
                    {config.label}
                </Badge>

                {/* Email */}
                <div className="flex items-center gap-1 text-slate-600 dark:text-slate-400 text-sm w-48 flex-shrink-0">
                    <Mail className="w-3 h-3 flex-shrink-0" />
                    <span className="truncate">{lead.email || '-'}</span>
                </div>

                {/* Phone */}
                <div className="flex items-center gap-1 text-slate-600 dark:text-slate-400 text-sm w-32 flex-shrink-0">
                    <Phone className="w-3 h-3 flex-shrink-0" />
                    <span className="truncate">{lead.phone || '-'}</span>
                </div>

                {/* Source */}
                <div className="flex items-center gap-1 text-slate-600 dark:text-slate-400 text-sm w-28 flex-shrink-0">
                    <Target className="w-3 h-3 flex-shrink-0" />
                    <span className="truncate">{lead.lead_source || '-'}</span>
                </div>

                {/* Date */}
                <div className="flex items-center gap-1 text-slate-500 text-xs w-24 flex-shrink-0">
                    <Calendar className="w-3 h-3" />
                    <span>{format(parseISO(lead.created_date), 'MMM d')}</span>
                </div>

                {/* Actions */}
                <div className="flex items-center gap-1 ml-auto flex-shrink-0">
                    <Button size="sm" variant="ghost" className="h-8 w-8 p-0" onClick={(e) => { e.stopPropagation(); onQuickAction(lead, 'call'); }}>
                        <Phone className="w-4 h-4" />
                    </Button>
                    <Button size="sm" variant="ghost" className="h-8 w-8 p-0" onClick={(e) => { e.stopPropagation(); onQuickAction(lead, 'email'); }}>
                        <Mail className="w-4 h-4" />
                    </Button>
                    <Button size="sm" variant="ghost" className="h-8 w-8 p-0" onClick={(e) => { e.stopPropagation(); onQuickAction(lead, 'note'); }}>
                        <MessageSquare className="w-4 h-4" />
                    </Button>
                </div>
            </div>
        </motion.div>
    );
};

const getLeadTypeLabel = (type) => {
    const labels = {
        buyer: 'üîµ Buyer Lead',
        seller: 'üü° Seller Lead',
        renter: 'üü£ Renter Lead',
        buyer_seller: 'üîµüü° Buyer & Seller Lead',
        buyer_renter: 'üîµüü£ Buyer & Renter Lead',
        seller_renter: 'üü°üü£ Seller & Renter Lead',
        all: 'üîµüü°üü£ All',
        unknown: 'Unknown'
    };
    return labels[type] || 'Unknown';
};

const LeadCard = ({ lead, onClick, onQuickAction }) => {
    const [attomData, setAttomData] = React.useState(null);
    const [loadingAttom, setLoadingAttom] = React.useState(false);

    React.useEffect(() => {
        const fetchAttomData = async () => {
            if (!lead.property_address || attomData || loadingAttom) return;
            
            setLoadingAttom(true);
            try {
                const addressParts = lead.property_address.split(',').map(p => p.trim());
                const streetAddress = addressParts[0] || '';
                const cityStateZip = addressParts.slice(1).join(', ');
                
                const response = await base44.functions.invoke('attomPropertyData', {
                    action: 'comprehensiveReport',
                    address: streetAddress,
                    city: cityStateZip.split(',')[0]?.trim() || '',
                    state: cityStateZip.match(/[A-Z]{2}/)?.[0] || '',
                    zip: cityStateZip.match(/\d{5}/)?.[0] || ''
                });
                
                const propertyData = response?.data?.data;
                const avmValue = propertyData?.avmSnapshot?.property?.[0]?.avm?.amount?.value;
                const propertyInfo = propertyData?.expandedProfile?.property?.[0];
                
                if (avmValue || propertyInfo) {
                    setAttomData({ avmValue, propertyInfo });
                }
            } catch (err) {
                console.warn('Failed to fetch ATTOM data:', err);
            } finally {
                setLoadingAttom(false);
            }
        };

        fetchAttomData();
    }, [lead.property_address]);

    const config = statusConfig[lead.status] || statusConfig.new;
    const StatusIcon = config.icon;

    return (
        <motion.div
            layout
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95 }}
            whileHover={{ y: -4 }}
            transition={{ duration: 0.2 }}
        >
            <Card className="cursor-pointer hover:shadow-xl transition-all duration-300 border-2 hover:border-primary/50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm" onClick={onClick}>
                <CardContent className="p-4">
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex items-start gap-3 flex-1">
                            <div className="w-12 h-12 rounded-full bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center flex-shrink-0">
                                <User className="w-6 h-6 text-primary" />
                            </div>
                            <div className="flex-1 min-w-0">
                                <h3 className="font-bold text-lg text-slate-900 dark:text-white truncate">{lead.name}</h3>
                                <div className="flex items-center gap-2 mt-1 flex-wrap">
                                    <Badge className={`text-xs ${config.color} border`}>
                                        <StatusIcon className="w-3 h-3 mr-1" />
                                        {config.label}
                                    </Badge>
                                    {lead.lead_type && lead.lead_type !== 'unknown' && (
                                        <Badge variant="outline" className="text-xs">
                                            {getLeadTypeLabel(lead.lead_type)}
                                        </Badge>
                                    )}
                                    {lead.score && <LeadScoreBadge score={lead.score} />}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="space-y-2 text-sm">
                        {lead.email && (
                            <div className="flex items-center gap-2 text-slate-600 dark:text-slate-400">
                                <Mail className="w-4 h-4 flex-shrink-0" />
                                <span className="truncate">{lead.email}</span>
                            </div>
                        )}
                        {lead.phone && (
                            <div className="flex items-center gap-2 text-slate-600 dark:text-slate-400">
                                <Phone className="w-4 h-4 flex-shrink-0" />
                                <span>{lead.phone}</span>
                            </div>
                        )}
                        {lead.lead_source && (
                            <div className="flex items-center gap-2 text-slate-600 dark:text-slate-400">
                                <Target className="w-4 h-4 flex-shrink-0" />
                                <span>From: {lead.lead_source}</span>
                            </div>
                        )}
                        {lead.property_address && (
                            <div className="space-y-2">
                                <div className="flex items-start gap-2 text-amber-600 dark:text-amber-400">
                                    <MapPin className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                    <span className="line-clamp-2">{lead.property_address}</span>
                                </div>
                                
                                {loadingAttom && (
                                    <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 ml-6">
                                        <div className="w-3 h-3 border-2 border-slate-300 border-t-slate-600 rounded-full animate-spin"></div>
                                        Loading property data...
                                    </div>
                                )}
                                
                                {attomData && (
                                    <div className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                        <div className="flex items-center gap-2 mb-2">
                                            <Home className="w-4 h-4 text-blue-600 dark:text-blue-400" />
                                            <span className="text-xs font-semibold text-blue-900 dark:text-blue-300">ATTOM Property Data</span>
                                        </div>
                                        
                                        {attomData.avmValue && (
                                            <div className="mb-2">
                                                <p className="text-xs text-slate-600 dark:text-slate-400">AVM Estimated Value</p>
                                                <p className="text-lg font-bold text-blue-600 dark:text-blue-400">
                                                    ${attomData.avmValue.toLocaleString()}
                                                </p>
                                            </div>
                                        )}
                                        
                                        {attomData.propertyInfo && (
                                            <div className="grid grid-cols-2 gap-2 text-xs">
                                                {attomData.propertyInfo.building?.size?.bldgSize && (
                                                    <div>
                                                        <p className="text-slate-500 dark:text-slate-400">Size</p>
                                                        <p className="font-semibold text-slate-700 dark:text-slate-300">
                                                            {attomData.propertyInfo.building.size.bldgSize.toLocaleString()} sqft
                                                        </p>
                                                    </div>
                                                )}
                                                {attomData.propertyInfo.building?.rooms?.beds && (
                                                    <div>
                                                        <p className="text-slate-500 dark:text-slate-400">Beds/Baths</p>
                                                        <p className="font-semibold text-slate-700 dark:text-slate-300">
                                                            {attomData.propertyInfo.building.rooms.beds} / {attomData.propertyInfo.building.rooms.bathstotal || 0}
                                                        </p>
                                                    </div>
                                                )}
                                                {attomData.propertyInfo.summary?.yearbuilt && (
                                                    <div>
                                                        <p className="text-slate-500 dark:text-slate-400">Year Built</p>
                                                        <p className="font-semibold text-slate-700 dark:text-slate-300">
                                                            {attomData.propertyInfo.summary.yearbuilt}
                                                        </p>
                                                    </div>
                                                )}
                                                {attomData.propertyInfo.summary?.proptype && (
                                                    <div>
                                                        <p className="text-slate-500 dark:text-slate-400">Type</p>
                                                        <p className="font-semibold text-slate-700 dark:text-slate-300 capitalize">
                                                            {attomData.propertyInfo.summary.proptype.replace('_', ' ')}
                                                        </p>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                        <div className="flex items-center gap-2 text-slate-500 dark:text-slate-500 text-xs">
                            <Calendar className="w-3 h-3" />
                            <span>Added {format(parseISO(lead.created_date), 'MMM d, yyyy')}</span>
                        </div>
                    </div>

                    <div className="flex items-center gap-2 mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                        <Button size="sm" variant="outline" className="flex-1" onClick={(e) => { e.stopPropagation(); onQuickAction(lead, 'call'); }}>
                           <Phone className="w-3 h-3 mr-1" /> Call
                        </Button>
                        <Button size="sm" variant="outline" className="flex-1" onClick={(e) => { e.stopPropagation(); onQuickAction(lead, 'email'); }}>
                           <Mail className="w-3 h-3 mr-1" /> Email
                        </Button>
                        <Button size="sm" variant="outline" onClick={(e) => { e.stopPropagation(); onQuickAction(lead, 'note'); }}>
                           <MessageSquare className="w-3 h-3" />
                        </Button>
                    </div>
                </CardContent>
            </Card>
        </motion.div>
    );
};

const LeadDetailModal = ({ lead, isOpen, onClose, onUpdate, onConvert }) => {
    const [formData, setFormData] = useState(lead || {});
    const [showConvertDialog, setShowConvertDialog] = useState(false);
    const [attomData, setAttomData] = useState(null);
    const [loadingAttom, setLoadingAttom] = useState(false);
    const [aiInsights, setAiInsights] = useState(null);
    const queryClient = useQueryClient();

    const { data: leadActivities = [] } = useQuery({
        queryKey: ['leadActivities', lead?.id],
        queryFn: () => base44.entities.LeadActivity.filter({ lead_id: lead.id }),
        enabled: !!lead?.id
    });

    // Parse intent data
    const intentData = lead?.intent_data ? JSON.parse(lead.intent_data) : null;
    const socialProfiles = lead?.social_media_profiles ? JSON.parse(lead.social_media_profiles) : {};
    const lifeEvents = lead?.life_events ? JSON.parse(lead.life_events) : [];
    const interests = lead?.interests_hobbies ? JSON.parse(lead.interests_hobbies) : [];

    React.useEffect(() => {
        if (lead) {
            // Auto-detect seller leads from House Worth and Why Didn't It Sell sources
            const isSellerSource = lead.lead_source && (
                lead.lead_source.includes('House Worth') || 
                lead.lead_source.includes('Why Didnt It Sell')
            );
            
            const leadType = lead.lead_type || (isSellerSource ? 'seller' : 'unknown');
            
            setFormData({ ...lead, lead_type: leadType });
        }
    }, [lead]);

    React.useEffect(() => {
        const fetchAttomData = async () => {
            if (!lead?.property_address || attomData || loadingAttom) return;
            
            setLoadingAttom(true);
            try {
                const addressParts = lead.property_address.split(',').map(p => p.trim());
                const streetAddress = addressParts[0] || '';
                const cityStateZip = addressParts.slice(1).join(', ');
                
                const response = await base44.functions.invoke('attomPropertyData', {
                    action: 'comprehensiveReport',
                    address: streetAddress,
                    city: cityStateZip.split(',')[0]?.trim() || '',
                    state: cityStateZip.match(/[A-Z]{2}/)?.[0] || '',
                    zip: cityStateZip.match(/\d{5}/)?.[0] || ''
                });
                
                const propertyData = response?.data?.data;
                const avmValue = propertyData?.avmSnapshot?.property?.[0]?.avm?.amount?.value;
                const propertyInfo = propertyData?.expandedProfile?.property?.[0];
                
                if (avmValue || propertyInfo) {
                    setAttomData({ avmValue, propertyInfo });
                }
            } catch (err) {
                console.warn('Failed to fetch ATTOM data:', err);
            } finally {
                setLoadingAttom(false);
            }
        };

        fetchAttomData();
    }, [lead?.property_address]);

    const updateLeadMutation = useMutation({
        mutationFn: (data) => base44.entities.Lead.update(lead.id, data),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['leads'] });
            toast.success('Lead updated successfully');
            onUpdate?.();
        },
    });

    const handleSubmit = async (e) => {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        try {
            // Always use the latest aiInsights if available
            const dataToSave = {
                ...formData,
                score: parseInt(formData.score) || 0,
                ai_insights: aiInsights ? JSON.stringify(aiInsights) : (formData.ai_insights || null)
            };
            
            await updateLeadMutation.mutateAsync(dataToSave);
            toast.success('Lead saved successfully!');
        } catch (error) {
            toast.error('Failed to save: ' + error.message);
        }
    };

    if (!lead) return null;

    return (
        <>
            <Dialog open={isOpen} onOpenChange={onClose}>
                <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
                    <DialogHeader>
                        <DialogTitle className="flex items-center gap-2 text-2xl">
                            <User className="w-6 h-6 text-primary" />
                            {lead.name}
                        </DialogTitle>
                    </DialogHeader>

                    {/* AI Follow-up Widget */}
                    <FollowUpWidget leadId={lead?.id} />

                    {/* Convert Lead Banner */}
                    <Card className="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-green-200 dark:border-green-800">
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Sparkles className="w-5 h-5 text-green-600" />
                                    <div>
                                        <p className="font-semibold text-green-800 dark:text-green-200">Ready to convert this lead?</p>
                                        <p className="text-sm text-green-600 dark:text-green-400">Export as a Buyer or Seller to continue working with them</p>
                                    </div>
                                </div>
                                <Button 
                                    onClick={() => setShowConvertDialog(true)}
                                    className="bg-green-600 hover:bg-green-700"
                                >
                                    <ArrowRight className="w-4 h-4 mr-2" />
                                    Convert Lead
                                </Button>
                            </div>
                        </CardContent>
                    </Card>

                    {/* Intent Intelligence */}
                    {intentData && (
                        <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
                            <CardHeader>
                                <CardTitle className="text-lg flex items-center gap-2">
                                    <Sparkles className="w-5 h-5 text-indigo-600" />
                                    AI Intent Intelligence
                                </CardTitle>
                            </CardHeader>
                            <CardContent className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-white dark:bg-slate-800 p-4 rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-medium text-slate-600 dark:text-slate-400">Buyer Intent</span>
                                            <Zap className={`w-5 h-5 ${intentData.buyer_intent_score >= 60 ? 'text-red-500' : 'text-slate-400'}`} />
                                        </div>
                                        <Progress value={intentData.buyer_intent_score || 0} className="h-3 mb-2" />
                                        <IntentScoreBadge score={intentData.buyer_intent_score || 0} type="Buyer" />
                                    </div>
                                    
                                    <div className="bg-white dark:bg-slate-800 p-4 rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-medium text-slate-600 dark:text-slate-400">Seller Intent</span>
                                            <Home className={`w-5 h-5 ${intentData.seller_intent_score >= 60 ? 'text-red-500' : 'text-slate-400'}`} />
                                        </div>
                                        <Progress value={intentData.seller_intent_score || 0} className="h-3 mb-2" />
                                        <IntentScoreBadge score={intentData.seller_intent_score || 0} type="Seller" />
                                    </div>
                                </div>

                                {intentData.signals && intentData.signals.length > 0 && (
                                    <div>
                                        <h4 className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                                            <Bell className="w-4 h-4" />
                                            Recent Intent Signals ({intentData.signals.length})
                                        </h4>
                                        <div className="space-y-2 max-h-60 overflow-y-auto">
                                            {intentData.signals.map((signal, i) => (
                                                <IntentSignalCard key={i} signal={signal} />
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {intentData.recommended_actions && intentData.recommended_actions.length > 0 && (
                                    <div>
                                        <h4 className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                                            <Target className="w-4 h-4" />
                                            Recommended Actions
                                        </h4>
                                        <ul className="space-y-2">
                                            {intentData.recommended_actions.map((action, i) => (
                                                <li key={i} className="flex items-start gap-2 text-sm text-slate-700 dark:text-slate-300">
                                                    <CheckCircle2 className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                                                    {action}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </CardContent>
                        </Card>
                    )}

                    {/* Social Media Profiles */}
                    {Object.keys(socialProfiles).length > 0 && (
                        <Card>
                            <CardHeader>
                                <CardTitle className="text-lg flex items-center gap-2">
                                    <Globe className="w-5 h-5 text-purple-600" />
                                    Social Media Profiles
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="flex flex-wrap gap-3">
                                    {Object.entries(socialProfiles).map(([platform, url]) => (
                                        <a
                                            key={platform}
                                            href={url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                                        >
                                            <SocialIcon platform={platform} />
                                            <span className="text-sm font-medium capitalize">{platform}</span>
                                            <ExternalLink className="w-3 h-3" />
                                        </a>
                                    ))}
                                </div>
                            </CardContent>
                        </Card>
                    )}

                    {/* Life Events */}
                    {lifeEvents.length > 0 && (
                        <Card>
                            <CardHeader>
                                <CardTitle className="text-lg flex items-center gap-2">
                                    <Heart className="w-5 h-5 text-pink-600" />
                                    Life Events
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="space-y-3">
                                    {lifeEvents.map((event, i) => (
                                        <div key={i} className="flex items-start gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                                            <Calendar className="w-5 h-5 text-slate-400 mt-0.5" />
                                            <div>
                                                <p className="font-semibold text-slate-900 dark:text-white">{event.event}</p>
                                                {event.date && <p className="text-xs text-slate-500">{new Date(event.date).toLocaleDateString()}</p>}
                                                {event.details && <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">{event.details}</p>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </CardContent>
                        </Card>
                    )}

                    {/* Interests & Hobbies */}
                    {interests.length > 0 && (
                        <Card>
                            <CardHeader>
                                <CardTitle className="text-lg flex items-center gap-2">
                                    <Tag className="w-5 h-5 text-amber-600" />
                                    Interests & Hobbies
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="flex flex-wrap gap-2">
                                    {interests.map((interest, i) => (
                                        <Badge key={i} variant="outline" className="text-sm">
                                            {interest}
                                        </Badge>
                                    ))}
                                </div>
                            </CardContent>
                        </Card>
                    )}

                    <form onSubmit={handleSubmit}>
                        <div className="grid md:grid-cols-2 gap-6">
                            <div className="space-y-4">
                                <Card>
                                    <CardHeader>
                                        <CardTitle className="text-base">Contact Information</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-3">
                                        <div>
                                            <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Name</label>
                                            <Input
                                                value={formData.name || ''}
                                                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                                className="mt-1"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Email</label>
                                            <Input
                                                type="email"
                                                value={formData.email || ''}
                                                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                                className="mt-1"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Phone</label>
                                            <Input
                                                value={formData.phone || ''}
                                                onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                                                className="mt-1"
                                            />
                                        </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Property Address (for Seller Leads)</label>
                                        <Input
                                            value={formData.property_address || ''}
                                            onChange={(e) => setFormData({ ...formData, property_address: e.target.value })}
                                            className="mt-1"
                                            placeholder="123 Main St, City, State"
                                        />
                                    </div>
                                    </CardContent>
                                    </Card>

                                    <Card>
                                    <CardHeader>
                                    <CardTitle className="text-base">Preferences</CardTitle>
                                    </CardHeader>
                                <CardContent className="space-y-3">
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Preferred Areas</label>
                                        <Input
                                            value={formData.preferred_areas || ''}
                                            onChange={(e) => setFormData({ ...formData, preferred_areas: e.target.value })}
                                            className="mt-1"
                                            placeholder="Downtown, Marina District"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Timeline</label>
                                        <Select 
                                            value={formData.timeline || 'not_specified'} 
                                            onValueChange={(value) => setFormData({ ...formData, timeline: value })}
                                        >
                                            <SelectTrigger className="mt-1">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                <SelectItem value="not_specified">Not Specified</SelectItem>
                                                <SelectItem value="immediate">Immediate</SelectItem>
                                                <SelectItem value="1_3_months">1-3 months</SelectItem>
                                                <SelectItem value="3_6_months">3-6 months</SelectItem>
                                                <SelectItem value="6_12_months">6-12 months</SelectItem>
                                                <SelectItem value="over_year">Over a year</SelectItem>
                                            </SelectContent>
                                        </Select>
                                    </div>
                                    </CardContent>
                                    </Card>

                                    <Card>
                                    <CardHeader>
                                    <CardTitle className="text-base">Lead Details</CardTitle>
                                    </CardHeader>
                                <CardContent className="space-y-3">
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Lead Type</label>
                                        <Select value={formData.lead_type || 'unknown'} onValueChange={(value) => setFormData({ ...formData, lead_type: value })}>
                                            <SelectTrigger className="mt-1">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                <SelectItem value="unknown">Unknown</SelectItem>
                                                <SelectItem value="buyer">üîµ Buyer Only</SelectItem>
                                                <SelectItem value="seller">üü° Seller Only</SelectItem>
                                                <SelectItem value="renter">üü£ Renter Only</SelectItem>
                                                <SelectItem value="buyer_seller">üîµüü° Buyer & Seller</SelectItem>
                                                <SelectItem value="buyer_renter">üîµüü£ Buyer & Renter</SelectItem>
                                                <SelectItem value="seller_renter">üü°üü£ Seller & Renter</SelectItem>
                                                <SelectItem value="all">üîµüü°üü£ All (Buyer, Seller, Renter)</SelectItem>
                                            </SelectContent>
                                        </Select>
                                        <p className="text-xs text-slate-500 mt-1">Select all that apply to this lead</p>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Status</label>
                                        <Select value={formData.status} onValueChange={(value) => setFormData({ ...formData, status: value })}>
                                            <SelectTrigger className="mt-1">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                <SelectItem value="new">New</SelectItem>
                                                <SelectItem value="contacted">Contacted</SelectItem>
                                                <SelectItem value="qualified">Qualified</SelectItem>
                                                <SelectItem value="nurturing">Nurturing</SelectItem>
                                                <SelectItem value="unqualified">Unqualified</SelectItem>
                                                <SelectItem value="closed">Closed</SelectItem>
                                            </SelectContent>
                                        </Select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Lead Source</label>
                                        <Input
                                            value={formData.lead_source || ''}
                                            onChange={(e) => setFormData({ ...formData, lead_source: e.target.value })}
                                            className="mt-1"
                                            placeholder="e.g., Zillow, Referral, Website"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Score (0-100)</label>
                                        <Input
                                            type="number"
                                            min="0"
                                            max="100"
                                            value={formData.score || ''}
                                            onChange={(e) => setFormData({ ...formData, score: parseInt(e.target.value) || 0 })}
                                            className="mt-1"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Notes</label>
                                        <Textarea
                                            value={formData.notes || ''}
                                            onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                            className="mt-1"
                                            rows={4}
                                            placeholder="Add notes about this lead..."
                                        />
                                    </div>
                                </CardContent>
                            </Card>
                        </div>

                            <div className="space-y-4">
                                {loadingAttom && (
                                    <Card className="bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800">
                                        <CardContent className="p-4 flex items-center gap-3">
                                            <div className="w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                                            <span className="text-sm text-blue-700 dark:text-blue-300">Loading property data for AI analysis...</span>
                                        </CardContent>
                                    </Card>
                                )}
                                <AIInsightCard 
                                    lead={lead} 
                                    attomData={attomData} 
                                    onInsightsGenerated={(insights) => setAiInsights(insights)}
                                />
                            </div>
                        </div>

                    </form>
                    
                    {/* Save/Cancel Buttons - Always at bottom */}
                    <div className="flex justify-end gap-3 pt-6 border-t mt-6">
                        <Button type="button" onClick={onClose} variant="outline">
                            Close
                        </Button>
                        <Button 
                            type="button" 
                            onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                handleSubmit();
                            }} 
                            disabled={updateLeadMutation.isLoading} 
                            className="bg-primary hover:bg-primary/90"
                        >
                            <CheckCircle className="w-4 h-4 mr-2" />
                            {updateLeadMutation.isLoading ? 'Saving...' : 'Save Changes'}
                        </Button>
                    </div>

                    {/* Activity Logger */}
                    <ActivityLogger
                        entityType="lead"
                        entityId={lead.id}
                        entityData={{
                            name: lead.name,
                            email: lead.email,
                            phone: lead.phone,
                            address: lead.property_address
                        }}
                        activities={leadActivities}
                        onActivityLogged={() => {
                            queryClient.invalidateQueries({ queryKey: ['leadActivities', lead.id] });
                        }}
                    />

                    {/* Communication History */}
                    <Card>
                        <CardHeader>
                            <CardTitle className="text-lg flex items-center gap-2">
                                <MessageSquare className="w-5 h-5 text-indigo-600" />
                                Communication History
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            <ClientCommunicationPanel
                                clientType="lead"
                                clientId={lead.id}
                                clientData={{
                                    name: lead.name,
                                    email: lead.email,
                                    phone: lead.phone
                                }}
                            />
                        </CardContent>
                    </Card>

                    <div className="flex items-center gap-2 text-sm text-slate-500 pt-4 border-t">
                        <Calendar className="w-4 h-4" />
                        <span>
                            Added on {new Date(lead.created_date).toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </span>
                    </div>

                    {/* Save/Cancel Buttons - Always Visible */}
                    <div className="flex justify-end gap-3 pt-6 pb-2 border-t mt-6">
                        <Button type="button" onClick={onClose} variant="outline">
                            Close
                        </Button>
                        <Button 
                            type="button" 
                            onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                handleSubmit();
                            }} 
                            disabled={updateLeadMutation.isLoading} 
                            className="bg-primary hover:bg-primary/90"
                        >
                            <CheckCircle className="w-4 h-4 mr-2" />
                            {updateLeadMutation.isLoading ? 'Saving...' : 'Save Changes'}
                        </Button>
                    </div>
                </DialogContent>
            </Dialog>

            {/* Convert Lead Dialog */}
            <Dialog open={showConvertDialog} onOpenChange={setShowConvertDialog}>
                <DialogContent className="max-w-lg">
                    <DialogHeader>
                        <DialogTitle className="flex items-center gap-2">
                            <Sparkles className="w-5 h-5 text-green-600" />
                            Convert Lead
                        </DialogTitle>
                    </DialogHeader>
                    <p className="text-slate-600 dark:text-slate-400 mb-4">
                        Choose how to convert <strong>{lead.name}</strong>. This will create a new record and remove the lead from this page.
                    </p>
                    
                    {/* Show "Both" option prominently if lead is buyer+seller type */}
                    {(lead.lead_type === 'buyer_seller' || lead.lead_type === 'all') && (
                        <Button
                            onClick={() => {
                                setShowConvertDialog(false);
                                onConvert(lead, 'both');
                            }}
                            className="w-full h-auto py-4 mb-4 flex flex-col items-center gap-2 bg-gradient-to-r from-blue-600 to-amber-500 hover:from-blue-700 hover:to-amber-600 text-white"
                        >
                            <div className="flex items-center gap-2">
                                <UserCheck className="w-6 h-6" />
                                <span className="text-lg">+</span>
                                <Building2 className="w-6 h-6" />
                            </div>
                            <span className="font-semibold">Convert as Both Buyer & Seller</span>
                            <span className="text-xs text-white/80">Creates linked Buyer + Property records</span>
                        </Button>
                    )}
                    
                    <div className="grid grid-cols-3 gap-4">
                        <Button
                            onClick={() => {
                                setShowConvertDialog(false);
                                onConvert(lead, 'buyer');
                            }}
                            variant="outline"
                            className="h-auto py-6 flex flex-col items-center gap-2 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20"
                        >
                            <UserCheck className="w-8 h-8 text-blue-600" />
                            <span className="font-semibold">Buyer Only</span>
                            <span className="text-xs text-slate-500">Add to Buyers page</span>
                        </Button>
                        <Button
                            onClick={() => {
                                setShowConvertDialog(false);
                                onConvert(lead, 'seller');
                            }}
                            variant="outline"
                            className="h-auto py-6 flex flex-col items-center gap-2 hover:border-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20"
                        >
                            <Building2 className="w-8 h-8 text-amber-600" />
                            <span className="font-semibold">Seller Only</span>
                            <span className="text-xs text-slate-500">Add new Property listing</span>
                        </Button>
                        <Button
                            onClick={() => {
                                setShowConvertDialog(false);
                                onConvert(lead, 'both');
                            }}
                            variant="outline"
                            className="h-auto py-6 flex flex-col items-center gap-2 hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 border-2 border-dashed"
                        >
                            <div className="flex items-center gap-1">
                                <UserCheck className="w-6 h-6 text-blue-600" />
                                <span className="text-purple-600 font-bold">+</span>
                                <Building2 className="w-6 h-6 text-amber-600" />
                            </div>
                            <span className="font-semibold">Both</span>
                            <span className="text-xs text-slate-500 text-center">Buyer & Seller linked</span>
                        </Button>
                    </div>
                    <div className="flex justify-end pt-4">
                        <Button variant="ghost" onClick={() => setShowConvertDialog(false)}>Cancel</Button>
                    </div>
                </DialogContent>
            </Dialog>
        </>
    );
};

export default function Leads() {
    const queryClient = useQueryClient();
    const navigate = useNavigate();
    const [searchQuery, setSearchQuery] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [scoreFilter, setScoreFilter] = useState('all');
    const [dateFilter, setDateFilter] = useState('all');
    const [viewMode, setViewMode] = useState('grid');
    const [selectedLead, setSelectedLead] = useState(null);
    const [showNewLeadModal, setShowNewLeadModal] = useState(false);
    const [newLeadData, setNewLeadData] = useState({});
    const [sortField, setSortField] = useState('created_date');
    const [sortDirection, setSortDirection] = useState('desc');

    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me(),
    });

    const { data: leads = [], isLoading } = useQuery({
        queryKey: ['leads'],
        queryFn: () => base44.entities.Lead.list('-created_date'),
        staleTime: 30 * 1000,
        refetchInterval: 30 * 1000,
    });

    // Check for openLead query parameter
    React.useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const openLeadId = urlParams.get('openLead');
        if (openLeadId && leads && leads.length > 0) {
            const lead = leads.find(l => l.id === openLeadId);
            if (lead) {
                setSelectedLead(lead);
                // Clean up URL
                window.history.replaceState({}, '', createPageUrl('Leads'));
            }
        }
    }, [leads]);

    const createLeadMutation = useMutation({
        mutationFn: (data) => base44.entities.Lead.create(data),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['leads'] });
            toast.success('Lead created successfully');
            setShowNewLeadModal(false);
            setNewLeadData({});
        },
    });

    const createBuyerMutation = useMutation({
        mutationFn: (data) => base44.entities.Buyer.create(data),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['buyers'] });
        },
    });

    const deleteLeadMutation = useMutation({
        mutationFn: (id) => base44.entities.Lead.delete(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['leads'] });
        },
    });

    const handleConvertLead = async (lead, type) => {
        try {
            if (type === 'buyer') {
                // Parse name into first/last
                const nameParts = (lead.name || '').trim().split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                await createBuyerMutation.mutateAsync({
                    first_name: firstName,
                    last_name: lastName,
                    email: lead.email,
                    phone: lead.phone,
                    notes: lead.notes,
                    status: 'active',
                });

                // Delete the lead
                await deleteLeadMutation.mutateAsync(lead.id);

                toast.success(`${lead.name} converted to Buyer successfully!`);
                setSelectedLead(null);
                navigate(createPageUrl('Buyers'));
            } else if (type === 'seller') {
                // For seller, navigate to property add page with pre-filled seller info AND property address
                // DON'T delete the lead - keep it until property is successfully created
                const params = new URLSearchParams();
                params.set('sellerName', lead.name || '');
                params.set('sellerEmail', lead.email || '');
                params.set('sellerPhone', lead.phone || '');
                params.set('leadId', lead.id); // Pass lead ID to delete after successful property creation
                if (lead.property_address) {
                    params.set('propertyAddress', lead.property_address);
                }
                if (lead.notes) {
                    params.set('notes', lead.notes);
                }
                
                toast.success(`Redirecting to add property for ${lead.name}`);
                setSelectedLead(null);
                navigate(createPageUrl(`PropertyAdd?${params.toString()}`));
            } else if (type === 'both') {
                // Create Buyer first with flag that they need to sell
                const nameParts = (lead.name || '').trim().split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                const buyer = await createBuyerMutation.mutateAsync({
                    first_name: firstName,
                    last_name: lastName,
                    email: lead.email,
                    phone: lead.phone,
                    notes: `${lead.notes || ''}\n\n‚ö†Ô∏è ALSO SELLING: ${lead.property_address || 'Address TBD'}`.trim(),
                    status: 'active',
                    must_sell_first: true, // Flag for buyer page
                    selling_property_address: lead.property_address || '',
                });

                // Navigate to property add page with buyer ID linked
                const params = new URLSearchParams();
                params.set('sellerName', lead.name || '');
                params.set('sellerEmail', lead.email || '');
                params.set('sellerPhone', lead.phone || '');
                params.set('leadId', lead.id);
                params.set('linkedBuyerId', buyer.id); // Link to the buyer record
                params.set('buyerNeedsToBuy', 'true'); // Flag for property page
                if (lead.property_address) {
                    params.set('propertyAddress', lead.property_address);
                }
                if (lead.notes) {
                    params.set('notes', lead.notes);
                }
                
                toast.success(`Buyer created! Now add their property listing...`);
                setSelectedLead(null);
                navigate(createPageUrl(`PropertyAdd?${params.toString()}`));
            }
        } catch (error) {
            toast.error(`Failed to convert lead: ${error.message}`);
        }
    };

    const filteredLeads = useMemo(() => {
        const filtered = leads.filter(lead => {
            const matchesSearch = !searchQuery || 
                (lead.name && lead.name.toLowerCase().includes(searchQuery.toLowerCase())) ||
                (lead.email && lead.email.toLowerCase().includes(searchQuery.toLowerCase())) ||
                (lead.phone && lead.phone.includes(searchQuery));
            
            const matchesStatus = statusFilter === 'all' || lead.status === statusFilter;
            
            const matchesScore = scoreFilter === 'all' || 
                (scoreFilter === 'hot' && (lead.score || 0) >= 70) ||
                (scoreFilter === 'warm' && (lead.score || 0) >= 40 && (lead.score || 0) < 70) ||
                (scoreFilter === 'cold' && (lead.score || 0) < 40);

            const matchesDate = dateFilter === 'all' || 
                (dateFilter === 'thisWeek' && isThisWeek(parseISO(lead.created_date)));

            return matchesSearch && matchesStatus && matchesScore && matchesDate;
        });

        // Sort the filtered leads
        return filtered.sort((a, b) => {
            let aValue, bValue;
            
            switch (sortField) {
                case 'score':
                    aValue = a.score || 0;
                    bValue = b.score || 0;
                    break;
                case 'name':
                    aValue = (a.name || '').toLowerCase();
                    bValue = (b.name || '').toLowerCase();
                    break;
                case 'status':
                    aValue = a.status || '';
                    bValue = b.status || '';
                    break;
                case 'email':
                    aValue = (a.email || '').toLowerCase();
                    bValue = (b.email || '').toLowerCase();
                    break;
                case 'phone':
                    aValue = a.phone || '';
                    bValue = b.phone || '';
                    break;
                case 'lead_source':
                    aValue = (a.lead_source || '').toLowerCase();
                    bValue = (b.lead_source || '').toLowerCase();
                    break;
                case 'created_date':
                default:
                    aValue = new Date(a.created_date).getTime();
                    bValue = new Date(b.created_date).getTime();
                    break;
            }

            if (typeof aValue === 'string') {
                const comparison = aValue.localeCompare(bValue);
                return sortDirection === 'asc' ? comparison : -comparison;
            } else {
                return sortDirection === 'asc' ? aValue - bValue : bValue - aValue;
            }
        });
    }, [leads, searchQuery, statusFilter, scoreFilter, dateFilter, sortField, sortDirection]);

    const stats = useMemo(() => {
        return {
            total: leads.length,
            new: leads.filter(l => l.status === 'new').length,
            hot: leads.filter(l => (l.score || 0) >= 70).length,
            contacted: leads.filter(l => l.status === 'contacted').length,
            thisWeek: leads.filter(l => isThisWeek(parseISO(l.created_date))).length,
        };
    }, [leads]);

    const handleQuickAction = (lead, action) => {
        if (action === 'call' && lead.phone) {
            window.location.href = `tel:${lead.phone}`;
        } else if (action === 'email' && lead.email) {
            window.location.href = `mailto:${lead.email}`;
        } else if (action === 'note') {
            setSelectedLead(lead);
        }
    };

    const handleCreateLead = (e) => {
        e.preventDefault();
        createLeadMutation.mutate({
            ...newLeadData,
            status: 'new',
            score: 50,
        });
    };

    if (isLoading) {
        return <LoadingSpinner icon={Target} title="Loading Leads..." description="Loading your lead pipeline" />;
    }

    return (
        <div className="page-container space-y-6 p-6">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div className="flex items-center gap-3">
                    <Button 
                        variant="ghost" 
                        size="sm" 
                        onClick={() => navigate(-1)}
                        className="text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800"
                    >
                        <ArrowLeft className="w-5 h-5" />
                    </Button>
                    <div>
                        <h1 className="text-3xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                            <Target className="w-8 h-8 text-primary" />
                            Smart Leads
                        </h1>
                        <p className="text-slate-600 dark:text-slate-400 mt-1">AI-powered lead management</p>
                    </div>
                </div>
                <Button onClick={() => setShowNewLeadModal(true)} className="bg-primary hover:bg-primary/90 shadow-lg">
                    <Plus className="w-4 h-4 mr-2" /> Add Lead
                </Button>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                <Card 
                    className="bg-gradient-to-br from-blue-500 to-blue-600 text-white border-0 shadow-lg cursor-pointer hover:shadow-xl transition-all hover:scale-105"
                    onClick={() => {
                        setStatusFilter('all');
                        setScoreFilter('all');
                        setDateFilter('all');
                        setSearchQuery('');
                    }}
                >
                    <CardContent className="p-4">
                        <div className="text-3xl font-bold">{stats.total}</div>
                        <div className="text-sm opacity-90 mt-1">Total Leads</div>
                    </CardContent>
                </Card>
                <Card 
                    className="bg-gradient-to-br from-green-500 to-green-600 text-white border-0 shadow-lg cursor-pointer hover:shadow-xl transition-all hover:scale-105"
                    onClick={() => {
                        setScoreFilter('hot');
                        setStatusFilter('all');
                    }}
                >
                    <CardContent className="p-4">
                        <div className="text-3xl font-bold">{stats.hot}</div>
                        <div className="text-sm opacity-90 mt-1 flex items-center gap-1">
                            <Zap className="w-3 h-3" /> Hot Leads
                        </div>
                    </CardContent>
                </Card>
                <Card 
                    className="bg-gradient-to-br from-purple-500 to-purple-600 text-white border-0 shadow-lg cursor-pointer hover:shadow-xl transition-all hover:scale-105"
                    onClick={() => {
                        setStatusFilter('new');
                        setScoreFilter('all');
                    }}
                >
                    <CardContent className="p-4">
                        <div className="text-3xl font-bold">{stats.new}</div>
                        <div className="text-sm opacity-90 mt-1">New Leads</div>
                    </CardContent>
                </Card>
                <Card 
                    className="bg-gradient-to-br from-amber-500 to-amber-600 text-white border-0 shadow-lg cursor-pointer hover:shadow-xl transition-all hover:scale-105"
                    onClick={() => {
                        setStatusFilter('contacted');
                        setScoreFilter('all');
                    }}
                >
                    <CardContent className="p-4">
                        <div className="text-3xl font-bold">{stats.contacted}</div>
                        <div className="text-sm opacity-90 mt-1">Contacted</div>
                    </CardContent>
                </Card>
                <Card 
                    className="bg-gradient-to-br from-cyan-500 to-cyan-600 text-white border-0 shadow-lg cursor-pointer hover:shadow-xl transition-all hover:scale-105"
                    onClick={() => {
                        setDateFilter('thisWeek');
                        setScoreFilter('all');
                        setStatusFilter('all');
                    }}
                >
                    <CardContent className="p-4">
                        <div className="text-3xl font-bold">{stats.thisWeek}</div>
                        <div className="text-sm opacity-90 mt-1">This Week</div>
                    </CardContent>
                </Card>
            </div>

            <Card className="bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm">
                <CardContent className="p-4">
                    <div className="flex flex-col md:flex-row gap-4">
                        <div className="flex-1 relative">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                            <Input
                                placeholder="Search leads by name, email, or phone..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                className="pl-10"
                            />
                        </div>
                        <Select value={statusFilter} onValueChange={setStatusFilter}>
                            <SelectTrigger className="w-full md:w-[180px]">
                                <SelectValue placeholder="Status" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="all">All Status</SelectItem>
                                <SelectItem value="new">New</SelectItem>
                                <SelectItem value="contacted">Contacted</SelectItem>
                                <SelectItem value="qualified">Qualified</SelectItem>
                                <SelectItem value="nurturing">Nurturing</SelectItem>
                                <SelectItem value="unqualified">Unqualified</SelectItem>
                                <SelectItem value="closed">Closed</SelectItem>
                            </SelectContent>
                        </Select>
                        <Select value={scoreFilter} onValueChange={setScoreFilter}>
                            <SelectTrigger className="w-full md:w-[180px]">
                                <SelectValue placeholder="Temperature" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="all">All Scores</SelectItem>
                                <SelectItem value="hot">üî• Hot (70+)</SelectItem>
                                <SelectItem value="warm">‚òÄÔ∏è Warm (40-70)</SelectItem>
                                <SelectItem value="cold">‚ùÑÔ∏è Cold (&lt;40)</SelectItem>
                            </SelectContent>
                        </Select>
                        <div className="flex gap-2">
                            <Button
                                variant={viewMode === 'grid' ? 'default' : 'outline'}
                                size="icon"
                                onClick={() => setViewMode('grid')}
                            >
                                <Grid3x3 className="w-4 h-4" />
                            </Button>
                            <Button
                                variant={viewMode === 'list' ? 'default' : 'outline'}
                                size="icon"
                                onClick={() => setViewMode('list')}
                            >
                                <List className="w-4 h-4" />
                            </Button>
                        </div>
                    </div>
                </CardContent>
            </Card>

            {filteredLeads.length === 0 ? (
                <Card className="p-12">
                    <div className="text-center">
                        <Target className="w-16 h-16 text-slate-300 mx-auto mb-4" />
                        <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-300 mb-2">No leads found</h3>
                        <p className="text-slate-500 dark:text-slate-400 mb-6">Start by adding your first lead</p>
                        <Button onClick={() => setShowNewLeadModal(true)}>
                            <Plus className="w-4 h-4 mr-2" /> Add Lead
                        </Button>
                    </div>
                </Card>
            ) : viewMode === 'list' ? (
                <div className="space-y-2">
                    {/* List Header with Sortable Columns */}
                    <div className="flex items-center gap-3 px-3 py-2 text-xs font-semibold text-slate-500 uppercase bg-slate-100 dark:bg-slate-800 rounded-lg">
                        <SortableHeader field="score" label="Score" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-10 flex-shrink-0 text-center" />
                        <SortableHeader field="name" label="Name" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-40 flex-shrink-0" />
                        <SortableHeader field="status" label="Status" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-24 flex-shrink-0 text-center" />
                        <SortableHeader field="email" label="Email" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-48 flex-shrink-0" />
                        <SortableHeader field="phone" label="Phone" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-32 flex-shrink-0" />
                        <SortableHeader field="lead_source" label="Source" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-28 flex-shrink-0" />
                        <SortableHeader field="created_date" label="Date" sortField={sortField} sortDirection={sortDirection} setSortField={setSortField} setSortDirection={setSortDirection} className="w-24 flex-shrink-0" />
                        <div className="ml-auto flex-shrink-0">Actions</div>
                    </div>
                    <AnimatePresence>
                        {filteredLeads.map(lead => (
                            <LeadListRow
                                key={lead.id}
                                lead={lead}
                                onClick={() => setSelectedLead(lead)}
                                onQuickAction={handleQuickAction}
                            />
                        ))}
                    </AnimatePresence>
                </div>
            ) : (
                <motion.div 
                    layout
                    className="grid gap-6 md:grid-cols-2 lg:grid-cols-3"
                >
                    <AnimatePresence>
                        {filteredLeads.map(lead => (
                            <LeadCard
                                key={lead.id}
                                lead={lead}
                                onClick={() => setSelectedLead(lead)}
                                onQuickAction={handleQuickAction}
                            />
                        ))}
                    </AnimatePresence>
                </motion.div>
            )}

            {selectedLead && (
                <LeadDetailModal
                    lead={selectedLead}
                    isOpen={!!selectedLead}
                    onClose={() => setSelectedLead(null)}
                    onUpdate={() => queryClient.invalidateQueries({ queryKey: ['leads'] })}
                    onConvert={handleConvertLead}
                />
            )}

            <Dialog open={showNewLeadModal} onOpenChange={setShowNewLeadModal}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>Add New Lead</DialogTitle>
                    </DialogHeader>
                    <form onSubmit={handleCreateLead} className="space-y-4">
                        <div>
                            <label className="text-sm font-medium">Name *</label>
                            <Input
                                required
                                value={newLeadData.name || ''}
                                onChange={(e) => setNewLeadData({ ...newLeadData, name: e.target.value })}
                                className="mt-1"
                                placeholder="John Doe"
                            />
                        </div>
                        <div>
                            <label className="text-sm font-medium">Email *</label>
                            <Input
                                type="email"
                                required
                                value={newLeadData.email || ''}
                                onChange={(e) => setNewLeadData({ ...newLeadData, email: e.target.value })}
                                className="mt-1"
                                placeholder="john@example.com"
                            />
                        </div>
                        <div>
                            <label className="text-sm font-medium">Phone</label>
                            <Input
                                value={newLeadData.phone || ''}
                                onChange={(e) => setNewLeadData({ ...newLeadData, phone: e.target.value })}
                                className="mt-1"
                                placeholder="(555) 123-4567"
                            />
                        </div>
                        <div>
                            <label className="text-sm font-medium">Lead Type</label>
                            <Select value={newLeadData.lead_type || 'unknown'} onValueChange={(value) => setNewLeadData({ ...newLeadData, lead_type: value })}>
                                <SelectTrigger className="mt-1">
                                    <SelectValue placeholder="Select lead type" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="unknown">Unknown</SelectItem>
                                    <SelectItem value="buyer">üîµ Buyer Only</SelectItem>
                                    <SelectItem value="seller">üü° Seller Only</SelectItem>
                                    <SelectItem value="renter">üü£ Renter Only</SelectItem>
                                    <SelectItem value="buyer_seller">üîµüü° Buyer & Seller</SelectItem>
                                    <SelectItem value="buyer_renter">üîµüü£ Buyer & Renter</SelectItem>
                                    <SelectItem value="seller_renter">üü°üü£ Seller & Renter</SelectItem>
                                    <SelectItem value="all">üîµüü°üü£ All Types</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>
                        <div>
                            <label className="text-sm font-medium">Property Address (for Sellers)</label>
                            <Input
                                value={newLeadData.property_address || ''}
                                onChange={(e) => setNewLeadData({ ...newLeadData, property_address: e.target.value })}
                                className="mt-1"
                                placeholder="123 Main St, City, State"
                            />
                        </div>
                        <div>
                            <label className="text-sm font-medium">Lead Source</label>
                            <Input
                                value={newLeadData.lead_source || ''}
                                onChange={(e) => setNewLeadData({ ...newLeadData, lead_source: e.target.value })}
                                className="mt-1"
                                placeholder="e.g., Zillow, Referral, Website"
                            />
                        </div>
                        <div>
                            <label className="text-sm font-medium">Notes</label>
                            <Textarea
                                value={newLeadData.notes || ''}
                                onChange={(e) => setNewLeadData({ ...newLeadData, notes: e.target.value })}
                                className="mt-1"
                                rows={3}
                                placeholder="Add any initial notes..."
                            />
                        </div>
                        <div className="flex justify-end gap-3 pt-4">
                            <Button type="button" variant="outline" onClick={() => setShowNewLeadModal(false)}>
                                Cancel
                            </Button>
                            <Button type="submit" disabled={createLeadMutation.isLoading}>
                                {createLeadMutation.isLoading ? 'Creating...' : 'Create Lead'}
                            </Button>
                        </div>
                    </form>
                </DialogContent>
            </Dialog>
        </div>
    );
}
import React, { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import {
  Target, TrendingUp, Home, DollarSign, Search,
  Award, Zap, ChevronRight, Sparkles, RefreshCw,
  Download, Settings, Mail, Phone
} from 'lucide-react';

const calculateLeadScore = (entity) => {
  if (!entity) return null;
  
  let intentData = null;
  let lifeEvents = [];
  
  try {
    intentData = entity.intent_data ? JSON.parse(entity.intent_data) : null;
  } catch (e) {}
  
  try {
    lifeEvents = entity.life_events ? JSON.parse(entity.life_events) : [];
  } catch (e) {}
  
  const isRecent = (dateStr, days) => {
    if (!dateStr) return false;
    try {
      const date = new Date(dateStr);
      const now = new Date();
      const diffDays = (now - date) / (1000 * 60 * 60 * 24);
      return diffDays <= days;
    } catch (e) {
      return false;
    }
  };
  
  const buyerScore = Math.max(
    (isRecent(entity.last_contact_date, 30) ? 30 : 0) +
    (entity.budget_max > 0 ? 25 : 0) +
    (intentData?.buyer_intent_score > 50 ? 25 : 0) +
    (entity.pre_approved ? 20 : 0),
    0
  );
  
  const sellerScore = Math.max(
    (isRecent(entity.last_contact_date, 30) ? 30 : 0) +
    (entity.property_address ? 25 : 0) +
    (intentData?.seller_intent_score > 50 ? 25 : 0) +
    (lifeEvents.length > 0 ? 20 : 0),
    0
  );
  
  const finalScore = Math.max(buyerScore, sellerScore);
  const recencyBoost = isRecent(entity.last_contact_date, 7) ? 10 : 0;
  const totalScore = Math.min(finalScore + recencyBoost, 100);
  
  let tier = 'Prospect';
  let tierColor = 'bg-slate-500';
  if (totalScore >= 90) { tier = 'Platinum'; tierColor = 'bg-purple-600'; }
  else if (totalScore >= 80) { tier = 'Gold'; tierColor = 'bg-yellow-500'; }
  else if (totalScore >= 70) { tier = 'Silver'; tierColor = 'bg-slate-400'; }
  else if (totalScore >= 60) { tier = 'Bronze'; tierColor = 'bg-orange-600'; }
  else if (totalScore >= 50) { tier = 'Lead'; tierColor = 'bg-blue-500'; }
  
  const intentType = buyerScore > sellerScore ? 'buyer' : sellerScore > buyerScore ? 'seller' : 'neutral';
  
  return {
    finalScore: Math.round(totalScore),
    buyerIntentScore: Math.round(buyerScore),
    sellerIntentScore: Math.round(sellerScore),
    intentType,
    tier,
    tierColor,
    recencyBoost
  };
};

export default function LeadScoring() {
  const navigate = useNavigate();
  const [searchTerm, setSearchTerm] = useState('');
  const [tierFilter, setTierFilter] = useState('all');
  const [intentFilter, setIntentFilter] = useState('all');
  const [isLoading, setIsLoading] = useState(true);
  const [scoredLeads, setScoredLeads] = useState([]);
  const [stats, setStats] = useState({
    platinum: 0,
    gold: 0,
    silver: 0,
    bronze: 0,
    buyers: 0,
    sellers: 0
  });

  useEffect(() => {
    loadAndScoreLeads();
  }, []);

  const loadAndScoreLeads = async () => {
    setIsLoading(true);
    try {
      const [leadsData, contactsData, buyersData] = await Promise.all([
        base44.entities.Lead.list().catch(() => []),
        base44.entities.Contact.list().catch(() => []),
        base44.entities.Buyer.list().catch(() => [])
      ]);
      
      const allEntities = [];
      
      (leadsData || []).forEach(lead => {
        const score = calculateLeadScore(lead);
        if (score) {
          allEntities.push({
            ...lead,
            ...score,
            entityType: 'lead',
            displayName: lead.name || 'Unknown',
            displayEmail: lead.email || '',
            displayPhone: lead.phone || ''
          });
        }
      });
      
      (contactsData || []).forEach(contact => {
        const score = calculateLeadScore(contact);
        if (score) {
          allEntities.push({
            ...contact,
            ...score,
            entityType: 'contact',
            displayName: contact.name || 'Unknown',
            displayEmail: contact.email || '',
            displayPhone: contact.phone || ''
          });
        }
      });
      
      (buyersData || []).forEach(buyer => {
        const score = calculateLeadScore(buyer);
        if (score) {
          allEntities.push({
            ...buyer,
            ...score,
            entityType: 'buyer',
            displayName: `${buyer.first_name || ''} ${buyer.last_name || ''}`.trim() || 'Unknown',
            displayEmail: buyer.email || '',
            displayPhone: buyer.phone || ''
          });
        }
      });
      
      const sorted = allEntities.sort((a, b) => b.finalScore - a.finalScore);
      setScoredLeads(sorted);
      
      setStats({
        platinum: sorted.filter(l => l.tier === 'Platinum').length,
        gold: sorted.filter(l => l.tier === 'Gold').length,
        silver: sorted.filter(l => l.tier === 'Silver').length,
        bronze: sorted.filter(l => l.tier === 'Bronze').length,
        buyers: sorted.filter(l => l.intentType === 'buyer').length,
        sellers: sorted.filter(l => l.intentType === 'seller').length
      });
    } catch (error) {
      console.error('Error loading leads:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const filteredLeads = scoredLeads.filter(lead => {
    const matchesSearch = !searchTerm || 
      lead.displayName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      lead.displayEmail?.toLowerCase().includes(searchTerm.toLowerCase());
    
    const matchesTier = tierFilter === 'all' || lead.tier === tierFilter;
    const matchesIntent = intentFilter === 'all' || lead.intentType === intentFilter;
    
    return matchesSearch && matchesTier && matchesIntent;
  });

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-screen bg-gradient-to-br from-slate-50 to-purple-50 dark:from-slate-900 dark:to-slate-800">
        <div className="text-center">
          <RefreshCw className="w-12 h-12 animate-spin mx-auto mb-4 text-purple-600" />
          <p className="text-slate-600 dark:text-slate-400">Analyzing leads...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-purple-50/30 to-blue-50/20 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        
        {/* Header */}
        <div className="relative overflow-hidden bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200/50 dark:border-slate-700/50">
          <div className="absolute inset-0 bg-gradient-to-br from-purple-500/5 via-blue-500/5 to-pink-500/5"></div>
          <div className="relative p-8">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div className="flex items-center gap-4">
                <button
                  onClick={() => navigate(createPageUrl('Dashboard'))}
                  className="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300"
                >
                  <Target className="w-7 h-7 text-white" />
                </button>
                <div>
                  <h1 className="text-3xl font-bold bg-gradient-to-r from-slate-900 via-purple-900 to-blue-900 dark:from-white dark:via-purple-200 dark:to-blue-200 bg-clip-text text-transparent">
                    Advanced Lead Scoring
                  </h1>
                  <p className="text-slate-600 dark:text-slate-400 text-sm mt-0.5">
                    Transaction likelihood analysis powered by RealtyMind AI
                  </p>
                </div>
              </div>
              <div className="flex gap-3">
                <button className="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-2">
                  <Download className="w-4 h-4" />
                  Export
                </button>
                <button className="px-4 py-2 border border-purple-300 dark:border-purple-700 rounded-lg hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors flex items-center gap-2">
                  <Settings className="w-4 h-4" />
                  Configure
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* Stats Cards */}
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
          <div 
            className="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-xl p-6 hover:shadow-lg transition-all cursor-pointer" 
            onClick={() => setTierFilter(tierFilter === 'Platinum' ? 'all' : 'Platinum')}
          >
            <div className="flex items-center justify-between mb-3">
              <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-600 to-purple-700 flex items-center justify-center shadow-md">
                <Award className="w-5 h-5 text-white" />
              </div>
            </div>
            <p className="text-3xl font-bold bg-gradient-to-br from-purple-600 to-purple-700 bg-clip-text text-transparent">{stats.platinum}</p>
            <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">Platinum (90+)</p>
          </div>

          <div 
            className="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-xl p-6 hover:shadow-lg transition-all cursor-pointer" 
            onClick={() => setTierFilter(tierFilter === 'Gold' ? 'all' : 'Gold')}
          >
            <div className="flex items-center justify-between mb-3">
              <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-yellow-500 to-yellow-600 flex items-center justify-center shadow-md">
                <Sparkles className="w-5 h-5 text-white" />
              </div>
            </div>
            <p className="text-3xl font-bold bg-gradient-to-br from-yellow-600 to-yellow-700 bg-clip-text text-transparent">{stats.gold}</p>
            <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">Gold (80-89)</p>
          </div>

          <div 
            className="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-xl p-6 hover:shadow-lg transition-all cursor-pointer" 
            onClick={() => setTierFilter(tierFilter === 'Silver' ? 'all' : 'Silver')}
          >
            <div className="flex items-center justify-between mb-3">
              <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-400 to-slate-500 flex items-center justify-center shadow-md">
                <TrendingUp className="w-5 h-5 text-white" />
              </div>
            </div>
            <p className="text-3xl font-bold bg-gradient-to-br from-slate-600 to-slate-700 bg-clip-text text-transparent">{stats.silver}</p>
            <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">Silver (70-79)</p>
          </div>

          <div 
            className="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-xl p-6 hover:shadow-lg transition-all cursor-pointer" 
            onClick={() => setTierFilter(tierFilter === 'Bronze' ? 'all' : 'Bronze')}
          >
            <div className="flex items-center justify-between mb-3">
              <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-600 to-orange-700 flex items-center justify-center shadow-md">
                <Target className="w-5 h-5 text-white" />
              </div>
            </div>
            <p className="text-3xl font-bold bg-gradient-to-br from-orange-600 to-orange-700 bg-clip-text text-transparent">{stats.bronze}</p>
            <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">Bronze (60-69)</p>
          </div>

          <div 
            className="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-xl p-6 hover:shadow-lg transition-all cursor-pointer" 
            onClick={() => setIntentFilter(intentFilter === 'buyer' ? 'all' : 'buyer')}
          >
            <div className="flex items-center justify-between mb-3">
              <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-md">
                <Home className="w-5 h-5 text-white" />
              </div>
            </div>
            <p className="text-3xl font-bold bg-gradient-to-br from-blue-600 to-blue-700 bg-clip-text text-transparent">{stats.buyers}</p>
            <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">Buyer Intent</p>
          </div>

          <div 
            className="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-xl p-6 hover:shadow-lg transition-all cursor-pointer" 
            onClick={() => setIntentFilter(intentFilter === 'seller' ? 'all' : 'seller')}
          >
            <div className="flex items-center justify-between mb-3">
              <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center shadow-md">
                <DollarSign className="w-5 h-5 text-white" />
              </div>
            </div>
            <p className="text-3xl font-bold bg-gradient-to-br from-green-600 to-green-700 bg-clip-text text-transparent">{stats.sellers}</p>
            <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">Seller Intent</p>
          </div>
        </div>

        {/* Search and Filters */}
        <div className="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-xl p-6">
          <div className="flex flex-wrap gap-4 items-center">
            <div className="flex-1 min-w-[300px]">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                <input
                  type="text"
                  placeholder="Search leads, contacts, buyers..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-slate-700 dark:text-white"
                />
              </div>
            </div>
            
            <div className="flex gap-2">
              <button
                className={`px-4 py-2 rounded-lg transition-colors ${
                  tierFilter === 'all' 
                    ? 'bg-purple-600 text-white' 
                    : 'border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700'
                }`}
                onClick={() => setTierFilter('all')}
              >
                All Tiers
              </button>
              <button
                className={`px-4 py-2 rounded-lg transition-colors ${
                  intentFilter === 'all' 
                    ? 'bg-purple-600 text-white' 
                    : 'border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700'
                }`}
                onClick={() => setIntentFilter('all')}
              >
                All Intent
              </button>
              {(tierFilter !== 'all' || intentFilter !== 'all') && (
                <button
                  className="px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                  onClick={() => {
                    setTierFilter('all');
                    setIntentFilter('all');
                  }}
                >
                  Clear Filters
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Leads List */}
        <div className="space-y-3">
          {filteredLeads.map((lead) => (
            <div
              key={`${lead.entityType}-${lead.id}`}
              className="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-xl p-6 hover:shadow-lg transition-all cursor-pointer"
              onClick={() => {
                if (lead.entityType === 'lead') navigate(createPageUrl(`LeadDetail?id=${lead.id}`));
                else if (lead.entityType === 'contact') navigate(createPageUrl(`ContactDetail?id=${lead.id}`));
                else if (lead.entityType === 'buyer') navigate(createPageUrl(`BuyerDetail?id=${lead.id}`));
              }}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4 flex-1">
                  <div className="flex flex-col items-center">
                    <div className={`w-16 h-16 rounded-full ${lead.tierColor} flex items-center justify-center text-white font-bold text-lg shadow-lg`}>
                      {lead.finalScore}
                    </div>
                    <span className={`${lead.tierColor} text-white text-xs mt-2 px-2 py-0.5 rounded-full`}>
                      {lead.tier}
                    </span>
                  </div>
                  
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2 flex-wrap">
                      <h3 className="text-lg font-bold text-slate-900 dark:text-white">
                        {lead.displayName}
                      </h3>
                      <span className="px-2 py-0.5 border border-slate-300 dark:border-slate-600 rounded text-xs capitalize">
                        {lead.entityType}
                      </span>
                      {lead.intentType !== 'neutral' && (
                        <span className={`px-2 py-1 rounded flex items-center gap-1 text-xs text-white ${lead.intentType === 'buyer' ? 'bg-blue-500' : 'bg-green-500'}`}>
                          {lead.intentType === 'buyer' ? <Home className="w-3 h-3" /> : <DollarSign className="w-3 h-3" />}
                          {lead.intentType}
                        </span>
                      )}
                    </div>
                    
                    <div className="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400 flex-wrap">
                      {lead.displayEmail && (
                        <div className="flex items-center gap-1">
                          <Mail className="w-3 h-3" />
                          {lead.displayEmail}
                        </div>
                      )}
                      {lead.displayPhone && (
                        <div className="flex items-center gap-1">
                          <Phone className="w-3 h-3" />
                          {lead.displayPhone}
                        </div>
                      )}
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 mt-3">
                      <div>
                        <p className="text-xs text-slate-500 mb-1">Buyer Intent</p>
                        <div className="flex items-center gap-2">
                          <div className="h-2 flex-1 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                            <div 
                              className="h-full bg-blue-500" 
                              style={{ width: `${lead.buyerIntentScore}%` }}
                            ></div>
                          </div>
                          <span className="text-xs font-semibold text-blue-600">{lead.buyerIntentScore}</span>
                        </div>
                      </div>
                      <div>
                        <p className="text-xs text-slate-500 mb-1">Seller Intent</p>
                        <div className="flex items-center gap-2">
                          <div className="h-2 flex-1 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                            <div 
                              className="h-full bg-green-500" 
                              style={{ width: `${lead.sellerIntentScore}%` }}
                            ></div>
                          </div>
                          <span className="text-xs font-semibold text-green-600">{lead.sellerIntentScore}</span>
                        </div>
                      </div>
                    </div>
                    
                    {lead.recencyBoost > 0 && (
                      <div className="mt-2">
                        <span className="bg-orange-500 text-white text-xs px-2 py-1 rounded flex items-center gap-1 w-fit">
                          <Zap className="w-3 h-3" />
                          +{lead.recencyBoost} Recency Boost
                        </span>
                      </div>
                    )}
                  </div>
                </div>
                
                <ChevronRight className="w-5 h-5 text-slate-400" />
              </div>
            </div>
          ))}
          
          {filteredLeads.length === 0 && (
            <div className="bg-white dark:bg-slate-800 border border-slate-200/50 dark:border-slate-700/50 rounded-xl p-12 text-center">
              <Target className="w-12 h-12 mx-auto mb-4 text-slate-400" />
              <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-2">
                No leads found
              </h3>
              <p className="text-sm text-slate-500 dark:text-slate-400">
                Try adjusting your filters or search criteria
              </p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  MapPin,
  Search,
  Loader2,
  Users,
  DollarSign,
  GraduationCap,
  TrendingUp,
  ShoppingCart,
  Utensils,
  Heart,
  Briefcase,
  Sun,
  Droplets,
  Car,
  Sparkles,
  ChevronRight
} from "lucide-react";
import { toast } from "sonner";

export default function LocationIntelligence() {
  const [countySearch, setCountySearch] = useState("");
  const [selectedCounty, setSelectedCounty] = useState(null);
  const [cities, setCities] = useState([]);
  const [selectedCity, setSelectedCity] = useState(null);
  const [cityIntelligence, setCityIntelligence] = useState(null);
  const [isLoadingCities, setIsLoadingCities] = useState(false);
  const [isLoadingIntelligence, setIsLoadingIntelligence] = useState(false);

  const searchCounty = async () => {
    if (!countySearch.trim()) {
      toast.error("Please enter a county name");
      return;
    }

    setIsLoadingCities(true);
    setSelectedCounty(null);
    setCities([]);
    setSelectedCity(null);
    setCityIntelligence(null);

    try {
      const prompt = `List the major cities and towns in ${countySearch}. 
      
      Provide a JSON response with the following structure:
      {
        "county_full_name": "Full county name with state",
        "state": "State abbreviation",
        "cities": [
          {
            "name": "City Name",
            "population_estimate": "Rough population (e.g., '50,000')",
            "type": "city or town",
            "known_for": "Brief one-line description"
          }
        ]
      }
      
      Include 10-15 major cities/towns. Make sure all data is accurate.`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            county_full_name: { type: "string" },
            state: { type: "string" },
            cities: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  name: { type: "string" },
                  population_estimate: { type: "string" },
                  type: { type: "string" },
                  known_for: { type: "string" }
                }
              }
            }
          }
        }
      });

      setSelectedCounty(response);
      setCities(response.cities || []);
      toast.success(`Found ${response.cities?.length || 0} cities in ${response.county_full_name}`);
    } catch (error) {
      console.error("Error searching county:", error);
      toast.error("Failed to search county. Please try again.");
    }

    setIsLoadingCities(false);
  };

  const loadCityIntelligence = async (city) => {
    setSelectedCity(city);
    setIsLoadingIntelligence(true);
    setCityIntelligence(null);

    try {
      const prompt = `Provide comprehensive real estate and location intelligence for ${city.name}, ${selectedCounty.state}. This is for real estate agents and buyers.

      Include the following categories with detailed, accurate information:

      1. **Market Overview**
         - Current median home price
         - Year-over-year price change percentage
         - Average days on market
         - Market trend (buyer's market, seller's market, balanced)
         - Inventory levels

      2. **Demographics**
         - Population
         - Median household income
         - Age demographics
         - Education levels
         - Employment rate

      3. **Schools & Education**
         - Top-rated schools (elementary, middle, high school)
         - School district rating
         - Nearby colleges/universities

      4. **Lifestyle & Amenities**
         - Top attractions and landmarks
         - Shopping centers and retail
         - Restaurants and dining scene
         - Parks and recreation
         - Entertainment options
         - Healthcare facilities

      5. **Transportation & Commute**
         - Average commute time
         - Public transportation options
         - Major highways and roads
         - Walkability score
         - Bike-friendliness

      6. **Employment & Economy**
         - Major employers
         - Key industries
         - Job growth rate
         - Unemployment rate

      7. **Climate & Environment**
         - Average temperatures (summer/winter)
         - Annual rainfall
         - Natural disaster risks
         - Air quality

      8. **Real Estate Investment Potential**
         - Rental market strength
         - Average rental rates
         - Cap rates
         - Future development plans
         - Growth projections

      9. **Pros & Cons**
         - Top 5 pros of living here
         - Top 5 cons to consider

      10. **Agent Tips**
          - Best neighborhoods for first-time buyers
          - Best neighborhoods for families
          - Best neighborhoods for investment
          - Unique selling points for marketing

      Provide accurate, up-to-date information. Use real data where possible.`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            market_overview: {
              type: "object",
              properties: {
                median_home_price: { type: "string" },
                price_change_yoy: { type: "string" },
                avg_days_on_market: { type: "string" },
                market_trend: { type: "string" },
                inventory_levels: { type: "string" }
              }
            },
            demographics: {
              type: "object",
              properties: {
                population: { type: "string" },
                median_income: { type: "string" },
                age_demographics: { type: "string" },
                education_levels: { type: "string" },
                employment_rate: { type: "string" }
              }
            },
            schools: {
              type: "object",
              properties: {
                top_schools: { type: "array", items: { type: "string" } },
                district_rating: { type: "string" },
                nearby_colleges: { type: "array", items: { type: "string" } }
              }
            },
            amenities: {
              type: "object",
              properties: {
                attractions: { type: "array", items: { type: "string" } },
                shopping: { type: "array", items: { type: "string" } },
                dining: { type: "string" },
                parks: { type: "array", items: { type: "string" } },
                entertainment: { type: "array", items: { type: "string" } },
                healthcare: { type: "array", items: { type: "string" } }
              }
            },
            transportation: {
              type: "object",
              properties: {
                avg_commute: { type: "string" },
                public_transit: { type: "array", items: { type: "string" } },
                major_highways: { type: "array", items: { type: "string" } },
                walkability_score: { type: "string" },
                bike_friendly: { type: "string" }
              }
            },
            economy: {
              type: "object",
              properties: {
                major_employers: { type: "array", items: { type: "string" } },
                key_industries: { type: "array", items: { type: "string" } },
                job_growth: { type: "string" },
                unemployment_rate: { type: "string" }
              }
            },
            climate: {
              type: "object",
              properties: {
                summer_temp: { type: "string" },
                winter_temp: { type: "string" },
                annual_rainfall: { type: "string" },
                disaster_risks: { type: "array", items: { type: "string" } },
                air_quality: { type: "string" }
              }
            },
            investment: {
              type: "object",
              properties: {
                rental_market: { type: "string" },
                avg_rent: { type: "string" },
                cap_rate: { type: "string" },
                future_development: { type: "array", items: { type: "string" } },
                growth_projection: { type: "string" }
              }
            },
            pros: { type: "array", items: { type: "string" } },
            cons: { type: "array", items: { type: "string" } },
            agent_tips: {
              type: "object",
              properties: {
                first_time_buyers: { type: "array", items: { type: "string" } },
                families: { type: "array", items: { type: "string" } },
                investors: { type: "array", items: { type: "string" } },
                selling_points: { type: "array", items: { type: "string" } }
              }
            }
          }
        }
      });

      setCityIntelligence(response);
      toast.success(`Loaded intelligence for ${city.name}`);
    } catch (error) {
      console.error("Error loading city intelligence:", error);
      toast.error("Failed to load city intelligence. Please try again.");
    }

    setIsLoadingIntelligence(false);
  };

  return (
    <div className="page-container">
      {/* Header */}
      <Card>
        <CardContent className="p-6">
          <div className="flex items-center gap-4 mb-4">
            <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-cyan-600 flex items-center justify-center">
              <MapPin className="w-6 h-6 text-white" />
            </div>
            <div>
              <h1 className="app-title text-2xl">Location Intelligence</h1>
              <p className="app-subtitle">AI-powered market insights for agents and buyers</p>
            </div>
          </div>

          {/* County Search */}
          <div className="flex gap-3">
            <Input
              placeholder="Enter county name (e.g., 'Travis County, TX' or 'Los Angeles County, CA')"
              value={countySearch}
              onChange={(e) => setCountySearch(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && searchCounty()}
              className="flex-1"
            />
            <Button
              onClick={searchCounty}
              disabled={isLoadingCities || !countySearch.trim()}
              className="bg-gradient-to-r from-blue-600 to-cyan-600"
            >
              {isLoadingCities ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Searching...
                </>
              ) : (
                <>
                  <Search className="w-4 h-4 mr-2" />
                  Search County
                </>
              )}
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Cities Grid */}
      {selectedCounty && cities.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center justify-between">
              <span>Cities in {selectedCounty.county_full_name}</span>
              <Badge className="bg-blue-600">{cities.length} cities</Badge>
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {cities.map((city, idx) => (
                <div
                  key={idx}
                  onClick={() => loadCityIntelligence(city)}
                  className={`p-4 rounded-lg border-2 cursor-pointer transition-all hover:shadow-lg ${
                    selectedCity?.name === city.name
                      ? 'border-blue-600 bg-blue-50 shadow-md'
                      : 'border-slate-200 hover:border-blue-400'
                  }`}
                >
                  <div className="flex items-start justify-between mb-2">
                    <div>
                      <h3 className="font-bold text-lg">{city.name}</h3>
                      <p className="text-sm text-slate-600">{city.population_estimate} residents</p>
                    </div>
                    <Badge variant="outline" className="capitalize">
                      {city.type}
                    </Badge>
                  </div>
                  <p className="text-sm text-slate-600 mb-3">{city.known_for}</p>
                  <div className="flex items-center justify-between">
                    <span className="text-xs text-blue-600 font-medium">View Intelligence</span>
                    <ChevronRight className="w-4 h-4 text-blue-600" />
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Loading Intelligence */}
      {isLoadingIntelligence && (
        <Card>
          <CardContent className="p-12 text-center">
            <Loader2 className="w-12 h-12 mx-auto mb-4 animate-spin text-blue-600" />
            <h3 className="text-xl font-semibold mb-2">Analyzing {selectedCity?.name}...</h3>
            <p className="text-slate-600">Gathering market data, demographics, and local insights</p>
          </CardContent>
        </Card>
      )}

      {/* City Intelligence Display */}
      {cityIntelligence && selectedCity && !isLoadingIntelligence && (
        <div className="space-y-4">
          {/* Header Banner */}
          <Card className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white border-0">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-3xl font-bold mb-2">{selectedCity.name}, {selectedCounty.state}</h2>
                  <p className="text-blue-100">Comprehensive Location Intelligence Report</p>
                </div>
                <Sparkles className="w-12 h-12 opacity-50" />
              </div>
            </CardContent>
          </Card>

          {/* Market Overview */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingUp className="w-5 h-5 text-green-600" />
                Market Overview
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="p-4 bg-green-50 rounded-lg">
                  <div className="text-sm text-slate-600 mb-1">Median Home Price</div>
                  <div className="text-2xl font-bold text-green-600">
                    {cityIntelligence.market_overview?.median_home_price || 'N/A'}
                  </div>
                </div>
                <div className="p-4 bg-blue-50 rounded-lg">
                  <div className="text-sm text-slate-600 mb-1">Price Change (YoY)</div>
                  <div className="text-2xl font-bold text-blue-600">
                    {cityIntelligence.market_overview?.price_change_yoy || 'N/A'}
                  </div>
                </div>
                <div className="p-4 bg-purple-50 rounded-lg">
                  <div className="text-sm text-slate-600 mb-1">Avg Days on Market</div>
                  <div className="text-2xl font-bold text-purple-600">
                    {cityIntelligence.market_overview?.avg_days_on_market || 'N/A'}
                  </div>
                </div>
              </div>
              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="p-3 bg-slate-50 rounded-lg">
                  <span className="text-sm text-slate-600">Market Trend:</span>
                  <span className="ml-2 font-semibold">{cityIntelligence.market_overview?.market_trend || 'N/A'}</span>
                </div>
                <div className="p-3 bg-slate-50 rounded-lg">
                  <span className="text-sm text-slate-600">Inventory:</span>
                  <span className="ml-2 font-semibold">{cityIntelligence.market_overview?.inventory_levels || 'N/A'}</span>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Demographics */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Users className="w-5 h-5 text-indigo-600" />
                Demographics
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {cityIntelligence.demographics && Object.entries(cityIntelligence.demographics).map(([key, value]) => (
                  <div key={key} className="p-3 bg-slate-50 rounded-lg">
                    <div className="text-sm text-slate-600 mb-1 capitalize">
                      {key.replace(/_/g, ' ')}
                    </div>
                    <div className="font-semibold">{value || 'N/A'}</div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          {/* Schools & Education */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <GraduationCap className="w-5 h-5 text-amber-600" />
                Schools & Education
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div>
                  <h4 className="font-semibold mb-2">Top-Rated Schools</h4>
                  <div className="flex flex-wrap gap-2">
                    {cityIntelligence.schools?.top_schools?.map((school, idx) => (
                      <Badge key={idx} variant="outline" className="py-1 px-3">
                        {school}
                      </Badge>
                    ))}
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="p-3 bg-amber-50 rounded-lg">
                    <span className="text-sm text-slate-600">District Rating:</span>
                    <span className="ml-2 font-semibold">{cityIntelligence.schools?.district_rating || 'N/A'}</span>
                  </div>
                </div>
                {cityIntelligence.schools?.nearby_colleges?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2">Nearby Colleges & Universities</h4>
                    <div className="flex flex-wrap gap-2">
                      {cityIntelligence.schools.nearby_colleges.map((college, idx) => (
                        <Badge key={idx} className="bg-amber-600 py-1 px-3">
                          {college}
                        </Badge>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Lifestyle & Amenities */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Heart className="w-5 h-5 text-rose-600" />
                Lifestyle & Amenities
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {cityIntelligence.amenities?.attractions?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2 flex items-center gap-2">
                      <MapPin className="w-4 h-4" />
                      Top Attractions
                    </h4>
                    <ul className="space-y-1">
                      {cityIntelligence.amenities.attractions.map((item, idx) => (
                        <li key={idx} className="text-sm text-slate-600">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                )}
                {cityIntelligence.amenities?.shopping?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2 flex items-center gap-2">
                      <ShoppingCart className="w-4 h-4" />
                      Shopping
                    </h4>
                    <ul className="space-y-1">
                      {cityIntelligence.amenities.shopping.map((item, idx) => (
                        <li key={idx} className="text-sm text-slate-600">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                )}
                {cityIntelligence.amenities?.parks?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2 flex items-center gap-2">
                      <Sun className="w-4 h-4" />
                      Parks & Recreation
                    </h4>
                    <ul className="space-y-1">
                      {cityIntelligence.amenities.parks.map((item, idx) => (
                        <li key={idx} className="text-sm text-slate-600">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                )}
                {cityIntelligence.amenities?.healthcare?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2 flex items-center gap-2">
                      <Heart className="w-4 h-4" />
                      Healthcare
                    </h4>
                    <ul className="space-y-1">
                      {cityIntelligence.amenities.healthcare.map((item, idx) => (
                        <li key={idx} className="text-sm text-slate-600">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
              {cityIntelligence.amenities?.dining && (
                <div className="mt-4 p-3 bg-rose-50 rounded-lg">
                  <h4 className="font-semibold mb-1 flex items-center gap-2">
                    <Utensils className="w-4 h-4" />
                    Dining Scene
                  </h4>
                  <p className="text-sm text-slate-600">{cityIntelligence.amenities.dining}</p>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Transportation */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Car className="w-5 h-5 text-cyan-600" />
                Transportation & Commute
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div className="p-3 bg-cyan-50 rounded-lg">
                  <div className="text-sm text-slate-600 mb-1">Avg Commute</div>
                  <div className="font-bold text-cyan-600">{cityIntelligence.transportation?.avg_commute || 'N/A'}</div>
                </div>
                <div className="p-3 bg-cyan-50 rounded-lg">
                  <div className="text-sm text-slate-600 mb-1">Walkability</div>
                  <div className="font-bold text-cyan-600">{cityIntelligence.transportation?.walkability_score || 'N/A'}</div>
                </div>
                <div className="p-3 bg-cyan-50 rounded-lg">
                  <div className="text-sm text-slate-600 mb-1">Bike-Friendly</div>
                  <div className="font-bold text-cyan-600">{cityIntelligence.transportation?.bike_friendly || 'N/A'}</div>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {cityIntelligence.transportation?.public_transit?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2">Public Transportation</h4>
                    <div className="flex flex-wrap gap-2">
                      {cityIntelligence.transportation.public_transit.map((item, idx) => (
                        <Badge key={idx} variant="outline">{item}</Badge>
                      ))}
                    </div>
                  </div>
                )}
                {cityIntelligence.transportation?.major_highways?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2">Major Highways</h4>
                    <div className="flex flex-wrap gap-2">
                      {cityIntelligence.transportation.major_highways.map((item, idx) => (
                        <Badge key={idx} variant="outline">{item}</Badge>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Employment & Economy */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Briefcase className="w-5 h-5 text-purple-600" />
                Employment & Economy
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div className="p-3 bg-purple-50 rounded-lg">
                  <span className="text-sm text-slate-600">Job Growth:</span>
                  <span className="ml-2 font-semibold">{cityIntelligence.economy?.job_growth || 'N/A'}</span>
                </div>
                <div className="p-3 bg-purple-50 rounded-lg">
                  <span className="text-sm text-slate-600">Unemployment Rate:</span>
                  <span className="ml-2 font-semibold">{cityIntelligence.economy?.unemployment_rate || 'N/A'}</span>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {cityIntelligence.economy?.major_employers?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2">Major Employers</h4>
                    <ul className="space-y-1">
                      {cityIntelligence.economy.major_employers.map((item, idx) => (
                        <li key={idx} className="text-sm text-slate-600">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                )}
                {cityIntelligence.economy?.key_industries?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2">Key Industries</h4>
                    <div className="flex flex-wrap gap-2">
                      {cityIntelligence.economy.key_industries.map((item, idx) => (
                        <Badge key={idx} className="bg-purple-600">{item}</Badge>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Climate */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Sun className="w-5 h-5 text-orange-600" />
                Climate & Environment
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div className="p-3 bg-orange-50 rounded-lg text-center">
                  <div className="text-sm text-slate-600 mb-1">Summer</div>
                  <div className="font-bold text-orange-600">{cityIntelligence.climate?.summer_temp || 'N/A'}</div>
                </div>
                <div className="p-3 bg-blue-50 rounded-lg text-center">
                  <div className="text-sm text-slate-600 mb-1">Winter</div>
                  <div className="font-bold text-blue-600">{cityIntelligence.climate?.winter_temp || 'N/A'}</div>
                </div>
                <div className="p-3 bg-cyan-50 rounded-lg text-center">
                  <Droplets className="w-6 h-6 mx-auto mb-1 text-cyan-600" />
                  <div className="text-sm text-slate-600 mb-1">Rainfall</div>
                  <div className="font-semibold text-cyan-600">{cityIntelligence.climate?.annual_rainfall || 'N/A'}</div>
                </div>
                <div className="p-3 bg-green-50 rounded-lg text-center">
                  <div className="text-sm text-slate-600 mb-1">Air Quality</div>
                  <div className="font-semibold text-green-600">{cityIntelligence.climate?.air_quality || 'N/A'}</div>
                </div>
              </div>
              {cityIntelligence.climate?.disaster_risks?.length > 0 && (
                <div className="p-3 bg-amber-50 rounded-lg">
                  <h4 className="font-semibold mb-2">Natural Disaster Risks</h4>
                  <div className="flex flex-wrap gap-2">
                    {cityIntelligence.climate.disaster_risks.map((risk, idx) => (
                      <Badge key={idx} variant="outline" className="border-amber-500 text-amber-700">
                        {risk}
                      </Badge>
                    ))}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Investment Potential */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <DollarSign className="w-5 h-5 text-emerald-600" />
                Real Estate Investment Potential
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div className="p-4 bg-emerald-50 rounded-lg">
                  <div className="text-sm text-slate-600 mb-1">Avg Rent</div>
                  <div className="text-xl font-bold text-emerald-600">
                    {cityIntelligence.investment?.avg_rent || 'N/A'}
                  </div>
                </div>
                <div className="p-4 bg-emerald-50 rounded-lg">
                  <div className="text-sm text-slate-600 mb-1">Cap Rate</div>
                  <div className="text-xl font-bold text-emerald-600">
                    {cityIntelligence.investment?.cap_rate || 'N/A'}
                  </div>
                </div>
                <div className="p-4 bg-emerald-50 rounded-lg">
                  <div className="text-sm text-slate-600 mb-1">Growth Projection</div>
                  <div className="text-xl font-bold text-emerald-600">
                    {cityIntelligence.investment?.growth_projection || 'N/A'}
                  </div>
                </div>
              </div>
              <div className="p-3 bg-slate-50 rounded-lg mb-4">
                <span className="text-sm text-slate-600">Rental Market:</span>
                <span className="ml-2 font-semibold">{cityIntelligence.investment?.rental_market || 'N/A'}</span>
              </div>
              {cityIntelligence.investment?.future_development?.length > 0 && (
                <div>
                  <h4 className="font-semibold mb-2">Future Development Plans</h4>
                  <ul className="space-y-1">
                    {cityIntelligence.investment.future_development.map((item, idx) => (
                      <li key={idx} className="text-sm text-slate-600">‚Ä¢ {item}</li>
                    ))}
                  </ul>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Pros & Cons */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Card className="border-green-200">
              <CardHeader>
                <CardTitle className="text-green-700">‚úÖ Pros of Living Here</CardTitle>
              </CardHeader>
              <CardContent>
                <ul className="space-y-2">
                  {cityIntelligence.pros?.map((pro, idx) => (
                    <li key={idx} className="flex items-start gap-2">
                      <span className="text-green-600 mt-1">‚úì</span>
                      <span className="text-sm">{pro}</span>
                    </li>
                  ))}
                </ul>
              </CardContent>
            </Card>

            <Card className="border-amber-200">
              <CardHeader>
                <CardTitle className="text-amber-700">‚ö†Ô∏è Cons to Consider</CardTitle>
              </CardHeader>
              <CardContent>
                <ul className="space-y-2">
                  {cityIntelligence.cons?.map((con, idx) => (
                    <li key={idx} className="flex items-start gap-2">
                      <span className="text-amber-600 mt-1">!</span>
                      <span className="text-sm">{con}</span>
                    </li>
                  ))}
                </ul>
              </CardContent>
            </Card>
          </div>

          {/* Agent Tips */}
          <Card className="border-indigo-200 bg-gradient-to-br from-indigo-50 to-purple-50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-indigo-700">
                <Sparkles className="w-5 h-5" />
                Agent Tips & Insights
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {cityIntelligence.agent_tips?.first_time_buyers?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2 text-indigo-700">Best for First-Time Buyers</h4>
                    <ul className="space-y-1">
                      {cityIntelligence.agent_tips.first_time_buyers.map((item, idx) => (
                        <li key={idx} className="text-sm text-slate-700">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                )}
                {cityIntelligence.agent_tips?.families?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2 text-indigo-700">Best for Families</h4>
                    <ul className="space-y-1">
                      {cityIntelligence.agent_tips.families.map((item, idx) => (
                        <li key={idx} className="text-sm text-slate-700">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                )}
                {cityIntelligence.agent_tips?.investors?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2 text-indigo-700">Best for Investors</h4>
                    <ul className="space-y-1">
                      {cityIntelligence.agent_tips.investors.map((item, idx) => (
                        <li key={idx} className="text-sm text-slate-700">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                )}
                {cityIntelligence.agent_tips?.selling_points?.length > 0 && (
                  <div>
                    <h4 className="font-semibold mb-2 text-indigo-700">Unique Selling Points</h4>
                    <ul className="space-y-1">
                      {cityIntelligence.agent_tips.selling_points.map((item, idx) => (
                        <li key={idx} className="text-sm text-slate-700">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Empty State */}
      {!selectedCounty && !isLoadingCities && (
        <Card>
          <CardContent className="p-12 text-center">
            <MapPin className="w-16 h-16 mx-auto mb-4 text-slate-300" />
            <h3 className="text-xl font-semibold text-slate-900 mb-2">
              Explore County & City Intelligence
            </h3>
            <p className="text-slate-600 mb-6">
              Search for any county to discover detailed market insights, demographics, and local intelligence for all major cities.
            </p>
            <div className="flex flex-wrap gap-2 justify-center">
              <Badge variant="outline" className="py-2 px-4">Market Data</Badge>
              <Badge variant="outline" className="py-2 px-4">Demographics</Badge>
              <Badge variant="outline" className="py-2 px-4">Schools</Badge>
              <Badge variant="outline" className="py-2 px-4">Lifestyle</Badge>
              <Badge variant="outline" className="py-2 px-4">Investment Analysis</Badge>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Plus, Mail, Share2, TrendingUp, Calendar, DollarSign, ArrowLeft, Eye, MousePointer, Users, Search, Send, Edit, Trash2, PiggyBank } from "lucide-react";
import { useLocation, useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Badge } from "@/components/ui/badge";
import { Card } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { toast } from "sonner";

import MarketingCampaignModal from "../components/marketing/MarketingCampaignModal";
import AIAdvisoryDashboard from "../components/marketing/AIAdvisoryDashboard";

// Aggressive caching to prevent rate limits
const CACHE_CONFIG = {
  staleTime: 15 * 60 * 1000, // 15 minutes
  cacheTime: 30 * 60 * 1000, // 30 minutes
  retry: false,
  refetchOnMount: false,
  refetchOnWindowFocus: false,
  refetchOnReconnect: false,
};

export default function MarketingCampaigns() {
  const navigate = useNavigate();
  const location = useLocation();
  const queryClient = useQueryClient();
  
  const [showModal, setShowModal] = useState(false);
  const [editingCampaign, setEditingCampaign] = useState(null);
  const [isSending, setIsSending] = useState(false);
  const [isCleaning, setIsCleaning] = useState(false);
  const [showAddFundsModal, setShowAddFundsModal] = useState(false);
  const [fundsToAdd, setFundsToAdd] = useState("");

  // Filters
  const [searchTerm, setSearchTerm] = useState("");
  const [statusFilter, setStatusFilter] = useState("all");
  const [typeFilter, setTypeFilter] = useState("all");

  // Query for user data with caching
  const { data: user, isLoading: isUserLoading } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me(),
    ...CACHE_CONFIG,
  });

  // Query for campaigns with caching
  const { data: campaigns = [], isLoading: isCampaignsLoading } = useQuery({
    queryKey: ['marketingCampaigns'],
    queryFn: async () => {
      try {
        return await base44.entities.MarketingCampaign.list("-created_date");
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for campaigns, using cached data');
          toast.warning('Rate limit reached - showing cached data');
        } else {
          console.error('Error fetching campaigns:', error);
        }
        return [];
      }
    },
    enabled: !!user,
    ...CACHE_CONFIG,
  });

  // Query for properties with caching
  const { data: properties = [] } = useQuery({
    queryKey: ['properties'],
    queryFn: async () => {
      try {
        return await base44.entities.Property.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for properties, using cached data');
        } else {
          console.error('Error fetching properties:', error);
        }
        return [];
      }
    },
    enabled: !!user,
    ...CACHE_CONFIG,
  });

  // Query for contacts with caching
  const { data: contacts = [] } = useQuery({
    queryKey: ['contacts'],
    queryFn: async () => {
      try {
        return await base44.entities.Contact.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for contacts, using cached data');
        } else {
          console.error('Error fetching contacts:', error);
        }
        return [];
      }
    },
    enabled: !!user,
    ...CACHE_CONFIG,
  });

  // Query for leads with caching
  const { data: leads = [] } = useQuery({
    queryKey: ['leads'],
    queryFn: async () => {
      try {
        return await base44.entities.Lead.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for leads, using cached data');
        } else {
          console.error('Error fetching leads:', error);
        }
        return [];
      }
    },
    enabled: !!user,
    ...CACHE_CONFIG,
  });

  // Query for transactions with caching
  const { data: transactions = [] } = useQuery({
    queryKey: ['transactions'],
    queryFn: async () => {
      try {
        return await base44.entities.Transaction.list();
      } catch (error) {
        if (error.message?.includes('Rate limit')) {
          console.warn('Rate limit hit for transactions, using cached data');
        } else {
          console.error('Error fetching transactions:', error);
        }
        return [];
      }
    },
    enabled: !!user,
    ...CACHE_CONFIG,
  });

  const isLoading = isUserLoading || isCampaignsLoading;
  const marketingBudget = user?.marketing_budget_balance || 0;

  useEffect(() => {
    if (!isLoading && user) {
      const params = new URLSearchParams(location.search);
      const newlyFunded = params.get('newlyFunded');
      const editCampaign = params.get('editCampaign');

      if (newlyFunded) {
        const amount = parseFloat(newlyFunded);
        if (!isNaN(amount) && amount > 0) {
          const currentBudget = user.marketing_budget_balance || 0;
          const newBudget = currentBudget + amount;
          
          base44.auth.updateMe({ marketing_budget_balance: newBudget }).then(() => {
            queryClient.invalidateQueries({ queryKey: ['user'] });
            toast.success(`$${amount.toLocaleString()} has been added to your marketing budget!`);
          }).catch(error => {
            console.error("Failed to update marketing budget:", error);
            toast.error("Could not update your marketing budget.");
          });
          
          navigate(createPageUrl("MarketingCampaigns"), { replace: true });
        }
      }

      // Auto-open edit modal if editCampaign param is present
      if (editCampaign && campaigns.length > 0) {
        const campaignToEdit = campaigns.find(c => c.id === editCampaign);
        if (campaignToEdit) {
          setEditingCampaign(campaignToEdit);
          setShowModal(true);
          // Remove the param from URL
          navigate(createPageUrl("MarketingCampaigns"), { replace: true });
        }
      }
    }
  }, [isLoading, user, location.search, navigate, queryClient, campaigns]);

  const sendCampaignEmail = async (campaign) => {
    if (campaign.campaign_type !== 'email') {
      console.warn("Only email campaigns can be sent via this method.");
      return { sentCount: 0, failedCount: 0 };
    }

    const content = JSON.parse(campaign.content || '{}');
    const recipientIds = campaign.recipient_ids || {};
    
    const recipients = [
      ...(recipientIds.contacts || []).map(id => contacts.find(c => c.id === id)).filter(Boolean),
      ...(recipientIds.leads || []).map(id => leads.find(l => l.id === id)).filter(Boolean)
    ];

    let sentCount = 0;
    let failedCount = 0;

    for (const recipient of recipients) {
      try {
        await base44.integrations.Core.SendEmail({
          to: recipient.email,
          subject: content.subject || campaign.name,
          body: content.html_body || content.content || campaign.description,
          from_name: user?.full_name || "Agent"
        });
        sentCount++;
        await new Promise(resolve => setTimeout(resolve, 1000));
      } catch (error) {
        console.error(`Failed to send to ${recipient.email}:`, error);
        failedCount++;
      }
    }

    await base44.entities.MarketingCampaign.update(campaign.id, {
      status: 'completed',
      metrics: {
        ...campaign.metrics,
        sent: sentCount,
        failed: failedCount,
        sent_date: new Date().toISOString()
      }
    });

    return { sentCount, failedCount };
  };

  const saveCampaignMutation = useMutation({
    mutationFn: async (campaignData) => {
      let savedCampaign;

      if (!editingCampaign && campaignData.budget > 0) {
        const currentBudget = user?.marketing_budget_balance || 0;
        if (campaignData.budget > currentBudget) {
          throw new Error("Campaign budget exceeds available marketing funds.");
        }
        const newBudget = currentBudget - campaignData.budget;
        
        await base44.auth.updateMe({ marketing_budget_balance: newBudget });
      }

      if (editingCampaign) {
        savedCampaign = await base44.entities.MarketingCampaign.update(editingCampaign.id, campaignData);
      } else {
        savedCampaign = await base44.entities.MarketingCampaign.create({ ...campaignData, created_by: user.id });
      }

      if (savedCampaign.status === "active" && !editingCampaign && savedCampaign.campaign_type === 'email') {
        const { sentCount, failedCount } = await sendCampaignEmail(savedCampaign);
        return { savedCampaign, sentCount, failedCount };
      }

      return { savedCampaign };
    },
    onSuccess: (result) => {
      queryClient.invalidateQueries({ queryKey: ['marketingCampaigns'] });
      queryClient.invalidateQueries({ queryKey: ['user'] });
      
      let message = editingCampaign ? "Campaign updated successfully!" : "Campaign created successfully!";
      if (result.sentCount !== undefined) {
        message += ` Email sent: ${result.sentCount} successful, ${result.failedCount} failed.`;
      }
      
      toast.success(message);
      setShowModal(false);
      setEditingCampaign(null);
    },
    onError: (error) => {
      console.error("Error saving campaign:", error);
      toast.error(error.message || "Failed to save campaign.");
    }
  });

  const deleteCampaignMutation = useMutation({
    mutationFn: (campaignId) => base44.entities.MarketingCampaign.delete(campaignId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['marketingCampaigns'] });
      toast.success("Campaign deleted successfully!");
    },
    onError: (error) => {
      console.error("Error deleting campaign:", error);
      toast.error("Failed to delete campaign");
    }
  });

  const handleDelete = async (campaignId) => {
    if (!confirm("Are you sure you want to delete this campaign?")) return;
    deleteCampaignMutation.mutate(campaignId);
  };

  const handleCleanupDemoCampaigns = async () => {
    if (!confirm("Are you sure you want to delete all campaigns containing 'Demo Campaign'? This action cannot be undone.")) {
      return;
    }
    setIsCleaning(true);
    try {
      const demoCampaigns = campaigns.filter(c => c.name && c.name.includes("Demo Campaign"));
      if (demoCampaigns.length === 0) {
        toast.info("No demo campaigns found.");
        setIsCleaning(false);
        return;
      }
      
      const deletePromises = demoCampaigns.map(c => base44.entities.MarketingCampaign.delete(c.id));
      await Promise.all(deletePromises);
      
      toast.success(`Successfully deleted ${demoCampaigns.length} demo campaigns.`);
      queryClient.invalidateQueries({ queryKey: ['marketingCampaigns'] });
    } catch (error) {
      console.error("Error cleaning up demo campaigns:", error);
      toast.error("An error occurred while deleting demo campaigns.");
    }
    setIsCleaning(false);
  };

  const handleSendCampaign = async (campaign) => {
    if (campaign.campaign_type !== 'email') {
      alert("Only email campaigns can be sent from here");
      return;
    }

    if (!confirm(`Send this email campaign to ${campaign.recipient_ids?.contacts?.length + campaign.recipient_ids?.leads?.length || 0} recipients?`)) {
      return;
    }

    setIsSending(true);
    try {
      const { sentCount, failedCount } = await sendCampaignEmail(campaign);
      toast.success(`Campaign sent! ${sentCount} successful, ${failedCount} failed.`);
      queryClient.invalidateQueries({ queryKey: ['marketingCampaigns'] });
    } catch (error) {
      console.error("Error sending campaign:", error);
      toast.error("Failed to send campaign");
    }
    setIsSending(false);
  };

  const handleAddFunds = async () => {
    const amount = parseFloat(fundsToAdd);
    if (isNaN(amount) || amount <= 0) {
      toast.error("Please enter a valid positive amount.");
      return;
    }

    try {
      const newBudget = (user?.marketing_budget_balance || 0) + amount;
      await base44.auth.updateMe({ marketing_budget_balance: newBudget });
      queryClient.invalidateQueries({ queryKey: ['user'] });
      toast.success(`$${amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })} has been added to your marketing budget!`);
      setShowAddFundsModal(false);
      setFundsToAdd("");
    } catch (error) {
      console.error("Failed to add funds:", error);
      toast.error("Could not update your marketing budget.");
    }
  };

  const getStatusColor = (status) => {
    const colors = {
      draft: "bg-slate-100 text-slate-700 border-slate-200",
      scheduled: "bg-blue-100 text-blue-700 border-blue-200",
      active: "bg-green-100 text-green-700 border-green-200",
      completed: "bg-purple-100 text-purple-700 border-purple-200",
      cancelled: "bg-red-100 text-red-700 border-red-200"
    };
    return colors[status] || colors.draft;
  };

  const getCampaignTypeIcon = (type) => {
    const icons = {
      email: <Mail className="w-5 h-5" />,
      social_media: <Share2 className="w-5 h-5" />,
      direct_mail: <Mail className="w-5 h-5" />,
      open_house: <Calendar className="w-5 h-5" />,
      just_listed: <TrendingUp className="w-5 h-5" />,
      just_sold: <TrendingUp className="w-5 h-5" />,
      price_reduction: <DollarSign className="w-5 h-5" />,
      general: <Share2 className="w-5 h-5" />
    };
    return icons[type] || icons.general;
  };

  const calculateStats = () => {
    const total = campaigns.length;
    const active = campaigns.filter(c => c.status === "active").length;
    const email = campaigns.filter(c => c.campaign_type === "email").length;
    const social = campaigns.filter(c => c.campaign_type === "social_media").length;
    
    return { total, active, email, social };
  };

  const filteredCampaigns = campaigns.filter(campaign => {
    const searchMatch = searchTerm === "" || 
      (campaign.name && campaign.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
      (campaign.description && campaign.description.toLowerCase().includes(searchTerm.toLowerCase()));
    
    const statusMatch = statusFilter === "all" || campaign.status === statusFilter;
    const typeMatch = typeFilter === "all" || campaign.campaign_type === typeFilter;
    
    return searchMatch && statusMatch && typeMatch;
  });

  const stats = calculateStats();

  if (isLoading) {
    return (
      <div className="p-8 animate-pulse">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {Array(6).fill(0).map((_, i) => (
            <div key={i} className="h-64 bg-slate-200 rounded-lg"></div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Header */}
        <div className="app-card p-6">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6">
            <div className="flex items-center gap-4">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => navigate(createPageUrl("Dashboard"))}
                className="rounded-full flex-shrink-0"
              >
                <ArrowLeft className="w-5 h-5" />
              </Button>
              <div className="flex-1">
                <h1 className="app-title text-2xl">Marketing Campaigns</h1>
                <p className="app-subtitle">Manage and track your marketing initiatives</p>
              </div>
            </div>
            
            <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-4 w-full sm:w-auto">
              <div className="flex items-center gap-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-6 py-3">
                <div className="p-3 bg-green-100 dark:bg-green-900/30 rounded-full">
                  <DollarSign className="w-6 h-6 text-green-600 dark:text-green-400" />
                </div>
                <div>
                  <p className="text-sm text-slate-500 dark:text-slate-400">Available Budget</p>
                  <p className="text-2xl font-bold text-slate-800 dark:text-white">
                    {marketingBudget.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <Button variant="outline" onClick={() => setShowAddFundsModal(true)}>
                  <PiggyBank className="w-4 h-4 mr-2" />
                  Add Funds
                </Button>
                <Button variant="outline" onClick={handleCleanupDemoCampaigns} disabled={isCleaning}>
                  <Trash2 className="w-4 h-4 mr-2" />
                  {isCleaning ? 'Cleaning...' : 'Clean Demo Data'}
                </Button>
                <Button onClick={() => setShowModal(true)} className="app-button">
                  <Plus className="w-4 h-4 mr-2" />
                  New Campaign
                </Button>
              </div>
            </div>
          </div>
        </div>

        {/* Stats Cards */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div className="app-card p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="app-text-muted text-sm mb-2">Total Campaigns</p>
                <p className="app-title text-3xl text-indigo-600">{stats.total}</p>
              </div>
              <div className="p-3 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg">
                <Share2 className="w-6 h-6 text-white" />
              </div>
            </div>
          </div>

          <div className="app-card p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="app-text-muted text-sm mb-2">Active</p>
                <p className="app-title text-3xl text-green-600">{stats.active}</p>
              </div>
              <div className="p-3 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg">
                <TrendingUp className="w-6 h-6 text-white" />
              </div>
            </div>
          </div>

          <div className="app-card p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="app-text-muted text-sm mb-2">Email Campaigns</p>
                <p className="app-title text-3xl text-blue-600">{stats.email}</p>
              </div>
              <div className="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 shadow-lg">
                <Mail className="w-6 h-6 text-white" />
              </div>
            </div>
          </div>

          <div className="app-card p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="app-text-muted text-sm mb-2">Social Media</p>
                <p className="app-title text-3xl text-purple-600">{stats.social}</p>
              </div>
              <div className="p-3 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 shadow-lg">
                <Share2 className="w-6 h-6 text-white" />
              </div>
            </div>
          </div>
        </div>

        {/* AI Advisory Dashboard */}
        <AIAdvisoryDashboard 
          campaigns={campaigns} 
          leads={leads}
          marketingBudget={marketingBudget}
          preferredChannels={JSON.parse(user?.preferred_marketing_channels || '[]')}
        />

        {/* Filters */}
        <div className="app-card p-4">
          <div className="flex flex-col md:flex-row gap-4">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
              <Input
                placeholder="Search campaigns..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10"
              />
            </div>
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger className="w-full md:w-40">
                <SelectValue placeholder="Status" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Status</SelectItem>
                <SelectItem value="draft">Draft</SelectItem>
                <SelectItem value="scheduled">Scheduled</SelectItem>
                <SelectItem value="active">Active</SelectItem>
                <SelectItem value="completed">Completed</SelectItem>
                <SelectItem value="cancelled">Cancelled</SelectItem>
              </SelectContent>
            </Select>
            <Select value={typeFilter} onValueChange={setTypeFilter}>
              <SelectTrigger className="w-full md:w-40">
                <SelectValue placeholder="Type" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Types</SelectItem>
                <SelectItem value="email">Email</SelectItem>
                <SelectItem value="social_media">Social Media</SelectItem>
                <SelectItem value="direct_mail">Direct Mail</SelectItem>
                <SelectItem value="open_house">Open House</SelectItem>
                <SelectItem value="general">General</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Campaign Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredCampaigns.length > 0 ? (
            filteredCampaigns.map((campaign) => {
              const metrics = campaign.metrics || {};
              const recipientCount = (campaign.recipient_ids?.contacts?.length || 0) + (campaign.recipient_ids?.leads?.length || 0);

              return (
                <Card key={campaign.id} className="overflow-hidden hover:shadow-lg transition-shadow">
                  <div className="p-6 space-y-4">
                    {/* Header */}
                    <div className="flex items-start justify-between">
                      <div className="flex items-center gap-3">
                        <div className="p-2 rounded-lg bg-indigo-100 text-indigo-600">
                          {getCampaignTypeIcon(campaign.campaign_type)}
                        </div>
                        <div>
                          <h3 className="font-semibold text-slate-900">{campaign.name}</h3>
                          <p className="text-xs text-slate-500 capitalize">
                            {campaign.campaign_type.replace('_', ' ')}
                          </p>
                        </div>
                      </div>
                      <Badge className={getStatusColor(campaign.status)}>
                        {campaign.status}
                      </Badge>
                    </div>

                    {/* Description */}
                    {campaign.description && (
                      <p className="text-sm text-slate-600 line-clamp-2">
                        {campaign.description}
                      </p>
                    )}

                    {/* Recipients */}
                    {campaign.campaign_type === 'email' && recipientCount > 0 && (
                      <div className="flex items-center gap-2 text-sm">
                        <Users className="w-4 h-4 text-slate-500" />
                        <span className="text-slate-600">
                          {recipientCount} recipient{recipientCount !== 1 ? 's' : ''}
                        </span>
                      </div>
                    )}

                    {/* Dates */}
                    {(campaign.start_date || campaign.end_date) && (
                      <div className="flex items-center gap-2 text-xs text-slate-500">
                        <Calendar className="w-4 h-4" />
                        <span>
                          {campaign.start_date && new Date(campaign.start_date).toLocaleDateString()}
                          {campaign.end_date && ` - ${new Date(campaign.end_date).toLocaleDateString()}`}
                        </span>
                      </div>
                    )}

                    {/* Metrics */}
                    {Object.keys(metrics).length > 0 && (
                      <div className="grid grid-cols-3 gap-3 pt-3 border-t border-slate-100">
                        {metrics.sent && (
                          <div>
                            <div className="flex items-center gap-1 text-xs text-slate-500 mb-1">
                              <Send className="w-3 h-3" />
                              <span>Sent</span>
                            </div>
                            <p className="font-semibold text-slate-900">
                              {metrics.sent}
                            </p>
                          </div>
                        )}
                        {metrics.opens && (
                          <div>
                            <div className="flex items-center gap-1 text-xs text-slate-500 mb-1">
                              <Eye className="w-3 h-3" />
                              <span>Opens</span>
                            </div>
                            <p className="font-semibold text-slate-900">
                              {metrics.opens}
                            </p>
                          </div>
                        )}
                        {metrics.clicks && (
                          <div>
                            <div className="flex items-center gap-1 text-xs text-slate-500 mb-1">
                              <MousePointer className="w-3 h-3" />
                              <span>Clicks</span>
                            </div>
                            <p className="font-semibold text-slate-900">
                              {metrics.clicks}
                            </p>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Actions */}
                    <div className="flex gap-2 pt-3 border-t border-slate-100">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => {
                          setEditingCampaign(campaign);
                          setShowModal(true);
                        }}
                        className="flex-1"
                      >
                        <Edit className="w-3 h-3 mr-1" />
                        Edit
                      </Button>
                      
                      {campaign.campaign_type === 'email' && campaign.status === 'draft' && (
                        <Button
                          size="sm"
                          onClick={() => handleSendCampaign(campaign)}
                          disabled={isSending}
                          className="flex-1 bg-green-600 hover:bg-green-700"
                        >
                          <Send className="w-3 h-3 mr-1" />
                          Send
                        </Button>
                      )}
                      
                      <Button
                        size="sm"
                        variant="ghost"
                        onClick={() => handleDelete(campaign.id)}
                        className="text-red-600 hover:text-red-700"
                      >
                        <Trash2 className="w-3 h-3" />
                      </Button>
                    </div>
                  </div>
                </Card>
              );
            })
          ) : (
            <div className="col-span-full app-card p-16 text-center">
              <Share2 className="w-20 h-20 mx-auto mb-6 text-slate-300" />
              <h3 className="app-title text-xl mb-3">No campaigns yet</h3>
              <p className="app-subtitle mb-6">
                Start promoting your listings with marketing campaigns
              </p>
              <Button onClick={() => setShowModal(true)} className="app-button">
                Create First Campaign
              </Button>
            </div>
          )}
        </div>

        {/* Modal */}
        {showModal && (
          <MarketingCampaignModal
            campaign={editingCampaign}
            properties={properties}
            contacts={contacts}
            leads={leads}
            onSave={(data) => saveCampaignMutation.mutate(data)}
            onClose={() => {
              setShowModal(false);
              setEditingCampaign(null);
            }}
          />
        )}
        
        {/* Add Funds Modal */}
        {showAddFundsModal && (
          <Dialog open={true} onOpenChange={() => setShowAddFundsModal(false)}>
            <DialogContent>
              <DialogHeader>
                <DialogTitle>Add Funds to Marketing Budget</DialogTitle>
              </DialogHeader>
              <div className="space-y-4 py-4">
                <div className="space-y-2">
                  <Label htmlFor="funds-amount">Amount to Add</Label>
                  <div className="relative">
                    <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                    <Input
                      id="funds-amount"
                      type="number"
                      placeholder="e.g., 500"
                      value={fundsToAdd}
                      onChange={(e) => setFundsToAdd(e.target.value)}
                      className="pl-8"
                    />
                  </div>
                </div>
                <div className="text-sm text-slate-500">
                  This will manually increase your available marketing budget.
                </div>
              </div>
              <DialogFooter>
                <Button variant="outline" onClick={() => setShowAddFundsModal(false)}>Cancel</Button>
                <Button onClick={handleAddFunds}>Add Funds</Button>
              </DialogFooter>
            </DialogContent>
          </Dialog>
        )}
      </div>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { Property } from "@/api/entities";
import { Photo } from "@/api/entities";
import { User } from "@/api/entities";
import { MarketingCampaign } from "@/api/entities";
import { Contact } from "@/api/entities";
import { Lead } from "@/api/entities";
import { InvokeLLM } from "@/api/integrations";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { 
  ArrowLeft, Sparkles, Download, Share2, Printer, Mail, Instagram, 
  Facebook, Linkedin, Image as ImageIcon, Loader2, Palette, Save, Copy, CheckCircle2, Clock, AlignLeft, AlignCenter, AlignRight, Eye, FileImage, ChevronLeft, ChevronRight, RefreshCw, Twitter
} from "lucide-react";
import { toast } from "sonner";

// Design Templates Library
const DESIGN_TEMPLATES = {
  instagram_post: [
    {
      id: "ig_modern_luxury",
      name: "Modern Luxury",
      preview: "https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400",
      style: "Clean, modern design with bold typography",
      layout: "featured_image_with_overlay"
    },
    {
      id: "ig_elegant_minimal",
      name: "Elegant Minimal",
      preview: "https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=400",
      style: "Minimalist design with focus on property",
      layout: "split_image_text"
    },
    {
      id: "ig_bold_vibrant",
      name: "Bold & Vibrant",
      preview: "https://images.unsplash.com/photo-1600566753376-12c8ab7fb75b?w=400",
      style: "Eye-catching colors and dynamic layout",
      layout: "carousel_ready"
    },
    {
      id: "ig_professional",
      name: "Professional",
      preview: "https://images.unsplash.com/photo-1600047509807-ba8f99d2cdde?w=400",
      style: "Professional real estate branding",
      layout: "branded_header"
    }
  ],
  facebook_post: [
    {
      id: "fb_community_focus",
      name: "Community Focus",
      preview: "https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400",
      style: "Warm, inviting community-focused design",
      layout: "landscape_with_callout"
    },
    {
      id: "fb_just_listed",
      name: "Just Listed Banner",
      preview: "https://images.unsplash.com/photo-1600585154526-990dced4db0d?w=400",
      style: "Attention-grabbing 'Just Listed' banner",
      layout: "banner_style"
    },
    {
      id: "fb_open_house",
      name: "Open House Invite",
      preview: "https://images.unsplash.com/photo-1600607687644-c7171b42498f?w=400",
      style: "Inviting open house announcement",
      layout: "event_style"
    }
  ],
  email_header: [
    {
      id: "email_newsletter",
      name: "Newsletter Header",
      preview: "https://images.unsplash.com/photo-1600585154363-67eb9e2e2099?w=400",
      style: "Professional email header with branding",
      layout: "header_with_logo"
    },
    {
      id: "email_property_showcase",
      name: "Property Showcase",
      preview: "https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400",
      style: "Large hero image with property details",
      layout: "hero_style"
    },
    {
      id: "email_market_update",
      name: "Market Update",
      preview: "https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400",
      style: "Data-focused market update design",
      layout: "stats_focused"
    }
  ],
  print_flyer: [
    {
      id: "flyer_classic",
      name: "Classic Flyer",
      preview: "https://images.unsplash.com/photo-1600047509807-ba8f99d2cdde?w=400",
      style: "Traditional real estate flyer layout",
      layout: "print_ready_classic"
    },
    {
      id: "flyer_modern",
      name: "Modern Flyer",
      preview: "https://images.unsplash.com/photo-1600566753376-12c8ab7fb75b?w=400",
      style: "Contemporary design with bold elements",
      layout: "print_ready_modern"
    },
    {
      id: "flyer_luxury",
      name: "Luxury Flyer",
      preview: "https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=400",
      style: "High-end luxury property presentation",
      layout: "print_ready_luxury"
    }
  ]
};

export default function MarketingDesignStudio() {
  const navigate = useNavigate();
  const [properties, setProperties] = useState([]);
  const [propertyPhotos, setPropertyPhotos] = useState([]);
  const [contacts, setContacts] = useState([]);
  const [leads, setLeads] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const [isLoadingPhotos, setIsLoadingPhotos] = useState(false);
  
  // Design Studio State
  const [currentView, setCurrentView] = useState("templates"); // templates, editor, export
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [designCategory, setDesignCategory] = useState("instagram_post");
  const [selectedProperty, setSelectedProperty] = useState("");
  const [selectedPhotoIndex, setSelectedPhotoIndex] = useState(0);
  const [customizationMode, setCustomizationMode] = useState(false);
  
  // Design Customization
  const [designSettings, setDesignSettings] = useState({
    headline: "",
    subheadline: "",
    price: "",
    details: "",
    cta_text: "Schedule Your Showing",
    background_color: "#000000",
    text_color: "#ffffff",
    accent_color: "#667eea",
    font_family: "Inter",
    font_size: "medium",
    text_align: "left",
    show_agent_info: true,
    show_logo: true,
    show_status_badge: true
  });
  
  // Brand Settings
  const [brandSettings, setBrandSettings] = useState({
    primary_color: "#667eea",
    secondary_color: "#764ba2",
    logo_url: "",
    agent_name: "",
    agent_title: "Real Estate Agent",
    phone: "",
    email: "",
    website: "",
    tagline: "Your Dream Home Awaits",
    social_instagram: "",
    social_facebook: "",
    social_linkedin: ""
  });

  // Generated Content
  const [generatedDesign, setGeneratedDesign] = useState(null);
  const [designHistory, setDesignHistory] = useState([]);

  // Modals
  const [showEmailCampaignModal, setShowEmailCampaignModal] = useState(false);
  const [showSocialMediaModal, setShowSocialMediaModal] = useState(false);
  const [showPhotoSelectorModal, setShowPhotoSelectorModal] = useState(false);

  // Social Media Distribution State
  const [socialMediaPosts, setSocialMediaPosts] = useState({
    instagram: { enabled: false, caption: "", hashtags: [], scheduled_time: "", cta: "" },
    facebook: { enabled: false, caption: "", hashtags: [], scheduled_time: "", cta: "" },
    linkedin: { enabled: false, caption: "", hashtags: [], scheduled_time: "", cta: "" },
    twitter: { enabled: false, caption: "", hashtags: [], scheduled_time: "", cta: "" }
  });
  
  const [captionVariations, setCaptionVariations] = useState({
    instagram: [],
    facebook: [],
    linkedin: [],
    twitter: []
  });

  useEffect(() => {
    loadData();
  }, []);

  useEffect(() => {
    if (selectedProperty) {
      loadPropertyPhotos(selectedProperty);
    }
  }, [selectedProperty]);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [user, propertiesData, contactsData, leadsData] = await Promise.all([
        User.me(),
        Property.list(),
        Contact.list().catch(() => []),
        Lead.list().catch(() => [])
      ]);
      
      setCurrentUser(user);
      setProperties(propertiesData.filter(p => p.status === 'active') || []);
      setContacts(contactsData || []);
      setLeads(leadsData.filter(l => l.status !== 'lost') || []);
      
      setBrandSettings(prev => ({
        ...prev,
        agent_name: user.full_name || "",
        phone: user.phone || "",
        email: user.email || "",
        website: user.office || "",
        logo_url: user.brokerage_logo_url || "" // Assuming user has a brokerage logo URL
      }));
    } catch (error) {
      console.error("Error loading data:", error);
    }
    setIsLoading(false);
  };

  const loadPropertyPhotos = async (propertyId) => {
    setIsLoadingPhotos(true);
    try {
      const photos = await Photo.filter({ property_id: propertyId });
      const approvedPhotos = (photos || []).filter(p => 
        p.approval_status === 'approved' || p.approval_status === 'broker_approved' || p.approval_status === 'live'
      );
      
      // If no approved photos, use the property's primary photo
      if (approvedPhotos.length === 0) {
        const property = properties.find(p => p.id === propertyId);
        if (property && property.primary_photo_url) {
          setPropertyPhotos([{ 
            id: 'primary', 
            file_url: property.primary_photo_url,
            caption: 'Primary Photo'
          }]);
        } else {
          setPropertyPhotos([]);
        }
      } else {
        setPropertyPhotos(approvedPhotos);
      }
      
      setSelectedPhotoIndex(0);
      
    } catch (error) {
      console.error("Error loading property photos:", error);
      toast.error("Failed to load property photos");
    }
    setIsLoadingPhotos(false);
  };

  const getCurrentPhoto = () => {
    if (propertyPhotos.length === 0) return null;
    return propertyPhotos[selectedPhotoIndex];
  };

  const handleTemplateSelect = (template) => {
    setSelectedTemplate(template);
    setCurrentView("editor");
    
    // Auto-fill design settings if property is selected
    const property = properties.find(p => p.id === selectedProperty);
    if (property) {
      setDesignSettings(prev => ({
        ...prev,
        headline: `${property.bedrooms} Bed, ${property.bathrooms} Bath Home`,
        subheadline: property.address,
        price: `$${property.price?.toLocaleString()}`,
        details: `${property.square_feet?.toLocaleString()} sqft ‚Ä¢ ${property.property_type.replace('_', ' ')}`
      }));
    }
  };

  const handleGenerateDesign = async () => {
    if (!selectedProperty) {
      toast.error("Please select a property first");
      return;
    }

    const currentPhoto = getCurrentPhoto();
    if (!currentPhoto) {
      toast.error("No photos available for this property. Please upload photos first.");
      return;
    }

    setIsGenerating(true);
    try {
      const property = properties.find(p => p.id === selectedProperty);
      
      toast.info("Generating professional marketing design...");

      // Generate comprehensive marketing copy with AI
      const copyPrompt = `Create compelling marketing copy for a ${designCategory.replace('_', ' ')} for this property:

Property Details:
- Address: ${property.address}, ${property.city}, ${property.state} ${property.zip_code}
- Price: $${property.price?.toLocaleString()}
- Bedrooms: ${property.bedrooms}
- Bathrooms: ${property.bathrooms}
- Square Feet: ${property.square_feet?.toLocaleString()}
- Property Type: ${property.property_type?.replace('_', ' ')}
- Year Built: ${property.year_built}
- Features: ${property.features || 'Modern amenities'}
- Description: ${property.description || ''}

Style: ${selectedTemplate?.name || 'modern'}
Platform: ${designCategory}

Generate complete marketing content with:
1. Main Headline (5-8 words, attention-grabbing)
2. Sub Headline (10-15 words, highlight key features)
3. Property Description (2-3 sentences, lifestyle-focused)
4. Key Features List (5-7 bullet points)
5. Call to Action (3-5 words, urgent and inviting)
6. Hashtags (8-12 relevant real estate hashtags, include location, property type, agent name, brokerage)

Return as JSON`;

      const copyResponse = await InvokeLLM({
        prompt: copyPrompt,
        response_json_schema: {
          type: "object",
          properties: {
            main_headline: { type: "string" },
            sub_headline: { type: "string" },
            description: { type: "string" },
            key_features: { type: "array", items: { type: "string" } },
            call_to_action: { type: "string" },
            hashtags: { type: "array", items: { type: "string" } }
          },
          required: ["main_headline", "sub_headline", "description", "key_features", "call_to_action", "hashtags"]
        }
      });

      // Update design settings with generated copy
      setDesignSettings(prev => ({
        ...prev,
        headline: copyResponse.main_headline,
        subheadline: copyResponse.sub_headline,
        price: `$${property.price?.toLocaleString()}`,
        details: copyResponse.description,
        cta_text: copyResponse.call_to_action
      }));

      // Use the actual property photo
      const imageUrl = currentPhoto.file_url;

      // Create comprehensive design object
      const newDesign = {
        id: Date.now(),
        category: designCategory,
        template: selectedTemplate,
        property: property,
        copy: copyResponse,
        image_url: imageUrl,
        photo_id: currentPhoto.id,
        settings: {
          ...designSettings,
          headline: copyResponse.main_headline,
          subheadline: copyResponse.sub_headline,
          price: `$${property.price?.toLocaleString()}`,
          details: copyResponse.description,
          cta_text: copyResponse.call_to_action
        },
        property_details: {
          address: property.address,
          city: property.city,
          state: property.state,
          price: property.price,
          bedrooms: property.bedrooms,
          bathrooms: property.bathrooms,
          square_feet: property.square_feet,
          key_features: copyResponse.key_features,
          hashtags: copyResponse.hashtags
        },
        agent_info: {
          name: brandSettings.agent_name,
          title: brandSettings.agent_title,
          phone: brandSettings.phone,
          email: brandSettings.email,
          website: brandSettings.website
        },
        timestamp: new Date().toISOString()
      };

      setGeneratedDesign(newDesign);
      setDesignHistory(prev => [newDesign, ...prev].slice(0, 10));
      setCurrentView("export");
      
      toast.success("Professional marketing design generated!");

    } catch (error) {
      console.error("Error generating design:", error);
      toast.error("Failed to generate design. Please try again.");
    }
    setIsGenerating(false);
  };

  const handleDownloadDesign = () => {
    if (!generatedDesign) return;
    
    toast.success("Design download started!");
    
    const link = document.createElement('a');
    link.href = generatedDesign.image_url;
    link.download = `${designCategory}_${Date.now()}.jpg`;
    link.click();
  };

  const generateSocialMediaVariations = async (property, design) => {
    try {
      toast.info("Generating platform-specific variations...");
      
      const prompt = `Generate optimized social media posts for multiple platforms for this property:

Property: ${property.address}, ${property.city}
Price: $${property.price?.toLocaleString()}
Beds/Baths: ${property.bedrooms}/${property.bathrooms}
Features: ${property.features || 'Beautiful home'}

Generate 3 caption variations for EACH platform with their specific requirements:

INSTAGRAM:
- Length: 150-200 characters
- Style: Visual, emoji-rich, lifestyle-focused
- Hashtags: 20-30 relevant hashtags
- CTA: "Link in bio" or "DM for details"

FACEBOOK:
- Length: 250-300 characters
- Style: Community-focused, conversational, detailed
- Hashtags: 3-5 targeted hashtags
- CTA: Encourage comments and shares

LINKEDIN:
- Length: 200-250 characters
- Style: Professional, market-focused, investment angle
- Hashtags: 3-5 professional hashtags
- CTA: Professional networking focused

TWITTER:
- Length: 200-250 characters (within limit)
- Style: Concise, punchy, trending
- Hashtags: 2-3 hashtags
- CTA: Quick action oriented

Return as JSON with platform variations`;

      const variations = await InvokeLLM({
        prompt,
        response_json_schema: {
          type: "object",
          properties: {
            instagram: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  caption: { type: "string" },
                  hashtags: { type: "array", items: { type: "string" } },
                  cta: { type: "string" }
                }
              }
            },
            facebook: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  caption: { type: "string" },
                  hashtags: { type: "array", items: { type: "string" } },
                  cta: { type: "string" }
                }
              }
            },
            linkedin: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  caption: { type: "string" },
                  hashtags: { type: "array", items: { type: "string" } },
                  cta: { type: "string" }
                }
              }
            },
            twitter: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  caption: { type: "string" },
                  hashtags: { type: "array", items: { type: "string" } },
                  cta: { type: "string" }
                }
              }
            }
          }
        }
      });

      setCaptionVariations(variations);
      
      // Auto-populate with first variation
      setSocialMediaPosts({
        instagram: {
          enabled: false,
          caption: variations.instagram[0].caption,
          hashtags: variations.instagram[0].hashtags,
          cta: variations.instagram[0].cta,
          scheduled_time: ""
        },
        facebook: {
          enabled: false,
          caption: variations.facebook[0].caption,
          hashtags: variations.facebook[0].hashtags,
          cta: variations.facebook[0].cta,
          scheduled_time: ""
        },
        linkedin: {
          enabled: false,
          caption: variations.linkedin[0].caption,
          hashtags: variations.linkedin[0].hashtags,
          cta: variations.linkedin[0].cta,
          scheduled_time: ""
        },
        twitter: {
          enabled: false,
          caption: variations.twitter[0].caption,
          hashtags: variations.twitter[0].hashtags,
          cta: variations.twitter[0].cta,
          scheduled_time: ""
        }
      });
      
      toast.success("Platform variations generated!");
      return variations;
      
    } catch (error) {
      console.error("Error generating variations:", error);
      toast.error("Failed to generate variations");
      return null;
    }
  };

  const handleShareToSocialMedia = async () => {
    if (!generatedDesign) return;
    
    // Generate variations if not already done or if the design changed
    const areCaptionVariationsEmpty = Object.values(captionVariations).every(platformVariations => platformVariations.length === 0);
    if (areCaptionVariationsEmpty) {
      await generateSocialMediaVariations(
        generatedDesign.property,
        generatedDesign
      );
    }
    
    setShowSocialMediaModal(true);
  };

  const handleSendEmailCampaign = () => {
    setShowEmailCampaignModal(true);
  };

  const handleSaveToAssets = async () => {
    if (!generatedDesign) return;
    
    try {
      await MarketingCampaign.create({
        name: `Design - ${generatedDesign.property.address}`,
        campaign_type: designCategory.includes('instagram') || designCategory.includes('facebook') ? 'social_media' : 'email',
        status: 'draft',
        property_ids: [generatedDesign.property.id],
        content: JSON.stringify(generatedDesign),
        created_by: currentUser.id
      });
      
      toast.success("Design saved to Marketing Campaigns!");
    } catch (error) {
      console.error("Error saving design:", error);
      toast.error("Failed to save design");
    }
  };

  const handleSaveSocialMediaCampaign = async () => {
    const enabledPlatforms = Object.keys(socialMediaPosts).filter(
      platform => socialMediaPosts[platform].enabled
    );
    
    if (enabledPlatforms.length === 0) {
      toast.error("Please select at least one platform");
      return;
    }
    
    try {
      // Save as marketing campaign
      await MarketingCampaign.create({
        name: `Social Media - ${generatedDesign.property.address}`,
        campaign_type: "social_media",
        status: "scheduled",
        property_ids: [generatedDesign.property.id],
        content: JSON.stringify({
          design: generatedDesign,
          platforms: socialMediaPosts,
          variations: captionVariations
        }),
        channels: JSON.stringify(enabledPlatforms),
        start_date: new Date().toISOString(), // Use current time or earliest scheduled time
        created_by: currentUser.id
      });
      
      toast.success(`Campaign saved! Ready to post on ${enabledPlatforms.length} platform(s)`);
      setShowSocialMediaModal(false);
      
    } catch (error) {
      console.error("Error saving campaign:", error);
      toast.error("Failed to save campaign");
    }
  };

  const renderPhotoSelector = () => {
    if (propertyPhotos.length === 0) {
      return (
        <div className="text-center py-8 text-slate-500">
          <ImageIcon className="w-12 h-12 mx-auto mb-3 opacity-50" />
          <p className="text-sm">No photos available</p>
          <p className="text-xs mt-2">Upload photos to this property first</p>
        </div>
      );
    }

    return (
      <div className="space-y-4">
        {/* Main Selected Photo */}
        <div className="relative aspect-video bg-slate-100 rounded-lg overflow-hidden">
          <img
            src={propertyPhotos[selectedPhotoIndex].file_url}
            alt="Selected property photo"
            className="w-full h-full object-cover"
          />
          <div className="absolute top-3 right-3 bg-black/70 text-white px-3 py-1 rounded-full text-sm">
            {selectedPhotoIndex + 1} / {propertyPhotos.length}
          </div>
          
          {/* Navigation Arrows */}
          {propertyPhotos.length > 1 && (
            <>
              <Button
                size="icon"
                variant="ghost"
                className="absolute left-3 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white"
                onClick={() => setSelectedPhotoIndex((prev) => 
                  prev === 0 ? propertyPhotos.length - 1 : prev - 1
                )}
              >
                <ChevronLeft className="w-5 h-5" />
              </Button>
              <Button
                size="icon"
                variant="ghost"
                className="absolute right-3 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white"
                onClick={() => setSelectedPhotoIndex((prev) => 
                  prev === propertyPhotos.length - 1 ? 0 : prev + 1
                )}
              >
                <ChevronRight className="w-5 h-5" />
              </Button>
            </>
          )}
        </div>

        {/* Thumbnail Grid */}
        {propertyPhotos.length > 1 && (
          <div className="grid grid-cols-4 gap-2">
            {propertyPhotos.map((photo, index) => (
              <div
                key={photo.id}
                className={`relative aspect-square bg-slate-100 rounded-lg overflow-hidden cursor-pointer transition-all ${
                  selectedPhotoIndex === index 
                    ? 'ring-2 ring-indigo-600 ring-offset-2' 
                    : 'hover:ring-2 hover:ring-slate-300'
                }`}
                onClick={() => setSelectedPhotoIndex(index)}
              >
                <img
                  src={photo.file_url}
                  alt={photo.caption || `Photo ${index + 1}`}
                  className="w-full h-full object-cover"
                />
                {selectedPhotoIndex === index && (
                  <div className="absolute inset-0 bg-indigo-600/20 flex items-center justify-center">
                    <CheckCircle2 className="w-6 h-6 text-white" />
                  </div>
                )}
              </div>
            ))}
          </div>
        )}

        {propertyPhotos[selectedPhotoIndex]?.caption && (
          <p className="text-sm text-slate-600 text-center">
            {propertyPhotos[selectedPhotoIndex].caption}
          </p>
        )}
      </div>
    );
  };

  const renderTemplateGallery = () => {
    const templates = DESIGN_TEMPLATES[designCategory] || [];
    
    return (
      <div className="space-y-6">
        {/* Category Selector */}
        <div className="flex gap-3 overflow-x-auto pb-2">
          <Button
            variant={designCategory === "instagram_post" ? "default" : "outline"}
            onClick={() => setDesignCategory("instagram_post")}
            className="flex items-center gap-2 whitespace-nowrap"
          >
            <Instagram className="w-4 h-4" />
            Instagram Posts
          </Button>
          <Button
            variant={designCategory === "facebook_post" ? "default" : "outline"}
            onClick={() => setDesignCategory("facebook_post")}
            className="flex items-center gap-2 whitespace-nowrap"
          >
            <Facebook className="w-4 h-4" />
            Facebook Posts
          </Button>
          <Button
            variant={designCategory === "email_header" ? "default" : "outline"}
            onClick={() => setDesignCategory("email_header")}
            className="flex items-center gap-2 whitespace-nowrap"
          >
            <Mail className="w-4 h-4" />
            Email Headers
          </Button>
          <Button
            variant={designCategory === "print_flyer" ? "default" : "outline"}
            onClick={() => setDesignCategory("print_flyer")}
            className="flex items-center gap-2 whitespace-nowrap"
          >
            <Printer className="w-4 h-4" />
            Print Flyers
          </Button>
        </div>

        {/* Property Selection */}
        <div className="space-y-2">
          <Label>Select Property</Label>
          <Select value={selectedProperty} onValueChange={setSelectedProperty}>
            <SelectTrigger>
              <SelectValue placeholder="Choose a property..." />
            </SelectTrigger>
            <SelectContent>
              {properties.map(prop => (
                <SelectItem key={prop.id} value={prop.id}>
                  {prop.address} - ${(prop.price / 1000).toFixed(0)}K
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* Photo Selection */}
        {selectedProperty && (
          <Card>
            <CardHeader>
              <CardTitle className="text-lg flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <FileImage className="w-5 h-5" />
                  Property Photos
                </div>
                {isLoadingPhotos && <Loader2 className="w-4 h-4 animate-spin" />}
              </CardTitle>
            </CardHeader>
            <CardContent>
              {renderPhotoSelector()}
            </CardContent>
          </Card>
        )}

        {/* Template Grid */}
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {templates.map(template => (
            <Card
              key={template.id}
              className="cursor-pointer hover:shadow-xl transition-all duration-300 overflow-hidden group"
              onClick={() => handleTemplateSelect(template)}
            >
              <div className="relative aspect-square overflow-hidden bg-slate-100">
                <img
                  src={template.preview}
                  alt={template.name}
                  className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                />
                <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                  <div className="text-white">
                    <p className="font-semibold text-sm mb-1">{template.name}</p>
                    <p className="text-xs opacity-90">{template.style}</p>
                  </div>
                </div>
              </div>
              <CardContent className="p-3">
                <h3 className="font-semibold text-sm mb-1">{template.name}</h3>
                <p className="text-xs text-slate-500 line-clamp-2">{template.style}</p>
              </CardContent>
            </Card>
          ))}
        </div>

        {/* AI Generate Option */}
        <Card className="border-2 border-dashed border-indigo-300 bg-indigo-50/50 dark:bg-indigo-900/10">
          <CardContent className="p-6 text-center">
            <Sparkles className="w-12 h-12 mx-auto mb-4 text-indigo-600" />
            <h3 className="font-semibold text-lg mb-2">AI-Powered Custom Design</h3>
            <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
              Let AI create unique copy for your property photo
            </p>
            <Button
              onClick={() => {
                if (!selectedProperty) {
                  toast.error("Please select a property first");
                  return;
                }
                if (!getCurrentPhoto()) {
                  toast.error("Please upload photos for this property first");
                  return;
                }
                setSelectedTemplate(null); // Clear selected template for pure AI generation
                setCurrentView("editor");
              }}
              disabled={!selectedProperty || !getCurrentPhoto()}
              className="bg-gradient-to-r from-indigo-600 to-purple-600"
            >
              <Sparkles className="w-4 h-4 mr-2" />
              Generate Custom Design
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  };

  const renderDesignEditor = () => {
    const property = properties.find(p => p.id === selectedProperty);
    const currentPhoto = getCurrentPhoto();
    
    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Customization Panel */}
        <div className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <Palette className="w-5 h-5" />
                Customize Design
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* Text Content */}
              <div className="space-y-3">
                <Label className="text-sm font-semibold">Content</Label>
                <div className="space-y-2">
                  <Input
                    placeholder="Headline..."
                    value={designSettings.headline}
                    onChange={(e) => setDesignSettings({...designSettings, headline: e.target.value})}
                  />
                  <Input
                    placeholder="Subheadline..."
                    value={designSettings.subheadline}
                    onChange={(e) => setDesignSettings({...designSettings, subheadline: e.target.value})}
                  />
                  <Input
                    placeholder="Price (e.g. $500,000)..."
                    value={designSettings.price}
                    onChange={(e) => setDesignSettings({...designSettings, price: e.target.value})}
                  />
                  <Textarea
                    placeholder="Details / Description..."
                    value={designSettings.details}
                    onChange={(e) => setDesignSettings({...designSettings, details: e.target.value})}
                    rows={2}
                  />
                  <Input
                    placeholder="Call to Action..."
                    value={designSettings.cta_text}
                    onChange={(e) => setDesignSettings({...designSettings, cta_text: e.target.value})}
                  />
                </div>
              </div>

              {/* Colors */}
              <div className="space-y-3 pt-3 border-t border-slate-200">
                <Label className="text-sm font-semibold">Colors</Label>
                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-1">
                    <Label className="text-xs">Text Section Background</Label>
                    <Input
                      type="color"
                      value={designSettings.background_color}
                      onChange={(e) => setDesignSettings({...designSettings, background_color: e.target.value})}
                      className="h-10"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-xs">Text Color</Label>
                    <Input
                      type="color"
                      value={designSettings.text_color}
                      onChange={(e) => setDesignSettings({...designSettings, text_color: e.target.value})}
                      className="h-10"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-xs">Accent (Price/CTA)</Label>
                    <Input
                      type="color"
                      value={designSettings.accent_color}
                      onChange={(e) => setDesignSettings({...designSettings, accent_color: e.target.value})}
                      className="h-10"
                    />
                  </div>
                </div>
              </div>

              {/* Typography */}
              <div className="space-y-3 pt-3 border-t border-slate-200">
                <Label className="text-sm font-semibold">Typography</Label>
                <Select
                  value={designSettings.font_family}
                  onValueChange={(value) => setDesignSettings({...designSettings, font_family: value})}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="Inter">Inter (Modern)</SelectItem>
                    <SelectItem value="Playfair Display">Playfair (Elegant)</SelectItem>
                    <SelectItem value="Montserrat">Montserrat (Bold)</SelectItem>
                    <SelectItem value="Lato">Lato (Clean)</SelectItem>
                  </SelectContent>
                </Select>

                <Select
                  value={designSettings.font_size}
                  onValueChange={(value) => setDesignSettings({...designSettings, font_size: value})}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="small">Small</SelectItem>
                    <SelectItem value="medium">Medium</SelectItem>
                    <SelectItem value="large">Large</SelectItem>
                  </SelectContent>
                </Select>

                <div className="flex gap-2">
                  <Button
                    size="sm"
                    variant={designSettings.text_align === 'left' ? 'default' : 'outline'}
                    onClick={() => setDesignSettings({...designSettings, text_align: 'left'})}
                  >
                    <AlignLeft className="w-4 h-4" />
                  </Button>
                  <Button
                    size="sm"
                    variant={designSettings.text_align === 'center' ? 'default' : 'outline'}
                    onClick={() => setDesignSettings({...designSettings, text_align: 'center'})}
                  >
                    <AlignCenter className="w-4 h-4" />
                  </Button>
                  <Button
                    size="sm"
                    variant={designSettings.text_align === 'right' ? 'default' : 'outline'}
                    onClick={() => setDesignSettings({...designSettings, text_align: 'right'})}
                  >
                    <AlignRight className="w-4 h-4" />
                  </Button>
                </div>
              </div>

              {/* Options */}
              <div className="space-y-3 pt-3 border-t border-slate-200">
                <Label className="text-sm font-semibold">Display Options</Label>
                <div className="space-y-2">
                  <div className="flex items-center space-x-2">
                    <Checkbox
                      checked={designSettings.show_status_badge}
                      onCheckedChange={(checked) => setDesignSettings({...designSettings, show_status_badge: checked})}
                      id="show-status-badge"
                    />
                    <label htmlFor="show-status-badge" className="text-sm cursor-pointer">Show Status Badge</label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <Checkbox
                      checked={designSettings.show_agent_info}
                      onCheckedChange={(checked) => setDesignSettings({...designSettings, show_agent_info: checked})}
                      id="show-agent-info"
                    />
                    <label htmlFor="show-agent-info" className="text-sm cursor-pointer">Show Agent Info</label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <Checkbox
                      checked={designSettings.show_logo}
                      onCheckedChange={(checked) => setDesignSettings({...designSettings, show_logo: checked})}
                      id="show-logo"
                    />
                    <label htmlFor="show-logo" className="text-sm cursor-pointer">Show Logo</label>
                  </div>
                </div>
              </div>

              <Button
                onClick={handleGenerateDesign}
                disabled={isGenerating || !selectedProperty || !currentPhoto}
                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600"
              >
                {isGenerating ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-4 h-4 mr-2" />
                    Generate Design
                  </>
                )}
              </Button>
            </CardContent>
          </Card>

          {/* Brand Settings Quick Access */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm flex items-center gap-2">
                <Palette className="w-4 h-4" />
                Brand Colors
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 gap-2">
                <div className="space-y-1">
                  <Label className="text-xs">Primary</Label>
                  <Input
                    type="color"
                    value={brandSettings.primary_color}
                    onChange={(e) => {
                      setBrandSettings({...brandSettings, primary_color: e.target.value});
                    }}
                    className="h-10"
                  />
                </div>
                <div className="space-y-1">
                  <Label className="text-xs">Accent</Label>
                  <Input
                    type="color"
                    value={designSettings.accent_color}
                    onChange={(e) => setDesignSettings({...designSettings, accent_color: e.target.value})}
                    className="h-10"
                  />
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Live Preview */}
        <div className="lg:col-span-2">
          <Card className="h-full">
            <CardHeader>
              <div className="flex justify-between items-center">
                <CardTitle className="text-lg flex items-center gap-2">
                  <Eye className="w-5 h-5" />
                  Live Preview
                </CardTitle>
                <div className="flex items-center gap-2">
                  <Badge variant="outline">
                    {selectedTemplate?.name || 'Custom Design'}
                  </Badge>
                  {propertyPhotos.length > 1 && (
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => setShowPhotoSelectorModal(true)}
                    >
                      <RefreshCw className="w-4 h-4 mr-2" />
                      Change Photo
                    </Button>
                  )}
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="aspect-square bg-slate-100 dark:bg-slate-800 rounded-lg flex items-center justify-center overflow-hidden">
                {currentPhoto && property ? (
                  <div className="relative w-full h-full flex flex-col" style={{ backgroundColor: designSettings.background_color }}>
                    {/* Property Photo - Top 65% */}
                    <div className="relative h-[65%] overflow-hidden">
                      <img
                        src={currentPhoto.file_url}
                        alt={property.address}
                        className="w-full h-full object-cover"
                      />
                      
                      {/* Status Badge Overlay on Photo */}
                      {designSettings.show_status_badge && (
                        <div className="absolute top-3 left-3">
                          <div
                            className="px-3 py-1.5 rounded-full font-bold text-xs shadow-lg"
                            style={{
                              backgroundColor: designSettings.accent_color,
                              color: '#ffffff'
                            }}
                          >
                            {property.status === 'active' ? 'JUST LISTED' : property.status?.toUpperCase()}
                          </div>
                        </div>
                      )}

                      {/* Logo Overlay on Photo */}
                      {designSettings.show_logo && brandSettings.logo_url && (
                        <div className="absolute top-3 right-3">
                          <div className="bg-white rounded-lg p-1.5 shadow-lg">
                            <img 
                              src={brandSettings.logo_url} 
                              alt="Logo" 
                              className="h-6 w-auto max-w-[80px] object-contain"
                            />
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Property Details - Bottom 35% */}
                    <div 
                      className="h-[35%] p-4 overflow-y-auto"
                      style={{ 
                        backgroundColor: designSettings.background_color,
                        color: designSettings.text_color,
                        textAlign: designSettings.text_align
                      }}
                    >
                      <div className="space-y-2">
                        {/* Headline */}
                        <h1
                          style={{
                            fontFamily: designSettings.font_family,
                            fontSize: designSettings.font_size === 'large' ? '1.25rem' : designSettings.font_size === 'small' ? '0.875rem' : '1rem',
                            fontWeight: 'bold',
                            lineHeight: '1.2',
                            color: designSettings.text_color,
                            marginBottom: '0.25rem'
                          }}
                        >
                          {designSettings.headline || `${property.bedrooms} Bed, ${property.bathrooms} Bath Home`}
                        </h1>

                        {/* Subheadline */}
                        <p
                          style={{
                            fontSize: '0.75rem',
                            fontWeight: '500',
                            color: designSettings.text_color,
                            opacity: 0.85,
                            marginBottom: '0.5rem'
                          }}
                        >
                          {designSettings.subheadline || `${property.address}, ${property.city}, ${property.state}`}
                        </p>

                        {/* Price */}
                        <div
                          className="inline-block px-3 py-1 rounded-lg"
                          style={{
                            backgroundColor: designSettings.accent_color,
                            color: '#ffffff',
                            marginBottom: '0.5rem'
                          }}
                        >
                          <span className="text-lg font-bold">
                            {designSettings.price || `$${property.price?.toLocaleString()}`}
                          </span>
                        </div>

                        {/* Property Stats */}
                        <div 
                          className="flex gap-3 text-xs flex-wrap" 
                          style={{ 
                            justifyContent: designSettings.text_align === 'center' ? 'center' : designSettings.text_align === 'right' ? 'flex-end' : 'flex-start',
                            color: designSettings.text_color,
                            marginBottom: '0.5rem'
                          }}
                        >
                          {property.bedrooms && (
                            <div>
                              <span className="font-bold">{property.bedrooms}</span> Beds
                            </div>
                          )}
                          {property.bathrooms && (
                            <>
                              <div>‚Ä¢</div>
                              <div>
                                <span className="font-bold">{property.bathrooms}</span> Baths
                              </div>
                            </>
                          )}
                          {property.square_feet && (
                            <>
                              <div>‚Ä¢</div>
                              <div>
                                <span className="font-bold">{property.square_feet?.toLocaleString()}</span> SF
                              </div>
                            </>
                          )}
                        </div>

                        {/* Key Features - Limited to 3 */}
                        {property.features && property.features.length > 0 && (
                          <div 
                            className="flex flex-wrap gap-1.5" 
                            style={{ 
                              justifyContent: designSettings.text_align === 'center' ? 'center' : designSettings.text_align === 'right' ? 'flex-end' : 'flex-start',
                              marginBottom: '0.5rem'
                            }}
                          >
                            {property.features.split(',').slice(0, 3).map((feature, idx) => (
                              <span
                                key={idx}
                                className="px-2 py-0.5 rounded-full text-xs font-medium"
                                style={{
                                  backgroundColor: `${designSettings.text_color}15`,
                                  color: designSettings.text_color,
                                  fontSize: '0.65rem'
                                }}
                              >
                                {feature.trim()}
                              </span>
                            ))}
                          </div>
                        )}

                        {/* Agent Info - Compact */}
                        {designSettings.show_agent_info && brandSettings.agent_name && (
                          <div 
                            className="pt-2 border-t mt-2" 
                            style={{ 
                              borderColor: `${designSettings.text_color}20`,
                              textAlign: designSettings.text_align
                            }}
                          >
                            <p className="font-bold text-xs">{brandSettings.agent_name}</p>
                            <p className="text-xs opacity-75" style={{ fontSize: '0.65rem' }}>{brandSettings.phone}</p>
                          </div>
                        )}

                        {/* CTA - Compact */}
                        <button
                          className="px-4 py-1.5 rounded-full font-bold mt-2"
                          style={{
                            backgroundColor: designSettings.accent_color,
                            color: '#ffffff',
                            fontSize: '0.75rem'
                          }}
                        >
                          {designSettings.cta_text || 'Schedule Showing'}
                        </button>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="text-center p-8">
                    <ImageIcon className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                    <p className="text-slate-500">Select a property to start designing</p>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  };

  const renderExportView = () => {
    if (!generatedDesign) return null;

    const { property, copy, image_url, settings, property_details, agent_info } = generatedDesign;

    return (
      <div className="max-w-5xl mx-auto space-y-6">
        {/* Success Header */}
        <Card className="border-2 border-green-200 bg-green-50 dark:bg-green-900/10">
          <CardContent className="p-6 text-center">
            <CheckCircle2 className="w-16 h-16 mx-auto mb-4 text-green-600" />
            <h2 className="text-2xl font-bold mb-2">Professional Design Ready!</h2>
            <p className="text-slate-600 dark:text-slate-400">
              Your marketing material includes all property details and is ready to share
            </p>
          </CardContent>
        </Card>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Preview */}
          <Card>
            <CardHeader>
              <CardTitle>Final Design Preview</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="aspect-square bg-slate-100 dark:bg-slate-800 rounded-lg overflow-hidden">
                {/* Same design as in editor but using generatedDesign data */}
                <div className="relative w-full h-full flex flex-col" style={{ backgroundColor: settings.background_color }}>
                  {/* Property Photo - Top 65% */}
                  <div className="relative h-[65%] overflow-hidden">
                    <img
                      src={image_url}
                      alt="Generated design"
                      className="w-full h-full object-cover"
                    />
                    
                    {/* Status Badge Overlay on Photo */}
                    {settings.show_status_badge && (
                      <div className="absolute top-3 left-3 z-10">
                        <div
                          className="px-3 py-1.5 rounded-full font-bold text-xs shadow-lg"
                          style={{
                            backgroundColor: settings.accent_color,
                            color: '#ffffff'
                          }}
                        >
                          {property.status === 'active' ? 'JUST LISTED' : property.status?.toUpperCase()}
                        </div>
                      </div>
                    )}

                    {/* Logo Overlay on Photo */}
                    {settings.show_logo && brandSettings.logo_url && (
                      <div className="absolute top-3 right-3 z-10">
                        <div className="bg-white rounded-lg p-1.5 shadow-lg">
                          <img 
                            src={brandSettings.logo_url} 
                            alt="Logo" 
                            className="h-6 w-auto max-w-[80px] object-contain"
                          />
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Property Details - Bottom 35% */}
                  <div 
                    className="h-[35%] p-4 overflow-y-auto"
                    style={{ 
                      backgroundColor: settings.background_color,
                      color: settings.text_color,
                      textAlign: settings.text_align
                    }}
                  >
                    <div className="space-y-2">
                      {/* Headline */}
                      <h1
                        style={{
                          fontFamily: settings.font_family,
                          fontSize: settings.font_size === 'large' ? '1.25rem' : settings.font_size === 'small' ? '0.875rem' : '1rem',
                          fontWeight: 'bold',
                          lineHeight: '1.2',
                          color: settings.text_color,
                          marginBottom: '0.25rem'
                        }}
                      >
                        {settings.headline}
                      </h1>
                      
                      {/* Subheadline */}
                      <p
                        style={{
                          fontSize: '0.75rem',
                          fontWeight: '500',
                          color: settings.text_color,
                          opacity: 0.9,
                          marginBottom: '0.5rem'
                        }}
                      >
                        {settings.subheadline}
                      </p>

                      {/* Price */}
                      <div
                        className="inline-block px-3 py-1 rounded-lg"
                        style={{
                          backgroundColor: settings.accent_color,
                          color: '#ffffff',
                          marginBottom: '0.5rem'
                        }}
                      >
                        <span className="text-lg font-bold">
                          {settings.price}
                        </span>
                      </div>

                      {/* Property Stats */}
                      <div 
                        className="flex gap-3 text-xs flex-wrap" 
                        style={{ 
                          justifyContent: settings.text_align === 'center' ? 'center' : settings.text_align === 'right' ? 'flex-end' : 'flex-start',
                          color: settings.text_color,
                          marginBottom: '0.5rem'
                        }}
                      >
                        {property_details.bedrooms && (
                          <div>
                            <span className="font-bold">{property_details.bedrooms}</span> Beds
                          </div>
                        )}
                        {property_details.bathrooms && (
                          <>
                            <div>‚Ä¢</div>
                            <div>
                              <span className="font-bold">{property_details.bathrooms}</span> Baths
                            </div>
                          </>
                        )}
                        {property_details.square_feet && (
                          <>
                            <div>‚Ä¢</div>
                            <div>
                              <span className="font-bold">{property_details.square_feet?.toLocaleString()}</span> SF
                            </div>
                          </>
                        )}
                      </div>

                      {/* Key Features */}
                      {property_details.key_features && property_details.key_features.length > 0 && (
                          <div 
                            className="flex flex-wrap gap-1.5" 
                            style={{ 
                              justifyContent: settings.text_align === 'center' ? 'center' : settings.text_align === 'right' ? 'flex-end' : 'flex-start',
                              marginBottom: '0.5rem'
                            }}
                          >
                            {property_details.key_features.slice(0, 3).map((feature, idx) => (
                              <span
                                key={idx}
                                className="px-2 py-0.5 rounded-full text-xs font-medium"
                                style={{
                                  backgroundColor: `${settings.text_color}15`,
                                  color: settings.text_color,
                                  fontSize: '0.65rem'
                                }}
                              >
                                {feature.trim()}
                              </span>
                            ))}
                          </div>
                        )}

                      {/* Agent Info */}
                      {settings.show_agent_info && agent_info && agent_info.name && (
                        <div 
                          className="pt-2 border-t mt-2" 
                          style={{ 
                            borderColor: `${settings.text_color}20`,
                            textAlign: settings.text_align
                          }}
                        >
                          <p className="font-bold text-xs">{agent_info.name}</p>
                          <p className="text-xs opacity-75" style={{ fontSize: '0.65rem' }}>{agent_info.phone}</p>
                        </div>
                      )}

                      {/* CTA */}
                      <button
                        className="px-4 py-1.5 rounded-full font-bold mt-2"
                        style={{
                          backgroundColor: settings.accent_color,
                          color: '#ffffff',
                          fontSize: '0.75rem'
                        }}
                      >
                        {settings.cta_text}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Actions and Details */}
          <div className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Export & Share</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <Button
                  onClick={handleDownloadDesign}
                  className="w-full justify-start"
                  variant="outline"
                >
                  <Download className="w-4 h-4 mr-2" />
                  Download High-Res Image
                </Button>

                <Button
                  onClick={handleShareToSocialMedia}
                  className="w-full justify-start"
                  variant="outline"
                >
                  <Share2 className="w-4 h-4 mr-2" />
                  Share to Social Media
                </Button>

                <Button
                  onClick={handleSendEmailCampaign}
                  className="w-full justify-start"
                  variant="outline"
                >
                  <Mail className="w-4 h-4 mr-2" />
                  Use in Email Campaign
                </Button>

                <Button
                  onClick={handleSaveToAssets}
                  className="w-full justify-start"
                  variant="outline"
                >
                  <Save className="w-4 h-4 mr-2" />
                  Save to Marketing Assets
                </Button>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Marketing Copy</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <Label className="text-xs text-slate-500 mb-1">Caption</Label>
                  <p className="text-sm">{copy.description}</p>
                </div>

                {property_details.key_features && property_details.key_features.length > 0 && (
                  <div>
                    <Label className="text-xs text-slate-500 mb-1">Key Features</Label>
                    <ul className="text-sm space-y-1 ml-4 list-disc">
                      {property_details.key_features.slice(0, 5).map((feature, idx) => (
                        <li key={idx}>{feature}</li>
                      ))}
                    </ul>
                  </div>
                )}

                {property_details.hashtags && property_details.hashtags.length > 0 && (
                  <div>
                    <Label className="text-xs text-slate-500 mb-1">Hashtags</Label>
                    <div className="flex flex-wrap gap-2">
                      {property_details.hashtags.map((tag, idx) => (
                        <Badge key={idx} variant="secondary" className="text-xs">
                          {tag}
                        </Badge>
                      ))}
                    </div>
                  </div>
                )}

                <Button
                  onClick={() => {
                    const caption = copy.description || '';
                    const features = property_details.key_features?.length > 0 ? `\n\nKey Features:\n${property_details.key_features.map(f => `‚Ä¢ ${f}`).join('\n')}` : '';
                    const hashtags = property_details.hashtags?.length > 0 ? `\n\n${property_details.hashtags.join(' ')}` : '';
                    const copyText = `${caption}${features}${hashtags}`;
                    navigator.clipboard.writeText(copyText);
                    toast.success("Marketing copy copied to clipboard!");
                  }}
                  variant="outline"
                  className="w-full"
                >
                  <Copy className="w-4 h-4 mr-2" />
                  Copy All Text
                </Button>
              </CardContent>
            </Card>

            <Button
              onClick={() => setCurrentView("templates")}
              className="w-full"
              variant="outline"
            >
              Create Another Design
            </Button>
          </div>
        </div>
      </div>
    );
  };

  const renderSocialMediaModal = () => {
    if (!generatedDesign) return null;

    const platforms = [
      {
        key: "instagram",
        name: "Instagram",
        icon: Instagram,
        color: "from-purple-600 to-pink-600",
        dimensions: "1080x1080",
        description: "Perfect square format, visual storytelling"
      },
      {
        key: "facebook",
        name: "Facebook",
        icon: Facebook,
        color: "from-blue-600 to-blue-700",
        dimensions: "1200x630",
        description: "Landscape format, community engagement"
      },
      {
        key: "linkedin",
        name: "LinkedIn",
        icon: Linkedin,
        color: "from-blue-700 to-blue-800",
        dimensions: "1200x627",
        description: "Professional network, business focus"
      },
      {
        key: "twitter",
        name: "Twitter/X",
        icon: Twitter,
        color: "from-gray-800 to-black",
        dimensions: "1200x675",
        description: "Concise messaging, trending topics"
      }
    ];

    return (
      <Dialog open={showSocialMediaModal} onOpenChange={setShowSocialMediaModal}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="text-2xl">Distribute to Social Media</DialogTitle>
            <p className="text-sm text-slate-500">
              Select platforms and customize your message for each network
            </p>
          </DialogHeader>

          <div className="space-y-6">
            {/* Platform Selection Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {platforms.map(platform => {
                const PlatformIcon = platform.icon;
                const isEnabled = socialMediaPosts[platform.key]?.enabled;
                const post = socialMediaPosts[platform.key] || {};
                const variations = captionVariations[platform.key] || [];

                return (
                  <Card 
                    key={platform.key}
                    className={`border-2 transition-all ${
                      isEnabled 
                        ? 'border-indigo-500 shadow-lg' 
                        : 'border-slate-200 hover:border-slate-300'
                    }`}
                  >
                    <CardContent className="p-6 space-y-4">
                      {/* Platform Header */}
                      <div className="flex items-start justify-between">
                        <div className="flex items-center gap-3">
                          <div className={`p-3 rounded-xl bg-gradient-to-br ${platform.color}`}>
                            <PlatformIcon className="w-6 h-6 text-white" />
                          </div>
                          <div>
                            <h3 className="font-semibold text-lg">{platform.name}</h3>
                            <p className="text-xs text-slate-500">{platform.dimensions}</p>
                          </div>
                        </div>
                        <Checkbox
                          checked={isEnabled}
                          onCheckedChange={(checked) => {
                            setSocialMediaPosts(prev => ({
                              ...prev,
                              [platform.key]: {
                                ...prev[platform.key],
                                enabled: checked
                              }
                            }));
                          }}
                          className="h-6 w-6"
                        />
                      </div>

                      <p className="text-sm text-slate-600">{platform.description}</p>

                      {isEnabled && (
                        <div className="space-y-4 pt-4 border-t">
                          {/* Caption Variations */}
                          {variations.length > 0 && (
                            <div>
                              <Label className="text-xs text-slate-500 mb-2">
                                Choose Caption Style
                              </Label>
                              <div className="space-y-2">
                                {variations.map((variation, idx) => (
                                  <div
                                    key={idx}
                                    onClick={() => {
                                      setSocialMediaPosts(prev => ({
                                        ...prev,
                                        [platform.key]: {
                                          ...prev[platform.key],
                                          caption: variation.caption,
                                          hashtags: variation.hashtags,
                                          cta: variation.cta
                                        }
                                      }));
                                    }}
                                    className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                      post.caption === variation.caption
                                        ? 'border-indigo-500 bg-indigo-50'
                                        : 'border-slate-200 hover:border-slate-300'
                                    }`}
                                  >
                                    <p className="text-sm line-clamp-2">
                                      {variation.caption}
                                    </p>
                                    <div className="flex items-center gap-2 mt-2">
                                      <Badge variant="outline" className="text-xs">
                                        Style {idx + 1}
                                      </Badge>
                                      {post.caption === variation.caption && (
                                        <CheckCircle2 className="w-4 h-4 text-indigo-600" />
                                      )}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {/* Caption Editor */}
                          <div>
                            <Label className="text-xs text-slate-500 mb-2">
                              Caption
                            </Label>
                            <Textarea
                              value={post.caption || ""}
                              onChange={(e) => {
                                setSocialMediaPosts(prev => ({
                                  ...prev,
                                  [platform.key]: {
                                    ...prev[platform.key],
                                    caption: e.target.value
                                  }
                                }));
                              }}
                              rows={4}
                              className="text-sm"
                            />
                            <div className="flex justify-between mt-1">
                              <span className="text-xs text-slate-500">
                                {post.caption?.length || 0} characters
                              </span>
                              {platform.key === 'twitter' && post.caption?.length > 280 && (
                                <span className="text-xs text-red-500">
                                  Exceeds Twitter limit!
                                </span>
                              )}
                            </div>
                          </div>

                          {/* Hashtags */}
                          <div>
                            <Label className="text-xs text-slate-500 mb-2">
                              Hashtags
                            </Label>
                            <div className="flex flex-wrap gap-2">
                              {(post.hashtags || []).map((tag, idx) => (
                                <Badge key={idx} variant="secondary" className="text-xs">
                                  {tag}
                                </Badge>
                              ))}
                            </div>
                          </div>

                          {/* Schedule Time */}
                          <div>
                            <Label className="text-xs text-slate-500 mb-2">
                              Schedule Post (Optional)
                            </Label>
                            <Input
                              type="datetime-local"
                              value={post.scheduled_time || ""}
                              onChange={(e) => {
                                setSocialMediaPosts(prev => ({
                                  ...prev,
                                  [platform.key]: {
                                    ...prev[platform.key],
                                    scheduled_time: e.target.value
                                  }
                                }));
                              }}
                              className="text-sm"
                            />
                          </div>

                          {/* CTA */}
                          {post.cta && (
                            <div className="p-3 bg-slate-50 rounded-lg">
                              <p className="text-xs text-slate-500 mb-1">Call to Action</p>
                              <p className="text-sm font-medium">{post.cta}</p>
                            </div>
                          )}
                        </div>
                      )}
                    </CardContent>
                  </Card>
                );
              })}
            </div>

            {/* Preview Section */}
            <Card className="bg-slate-50">
              <CardHeader>
                <CardTitle className="text-lg">Design Preview</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="aspect-square max-w-md mx-auto bg-white rounded-lg overflow-hidden shadow-lg">
                  <img
                    src={generatedDesign.image_url}
                    alt="Design preview"
                    className="w-full h-full object-cover"
                  />
                </div>
              </CardContent>
            </Card>

            {/* Best Practices */}
            <Card className="bg-blue-50 border-blue-200">
              <CardContent className="p-4">
                <div className="flex items-start gap-3">
                  <Sparkles className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                  <div className="text-sm text-blue-900">
                    <p className="font-semibold mb-2">Best Times to Post:</p>
                    <ul className="space-y-1">
                      <li>üì∏ Instagram: 11 AM - 1 PM or 7 PM - 9 PM</li>
                      <li>üë• Facebook: 1 PM - 4 PM weekdays</li>
                      <li>üíº LinkedIn: 7 AM - 9 AM or 5 PM - 6 PM weekdays</li>
                      <li>üê¶ Twitter: 9 AM - 3 PM weekdays</li>
                    </ul>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Action Buttons */}
            <div className="flex justify-between items-center pt-4 border-t">
              <Button
                variant="outline"
                onClick={() => setShowSocialMediaModal(false)}
              >
                Cancel
              </Button>
              <div className="flex gap-3">
                <Button
                  variant="outline"
                  onClick={handleDownloadDesign}
                >
                  <Download className="w-4 h-4 mr-2" />
                  Download Design
                </Button>
                <Button
                  onClick={handleSaveSocialMediaCampaign}
                  className="bg-gradient-to-r from-indigo-600 to-purple-600"
                >
                  <Save className="w-4 h-4 mr-2" />
                  Save Campaign
                </Button>
              </div>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    );
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="p-4">
      <div className="space-y-6">
        {/* Header */}
        <div className="app-card p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => {
                if (currentView === "editor" || currentView === "export") {
                  setCurrentView("templates");
                } else {
                  navigate(createPageUrl("Dashboard"));
                }
              }}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <Palette className="w-6 h-6 text-indigo-600" />
                <h1 className="app-title text-2xl">360¬∞ Marketing Design Studio</h1>
              </div>
              <p className="app-subtitle">Create professional marketing materials with your property photos</p>
            </div>
            
            {/* View Indicators */}
            <div className="flex items-center gap-2">
              <Badge variant={currentView === "templates" ? "default" : "outline"}>Templates</Badge>
              <ChevronRight className="w-4 h-4 text-slate-400" />
              <Badge variant={currentView === "editor" ? "default" : "outline"}>Editor</Badge>
              <ChevronRight className="w-4 h-4 text-slate-400" />
              <Badge variant={currentView === "export" ? "default" : "outline"}>Export</Badge>
            </div>
          </div>
        </div>

        {/* Main Content */}
        <div className="app-card p-6">
          {currentView === "templates" && renderTemplateGallery()}
          {currentView === "editor" && renderDesignEditor()}
          {currentView === "export" && renderExportView()}
        </div>

        {/* Design History */}
        {designHistory.length > 0 && currentView === "templates" && (
          <div className="app-card p-6">
            <h3 className="app-title text-lg mb-4 flex items-center gap-2">
              <Clock className="w-5 h-5" />
              Recent Designs
            </h3>
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
              {designHistory.map(design => (
                <Card
                  key={design.id}
                  className="cursor-pointer hover:shadow-lg transition-shadow"
                  onClick={() => {
                    setGeneratedDesign(design);
                    setCurrentView("export");
                  }}
                >
                  <div className="aspect-square bg-slate-100 overflow-hidden">
                    <img
                      src={design.image_url}
                      alt="Design history"
                      className="w-full h-full object-cover"
                    />
                  </div>
                  <CardContent className="p-2">
                    <p className="text-xs text-slate-500 truncate">
                      {design.property.address}
                    </p>
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
        )}

        {/* Photo Selector Modal */}
        {showPhotoSelectorModal && (
          <Dialog open={showPhotoSelectorModal} onOpenChange={setShowPhotoSelectorModal}>
            <DialogContent className="max-w-3xl">
              <DialogHeader>
                <DialogTitle>Select Property Photo</DialogTitle>
              </DialogHeader>
              {renderPhotoSelector()}
              <div className="flex justify-end gap-3">
                <Button variant="outline" onClick={() => setShowPhotoSelectorModal(false)}>
                  Cancel
                </Button>
                <Button onClick={() => setShowPhotoSelectorModal(false)}>
                  Use This Photo
                </Button>
              </div>
            </DialogContent>
          </Dialog>
        )}

        {/* Social Media Share Modal */}
        {renderSocialMediaModal()}
      </div>
    </div>
  );
}

import React, { useState, useEffect, useMemo } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import _ from 'lodash';

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Plus, Search, Send, Building2, Loader2, MessageSquare, Check, CheckCheck,
  ArrowLeft, Shield, User, Filter, Pin, Archive, Star, Sparkles,
  Clock, Home, Users, TrendingUp, Zap, Copy, Mail, Phone, Calendar as CalendarIcon // Added CalendarIcon
} from "lucide-react";
import { formatDistanceToNow, format } from "date-fns";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import MeetingScheduler from "../components/scheduling/MeetingScheduler"; // New import

// Get ALL people associated with a property for messaging
const getAllPropertyContacts = (property, currentUserId, users, teamMembers = []) => {
  const contacts = [];
  
  if (!property || !currentUserId) return contacts;

  // Helper to ensure unique contacts by ID or email, and exclude current user
  const addedKeys = new Set();
  const addContact = (contact) => {
    // If it's an internal user, key by 'user_<id>', otherwise by 'external_<email or name>'
    const key = contact.isUser ? `user_${contact.id}` : `external_${contact.email || contact.full_name}`;

    // Ensure contact is not the current user
    if (contact.id === currentUserId) return; // For internal users
    // For external contacts, check if their email matches current user's email if available
    const currentUserEmail = users.find(u => u.id === currentUserId)?.email;
    if (!contact.isUser && contact.email && contact.email === currentUserEmail) return;

    if (!addedKeys.has(key)) {
      contacts.push(contact);
      addedKeys.add(key);
    }
  };

  // 1. Listing Agent
  if (property.listing_agent_id) {
    // Check if the listing agent is a team member, which might have additional info or a direct user object
    const listingAgentTeamMember = (teamMembers || []).find(tm => tm && tm.user_id === property.listing_agent_id);
    // Prioritize the user object from the team member, otherwise find in general users
    const listingAgent = listingAgentTeamMember?.user || (users || []).find(u => u && u.id === property.listing_agent_id);
    
    if (listingAgent) {
      addContact({
        id: listingAgent.id,
        full_name: listingAgent.full_name || listingAgent.email,
        email: listingAgent.email,
        phone: listingAgent.phone,
        role: 'Listing Agent',
        isUser: true
      });
    }
  }

  // 2. Selling Agent
  if (property.selling_agent_id) {
    const sellingAgent = (users || []).find(u => u && u.id === property.selling_agent_id);
    if (sellingAgent) {
      addContact({
        id: sellingAgent.id,
        full_name: sellingAgent.full_name || sellingAgent.email,
        email: sellingAgent.email,
        phone: sellingAgent.phone,
        role: 'Selling Agent',
        isUser: true
      });
    }
  } else if (property.selling_agent_name) {
    addContact({
      id: `external_selling_agent_${property.selling_agent_email || property.selling_agent_name}`,
      full_name: property.selling_agent_name,
      email: property.selling_agent_email,
      phone: property.selling_agent_phone,
      role: 'Selling Agent',
      isUser: false
    });
  }

  // 3. Buyer
  if (property.buyer_id) {
    const buyer = (users || []).find(u => u && u.id === property.buyer_id);
    if (buyer) {
      addContact({
        id: buyer.id,
        full_name: buyer.full_name || buyer.email,
        email: buyer.email,
        phone: buyer.phone,
        role: 'Buyer',
        isUser: true
      });
    }
  } else if (property.buyer_name) {
    addContact({
      id: `external_buyer_${property.buyer_email || property.buyer_name}`,
      full_name: property.buyer_name,
      email: property.buyer_email,
      phone: property.buyer_phone,
      role: 'Buyer',
      isUser: false
    });
  }

  // 4. Sellers
  let sellers = [];
  if (property.sellers_info) {
    try {
      sellers = Array.isArray(property.sellers_info)
        ? property.sellers_info
        : JSON.parse(property.sellers_info);
    } catch (e) {
      console.error("Error parsing sellers_info:", e);
    }
  }

  sellers.forEach((seller, index) => {
    if (!seller || (!seller.email && !seller.name)) return;
    const sellerUser = (users || []).find(u => u && u.email === seller.email);
    
    if (sellerUser) { // If it's an internal user
      addContact({
        id: sellerUser.id,
        full_name: sellerUser.full_name || sellerUser.email,
        email: sellerUser.email,
        phone: sellerUser.phone,
        role: `Seller${sellers.length > 1 ? ` ${index + 1}` : ''}`,
        isUser: true
      });
    } else if (seller.email) { // If it's an external contact with an email
      addContact({
        id: `external_seller_${seller.email}`,
        full_name: seller.name || seller.email, // Use name if available, otherwise email
        email: seller.email,
        phone: seller.phone,
        role: `Seller${sellers.length > 1 ? ` ${index + 1}` : ''}`,
        isUser: false
      });
    }
  });

  // 5. Title Company
  if (property.title_company) {
    let titleContact = null;
    if (property.title_company_contact) {
      try {
        titleContact = typeof property.title_company_contact === 'string'
          ? JSON.parse(property.title_company_contact)
          : property.title_company_contact;
      } catch (e) {
        console.error("Error parsing title_company_contact:", e);
      }
    }
    
    addContact({
      id: `external_title_${property.title_company}`, // Unique ID for external
      full_name: titleContact?.name || property.title_company,
      email: titleContact?.email,
      phone: titleContact?.phone,
      role: 'Title Company',
      isUser: false
    });
  }

  // 6. Mortgage Company
  if (property.mortgage_company) {
    let mortgageContact = null;
    if (property.mortgage_company_contact) {
      try {
        mortgageContact = typeof property.mortgage_company_contact === 'string'
          ? JSON.parse(property.mortgage_company_contact)
          : property.mortgage_company_contact;
      } catch (e) {
        console.error("Error parsing mortgage_company_contact:", e);
      }
    }
    
    addContact({
      id: `external_mortgage_${property.mortgage_company}`,
      full_name: mortgageContact?.name || property.mortgage_company,
      email: mortgageContact?.email,
      phone: mortgageContact?.phone,
      role: 'Mortgage Company',
      isUser: false
    });
  }

  // 7. Inspection Company
  if (property.inspection_company) {
    let inspectionContact = null;
    if (property.inspection_company_contact) {
      try {
        inspectionContact = typeof property.inspection_company_contact === 'string'
          ? JSON.parse(property.inspection_company_contact)
          : property.inspection_company_contact;
      } catch (e) {
        console.error("Error parsing inspection_company_contact:", e);
      }
    }
    
    addContact({
      id: `external_inspection_${property.inspection_company}`,
      full_name: inspectionContact?.name || property.inspection_company,
      email: inspectionContact?.email,
      phone: inspectionContact?.phone,
      role: 'Inspection Company',
      isUser: false
    });
  }

  return contacts;
};

// Legacy function - kept for backwards compatibility but redirects to new function
// This function now simply returns all contacts associated with the property,
// excluding the current user. The previous role-based filtering logic is removed
// as per the new requirement to get "ALL people associated with a property for messaging".
// The 'allowed' part is now implicitly handled by the UI presenting all these contacts.
const getAllowedRecipients = (property, currentUserId, currentUserRole, users, teamMembers = []) => {
  return getAllPropertyContacts(property, currentUserId, users, teamMembers);
};


// Utility functions for message types
const getMessageTypeColor = (messageType, isCurrentUser) => {
  if (isCurrentUser) {
    // Current user's messages - bright solid colors
    if (messageType === 'email') return 'bg-blue-600';
    if (messageType === 'internal') return 'bg-indigo-600';
    if (messageType === 'sms') return 'bg-purple-600';
    return 'bg-slate-600'; // fallback
  } else {
    // Other user's messages - lighter with borders
    if (messageType === 'email') return 'bg-blue-100 dark:bg-blue-900/30 text-slate-900 dark:text-white border-blue-300 dark:border-blue-700';
    if (messageType === 'internal') return 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white border-slate-200 dark:border-slate-700';
    if (messageType === 'sms') return 'bg-purple-100 dark:bg-purple-900/30 text-slate-900 dark:text-white border-purple-300 dark:border-purple-700';
    return 'bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white border-slate-200 dark:border-slate-700'; // fallback
  }
};

const getMessageTypeIcon = (messageType) => {
  if (messageType === 'email') return <Mail className="w-3 h-3" />;
  if (messageType === 'internal') return <MessageSquare className="w-3 h-3" />;
  if (messageType === 'sms') return <Phone className="w-3 h-3" />;
  return <MessageSquare className="w-3 h-3" />; // fallback
};

const getMessageTypeLabel = (messageType) => {
  if (messageType === 'email') return 'Email';
  if (messageType === 'internal') return 'Internal';
  if (messageType === 'sms') return 'SMS';
  return 'Message'; // fallback
};

export default function MessagesPage() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [showNewMessageModal, setShowNewMessageModal] = useState(false);
  const [selectedPropertyId, setSelectedPropertyId] = useState("");
  const [selectedRecipient, setSelectedRecipient] = useState(null); // Can be a single recipient or { isAllContacts: true, contacts: [...] }
  const [newMessage, setNewMessage] = useState("");
  const [searchQuery, setSearchQuery] = useState("");
  const [activeTab, setActiveTab] = useState("all");
  const [sortBy, setSortBy] = useState("recent");
  const [messageTypeFilter, setMessageTypeFilter] = useState("all");
  const [selectedMessageTypes, setSelectedMessageTypes] = useState(["internal"]); // NEW: array for multiple selections
  const [showAISuggestions, setShowAISuggestions] = useState(false);
  const [aiSuggestions, setAISuggestions] = useState([]);
  const [generatingSuggestions, setGeneratingSuggestions] = useState(false);
  const [showMeetingScheduler, setShowMeetingScheduler] = useState(false); // New state
  const [meetingPreFill, setMeetingPreFill] = useState({}); // New state
  const [highlightMessageId, setHighlightMessageId] = useState(null);
  const messagesEndRef = React.useRef(null);

  const { data: user, isLoading: isLoadingUser } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me()
  });

  const { data: messages = [], isLoading: messagesLoading } = useQuery({
    queryKey: ["messages", user?.id],
    queryFn: async () => {
      const [sent, received] = await Promise.all([
        base44.entities.Message.filter({ sender_id: user.id }, '-created_date').catch(() => []),
        base44.entities.Message.filter({ recipient_id: user.id }, '-created_date').catch(() => [])
      ]);
      const combined = [...sent, ...received];
      return Array.from(new Map(combined.map(item => [item.id, item])).values());
    },
    enabled: !!user?.id,
    initialData: [],
  });

  const { data: users = [] } = useQuery({
    queryKey: ["users"],
    queryFn: () => base44.entities.User.list(),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
    initialData: [],
  });

  const { data: properties = [] } = useQuery({
    queryKey: ['properties'],
    queryFn: () => base44.entities.Property.list(),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
    initialData: [],
  });

  const { data: teamMembers = [] } = useQuery({
    queryKey: ['teamMembers'],
    queryFn: () => base44.entities.TeamMember.list(),
    initialData: [],
  });

  const userProperties = useMemo(() => {
    if (!user) return [];

    return properties.filter(property => {
      if (!property) return false;
      if (user.role === 'admin' || user.role === 'broker') return true;
      if (property.listing_agent_id === user.id) return true;
      if (property.selling_agent_id === user.id) return true;
      if (property.buyer_id === user.id) return true;

      if (property.sellers_info) {
        try {
          const sellers = Array.isArray(property.sellers_info)
            ? property.sellers_info
            : JSON.parse(property.sellers_info);
          return sellers.some(s => {
            if (!s || !s.email) return false;
            const sellerUser = users.find(u => u && u.email && u.email === s.email);
            return sellerUser && sellerUser.id === user.id;
          });
        } catch (e) {}
      }

      return false;
    });
  }, [properties, user, users]);

  const allowedRecipients = useMemo(() => {
    if (!selectedPropertyId || !user) return [];
    const property = properties.find(p => p.id === selectedPropertyId);
    if (!property) return [];
    return getAllPropertyContacts(property, user.id, users, teamMembers);
  }, [selectedPropertyId, user, properties, users, teamMembers]);

  const availableConversations = useMemo(() => {
    if (!user) return [];

    const conversations = [];

    userProperties.forEach(property => {
      const recipients = getAllPropertyContacts(property, user.id, users, teamMembers);

      recipients.forEach(recipient => {
        const recipientKey = recipient.isUser ? recipient.id : recipient.email;
        const threadId = `property_${property.id}_recipient_${recipientKey}`;

        const conversationMessages = messages.filter(m => {
          if (m.property_id !== property.id) return false;

          if (recipient.isUser) {
            return (
              (m.sender_id === user.id && m.recipient_id === recipient.id) ||
              (m.sender_id === recipient.id && m.recipient_id === user.id)
            );
          }

          return (
            (m.sender_id === user.id && m.recipient_email === recipient.email) ||
            (m.recipient_id === user.id && m.sender_id && users.find(u => u.id === m.sender_id)?.email === recipient.email)
          );
        });

        const latestMessage = _.orderBy(conversationMessages, 'created_date', 'desc')[0];
        const unreadCount = conversationMessages.filter(m => !m.is_read && m.recipient_id === user.id).length;

        conversations.push({
          threadId,
          property,
          recipient,
          messages: _.orderBy(conversationMessages, 'created_date', 'asc'),
          latestMessage,
          unreadCount,
          hasMessages: conversationMessages.length > 0
        });
      });
    });

    return conversations;
  }, [userProperties, user, users, messages, teamMembers]);

  // Organize conversations
  const organizedConversations = useMemo(() => {
    let filtered = [...availableConversations];

    // Apply tab filter
    if (activeTab === 'unread') {
      filtered = filtered.filter(c => c.unreadCount > 0);
    } else if (activeTab === 'properties') {
      filtered = filtered.filter(c => c.hasMessages);
    }

    // Apply message type filter - NEW
    if (messageTypeFilter !== 'all') {
      filtered = filtered.filter(conv => {
        // Check if conversation has any messages of the selected type
        // Note: For 'all' conversations, we still filter by type if messageTypeFilter is not 'all'.
        // If there are no messages, it won't match any type, which is fine.
        return conv.messages.some(m => m.message_type === messageTypeFilter);
      });
    }

    // Apply search
    if (searchQuery && typeof searchQuery === 'string') {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(conv =>
        (conv.property?.address && typeof conv.property.address === 'string' && conv.property.address.toLowerCase().includes(query)) ||
        (conv.recipient?.full_name && typeof conv.recipient.full_name === 'string' && conv.recipient.full_name.toLowerCase().includes(query)) ||
        (conv.latestMessage?.content && typeof conv.latestMessage.content === 'string' && conv.latestMessage.content.toLowerCase().includes(query))
      );
    }

    // Apply sorting
    if (sortBy === 'recent') {
      filtered = _.orderBy(filtered, [
        conv => conv.hasMessages ? 0 : 1,
        conv => conv.latestMessage ? new Date(conv.latestMessage.created_date).getTime() : 0
      ], ['asc', 'desc']);
    } else if (sortBy === 'unread') {
      filtered = _.orderBy(filtered, ['unreadCount', conv => conv.latestMessage ? new Date(conv.latestMessage.created_date).getTime() : 0], ['desc', 'desc']);
    } else if (sortBy === 'property') {
      filtered = _.orderBy(filtered, [conv => conv.property?.address || ''], ['asc']);
    }

    return filtered;
  }, [availableConversations, activeTab, searchQuery, sortBy, messageTypeFilter]);

  // Group conversations by property for the "By Property" view
  const conversationsByProperty = useMemo(() => {
    const grouped = _.groupBy(organizedConversations, conv => conv.property.id);
    return Object.entries(grouped).map(([propertyId, convs]) => ({
      property: convs[0].property,
      conversations: convs,
      totalUnread: convs.reduce((sum, c) => sum + c.unreadCount, 0)
    }));
  }, [organizedConversations]);

  const selectedConversation = useMemo(() => {
    if (!selectedPropertyId || !selectedRecipient) return null;

    // Handle "All Contacts" selection separately
    if (selectedRecipient.isAllContacts) {
      return {
        threadId: `property_${selectedPropertyId}_all_contacts`, // A temporary thread ID for UI
        property: properties.find(p => p.id === selectedPropertyId),
        recipient: selectedRecipient, // Keep the special recipient object
        messages: [], // No historical messages for this pseudo-conversation
        latestMessage: null,
        unreadCount: 0,
        hasMessages: false,
        isAllContactsBroadcast: true // Flag to indicate it's a broadcast setup
      };
    }

    const recipientKey = selectedRecipient.isUser ? selectedRecipient.id : selectedRecipient.email;
    return availableConversations.find(
      c => c.property.id === selectedPropertyId &&
           (c.recipient.isUser ? c.recipient.id : c.recipient.email) === recipientKey
    );
  }, [availableConversations, selectedPropertyId, selectedRecipient, properties]);

  // Auto-select available message types when conversation changes
  useEffect(() => {
    if (selectedConversation && !selectedConversation.isAllContactsBroadcast) {
      const availableTypes = [];
      if (selectedConversation.recipient.isUser) availableTypes.push('internal');
      if (selectedConversation.recipient.email) availableTypes.push('email');
      if (selectedConversation.recipient.phone) availableTypes.push('sms');
      
      setSelectedMessageTypes(availableTypes.length > 0 ? [availableTypes[0]] : ['internal']);
    } else if (selectedConversation && selectedConversation.isAllContactsBroadcast) {
      const availableTypes = [];
      if (selectedConversation.recipient.contacts.some(c => c.isUser)) availableTypes.push('internal');
      if (selectedConversation.recipient.contacts.some(c => c.email)) availableTypes.push('email');
      if (selectedConversation.recipient.contacts.some(c => c.phone)) availableTypes.push('sms');
      
      setSelectedMessageTypes(availableTypes.length > 0 ? [availableTypes[0]] : ['internal']);
    }
  }, [selectedConversation]);

  useEffect(() => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
    }
  }, [selectedConversation?.messages]);

  // Handle highlight from URL parameter
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const highlightId = urlParams.get('highlightMessage');
    
    if (highlightId && messages.length > 0) {
      const message = messages.find(m => m.id === highlightId);
      if (message) {
        // Find the conversation for this message
        const messageProperty = properties.find(p => p.id === message.property_id);
        if (messageProperty) {
          const recipients = getAllPropertyContacts(messageProperty, user?.id, users, teamMembers);
          const messageSender = users.find(u => u.id === message.sender_id);
          const messageRecipient = recipients.find(r => 
            r.isUser ? r.id === message.sender_id : r.email === messageSender?.email
          );
          
          if (messageRecipient) {
            setSelectedPropertyId(messageProperty.id);
            setSelectedRecipient(messageRecipient);
            setHighlightMessageId(highlightId);
            
            // Scroll to message after a short delay
            setTimeout(() => {
              const messageElement = document.getElementById(`message-${highlightId}`);
              if (messageElement) {
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            }, 500);
            
            // Clear highlight after 3 seconds
            setTimeout(() => setHighlightMessageId(null), 3000);
          }
        }
      }
    }
  }, [messages, properties, users, teamMembers, user]);

  const sendMessageMutation = useMutation({
    mutationFn: async (messageData) => {
      return await base44.entities.Message.create(messageData);
    },
    onSuccess: (data, variables) => {
      // For single message, invalidate and clear input
      if (!variables.isBroadcast) { // Custom flag to differentiate from broadcast
        queryClient.invalidateQueries({ queryKey: ["messages"] });
        setNewMessage("");
        setShowAISuggestions(false);
        toast.success("Message sent!");
      }
      // For broadcast, success handling is done in handleSendMessage
    },
    onError: (error) => {
      console.error("Error sending message:", error);
      toast.error("Failed to send message");
    }
  });

  const markAsReadMutation = useMutation({
    mutationFn: async (messageId) => {
      return await base44.entities.Message.update(messageId, { is_read: true });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["messages"] });
    }
  });

  useEffect(() => {
    if (selectedConversation && user && !selectedConversation.isAllContactsBroadcast) {
      const unreadMessages = selectedConversation.messages.filter(
        m => !m.is_read && m.recipient_id === user.id
      );
      unreadMessages.forEach(m => {
        markAsReadMutation.mutate(m.id);
      });
    }
  }, [selectedConversation, user]);

  const handleSendMessage = async (e) => {
    e.preventDefault();
    if (!newMessage.trim() || !selectedConversation || !user || selectedMessageTypes.length === 0) return;

    if (selectedConversation.isAllContactsBroadcast) {
        const messagesToSend = [];
        const failedRecipients = [];
        const allRecipients = selectedConversation.recipient.contacts;

        for (const recipient of allRecipients) {
            for (const messageType of selectedMessageTypes) {
                let recipientId = null;
                let recipientEmail = null;

                if (recipient.isUser) {
                    recipientId = recipient.id;
                } else {
                    recipientEmail = recipient.email;
                }

                let canSend = true;
                let failureReason = '';

                if (messageType === 'email') {
                    if (!recipient.email) { canSend = false; failureReason = '(no email)'; }
                } else if (messageType === 'sms') {
                    if (!recipient.phone) { canSend = false; failureReason = '(no phone)'; }
                } else if (messageType === 'internal') {
                    if (!recipient.isUser) { canSend = false; failureReason = '(not internal user)'; }
                }

                if (!canSend) {
                    const key = `${recipient.full_name || recipient.email || 'Unknown'}-${messageType}${failureReason}`;
                    if (!failedRecipients.includes(key)) {
                        failedRecipients.push(key);
                    }
                    continue;
                }

                messagesToSend.push({
                    thread_id: `property_${selectedConversation.property.id}_recipient_${recipientId || recipientEmail || `external_${recipient.full_name}`}`,
                    sender_id: user.id,
                    content: newMessage,
                    property_id: selectedConversation.property.id,
                    message_type: messageType,
                    is_read: false,
                    recipient_id: recipientId,
                    recipient_email: recipientEmail,
                    isBroadcast: true
                });
            }
        }

        if (messagesToSend.length === 0) {
            toast.error(`No messages sent. Failed to send.`);
            return;
        }

        const sendPromises = messagesToSend.map(msgData =>
            sendMessageMutation.mutateAsync(msgData)
        );

        try {
            await Promise.allSettled(sendPromises);
            queryClient.invalidateQueries({ queryKey: ["messages"] });
            setNewMessage("");
            setShowAISuggestions(false);
            toast.success(`Message sent via ${selectedMessageTypes.join(', ')} to recipients.`);
            setSelectedRecipient(null);
            setSelectedPropertyId("");
        } catch (error) {
            console.error("Error sending messages:", error);
            toast.error("Failed to send some messages.");
        }
    } else {
        // Single recipient - send via all selected types
        const messagesToSend = [];
        
        for (const messageType of selectedMessageTypes) {
            // Validate
            if (messageType === 'email' && !selectedConversation.recipient.email) continue;
            if (messageType === 'sms' && !selectedConversation.recipient.phone) continue;
            if (messageType === 'internal' && !selectedConversation.recipient.isUser) continue;

            const recipientKey = selectedConversation.recipient.isUser
                ? selectedConversation.recipient.id
                : selectedConversation.recipient.email;
            const threadId = `property_${selectedConversation.property.id}_recipient_${recipientKey}`;

            const messageData = {
                thread_id: threadId,
                sender_id: user.id,
                content: newMessage,
                property_id: selectedConversation.property.id,
                message_type: messageType,
                is_read: false
            };

            if (selectedConversation.recipient.isUser) {
                messageData.recipient_id = selectedConversation.recipient.id;
            } else {
                messageData.recipient_email = selectedConversation.recipient.email;
            }

            messagesToSend.push(messageData);
        }

        if (messagesToSend.length === 0) {
            toast.error("No valid channels selected for this recipient");
            return;
        }

        try {
            await Promise.all(messagesToSend.map(msg => sendMessageMutation.mutateAsync(msg)));
            toast.success(`Message sent via ${selectedMessageTypes.join(', ')}`);
        } catch (error) {
            toast.error("Failed to send message");
        }
    }
  };

  const handleGenerateAISuggestions = async () => {
    if (!selectedConversation || selectedConversation.isAllContactsBroadcast) return; // Disable for broadcast

    setGeneratingSuggestions(true);
    try {
      const conversationContext = selectedConversation.messages.slice(-5).map(m =>
        `${m.sender_id === user.id ? 'You' : selectedConversation.recipient.full_name}: ${m.content}`
      ).join('\n');

      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `You are a professional real estate assistant. Based on this conversation about property "${selectedConversation.property.address}", generate 3 smart reply suggestions.

Conversation context:
${conversationContext || 'No previous messages'}

Property: ${selectedConversation.property.address}, ${selectedConversation.property.city}
Price: $${selectedConversation.property.price?.toLocaleString()}
Recipient Role: ${selectedConversation.recipient.role}

Generate 3 helpful, professional reply options:
1. A brief acknowledgment/update
2. A detailed response with next steps
3. A friendly check-in`,
        response_json_schema: {
          type: "object",
          properties: {
            suggestions: {
              type: "array",
              items: { type: "string" }
            }
          }
        }
      });

      setAISuggestions(result.suggestions || []);
      setShowAISuggestions(true);
      toast.success("AI suggestions ready!");
    } catch (error) {
      console.error("Error generating suggestions:", error);
      toast.error("Failed to generate suggestions");
    } finally {
      setGeneratingSuggestions(false);
    }
  };

  const handleNewMessage = () => {
    setSelectedPropertyId("");
    setSelectedRecipient(null);
    setShowNewMessageModal(true);
  };

  const handleStartConversation = () => {
    if (!selectedPropertyId || !selectedRecipient) {
      toast.error("Please select both property and recipient");
      return;
    }
    setShowNewMessageModal(false);
  };

  const handleScheduleMeetingWithContact = () => {
    if (!selectedConversation || selectedConversation.isAllContactsBroadcast) {
      toast.error('Please select a single contact to schedule a meeting');
      return;
    }

    setMeetingPreFill({
      clientName: selectedConversation.recipient.full_name,
      clientEmail: selectedConversation.recipient.email,
      clientPhone: selectedConversation.recipient.phone,
      title: `Meeting with ${selectedConversation.recipient.full_name}`,
      notes: `Meeting scheduled from conversation about ${selectedConversation.property.address}`,
      propertyId: selectedConversation.property.id,
      recipientId: selectedConversation.recipient.isUser ? selectedConversation.recipient.id : null,
      recipientEmail: selectedConversation.recipient.email
    });
    setShowMeetingScheduler(true);
  };

  const isLoading = isLoadingUser || messagesLoading;
  const totalUnread = availableConversations.reduce((sum, conv) => sum + conv.unreadCount, 0);
  const conversationsWithMessages = availableConversations.filter(c => c.hasMessages);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-screen bg-slate-50 dark:bg-slate-900">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="h-screen bg-slate-50 dark:bg-slate-900 flex flex-col -m-6 overflow-hidden">
      {/* Header */}
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 shadow-lg flex-shrink-0">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div>
              <h1 className="text-2xl font-bold flex items-center gap-2">
                <MessageSquare className="w-6 h-6" />
                Messages
              </h1>
              <p className="text-white/80 text-sm">
                {totalUnread > 0 ? `${totalUnread} unread` : 'All caught up!'} ‚Ä¢ {conversationsWithMessages.length} active conversations
              </p>
            </div>
          </div>
          <Button onClick={handleNewMessage} className="bg-white text-indigo-600 hover:bg-white/90">
            <Plus className="w-4 h-4 mr-2" />
            New Message
          </Button>
        </div>

        {/* Quick Stats */}
        <div className="grid grid-cols-4 gap-3 mt-4">
          <div className="bg-white/10 backdrop-blur-sm rounded-lg p-3">
            <div className="text-2xl font-bold">{conversationsWithMessages.length}</div>
            <div className="text-xs text-white/70">Active Chats</div>
          </div>
          <div className="bg-white/10 backdrop-blur-sm rounded-lg p-3">
            <div className="text-2xl font-bold">{totalUnread}</div>
            <div className="text-xs text-white/70">Unread</div>
          </div>
          <div className="bg-white/10 backdrop-blur-sm rounded-lg p-3">
            <div className="2xl font-bold">{userProperties.length}</div>
            <div className="text-xs text-white/70">Properties</div>
          </div>
          <div className="bg-white/10 backdrop-blur-sm rounded-lg p-3">
            <div className="2xl font-bold">{availableConversations.length}</div>
            <div className="text-xs text-white/70">Total Contacts</div>
          </div>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="flex-1 flex min-h-0 overflow-hidden">
        {/* Conversations List - Left Sidebar */}
        <div className="w-full md:w-96 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden">
          {/* Search & Filters */}
          <div className="p-4 border-b border-slate-200 dark:border-slate-700 space-y-3 flex-shrink-0">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
              <Input
                placeholder="Search conversations..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-10 bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700"
              />
            </div>

            {/* Message Type Filter - UPDATED with SMS */}
            <div className="grid grid-cols-4 gap-2">
              <Button
                variant={messageTypeFilter === 'all' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setMessageTypeFilter('all')}
                className="text-xs"
              >
                All
              </Button>
              <Button
                variant={messageTypeFilter === 'email' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setMessageTypeFilter('email')}
                className={`text-xs ${messageTypeFilter === 'email' ? 'bg-blue-600 hover:bg-blue-700 text-white' : ''}`}
              >
                <Mail className="w-3 h-3 mr-1" />
                Email
              </Button>
              <Button
                variant={messageTypeFilter === 'internal' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setMessageTypeFilter('internal')}
                className={`text-xs ${messageTypeFilter === 'internal' ? 'bg-indigo-600 hover:bg-indigo-700 text-white' : ''}`}
              >
                <MessageSquare className="w-3 h-3 mr-1" />
                Internal
              </Button>
              <Button
                variant={messageTypeFilter === 'sms' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setMessageTypeFilter('sms')}
                className={`text-xs ${messageTypeFilter === 'sms' ? 'bg-purple-600 hover:bg-purple-700 text-white' : ''}`}
              >
                <Phone className="w-3 h-3 mr-1" />
                SMS
              </Button>
            </div>

            <Select value={sortBy} onValueChange={setSortBy}>
              <SelectTrigger className="w-full">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="recent">
                  <div className="flex items-center gap-2">
                    <Clock className="w-4 h-4" />
                    Most Recent
                  </div>
                </SelectItem>
                <SelectItem value="unread">
                  <div className="flex items-center gap-2">
                    <TrendingUp className="w-4 h-4" />
                    Unread First
                  </div>
                </SelectItem>
                <SelectItem value="property">
                  <div className="flex items-center gap-2">
                    <Home className="w-4 h-4" />
                    By Property
                  </div>
                </SelectItem>
              </SelectContent>
            </Select>
          </div>

          {/* Tabs */}
          <Tabs value={activeTab} onValueChange={setActiveTab} className="flex-1 flex flex-col overflow-hidden">
            <TabsList className="w-full justify-start rounded-none border-b bg-transparent h-auto p-0 flex-shrink-0">
              <TabsTrigger value="all" className="rounded-none data-[state=active]:border-b-2 data-[state=active]:border-indigo-600">
                All ({availableConversations.length})
              </TabsTrigger>
              <TabsTrigger value="unread" className="rounded-none data-[state=active]:border-b-2 data-[state=active]:border-indigo-600">
                Unread ({totalUnread})
              </TabsTrigger>
              <TabsTrigger value="properties" className="rounded-none data-[state=active]:border-b-2 data-[state=active]:border-indigo-600">
                By Property
              </TabsTrigger>
            </TabsList>

            {/* Conversations List */}
            <TabsContent value="all" className="flex-1 overflow-y-auto m-0">
              {organizedConversations.length === 0 ? (
                <EmptyState onNewMessage={handleNewMessage} />
              ) : (
                <ConversationsList
                  conversations={organizedConversations}
                  selectedPropertyId={selectedPropertyId}
                  selectedRecipient={selectedRecipient}
                  onSelect={(conv) => {
                    setSelectedPropertyId(conv.property.id);
                    setSelectedRecipient(conv.recipient);
                  }}
                  user={user}
                />
              )}
            </TabsContent>

            <TabsContent value="unread" className="flex-1 overflow-y-auto m-0">
              {organizedConversations.length === 0 ? (
                <EmptyState message="No unread messages" />
              ) : (
                <ConversationsList
                  conversations={organizedConversations}
                  selectedPropertyId={selectedPropertyId}
                  selectedRecipient={selectedRecipient}
                  onSelect={(conv) => {
                    setSelectedPropertyId(conv.property.id);
                    setSelectedRecipient(conv.recipient);
                  }}
                  user={user}
                />
              )}
            </TabsContent>

            <TabsContent value="properties" className="flex-1 overflow-y-auto m-0">
              {conversationsByProperty.length === 0 ? (
                <EmptyState onNewMessage={handleNewMessage} />
              ) : (
                <PropertyGroupedList
                  groups={conversationsByProperty}
                  selectedPropertyId={selectedPropertyId}
                  selectedRecipient={selectedRecipient}
                  onSelect={(conv) => {
                    setSelectedPropertyId(conv.property.id);
                    setSelectedRecipient(conv.recipient);
                  }}
                  user={user}
                />
              )}
            </TabsContent>
          </Tabs>
        </div>

        {/* Messages View - Right Side */}
        <div className="flex-1 flex flex-col bg-white dark:bg-slate-900 overflow-hidden min-h-0">
          {selectedConversation ? (
            <>
              {/* Conversation Header */}
              <div className="px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex-shrink-0">
                {selectedConversation.isAllContactsBroadcast ? (
                  <div className="flex items-center gap-3 mb-3">
                    <Avatar className="w-10 h-10">
                      <AvatarFallback className="bg-gradient-to-br from-purple-600 to-indigo-600 text-white font-semibold">
                        <Users className="w-5 h-5" />
                      </AvatarFallback>
                    </Avatar>
                    <div>
                      <h3 className="font-semibold text-slate-900 dark:text-white">
                        New Broadcast to {selectedConversation.recipient.contacts.length} Contacts
                      </h3>
                      <p className="text-sm text-slate-600 dark:text-slate-400">
                        Property: {selectedConversation.property.address}
                      </p>
                    </div>
                  </div>
                ) : (
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <Avatar className="w-10 h-10">
                        <AvatarFallback className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold">
                          {selectedConversation.recipient?.full_name?.charAt(0) || "?"}
                        </AvatarFallback>
                      </Avatar>
                      <div>
                        <h3 className="font-semibold text-slate-900 dark:text-white">
                          {selectedConversation.recipient?.full_name || selectedConversation.recipient?.email}
                        </h3>
                        <div className="flex items-center gap-2">
                          <Badge variant="outline" className="text-xs">
                            {selectedConversation.recipient.role}
                          </Badge>
                          {!selectedConversation.recipient.isUser && (
                            <Badge variant="secondary" className="text-xs">
                              External
                            </Badge>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Schedule Meeting Button */}
                    <Button
                      size="sm"
                      onClick={handleScheduleMeetingWithContact}
                      className="bg-green-600 hover:bg-green-700"
                    >
                      <CalendarIcon className="w-4 h-4 mr-2" />
                      Schedule Meeting
                    </Button>
                  </div>
                )}


                {/* Property Info */}
                <div
                  onClick={() => navigate(createPageUrl(`PropertyDetail?id=${selectedConversation.property.id}`))}
                  className="flex items-center gap-3 p-3 rounded-lg bg-gradient-to-r from-slate-50 to-indigo-50 dark:from-slate-700 dark:to-indigo-900/20 hover:from-slate-100 hover:to-indigo-100 dark:hover:from-slate-600 dark:hover:to-indigo-900/30 cursor-pointer transition-all border border-slate-200 dark:border-slate-700"
                >
                  <div className="flex-1 min-w-0">
                    <p className="font-semibold text-sm text-slate-900 dark:text-white truncate">
                      {selectedConversation.property.address}
                    </p>
                    <p className="text-xs text-slate-600 dark:text-slate-400">
                      {selectedConversation.property.city}, {selectedConversation.property.state} ‚Ä¢ ${selectedConversation.property.price?.toLocaleString()}
                    </p>
                  </div>
                  {selectedConversation.property.primary_photo_url ? (
                    <img
                      src={selectedConversation.property.primary_photo_url}
                      alt={selectedConversation.property.address}
                      className="w-20 h-20 rounded-lg object-cover border-2 border-white dark:border-slate-800 shadow-md flex-shrink-0"
                    />
                  ) : (
                    <div className="w-20 h-20 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg flex items-center justify-center border-2 border-white dark:border-slate-800 flex-shrink-0">
                      <Building2 className="w-8 h-8 text-indigo-600 dark:text-indigo-400" />
                    </div>
                  )}
                  <Badge className="bg-indigo-600 text-white text-xs">
                    View
                  </Badge>
                </div>
              </div>

              {/* Messages Area - Scrollable */}
              <div className="flex-1 overflow-y-auto p-6 bg-slate-50 dark:bg-slate-900 min-h-0">
                {selectedConversation.isAllContactsBroadcast ? (
                  <div className="flex flex-col items-center justify-center h-full text-center">
                    <div className="w-16 h-16 bg-purple-100 dark:bg-purple-900/50 rounded-full flex items-center justify-center mb-4">
                      <Users className="w-8 h-8 text-purple-600 dark:text-purple-400" />
                    </div>
                    <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
                      Compose your broadcast message
                    </h3>
                    <p className="text-slate-600 dark:text-slate-400 max-w-sm mb-4">
                      This message will be sent individually to {selectedConversation.recipient.contacts.length} contacts associated with {selectedConversation.property.address}.
                    </p>
                  </div>
                ) : (
                  selectedConversation.messages.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full text-center">
                      <div className="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/50 rounded-full flex items-center justify-center mb-4">
                        <MessageSquare className="w-8 h-8 text-indigo-600 dark:text-indigo-400" />
                      </div>
                      <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
                        Start the conversation
                      </h3>
                      <p className="text-slate-600 dark:text-slate-400 max-w-sm mb-4">
                        Send a message to {selectedConversation.recipient.full_name} about {selectedConversation.property.address}
                      </p>
                      <Button onClick={handleGenerateAISuggestions} disabled={generatingSuggestions} className="bg-gradient-to-r from-purple-600 to-pink-600">
                        {generatingSuggestions ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Sparkles className="w-4 h-4 mr-2" />}
                        Get AI Starter Messages
                      </Button>
                    </div>
                  ) : (
                    <div className="space-y-1">
                      {selectedConversation.messages.map((message, index) => {
                        const isCurrentUser = message.sender_id === user?.id;
                        const isFirstInGroup = index === 0 || selectedConversation.messages[index - 1].sender_id !== message.sender_id;
                        const isLastInGroup = index === selectedConversation.messages.length - 1 || selectedConversation.messages[index + 1].sender_id !== message.sender_id;
                        const sender = isCurrentUser ? user : selectedConversation.recipient;
                        const messageType = message.message_type || (selectedConversation.recipient.isUser ? 'internal' : (selectedConversation.recipient.email ? 'email' : 'sms'));
                        const isHighlighted = highlightMessageId === message.id;

                        return (
                          <div 
                            key={message.id} 
                            id={`message-${message.id}`}
                            className={`flex gap-3 ${isCurrentUser ? 'flex-row-reverse' : 'flex-row'} ${!isFirstInGroup ? 'mt-1' : 'mt-4'} ${
                              isHighlighted ? 'animate-pulse' : ''
                            }`}
                          >
                            {isFirstInGroup && (
                              <Avatar className="w-8 h-8 flex-shrink-0">
                                <AvatarFallback className={`text-xs font-semibold ${
                                  isCurrentUser
                                    ? 'bg-indigo-600 text-white'
                                    : 'bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300'
                                }`}>
                                  {sender?.full_name?.charAt(0) || '?'}
                                </AvatarFallback>
                              </Avatar>
                            )}

                            {!isFirstInGroup && <div className="w-8 flex-shrink-0" />}

                            <div className={`flex flex-col max-w-[70%] ${isCurrentUser ? 'items-end' : 'items-start'}`}>
                              {isFirstInGroup && (
                                <div className={`flex items-center gap-2 mb-1 px-1 ${isCurrentUser ? 'flex-row-reverse' : 'flex-row'}`}>
                                  <span className="text-xs font-medium text-slate-600 dark:text-slate-400">
                                    {sender?.full_name || 'Unknown'}
                                  </span>
                                </div>
                              )}

                              <div className="relative group">
                                <div className={`rounded-2xl px-4 py-2.5 shadow-sm ${
                                  isCurrentUser
                                    ? `${getMessageTypeColor(messageType, true)} text-white`
                                    : `${getMessageTypeColor(messageType, false)} border-2`
                                } ${
                                  isHighlighted ? 'ring-4 ring-red-500 border-red-500' : ''
                                }`}>
                                  <p className="text-[15px] leading-relaxed whitespace-pre-wrap break-words">
                                    {message.content}
                                  </p>
                                  <p className={`text-[10px] mt-1 ${isCurrentUser ? 'text-white/70' : 'text-slate-400'}`}>
                                    {format(new Date(message.created_date), 'MMM d, h:mm a')}
                                  </p>
                                </div>

                                {/* Message Type Indicator - Always Visible */}
                                <div className={`absolute ${isCurrentUser ? 'left-0 -translate-x-full' : 'right-0 translate-x-full'} top-1 px-2`}>
                                  <Badge
                                    variant="outline"
                                    className={`text-[10px] px-1.5 py-0 flex items-center gap-1 ${
                                      messageType === 'email' ? 'border-blue-400 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' :
                                      messageType === 'internal' ? 'border-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' :
                                      messageType === 'sms' ? 'border-purple-400 bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300' :
                                      'border-slate-400 bg-slate-50 dark:bg-slate-900/30 text-slate-700 dark:text-slate-300'
                                    }`}
                                  >
                                    {getMessageTypeIcon(messageType)}
                                    <span className="font-semibold">
                                      {getMessageTypeLabel(messageType)}
                                    </span>
                                  </Badge>
                                </div>
                              </div>

                              {isLastInGroup && isCurrentUser && messageType === 'internal' && (
                                <div className={`flex items-center gap-1.5 mt-1 px-1 flex-row-reverse`}>
                                  {message.is_read ? (
                                    <span className="flex items-center gap-1 text-indigo-500">
                                      <CheckCheck className="w-3 h-3" />
                                      <span className="text-[10px] font-medium">Seen</span>
                                    </span>
                                  ) : (
                                    <span className="flex items-center gap-1 text-slate-400">
                                      <Check className="w-3 h-3" />
                                      <span className="text-[10px]">Sent</span>
                                    </span>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                      <div ref={messagesEndRef} />
                    </div>
                  )
                )}
              </div>

              {/* AI Suggestions Panel */}
              {showAISuggestions && aiSuggestions.length > 0 && selectedConversation && !selectedConversation.isAllContactsBroadcast && (
                <div className="px-6 py-3 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 border-t border-purple-200 dark:border-purple-800 flex-shrink-0">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-xs font-semibold text-purple-900 dark:text-purple-100 flex items-center gap-2">
                      <Sparkles className="w-4 h-4" />
                      AI Smart Replies
                    </span>
                    <Button variant="ghost" size="sm" onClick={() => setShowAISuggestions(false)} className="h-6 text-xs">
                      Hide
                    </Button>
                  </div>
                  <div className="space-y-2">
                    {aiSuggestions.map((suggestion, idx) => (
                      <Button
                        key={idx}
                        variant="outline"
                        size="sm"
                        className="w-full justify-start text-left h-auto py-2 px-3 hover:bg-purple-100 dark:hover:bg-purple-900/30"
                        onClick={() => {
                          setNewMessage(suggestion);
                          setShowAISuggestions(false);
                        }}
                      >
                        <div className="flex items-start gap-2 w-full">
                          <Zap className="w-3 h-3 text-purple-600 flex-shrink-0 mt-0.5" />
                          <span className="text-xs flex-1">{suggestion}</span>
                        </div>
                      </Button>
                    ))}
                  </div>
                </div>
              )}

              {/* Message Input - Fixed at bottom */}
              <div className="border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex-shrink-0 mt-auto">
                <form onSubmit={handleSendMessage} className="p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={handleGenerateAISuggestions}
                      disabled={generatingSuggestions || (selectedConversation && selectedConversation.isAllContactsBroadcast)}
                      className="text-xs"
                    >
                      {generatingSuggestions ? (
                        <>
                          <Loader2 className="w-3 h-3 mr-1 animate-spin" />
                          Generating...
                        </>
                      ) : (
                        <>
                          <Sparkles className="w-3 h-3 mr-1" />
                          AI Suggestions
                        </>
                      )}
                    </Button>

                    {/* Message Type Selector - Multi-select */}
                    <div className="ml-auto flex items-center gap-2">
                      <span className="text-xs text-slate-500">Send via:</span>
                      <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                        <Button
                          type="button"
                          variant={selectedMessageTypes.includes('internal') ? 'default' : 'ghost'}
                          size="sm"
                          onClick={() => {
                            if (selectedMessageTypes.includes('internal')) {
                              setSelectedMessageTypes(selectedMessageTypes.filter(t => t !== 'internal'));
                            } else {
                              setSelectedMessageTypes([...selectedMessageTypes, 'internal']);
                            }
                          }}
                          className={`h-7 px-3 text-xs ${
                            selectedMessageTypes.includes('internal')
                              ? 'bg-indigo-600 hover:bg-indigo-700 text-white'
                              : 'hover:bg-slate-200 dark:hover:bg-slate-600'
                          }`}
                          disabled={selectedConversation && selectedConversation.isAllContactsBroadcast
                            ? !selectedConversation.recipient.contacts.some(c => c.isUser)
                            : !selectedConversation?.recipient?.isUser}
                        >
                          <MessageSquare className="w-3 h-3 mr-1" />
                          Internal
                        </Button>
                        <Button
                          type="button"
                          variant={selectedMessageTypes.includes('email') ? 'default' : 'ghost'}
                          size="sm"
                          onClick={() => {
                            if (selectedMessageTypes.includes('email')) {
                              setSelectedMessageTypes(selectedMessageTypes.filter(t => t !== 'email'));
                            } else {
                              setSelectedMessageTypes([...selectedMessageTypes, 'email']);
                            }
                          }}
                          className={`h-7 px-3 text-xs ${
                            selectedMessageTypes.includes('email')
                              ? 'bg-blue-600 hover:bg-blue-700 text-white'
                              : 'hover:bg-slate-200 dark:hover:bg-slate-600'
                          }`}
                          disabled={selectedConversation && selectedConversation.isAllContactsBroadcast
                            ? !selectedConversation.recipient.contacts.some(c => c.email)
                            : !selectedConversation?.recipient?.email}
                        >
                          <Mail className="w-3 h-3 mr-1" />
                          Email
                        </Button>
                        <Button
                          type="button"
                          variant={selectedMessageTypes.includes('sms') ? 'default' : 'ghost'}
                          size="sm"
                          onClick={() => {
                            if (selectedMessageTypes.includes('sms')) {
                              setSelectedMessageTypes(selectedMessageTypes.filter(t => t !== 'sms'));
                            } else {
                              setSelectedMessageTypes([...selectedMessageTypes, 'sms']);
                            }
                          }}
                          className={`h-7 px-3 text-xs ${
                            selectedMessageTypes.includes('sms')
                              ? 'bg-purple-600 hover:bg-purple-700 text-white'
                              : 'hover:bg-slate-200 dark:hover:bg-slate-600'
                          }`}
                          disabled={selectedConversation && selectedConversation.isAllContactsBroadcast
                            ? !selectedConversation.recipient.contacts.some(c => c.phone)
                            : !selectedConversation?.recipient?.phone}
                        >
                          <Phone className="w-3 h-3 mr-1" />
                          SMS
                        </Button>
                      </div>
                    </div>
                  </div>

                  <div className="flex items-end gap-3">
                    <div className="flex-1 relative">
                      <Input
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        placeholder={`Message ${selectedConversation?.isAllContactsBroadcast ? 'all contacts' : (selectedConversation?.recipient?.full_name || 'recipient')}...`}
                        className="pr-12 min-h-[44px] bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700"
                        disabled={sendMessageMutation.isPending}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            handleSendMessage(e);
                          }
                        }}
                      />
                    </div>
                    <Button
                      type="submit"
                      size="lg"
                      disabled={!newMessage.trim() || sendMessageMutation.isPending || selectedMessageTypes.length === 0}
                      className="h-[44px] px-6 bg-indigo-600 hover:bg-indigo-700"
                    >
                      {sendMessageMutation.isPending ? (
                        <Loader2 className="w-4 h-4 animate-spin" />
                      ) : (
                        <>
                          <Send className="w-4 h-4 mr-2" />
                          Send
                        </>
                      )}
                    </Button>
                  </div>
                  <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                    Press Enter to send
                    {selectedMessageTypes.length > 0 && (
                      <span className="ml-2 font-semibold text-indigo-600">
                        ‚Ä¢ Sending via {selectedMessageTypes.map(t => getMessageTypeLabel(t)).join(' + ')}
                      </span>
                    )}
                  </p>
                </form>
              </div>
            </>
          ) : (
            <EmptyChatView onNewMessage={handleNewMessage} totalConversations={availableConversations.length} />
          )}
        </div>
      </div>

      {/* New Message Modal */}
      {showNewMessageModal && (
        <NewMessageModal
          userProperties={userProperties}
          allowedRecipients={allowedRecipients}
          selectedPropertyId={selectedPropertyId}
          selectedRecipient={selectedRecipient}
          onPropertyChange={(value) => {
            setSelectedPropertyId(value);
            setSelectedRecipient(null);
          }}
          onRecipientChange={setSelectedRecipient}
          onClose={() => setShowNewMessageModal(false)}
          onStart={handleStartConversation}
          user={user}
          users={users}
          properties={properties}
          navigate={navigate}
        />
      )}

      {showMeetingScheduler && (
        <MeetingScheduler
          isOpen={showMeetingScheduler}
          onClose={() => {
            setShowMeetingScheduler(false);
            setMeetingPreFill({});
          }}
          preFilledData={meetingPreFill}
          propertyId={meetingPreFill.propertyId}
          recipientId={meetingPreFill.recipientId}
          recipientEmail={meetingPreFill.recipientEmail}
          onMeetingCreated={() => {
            queryClient.invalidateQueries({ queryKey: ['appointments'] });
            queryClient.invalidateQueries({ queryKey: ['messages'] });
            toast.success('Meeting scheduled and invites sent!');
          }}
        />
      )}
    </div>
  );
}

// Empty State Component
function EmptyState({ message, onNewMessage }) {
  return (
    <div className="flex flex-col items-center justify-center h-full p-8 text-center">
      <div className="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mb-4">
        <MessageSquare className="w-8 h-8 text-slate-400" />
      </div>
      <h3 className="font-semibold text-slate-900 dark:text-white mb-2">
        {message || 'No conversations yet'}
      </h3>
      <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">
        Start messaging people about your properties
      </p>
      {onNewMessage && (
        <Button size="sm" onClick={onNewMessage} variant="outline">
          <Plus className="w-4 h-4 mr-2" />
          Start Conversation
        </Button>
      )}
    </div>
  );
}

// Empty Chat View Component
function EmptyChatView({ onNewMessage, totalConversations }) {
  return (
    <div className="flex-1 flex flex-col items-center justify-center text-center p-8 bg-slate-50 dark:bg-slate-900">
      <div className="w-20 h-20 bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-full flex items-center justify-center mb-4">
        <MessageSquare className="w-10 h-10 text-indigo-600 dark:text-indigo-400" />
      </div>
      <h3 className="text-xl font-semibold text-slate-900 dark:text-white mb-2">
        Select a conversation
      </h3>
      <p className="text-slate-500 dark:text-slate-400 max-w-sm mb-6">
        Choose a property and person from the left to start messaging, or create a new conversation
      </p>
      <div className="flex gap-3">
        <Button onClick={onNewMessage} className="bg-indigo-600 hover:bg-indigo-700">
          <Plus className="w-4 h-4 mr-2" />
          New Message
        </Button>
      </div>
      {totalConversations > 0 && (
        <p className="text-xs text-slate-400 mt-4">
          {totalConversations} conversations available
        </p>
      )}
    </div>
  );
}

// Conversations List Component
function ConversationsList({ conversations, selectedPropertyId, selectedRecipient, onSelect, user }) {
  return (
    <div className="divide-y divide-slate-100 dark:divide-slate-700">
      {conversations.map((conv) => {
        const recipientKey = conv.recipient.isUser ? conv.recipient.id : conv.recipient.email;
        const selectedKey = selectedRecipient?.isUser ? selectedRecipient.id : selectedRecipient?.email;
        const isSelected = conv.property.id === selectedPropertyId && recipientKey === selectedKey;
        const hasUnread = conv.unreadCount > 0;

        return (
          <div
            key={conv.threadId}
            onClick={() => onSelect(conv)}
            className={`p-4 cursor-pointer transition-all ${
              isSelected
                ? 'bg-indigo-50 dark:bg-indigo-900/20 border-l-4 border-indigo-600'
                : hasUnread 
                  ? 'bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 hover:bg-red-100 dark:hover:bg-red-900/30'
                  : 'hover:bg-slate-50 dark:hover:bg-slate-700/50'
            } ${!conv.hasMessages ? 'opacity-60' : ''}`}
          >
            <div className="flex items-start gap-3">
              <div className="relative">
                <Avatar className="w-12 h-12">
                  <AvatarFallback className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold">
                    {conv.recipient?.full_name?.charAt(0) || "?"}
                  </AvatarFallback>
                </Avatar>
                {hasUnread && (
                  <div className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center animate-pulse">
                    <span className="text-white text-xs font-bold">{conv.unreadCount}</span>
                  </div>
                )}
              </div>

              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 mb-1">
                  <h4 className={`font-semibold truncate ${
                    hasUnread ? 'text-red-600 dark:text-red-400' : 'text-slate-700 dark:text-slate-300'
                  }`}>
                    {conv.recipient?.full_name || conv.recipient?.email || "Unknown"}
                  </h4>
                  <Badge variant="outline" className="text-xs flex-shrink-0">
                    {conv.recipient.role}
                  </Badge>
                </div>

                <div className="flex items-center gap-2 mb-2">
                  {conv.property.primary_photo_url ? (
                    <img
                      src={conv.property.primary_photo_url}
                      alt={conv.property.address}
                      className="w-6 h-6 rounded object-cover border border-slate-200 dark:border-slate-600 flex-shrink-0"
                    />
                  ) : (
                    <div className="w-6 h-6 bg-slate-100 dark:bg-slate-700 rounded flex items-center justify-center flex-shrink-0">
                      <Building2 className="w-3 h-3 text-slate-400" />
                    </div>
                  )}
                  <p className="text-xs text-slate-600 dark:text-slate-400 truncate">
                    {conv.property.address}
                  </p>
                </div>

                {conv.latestMessage ? (
                  <p className={`text-sm truncate ${
                    hasUnread ? 'font-semibold text-red-600 dark:text-red-400' : 'text-slate-500 dark:text-slate-400'
                  }`}>
                    {conv.latestMessage.sender_id === user?.id && "You: "}
                    {conv.latestMessage.content}
                  </p>
                ) : (
                  <p className="text-xs text-slate-400 italic">No messages yet ‚Ä¢ Click to start</p>
                )}
              </div>

              {conv.latestMessage && (
                <div className="text-xs text-slate-400 flex-shrink-0">
                  {format(new Date(conv.latestMessage.created_date), 'MMM d, h:mm a')}
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
}

// Property Grouped List Component
function PropertyGroupedList({ groups, selectedPropertyId, selectedRecipient, onSelect, user }) {
  const [expandedProperties, setExpandedProperties] = React.useState(new Set());

  const toggleProperty = (propertyId) => {
    setExpandedProperties(prev => {
      const newSet = new Set(prev);
      if (newSet.has(propertyId)) {
        newSet.delete(propertyId);
      } else {
        newSet.add(propertyId);
      }
      return newSet;
    });
  };

  return (
    <div className="space-y-2 p-2">
      {groups.map((group) => {
        const isExpanded = expandedProperties.has(group.property.id);
        
        return (
          <Card key={group.property.id} className="overflow-hidden">
            <CardHeader 
              className="p-3 bg-gradient-to-r from-slate-50 to-indigo-50 dark:from-slate-800 dark:to-indigo-900/20 cursor-pointer hover:from-slate-100 hover:to-indigo-100 dark:hover:from-slate-700 dark:hover:to-indigo-900/30 transition-all"
              onClick={() => toggleProperty(group.property.id)}
            >
              <div className="flex items-center gap-3">
                {group.property.primary_photo_url ? (
                  <img src={group.property.primary_photo_url} alt="" className="w-10 h-10 rounded object-cover" />
                ) : (
                  <div className="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/50 rounded flex items-center justify-center">
                    <Building2 className="w-5 h-5 text-indigo-600" />
                  </div>
                )}
                <div className="flex-1 min-w-0">
                  <h4 className="font-semibold text-sm truncate">{group.property.address}</h4>
                  <p className="text-xs text-slate-500">{group.conversations.length} contacts ‚Ä¢ Click to expand</p>
                </div>
                <div className="flex items-center gap-2">
                  {group.totalUnread > 0 && (
                    <Badge className="bg-red-500 text-white">{group.totalUnread}</Badge>
                  )}
                  <div className={`transition-transform ${isExpanded ? 'rotate-180' : ''}`}>
                    ‚ñº
                  </div>
                </div>
              </div>
            </CardHeader>
            {isExpanded && (
              <CardContent className="p-0">
                {group.conversations.map((conv) => {
                  const recipientKey = conv.recipient.isUser ? conv.recipient.id : conv.recipient.email;
                  const selectedKey = selectedRecipient?.isUser ? selectedRecipient.id : selectedRecipient?.email;
                  const isSelected = conv.property.id === selectedPropertyId && recipientKey === selectedKey;
                  const hasMessages = conv.messages && conv.messages.length > 0;
                  const latestMessage = conv.messages?.[conv.messages.length - 1];

                  return (
                    <div
                      key={conv.threadId}
                      onClick={(e) => {
                        e.stopPropagation();
                        onSelect(conv);
                      }}
                      className={`p-3 cursor-pointer border-t border-slate-100 dark:border-slate-700 ${
                        isSelected ? 'bg-indigo-50 dark:bg-indigo-900/20' : 'hover:bg-slate-50 dark:hover:bg-slate-700/50'
                      }`}
                    >
                      <div className="flex items-start justify-between gap-3">
                        <div className="flex items-start gap-2 flex-1 min-w-0">
                          <div className="relative">
                            <Avatar className="w-8 h-8">
                              <AvatarFallback className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white text-xs">
                                {conv.recipient.full_name?.charAt(0) || "?"}
                              </AvatarFallback>
                            </Avatar>
                            {conv.unreadCount > 0 && (
                              <div className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                                <span className="text-white text-[10px] font-bold">{conv.unreadCount}</span>
                              </div>
                            )}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-0.5">
                              <p className={`font-medium text-sm truncate ${
                                conv.unreadCount > 0 ? 'text-red-600 dark:text-red-400' : ''
                              }`}>{conv.recipient.full_name}</p>
                              <Badge variant="outline" className="text-[10px] px-1.5 py-0">{conv.recipient.role}</Badge>
                              {!conv.recipient.isUser && (
                                <Badge variant="secondary" className="text-[10px] px-1.5 py-0">External</Badge>
                              )}
                            </div>
                            {hasMessages ? (
                              <>
                                <p className={`text-xs truncate ${
                                  conv.unreadCount > 0 ? 'font-semibold text-red-600 dark:text-red-400' : 'text-slate-600 dark:text-slate-400'
                                }`}>
                                  {latestMessage?.sender_id === user?.id && "You: "}
                                  {latestMessage?.content}
                                </p>
                                <p className="text-[10px] text-slate-400 mt-0.5">
                                  {format(new Date(latestMessage?.created_date), 'MMM d, h:mm a')}
                                </p>
                              </>
                            ) : (
                              <p className="text-xs text-slate-400 italic">No messages yet</p>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </CardContent>
            )}
          </Card>
        );
      })}
    </div>
  );
}

// New Message Modal Component
function NewMessageModal({ userProperties, allowedRecipients, selectedPropertyId, selectedRecipient, onPropertyChange, onRecipientChange, onClose, onStart, user, users, properties, navigate }) {
  // Filter out recipients without valid identifiers
  const validRecipients = (allowedRecipients || []).filter(r => 
    r && (r.isUser ? r.id : r.email)
  );

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Sparkles className="w-5 h-5 text-indigo-600" />
            New Message
          </DialogTitle>
          <DialogDescription>
            Choose a property and the person you'd like to message
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <Label className="flex items-center gap-2">
              <Badge className="bg-indigo-600 text-white">1</Badge>
              Select Property
            </Label>
            <Select value={selectedPropertyId} onValueChange={onPropertyChange}>
              <SelectTrigger>
                <SelectValue placeholder="Choose a property..." />
              </SelectTrigger>
              <SelectContent>
                {userProperties.map(p => (
                  <SelectItem key={p.id} value={p.id}>
                    <div className="flex items-center gap-2">
                      <Building2 className="w-4 h-4 text-slate-500" />
                      <span className="truncate">{p.address} - {p.city}</span>
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {selectedPropertyId && (
            <div className="space-y-2">
              <Label className="flex items-center gap-2">
                <Badge className="bg-indigo-600 text-white">2</Badge>
                Select Person to Message
              </Label>
              {validRecipients.length === 0 ? (
                <div className="p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                  <p className="text-sm text-amber-900 dark:text-amber-100 mb-2 font-semibold">
                    No people available to message for this property yet.
                  </p>
                  <p className="text-xs text-amber-800 dark:text-amber-200 mb-3">
                    Please add buyer, seller, or agent information to the property first.
                  </p>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => {
                      const property = properties.find(p => p.id === selectedPropertyId);
                      if (property) {
                        navigate(createPageUrl(`PropertyDetail?id=${property.id}`));
                      }
                    }}
                  >
                    Go to Property Details
                  </Button>
                </div>
              ) : (
                <Select
                  value={selectedRecipient ? (selectedRecipient.isAllContacts ? "ALL_CONTACTS" : (selectedRecipient.isUser ? selectedRecipient.id : selectedRecipient.email)) : undefined}
                  onValueChange={(value) => {
                    // Check if "All Contacts" was selected
                    if (value === "ALL_CONTACTS") {
                      onRecipientChange({ 
                        id: "ALL_CONTACTS",
                        full_name: "All Contacts",
                        email: "all_contacts",
                        isAllContacts: true,
                        contacts: validRecipients
                      });
                      return;
                    }
                    
                    const recipient = validRecipients.find(r =>
                      (r.isUser ? r.id : r.email) === value
                    );
                    onRecipientChange(recipient);
                  }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Choose who to message..." />
                  </SelectTrigger>
                  <SelectContent>
                    {/* All Contacts Option */}
                    {validRecipients.length > 1 && (
                      <>
                        <SelectItem value="ALL_CONTACTS">
                          <div className="flex items-center gap-2">
                            <Users className="w-4 h-4 text-purple-600" />
                            <span className="font-semibold text-purple-600">All Contacts ({validRecipients.length})</span>
                          </div>
                        </SelectItem>
                        <div className="h-px bg-slate-200 dark:bg-slate-700 my-1" />
                      </>
                    )}
                    
                    {/* Individual Recipients */}
                    {validRecipients.map(recipient => {
                      const key = recipient.isUser ? recipient.id : recipient.email;
                      if (!key) return null; // Skip if no valid key
                      
                      return (
                        <SelectItem key={key} value={key}>
                          <div className="flex items-center gap-2">
                            <User className="w-4 h-4 text-slate-500" />
                            <span className="truncate">{recipient.full_name || recipient.email}</span>
                            <Badge variant="outline" className="text-xs ml-2">
                              {recipient.role}
                            </Badge>
                            {!recipient.isUser && (
                              <Badge variant="secondary" className="text-xs">External</Badge>
                            )}
                          </div>
                        </SelectItem>
                      );
                    })}
                  </SelectContent>
                </Select>
              )}
            </div>
          )}

          <div className="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
            <div className="flex items-start gap-2">
              <Shield className="w-4 h-4 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
              <div className="text-xs text-blue-900 dark:text-blue-100">
                <p className="font-semibold mb-1">Available Contacts:</p>
                <p className="text-blue-800 dark:text-blue-200">
                  You can message all contacts associated with this property including agents, buyers, sellers, and service providers (title, mortgage, inspection companies).
                </p>
                {validRecipients.length > 1 && (
                  <p className="text-purple-700 dark:text-purple-300 font-semibold mt-2">
                    üí° Use "All Contacts" to message everyone at once
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t">
          <Button variant="outline" onClick={onClose}>
            Cancel
          </Button>
          <Button
            onClick={onStart}
            disabled={!selectedPropertyId || !selectedRecipient}
            className="bg-indigo-600 hover:bg-indigo-700"
          >
            {selectedRecipient?.isAllContacts ? 'Message All' : 'Start Conversation'}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState, useMemo, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Calculator, DollarSign, Home, TrendingUp, PieChart, FileText, RefreshCw, ArrowUp, ArrowDown, Minus } from 'lucide-react';
import { BarChart, Bar, PieChart as RePieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { addMonths, format } from 'date-fns';
import { base44 } from '@/api/base44Client';
import { Badge } from '@/components/ui/badge';

export default function MortgageCalculator() {
    // Live rate state
    const [liveRateData, setLiveRateData] = useState(null);
    const [isLoadingRate, setIsLoadingRate] = useState(true);
    const [rateLastUpdated, setRateLastUpdated] = useState(null);

    // Basic Calculator State
    const [homePrice, setHomePrice] = useState(350000);
    const [downPayment, setDownPayment] = useState(70000);
    const [interestRate, setInterestRate] = useState(6.5);
    const [loanTerm, setLoanTerm] = useState(30);

    // Fetch live mortgage rate on mount
    useEffect(() => {
        const fetchLiveRate = async () => {
            setIsLoadingRate(true);
            try {
                const response = await base44.functions.invoke('getCurrentMortgageRate', {});
                if (response.data?.success && response.data?.data) {
                    const rateData = response.data.data;
                    setLiveRateData(rateData);
                    // Auto-set the interest rate to live rate
                    if (rateData.rate_30_year) {
                        setInterestRate(rateData.rate_30_year);
                    }
                    setRateLastUpdated(response.data.fetched_at || new Date().toISOString());
                }
            } catch (error) {
                console.error('Error fetching live rate:', error);
            } finally {
                setIsLoadingRate(false);
            }
        };

        fetchLiveRate();
    }, []);

    const refreshLiveRate = async () => {
        setIsLoadingRate(true);
        try {
            const response = await base44.functions.invoke('getCurrentMortgageRate', {});
            if (response.data?.success && response.data?.data) {
                const rateData = response.data.data;
                setLiveRateData(rateData);
                if (rateData.rate_30_year) {
                    setInterestRate(rateData.rate_30_year);
                }
                setRateLastUpdated(response.data.fetched_at || new Date().toISOString());
            }
        } catch (error) {
            console.error('Error refreshing rate:', error);
        } finally {
            setIsLoadingRate(false);
        }
    };

    const getTrendIcon = (trend) => {
        if (trend === 'up') return <ArrowUp className="w-3 h-3 text-red-500" />;
        if (trend === 'down') return <ArrowDown className="w-3 h-3 text-green-500" />;
        return <Minus className="w-3 h-3 text-slate-400" />;
    };
    const [propertyTax, setPropertyTax] = useState(3500);
    const [homeInsurance, setHomeInsurance] = useState(1200);
    const [hoaFees, setHoaFees] = useState(0);
    const [pmiRate, setPmiRate] = useState(0.5); // PMI as annual percentage

    // Affordability Calculator State
    const [monthlyIncome, setMonthlyIncome] = useState(8000);
    const [monthlyDebts, setMonthlyDebts] = useState(500);
    const [creditScore, setCreditScore] = useState(740);

    // Calculate monthly payment with PMI tracking
    const calculations = useMemo(() => {
        const principal = homePrice - downPayment;
        const monthlyRate = interestRate / 100 / 12;
        const numberOfPayments = loanTerm * 12;
        
        const monthlyPI = principal > 0 && monthlyRate > 0
            ? (principal * monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / 
              (Math.pow(1 + monthlyRate, numberOfPayments) - 1)
            : principal > 0 ? principal / numberOfPayments : 0; // Handle 0 interest rate
        
        const monthlyPropertyTax = propertyTax / 12;
        const monthlyInsurance = homeInsurance / 12;
        const monthlyHOA = hoaFees;
        
        // PMI Calculations
        const downPaymentPercent = homePrice > 0 ? (downPayment / homePrice) * 100 : 0;
        const needsPMI = downPaymentPercent < 20;
        const monthlyPMI = needsPMI ? (principal * (pmiRate / 100) / 12) : 0;
        
        // Calculate when PMI ends (when loan balance reaches 80% of original home value)
        let pmiMonths = 0;
        let remainingBalance = principal;
        const targetBalance = homePrice * 0.8;
        
        if (needsPMI && principal > 0 && monthlyRate > 0) {
            for (let month = 1; month <= numberOfPayments; month++) {
                const interestPayment = remainingBalance * monthlyRate;
                const principalPayment = monthlyPI - interestPayment;
                remainingBalance -= principalPayment;
                
                if (remainingBalance <= targetBalance) {
                    pmiMonths = month;
                    break;
                }
            }
        } else if (needsPMI && principal > 0 && monthlyRate === 0) { // For 0 interest, PMI ends when principal balance reaches 80% of original home value
            pmiMonths = Math.ceil((principal - targetBalance) / (principal / numberOfPayments));
        }

        // Ensure PMI doesn't exceed loan term
        pmiMonths = Math.min(pmiMonths || numberOfPayments, numberOfPayments);
        if (!needsPMI) pmiMonths = 0; // If PMI is not needed, set pmiMonths to 0

        // Calculate totals
        const totalPMI = monthlyPMI * pmiMonths;
        const totalMonthlyWithPMI = monthlyPI + monthlyPropertyTax + monthlyInsurance + monthlyHOA + monthlyPMI;
        const totalMonthlyWithoutPMI = monthlyPI + monthlyPropertyTax + monthlyInsurance + monthlyHOA;
        
        const totalInterest = (monthlyPI * numberOfPayments) - principal;
        const totalPropertyTax = monthlyPropertyTax * numberOfPayments;
        const totalInsurance = monthlyInsurance * numberOfPayments;
        const totalHOA = monthlyHOA * numberOfPayments;

        const totalOfAllPayments = (totalMonthlyWithPMI * (pmiMonths || 0)) + 
                                   (totalMonthlyWithoutPMI * (numberOfPayments - (pmiMonths || 0))) + downPayment;
        
        const annualPayment = totalMonthlyWithPMI * 12;
        
        // Payoff date
        const payoffDate = addMonths(new Date(), numberOfPayments);

        return {
            principal,
            monthlyPI,
            monthlyPropertyTax,
            monthlyInsurance,
            monthlyHOA,
            monthlyPMI,
            totalMonthlyWithPMI,
            totalMonthlyWithoutPMI,
            totalInterest,
            totalPropertyTax,
            totalInsurance,
            totalHOA,
            totalPMI,
            totalOfAllPayments,
            downPaymentPercent,
            needsPMI,
            pmiMonths,
            annualPayment,
            payoffDate,
            numberOfPayments
        };
    }, [homePrice, downPayment, interestRate, loanTerm, propertyTax, homeInsurance, hoaFees, pmiRate]);

    // Affordability calculations
    const affordability = useMemo(() => {
        const maxDebtRatio = 0.43;
        const maxMonthlyPayment = (monthlyIncome * maxDebtRatio) - monthlyDebts;
        
        const estimatedRate = creditScore >= 740 ? 6.0 : creditScore >= 670 ? 6.5 : 7.0;
        const monthlyRate = estimatedRate / 100 / 12;
        const numberOfPayments = 30 * 12;
        
        const maxLoanAmount = maxMonthlyPayment > 0 && monthlyRate > 0
            ? (maxMonthlyPayment * (Math.pow(1 + monthlyRate, numberOfPayments) - 1)) / 
              (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments))
            : maxMonthlyPayment > 0 ? maxMonthlyPayment * numberOfPayments : 0; // Handle 0 interest rate
        
        const estimatedDownPayment = maxLoanAmount * 0.2;
        const maxHomePrice = maxLoanAmount + estimatedDownPayment;

        return {
            maxMonthlyPayment,
            maxLoanAmount,
            maxHomePrice,
            estimatedRate
        };
    }, [monthlyIncome, monthlyDebts, creditScore]);

    // Calculate recommended income based on current payment
    const recommendedIncome = calculations.totalMonthlyWithPMI * 3;

    // Amortization schedule with PMI tracking
    const amortizationSchedule = useMemo(() => {
        const principal = homePrice - downPayment;
        const monthlyRate = interestRate / 100 / 12;
        const monthlyPI = calculations.monthlyPI;
        
        let remainingBalance = principal;
        const schedule = [];
        
        const totalOtherCostsMonthly = calculations.monthlyPropertyTax + calculations.monthlyInsurance + calculations.monthlyHOA;

        for (let month = 1; month <= Math.min(360, loanTerm * 12); month++) {
            const interestPayment = remainingBalance * monthlyRate;
            const principalPayment = monthlyPI - interestPayment;
            remainingBalance -= principalPayment;
            
            const includesPMI = calculations.needsPMI && month <= calculations.pmiMonths;
            const currentPMI = includesPMI ? calculations.monthlyPMI : 0;

            const totalMonthlyPayment = monthlyPI + totalOtherCostsMonthly + currentPMI;
            
            schedule.push({
                month,
                year: Math.ceil(month / 12),
                payment: monthlyPI, // P&I only
                principal: principalPayment,
                interest: interestPayment,
                balance: Math.max(0, remainingBalance),
                pmi: currentPMI,
                totalPayment: totalMonthlyPayment // P&I + Tax + Ins + HOA + PMI
            });
        }
        
        return schedule;
    }, [homePrice, downPayment, interestRate, loanTerm, calculations]);

    // Pie chart data
    const pieData = [
        { name: 'Principal & Interest', value: calculations.monthlyPI, color: '#3b82f6' },
        { name: 'Property Tax', value: calculations.monthlyPropertyTax, color: '#10b981' },
        { name: 'Insurance', value: calculations.monthlyInsurance, color: '#f59e0b' },
        { name: 'HOA Fees', value: calculations.monthlyHOA, color: '#8b5cf6' },
        { name: 'PMI', value: calculations.monthlyPMI, color: '#ef4444' }
    ].filter(item => item.value > 0);

    const formatCurrency = (value) => {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            maximumFractionDigits: 0
        }).format(value);
    };

    return (
        <div className="page-container p-6 bg-gradient-to-br from-slate-50 to-blue-50 dark:from-slate-950 dark:to-slate-900 min-h-screen">
            <div className="max-w-7xl mx-auto space-y-6">
                {/* Header */}
                <div className="flex items-center justify-between">
                    <div>
                        <h1 className="text-3xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                            <Calculator className="w-8 h-8 text-blue-600" />
                            Mortgage Calculator
                        </h1>
                        <p className="text-slate-600 dark:text-slate-400 mt-1">
                            Calculate monthly payments, affordability, and view amortization schedules
                        </p>
                    </div>
                </div>

                {/* Live Rate Banner */}
                {liveRateData && (
                    <Card className="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-green-200">
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between flex-wrap gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center">
                                        <TrendingUp className="w-5 h-5 text-green-600" />
                                    </div>
                                    <div>
                                        <p className="text-sm text-green-700 dark:text-green-300 font-medium">Today's Live Mortgage Rates</p>
                                        <p className="text-xs text-green-600 dark:text-green-400">
                                            Updated daily at 4:30 AM ‚Ä¢ Source: {liveRateData.source}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-6">
                                    <div className="text-center">
                                        <p className="text-2xl font-bold text-green-700 dark:text-green-300 flex items-center gap-1">
                                            {liveRateData.rate_30_year}%
                                            {getTrendIcon(liveRateData.trend)}
                                        </p>
                                        <p className="text-xs text-green-600">30-Year Fixed</p>
                                    </div>
                                    {liveRateData.rate_15_year && (
                                        <div className="text-center">
                                            <p className="text-2xl font-bold text-green-700 dark:text-green-300">
                                                {liveRateData.rate_15_year}%
                                            </p>
                                            <p className="text-xs text-green-600">15-Year Fixed</p>
                                        </div>
                                    )}
                                    <Button
                                        variant="outline"
                                        size="sm"
                                        onClick={refreshLiveRate}
                                        disabled={isLoadingRate}
                                        className="border-green-300 text-green-700 hover:bg-green-100"
                                    >
                                        <RefreshCw className={`w-4 h-4 mr-1 ${isLoadingRate ? 'animate-spin' : ''}`} />
                                        Refresh
                                    </Button>
                                </div>
                            </div>
                        </CardContent>
                    </Card>
                )}

                {isLoadingRate && !liveRateData && (
                    <Card className="bg-slate-50 dark:bg-slate-900/50">
                        <CardContent className="p-4 flex items-center gap-3">
                            <RefreshCw className="w-5 h-5 animate-spin text-blue-600" />
                            <span className="text-slate-600 dark:text-slate-400">Fetching today's live mortgage rates...</span>
                        </CardContent>
                    </Card>
                )}

                <Tabs defaultValue="calculator" className="w-full">
                    <TabsList className="grid w-full grid-cols-3 max-w-md">
                        <TabsTrigger value="calculator">Calculator</TabsTrigger>
                        <TabsTrigger value="affordability">Affordability</TabsTrigger>
                        <TabsTrigger value="amortization">Schedule</TabsTrigger>
                    </TabsList>

                    {/* Main Calculator Tab */}
                    <TabsContent value="calculator" className="space-y-6">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Input Card */}
                            <Card className="lg:col-span-2">
                                <CardHeader>
                                    <CardTitle className="flex items-center gap-2">
                                        <Home className="w-5 h-5 text-blue-600" />
                                        Loan Details
                                    </CardTitle>
                                </CardHeader>
                                <CardContent className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <Label>Home Price</Label>
                                            <Input
                                                type="number"
                                                value={homePrice}
                                                onChange={(e) => setHomePrice(Number(e.target.value))}
                                                className="mt-1"
                                            />
                                        </div>
                                        <div>
                                            <Label>Down Payment ({calculations.downPaymentPercent.toFixed(1)}%)</Label>
                                            <Input
                                                type="number"
                                                value={downPayment}
                                                onChange={(e) => setDownPayment(Number(e.target.value))}
                                                className="mt-1"
                                            />
                                        </div>
                                        <div>
                                            <div className="flex items-center justify-between">
                                                <Label>Interest Rate (%)</Label>
                                                {liveRateData && (
                                                    <div className="flex items-center gap-1">
                                                        <Badge variant="outline" className="text-xs bg-green-50 text-green-700 border-green-200">
                                                            Live Rate
                                                        </Badge>
                                                        {getTrendIcon(liveRateData.trend)}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="relative mt-1">
                                                <Input
                                                    type="number"
                                                    step="0.1"
                                                    value={interestRate}
                                                    onChange={(e) => setInterestRate(Number(e.target.value))}
                                                />
                                                <Button
                                                    variant="ghost"
                                                    size="sm"
                                                    className="absolute right-1 top-1/2 -translate-y-1/2 h-7 px-2"
                                                    onClick={refreshLiveRate}
                                                    disabled={isLoadingRate}
                                                >
                                                    <RefreshCw className={`w-3 h-3 ${isLoadingRate ? 'animate-spin' : ''}`} />
                                                </Button>
                                            </div>
                                            {liveRateData && (
                                                <p className="text-xs text-slate-500 mt-1">
                                                    {liveRateData.source} ‚Ä¢ Updated {liveRateData.rate_date}
                                                    {liveRateData.weekly_change && (
                                                        <span className={liveRateData.weekly_change > 0 ? 'text-red-500' : 'text-green-500'}>
                                                            {' '}({liveRateData.weekly_change > 0 ? '+' : ''}{liveRateData.weekly_change.toFixed(2)}% this week)
                                                        </span>
                                                    )}
                                                </p>
                                            )}
                                        </div>
                                        <div>
                                            <Label>Loan Term (years)</Label>
                                            <Input
                                                type="number"
                                                value={loanTerm}
                                                onChange={(e) => setLoanTerm(Number(e.target.value))}
                                                className="mt-1"
                                            />
                                        </div>
                                        <div>
                                            <Label>Property Tax (annual)</Label>
                                            <Input
                                                type="number"
                                                value={propertyTax}
                                                onChange={(e) => setPropertyTax(Number(e.target.value))}
                                                className="mt-1"
                                            />
                                        </div>
                                        <div>
                                            <Label>Home Insurance (annual)</Label>
                                            <Input
                                                type="number"
                                                value={homeInsurance}
                                                onChange={(e) => setHomeInsurance(Number(e.target.value))}
                                                className="mt-1"
                                            />
                                        </div>
                                        <div>
                                            <Label>HOA Fees (monthly)</Label>
                                            <Input
                                                type="number"
                                                value={hoaFees}
                                                onChange={(e) => setHoaFees(Number(e.target.value))}
                                                className="mt-1"
                                            />
                                        </div>
                                        <div>
                                            <Label>PMI Rate (annual %)</Label>
                                            <Input
                                                type="number"
                                                step="0.1"
                                                value={pmiRate}
                                                onChange={(e) => setPmiRate(Number(e.target.value))}
                                                className="mt-1"
                                            />
                                        </div>
                                    </div>
                                </CardContent>
                            </Card>

                            {/* Results Card */}
                            <Card className="bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                                <CardHeader>
                                    <CardTitle className="text-white">Monthly Payment</CardTitle>
                                </CardHeader>
                                <CardContent className="space-y-4">
                                    <div>
                                        <p className="text-blue-100 text-sm">
                                            {calculations.needsPMI ? 'Total with PMI' : 'Total Monthly Payment'}
                                        </p>
                                        <p className="text-4xl font-bold">{formatCurrency(calculations.totalMonthlyWithPMI)}</p>
                                    </div>
                                    
                                    {calculations.needsPMI && calculations.pmiMonths > 0 && (
                                        <div className="bg-white/20 rounded-lg p-3">
                                            <p className="text-blue-100 text-xs mb-1">After PMI ends ({calculations.pmiMonths} months)</p>
                                            <p className="text-2xl font-bold">{formatCurrency(calculations.totalMonthlyWithoutPMI)}</p>
                                        </div>
                                    )}

                                    <div className="space-y-2 pt-4 border-t border-blue-400">
                                        <div className="flex justify-between text-sm">
                                            <span className="text-blue-100">Principal & Interest</span>
                                            <span className="font-semibold">{formatCurrency(calculations.monthlyPI)}</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-blue-100">Property Tax</span>
                                            <span className="font-semibold">{formatCurrency(calculations.monthlyPropertyTax)}</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-blue-100">Insurance</span>
                                            <span className="font-semibold">{formatCurrency(calculations.monthlyInsurance)}</span>
                                        </div>
                                        {calculations.monthlyHOA > 0 && (
                                            <div className="flex justify-between text-sm">
                                                <span className="text-blue-100">HOA Fees</span>
                                                <span className="font-semibold">{formatCurrency(calculations.monthlyHOA)}</span>
                                            </div>
                                        )}
                                        {calculations.needsPMI && (
                                            <div className="flex justify-between text-sm">
                                                <span className="text-blue-100">PMI ({calculations.pmiMonths} months)</span>
                                                <span className="font-semibold">{formatCurrency(calculations.monthlyPMI)}</span>
                                            </div>
                                        )}
                                    </div>
                                </CardContent>
                            </Card>
                        </div>

                        {/* Mortgage Summary */}
                        <Card>
                            <CardHeader>
                                <CardTitle className="flex items-center gap-2">
                                    <FileText className="w-5 h-5 text-blue-600" />
                                    Mortgage Repayment Summary
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Down Payment</p>
                                        <p className="text-xl font-bold text-blue-600">{formatCurrency(downPayment)}</p>
                                        <p className="text-xs text-slate-500 mt-1">{calculations.downPaymentPercent.toFixed(2)}%</p>
                                    </div>

                                    <div className="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Loan Amount</p>
                                        <p className="text-xl font-bold text-green-600">{formatCurrency(calculations.principal)}</p>
                                    </div>

                                    <div className="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Total Interest</p>
                                        <p className="text-xl font-bold text-red-600">{formatCurrency(calculations.totalInterest)}</p>
                                    </div>

                                    <div className="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Payoff Date</p>
                                        <p className="text-lg font-bold text-purple-600">{format(calculations.payoffDate, 'MMM dd, yyyy')}</p>
                                    </div>

                                    {calculations.needsPMI && calculations.pmiMonths > 0 && (
                                        <>
                                            <div className="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                                                <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Total PMI</p>
                                                <p className="text-xl font-bold text-orange-600">{formatCurrency(calculations.totalPMI)}</p>
                                                <p className="text-xs text-slate-500 mt-1">{calculations.pmiMonths} payments</p>
                                            </div>
                                            <div className="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                                <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">PMI Ends</p>
                                                <p className="text-lg font-bold text-yellow-600">
                                                    {format(addMonths(new Date(), calculations.pmiMonths), 'MMM dd, yyyy')}
                                                </p>
                                            </div>
                                        </>
                                    )}

                                    <div className="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Total Property Tax</p>
                                        <p className="text-xl font-bold text-indigo-600">{formatCurrency(calculations.totalPropertyTax)}</p>
                                    </div>

                                    <div className="p-4 bg-teal-50 dark:bg-teal-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Total Insurance</p>
                                        <p className="text-xl font-bold text-teal-600">{formatCurrency(calculations.totalInsurance)}</p>
                                    </div>

                                    <div className="p-4 bg-pink-50 dark:bg-pink-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Annual Payment</p>
                                        <p className="text-xl font-bold text-pink-600">{formatCurrency(calculations.annualPayment)}</p>
                                    </div>

                                    <div className="p-4 bg-slate-100 dark:bg-slate-800 rounded-lg border-2 border-slate-300 dark:border-slate-600">
                                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Total All-In Cost</p>
                                        <p className="text-xl font-bold text-slate-900 dark:text-white">{formatCurrency(calculations.totalOfAllPayments)}</p>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>

                        {/* Payment Breakdown Chart */}
                        <Card>
                            <CardHeader>
                                <CardTitle className="flex items-center gap-2">
                                    <PieChart className="w-5 h-5 text-blue-600" />
                                    Monthly Payment Breakdown
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <ResponsiveContainer width="100%" height={300}>
                                    <RePieChart>
                                        <Pie
                                            data={pieData}
                                            cx="50%"
                                            cy="50%"
                                            labelLine={false}
                                            label={({ name, value }) => `${name}: ${formatCurrency(value)}`}
                                            outerRadius={80}
                                            fill="#8884d8"
                                            dataKey="value"
                                        >
                                            {pieData.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={entry.color} />
                                            ))}
                                        </Pie>
                                        <Tooltip formatter={(value) => formatCurrency(value)} />
                                        <Legend />
                                    </RePieChart>
                                </ResponsiveContainer>
                            </CardContent>
                        </Card>

                        {/* Principal vs Interest Over Time */}
                        <Card>
                            <CardHeader>
                                <CardTitle className="flex items-center gap-2">
                                    <TrendingUp className="w-5 h-5 text-blue-600" />
                                    Principal vs Interest Over Time
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <ResponsiveContainer width="100%" height={300}>
                                    <BarChart data={amortizationSchedule.filter(row => row.month % 12 === 0)}>
                                        <CartesianGrid strokeDasharray="3 3" />
                                        <XAxis dataKey="year" label={{ value: 'Year', position: 'insideBottom', offset: -5 }} />
                                        <YAxis />
                                        <Tooltip formatter={(value) => formatCurrency(value)} />
                                        <Legend />
                                        <Bar dataKey="principal" fill="#10b981" name="Principal" />
                                        <Bar dataKey="interest" fill="#ef4444" name="Interest" />
                                    </BarChart>
                                </ResponsiveContainer>
                            </CardContent>
                        </Card>
                    </TabsContent>

                    {/* Affordability Tab */}
                    <TabsContent value="affordability" className="space-y-6">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <Card>
                                <CardHeader>
                                    <CardTitle className="flex items-center gap-2">
                                        <DollarSign className="w-5 h-5 text-green-600" />
                                        Your Financial Profile
                                    </CardTitle>
                                </CardHeader>
                                <CardContent className="space-y-4">
                                    <div>
                                        <Label>Monthly Gross Income</Label>
                                        <Input
                                            type="number"
                                            value={monthlyIncome}
                                            onChange={(e) => setMonthlyIncome(Number(e.target.value))}
                                            className="mt-1"
                                        />
                                    </div>
                                    <div>
                                        <Label>Monthly Debt Payments</Label>
                                        <Input
                                            type="number"
                                            value={monthlyDebts}
                                            onChange={(e) => setMonthlyDebts(Number(e.target.value))}
                                            className="mt-1"
                                        />
                                        <p className="text-xs text-slate-500 mt-1">
                                            Include car loans, student loans, credit cards, etc.
                                        </p>
                                    </div>
                                    <div>
                                        <Label>Credit Score</Label>
                                        <Input
                                            type="number"
                                            value={creditScore}
                                            onChange={(e) => setCreditScore(Number(e.target.value))}
                                            className="mt-1"
                                        />
                                    </div>
                                </CardContent>
                            </Card>

                            <Card className="bg-gradient-to-br from-green-500 to-green-600 text-white">
                                <CardHeader>
                                    <CardTitle className="text-white">You Can Afford</CardTitle>
                                </CardHeader>
                                <CardContent className="space-y-4">
                                    <div>
                                        <p className="text-green-100 text-sm">Maximum Home Price</p>
                                        <p className="text-4xl font-bold">{formatCurrency(affordability.maxHomePrice)}</p>
                                    </div>
                                    <div className="space-y-3 pt-4 border-t border-green-400">
                                        <div>
                                            <p className="text-green-100 text-sm">Max Monthly Payment</p>
                                            <p className="text-2xl font-semibold">{formatCurrency(affordability.maxMonthlyPayment)}</p>
                                        </div>
                                        <div>
                                            <p className="text-green-100 text-sm">Max Loan Amount</p>
                                            <p className="text-xl font-semibold">{formatCurrency(affordability.maxLoanAmount)}</p>
                                        </div>
                                        <div>
                                            <p className="text-green-100 text-sm">Estimated Rate</p>
                                            <p className="text-xl font-semibold">{affordability.estimatedRate.toFixed(2)}%</p>
                                        </div>
                                    </div>
                                    <div className="pt-4 border-t border-green-400">
                                        <p className="text-xs text-green-100">
                                            Based on 43% debt-to-income ratio and 20% down payment
                                        </p>
                                    </div>
                                </CardContent>
                            </Card>
                        </div>

                        <Card>
                            <CardHeader>
                                <CardTitle>Income Requirements</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400">Current Monthly Payment</p>
                                        <p className="text-2xl font-bold text-blue-600">{formatCurrency(calculations.totalMonthlyWithPMI)}</p>
                                    </div>
                                    <div className="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400">Recommended Monthly Income</p>
                                        <p className="text-2xl font-bold text-green-600">{formatCurrency(recommendedIncome)}</p>
                                    </div>
                                    <div className="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                        <p className="text-sm text-slate-600 dark:text-slate-400">Your Current Income</p>
                                        <p className="text-2xl font-bold text-purple-600">{formatCurrency(monthlyIncome)}</p>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    </TabsContent>

                    <TabsContent value="amortization" className="space-y-6">
                        <Card>
                            <CardHeader>
                                <CardTitle className="flex items-center gap-2">
                                    <FileText className="w-5 h-5 text-blue-600" />
                                    Amortization Schedule
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b">
                                                <th className="text-left py-3 px-2">Month</th>
                                                <th className="text-right py-3 px-2">P&I</th>
                                                <th className="text-right py-3 px-2">Principal</th>
                                                <th className="text-right py-3 px-2">Interest</th>
                                                {calculations.needsPMI && <th className="text-right py-3 px-2">PMI</th>}
                                                <th className="text-right py-3 px-2">Balance</th>
                                                <th className="text-right py-3 px-2">Total Payment</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {amortizationSchedule.map((row) => ( // Changed slice(0,12) to show all
                                                <tr key={row.month} className="border-b hover:bg-slate-50 dark:hover:bg-slate-800">
                                                    <td className="py-3 px-2 font-medium">{row.month}</td>
                                                    <td className="text-right py-3 px-2">{formatCurrency(row.payment)}</td>
                                                    <td className="text-right py-3 px-2 text-green-600">{formatCurrency(row.principal)}</td>
                                                    <td className="text-right py-3 px-2 text-red-600">{formatCurrency(row.interest)}</td>
                                                    {calculations.needsPMI && (
                                                        <td className="text-right py-3 px-2 text-orange-600">{formatCurrency(row.pmi)}</td>
                                                    )}
                                                    <td className="text-right py-3 px-2 font-medium">{formatCurrency(row.balance)}</td>
                                                    <td className="text-right py-3 px-2 font-bold">{formatCurrency(row.totalPayment)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <p className="text-xs text-slate-500 mt-4">
                                    Showing full {loanTerm}-year schedule.
                                </p>
                            </CardContent>
                        </Card>
                    </TabsContent>
                </Tabs>
            </div>
        </div>
    );
}
import React, { useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Target, AlertTriangle, DollarSign, Briefcase, Activity, Users } from 'lucide-react';
import GoalProgressChart from '../components/goals/GoalProgressChart';

export default function MyGoals() {
    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me()
    });

    const { data: teamMembers = [] } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: async () => {
            try {
                return await base44.entities.TeamMember.list() || [];
            } catch (error) {
                return [];
            }
        }
    });

    const { data: goals = [] } = useQuery({
        queryKey: ['performanceGoals'],
        queryFn: async () => {
            try {
                return await base44.entities.PerformanceGoal.list() || [];
            } catch (error) {
                return [];
            }
        }
    });

    // Find my goals
    const myGoals = useMemo(() => {
        if (!user || !teamMembers.length) return [];
        
        const myTeamMember = teamMembers.find(m => m.email === user.email);
        if (!myTeamMember) return [];

        return goals.filter(g => g.agent_id === myTeamMember.id);
    }, [goals, teamMembers, user]);

    const currentGoal = useMemo(() => {
        const now = new Date();
        return myGoals.find(g => {
            const end = new Date(g.period_end);
            return end >= now && g.status !== 'completed';
        });
    }, [myGoals]);

    const getProgressPercentage = (current, target) => {
        if (!target || target === 0) return 0;
        return Math.min(Math.round((current / target) * 100), 100);
    };

    const getStatusColor = (status) => {
        const colors = {
            on_track: 'bg-green-100 text-green-700 border-green-200',
            exceeded: 'bg-blue-100 text-blue-700 border-blue-200',
            at_risk: 'bg-yellow-100 text-yellow-700 border-yellow-200',
            behind: 'bg-red-100 text-red-700 border-red-200',
            completed: 'bg-slate-100 text-slate-700 border-slate-200'
        };
        return colors[status] || colors.on_track;
    };

    if (!currentGoal) {
        return (
            <div className="page-container">
                <Card>
                    <CardContent className="p-12 text-center">
                        <Target className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                        <h3 className="text-lg font-semibold mb-2">No Active Goals</h3>
                        <p className="text-slate-500">
                            You don't have any active performance goals. Contact your manager to set goals.
                        </p>
                    </CardContent>
                </Card>
            </div>
        );
    }

    return (
        <div className="page-container space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold">My Performance Goals</h1>
                    <p className="text-slate-500 dark:text-slate-400 mt-1">
                        Track your progress towards your performance targets
                    </p>
                </div>
                <Badge className={getStatusColor(currentGoal.status)}>
                    {currentGoal.status.replace('_', ' ').toUpperCase()}
                </Badge>
            </div>

            {/* Goal Header */}
            <Card>
                <CardHeader>
                    <div className="flex justify-between items-start">
                        <div>
                            <CardTitle>{currentGoal.period_type.charAt(0).toUpperCase() + currentGoal.period_type.slice(1)} Goal</CardTitle>
                            <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                                {new Date(currentGoal.period_start).toLocaleDateString()} - {new Date(currentGoal.period_end).toLocaleDateString()}
                            </p>
                        </div>
                    </div>
                </CardHeader>
            </Card>

            {/* Progress Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {currentGoal.revenue_goal > 0 && (
                    <Card>
                        <CardContent className="p-6">
                            <div className="flex items-center justify-between mb-4">
                                <DollarSign className="w-8 h-8 text-green-500" />
                                <span className="text-2xl font-bold">
                                    {getProgressPercentage(currentGoal.current_revenue, currentGoal.revenue_goal)}%
                                </span>
                            </div>
                            <h3 className="font-semibold mb-2">Revenue</h3>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                ${(currentGoal.current_revenue || 0).toLocaleString()} / ${currentGoal.revenue_goal.toLocaleString()}
                            </p>
                            <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 mt-2">
                                <div
                                    className="bg-green-500 h-2 rounded-full transition-all"
                                    style={{ width: `${getProgressPercentage(currentGoal.current_revenue, currentGoal.revenue_goal)}%` }}
                                />
                            </div>
                        </CardContent>
                    </Card>
                )}

                {currentGoal.deals_goal > 0 && (
                    <Card>
                        <CardContent className="p-6">
                            <div className="flex items-center justify-between mb-4">
                                <Briefcase className="w-8 h-8 text-blue-500" />
                                <span className="text-2xl font-bold">
                                    {getProgressPercentage(currentGoal.current_deals, currentGoal.deals_goal)}%
                                </span>
                            </div>
                            <h3 className="font-semibold mb-2">Deals Closed</h3>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                {currentGoal.current_deals || 0} / {currentGoal.deals_goal}
                            </p>
                            <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 mt-2">
                                <div
                                    className="bg-blue-500 h-2 rounded-full transition-all"
                                    style={{ width: `${getProgressPercentage(currentGoal.current_deals, currentGoal.deals_goal)}%` }}
                                />
                            </div>
                        </CardContent>
                    </Card>
                )}

                {currentGoal.activities_goal > 0 && (
                    <Card>
                        <CardContent className="p-6">
                            <div className="flex items-center justify-between mb-4">
                                <Activity className="w-8 h-8 text-purple-500" />
                                <span className="text-2xl font-bold">
                                    {getProgressPercentage(currentGoal.current_activities, currentGoal.activities_goal)}%
                                </span>
                            </div>
                            <h3 className="font-semibold mb-2">Activities</h3>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                {currentGoal.current_activities || 0} / {currentGoal.activities_goal}
                            </p>
                            <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 mt-2">
                                <div
                                    className="bg-purple-500 h-2 rounded-full transition-all"
                                    style={{ width: `${getProgressPercentage(currentGoal.current_activities, currentGoal.activities_goal)}%` }}
                                />
                            </div>
                        </CardContent>
                    </Card>
                )}

                {currentGoal.leads_goal > 0 && (
                    <Card>
                        <CardContent className="p-6">
                            <div className="flex items-center justify-between mb-4">
                                <Users className="w-8 h-8 text-orange-500" />
                                <span className="text-2xl font-bold">
                                    {getProgressPercentage(currentGoal.current_leads, currentGoal.leads_goal)}%
                                </span>
                            </div>
                            <h3 className="font-semibold mb-2">New Leads</h3>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                {currentGoal.current_leads || 0} / {currentGoal.leads_goal}
                            </p>
                            <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 mt-2">
                                <div
                                    className="bg-orange-500 h-2 rounded-full transition-all"
                                    style={{ width: `${getProgressPercentage(currentGoal.current_leads, currentGoal.leads_goal)}%` }}
                                />
                            </div>
                        </CardContent>
                    </Card>
                )}
            </div>

            {/* AI Insights */}
            {currentGoal.ai_insights && (currentGoal.status === 'at_risk' || currentGoal.status === 'behind') && (
                <Card className="border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20">
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2 text-amber-800 dark:text-amber-300">
                            <AlertTriangle className="w-5 h-5" />
                            AI Performance Coach Recommendation
                        </CardTitle>
                    </CardHeader>
                    <CardContent>
                        <p className="text-amber-700 dark:text-amber-400">
                            {JSON.parse(currentGoal.ai_insights).recommendation}
                        </p>
                    </CardContent>
                </Card>
            )}

            {/* Progress Chart */}
            <GoalProgressChart goal={currentGoal} />

            {/* Manager Notes */}
            {currentGoal.manager_notes && (
                <Card>
                    <CardHeader>
                        <CardTitle>Manager Notes</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <p className="text-slate-600 dark:text-slate-400">{currentGoal.manager_notes}</p>
                    </CardContent>
                </Card>
            )}
        </div>
    );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  Calculator,
  DollarSign,
  Home,
  FileText,
  Download,
  Share2,
  Sparkles,
  AlertCircle,
  Building2,
  Percent,
  MinusCircle,
  PlusCircle
} from "lucide-react";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { toast } from "sonner";

export default function NetSheetGenerator() {
  // Property Selection
  const [properties, setProperties] = useState([]);
  const [selectedPropertyId, setSelectedPropertyId] = useState("");

  // Sale Information
  const [salePrice, setSalePrice] = useState(500000);
  const [propertyAddress, setPropertyAddress] = useState("");
  
  // Mortgage & Liens
  const [mortgageBalance, setMortgageBalance] = useState(300000);
  const [secondMortgage, setSecondMortgage] = useState(0);
  const [otherLiens, setOtherLiens] = useState(0);

  // Commission
  const [listingCommission, setListingCommission] = useState(3);
  const [sellingCommission, setSellingCommission] = useState(3);

  // Closing Costs
  const [titleInsurance, setTitleInsurance] = useState(1500);
  const [escrowFees, setEscrowFees] = useState(800);
  const [transferTax, setTransferTax] = useState(0); // Auto-calculated
  const [recordingFees, setRecordingFees] = useState(250);
  const [homeWarranty, setHomeWarranty] = useState(500);
  const [attorneyFees, setAttorneyFees] = useState(0);

  // Seller Costs
  const [sellerConcessions, setSellerConcessions] = useState(0);
  const [repairs, setRepairs] = useState(0);
  const [inspectionFees, setInspectionFees] = useState(0);
  const [stagingCosts, setStagingCosts] = useState(0);

  // Prorations
  const [propertyTaxProration, setPropertyTaxProration] = useState(0);
  const [hoaProration, setHoaProration] = useState(0);

  // Additional Credits/Debits
  const [additionalCredits, setAdditionalCredits] = useState(0);
  const [additionalDebits, setAdditionalDebits] = useState(0);

  // Calculated Values
  const [calculations, setCalculations] = useState({
    totalCommission: 0,
    totalClosingCosts: 0,
    totalPayoffs: 0,
    totalDebits: 0,
    netToSeller: 0
  });

  useEffect(() => {
    loadProperties();
  }, []);

  useEffect(() => {
    calculateNetSheet();
  }, [
    salePrice, mortgageBalance, secondMortgage, otherLiens,
    listingCommission, sellingCommission, titleInsurance, escrowFees,
    transferTax, recordingFees, homeWarranty, attorneyFees,
    sellerConcessions, repairs, inspectionFees, stagingCosts,
    propertyTaxProration, hoaProration, additionalCredits, additionalDebits
  ]);

  useEffect(() => {
    // Auto-calculate transfer tax (typically 0.1% to 2% depending on location)
    // Using 0.5% as default
    setTransferTax(salePrice * 0.005);
  }, [salePrice]);

  const loadProperties = async () => {
    try {
      const props = await base44.entities.Property.list();
      setProperties(props || []);
    } catch (error) {
      console.error("Error loading properties:", error);
    }
  };

  const handlePropertySelect = (propertyId) => {
    setSelectedPropertyId(propertyId);
    const property = properties.find(p => p.id === propertyId);
    if (property) {
      setSalePrice(property.price || 0);
      setPropertyAddress(property.address);
      
      // Set commission rates if available
      if (property.listing_side_commission) {
        setListingCommission(property.listing_side_commission);
      }
      if (property.selling_side_commission) {
        setSellingCommission(property.selling_side_commission);
      }

      toast.success("Property data loaded!");
    }
  };

  const calculateNetSheet = () => {
    // Total Commission
    const totalCommission = salePrice * ((listingCommission + sellingCommission) / 100);

    // Total Closing Costs
    const totalClosingCosts = 
      titleInsurance + 
      escrowFees + 
      transferTax + 
      recordingFees + 
      homeWarranty + 
      attorneyFees;

    // Total Payoffs
    const totalPayoffs = mortgageBalance + secondMortgage + otherLiens;

    // Total Debits
    const totalDebits = 
      totalCommission + 
      totalClosingCosts + 
      totalPayoffs + 
      sellerConcessions + 
      repairs + 
      inspectionFees + 
      stagingCosts + 
      propertyTaxProration + 
      hoaProration + 
      additionalDebits;

    // Net to Seller
    const netToSeller = salePrice - totalDebits + additionalCredits;

    setCalculations({
      totalCommission,
      totalClosingCosts,
      totalPayoffs,
      totalDebits,
      netToSeller
    });
  };

  const formatCurrency = (value) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(value);
  };

  const formatPercent = (value) => {
    return `${value}%`;
  };

  const downloadNetSheet = () => {
    toast.success("Net sheet download coming soon!");
  };

  const shareNetSheet = () => {
    toast.success("Net sheet sharing coming soon!");
  };

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Header */}
        <Card className="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
          <CardContent className="p-6">
            <div className="flex items-center gap-4">
              <div className="w-16 h-16 bg-white/20 rounded-lg flex items-center justify-center">
                <FileText className="w-8 h-8" />
              </div>
              <div className="flex-1">
                <h1 className="text-3xl font-bold mb-2">Seller Net Sheet Generator</h1>
                <p className="text-green-100">
                  Navigate negotiations with confidence! Ensure accurate closing cost calculations and showcase your professionalism.
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column - Input Form */}
          <div className="lg:col-span-2 space-y-6">
            {/* Property Selection */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Home className="w-5 h-5" />
                  Property Information
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <Label>Select Property (Optional)</Label>
                  <Select value={selectedPropertyId} onValueChange={handlePropertySelect}>
                    <SelectTrigger>
                      <SelectValue placeholder="Choose from existing properties..." />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value={null}>Manual Entry</SelectItem>
                      {properties.map(p => (
                        <SelectItem key={p.id} value={p.id}>
                          {p.address} - {formatCurrency(p.price)}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label>Property Address</Label>
                  <Input
                    value={propertyAddress}
                    onChange={(e) => setPropertyAddress(e.target.value)}
                    placeholder="123 Main St, City, State"
                  />
                </div>

                <div>
                  <Label>Sale Price *</Label>
                  <div className="relative">
                    <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                    <Input
                      type="number"
                      value={salePrice}
                      onChange={(e) => setSalePrice(parseFloat(e.target.value) || 0)}
                      className="pl-9"
                    />
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Mortgage & Liens */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Building2 className="w-5 h-5" />
                  Mortgage & Liens Payoff
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <Label>First Mortgage Balance</Label>
                  <div className="relative">
                    <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                    <Input
                      type="number"
                      value={mortgageBalance}
                      onChange={(e) => setMortgageBalance(parseFloat(e.target.value) || 0)}
                      className="pl-9"
                    />
                  </div>
                </div>

                <div>
                  <Label>Second Mortgage / HELOC</Label>
                  <div className="relative">
                    <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                    <Input
                      type="number"
                      value={secondMortgage}
                      onChange={(e) => setSecondMortgage(parseFloat(e.target.value) || 0)}
                      className="pl-9"
                    />
                  </div>
                </div>

                <div>
                  <Label>Other Liens / Judgments</Label>
                  <div className="relative">
                    <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                    <Input
                      type="number"
                      value={otherLiens}
                      onChange={(e) => setOtherLiens(parseFloat(e.target.value) || 0)}
                      className="pl-9"
                    />
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Commission */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Percent className="w-5 h-5" />
                  Real Estate Commission
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Listing Commission (%)</Label>
                    <Input
                      type="number"
                      step="0.1"
                      value={listingCommission}
                      onChange={(e) => setListingCommission(parseFloat(e.target.value) || 0)}
                    />
                  </div>
                  <div>
                    <Label>Selling Commission (%)</Label>
                    <Input
                      type="number"
                      step="0.1"
                      value={sellingCommission}
                      onChange={(e) => setSellingCommission(parseFloat(e.target.value) || 0)}
                    />
                  </div>
                </div>
                <div className="bg-slate-50 p-3 rounded-lg">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">Total Commission ({listingCommission + sellingCommission}%)</span>
                    <span className="text-lg font-bold text-red-600">
                      {formatCurrency(calculations.totalCommission)}
                    </span>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Closing Costs */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <FileText className="w-5 h-5" />
                  Closing Costs
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Title Insurance</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={titleInsurance}
                        onChange={(e) => setTitleInsurance(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Escrow Fees</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={escrowFees}
                        onChange={(e) => setEscrowFees(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Transfer Tax (Auto)</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={transferTax}
                        onChange={(e) => setTransferTax(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Recording Fees</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={recordingFees}
                        onChange={(e) => setRecordingFees(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Home Warranty</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={homeWarranty}
                        onChange={(e) => setHomeWarranty(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Attorney Fees</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={attorneyFees}
                        onChange={(e) => setAttorneyFees(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Seller Costs */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <MinusCircle className="w-5 h-5" />
                  Seller-Paid Costs
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Seller Concessions</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={sellerConcessions}
                        onChange={(e) => setSellerConcessions(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Repairs</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={repairs}
                        onChange={(e) => setRepairs(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Inspection Fees</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={inspectionFees}
                        onChange={(e) => setInspectionFees(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Staging Costs</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={stagingCosts}
                        onChange={(e) => setStagingCosts(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Prorations & Additional */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Calculator className="w-5 h-5" />
                  Prorations & Additional Items
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Property Tax Proration</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={propertyTaxProration}
                        onChange={(e) => setPropertyTaxProration(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>HOA Proration</Label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                      <Input
                        type="number"
                        value={hoaProration}
                        onChange={(e) => setHoaProration(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Additional Credits (+)</Label>
                    <div className="relative">
                      <PlusCircle className="absolute left-3 top-3 w-4 h-4 text-green-500" />
                      <Input
                        type="number"
                        value={additionalCredits}
                        onChange={(e) => setAdditionalCredits(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                  <div>
                    <Label>Additional Debits (-)</Label>
                    <div className="relative">
                      <MinusCircle className="absolute left-3 top-3 w-4 h-4 text-red-500" />
                      <Input
                        type="number"
                        value={additionalDebits}
                        onChange={(e) => setAdditionalDebits(parseFloat(e.target.value) || 0)}
                        className="pl-9"
                      />
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Right Column - Net Sheet Summary */}
          <div className="lg:col-span-1 space-y-4">
            {/* Net to Seller - Highlighted */}
            <Card className="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-500 sticky top-4">
              <CardContent className="p-6">
                <div className="text-center">
                  <div className="flex items-center justify-center gap-2 mb-2">
                    <Sparkles className="w-5 h-5 text-green-600" />
                    <p className="text-sm font-semibold text-slate-600">ESTIMATED NET TO SELLER</p>
                  </div>
                  <div className="text-5xl font-bold text-green-600 mb-4">
                    {formatCurrency(calculations.netToSeller)}
                  </div>
                  {calculations.netToSeller < 0 && (
                    <div className="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                      <div className="flex items-center gap-2 text-red-700">
                        <AlertCircle className="w-5 h-5" />
                        <p className="text-sm font-semibold">Seller will owe money at closing</p>
                      </div>
                    </div>
                  )}
                  <div className="bg-white rounded-lg p-4 space-y-2 text-left">
                    <div className="flex justify-between text-sm">
                      <span className="text-slate-600">Sale Price:</span>
                      <span className="font-semibold">{formatCurrency(salePrice)}</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-slate-600">Total Debits:</span>
                      <span className="font-semibold text-red-600">-{formatCurrency(calculations.totalDebits)}</span>
                    </div>
                    {additionalCredits > 0 && (
                      <div className="flex justify-between text-sm">
                        <span className="text-slate-600">Total Credits:</span>
                        <span className="font-semibold text-green-600">+{formatCurrency(additionalCredits)}</span>
                      </div>
                    )}
                    <div className="border-t pt-2 mt-2">
                      <div className="flex justify-between">
                        <span className="font-bold">Net Proceeds:</span>
                        <span className="font-bold text-green-600">{formatCurrency(calculations.netToSeller)}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Detailed Breakdown */}
            <Card>
              <CardHeader>
                <CardTitle className="text-base">Cost Breakdown</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="space-y-2">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">Commission</span>
                    <span className="font-semibold text-red-600">
                      -{formatCurrency(calculations.totalCommission)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">Closing Costs</span>
                    <span className="font-semibold text-red-600">
                      -{formatCurrency(calculations.totalClosingCosts)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">Loan Payoffs</span>
                    <span className="font-semibold text-red-600">
                      -{formatCurrency(calculations.totalPayoffs)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">Seller Concessions</span>
                    <span className="font-semibold text-red-600">
                      -{formatCurrency(sellerConcessions)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">Repairs & Costs</span>
                    <span className="font-semibold text-red-600">
                      -{formatCurrency(repairs + inspectionFees + stagingCosts)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-600">Prorations</span>
                    <span className="font-semibold text-red-600">
                      -{formatCurrency(propertyTaxProration + hoaProration)}
                    </span>
                  </div>
                  {additionalDebits > 0 && (
                    <div className="flex justify-between items-center">
                      <span className="text-sm text-slate-600">Other Debits</span>
                      <span className="font-semibold text-red-600">
                        -{formatCurrency(additionalDebits)}
                      </span>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>

            {/* Key Percentages */}
            <Card>
              <CardHeader>
                <CardTitle className="text-base">Key Metrics</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex justify-between items-center">
                  <span className="text-sm text-slate-600">Net % of Sale Price</span>
                  <Badge variant="outline" className="text-lg">
                    {((calculations.netToSeller / salePrice) * 100).toFixed(1)}%
                  </Badge>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-sm text-slate-600">Total Costs % of Sale</span>
                  <Badge variant="outline" className="text-lg">
                    {((calculations.totalDebits / salePrice) * 100).toFixed(1)}%
                  </Badge>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-sm text-slate-600">Equity After Payoff</span>
                  <Badge variant="outline" className="text-lg">
                    {formatCurrency(salePrice - calculations.totalPayoffs)}
                  </Badge>
                </div>
              </CardContent>
            </Card>

            {/* Action Buttons */}
            <Card>
              <CardContent className="p-4 space-y-3">
                <Button onClick={downloadNetSheet} className="w-full bg-green-600 hover:bg-green-700">
                  <Download className="w-4 h-4 mr-2" />
                  Download Net Sheet
                </Button>
                <Button onClick={shareNetSheet} variant="outline" className="w-full">
                  <Share2 className="w-4 h-4 mr-2" />
                  Share with Seller
                </Button>
              </CardContent>
            </Card>

            {/* Disclaimer */}
            <Card className="bg-amber-50 border-amber-200">
              <CardContent className="p-4">
                <div className="flex items-start gap-2">
                  <AlertCircle className="w-5 h-5 text-amber-600 mt-0.5" />
                  <div className="text-xs text-amber-800">
                    <p className="font-semibold mb-1">Estimate Only</p>
                    <p>This net sheet is an estimate. Actual costs may vary. Consult with your title company for final figures.</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Newspaper,
  TrendingUp,
  Search,
  Filter,
  Share2,
  Mail,
  Facebook,
  Linkedin,
  Twitter,
  BookmarkPlus,
  Clock,
  ArrowRight,
  Sparkles,
  ExternalLink,
  Eye,
  Heart,
  MessageSquare,
  Bell,
  Settings,
  BarChart3,
  Target,
  Lightbulb,
  Globe,
  DollarSign,
  Home,
  Briefcase,
  AlertCircle,
  RefreshCw,
  Send,
  Users,
  TrendingDown,
  ArrowLeft,
  MapPin,
  Scale,
  Instagram
} from "lucide-react";
import { toast } from "sonner";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { format } from "date-fns"; // Import format from date-fns
import NewsPreferencesModal from '../components/news/NewsPreferencesModal';

export default function News() {
  const navigate = useNavigate();
  const [currentUser, setCurrentUser] = useState(null);
  const [articles, setArticles] = useState([]);
  const [filteredArticles, setFilteredArticles] = useState([]);
  const [preferences, setPreferences] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [categoryFilter, setCategoryFilter] = useState("all");
  const [selectedArticle, setSelectedArticle] = useState(null);
  const [showArticleModal, setShowArticleModal] = useState(false);
  const [showShareModal, setShowShareModal] = useState(false);
  const [shareArticle, setShareArticle] = useState(null);
  const [isGeneratingNews, setIsGeneratingNews] = useState(false);
  const [readingTime, setReadingTime] = useState(0);
  const [lastRefreshTime, setLastRefreshTime] = useState(null); // Added state for last refresh time
  const [readArticleIds, setReadArticleIds] = useState(new Set());
  const [showPreferencesModal, setShowPreferencesModal] = useState(false);
  const [recommendedArticles, setRecommendedArticles] = useState([]);
  const [stats, setStats] = useState({
    totalViews: 0,
    totalShares: 0,
    knowledgeScore: 0,
    articlesRead: 0
  });

  useEffect(() => {
    loadData();
    checkAndAutoUpdate();
  }, []);

  const checkAndAutoUpdate = async () => {
    try {
      const lastAutoUpdate = localStorage.getItem('news_last_auto_update');
      const now = new Date();
      const targetHour = 3;
      const targetMinute = 31;
      
      // Create today's target time (3:31 AM)
      const todayTarget = new Date();
      todayTarget.setHours(targetHour, targetMinute, 0, 0);
      
      // If last update was before today's 3:31 AM and current time is after 3:31 AM
      if (!lastAutoUpdate || new Date(lastAutoUpdate) < todayTarget) {
        // Check if current time is past 3:31 AM today
        if (now >= todayTarget) {
          const user = await base44.auth.me();
          if (user) {
            await generateNewsArticles(user);
            localStorage.setItem('news_last_auto_update', now.toISOString());
          }
        }
      }
    } catch (error) {
      console.error('Auto-update check failed:', error);
    }
  };

  useEffect(() => {
    filterArticles();
  }, [articles, searchTerm, categoryFilter]);

  const loadData = async () => {
    try {
      const user = await base44.auth.me();
      setCurrentUser(user);

      const prefs = await base44.entities.NewsPreference.filter({ user_id: user.id });
      if (prefs.length > 0) {
        setPreferences(prefs[0]);
      } else {
        const defaultPrefs = await base44.entities.NewsPreference.create({
          user_id: user.id,
          preferred_categories: JSON.stringify(["market_trends", "interest_rates", "technology"]),
          notification_frequency: "daily_digest",
          email_notifications: true
        });
        setPreferences(defaultPrefs);
      }

      const articlesData = await base44.entities.NewsArticle.list("-publish_date", 50);

      if (articlesData.length === 0) {
        await generateNewsArticles(user);
      } else {
        setArticles(articlesData);
        // Set last refresh time to the most recent article's publish date
        if (articlesData.length > 0) {
          setLastRefreshTime(new Date(articlesData[0].publish_date || articlesData[0].created_date));
        }
      }

      const engagements = await base44.entities.NewsEngagement.filter({ user_id: user.id });
      const totalViews = engagements.filter(e => e.action_type === 'view').length;
      const totalShares = engagements.filter(e => e.action_type === 'share').length;
      
      // Track which articles have been viewed/read
      const viewedArticleIds = new Set(engagements.filter(e => e.action_type === 'view').map(e => e.article_id));
      setReadArticleIds(viewedArticleIds);

      // Calculate knowledge score: 2% per article read, capped at 100%
      const knowledgeScore = Math.min(100, viewedArticleIds.size * 2);

      setStats({
        totalViews,
        totalShares,
        knowledgeScore,
        articlesRead: viewedArticleIds.size
      });

    } catch (error) {
      console.error("Error loading news data:", error);
      toast.error("Failed to load news");
    } finally {
      setIsLoading(false);
    }
  };

  const generateNewsArticles = async (user) => {
    setIsGeneratingNews(true);
    try {
      const loadingToast = toast.loading("Generating news articles...");

      // Extract user's local market from office address
      let userCity = "United States";
      let userState = "";
      let fullLocation = "United States";
      
      if (user.office_address) {
        const addressParts = user.office_address.split(',').map(part => part.trim());
        
        // Try to extract city and state
        if (addressParts.length >= 3) {
          userCity = addressParts[addressParts.length - 3]; // City
          userState = addressParts[addressParts.length - 2]; // State
          fullLocation = `${userCity}, ${userState}`;
        } else if (addressParts.length >= 2) {
          userCity = addressParts[addressParts.length - 2];
          fullLocation = userCity;
        }
      }

      // Create in smaller batches with simpler structure
      const batches = [
        { sources: ["CNN Business", "Fox Business", "CNBC"], count: 3 },
        { sources: ["Bloomberg", "Wall Street Journal", "Reuters"], count: 3 },
        { sources: ["NAR", "Realtor.com", "Zillow Research"], count: 3 },
        { sources: [`${fullLocation} Real Estate News`, "Local Market Report", "Regional Housing Updates"], count: 3, isLocal: true, location: fullLocation }
      ];

      const createdArticles = [];
      const baseDate = new Date();

      for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
        const batch = batches[batchIndex];

        try {
          const result = await base44.integrations.Core.InvokeLLM({
            prompt: batch.isLocal 
              ? `You MUST search Google for REAL recent real estate news from ${userCity}, ${userState} area ONLY.

STRICT REQUIREMENT: Every article MUST be about ${userCity} or cities within 50 miles of ${userCity}, ${userState}. 
DO NOT include any national news or news from other states/cities.

Search query examples:
- "${userCity} real estate market"
- "${userCity} home sales"
- "${userState} ${userCity} housing"
- "${userCity} metro area real estate"

Return ${batch.count} articles that:
- title: MUST contain "${userCity}" OR a nearby city name (within 50 miles)
- content: 2-3 paragraphs with specific ${userCity} area data and neighborhood names
- summary: Brief overview mentioning ${userCity} or nearby areas
- source: Local news source from ${userState}
- category: local_market
- score: 60-90
- location: ${userCity}, ${userState}

REJECT any article that doesn't specifically mention ${userCity} or the immediate surrounding metro area.`
              : `Generate ${batch.count} brief real estate news articles from these sources: ${batch.sources.join(', ')}.

Topics: mortgage rates, housing market, home prices, inventory levels, buyer/seller trends.

Each article needs:
- title: Short headline
- content: 2-3 paragraphs (200 words)
- summary: 1-2 sentences
- source: Pick from ${batch.sources.join(', ')}
- category: market_trends, interest_rates, or financing
- score: number 60-90

Keep it simple and realistic.`,
            add_context_from_internet: true,
            response_json_schema: {
              type: "object",
              properties: {
                articles: {
                  type: "array",
                  items: {
                    type: "object",
                    properties: {
                      title: { type: "string" },
                      content: { type: "string" },
                      summary: { type: "string" },
                      source: { type: "string" },
                      category: { type: "string" },
                      score: { type: "number" },
                      location: { type: "string" }
                    },
                    required: ["title", "content", "source", "category", "score"]
                  }
                }
              },
              required: ["articles"]
            }
          });

          if (result?.articles) {
            for (let i = 0; i < result.articles.length; i++) {
              const article = result.articles[i];
              const publishDate = new Date(baseDate);
              publishDate.setHours(publishDate.getHours() - ((batchIndex * batch.count + i) * 6));

              const newArticle = await base44.entities.NewsArticle.create({
                title: article.title,
                content: article.content,
                summary: article.summary || article.content.substring(0, Math.min(article.content.length, 150)) + "...",
                source: article.source,
                source_url: `https://${article.source.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '')}.com`,
                category: article.category || "market_trends",
                geographic_focus: article.location || (batch.isLocal ? batch.location : "National"),
                market_impact: article.score >= 80 ? "high" : article.score >= 65 ? "medium" : "low",
                relevance_score: article.score || 70,
                target_audience: JSON.stringify(["all_agents"]),
                key_takeaways: JSON.stringify([
                  "Market conditions evolving",
                  "Stay informed on trends",
                  "Consult with professionals"
                ]),
                client_talking_points: JSON.stringify([
                  `According to ${article.source}: ${article.title}`,
                  "This could impact your real estate decisions",
                  "Let's discuss your situation"
                ]),
                social_media_content: JSON.stringify({
                  facebook: `${article.title} - ${article.source}`,
                  linkedin: `Real estate update: ${article.title}`,
                  instagram: `üì∞ ${article.title} #RealEstate`
                }),
                email_template: `Hi [Client],\n\n${article.title}\n\n${article.summary}\n\nLet's discuss.\n\nBest,\n[Your Name]`,
                tags: article.category,
                is_featured: article.score >= 85,
                is_trending: article.score >= 75,
                publish_date: publishDate.toISOString(),
                view_count: 0,
                share_count: 0
              });
              createdArticles.push(newArticle);
            }
          }

          // Delay between batches to avoid rate limiting or large single requests
          if (batchIndex < batches.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1500)); // 1.5 seconds delay
          }

        } catch (batchError) {
          console.error(`Batch ${batchIndex + 1} error:`, batchError);
        }
      }

      if (createdArticles.length === 0) {
        // Fallback articles if LLM generation fails for all batches
        const fallback = [
          {
            title: "Housing Market Shows Stability",
            content: "The housing market is showing signs of stabilization. Prices have moderated while inventory increases. This creates opportunities for buyers and sellers.\n\nExperts suggest the market is finding balance after recent volatility.",
            source: "CNN Business",
            category: "market_trends",
            score: 75
          },
          {
            title: "Mortgage Rates Shift Lower",
            content: "Mortgage rates have declined slightly this month. The average 30-year fixed rate now sits at 6.8%. This could encourage more buyers to enter the market.\n\nLenders expect rates to stabilize in coming months.",
            source: "Fox Business",
            category: "interest_rates",
            score: 80
          },
          {
            title: "First-Time Buyers Return",
            content: "First-time homebuyers are returning to the market. New assistance programs and improved affordability are driving activity. Many buyers are taking advantage of current conditions.\n\nAgents report increased interest from younger demographics.",
            source: "NAR",
            category: "market_trends",
            score: 70
          }
        ];

        for (const article of fallback) {
          const newArticle = await base44.entities.NewsArticle.create({
            title: article.title,
            content: article.content,
            summary: article.content.substring(0, Math.min(article.content.length, 100)) + "...",
            source: article.source,
            source_url: `https://${article.source.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '')}.com`,
            category: article.category,
            market_impact: "medium",
            relevance_score: article.score,
            target_audience: JSON.stringify(["all_agents"]),
            key_takeaways: JSON.stringify(["Market update", "Industry trends", "Professional insights"]),
            client_talking_points: JSON.stringify([article.title, "Let's discuss", "Contact me"]),
            social_media_content: JSON.stringify({
              facebook: article.title,
              linkedin: article.title,
              instagram: article.title
            }),
            email_template: `Hi,\n\n${article.title}\n\nBest regards`,
            tags: article.category,
            is_featured: article.score >= 80,
            is_trending: article.score >= 75,
            publish_date: new Date().toISOString(),
            view_count: 0,
            share_count: 0
          });
          createdArticles.push(newArticle);
        }
      }

      setArticles(createdArticles);
      setFilteredArticles(createdArticles);
      setLastRefreshTime(new Date());
      toast.dismiss(loadingToast);
      toast.success(`${createdArticles.length} articles loaded!`);

    } catch (error) {
      console.error("Error generating news:", error);
      toast.dismiss();
      toast.error("Failed to generate articles");
    } finally {
      setIsGeneratingNews(false);
    }
  };

  const filterArticles = () => {
    let filtered = [...articles];

    // Apply user preferences
    if (preferences) {
      try {
        const blockedSources = JSON.parse(preferences.blocked_sources || '[]');
        const blockedKeywords = JSON.parse(preferences.blocked_keywords || '[]');
        const preferredCategories = JSON.parse(preferences.preferred_categories || '[]');
        const preferredSources = JSON.parse(preferences.preferred_sources || '[]');

        // Filter out blocked sources
        if (blockedSources.length > 0) {
          filtered = filtered.filter(article => !blockedSources.includes(article.source));
        }

        // Filter out articles with blocked keywords
        if (blockedKeywords.length > 0) {
          filtered = filtered.filter(article => {
            const textToCheck = `${article.title} ${article.content} ${article.tags}`.toLowerCase();
            return !blockedKeywords.some(keyword => textToCheck.includes(keyword));
          });
        }

        // Boost preferred categories and sources
        if (preferences.ai_recommendations_enabled) {
          filtered = filtered.map(article => {
            let boost = 0;
            if (preferredCategories.includes(article.category)) boost += 10;
            if (preferredSources.includes(article.source)) boost += 5;
            return { ...article, ai_boost: boost };
          });
        }
      } catch (e) {
        console.error('Error applying preferences:', e);
      }
    }

    if (searchTerm) {
      filtered = filtered.filter(article =>
        article.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        article.content?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        article.tags?.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    if (categoryFilter !== "all") {
      filtered = filtered.filter(article => article.category === categoryFilter);
    }

    filtered.sort((a, b) => {
      const dateA = new Date(a.publish_date || a.created_date);
      const dateB = new Date(b.publish_date || b.created_date);

      if (dateB - dateA !== 0) {
        return dateB - dateA;
      }

      if (a.is_featured && !b.is_featured) return -1;
      if (!a.is_featured && b.is_featured) return 1;

      if (a.is_trending && !b.is_trending) return -1;
      if (!a.is_trending && b.is_trending) return 1;

      // Apply AI boost if enabled
      const scoreA = (a.relevance_score || 0) + (a.ai_boost || 0);
      const scoreB = (b.relevance_score || 0) + (b.ai_boost || 0);
      return scoreB - scoreA;
    });

    setFilteredArticles(filtered);
  };

  const handleArticleClick = async (article) => {
    setSelectedArticle(article);
    setShowArticleModal(true);
    setReadingTime(0);

    try {
      await base44.entities.NewsEngagement.create({
        user_id: currentUser.id,
        article_id: article.id,
        action_type: "view"
      });

      await base44.entities.NewsArticle.update(article.id, {
        view_count: (article.view_count || 0) + 1
      });

      const updatedArticles = await base44.entities.NewsArticle.list("-publish_date", 50);
      setArticles(updatedArticles);
      
      // Update read articles set and stats
      setReadArticleIds(prev => {
        const newSet = new Set([...prev, article.id]);
        // Calculate knowledge score: 2% per article read, capped at 100%
        const knowledgeScore = Math.min(100, newSet.size * 2);
        setStats(prevStats => ({ 
          ...prevStats, 
          articlesRead: newSet.size,
          knowledgeScore
        }));
        return newSet;
      });

      // Update personalization score based on interactions
      if (preferences?.ai_recommendations_enabled) {
        await updatePersonalizationScore(article);
      }

    } catch (error) {
      console.error("Error tracking view:", error);
    }

    const startTime = Date.now();
    const timer = setInterval(() => {
      setReadingTime(Math.floor((Date.now() - startTime) / 1000));
    }, 1000);

    setTimeout(() => clearInterval(timer), 300000);
  };

  const handleShareArticle = (article) => {
    setShareArticle(article);
    setShowShareModal(true);
  };

  const shareToSocial = async (platform) => {
    if (!shareArticle) return;

    try {
      let socialContent = {};
      try {
        socialContent = JSON.parse(shareArticle.social_media_content || '{}');
      } catch (e) {
        socialContent = {};
      }

      const postText = socialContent[platform] || shareArticle.summary;

      await base44.entities.NewsEngagement.create({
        user_id: currentUser.id,
        article_id: shareArticle.id,
        action_type: "share",
        shared_to: platform
      });

      await base44.entities.NewsArticle.update(shareArticle.id, {
        share_count: (shareArticle.share_count || 0) + 1
      });

      navigator.clipboard.writeText(postText);
      toast.success(`${platform} post copied to clipboard!`);

      setShowShareModal(false);

    } catch (error) {
      console.error("Error sharing article:", error);
      toast.error("Failed to share article");
    }
  };

  const sendToClients = async () => {
    if (!shareArticle) return;

    try {
      navigate(createPageUrl(`AIEmailAssistant?article=${shareArticle.id}`));
      setShowShareModal(false);
    } catch (error) {
      console.error("Error:", error);
      toast.error("Failed to open email assistant");
    }
  };

  const getCategoryIcon = (category) => {
    const icons = {
      market_trends: TrendingUp,
      interest_rates: DollarSign,
      housing_policy: Briefcase,
      technology: Sparkles,
      local_market: MapPin,
      financing: DollarSign,
      legal: Scale,
      business_tips: Lightbulb,
      client_stories: Users
    };
    return icons[category] || Newspaper;
  };

  const getCategoryColor = (category) => {
    const colors = {
      market_trends: "bg-blue-100 text-blue-700",
      interest_rates: "bg-green-100 text-green-700",
      housing_policy: "bg-purple-100 text-purple-700",
      technology: "bg-pink-100 text-pink-700",
      local_market: "bg-orange-100 text-orange-700",
      financing: "bg-emerald-100 text-emerald-700",
      legal: "bg-slate-100 text-slate-700",
      business_tips: "bg-amber-100 text-amber-700",
      client_stories: "bg-indigo-100 text-indigo-700"
    };
    return colors[category] || "bg-slate-100 text-slate-700";
  };

  const calculateTrendScore = (article) => {
    // Calculate trend score based on multiple factors (0-100)
    const relevanceWeight = 0.4;
    const viewWeight = 0.3;
    const shareWeight = 0.3;
    
    const relevanceScore = article.relevance_score || 0;
    const viewScore = Math.min(100, (article.view_count || 0) * 5); // 20 views = 100
    const shareScore = Math.min(100, (article.share_count || 0) * 10); // 10 shares = 100
    
    const trendScore = Math.round(
      (relevanceScore * relevanceWeight) + 
      (viewScore * viewWeight) + 
      (shareScore * shareWeight)
    );
    
    return trendScore;
  };

  const getTrendScoreColor = (score) => {
    if (score >= 80) return "text-green-600 bg-green-50 border-green-200";
    if (score >= 60) return "text-blue-600 bg-blue-50 border-blue-200";
    if (score >= 40) return "text-amber-600 bg-amber-50 border-amber-200";
    return "text-slate-600 bg-slate-50 border-slate-200";
  };

  const getTrendScoreLabel = (score) => {
    if (score >= 80) return "üî• Hot";
    if (score >= 60) return "üìà Rising";
    if (score >= 40) return "üìä Steady";
    return "üí§ Cool";
  };

  const updatePersonalizationScore = async (article) => {
    if (!preferences?.id) return;
    
    try {
      const engagements = await base44.entities.NewsEngagement.filter({ user_id: currentUser.id });
      
      // Calculate score based on various factors
      let score = preferences.personalization_score || 0;
      
      // Increment based on interactions (max 100)
      if (engagements.length < 20) {
        score = Math.min(100, score + 2); // Fast growth initially
      } else {
        score = Math.min(100, score + 0.5); // Slower growth as user matures
      }
      
      await base44.entities.NewsPreference.update(preferences.id, {
        personalization_score: score
      });
    } catch (error) {
      console.error('Error updating personalization score:', error);
    }
  };

  const generateAIRecommendations = async () => {
    if (!preferences?.ai_recommendations_enabled || !currentUser) return;

    try {
      const engagements = await base44.entities.NewsEngagement.filter({ user_id: currentUser.id });
      
      // Analyze user behavior
      const viewedArticles = engagements
        .filter(e => e.action_type === 'view')
        .map(e => articles.find(a => a.id === e.article_id))
        .filter(Boolean);

      const sharedArticles = engagements
        .filter(e => e.action_type === 'share')
        .map(e => articles.find(a => a.id === e.article_id))
        .filter(Boolean);

      // Categories and sources the user engages with most
      const categoryFreq = {};
      const sourceFreq = {};
      
      viewedArticles.forEach(article => {
        categoryFreq[article.category] = (categoryFreq[article.category] || 0) + 1;
        sourceFreq[article.source] = (sourceFreq[article.source] || 0) + 1;
      });

      sharedArticles.forEach(article => {
        categoryFreq[article.category] = (categoryFreq[article.category] || 0) + 2; // Weight shares more
        sourceFreq[article.source] = (sourceFreq[article.source] || 0) + 2;
      });

      // Find unread articles matching user interests
      const unreadArticles = articles.filter(a => !readArticleIds.has(a.id));
      
      const scored = unreadArticles.map(article => ({
        ...article,
        aiScore: (categoryFreq[article.category] || 0) + (sourceFreq[article.source] || 0)
      }));

      const recommended = scored
        .sort((a, b) => b.aiScore - a.aiScore)
        .slice(0, 5);

      setRecommendedArticles(recommended);
    } catch (error) {
      console.error('Error generating recommendations:', error);
    }
  };

  useEffect(() => {
    if (articles.length > 0 && preferences?.ai_recommendations_enabled) {
      generateAIRecommendations();
    }
  }, [articles, readArticleIds, preferences]);

  if (isLoading) {
    return (
      <div className="page-container">
        <div className="flex items-center justify-center h-64">
          <RefreshCw className="w-8 h-8 animate-spin text-indigo-600" />
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center gap-4">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => navigate(-1)}
                className="rounded-full"
              >
                <ArrowLeft className="w-5 h-5" />
              </Button>
              <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center">
                <Newspaper className="w-7 h-7 text-white" />
              </div>
              <div className="flex-1">
                <h1 className="text-3xl font-bold">News & Market Intelligence</h1>
                <p className="text-slate-600 dark:text-slate-400">
                  Stay ahead with AI-curated real estate news ‚Ä¢ {articles.length} articles available
                </p>
                {lastRefreshTime && (
                  <p className="text-xs text-slate-500 dark:text-slate-500 mt-1">
                    Last updated: {format(lastRefreshTime, 'MMM d, yyyy h:mm a')}
                  </p>
                )}
              </div>
              <div className="flex gap-2">
                <Button
                  onClick={() => setShowPreferencesModal(true)}
                  variant="outline"
                  size="lg"
                >
                  <Settings className="w-5 h-5 mr-2" />
                  Personalize
                </Button>
                <Button
                  onClick={() => generateNewsArticles(currentUser)}
                  disabled={isGeneratingNews}
                  className="bg-indigo-600 hover:bg-indigo-700"
                  size="lg"
                >
                  {isGeneratingNews ? (
                    <>
                      <RefreshCw className="w-5 h-5 mr-2 animate-spin" />
                      Loading Latest...
                    </>
                  ) : (
                    <>
                      <RefreshCw className="w-5 h-5 mr-2" />
                      Refresh Latest News
                    </>
                  )}
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600 mb-1">Articles Read</p>
                  <p className="text-3xl font-bold text-indigo-600">{stats.articlesRead}</p>
                </div>
                <Eye className="w-10 h-10 text-indigo-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600 mb-1">Times Shared</p>
                  <p className="text-3xl font-bold text-purple-600">{stats.totalShares}</p>
                </div>
                <Share2 className="w-10 h-10 text-purple-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600 mb-1">Knowledge Score</p>
                  <p className="text-3xl font-bold text-green-600">{stats.knowledgeScore}%</p>
                </div>
                <Target className="w-10 h-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600 mb-1">Total Articles</p>
                  <p className="text-3xl font-bold text-orange-600">{articles.length}</p>
                </div>
                <Newspaper className="w-10 h-10 text-orange-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        <Card>
          <CardContent className="p-4">
            <div className="flex flex-col md:flex-row gap-4">
              <div className="flex-1"> {/* Wrapped input in a div to maintain flex layout */}
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                  <Input
                    placeholder="Search articles..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10"
                  />
                </div>
              </div>
              <Select value={categoryFilter} onValueChange={setCategoryFilter}>
                <SelectTrigger className="w-full md:w-60">
                  <SelectValue placeholder="Filter by category" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Categories</SelectItem>
                  <SelectItem value="market_trends">Market Trends</SelectItem>
                  <SelectItem value="interest_rates">Interest Rates</SelectItem>
                  <SelectItem value="housing_policy">Housing Policy</SelectItem>
                  <SelectItem value="technology">Technology</SelectItem>
                  <SelectItem value="local_market">Local Market</SelectItem>
                  <SelectItem value="financing">Financing</SelectItem>
                  <SelectItem value="legal">Legal</SelectItem>
                  <SelectItem value="business_tips">Business Tips</SelectItem>
                  <SelectItem value="client_stories">Client Stories</SelectItem>
                </SelectContent>
              </Select>
              <Button
                onClick={() => generateNewsArticles(currentUser)}
                disabled={isGeneratingNews}
                variant="outline"
                className="whitespace-nowrap" // Prevents the text from wrapping
              >
                {isGeneratingNews ? (
                  <>
                    <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                    Updating...
                  </>
                ) : (
                  <>
                    <RefreshCw className="w-4 h-4 mr-2" />
                    Get Latest
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>

        {recommendedArticles.length > 0 && preferences?.ai_recommendations_enabled && (
          <Card className="bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 border-purple-200">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Sparkles className="w-5 h-5 text-purple-600" />
                AI Recommended For You
              </CardTitle>
              <p className="text-sm text-slate-600">Based on your reading habits and preferences</p>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {recommendedArticles.slice(0, 3).map((article) => {
                  const CategoryIcon = getCategoryIcon(article.category);
                  return (
                    <div
                      key={article.id}
                      className="bg-white dark:bg-slate-800 p-4 rounded-lg hover:shadow-md transition-shadow cursor-pointer"
                      onClick={() => handleArticleClick(article)}
                    >
                      <div className="flex items-start gap-3">
                        <div className={`w-10 h-10 rounded-lg ${getCategoryColor(article.category)} flex items-center justify-center flex-shrink-0`}>
                          <CategoryIcon className="w-5 h-5" />
                        </div>
                        <div className="flex-1 min-w-0">
                          <h4 className="font-semibold line-clamp-2 mb-1">{article.title}</h4>
                          <p className="text-xs text-slate-500 flex items-center gap-2">
                            <span>{article.source}</span>
                            <span>‚Ä¢</span>
                            <span>{format(new Date(article.publish_date || article.created_date), 'MMM d')}</span>
                          </p>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </CardContent>
          </Card>
        )}

        {filteredArticles.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {filteredArticles.map((article) => {
              const CategoryIcon = getCategoryIcon(article.category);
              const isRead = readArticleIds.has(article.id);

              return (
                <Card key={article.id} className={`hover:shadow-lg transition-shadow cursor-pointer ${isRead ? 'bg-slate-50 dark:bg-slate-800/50' : ''}`}>
                  <CardContent className="p-6">
                    <div className="space-y-4">
                      <div className="flex items-start justify-between gap-2">
                        <div className="flex gap-1 flex-wrap">
                          <Badge className={getCategoryColor(article.category)}>
                            <CategoryIcon className="w-3 h-3 mr-1" />
                            {article.category?.replace('_', ' ')}
                          </Badge>
                          {article.category === 'local_market' && (
                            <Badge className="bg-orange-500 text-white">
                              <MapPin className="w-3 h-3 mr-1" />
                              Local News
                            </Badge>
                          )}
                          {isRead && (
                            <Badge className="bg-green-100 text-green-700 border-green-200">
                              <Eye className="w-3 h-3 mr-1" />
                              Read
                            </Badge>
                          )}
                        </div>
                        <div className="flex gap-1">
                          {article.is_trending && (
                            <Badge variant="outline" className="bg-orange-50 text-orange-700 border-orange-300">
                              <TrendingUp className="w-3 h-3 mr-1" />
                              Trending
                            </Badge>
                          )}
                          {article.is_featured && (
                            <Badge variant="outline" className="bg-purple-50 text-purple-700 border-purple-300">
                              Featured
                            </Badge>
                          )}
                        </div>
                      </div>

                      <h3
                        className="font-bold text-lg line-clamp-2 hover:text-indigo-600 transition-colors"
                        onClick={() => handleArticleClick(article)}
                      >
                        {article.title}
                      </h3>

                      <p className="text-sm text-slate-600 line-clamp-3">
                        {article.summary}
                      </p>

                      <div className="flex items-center gap-2 text-xs text-slate-500">
                        <Clock className="w-3 h-3" />
                        <span>{format(new Date(article.publish_date || article.created_date), 'MMM d, yyyy')}</span>
                      </div>

                      <div className="flex items-center justify-between text-xs text-slate-500">
                        <div className="flex items-center gap-3">
                          <div className="flex items-center gap-1">
                            <Eye className="w-3 h-3" />
                            <span>{article.view_count || 0}</span>
                          </div>
                          <div className="flex items-center gap-1">
                            <Share2 className="w-3 h-3" />
                            <span>{article.share_count || 0}</span>
                          </div>
                        </div>
                        <Badge variant="outline" className={`text-xs font-semibold ${getTrendScoreColor(calculateTrendScore(article))}`}>
                          {getTrendScoreLabel(calculateTrendScore(article))} {calculateTrendScore(article)}
                        </Badge>
                      </div>

                      <div className="flex gap-3 pt-2 border-t">
                        <Button
                          size="sm"
                          onClick={() => handleArticleClick(article)}
                          className="flex-1"
                        >
                          Read More
                        </Button>
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => handleShareArticle(article)}
                        >
                          <Share2 className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              );
            })}
          </div>
        ) : (
          <Card>
            <CardContent className="p-12 text-center">
              <Newspaper className="w-16 h-16 mx-auto mb-4 text-slate-300" />
              <h3 className="text-lg font-semibold mb-2">No articles found</h3>
              <p className="text-slate-600 mb-4">
                {searchTerm || categoryFilter !== "all"
                  ? "Try adjusting your filters"
                  : "Click 'Refresh News' to load articles"}
              </p>
              <Button onClick={() => generateNewsArticles(currentUser)} disabled={isGeneratingNews}>
                {isGeneratingNews ? (
                  <>
                    <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                    Loading...
                  </>
                ) : (
                  <>
                    <RefreshCw className="w-4 h-4 mr-2" />
                    Load News Articles
                  </>
                )}
              </Button>
            </CardContent>
          </Card>
        )}

        {selectedArticle && (
          <Dialog open={showArticleModal} onOpenChange={setShowArticleModal}>
            <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
              <DialogHeader>
                <DialogTitle className="text-2xl pr-8">{selectedArticle.title}</DialogTitle>
              </DialogHeader>

              <div className="space-y-6">
                <div className="flex items-center gap-4 flex-wrap">
                  <Badge className={getCategoryColor(selectedArticle.category)}>
                    {selectedArticle.category?.replace('_', ' ')}
                  </Badge>
                  {selectedArticle.market_impact && (
                    <Badge variant="outline">
                      <AlertCircle className="w-3 h-3 mr-1" />
                      {selectedArticle.market_impact} market impact
                    </Badge>
                  )}
                  {selectedArticle.source && (
                    <div className="flex items-center gap-1 text-sm text-slate-600">
                      <Globe className="w-4 h-4" />
                      {selectedArticle.source}
                    </div>
                  )}
                  <div className="flex items-center gap-1 text-sm text-slate-600">
                    <Clock className="w-4 h-4" />
                    Reading: {readingTime}s
                  </div>
                </div>

                <div className="bg-indigo-50 p-4 rounded-lg">
                  <p className="text-sm font-medium text-indigo-900">{selectedArticle.summary}</p>
                </div>

                <div className="prose prose-slate max-w-none">
                  {selectedArticle.content.split('\n\n').map((paragraph, index) => (
                    <p key={index}>{paragraph}</p>
                  ))}
                </div>

                {selectedArticle.key_takeaways && (
                  <div className="bg-green-50 p-4 rounded-lg">
                    <h4 className="font-semibold text-green-900 mb-3 flex items-center gap-2">
                      <Lightbulb className="w-5 h-5" />
                      Key Takeaways
                    </h4>
                    <ul className="space-y-2">
                      {JSON.parse(selectedArticle.key_takeaways).map((takeaway, idx) => (
                        <li key={idx} className="text-sm text-green-800 flex gap-2">
                          <span className="font-bold">‚Ä¢</span>
                          <span>{takeaway}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                {selectedArticle.client_talking_points && (
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <h4 className="font-semibold text-purple-900 mb-3 flex items-center gap-2">
                      <MessageSquare className="w-5 h-5" />
                      Client Talking Points
                    </h4>
                    <ul className="space-y-2">
                      {JSON.parse(selectedArticle.client_talking_points).map((point, idx) => (
                        <li key={idx} className="text-sm text-purple-800 flex gap-2">
                          <span className="font-bold">‚Ä¢</span>
                          <span>{point}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                <div className="flex gap-3 pt-4 border-t">
                  <Button
                    onClick={() => handleShareArticle(selectedArticle)}
                    className="flex-1 bg-indigo-600 hover:bg-indigo-700"
                  >
                    <Share2 className="w-4 h-4 mr-2" />
                    Share with Clients
                  </Button>
                  {selectedArticle.source_url && (
                    <Button
                      onClick={() => window.open(selectedArticle.source_url, '_blank')}
                      variant="outline"
                    >
                      <ExternalLink className="w-4 h-4 mr-2" />
                      Source
                    </Button>
                  )}
                </div>
              </div>
            </DialogContent>
          </Dialog>
        )}

        {shareArticle && (
          <Dialog open={showShareModal} onOpenChange={setShowShareModal}>
            <DialogContent>
              <DialogHeader>
                <DialogTitle>Share Article</DialogTitle>
              </DialogHeader>

              <div className="space-y-4">
                <p className="text-sm text-slate-600">
                  Share "{shareArticle.title}" with your network or clients
                </p>

                <div className="grid grid-cols-2 gap-3">
                  <Button
                    onClick={() => shareToSocial('facebook')}
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    <Facebook className="w-4 h-4 mr-2" />
                    Facebook
                  </Button>
                  <Button
                    onClick={() => shareToSocial('linkedin')}
                    className="bg-blue-700 hover:bg-blue-800"
                  >
                    <Linkedin className="w-4 h-4 mr-2" />
                    LinkedIn
                  </Button>
                  <Button
                    onClick={() => shareToSocial('instagram')}
                    className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700"
                  >
                    <Instagram className="w-4 h-4 mr-2" />
                    Instagram
                  </Button>
                  <Button
                    onClick={() => shareToSocial('twitter')}
                    className="bg-sky-500 hover:bg-sky-600"
                  >
                    <Twitter className="w-4 h-4 mr-2" />
                    Twitter
                  </Button>
                </div>

                <div className="pt-4 border-t">
                  <Button
                    onClick={sendToClients}
                    className="w-full bg-green-600 hover:bg-green-700"
                  >
                    <Mail className="w-4 h-4 mr-2" />
                    Email to Clients
                  </Button>
                </div>
              </div>
            </DialogContent>
          </Dialog>
        )}

        <NewsPreferencesModal
          open={showPreferencesModal}
          onClose={() => setShowPreferencesModal(false)}
          preferences={preferences}
          userId={currentUser?.id}
          onSave={loadData}
        />
      </div>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import {
  ArrowLeft,
  Mail,
  Send,
  Clock,
  Users,
  Eye,
  MousePointer,
  Plus,
  Trash2,
  Edit,
  Save,
  Calendar,
  Sparkles,
  RefreshCw,
  Search,
  CheckCircle2,
  AlertCircle,
  TrendingUp
} from "lucide-react";
import { toast } from "sonner";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";

export default function NewsletterBuilder() {
  const navigate = useNavigate();
  const [currentUser, setCurrentUser] = useState(null);
  const [newsletters, setNewsletters] = useState([]);
  const [articles, setArticles] = useState([]);
  const [contacts, setContacts] = useState([]);
  const [buyers, setBuyers] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [editingNewsletter, setEditingNewsletter] = useState(null);
  const [selectedArticles, setSelectedArticles] = useState([]);
  const [searchTerm, setSearchTerm] = useState("");
  const [recipientType, setRecipientType] = useState("all_clients");
  const [customRecipients, setCustomRecipients] = useState([]);
  const [isGenerating, setIsGenerating] = useState(false);

  const [newsletterData, setNewsletterData] = useState({
    title: "",
    content: "",
    subject: "",
    preview_text: "",
    scheduled_send_date: ""
  });

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const user = await base44.auth.me();
      setCurrentUser(user);

      const [newslettersData, articlesData, contactsData, buyersData] = await Promise.all([
        base44.entities.ClientNewsletter.filter({ agent_id: user.id }, "-created_date"),
        base44.entities.NewsArticle.list("-publish_date", 50),
        base44.entities.Contact.list(),
        base44.entities.Buyer.list()
      ]);

      setNewsletters(newslettersData || []);
      setArticles(articlesData || []);
      setContacts(contactsData || []);
      setBuyers(buyersData || []);
    } catch (error) {
      console.error("Error loading data:", error);
      toast.error("Failed to load data");
    } finally {
      setIsLoading(false);
    }
  };

  const handleCreateNewsletter = () => {
    setEditingNewsletter(null);
    setSelectedArticles([]);
    setNewsletterData({
      title: "",
      content: "",
      subject: "",
      preview_text: "",
      scheduled_send_date: ""
    });
    setRecipientType("all_clients");
    setCustomRecipients([]);
    setShowCreateModal(true);
  };

  const handleEditNewsletter = (newsletter) => {
    setEditingNewsletter(newsletter);
    setNewsletterData({
      title: newsletter.title,
      content: newsletter.content,
      subject: newsletter.subject || newsletter.title,
      preview_text: newsletter.preview_text || "",
      scheduled_send_date: newsletter.scheduled_send_date || ""
    });
    setRecipientType(newsletter.recipient_type);
    setSelectedArticles(newsletter.article_ids ? newsletter.article_ids.split(',') : []);
    setCustomRecipients(newsletter.custom_recipient_ids ? newsletter.custom_recipient_ids.split(',') : []);
    setShowCreateModal(true);
  };

  const generateNewsletterContent = async () => {
    if (selectedArticles.length === 0) {
      toast.error("Please select at least one article");
      return;
    }

    setIsGenerating(true);
    try {
      const selectedArticleObjects = articles.filter(a => selectedArticles.includes(a.id));
      
      const articlesText = selectedArticleObjects.map(a => `
Title: ${a.title}
Summary: ${a.summary}
Key Takeaways: ${a.key_takeaways || '[]'}
Category: ${a.category}
      `).join('\n---\n');

      const prompt = `Create a professional, engaging real estate newsletter for clients based on these news articles:

${articlesText}

Generate:
1. Catchy subject line (max 60 characters)
2. Preview text for email (max 100 characters)
3. Full HTML newsletter content with:
   - Warm, professional greeting
   - Brief intro about staying informed
   - Sections for each article with:
     * Eye-catching headline
     * 2-3 sentence summary
     * "What this means for you" client perspective
     * Call-to-action
   - Personal closing from the agent
   - Contact information section
   - Professional signature

Style: Professional, friendly, informative, client-focused
Tone: Helpful advisor, not salesy
Format: Clean HTML with proper headings, paragraphs, and styling

Return as JSON:
{
  "subject": "email subject line",
  "preview_text": "preview text",
  "html_content": "full HTML newsletter"
}`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        response_json_schema: {
          type: "object",
          properties: {
            subject: { type: "string" },
            preview_text: { type: "string" },
            html_content: { type: "string" }
          }
        }
      });

      setNewsletterData(prev => ({
        ...prev,
        subject: response.subject,
        preview_text: response.preview_text,
        content: response.html_content
      }));

      toast.success("Newsletter content generated!");
    } catch (error) {
      console.error("Error generating newsletter:", error);
      toast.error("Failed to generate newsletter content");
    } finally {
      setIsGenerating(false);
    }
  };

  const handleSaveNewsletter = async (status = 'draft') => {
    if (!newsletterData.title || !newsletterData.content) {
      toast.error("Please provide title and content");
      return;
    }

    try {
      const recipientCount = getRecipientCount();
      
      const data = {
        ...newsletterData,
        agent_id: currentUser.id,
        article_ids: selectedArticles.join(','),
        recipient_type: recipientType,
        custom_recipient_ids: customRecipients.join(','),
        recipient_count: recipientCount,
        status: status
      };

      if (editingNewsletter) {
        await base44.entities.ClientNewsletter.update(editingNewsletter.id, data);
        toast.success("Newsletter updated successfully");
      } else {
        await base44.entities.ClientNewsletter.create(data);
        toast.success("Newsletter saved successfully");
      }

      setShowCreateModal(false);
      await loadData();
    } catch (error) {
      console.error("Error saving newsletter:", error);
      toast.error("Failed to save newsletter");
    }
  };

  const handleSendNewsletter = async (newsletterId) => {
    if (!window.confirm("Are you sure you want to send this newsletter to all recipients?")) {
      return;
    }

    try {
      const newsletter = newsletters.find(n => n.id === newsletterId);
      const recipients = getRecipients(newsletter);

      // Send emails
      for (const recipient of recipients) {
        try {
          await base44.integrations.Core.SendEmail({
            from_name: currentUser.full_name || "Your Real Estate Agent",
            to: recipient.email,
            subject: newsletter.subject || newsletter.title,
            body: newsletter.content
          });
        } catch (emailError) {
          console.error(`Failed to send to ${recipient.email}:`, emailError);
        }
      }

      // Update newsletter status
      await base44.entities.ClientNewsletter.update(newsletterId, {
        status: 'sent',
        sent_date: new Date().toISOString()
      });

      toast.success(`Newsletter sent to ${recipients.length} recipients!`);
      await loadData();
    } catch (error) {
      console.error("Error sending newsletter:", error);
      toast.error("Failed to send newsletter");
    }
  };

  const handleScheduleNewsletter = async () => {
    if (!newsletterData.scheduled_send_date) {
      toast.error("Please select a send date and time");
      return;
    }

    await handleSaveNewsletter('scheduled');
    toast.success("Newsletter scheduled successfully!");
  };

  const handleDeleteNewsletter = async (newsletterId) => {
    if (!window.confirm("Are you sure you want to delete this newsletter?")) {
      return;
    }

    try {
      await base44.entities.ClientNewsletter.delete(newsletterId);
      toast.success("Newsletter deleted successfully");
      await loadData();
    } catch (error) {
      console.error("Error deleting newsletter:", error);
      toast.error("Failed to delete newsletter");
    }
  };

  const toggleArticleSelection = (articleId) => {
    setSelectedArticles(prev =>
      prev.includes(articleId)
        ? prev.filter(id => id !== articleId)
        : [...prev, articleId]
    );
  };

  const toggleRecipientSelection = (recipientId) => {
    setCustomRecipients(prev =>
      prev.includes(recipientId)
        ? prev.filter(id => id !== recipientId)
        : [...prev, recipientId]
    );
  };

  const getRecipients = (newsletter) => {
    const type = newsletter?.recipient_type || recipientType;
    
    if (type === 'all_clients') {
      return [...contacts, ...buyers];
    } else if (type === 'buyers') {
      return buyers;
    } else if (type === 'past_clients') {
      return contacts.filter(c => c.relationship === 'past_client');
    } else if (type === 'leads') {
      // Would need to load leads
      return [];
    } else if (type === 'custom') {
      const ids = newsletter?.custom_recipient_ids?.split(',') || customRecipients;
      return [...contacts, ...buyers].filter(r => ids.includes(r.id));
    }
    
    return [];
  };

  const getRecipientCount = () => {
    return getRecipients().length;
  };

  const filteredArticles = articles.filter(article =>
    article.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    article.summary?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  if (isLoading) {
    return (
      <div className="page-container">
        <div className="flex items-center justify-center h-64">
          <RefreshCw className="w-8 h-8 animate-spin text-indigo-600" />
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Header */}
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center gap-4">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => navigate(-1)}
                className="rounded-full"
              >
                <ArrowLeft className="w-5 h-5" />
              </Button>
              <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center">
                <Mail className="w-7 h-7 text-white" />
              </div>
              <div className="flex-1">
                <h1 className="text-3xl font-bold">Client Newsletters</h1>
                <p className="text-slate-600">Create and send market updates to your clients</p>
              </div>
              <Button
                onClick={handleCreateNewsletter}
                className="bg-indigo-600 hover:bg-indigo-700"
              >
                <Plus className="w-4 h-4 mr-2" />
                Create Newsletter
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600">Total Sent</p>
                  <p className="text-2xl font-bold">{newsletters.filter(n => n.status === 'sent').length}</p>
                </div>
                <Send className="w-8 h-8 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600">Scheduled</p>
                  <p className="text-2xl font-bold">{newsletters.filter(n => n.status === 'scheduled').length}</p>
                </div>
                <Clock className="w-8 h-8 text-blue-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600">Total Recipients</p>
                  <p className="text-2xl font-bold">
                    {newsletters.reduce((sum, n) => sum + (n.recipient_count || 0), 0)}
                  </p>
                </div>
                <Users className="w-8 h-8 text-purple-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600">Avg Open Rate</p>
                  <p className="text-2xl font-bold">
                    {newsletters.length > 0
                      ? Math.round(
                          newsletters.reduce((sum, n) => {
                            return sum + (n.recipient_count > 0 ? (n.open_count || 0) / n.recipient_count * 100 : 0);
                          }, 0) / newsletters.length
                        )
                      : 0}%
                  </p>
                </div>
                <Eye className="w-8 h-8 text-indigo-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Newsletters List */}
        <Card>
          <CardHeader>
            <CardTitle>Your Newsletters</CardTitle>
          </CardHeader>
          <CardContent>
            {newsletters.length === 0 ? (
              <div className="text-center py-12">
                <Mail className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                <h3 className="text-lg font-semibold text-slate-900 mb-2">No newsletters yet</h3>
                <p className="text-slate-600 mb-4">Create your first newsletter to share market insights with clients</p>
                <Button onClick={handleCreateNewsletter}>
                  <Plus className="w-4 h-4 mr-2" />
                  Create First Newsletter
                </Button>
              </div>
            ) : (
              <div className="space-y-4">
                {newsletters.map(newsletter => (
                  <Card key={newsletter.id} className="hover:shadow-md transition-shadow">
                    <CardContent className="p-4">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <h3 className="font-semibold text-lg">{newsletter.title}</h3>
                            <Badge variant={
                              newsletter.status === 'sent' ? 'default' :
                              newsletter.status === 'scheduled' ? 'secondary' :
                              'outline'
                            }>
                              {newsletter.status === 'sent' && <CheckCircle2 className="w-3 h-3 mr-1" />}
                              {newsletter.status === 'scheduled' && <Clock className="w-3 h-3 mr-1" />}
                              {newsletter.status}
                            </Badge>
                          </div>
                          
                          <div className="flex items-center gap-6 text-sm text-slate-600 mb-3">
                            <div className="flex items-center gap-1">
                              <Users className="w-4 h-4" />
                              <span>{newsletter.recipient_count || 0} recipients</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <Eye className="w-4 h-4" />
                              <span>{newsletter.open_count || 0} opens</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <MousePointer className="w-4 h-4" />
                              <span>{newsletter.click_count || 0} clicks</span>
                            </div>
                            {newsletter.sent_date && (
                              <div className="flex items-center gap-1">
                                <Calendar className="w-4 h-4" />
                                <span>Sent {new Date(newsletter.sent_date).toLocaleDateString()}</span>
                              </div>
                            )}
                            {newsletter.scheduled_send_date && newsletter.status === 'scheduled' && (
                              <div className="flex items-center gap-1">
                                <Clock className="w-4 h-4" />
                                <span>Scheduled for {new Date(newsletter.scheduled_send_date).toLocaleString()}</span>
                              </div>
                            )}
                          </div>

                          <div className="flex gap-2">
                            {newsletter.status === 'draft' && (
                              <>
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={() => handleEditNewsletter(newsletter)}
                                >
                                  <Edit className="w-3 h-3 mr-1" />
                                  Edit
                                </Button>
                                <Button
                                  size="sm"
                                  onClick={() => handleSendNewsletter(newsletter.id)}
                                  className="bg-green-600 hover:bg-green-700"
                                >
                                  <Send className="w-3 h-3 mr-1" />
                                  Send Now
                                </Button>
                              </>
                            )}
                            {newsletter.status === 'sent' && (
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={() => handleEditNewsletter(newsletter)}
                              >
                                <Eye className="w-3 h-3 mr-1" />
                                View
                              </Button>
                            )}
                            <Button
                              size="sm"
                              variant="ghost"
                              onClick={() => handleDeleteNewsletter(newsletter.id)}
                              className="text-red-600 hover:text-red-700 hover:bg-red-50"
                            >
                              <Trash2 className="w-3 h-3" />
                            </Button>
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Create/Edit Newsletter Modal */}
      {showCreateModal && (
        <Dialog open={showCreateModal} onOpenChange={setShowCreateModal}>
          <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle className="text-2xl">
                {editingNewsletter ? 'Edit Newsletter' : 'Create New Newsletter'}
              </DialogTitle>
            </DialogHeader>

            <Tabs defaultValue="articles" className="w-full">
              <TabsList className="grid w-full grid-cols-4">
                <TabsTrigger value="articles">1. Select Articles</TabsTrigger>
                <TabsTrigger value="content">2. Content</TabsTrigger>
                <TabsTrigger value="recipients">3. Recipients</TabsTrigger>
                <TabsTrigger value="preview">4. Preview & Send</TabsTrigger>
              </TabsList>

              {/* Step 1: Select Articles */}
              <TabsContent value="articles" className="space-y-4">
                <div className="space-y-4">
                  <div className="flex gap-2">
                    <div className="relative flex-1">
                      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                      <Input
                        placeholder="Search articles..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="pl-10"
                      />
                    </div>
                  </div>

                  <div className="text-sm text-slate-600 mb-2">
                    {selectedArticles.length} article(s) selected
                  </div>

                  <div className="grid grid-cols-1 gap-3 max-h-96 overflow-y-auto">
                    {filteredArticles.map(article => (
                      <Card
                        key={article.id}
                        className={`cursor-pointer transition-all ${
                          selectedArticles.includes(article.id)
                            ? 'border-indigo-500 bg-indigo-50'
                            : 'hover:border-slate-300'
                        }`}
                        onClick={() => toggleArticleSelection(article.id)}
                      >
                        <CardContent className="p-4">
                          <div className="flex items-start gap-3">
                            <input
                              type="checkbox"
                              checked={selectedArticles.includes(article.id)}
                              onChange={() => toggleArticleSelection(article.id)}
                              className="mt-1"
                              onClick={(e) => e.stopPropagation()}
                            />
                            <div className="flex-1">
                              <h4 className="font-semibold text-slate-900 mb-1">{article.title}</h4>
                              <p className="text-sm text-slate-600 line-clamp-2">{article.summary}</p>
                              <div className="flex gap-2 mt-2">
                                <Badge variant="outline" className="text-xs">{article.category}</Badge>
                                {article.is_trending && (
                                  <Badge className="text-xs bg-orange-100 text-orange-700">
                                    <TrendingUp className="w-3 h-3 mr-1" />
                                    Trending
                                  </Badge>
                                )}
                              </div>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </div>
              </TabsContent>

              {/* Step 2: Content */}
              <TabsContent value="content" className="space-y-4">
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Newsletter Title</label>
                    <Input
                      value={newsletterData.title}
                      onChange={(e) => setNewsletterData({...newsletterData, title: e.target.value})}
                      placeholder="e.g., Monthly Market Update - January 2025"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Email Subject Line</label>
                    <Input
                      value={newsletterData.subject}
                      onChange={(e) => setNewsletterData({...newsletterData, subject: e.target.value})}
                      placeholder="Catchy subject line for email"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Preview Text</label>
                    <Input
                      value={newsletterData.preview_text}
                      onChange={(e) => setNewsletterData({...newsletterData, preview_text: e.target.value})}
                      placeholder="Brief preview text shown in email clients"
                    />
                  </div>

                  <div className="flex gap-2">
                    <Button
                      onClick={generateNewsletterContent}
                      disabled={isGenerating || selectedArticles.length === 0}
                      className="bg-purple-600 hover:bg-purple-700"
                    >
                      {isGenerating ? (
                        <>
                          <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                          Generating...
                        </>
                      ) : (
                        <>
                          <Sparkles className="w-4 h-4 mr-2" />
                          AI Generate Content
                        </>
                      )}
                    </Button>
                    {selectedArticles.length === 0 && (
                      <p className="text-sm text-amber-600 flex items-center gap-1">
                        <AlertCircle className="w-4 h-4" />
                        Select articles first
                      </p>
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Newsletter Content (HTML)</label>
                    <Textarea
                      value={newsletterData.content}
                      onChange={(e) => setNewsletterData({...newsletterData, content: e.target.value})}
                      placeholder="Newsletter HTML content..."
                      className="h-64 font-mono text-sm"
                    />
                  </div>
                </div>
              </TabsContent>

              {/* Step 3: Recipients */}
              <TabsContent value="recipients" className="space-y-4">
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Recipient Group</label>
                    <Select value={recipientType} onValueChange={setRecipientType}>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all_clients">All Clients ({contacts.length + buyers.length})</SelectItem>
                        <SelectItem value="buyers">Active Buyers ({buyers.length})</SelectItem>
                        <SelectItem value="past_clients">Past Clients ({contacts.filter(c => c.relationship === 'past_client').length})</SelectItem>
                        <SelectItem value="custom">Custom Selection</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  {recipientType === 'custom' && (
                    <div>
                      <label className="block text-sm font-medium mb-2">Select Recipients</label>
                      <div className="border rounded-lg p-4 max-h-96 overflow-y-auto space-y-2">
                        {[...contacts, ...buyers].map(recipient => (
                          <div
                            key={recipient.id}
                            className="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer"
                            onClick={() => toggleRecipientSelection(recipient.id)}
                          >
                            <input
                              type="checkbox"
                              checked={customRecipients.includes(recipient.id)}
                              onChange={() => toggleRecipientSelection(recipient.id)}
                              onClick={(e) => e.stopPropagation()}
                            />
                            <div>
                              <p className="font-medium">{recipient.name || `${recipient.first_name} ${recipient.last_name}`}</p>
                              <p className="text-sm text-slate-600">{recipient.email}</p>
                            </div>
                          </div>
                        ))}
                      </div>
                      <p className="text-sm text-slate-600 mt-2">
                        {customRecipients.length} recipient(s) selected
                      </p>
                    </div>
                  )}

                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div className="flex items-start gap-2">
                      <Users className="w-5 h-5 text-blue-600 mt-0.5" />
                      <div>
                        <p className="font-semibold text-blue-900">Total Recipients</p>
                        <p className="text-2xl font-bold text-blue-600">{getRecipientCount()}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </TabsContent>

              {/* Step 4: Preview & Send */}
              <TabsContent value="preview" className="space-y-4">
                <div className="space-y-4">
                  <div className="bg-slate-50 border rounded-lg p-6">
                    <h3 className="font-semibold mb-2">Subject:</h3>
                    <p className="text-lg">{newsletterData.subject || newsletterData.title}</p>
                    
                    <h3 className="font-semibold mt-4 mb-2">Preview:</h3>
                    <p className="text-slate-600">{newsletterData.preview_text}</p>
                    
                    <h3 className="font-semibold mt-4 mb-2">Content Preview:</h3>
                    <div
                      className="border rounded p-4 bg-white max-h-96 overflow-y-auto"
                      dangerouslySetInnerHTML={{ __html: newsletterData.content }}
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <Card>
                      <CardContent className="p-4">
                        <p className="text-sm text-slate-600 mb-1">Articles Included</p>
                        <p className="text-2xl font-bold">{selectedArticles.length}</p>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="p-4">
                        <p className="text-sm text-slate-600 mb-1">Total Recipients</p>
                        <p className="text-2xl font-bold">{getRecipientCount()}</p>
                      </CardContent>
                    </Card>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Schedule Send (Optional)</label>
                    <Input
                      type="datetime-local"
                      value={newsletterData.scheduled_send_date}
                      onChange={(e) => setNewsletterData({...newsletterData, scheduled_send_date: e.target.value})}
                    />
                  </div>
                </div>
              </TabsContent>
            </Tabs>

            {/* Action Buttons */}
            <div className="flex justify-between items-center pt-4 border-t">
              <Button
                variant="outline"
                onClick={() => setShowCreateModal(false)}
              >
                Cancel
              </Button>
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  onClick={() => handleSaveNewsletter('draft')}
                >
                  <Save className="w-4 h-4 mr-2" />
                  Save Draft
                </Button>
                {newsletterData.scheduled_send_date ? (
                  <Button
                    onClick={handleScheduleNewsletter}
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    <Clock className="w-4 h-4 mr-2" />
                    Schedule Send
                  </Button>
                ) : (
                  <Button
                    onClick={() => {
                      handleSaveNewsletter('draft').then(() => {
                        const newsletter = newsletters[0];
                        if (newsletter) {
                          handleSendNewsletter(newsletter.id);
                        }
                      });
                    }}
                    className="bg-green-600 hover:bg-green-700"
                  >
                    <Send className="w-4 h-4 mr-2" />
                    Send Now
                  </Button>
                )}
              </div>
            </div>
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { Notification } from "@/api/entities";
import { User } from "@/api/entities";
import { Property } from "@/api/entities";
import { Task } from "@/api/entities";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import LoadingSpinner from "../components/common/LoadingSpinner";
import { Bell, CheckCircle2, Clock, AlertCircle, Trash2, CheckCheck, ArrowLeft, Settings, Building2, DollarSign } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { formatDistanceToNow } from "date-fns";
import { toast } from "sonner";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";

export default function Notifications() {
  const navigate = useNavigate();
  const [notifications, setNotifications] = useState([]);
  const [properties, setProperties] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [filterMode, setFilterMode] = useState("unread");
  const [isLoading, setIsLoading] = useState(true);
  const [showSettings, setShowSettings] = useState(false);
  const [notificationPrefs, setNotificationPrefs] = useState({
    notify_1_day: true,
    notify_3_days: true,
    notify_5_days: false
  });

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const user = await User.me();
      setCurrentUser(user);
      
      // Load user notification preferences
      if (user.notification_preferences) {
        try {
          const prefs = typeof user.notification_preferences === 'string' 
            ? JSON.parse(user.notification_preferences)
            : user.notification_preferences;
          setNotificationPrefs(prev => ({ ...prev, ...prefs }));
        } catch (e) {
          console.error("Error parsing notification preferences:", e);
        }
      }
      
      // Load notifications first
      const notifData = await Notification.filter({ user_id: user.id });
      setNotifications(notifData.sort((a, b) => 
        new Date(b.created_date) - new Date(a.created_date)
      ));

      // Wait longer before loading properties and tasks to avoid rate limits
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Load properties and tasks separately with error handling
      try {
        const propertiesData = await Property.list();
        setProperties(propertiesData || []);
      } catch (error) {
        console.error("Could not load properties:", error);
        setProperties([]);
      }
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      try {
        const tasksData = await Task.list();
        setTasks(tasksData || []);
      } catch (error) {
        console.error("Could not load tasks:", error);
        setTasks([]);
      }
    } catch (error) {
      console.error("Error loading notifications:", error);
      if (error.response?.status === 429) {
        toast.error("Too many requests. Please wait a moment and try again.");
      } else {
        toast.error("Failed to load notifications");
      }
    }
    setIsLoading(false);
  };

  const saveNotificationPreferences = async (prefs) => {
    try {
      await User.updateMyUserData({
        notification_preferences: JSON.stringify(prefs)
      });
      setNotificationPrefs(prefs);
      toast.success("Notification preferences saved");
      setShowSettings(false);
    } catch (error) {
      console.error("Error saving preferences:", error);
      toast.error("Failed to save preferences");
    }
  };

  const markAsRead = async (notificationId) => {
    try {
      await Notification.update(notificationId, {
        is_read: true,
        read_at: new Date().toISOString()
      });
      loadData();
      
      window.dispatchEvent(new Event('refreshCounts'));
    } catch (error) {
      console.error("Error marking as read:", error);
      toast.error("Failed to mark as read");
    }
  };

  const markAllAsRead = async () => {
    try {
      const unreadNotifs = notifications.filter(n => !n.is_read);
      await Promise.all(
        unreadNotifs.map(n => 
          Notification.update(n.id, {
            is_read: true,
            read_at: new Date().toISOString()
          })
        )
      );
      loadData();
      
      window.dispatchEvent(new Event('refreshCounts'));
      toast.success("All notifications marked as read");
    } catch (error) {
      console.error("Error marking all as read:", error);
      toast.error("Failed to mark all as read");
    }
  };

  const deleteNotification = async (notificationId) => {
    if (!confirm("Delete this notification?")) return;
    try {
      await Notification.delete(notificationId);
      loadData();
      
      window.dispatchEvent(new Event('refreshCounts'));
      toast.success("Notification deleted");
    } catch (error) {
      console.error("Error deleting notification:", error);
      toast.error("Failed to delete notification");
    }
  };

  const handleNotificationClick = (notification) => {
    if (!notification.is_read) {
      markAsRead(notification.id);
    }
    
    // If it's a task notification, go to the property page with task highlighted
    if (notification.related_entity_type === 'task' && notification.related_entity_id) {
      const task = tasks.find(t => t.id === notification.related_entity_id);
      if (task && task.property_id) {
        // Navigate to property page with highlightTask parameter
        navigate(createPageUrl(`PropertyDetail?id=${task.property_id}&highlightTask=${task.id}`));
        return;
      }
    }
    
    // Otherwise use default navigation logic
    if (notification.action_url) {
      navigate(notification.action_url);
    } else if (notification.related_entity_type && notification.related_entity_id) {
      const pageMap = {
        lead: `LeadDetail?id=${notification.related_entity_id}`,
        property: `PropertyDetail?id=${notification.related_entity_id}`,
        task: `Tasks`,
        transaction: `Transactions`,
        buyer: `BuyerDetail?id=${notification.related_entity_id}`
      };
      const page = pageMap[notification.related_entity_type];
      if (page) navigate(createPageUrl(page));
    }
  };

  const getRelatedPropertyInfo = (notification) => {
    let property = null;
    
    // If notification is for a task, find the task's property
    if (notification.related_entity_type === 'task' && notification.related_entity_id) {
      const task = tasks.find(t => t.id === notification.related_entity_id);
      if (task && task.property_id) {
        // If task is completed, don't show this notification
        if (task.status === 'completed') {
          return null;
        }
        property = properties.find(p => p.id === task.property_id);
      }
    }
    // If notification is directly for a property
    else if (notification.related_entity_type === 'property' && notification.related_entity_id) {
      property = properties.find(p => p.id === notification.related_entity_id);
    }
    
    return property;
  };

  const getNotificationIcon = (type, priority) => {
    if (priority === "urgent") return <AlertCircle className="w-5 h-5 text-red-500" />;
    if (priority === "high") return <AlertCircle className="w-5 h-5 text-orange-500" />;
    
    const icons = {
      task_due: <Clock className="w-5 h-5 text-blue-500" />,
      task_overdue: <AlertCircle className="w-5 h-5 text-red-500" />,
      lead_assigned: <Bell className="w-5 h-5 text-green-500" />,
      property_status_change: <CheckCircle2 className="w-5 h-5 text-indigo-500" />,
      message_received: <Bell className="w-5 h-5 text-purple-500" />,
      document_uploaded: <CheckCircle2 className="w-5 h-5 text-blue-500" />,
      transaction_update: <CheckCircle2 className="w-5 h-5 text-green-500" />,
      system_alert: <AlertCircle className="w-5 h-5 text-amber-500" />
    };
    return icons[type] || <Bell className="w-5 h-5 text-slate-400" />;
  };

  const getPriorityColor = (priority) => {
    const colors = {
      urgent: "bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-700",
      high: "bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-300 dark:border-orange-700",
      normal: "bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-700",
      low: "bg-slate-100 text-slate-700 border-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600"
    };
    return colors[priority] || colors.normal;
  };

  const filteredNotifications = notifications.filter(n => {
    // Filter out notifications for completed tasks
    const propertyInfo = getRelatedPropertyInfo(n);
    if (propertyInfo === null) return false; // null means task is completed
    
    // Apply read/unread filter
    if (filterMode === "unread") return !n.is_read;
    if (filterMode === "read") return n.is_read;
    return true; // if filterMode is "all" or undefined
  });

  const unreadCount = notifications.filter(n => {
    const propertyInfo = getRelatedPropertyInfo(n);
    return propertyInfo !== null && !n.is_read;
  }).length;

  if (isLoading) {
    return <LoadingSpinner icon={Bell} title="Loading Notifications..." description="Loading your notifications" />;
  }

  return (
    <div className="page-container">
      {/* Header */}
      <div className="app-card p-3">
        <div className="flex items-center gap-3">
          <Button
            variant="ghost"
            size="icon"
            onClick={() => navigate(createPageUrl("Dashboard"))}
            className="rounded-full h-8 w-8"
          >
            <ArrowLeft className="w-4 h-4" />
          </Button>
          <div className="flex-1">
            <h1 className="app-title text-lg">Notifications</h1>
            <p className="app-subtitle text-xs">
              {unreadCount} unread notifications ‚Ä¢ Stay updated on important events
            </p>
          </div>
          <div className="flex items-center gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setShowSettings(true)}
              className="h-8"
            >
              <Settings className="w-4 h-4 mr-2" />
              Settings
            </Button>
            <Button
              variant={filterMode === "unread" ? "default" : "outline"}
              size="sm"
              onClick={() => setFilterMode("unread")}
              className="h-8"
            >
              Unread ({unreadCount})
            </Button>
            <Button
              variant={filterMode === "all" ? "default" : "outline"}
              size="sm"
              onClick={() => setFilterMode("all")}
              className="h-8"
            >
              All ({notifications.length})
            </Button>
          </div>
          {unreadCount > 0 && (
            <Button onClick={markAllAsRead} variant="outline" size="sm" className="h-8">
              <CheckCheck className="w-4 h-4 mr-2" />
              Mark All Read
            </Button>
          )}
        </div>
      </div>

      {/* Notification List */}
      <div className="space-y-3">
        {filteredNotifications.length === 0 ? (
          <div className="app-card p-12 text-center">
            <Bell className="w-16 h-16 mx-auto mb-4 text-slate-300 dark:text-slate-600" />
            <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
              {filterMode === "unread" ? "No unread notifications" : "No notifications"}
            </h3>
            <p className="text-slate-500 dark:text-slate-400">
              {filterMode === "unread" 
                ? "You're all caught up! Check back later for updates." 
                : "You don't have any notifications yet."}
            </p>
          </div>
        ) : (
          filteredNotifications.map(notification => {
            const property = getRelatedPropertyInfo(notification);
            
            return (
              <div
                key={notification.id}
                onClick={() => handleNotificationClick(notification)}
                className={`app-card p-4 cursor-pointer transition-all hover:shadow-lg ${
                  !notification.is_read 
                    ? 'border-l-4 border-indigo-600 bg-indigo-50/50 dark:bg-indigo-900/20' 
                    : 'hover:bg-slate-50 dark:hover:bg-slate-800'
                }`}
              >
                <div className="flex items-start gap-4">
                  <div className="mt-1">
                    {getNotificationIcon(notification.notification_type, notification.priority)}
                  </div>
                  
                  <div className="flex-1 min-w-0">
                    <div className="flex items-start justify-between gap-3 mb-2">
                      <h4 className="font-semibold text-slate-900 dark:text-white">
                        {notification.title}
                      </h4>
                      <div className="flex items-center gap-2">
                        {notification.priority && notification.priority !== "normal" && (
                          <Badge className={getPriorityColor(notification.priority)}>
                            {notification.priority}
                          </Badge>
                        )}
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={(e) => {
                            e.stopPropagation();
                            deleteNotification(notification.id);
                          }}
                          className="h-8 w-8 p-0 hover:bg-red-100 hover:text-red-600 dark:hover:bg-red-900/30"
                        >
                          <Trash2 className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                    
                    <p className="text-slate-600 dark:text-slate-300 text-sm mb-2">
                      {notification.message}
                    </p>

                    {/* Property Information */}
                    {property && (
                      <div className="mt-3 p-3 bg-slate-100 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-600">
                        <div className="flex items-start gap-3">
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                              <Building2 className="w-4 h-4 text-slate-500 dark:text-slate-400 flex-shrink-0" />
                              <p className="text-sm font-semibold text-slate-900 dark:text-white truncate">
                                {property.address}
                              </p>
                            </div>
                            <div className="flex items-center gap-2">
                              <DollarSign className="w-4 h-4 text-green-600 dark:text-green-400 flex-shrink-0" />
                              <p className="text-sm font-medium text-slate-700 dark:text-slate-300">
                                ${property.price?.toLocaleString()}
                              </p>
                            </div>
                          </div>
                          {property.primary_photo_url && (
                            <img 
                              src={property.primary_photo_url} 
                              alt={property.address}
                              className="w-16 h-16 object-cover rounded-lg flex-shrink-0"
                            />
                          )}
                        </div>
                      </div>
                    )}
                    
                    <div className="flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400 mt-2">
                      <span>{formatDistanceToNow(new Date(notification.created_date), { addSuffix: true })}</span>
                      {notification.related_entity_type && (
                        <>
                          <span>‚Ä¢</span>
                          <span className="capitalize">{notification.related_entity_type.replace('_', ' ')}</span>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            );
          })
        )}
      </div>

      {/* Settings Modal */}
      {showSettings && (
        <Dialog open={showSettings} onOpenChange={setShowSettings}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Notification Settings</DialogTitle>
            </DialogHeader>
            <div className="space-y-6 py-4">
              <div>
                <h3 className="text-sm font-semibold text-slate-900 dark:text-white mb-3">
                  Task Due Date Reminders
                </h3>
                <p className="text-xs text-slate-500 dark:text-slate-400 mb-4">
                  Customize when you receive task reminders (requires background job setup)
                </p>
                <div className="space-y-3">
                  <div className="flex items-center gap-3">
                    <Checkbox
                      id="notify_1_day"
                      checked={notificationPrefs.notify_1_day}
                      onCheckedChange={(checked) => 
                        setNotificationPrefs(prev => ({ ...prev, notify_1_day: checked }))
                      }
                    />
                    <Label htmlFor="notify_1_day" className="cursor-pointer">
                      1 day before task is due
                    </Label>
                  </div>
                  <div className="flex items-center gap-3">
                    <Checkbox
                      id="notify_3_days"
                      checked={notificationPrefs.notify_3_days}
                      onCheckedChange={(checked) => 
                        setNotificationPrefs(prev => ({ ...prev, notify_3_days: checked }))
                      }
                    />
                    <Label htmlFor="notify_3_days" className="cursor-pointer">
                      3 days before task is due
                    </Label>
                  </div>
                  <div className="flex items-center gap-3">
                    <Checkbox
                      id="notify_5_days"
                      checked={notificationPrefs.notify_5_days}
                      onCheckedChange={(checked) => 
                        setNotificationPrefs(prev => ({ ...prev, notify_5_days: checked }))
                      }
                    />
                    <Label htmlFor="notify_5_days" className="cursor-pointer">
                      5 days before task is due
                    </Label>
                  </div>
                </div>
                
                <div className="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                  <p className="text-xs text-blue-800 dark:text-blue-300">
                    <strong>Note:</strong> Task reminder notifications are generated by a background system. 
                    Your preferences are saved and will be applied automatically.
                  </p>
                </div>
              </div>
              
              <div className="flex justify-end gap-3 pt-4 border-t">
                <Button
                  variant="outline"
                  onClick={() => setShowSettings(false)}
                >
                  Cancel
                </Button>
                <Button
                  onClick={() => saveNotificationPreferences(notificationPrefs)}
                >
                  Save Settings
                </Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
}
import React, { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Star, ThumbsUp, ThumbsDown, AlertCircle, CheckCircle2, Home, Loader2, MapPin } from 'lucide-react';
import { toast } from 'sonner';

export default function OpenHouseFeedback() {
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [openHouse, setOpenHouse] = useState(null);
  const [property, setProperty] = useState(null);
  const [formData, setFormData] = useState({
    attendee_name: '',
    attendee_email: '',
    interest_level: '',
    rating: 0,
    likes: '',
    dislikes: '',
    concerns: '',
    feedback_text: '',
    offer_potential: 'unknown'
  });

  useEffect(() => {
    loadOpenHouseData();
  }, []);

  const loadOpenHouseData = async () => {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const openHouseId = urlParams.get('id');

      if (!openHouseId) {
        toast.error('No open house ID provided');
        setLoading(false);
        return;
      }

      const openHouses = await base44.entities.OpenHouse.list();
      const oh = openHouses.find(o => o.id === openHouseId);

      if (!oh) {
        toast.error('Open house not found');
        setLoading(false);
        return;
      }

      const properties = await base44.entities.Property.list();
      const prop = properties.find(p => p.id === oh.property_id);

      setOpenHouse(oh);
      setProperty(prop);
    } catch (error) {
      console.error('Error loading open house:', error);
      toast.error('Failed to load open house details');
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!formData.attendee_name) {
      toast.error('Please enter your name');
      return;
    }

    setSubmitting(true);
    try {
      await base44.entities.PropertyFeedback.create({
        property_id: property.id,
        open_house_id: openHouse.id,
        feedback_source: 'open_house',
        attendee_name: formData.attendee_name,
        attendee_email: formData.attendee_email,
        interest_level: formData.interest_level,
        rating: formData.rating,
        likes: formData.likes,
        dislikes: formData.dislikes,
        concerns: formData.concerns,
        feedback_text: formData.feedback_text,
        offer_potential: formData.offer_potential,
        ai_analyzed: false
      });

      setSubmitted(true);
      toast.success('Thank you for your feedback!');
    } catch (error) {
      console.error('Error submitting feedback:', error);
      toast.error('Failed to submit feedback. Please try again.');
    } finally {
      setSubmitting(false);
    }
  };

  const handleChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 flex items-center justify-center p-4">
        <div className="text-center">
          <Loader2 className="w-12 h-12 animate-spin text-indigo-600 mx-auto mb-4" />
          <p className="text-slate-600">Loading open house details...</p>
        </div>
      </div>
    );
  }

  if (!openHouse || !property) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h2 className="text-2xl font-bold text-slate-900 mb-2">Open House Not Found</h2>
            <p className="text-slate-600">Please check your link and try again.</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (submitted) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 flex items-center justify-center p-4">
        <Card className="max-w-2xl w-full border-2 border-green-200 shadow-2xl">
          <CardContent className="p-8 text-center">
            <div className="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
              <CheckCircle2 className="w-12 h-12 text-white" />
            </div>
            <h2 className="text-3xl font-bold text-slate-900 mb-4">Thank You!</h2>
            <p className="text-lg text-slate-600 mb-6">
              Your feedback has been submitted successfully. We appreciate you taking the time to share your thoughts about this property.
            </p>
            <div className="bg-green-100 border-2 border-green-300 rounded-lg p-4">
              <p className="text-sm text-green-800 font-semibold">
                Our team will review your feedback and reach out to you soon!
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 py-6 px-6">
      <div className="max-w-4xl mx-auto">
        {/* Property Header */}
        <Card className="mb-8 border-2 border-indigo-200 shadow-xl overflow-hidden">
          <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-white">
            <div className="flex items-start gap-6">
              <div className="w-20 h-20 bg-white/20 rounded-2xl flex items-center justify-center flex-shrink-0">
                <Home className="w-10 h-10" />
              </div>
              <div className="flex-1">
                <h1 className="text-3xl font-bold mb-3">{property.address}</h1>
                <div className="flex items-center gap-3 text-white/90 mb-3 text-lg">
                  <MapPin className="w-5 h-5" />
                  <span>{property.city}, {property.state} {property.zip_code}</span>
                </div>
                <div className="flex items-center gap-6 text-base">
                  {property.bedrooms && <span className="font-semibold">{property.bedrooms} beds</span>}
                  {property.bathrooms && <span className="font-semibold">{property.bathrooms} baths</span>}
                  {property.square_feet && <span className="font-semibold">{property.square_feet.toLocaleString()} sqft</span>}
                </div>
              </div>
              <div className="text-right">
                <div className="text-4xl font-bold">${property.price?.toLocaleString()}</div>
              </div>
            </div>
          </div>
        </Card>

        {/* Feedback Form */}
        <Card className="border-2 border-slate-200 shadow-xl">
          <CardHeader className="bg-gradient-to-r from-slate-50 to-slate-100 border-b p-8">
            <h2 className="text-3xl font-bold text-slate-900">Share Your Feedback</h2>
            <p className="text-slate-600 text-lg mt-2">Help us understand what you think about this property</p>
          </CardHeader>
          <CardContent className="p-8">
            <form onSubmit={handleSubmit} className="space-y-8">
              {/* Contact Information */}
              <div className="bg-indigo-50 rounded-xl p-6 border-2 border-indigo-200">
                <h3 className="text-2xl font-semibold text-slate-900 mb-6 flex items-center gap-3">
                  <AlertCircle className="w-6 h-6 text-indigo-600" />
                  Your Information
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-lg font-semibold text-slate-700 mb-3">
                      Name <span className="text-red-500">*</span>
                    </label>
                    <Input
                      value={formData.attendee_name}
                      onChange={(e) => handleChange('attendee_name', e.target.value)}
                      placeholder="Your full name"
                      className="h-16 text-lg"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-lg font-semibold text-slate-700 mb-3">
                      Email
                    </label>
                    <Input
                      type="email"
                      value={formData.attendee_email}
                      onChange={(e) => handleChange('attendee_email', e.target.value)}
                      placeholder="your.email@example.com"
                      className="h-16 text-lg"
                    />
                  </div>
                </div>
              </div>

              {/* Rating */}
              <div className="bg-yellow-50 rounded-xl p-6 border-2 border-yellow-200">
                <label className="block text-2xl font-semibold text-slate-900 mb-6 text-center">
                  How would you rate this property?
                </label>
                <div className="flex justify-center gap-4">
                  {[1, 2, 3, 4, 5].map((num) => (
                    <button
                      key={num}
                      type="button"
                      onClick={() => handleChange('rating', num)}
                      className="transition-all hover:scale-110 active:scale-95 p-2"
                    >
                      <Star
                        className={`w-16 h-16 ${formData.rating >= num ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'}`}
                      />
                    </button>
                  ))}
                </div>
                {formData.rating > 0 && (
                  <p className="text-center text-xl text-slate-700 mt-4 font-semibold">
                    {formData.rating === 5 ? '‚≠ê Excellent!' : 
                     formData.rating === 4 ? 'üëç Great!' :
                     formData.rating === 3 ? 'üëå Good' :
                     formData.rating === 2 ? 'ü§î Fair' : 'üòï Needs improvement'}
                  </p>
                )}
              </div>

              {/* Interest Level */}
              <div>
                <label className="block text-2xl font-semibold text-slate-900 mb-6 text-center">
                  How interested are you in this property?
                </label>
                <div className="grid grid-cols-2 gap-4">
                  {[
                    { value: 'very_interested', label: 'Very Interested', emoji: 'üî•', color: 'from-red-500 to-orange-500' },
                    { value: 'interested', label: 'Interested', emoji: 'üëç', color: 'from-green-500 to-emerald-500' },
                    { value: 'neutral', label: 'Neutral', emoji: 'üòê', color: 'from-slate-500 to-slate-600' },
                    { value: 'not_interested', label: 'Not Interested', emoji: 'üëé', color: 'from-gray-500 to-gray-600' }
                  ].map((option) => (
                    <button
                      key={option.value}
                      type="button"
                      onClick={() => handleChange('interest_level', option.value)}
                      className={`p-6 rounded-2xl border-3 transition-all active:scale-95 ${
                        formData.interest_level === option.value
                          ? `bg-gradient-to-br ${option.color} text-white border-transparent shadow-2xl scale-105`
                          : 'bg-white border-slate-300 hover:border-indigo-400 hover:shadow-lg'
                      }`}
                    >
                      <div className="text-5xl mb-3">{option.emoji}</div>
                      <div className={`text-lg font-bold ${formData.interest_level === option.value ? 'text-white' : 'text-slate-700'}`}>
                        {option.label}
                      </div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Offer Potential */}
              <div>
                <label className="block text-2xl font-semibold text-slate-900 mb-6 text-center">
                  Would you consider making an offer?
                </label>
                <div className="grid grid-cols-2 gap-4">
                  {[
                    { value: 'likely', label: 'Very Likely', color: 'bg-green-500' },
                    { value: 'possible', label: 'Maybe', color: 'bg-blue-500' },
                    { value: 'unlikely', label: 'Unlikely', color: 'bg-orange-500' },
                    { value: 'unknown', label: 'Not Sure', color: 'bg-gray-500' }
                  ].map((option) => (
                    <button
                      key={option.value}
                      type="button"
                      onClick={() => handleChange('offer_potential', option.value)}
                      className={`p-5 rounded-2xl border-3 transition-all active:scale-95 ${
                        formData.offer_potential === option.value
                          ? `${option.color} text-white border-transparent shadow-2xl scale-105`
                          : 'bg-white border-slate-300 hover:border-indigo-400 hover:shadow-lg text-slate-700'
                      }`}
                    >
                      <div className="text-lg font-bold">{option.label}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* What They Liked */}
              <div className="bg-green-50 rounded-xl p-6 border-2 border-green-200">
                <label className="block text-xl font-semibold text-slate-900 mb-4 flex items-center gap-3">
                  <ThumbsUp className="w-6 h-6 text-green-600" />
                  What did you like about this property?
                </label>
                <Textarea
                  value={formData.likes}
                  onChange={(e) => handleChange('likes', e.target.value)}
                  placeholder="Tell us what caught your eye..."
                  className="min-h-[120px] text-lg"
                />
              </div>

              {/* What They Didn't Like */}
              <div className="bg-red-50 rounded-xl p-6 border-2 border-red-200">
                <label className="block text-xl font-semibold text-slate-900 mb-4 flex items-center gap-3">
                  <ThumbsDown className="w-6 h-6 text-red-600" />
                  What didn't you like?
                </label>
                <Textarea
                  value={formData.dislikes}
                  onChange={(e) => handleChange('dislikes', e.target.value)}
                  placeholder="Any concerns or things you didn't prefer..."
                  className="min-h-[120px] text-lg"
                />
              </div>

              {/* Questions/Concerns */}
              <div className="bg-orange-50 rounded-xl p-6 border-2 border-orange-200">
                <label className="block text-xl font-semibold text-slate-900 mb-4 flex items-center gap-3">
                  <AlertCircle className="w-6 h-6 text-orange-600" />
                  Any questions or concerns?
                </label>
                <Textarea
                  value={formData.concerns}
                  onChange={(e) => handleChange('concerns', e.target.value)}
                  placeholder="Questions you'd like answered..."
                  className="min-h-[120px] text-lg"
                />
              </div>

              {/* Additional Comments */}
              <div>
                <label className="block text-xl font-semibold text-slate-900 mb-4">
                  Additional Comments
                </label>
                <Textarea
                  value={formData.feedback_text}
                  onChange={(e) => handleChange('feedback_text', e.target.value)}
                  placeholder="Any other thoughts or feedback..."
                  className="min-h-[140px] text-lg"
                />
              </div>

              {/* Submit Button */}
              <Button
                type="submit"
                disabled={submitting || !formData.attendee_name}
                className="w-full h-20 text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-2xl active:scale-95 transition-all"
              >
                {submitting ? (
                  <>
                    <Loader2 className="w-7 h-7 mr-3 animate-spin" />
                    Submitting...
                  </>
                ) : (
                  <>
                    <CheckCircle2 className="w-7 h-7 mr-3" />
                    Submit Feedback
                  </>
                )}
              </Button>

              <p className="text-base text-center text-slate-500 mt-4">
                Your feedback helps us serve you better. Thank you for visiting!
              </p>
            </form>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
import React, { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { Plus, Calendar, Clock, User as UserIcon, CheckCircle, ArrowLeft, Star, MessageSquare } from "lucide-react";
import { format, parseISO } from "date-fns";
import { useNavigate } from 'react-router-dom';
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner"; // Assuming sonner is already installed and configured

export default function OpenHouses() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  
  const [showModal, setShowModal] = useState(false);
  const [editingOpenHouse, setEditingOpenHouse] = useState(null);
  const [filterMode, setFilterMode] = useState("pending"); // Default to pending open houses

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me(),
  });

  const { data: openHouses = [], isLoading: isLoadingOpenHouses } = useQuery({
    queryKey: ['openHouses', user?.id],
    queryFn: () => base44.entities.OpenHouse.filter({ hosting_agent_id: user.id }, "-date"),
    enabled: !!user?.id
  });

  const { data: properties = [], isLoading: isLoadingProperties } = useQuery({
    queryKey: ['properties', user?.id],
    queryFn: async () => {
      const [listing, created] = await Promise.all([
        base44.entities.Property.filter({ listing_agent_id: user.id }).catch(() => []),
        base44.entities.Property.filter({ created_by: user.email }).catch(() => [])
      ]);
      const combined = [...listing, ...created];
      return Array.from(new Map(combined.map(item => [item.id, item])).values());
    },
    enabled: !!user?.id
  });

  const { data: users = [], isLoading: isLoadingUsers } = useQuery({
    queryKey: ['users'],
    queryFn: () => base44.entities.User.list(),
  });

  const { data: allFeedback = [] } = useQuery({
    queryKey: ['propertyFeedback'],
    queryFn: () => base44.entities.PropertyFeedback.list(),
  });

  const isLoading = isLoadingOpenHouses || isLoadingProperties || isLoadingUsers;

  const mutation = useMutation({
    mutationFn: (data) => {
        const payload = { ...data, attendee_count: parseInt(data.attendee_count, 10) || 0 };
        if (editingOpenHouse) {
            return base44.entities.OpenHouse.update(editingOpenHouse.id, payload);
        } else {
            return base44.entities.OpenHouse.create(payload);
        }
    },
    onSuccess: () => {
        queryClient.invalidateQueries({ queryKey: ['openHouses'] });
        queryClient.invalidateQueries({ queryKey: ['dashboardData'] }); // Invalidate dashboard data if it relies on open houses count/status
        setShowModal(false);
        setEditingOpenHouse(null);
        toast.success(`Open House ${editingOpenHouse ? "updated" : "scheduled"} successfully!`);
    },
    onError: (error) => {
        console.error("Error saving open house:", error);
        toast.error(`Error saving Open House: ${error.message || "An unknown error occurred."}`);
    },
  });

  const handleSave = (data) => {
    mutation.mutate(data);
  };

  const getStatusColor = (status) => {
    const colors = {
      proposed: "#94a3b8",
      approved: "#10b981",
      published: "#6366f1",
      completed: "#8b5cf6",
      cancelled: "#ef4444"
    };
    return colors[status] || "#94a3b8";
  };

  const getFilteredOpenHouses = () => {
    let filtered = openHouses;

    if (filterMode === "pending") {
      filtered = filtered.filter(oh =>
        oh.status === 'proposed' || oh.status === 'approved'
      );
    }
    // If filterMode is "all", 'filtered' remains 'openHouses'
    return filtered;
  };

  const filteredOpenHouses = getFilteredOpenHouses();
  const pendingCount = openHouses.filter(oh =>
    oh.status === 'proposed' || oh.status === 'approved'
  ).length;

  if (isLoading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-pulse p-4"> {/* Added p-4 here for consistency */}
        {Array(6).fill(0).map((_, i) => (
          <div key={i} className="luxury-card h-64 shimmer"></div>
        ))}
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Header */}
        <div className="app-card p-3">
          <div className="flex items-center gap-3">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate('/dashboard')}
              className="rounded-full h-8 w-8"
            >
              <ArrowLeft className="w-4 h-4" />
            </Button>
            <div className="flex-1">
              <h1 className="app-title text-lg">Open Houses</h1>
              <p className="app-subtitle text-xs">
                {pendingCount} pending open houses ‚Ä¢ Manage property showings
              </p>
            </div>
            <div className="flex items-center gap-2">
              <Button
                variant={filterMode === "pending" ? "default" : "outline"}
                size="sm"
                onClick={() => setFilterMode("pending")}
                className="h-8"
              >
                Pending ({pendingCount})
              </Button>
              <Button
                variant={filterMode === "all" ? "default" : "outline"}
                size="sm"
                onClick={() => setFilterMode("all")}
                className="h-8"
              >
                All ({openHouses.length})
              </Button>
            </div>
            <Button onClick={() => setShowModal(true)} className="app-button text-sm py-2 px-4">
              <Plus className="w-4 h-4 mr-1" />
              Schedule Open House
            </Button>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          {[
            { title: "Total Scheduled", value: openHouses.length, icon: Calendar, color: "#6366f1" },
            { title: "Approved", value: openHouses.filter(oh => oh.status === 'approved').length, icon: CheckCircle, color: "#10b981" },
            { title: "Completed", value: openHouses.filter(oh => oh.status === 'completed').length, icon: Calendar, color: "#8b5cf6" },
            { title: "Total Attendees", value: openHouses.reduce((sum, oh) => sum + (oh.attendee_count || 0), 0), icon: UserIcon, color: "#f59e0b" }
          ].map((stat, index) => (
            <div key={index} className="luxury-card p-6">
              <div className="flex items-start justify-between mb-4">
                <div>
                  <p className="luxury-body-text text-sm mb-2 opacity-70">{stat.title}</p>
                  <p className="luxury-text text-4xl">{stat.value}</p>
                </div>
                <div
                  className="p-3 rounded-xl"
                  style={{
                    background: `linear-gradient(135deg, ${stat.color}20 0%, ${stat.color}10 100%)`,
                    border: `1px solid ${stat.color}30`
                  }}
                >
                  <stat.icon className="w-6 h-6" style={{ color: stat.color }} />
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Open Houses Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredOpenHouses.map((oh) => {
            const property = properties.find(p => p.id === oh.property_id);
            const agent = users.find(u => u.id === oh.hosting_agent_id);
            const needsAction = oh.status === 'proposed' || oh.status === 'approved';
            const feedback = allFeedback.filter(f => f.open_house_id === oh.id);
            const avgRating = feedback.length > 0 
              ? (feedback.reduce((sum, f) => sum + (f.rating || 0), 0) / feedback.filter(f => f.rating).length).toFixed(1)
              : null;
            
            return (
              <div key={oh.id} className="app-card p-4 hover:shadow-md transition-all relative">
                {needsAction && (
                  <div className="absolute top-3 right-3 w-3 h-3 bg-red-500 rounded-full border-2 border-white shadow-lg animate-pulse"></div>
                )}
                
                <div className="flex items-start justify-between mb-4">
                  <div
                    className="luxury-badge"
                    style={{
                      background: `${getStatusColor(oh.status)}20`,
                      borderColor: `${getStatusColor(oh.status)}40`,
                      color: getStatusColor(oh.status)
                    }}
                  >
                    {oh.status?.replace('_', ' ')}
                  </div>
                  {oh.seller_approved && (
                    <CheckCircle className="w-5 h-5" style={{ color: '#10b981' }} />
                  )}
                </div>

                {property && (
                  <div className="mb-4">
                    <h3 className="luxury-text text-lg font-semibold mb-1">
                      {property.address}
                    </h3>
                    <p className="luxury-body-text text-sm opacity-70">
                      {property.city}, {property.state}
                    </p>
                  </div>
                )}

                <div className="space-y-3">
                  <div className="flex items-center gap-2 luxury-body-text text-sm">
                    <Calendar className="w-4 h-4" style={{ color: '#d4af37' }} />
                    <span>{format(parseISO(oh.date), 'MMMM d, yyyy')}</span>
                  </div>

                  <div className="flex items-center gap-2 luxury-body-text text-sm">
                    <Clock className="w-4 h-4" style={{ color: '#d4af37' }} />
                    <span>{oh.start_time} - {oh.end_time}</span>
                  </div>

                  {agent && (
                    <div className="flex items-center gap-2 luxury-body-text text-sm">
                      <UserIcon className="w-4 h-4" style={{ color: '#d4af37' }} />
                      <span>{agent.full_name || agent.email}</span>
                    </div>
                  )}

                  {oh.attendee_count > 0 && (
                    <div className="mt-4 pt-4 border-t" style={{ borderColor: 'rgba(212, 175, 55, 0.2)' }}>
                      <p className="luxury-body-text text-sm">
                        <span className="font-semibold">{oh.attendee_count}</span> attendees
                      </p>
                    </div>
                  )}

                  {oh.notes && (
                    <div className="mt-3">
                      <p className="luxury-body-text text-xs opacity-70">{oh.notes}</p>
                    </div>
                  )}

                  {feedback.length > 0 && (
                    <div className="mt-3 pt-3 border-t" style={{ borderColor: 'rgba(212, 175, 55, 0.2)' }}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <MessageSquare className="w-4 h-4" style={{ color: '#d4af37' }} />
                          <span className="luxury-body-text text-sm">
                            {feedback.length} feedback
                          </span>
                        </div>
                        {avgRating && (
                          <div className="flex items-center gap-1">
                            <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                            <span className="luxury-body-text text-sm font-semibold">{avgRating}</span>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                <div className="mt-4 pt-4 border-t space-y-2" style={{ borderColor: 'rgba(212, 175, 55, 0.2)' }}>
                  <button
                    onClick={() => window.open(`/OpenHouseFeedback?id=${oh.id}`, '_blank')}
                    className="w-full luxury-button py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                  >
                    <MessageSquare className="w-4 h-4 inline mr-2" />
                    Visitor Feedback Link
                  </button>
                  <button
                    onClick={() => {
                      setEditingOpenHouse(oh);
                      setShowModal(true);
                    }}
                    className="w-full luxury-button py-2"
                  >
                    Edit Details
                  </button>
                </div>
              </div>
            );
          })}
        </div>

        {filteredOpenHouses.length === 0 && (
          <div className="luxury-card p-16 text-center">
            <Calendar className="w-20 h-20 mx-auto mb-6" style={{ color: '#64748b' }} />
            {filterMode === "pending" ? (
              <>
                <h3 className="luxury-text text-2xl mb-3">No pending open houses</h3>
                <p className="luxury-body-text mb-6">All scheduled open houses are either published, completed or cancelled, or you haven't scheduled any yet.</p>
              </>
            ) : (
              <>
                <h3 className="luxury-text text-2xl mb-3">No open houses scheduled</h3>
                <p className="luxury-body-text mb-6">Schedule your first open house event</p>
              </>
            )}

            <button onClick={() => setShowModal(true)} className="luxury-button">
              Schedule Open House
            </button>
          </div>
        )}

        {/* Modal */}
        {showModal && (
          <OpenHouseModal
            openHouse={editingOpenHouse}
            properties={properties}
            users={users}
            onSave={handleSave}
            onClose={() => {
              setShowModal(false);
              setEditingOpenHouse(null);
            }}
          />
        )}
      </div>
    </div>
  );
}

// Simple Open House Modal
function OpenHouseModal({ openHouse, properties, users, onSave, onClose }) {
  // Check for initial date from calendar
  const initialDate = !openHouse ? sessionStorage.getItem('newOpenHouseDate') : null;
  
  const [formData, setFormData] = useState(openHouse || {
    property_id: "",
    date: initialDate || "",
    start_time: "",
    end_time: "",
    hosting_agent_id: "",
    status: "proposed",
    seller_approved: false,
    attendee_count: 0,
    notes: ""
  });

  // Clear initial date from session storage after using it
  React.useEffect(() => {
    if (initialDate) {
      sessionStorage.removeItem('newOpenHouseDate');
    }
  }, []);

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData); // `onSave` now expects the raw formData, parsing handled by mutation
  };

  return (
    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-2 border-slate-200 dark:border-slate-700">
        <div className="sticky top-0 bg-white dark:bg-slate-800 border-b-2 border-slate-200 dark:border-slate-700 p-6 z-10">
          <h2 className="text-2xl font-bold text-slate-900 dark:text-white">
            {openHouse?.id ? 'Edit Open House' : 'New Open House'}
          </h2>
          <p className="text-sm text-slate-600 dark:text-slate-300 mt-1">
            Fill in the details below to schedule a new open house event
          </p>
        </div>

        <form onSubmit={handleSubmit} className="p-6 space-y-6">
          <div>
            <label className="block text-sm font-semibold mb-2 text-slate-900 dark:text-white">
              Property *
            </label>
            <select
              value={formData.property_id}
              onChange={(e) => setFormData({...formData, property_id: e.target.value})}
              className="w-full px-4 py-3 rounded-xl border-2 border-slate-300 dark:border-slate-600 
                         bg-white dark:bg-slate-700 
                         text-slate-900 dark:text-white
                         focus:border-indigo-500 dark:focus:border-indigo-400 
                         focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800
                         transition-all outline-none"
              required
            >
              <option value="" className="text-slate-900 dark:text-white">Select Property</option>
              {properties.map(prop => (
                <option key={prop.id} value={prop.id} className="text-slate-900 dark:text-white bg-white dark:bg-slate-700">
                  {prop.address}
                </option>
              ))}
            </select>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold mb-2 text-slate-900 dark:text-white">
                Date *
              </label>
              <input
                type="date"
                value={formData.date}
                onChange={(e) => setFormData({...formData, date: e.target.value})}
                className="w-full px-4 py-3 rounded-xl border-2 border-slate-300 dark:border-slate-600 
                           bg-white dark:bg-slate-700 
                           text-slate-900 dark:text-white
                           focus:border-indigo-500 dark:focus:border-indigo-400 
                           focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800
                           transition-all outline-none"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-semibold mb-2 text-slate-900 dark:text-white">
                Status
              </label>
              <select
                value={formData.status}
                onChange={(e) => setFormData({...formData, status: e.target.value})}
                className="w-full px-4 py-3 rounded-xl border-2 border-slate-300 dark:border-slate-600 
                           bg-white dark:bg-slate-700 
                           text-slate-900 dark:text-white
                           focus:border-indigo-500 dark:focus:border-indigo-400 
                           focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800
                           transition-all outline-none"
              >
                <option value="proposed" className="text-slate-900 dark:text-white bg-white dark:bg-slate-700">Proposed</option>
                <option value="approved" className="text-slate-900 dark:text-white bg-white dark:bg-slate-700">Approved</option>
                <option value="published" className="text-slate-900 dark:text-white bg-white dark:bg-slate-700">Published</option>
                <option value="completed" className="text-slate-900 dark:text-white bg-white dark:bg-slate-700">Completed</option>
                <option value="cancelled" className="text-slate-900 dark:text-white bg-white dark:bg-slate-700">Cancelled</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold mb-2 text-slate-900 dark:text-white">
                Start Time *
              </label>
              <input
                type="time"
                value={formData.start_time}
                onChange={(e) => setFormData({...formData, start_time: e.target.value})}
                className="w-full px-4 py-3 rounded-xl border-2 border-slate-300 dark:border-slate-600 
                           bg-white dark:bg-slate-700 
                           text-slate-900 dark:text-white
                           focus:border-indigo-500 dark:focus:border-indigo-400 
                           focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800
                           transition-all outline-none"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-semibold mb-2 text-slate-900 dark:text-white">
                End Time *
              </label>
              <input
                type="time"
                value={formData.end_time}
                onChange={(e) => setFormData({...formData, end_time: e.target.value})}
                className="w-full px-4 py-3 rounded-xl border-2 border-slate-300 dark:border-slate-600 
                           bg-white dark:bg-slate-700 
                           text-slate-900 dark:text-white
                           focus:border-indigo-500 dark:focus:border-indigo-400 
                           focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800
                           transition-all outline-none"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-semibold mb-2 text-slate-900 dark:text-white">
                Hosting Agent
              </label>
              <select
                value={formData.hosting_agent_id}
                onChange={(e) => setFormData({...formData, hosting_agent_id: e.target.value})}
                className="w-full px-4 py-3 rounded-xl border-2 border-slate-300 dark:border-slate-600 
                           bg-white dark:bg-slate-700 
                           text-slate-900 dark:text-white
                           focus:border-indigo-500 dark:focus:border-indigo-400 
                           focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800
                           transition-all outline-none"
              >
                <option value="" className="text-slate-900 dark:text-white bg-white dark:bg-slate-700">Select Agent</option>
                {users.map(user => (
                  <option key={user.id} value={user.id} className="text-slate-900 dark:text-white bg-white dark:bg-slate-700">
                    {user.full_name || user.email}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold mb-2 text-slate-900 dark:text-white">
                Attendee Count
              </label>
              <input
                type="number"
                value={formData.attendee_count}
                onChange={(e) => setFormData({...formData, attendee_count: e.target.value})}
                className="w-full px-4 py-3 rounded-xl border-2 border-slate-300 dark:border-slate-600 
                           bg-white dark:bg-slate-700 
                           text-slate-900 dark:text-white
                           focus:border-indigo-500 dark:focus:border-indigo-400 
                           focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800
                           transition-all outline-none"
                min="0"
              />
            </div>
          </div>

          <div>
            <label className="flex items-center gap-3 cursor-pointer">
              <input
                type="checkbox"
                checked={formData.seller_approved}
                onChange={(e) => setFormData({...formData, seller_approved: e.target.checked})}
                className="w-5 h-5 rounded border-2 border-slate-300 dark:border-slate-600 
                           text-indigo-600 focus:ring-2 focus:ring-indigo-500 
                           bg-white dark:bg-slate-700"
              />
              <span className="text-sm font-semibold text-slate-900 dark:text-white">
                Seller Approved
              </span>
            </label>
          </div>

          <div>
            <label className="block text-sm font-semibold mb-2 text-slate-900 dark:text-white">
              Notes
            </label>
            <textarea
              value={formData.notes}
              onChange={(e) => setFormData({...formData, notes: e.target.value})}
              className="w-full px-4 py-3 rounded-xl border-2 border-slate-300 dark:border-slate-600 
                         bg-white dark:bg-slate-700 
                         text-slate-900 dark:text-white
                         focus:border-indigo-500 dark:focus:border-indigo-400 
                         focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800
                         transition-all outline-none resize-none"
              rows={3}
              placeholder="Add any additional notes or special instructions..."
            />
          </div>

          <div className="flex justify-end gap-3 pt-6 border-t-2 border-slate-200 dark:border-slate-700">
            <button
              type="button"
              onClick={onClose}
              className="px-6 py-3 rounded-xl font-semibold
                         bg-slate-100 dark:bg-slate-700 
                         text-slate-700 dark:text-slate-200
                         hover:bg-slate-200 dark:hover:bg-slate-600
                         transition-all border-2 border-slate-200 dark:border-slate-600"
            >
              Cancel
            </button>
            <button 
              type="submit" 
              className="px-6 py-3 rounded-xl font-semibold
                         bg-gradient-to-r from-indigo-600 to-purple-600 
                         text-white
                         hover:from-indigo-700 hover:to-purple-700
                         transition-all shadow-lg hover:shadow-xl"
            >
              {openHouse ? 'Update' : 'Schedule'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
import React, { useState, useEffect, useMemo } from "react";
import { base44 } from "@/api/base44Client";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { 
  Plus, 
  ArrowLeft, 
  Search,
  Star,
  Check,
  X,
  Clock,
  ZoomIn,
  RefreshCw,
  Image as ImageIcon,
  CheckCircle2
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { toast } from "sonner";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

import PhotoUpload from "../components/photos/PhotoUpload";
import PhotoLightbox from "../components/photos/PhotoLightbox";

export default function Photos() {
  const navigate = useNavigate();
  const [photos, setPhotos] = useState([]);
  const [properties, setProperties] = useState([]);
  const [users, setUsers] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [selectedStatus, setSelectedStatus] = useState("all");
  const [selectedCategory, setSelectedCategory] = useState("all");
  const [showUpload, setShowUpload] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [lightboxPhoto, setLightboxPhoto] = useState(null);
  const [lightboxIndex, setLightboxIndex] = useState(0);
  const [sortBy, setSortBy] = useState("newest");

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async (showRefreshIndicator = false) => {
    if (showRefreshIndicator) {
      setIsRefreshing(true);
    } else {
      setIsLoading(true);
    }

    try {
      const [user, photoData, propertyData, usersData] = await Promise.all([
        base44.auth.me(),
        base44.entities.Photo.list("-created_date"),
        base44.entities.Property.list(),
        base44.entities.User.list()
      ]);
      
      setCurrentUser(user);
      setPhotos(photoData || []);
      setProperties(propertyData || []);
      setUsers(usersData || []);
    } catch (error) {
      console.error("Error loading photos data:", error);
      toast.error("Failed to load photos");
    } finally {
      setIsLoading(false);
      setIsRefreshing(false);
    }
  };

  const handleManualRefresh = () => {
    loadData(true);
  };

  const filteredPhotos = useMemo(() => {
    let filtered = [...photos];

    // Filter by user role
    if (currentUser?.role === 'seller') {
      const userProperties = properties.filter(p => {
        try {
          const sellers = p.sellers_info ? JSON.parse(p.sellers_info) : [];
          return sellers.some(s => s.email === currentUser.email);
        } catch {
          return false;
        }
      }).map(p => p.id);
      filtered = filtered.filter(photo => userProperties.includes(photo.property_id));
    } else if (currentUser?.role === 'listing_agent') {
      const agentProperties = properties.filter(p => p.listing_agent_id === currentUser.id).map(p => p.id);
      filtered = filtered.filter(photo => agentProperties.includes(photo.property_id));
    }

    // Status filter
    if (selectedStatus !== "all") {
      filtered = filtered.filter(photo => photo.approval_status === selectedStatus);
    }

    // Category filter
    if (selectedCategory !== "all") {
      filtered = filtered.filter(photo => photo.category === selectedCategory);
    }

    // Search filter
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(photo => {
        const property = properties.find(p => p.id === photo.property_id);
        return (
          photo.caption?.toLowerCase().includes(query) ||
          property?.address?.toLowerCase().includes(query)
        );
      });
    }

    // Sort
    switch (sortBy) {
      case "newest":
        filtered.sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
        break;
      case "oldest":
        filtered.sort((a, b) => new Date(a.created_date) - new Date(b.created_date));
        break;
      case "property":
        filtered.sort((a, b) => {
          const propA = properties.find(p => p.id === a.property_id);
          const propB = properties.find(p => p.id === b.property_id);
          return (propA?.address || "").localeCompare(propB?.address || "");
        });
        break;
      default:
        break;
    }

    return filtered;
  }, [photos, selectedStatus, selectedCategory, searchQuery, sortBy, properties, currentUser]);

  const stats = useMemo(() => {
    const pending = filteredPhotos.filter(p => p.approval_status === 'pending').length;
    const approved = filteredPhotos.filter(p => p.approval_status === 'approved' || p.approval_status === 'broker_approved').length;
    const rejected = filteredPhotos.filter(p => p.approval_status === 'needs_changes').length;
    
    return { pending, approved, rejected, total: filteredPhotos.length };
  }, [filteredPhotos]);

  // Group photos by property
  const photosByProperty = useMemo(() => {
    const grouped = {};
    filteredPhotos.forEach(photo => {
      if (!grouped[photo.property_id]) {
        grouped[photo.property_id] = [];
      }
      grouped[photo.property_id].push(photo);
    });
    return grouped;
  }, [filteredPhotos]);

  const handlePhotoUpload = async (files, propertyId, caption, category) => {
    try {
      const uploadPromises = files.map(async (file) => {
        const { file_url } = await base44.integrations.Core.UploadFile({ file });
        return base44.entities.Photo.create({
          property_id: propertyId,
          file_url,
          caption,
          category: category || "interior",
          uploaded_by: currentUser.id,
          approval_status: "pending"
        });
      });

      await Promise.all(uploadPromises);
      await loadData();
      setShowUpload(false);
      toast.success(`${files.length} photo(s) uploaded successfully!`);
      window.dispatchEvent(new Event('refreshCounts'));
    } catch (error) {
      console.error("Error uploading photos:", error);
      toast.error("Failed to upload photos");
    }
  };

  const handleApprovalAction = async (photoId, action) => {
    try {
      const updateData = {
        approval_status: action === 'approve' ? 'approved' : 'needs_changes'
      };
      
      await base44.entities.Photo.update(photoId, updateData);
      await loadData();
      toast.success(`Photo ${action === 'approve' ? 'approved' : 'rejected'} successfully`);
      window.dispatchEvent(new Event('refreshCounts'));
    } catch (error) {
      console.error("Error updating photo approval:", error);
      toast.error("Failed to update photo status");
    }
  };

  const handlePhotoClick = (photo, index) => {
    setLightboxPhoto(photo);
    setLightboxIndex(index);
  };

  const handleLightboxClose = () => {
    setLightboxPhoto(null);
  };

  const handleLightboxNav = (direction) => {
    const newIndex = direction === 'next' 
      ? (lightboxIndex + 1) % filteredPhotos.length
      : (lightboxIndex - 1 + filteredPhotos.length) % filteredPhotos.length;
    
    setLightboxIndex(newIndex);
    setLightboxPhoto(filteredPhotos[newIndex]);
  };

  const handleSetPrimary = async (photoId) => {
    const photo = photos.find(p => p.id === photoId);
    if (!photo) return;

    try {
      const propertyPhotos = photos.filter(p => p.property_id === photo.property_id && p.id !== photoId);
      await Promise.all(propertyPhotos.map(p => 
        base44.entities.Photo.update(p.id, { is_primary: false })
      ));

      await base44.entities.Photo.update(photoId, { is_primary: true });
      
      await base44.entities.Property.update(photo.property_id, { 
        primary_photo_url: photo.file_url 
      });

      await loadData();
      toast.success("Primary photo updated successfully");
      window.dispatchEvent(new Event('refreshCounts'));
    } catch (error) {
      console.error("Error setting primary photo:", error);
      toast.error("Failed to set primary photo");
    }
  };

  const canUpload = currentUser?.role === 'listing_agent' || currentUser?.role === 'admin' || currentUser?.role === 'user';
  const canApprove = ['seller', 'broker', 'admin', 'user'].includes(currentUser?.role);

  const getPageTitle = () => {
    switch (currentUser?.role) {
      case 'seller': return 'Photo Approval';
      case 'broker': return 'Photo Review';
      case 'listing_agent': return 'Photo Management';
      default: return 'Property Photos';
    }
  };

  const getPageDescription = () => {
    switch (currentUser?.role) {
      case 'seller': return 'Review and approve photos for your properties';
      case 'broker': return 'Review and approve photos from your agents';
      case 'listing_agent': return 'Upload and manage photos for your listings';
      default: return 'View and manage property photos';
    }
  };

  if (isLoading) {
    return (
      <div className="space-y-6">
        <div className="flex items-center justify-center min-h-[60vh]">
          <div className="text-center">
            <ImageIcon className="w-16 h-16 text-slate-300 mx-auto mb-4 animate-pulse" />
            <p className="text-slate-600">Loading photos...</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div 
        className="rounded-2xl p-6 md:p-8 text-white relative overflow-hidden"
        style={{ background: 'linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%)' }}
      >
        <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div className="flex items-center gap-3">
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={() => navigate(-1)}
              className="text-white hover:bg-white/20 -ml-2"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="w-12 h-12 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center">
              <ImageIcon className="w-6 h-6 text-white" />
            </div>
            <div>
              <h1 className="text-2xl md:text-3xl font-bold">{getPageTitle()}</h1>
              <p className="text-white/80 text-sm">{getPageDescription()}</p>
            </div>
          </div>
          <div className="flex gap-2">
            <Button
              variant="outline"
              onClick={handleManualRefresh}
              disabled={isRefreshing}
              className="border-white/30 text-white hover:bg-white/20 bg-white/10"
            >
              <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
              Refresh
            </Button>
            {canUpload && (
              <Button 
                onClick={() => setShowUpload(true)}
                className="bg-white hover:bg-white/90"
                style={{ color: 'var(--theme-primary)' }}
              >
                <Plus className="w-4 h-4 mr-2" />
                Upload Photos
              </Button>
            )}
          </div>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-gradient-to-br from-slate-600 to-slate-800 text-white rounded-xl p-4 shadow-lg">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-white/80">Total Photos</p>
              <p className="text-2xl font-bold">{stats.total}</p>
            </div>
            <ImageIcon className="w-10 h-10 opacity-50" />
          </div>
        </div>

        <div className="bg-gradient-to-br from-yellow-500 to-amber-600 text-white rounded-xl p-4 shadow-lg">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-white/80">Pending</p>
              <p className="text-2xl font-bold">{stats.pending}</p>
            </div>
            <Clock className="w-10 h-10 opacity-50" />
          </div>
        </div>

        <div className="bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-xl p-4 shadow-lg">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-white/80">Approved</p>
              <p className="text-2xl font-bold">{stats.approved}</p>
            </div>
            <CheckCircle2 className="w-10 h-10 opacity-50" />
          </div>
        </div>

        <div className="bg-gradient-to-br from-blue-500 to-cyan-600 text-white rounded-xl p-4 shadow-lg">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-white/80">Properties</p>
              <p className="text-2xl font-bold">{Object.keys(photosByProperty).length}</p>
            </div>
            <ImageIcon className="w-10 h-10 opacity-50" />
          </div>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white dark:bg-slate-900 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700">
        <div className="flex flex-col lg:flex-row gap-3">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
            <Input
              placeholder="Search by property address or caption..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10"
            />
          </div>

          <Select value={selectedStatus} onValueChange={setSelectedStatus}>
            <SelectTrigger className="w-full lg:w-[180px]">
              <SelectValue placeholder="Status" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Status</SelectItem>
              <SelectItem value="pending">‚è≥ Pending</SelectItem>
              <SelectItem value="approved">‚úÖ Approved</SelectItem>
              <SelectItem value="needs_changes">‚ùå Needs Changes</SelectItem>
            </SelectContent>
          </Select>

          <Select value={selectedCategory} onValueChange={setSelectedCategory}>
            <SelectTrigger className="w-full lg:w-[150px]">
              <SelectValue placeholder="Category" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Categories</SelectItem>
              <SelectItem value="exterior">üè° Exterior</SelectItem>
              <SelectItem value="interior">üè† Interior</SelectItem>
              <SelectItem value="kitchen">üç≥ Kitchen</SelectItem>
              <SelectItem value="bathroom">üöø Bathroom</SelectItem>
              <SelectItem value="bedroom">üõèÔ∏è Bedroom</SelectItem>
              <SelectItem value="other">üìÅ Other</SelectItem>
            </SelectContent>
          </Select>

          <Select value={sortBy} onValueChange={setSortBy}>
            <SelectTrigger className="w-full lg:w-[140px]">
              <SelectValue placeholder="Sort" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="newest">Newest First</SelectItem>
              <SelectItem value="oldest">Oldest First</SelectItem>
              <SelectItem value="property">By Property</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>

      {/* Photos by Property */}
      {filteredPhotos.length === 0 ? (
        <div className="bg-white dark:bg-slate-900 rounded-xl p-12 text-center shadow-sm border border-slate-200 dark:border-slate-700">
          <ImageIcon className="w-16 h-16 text-slate-300 mx-auto mb-4" />
          <h3 className="text-lg font-semibold mb-2">No Photos Found</h3>
          <p className="text-slate-600 dark:text-slate-400 mb-4">
            {searchQuery || selectedStatus !== 'all' || selectedCategory !== 'all' 
              ? 'Try adjusting your filters'
              : 'Start by uploading photos for your properties'}
          </p>
          {canUpload && !searchQuery && selectedStatus === 'all' && (
            <Button onClick={() => setShowUpload(true)}>
              <Plus className="w-4 h-4 mr-2" />
              Upload Photos
            </Button>
          )}
        </div>
      ) : (
        <div className="space-y-6">
          {Object.entries(photosByProperty).map(([propertyId, propertyPhotos]) => {
            const property = properties.find(p => p.id === propertyId);
            if (!property) return null;

            const primaryPhoto = propertyPhotos.find(p => p.is_primary);
            const pendingCount = propertyPhotos.filter(p => p.approval_status === 'pending').length;

            return (
              <div key={propertyId} className="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                {/* Property Header */}
                <div 
                  className="p-4 border-b border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                  onClick={() => navigate(createPageUrl(`PropertyDetail?id=${propertyId}`))}
                >
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <ImageIcon className="w-5 h-5 text-white" />
                      </div>
                      <div>
                        <h3 className="font-semibold text-slate-900 dark:text-white">{property.address}</h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400">
                          {property.city}, {property.state}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Badge variant="outline" className="text-xs">
                        {propertyPhotos.length} photos
                      </Badge>
                      {pendingCount > 0 && (
                        <Badge className="bg-yellow-100 text-yellow-700 text-xs">
                          {pendingCount} pending
                        </Badge>
                      )}
                      {primaryPhoto && (
                        <Badge className="bg-blue-100 text-blue-700 text-xs">
                          <Star className="w-3 h-3 mr-1 fill-blue-700" />
                          Primary set
                        </Badge>
                      )}
                    </div>
                  </div>
                </div>

                {/* Photos Grid */}
                <div className="p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                  {propertyPhotos.map((photo, index) => (
                    <div
                      key={photo.id}
                      className="group relative aspect-square rounded-lg overflow-hidden border-2 border-slate-200 dark:border-slate-700 hover:border-indigo-400 dark:hover:border-indigo-600 transition-all cursor-pointer"
                      onClick={() => handlePhotoClick(photo, filteredPhotos.indexOf(photo))}
                    >
                      <img
                        src={photo.file_url}
                        alt={photo.caption || `Photo ${index + 1}`}
                        className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      />
                      
                      {/* Overlay with actions */}
                      <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                        {/* Caption */}
                        <div className="absolute bottom-2 left-2 right-2">
                          <p className="text-white text-xs font-medium truncate mb-2">
                            {photo.caption || photo.category}
                          </p>
                          
                          {/* Action Buttons */}
                          {canApprove && photo.approval_status === 'pending' && (
                            <div className="flex gap-1">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleApprovalAction(photo.id, 'approve');
                                }}
                                className="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1.5 px-2 rounded-md flex items-center justify-center gap-1 transition-colors"
                              >
                                <Check className="w-3 h-3" />
                                Approve
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleApprovalAction(photo.id, 'reject');
                                }}
                                className="flex-1 bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1.5 px-2 rounded-md flex items-center justify-center gap-1 transition-colors"
                              >
                                <X className="w-3 h-3" />
                                Reject
                              </button>
                            </div>
                          )}
                          
                          {/* Set Primary Button */}
                          {!photo.is_primary && (photo.approval_status === 'approved' || photo.approval_status === 'broker_approved' || photo.approval_status === 'seller_approved') && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                handleSetPrimary(photo.id);
                              }}
                              className="w-full bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1.5 px-2 rounded-md flex items-center justify-center gap-1 transition-colors"
                            >
                              <Star className="w-3 h-3" />
                              Set as Primary
                            </button>
                          )}
                        </div>
                      </div>

                      {/* Status Badge */}
                      <div className="absolute top-2 right-2">
                        {(photo.approval_status === 'approved' || photo.approval_status === 'broker_approved' || photo.approval_status === 'seller_approved') && (
                          <div className="w-7 h-7 rounded-full bg-green-500 flex items-center justify-center shadow-lg border-2 border-white">
                            <Check className="w-4 h-4 text-white" />
                          </div>
                        )}
                        {photo.approval_status === 'pending' && (
                          <div className="w-7 h-7 rounded-full bg-yellow-500 flex items-center justify-center shadow-lg border-2 border-white animate-pulse">
                            <Clock className="w-4 h-4 text-white" />
                          </div>
                        )}
                        {photo.approval_status === 'needs_changes' && (
                          <div className="w-7 h-7 rounded-full bg-red-500 flex items-center justify-center shadow-lg border-2 border-white">
                            <X className="w-4 h-4 text-white" />
                          </div>
                        )}
                      </div>

                      {/* Primary Badge */}
                      {photo.is_primary && (
                        <div className="absolute top-2 left-2">
                          <div className="bg-blue-500 rounded-full px-2 py-0.5 flex items-center gap-1 shadow-lg border border-white">
                            <Star className="w-3 h-3 text-white fill-white" />
                            <span className="text-white text-[10px] font-bold">PRIMARY</span>
                          </div>
                        </div>
                      )}

                      {/* Zoom hint */}
                      <div 
                        className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"
                        style={{ display: canApprove && photo.approval_status === 'pending' ? 'none' : 'block' }}
                      >
                        <div className="w-10 h-10 rounded-full bg-white/80 flex items-center justify-center">
                          <ZoomIn className="w-5 h-5 text-slate-700" />
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Upload Modal */}
      {showUpload && canUpload && (
        <PhotoUpload
          properties={properties.filter(p => p.listing_agent_id === currentUser?.id)}
          onUpload={handlePhotoUpload}
          onClose={() => setShowUpload(false)}
        />
      )}

      {/* Lightbox */}
      {lightboxPhoto && (
        <PhotoLightbox
          photo={lightboxPhoto}
          photos={filteredPhotos}
          currentIndex={lightboxIndex}
          properties={properties}
          users={users}
          onClose={handleLightboxClose}
          onNext={() => handleLightboxNav('next')}
          onPrev={() => handleLightboxNav('prev')}
          onApprove={(photoId) => handleApprovalAction(photoId, 'approve')}
          onReject={(photoId) => handleApprovalAction(photoId, 'reject')}
          onSetPrimary={handleSetPrimary}
          canApprove={canApprove}
          userRole={currentUser?.role}
        />
      )}
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from "@/components/ui/tabs";
import {
  Calendar,
  Plus,
  CheckSquare,
  Clock,
  Target,
  Sparkles,
  Trash2,
  ArrowLeft,
  Users,
  Home,
  Phone,
  TrendingUp,
  Sun,
  CloudRain,
  AlertCircle,
  Zap,
  DollarSign,
  FileText,
  Camera
} from "lucide-react";
import { toast } from "sonner";
import { format, addDays, differenceInDays } from "date-fns";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";

export default function PlanNextDay() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const tomorrow = addDays(new Date(), 1);
  const tomorrowDate = format(tomorrow, "yyyy-MM-dd");
  const tomorrowDay = format(tomorrow, "EEEE").toLowerCase();

  const [newTask, setNewTask] = useState({
    title: "",
    description: "",
    priority: "medium",
    task_type: "general"
  });
  const [aiSuggestions, setAiSuggestions] = useState([]);
  const [smartInsights, setSmartInsights] = useState([]);
  const [isGeneratingSuggestions, setIsGeneratingSuggestions] = useState(false);
  const [activeTab, setActiveTab] = useState("overview");

  const { data: user } = useQuery({
    queryKey: ["user"],
    queryFn: () => base44.auth.me()
  });

  const { data: leads = [] } = useQuery({
    queryKey: ["leads"],
    queryFn: () => base44.entities.Lead.list(),
    enabled: !!user
  });

  const { data: properties = [] } = useQuery({
    queryKey: ["properties"],
    queryFn: () => base44.entities.Property.list(),
    enabled: !!user
  });

  const { data: buyers = [] } = useQuery({
    queryKey: ["buyers"],
    queryFn: () => base44.entities.Buyer.list(),
    enabled: !!user
  });

  const { data: transactions = [] } = useQuery({
    queryKey: ["transactions"],
    queryFn: () => base44.entities.Transaction.list(),
    enabled: !!user
  });

  const { data: allTasks = [] } = useQuery({
    queryKey: ["allTasks"],
    queryFn: () => base44.entities.Task.list(),
    enabled: !!user
  });

  const { data: leadActivities = [] } = useQuery({
    queryKey: ["leadActivities"],
    queryFn: () => base44.entities.LeadActivity.list(),
    enabled: !!user
  });

  const { data: weatherData } = useQuery({
    queryKey: ["weather"],
    queryFn: async () => {
      if (!user?.office_address) return null;
      try {
        const result = await base44.integrations.Core.InvokeLLM({
          prompt: `What will the weather be like tomorrow in ${user.office_address}? Check temperature and if it will rain. Return: temperature in Fahrenheit, weather condition, and if it's suitable for outdoor door knocking (good if temp between 50-85¬∞F and no rain/storms).`,
          add_context_from_internet: true,
          response_json_schema: {
            type: "object",
            properties: {
              temperature: { type: "number" },
              condition: { type: "string" },
              suitable_for_outdoor: { type: "boolean" }
            }
          }
        });
        return result;
      } catch (e) {
        return null;
      }
    },
    enabled: !!user?.office_address,
    staleTime: 60 * 60 * 1000
  });

  const { data: tomorrowTasks = [] } = useQuery({
    queryKey: ["tomorrowTasks", tomorrowDate],
    queryFn: async () => {
      const allTasks = await base44.entities.Task.list();
      return allTasks.filter(
        task => task.due_date === tomorrowDate && task.status !== "completed" && task.status !== "cancelled"
      );
    },
    enabled: !!user
  });

  const { data: appointments = [] } = useQuery({
    queryKey: ["tomorrowAppointments", tomorrowDate],
    queryFn: async () => {
      const allAppointments = await base44.entities.Appointment.list();
      return allAppointments.filter(
        apt => apt.scheduled_date?.startsWith(tomorrowDate) && apt.status !== "cancelled" && apt.status !== "completed"
      );
    },
    enabled: !!user
  });

  const generateSmartInsights = () => {
    const insights = [];
    const today = new Date();

    const staleLeads = leads.filter(lead => {
      if (!lead.created_date || lead.status === 'closed') return false;
      const lastActivity = leadActivities
        .filter(a => a.lead_id === lead.id)
        .sort((a, b) => new Date(b.created_date) - new Date(a.created_date))[0];
      
      const lastContactDate = lastActivity ? new Date(lastActivity.created_date) : new Date(lead.created_date);
      const daysSince = differenceInDays(today, lastContactDate);
      return daysSince >= 7;
    });

    if (staleLeads.length > 0) {
      insights.push({
        type: "urgent",
        icon: Users,
        title: `${staleLeads.length} leads need follow-up`,
        description: "Haven't been contacted in 7+ days",
        action: "Follow up with cold leads",
        priority: "high",
        task_type: "general",
        color: "bg-red-50 border-red-200 dark:bg-red-900/20"
      });
    }

    const activeProperties = properties.filter(p => p.status === 'active');
    if (activeProperties.length > 0) {
      insights.push({
        type: "info",
        icon: Home,
        title: `${activeProperties.length} active listings`,
        description: "Monitor and promote your listings",
        action: "Review listing performance and update marketing",
        priority: "medium",
        task_type: "marketing",
        color: "bg-blue-50 border-blue-200 dark:bg-blue-900/20"
      });
    }

    const activeTransactions = transactions.filter(t => t.status === 'active' || t.status === 'pending');
    if (activeTransactions.length > 0) {
      insights.push({
        type: "important",
        icon: FileText,
        title: `${activeTransactions.length} active transactions`,
        description: "Keep deals moving forward",
        action: "Check transaction status and follow up on pending items",
        priority: "high",
        task_type: "contract",
        color: "bg-purple-50 border-purple-200 dark:bg-purple-900/20"
      });
    }

    const hotBuyers = buyers.filter(b => b.status === 'active' && b.timeline === 'immediate');
    if (hotBuyers.length > 0) {
      insights.push({
        type: "opportunity",
        icon: DollarSign,
        title: `${hotBuyers.length} ready buyers`,
        description: "Looking to purchase immediately",
        action: "Send property matches to hot buyers",
        priority: "high",
        task_type: "general",
        color: "bg-green-50 border-green-200 dark:bg-green-900/20"
      });
    }

    if (weatherData?.suitable_for_outdoor) {
      insights.push({
        type: "tip",
        icon: Sun,
        title: "Perfect weather for door knocking",
        description: `${weatherData.temperature}¬∞F, ${weatherData.condition} - Great for outdoor prospecting`,
        action: "Schedule door knocking session in target neighborhood",
        priority: "medium",
        task_type: "marketing",
        color: "bg-yellow-50 border-yellow-200 dark:bg-yellow-900/20"
      });
      
      insights.push({
        type: "tip",
        icon: Home,
        title: "Ideal showing weather",
        description: `${weatherData.temperature}¬∞F, ${weatherData.condition}`,
        action: "Schedule property showings or open house",
        priority: "medium",
        task_type: "general",
        color: "bg-green-50 border-green-200 dark:bg-green-900/20"
      });
    }

    const overdueTasksCount = allTasks.filter(t => {
      if (t.status === 'completed' || t.status === 'cancelled') return false;
      const dueDate = new Date(t.due_date);
      return dueDate < today;
    }).length;

    if (overdueTasksCount > 0) {
      insights.push({
        type: "warning",
        icon: AlertCircle,
        title: `${overdueTasksCount} overdue tasks`,
        description: "Don't let important work slip",
        action: "Complete or reschedule overdue tasks",
        priority: "critical",
        task_type: "general",
        color: "bg-orange-50 border-orange-200 dark:bg-orange-900/20"
      });
    }

    setSmartInsights(insights);
  };

  const generateAISuggestions = async () => {
    setIsGeneratingSuggestions(true);
    try {
      const contextData = {
        leads_count: leads.length,
        stale_leads: leads.filter(l => {
          const lastActivity = leadActivities.filter(a => a.lead_id === l.id).sort((a, b) => new Date(b.created_date) - new Date(a.created_date))[0];
          const lastContactDate = lastActivity ? new Date(lastActivity.created_date) : new Date(l.created_date);
          return differenceInDays(new Date(), lastContactDate) >= 7;
        }).length,
        active_properties: properties.filter(p => p.status === 'active').length,
        active_transactions: transactions.filter(t => t.status === 'active').length,
        hot_buyers: buyers.filter(b => b.status === 'active' && b.timeline === 'immediate').length,
        day_of_week: tomorrowDay,
        weather: weatherData?.condition || 'unknown'
      };

      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `Generate 6 personalized task suggestions for a real estate agent's tomorrow (${format(tomorrow, "EEEE, MMMM d, yyyy")}).

Context:
- ${contextData.leads_count} total leads, ${contextData.stale_leads} need follow-up
- ${contextData.active_properties} active listings
- ${contextData.active_transactions} transactions in progress
- ${contextData.hot_buyers} hot buyers ready to purchase
- Day: ${contextData.day_of_week}
- Weather: ${contextData.weather}

Based on this data, suggest specific actionable tasks. Include:
- Specific lead follow-up tasks
- Property marketing activities
- Transaction management
- Buyer outreach
- Business development based on day of week
- Weather-appropriate activities

Make suggestions specific and actionable.`,
        response_json_schema: {
          type: "object",
          properties: {
            suggestions: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  title: { type: "string" },
                  description: { type: "string" },
                  priority: { type: "string" },
                  task_type: { type: "string" },
                  time_estimate: { type: "string" }
                }
              }
            }
          }
        }
      });
      
      setAiSuggestions(result.suggestions || []);
    } catch (error) {
      console.error("Error generating suggestions:", error);
      toast.error("Failed to generate AI suggestions");
    } finally {
      setIsGeneratingSuggestions(false);
    }
  };

  useEffect(() => {
    if (user && leads.length > 0) {
      generateSmartInsights();
    }
  }, [user, leads, properties, transactions, buyers, allTasks, weatherData]);

  const applyDayTemplate = async (templateType) => {
    const templates = {
      prospecting: [
        { title: "Morning lead calls (9-11am)", description: "Call 10 new leads", priority: "high", task_type: "general" },
        { title: "Follow up with hot prospects", description: "Contact interested leads from this week", priority: "high", task_type: "general" },
        { title: "Door knocking session", description: "Target neighborhood farming area", priority: "medium", task_type: "marketing" },
        { title: "Send market updates to sphere", description: "Email newsletter with latest market trends", priority: "medium", task_type: "marketing" },
        { title: "Social media engagement", description: "Post and respond to comments", priority: "low", task_type: "marketing" }
      ],
      showings: [
        { title: "Confirm tomorrow's showings", description: "Call all clients to confirm appointment times", priority: "critical", task_type: "general" },
        { title: "Prepare showing materials", description: "Print property details and comps", priority: "high", task_type: "documentation" },
        { title: "Check lockbox codes", description: "Verify access to all properties", priority: "high", task_type: "general" },
        { title: "Plan optimal route", description: "Map out efficient showing schedule", priority: "medium", task_type: "general" },
        { title: "Prepare buyer feedback forms", description: "Get ready to collect client feedback", priority: "medium", task_type: "documentation" }
      ],
      admin: [
        { title: "Review and respond to emails", description: "Clear inbox and follow up", priority: "high", task_type: "general" },
        { title: "Update CRM", description: "Log all recent activities and notes", priority: "medium", task_type: "documentation" },
        { title: "Review transaction checklist", description: "Ensure nothing is falling through cracks", priority: "high", task_type: "contract" },
        { title: "Expense tracking", description: "Log receipts and update budget", priority: "medium", task_type: "general" },
        { title: "Schedule next week appointments", description: "Book showings and meetings", priority: "medium", task_type: "general" }
      ],
      marketing: [
        { title: "Create property listing content", description: "Photos, descriptions, virtual tours", priority: "high", task_type: "marketing" },
        { title: "Schedule social media posts", description: "Plan week's content calendar", priority: "high", task_type: "marketing" },
        { title: "Send just listed/sold postcards", description: "Farm neighborhood marketing", priority: "medium", task_type: "marketing" },
        { title: "Update website listings", description: "Ensure all properties current", priority: "medium", task_type: "marketing" },
        { title: "Client appreciation outreach", description: "Call past clients to check in", priority: "low", task_type: "general" }
      ]
    };

    const tasks = templates[templateType] || [];
    
    try {
      for (const task of tasks) {
        await createTaskMutation.mutateAsync(task);
      }
      toast.success(`${tasks.length} tasks added from ${templateType} template`);
    } catch (error) {
      toast.error("Failed to apply template");
    }
  };

  const createTaskMutation = useMutation({
    mutationFn: async (taskData) => {
      if (!user?.id) {
        throw new Error("User not loaded");
      }
      
      const taskToCreate = {
        title: taskData.title,
        description: taskData.description || "",
        assigned_to: user.id,
        due_date: tomorrowDate,
        status: "pending",
        priority: taskData.priority || "medium",
        task_type: taskData.task_type || "general"
      };
      
      return await base44.entities.Task.create(taskToCreate);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["tomorrowTasks"] });
      setNewTask({ title: "", description: "", priority: "medium", task_type: "general" });
      toast.success("Task added!");
    },
    onError: (error) => {
      toast.error("Failed to create task: " + error.message);
    }
  });

  const deleteTaskMutation = useMutation({
    mutationFn: (taskId) => base44.entities.Task.delete(taskId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["tomorrowTasks"] });
      toast.success("Task removed");
    }
  });

  const handleAddTask = () => {
    if (!newTask.title.trim()) {
      toast.error("Please enter a task title");
      return;
    }
    if (!user) {
      toast.error("Please wait, loading user data...");
      return;
    }
    createTaskMutation.mutate(newTask);
  };

  const getPriorityColor = (priority) => {
    switch (priority) {
      case "critical": return "bg-red-100 text-red-700 border-red-300";
      case "high": return "bg-orange-100 text-orange-700 border-orange-300";
      case "medium": return "bg-yellow-100 text-yellow-700 border-yellow-300";
      case "low": return "bg-green-100 text-green-700 border-green-300";
      default: return "bg-slate-100 text-slate-700 border-slate-300";
    }
  };

  return (
    <div className="space-y-6">
      <Card>
        <CardContent className="p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(-1)}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center">
              <Calendar className="w-7 h-7 text-white" />
            </div>
            <div className="flex-1">
              <h1 className="text-3xl font-bold">Smart Day Planner</h1>
              <p className="text-slate-600 dark:text-slate-400">
                {format(tomorrow, "EEEE, MMMM d, yyyy")}
              </p>
              {weatherData && (
                <div className="flex items-center gap-2 mt-1">
                  {weatherData.suitable_for_outdoor ? (
                    <Sun className="w-4 h-4 text-yellow-600" />
                  ) : (
                    <CloudRain className="w-4 h-4 text-slate-600" />
                  )}
                  <span className="text-sm text-slate-600 dark:text-slate-400">
                    {weatherData.temperature}¬∞F, {weatherData.condition}
                  </span>
                </div>
              )}
            </div>
            <Button
              onClick={generateAISuggestions}
              disabled={isGeneratingSuggestions}
              className="bg-gradient-to-r from-indigo-600 to-purple-600"
            >
              <Sparkles className="w-4 h-4 mr-2" />
              {isGeneratingSuggestions ? "Generating..." : "AI Suggestions"}
            </Button>
          </div>
        </CardContent>
      </Card>

      <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
        <TabsList className="grid grid-cols-4 w-full max-w-2xl">
          <TabsTrigger value="overview">Overview</TabsTrigger>
          <TabsTrigger value="insights">
            Smart Insights
            {smartInsights.length > 0 && (
              <Badge className="ml-2 bg-red-500">{smartInsights.length}</Badge>
            )}
          </TabsTrigger>
          <TabsTrigger value="templates">Templates</TabsTrigger>
          <TabsTrigger value="tasks">Your Tasks</TabsTrigger>
        </TabsList>

        <TabsContent value="overview" className="space-y-6">
          {smartInsights.length > 0 && (
            <Card className="bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border-amber-200">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Zap className="w-5 h-5 text-amber-600" />
                  Smart Insights - Action Needed
                  <Badge className="bg-red-500 ml-auto">{smartInsights.length}</Badge>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {smartInsights.slice(0, 4).map((insight, idx) => {
                    const Icon = insight.icon;
                    return (
                      <div key={idx} className={`p-3 border-2 rounded-lg ${insight.color}`}>
                        <div className="flex items-start gap-2">
                          <Icon className="w-5 h-5 flex-shrink-0 mt-0.5" />
                          <div className="flex-1 min-w-0">
                            <h4 className="font-semibold text-sm mb-1">{insight.title}</h4>
                            <p className="text-xs text-slate-600 mb-2">{insight.description}</p>
                            <Button
                              size="sm"
                              className="text-xs h-7"
                              onClick={() => {
                                createTaskMutation.mutate({
                                  title: insight.title,
                                  description: insight.action,
                                  priority: insight.priority,
                                  task_type: insight.task_type
                                });
                              }}
                            >
                              <Plus className="w-3 h-3 mr-1" />
                              Add Task
                            </Button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                {smartInsights.length > 4 && (
                  <Button
                    variant="outline"
                    size="sm"
                    className="w-full mt-3"
                    onClick={() => setActiveTab("insights")}
                  >
                    View All {smartInsights.length} Insights
                  </Button>
                )}
              </CardContent>
            </Card>
          )}

          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-slate-600 mb-1">Planned Tasks</p>
                    <p className="text-3xl font-bold text-indigo-600">{tomorrowTasks.length}</p>
                  </div>
                  <CheckSquare className="w-10 h-10 text-indigo-600 opacity-20" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-slate-600 mb-1">Appointments</p>
                    <p className="text-3xl font-bold text-purple-600">{appointments.length}</p>
                  </div>
                  <Clock className="w-10 h-10 text-purple-600 opacity-20" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-slate-600 mb-1">Stale Leads</p>
                    <p className="text-3xl font-bold text-orange-600">
                      {leads.filter(l => {
                        const lastActivity = leadActivities.filter(a => a.lead_id === l.id).sort((a, b) => new Date(b.created_date) - new Date(a.created_date))[0];
                        const lastContactDate = lastActivity ? new Date(lastActivity.created_date) : new Date(l.created_date);
                        return differenceInDays(new Date(), lastContactDate) >= 7;
                      }).length}
                    </p>
                  </div>
                  <Users className="w-10 h-10 text-orange-600 opacity-20" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-slate-600 mb-1">Hot Deals</p>
                    <p className="text-3xl font-bold text-green-600">
                      {transactions.filter(t => t.status === 'active').length}
                    </p>
                  </div>
                  <TrendingUp className="w-10 h-10 text-green-600 opacity-20" />
                </div>
              </CardContent>
            </Card>
          </div>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Plus className="w-5 h-5" />
                Add New Task for Tomorrow
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <Input
                placeholder="Task title"
                value={newTask.title}
                onChange={(e) => setNewTask({ ...newTask, title: e.target.value })}
              />
              <Textarea
                placeholder="Task description (optional)"
                value={newTask.description}
                onChange={(e) => setNewTask({ ...newTask, description: e.target.value })}
                rows={2}
              />
              <div className="flex gap-4">
                <Select
                  value={newTask.priority}
                  onValueChange={(value) => setNewTask({ ...newTask, priority: value })}
                >
                  <SelectTrigger className="w-40">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="low">Low Priority</SelectItem>
                    <SelectItem value="medium">Medium Priority</SelectItem>
                    <SelectItem value="high">High Priority</SelectItem>
                    <SelectItem value="critical">Critical</SelectItem>
                  </SelectContent>
                </Select>
                <Select
                  value={newTask.task_type}
                  onValueChange={(value) => setNewTask({ ...newTask, task_type: value })}
                >
                  <SelectTrigger className="w-40">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="general">General</SelectItem>
                    <SelectItem value="contract">Contract</SelectItem>
                    <SelectItem value="inspection">Inspection</SelectItem>
                    <SelectItem value="financing">Financing</SelectItem>
                    <SelectItem value="marketing">Marketing</SelectItem>
                    <SelectItem value="documentation">Documentation</SelectItem>
                    <SelectItem value="closing">Closing</SelectItem>
                  </SelectContent>
                </Select>
                <Button
                  onClick={handleAddTask}
                  disabled={createTaskMutation.isPending || !user}
                  className="ml-auto"
                >
                  <Plus className="w-4 h-4 mr-2" />
                  {createTaskMutation.isPending ? "Adding..." : "Add Task"}
                </Button>
              </div>
            </CardContent>
          </Card>

          {appointments.length > 0 && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Clock className="w-5 h-5" />
                  Tomorrow's Appointments
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {appointments.map((apt) => (
                    <div
                      key={apt.id}
                      className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg"
                    >
                      <div className="flex items-start justify-between">
                        <div>
                          <h4 className="font-semibold">{apt.title}</h4>
                          <p className="text-sm text-slate-600 dark:text-slate-400">
                            {format(new Date(apt.scheduled_date), "h:mm a")}
                          </p>
                          {apt.location && (
                            <p className="text-sm text-slate-500 mt-1">{apt.location}</p>
                          )}
                        </div>
                        <Badge variant="outline" className="bg-purple-50 text-purple-700 border-purple-300">
                          {apt.appointment_type}
                        </Badge>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}

          {tomorrowTasks.length > 0 && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <CheckSquare className="w-5 h-5" />
                  Tomorrow's Task List ({tomorrowTasks.length})
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {tomorrowTasks.map((task) => {
                    const getTaskNavigationUrl = (task) => {
                      const title = task.title.toLowerCase();
                      const description = (task.description || '').toLowerCase();
                      const combined = title + ' ' + description;

                      if (combined.includes('door knock')) return 'DoorKnockingGuide';
                      if (combined.includes('social media') || combined.includes('post')) return 'SocialMediaPosting';
                      if (combined.includes('call') || combined.includes('phone') || combined.includes('follow up')) return 'Leads';
                      if (combined.includes('email') || combined.includes('message')) return 'AIEmailAssistant';
                      if (combined.includes('showing') || combined.includes('tour')) return 'Showings';
                      if (combined.includes('listing') || combined.includes('property')) return 'Properties';
                      if (combined.includes('marketing') || combined.includes('campaign')) return 'MarketingCampaigns';
                      if (combined.includes('open house')) return 'OpenHouses';
                      if (combined.includes('contract') || combined.includes('document')) return 'Documents';
                      if (combined.includes('transaction')) return 'Transactions';
                      return null;
                    };

                    const navUrl = getTaskNavigationUrl(task);

                    return (
                      <div
                        key={task.id}
                        className="p-4 bg-white dark:bg-slate-800 border-2 border-green-200 dark:border-green-900 rounded-lg hover:shadow-md transition-shadow cursor-pointer"
                        onClick={() => navUrl && navigate(createPageUrl(navUrl))}
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                              <CheckSquare className="w-4 h-4 text-green-600" />
                              <h4 className="font-semibold">{task.title}</h4>
                              <Badge className={getPriorityColor(task.priority)}>
                                {task.priority}
                              </Badge>
                              {task.task_type && (
                                <Badge variant="outline">{task.task_type}</Badge>
                              )}
                              {navUrl && (
                                <Badge className="bg-indigo-100 text-indigo-700 text-xs">
                                  Click for details
                                </Badge>
                              )}
                            </div>
                            {task.description && (
                              <p className="text-sm text-slate-600 dark:text-slate-400 ml-6">
                                {task.description}
                              </p>
                            )}
                          </div>
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteTaskMutation.mutate(task.id);
                            }}
                            className="text-red-500 hover:text-red-700 hover:bg-red-50"
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          )}

          {aiSuggestions.length > 0 && (
            <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Sparkles className="w-5 h-5 text-indigo-600" />
                  AI Suggested Activities
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {aiSuggestions.map((suggestion, idx) => (
                    <div
                      key={idx}
                      className="p-4 bg-white dark:bg-slate-800 border border-indigo-200 dark:border-indigo-800 rounded-lg"
                    >
                      <div className="space-y-3">
                        <div>
                          <div className="flex items-start justify-between gap-2 mb-2">
                            <h4 className="font-semibold flex-1">{suggestion.title}</h4>
                            <Badge variant="outline" className="text-xs">
                              {suggestion.priority || "medium"}
                            </Badge>
                          </div>
                          <p className="text-sm text-slate-600 dark:text-slate-400">
                            {suggestion.description}
                          </p>
                        </div>
                        <Button
                          size="sm"
                          className="w-full bg-indigo-600 hover:bg-indigo-700"
                          onClick={() => {
                            if (!user) {
                              toast.error("Please wait, loading user data...");
                              return;
                            }
                            createTaskMutation.mutate({
                              title: suggestion.title,
                              description: suggestion.description,
                              priority: suggestion.priority || "medium",
                              task_type: suggestion.task_type || "general"
                            });
                          }}
                          disabled={createTaskMutation.isPending || !user}
                        >
                          <Plus className="w-4 h-4 mr-2" />
                          Add to Tomorrow
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}
        </TabsContent>

        <TabsContent value="insights" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Smart Insights Based on Your Data</CardTitle>
              <p className="text-sm text-slate-600">
                Click "Add Task" to quickly add these insights to your plan
              </p>
            </CardHeader>
            <CardContent>
              {smartInsights.length > 0 ? (
                <div className="space-y-3">
                  {smartInsights.map((insight, idx) => {
                    const Icon = insight.icon;
                    return (
                      <div
                        key={idx}
                        className={`p-4 border-2 rounded-lg ${insight.color}`}
                      >
                        <div className="flex items-start gap-3">
                          <Icon className="w-6 h-6 flex-shrink-0 mt-1" />
                          <div className="flex-1">
                            <h4 className="font-semibold mb-1">{insight.title}</h4>
                            <p className="text-sm text-slate-600 dark:text-slate-400 mb-2">
                              {insight.description}
                            </p>
                            <p className="text-sm font-medium">{insight.action}</p>
                          </div>
                          <Button
                            size="sm"
                            onClick={() => {
                              createTaskMutation.mutate({
                                title: insight.title,
                                description: insight.action,
                                priority: insight.priority,
                                task_type: insight.task_type
                              });
                            }}
                            disabled={createTaskMutation.isPending}
                          >
                            <Plus className="w-4 h-4 mr-1" />
                            Add Task
                          </Button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <div className="text-center py-8">
                  <Target className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                  <p className="text-slate-600">No insights available yet</p>
                  <p className="text-sm text-slate-500">
                    Add more data to get personalized suggestions
                  </p>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="templates" className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => applyDayTemplate('prospecting')}>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Phone className="w-5 h-5" />
                  Prospecting Day
                </CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-slate-600 mb-4">
                  Perfect for lead generation and outreach
                </p>
                <ul className="text-sm space-y-1 text-slate-600">
                  <li>‚Ä¢ Morning lead calls</li>
                  <li>‚Ä¢ Follow up hot prospects</li>
                  <li>‚Ä¢ Door knocking</li>
                  <li>‚Ä¢ Email campaigns</li>
                  <li>‚Ä¢ Social media engagement</li>
                </ul>
                <Button className="w-full mt-4" disabled={createTaskMutation.isPending}>
                  <Plus className="w-4 h-4 mr-2" />
                  Apply Template (5 tasks)
                </Button>
              </CardContent>
            </Card>

            <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => applyDayTemplate('showings')}>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Home className="w-5 h-5" />
                  Showing Day
                </CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-slate-600 mb-4">
                  Get ready for property tours
                </p>
                <ul className="text-sm space-y-1 text-slate-600">
                  <li>‚Ä¢ Confirm appointments</li>
                  <li>‚Ä¢ Prepare materials</li>
                  <li>‚Ä¢ Check lockbox codes</li>
                  <li>‚Ä¢ Plan route</li>
                  <li>‚Ä¢ Feedback forms</li>
                </ul>
                <Button className="w-full mt-4" disabled={createTaskMutation.isPending}>
                  <Plus className="w-4 h-4 mr-2" />
                  Apply Template (5 tasks)
                </Button>
              </CardContent>
            </Card>

            <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => applyDayTemplate('admin')}>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <FileText className="w-5 h-5" />
                  Admin Day
                </CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-slate-600 mb-4">
                  Catch up on paperwork and organization
                </p>
                <ul className="text-sm space-y-1 text-slate-600">
                  <li>‚Ä¢ Review emails</li>
                  <li>‚Ä¢ Update CRM</li>
                  <li>‚Ä¢ Transaction checklists</li>
                  <li>‚Ä¢ Expense tracking</li>
                  <li>‚Ä¢ Schedule appointments</li>
                </ul>
                <Button className="w-full mt-4" disabled={createTaskMutation.isPending}>
                  <Plus className="w-4 h-4 mr-2" />
                  Apply Template (5 tasks)
                </Button>
              </CardContent>
            </Card>

            <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => applyDayTemplate('marketing')}>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Camera className="w-5 h-5" />
                  Marketing Day
                </CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm text-slate-600 mb-4">
                  Focus on content and promotion
                </p>
                <ul className="text-sm space-y-1 text-slate-600">
                  <li>‚Ä¢ Create listing content</li>
                  <li>‚Ä¢ Social media calendar</li>
                  <li>‚Ä¢ Direct mail campaigns</li>
                  <li>‚Ä¢ Update websites</li>
                  <li>‚Ä¢ Client appreciation</li>
                </ul>
                <Button className="w-full mt-4" disabled={createTaskMutation.isPending}>
                  <Plus className="w-4 h-4 mr-2" />
                  Apply Template (5 tasks)
                </Button>
              </CardContent>
            </Card>
          </div>
        </TabsContent>

        <TabsContent value="tasks" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>All Tasks for Tomorrow ({tomorrowTasks.length})</CardTitle>
            </CardHeader>
            <CardContent>
              {tomorrowTasks.length > 0 ? (
                <div className="space-y-3">
                  {tomorrowTasks.map((task) => (
                    <div
                      key={task.id}
                      className="p-4 bg-white dark:bg-slate-800 border rounded-lg"
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <h4 className="font-semibold">{task.title}</h4>
                            <Badge className={getPriorityColor(task.priority)}>
                              {task.priority}
                            </Badge>
                            {task.task_type && (
                              <Badge variant="outline">{task.task_type}</Badge>
                            )}
                          </div>
                          {task.description && (
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {task.description}
                            </p>
                          )}
                        </div>
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => deleteTaskMutation.mutate(task.id)}
                          className="text-red-500 hover:text-red-700"
                        >
                          <Trash2 className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8">
                  <Calendar className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                  <p className="text-slate-600 mb-2">No tasks yet</p>
                  <p className="text-sm text-slate-500">
                    Add tasks manually or use templates and AI suggestions
                  </p>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
import React, { useState, useEffect, useMemo } from "react";
import { base44 } from "@/api/base44Client";
import { createPageUrl } from "@/utils";
import { useNavigate } from "react-router-dom";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useSubscriptionLimits } from "../components/utils/subscriptionLimits";
import UpgradePrompt from "../components/common/UpgradePrompt";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Progress } from "@/components/ui/progress";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue
} from
"@/components/ui/select";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from
"@/components/ui/dropdown-menu";
import { Plus, Filter, Grid3x3, List, Home, Bed, Bath, LayoutDashboard, Edit, Trash2, RefreshCw, Search, MapPin, DollarSign, Calendar, TrendingUp, Eye, MoreVertical, CheckCircle2, Clock, AlertCircle, ImageIcon, SortAsc, Sparkles, AlertTriangle, Loader2, Map, UserCheck, ExternalLink, ArrowLeft, X, Star, MessageSquare } from "lucide-react";
import { toast } from "sonner";

import PropertyModal from "../components/properties/PropertyModal";
import SoldCelebrationModal from "../components/common/SoldCelebrationModal";
import PropertiesMapView from "../components/properties/PropertiesMapView";
import PropertiesMapViewEnhanced from "../components/properties/PropertiesMapViewEnhanced";
import LoadingSpinner from "../components/common/LoadingSpinner";
import { filterPropertiesByRole, canEditProperty, canDeleteProperty } from "../components/utils/rolePermissions";
import ClientLoveMeter from "../components/common/ClientLoveMeter";

export default function Properties() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const { checkLimit } = useSubscriptionLimits();

  const [filteredProperties, setFilteredProperties] = useState([]);
  const [limitCheck, setLimitCheck] = useState(null);
  const [showPropertyModal, setShowPropertyModal] = useState(false);
  const [editingProperty, setEditingProperty] = useState(null);
  const [viewMode, setViewMode] = useState("grid");
  const [searchQuery, setSearchQuery] = useState("");
  const [showMap, setShowMap] = useState(false);
  const [filters, setFilters] = useState({
    status: "all",
    property_type: "all",
    min_price: "",
    max_price: "",
    min_bedrooms: "",
    city: "",
    is_stale: false
  });
  const [sortBy, setSortBy] = useState("newest");
  const [showCelebrationModal, setShowCelebrationModal] = useState(false);
  const [celebrationDetails, setCelebrationDetails] = useState({ property: null, commission: 0, marketingAllocation: 10 });
  const [isCleaning, setIsCleaning] = useState(false);
  const [buyerSearchInfo, setBuyerSearchInfo] = useState(null);
  const [staleAlertDismissed, setStaleAlertDismissed] = useState(() => {
    const dismissed = localStorage.getItem('staleAlertDismissedUntil');
    if (dismissed) {
      return new Date(dismissed) > new Date();
    }
    return false;
  });
  const [selectedProperties, setSelectedProperties] = useState([]);

  const { data: currentUser, isLoading: isUserLoading } = useQuery({
    queryKey: ["currentUser"],
    queryFn: () => base44.auth.me()
  });

  const { data: propertiesData = [], isLoading: isPropertiesLoading, isFetching: isPropertiesFetching } = useQuery({
    queryKey: ["properties"],
    queryFn: () => base44.entities.Property.list("-updated_date")
  });

  useEffect(() => {
    if (propertiesData.length > 0) {
      checkLimit('properties', propertiesData.length).then(setLimitCheck);
    }
  }, [propertiesData.length]);

  const { data: users = [] } = useQuery({ 
    queryKey: ['users'], 
    queryFn: () => base44.entities.User.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });
  const { data: tasks = [] } = useQuery({ 
    queryKey: ['tasks'], 
    queryFn: () => base44.entities.Task.list(),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });
  const { data: transactions = [] } = useQuery({ 
    queryKey: ['transactions'], 
    queryFn: () => base44.entities.Transaction.list(),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });
  const { data: teamMembers = [] } = useQuery({ 
    queryKey: ['teamMembers'], 
    queryFn: () => base44.entities.TeamMember.list().catch(() => []),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });
  const { data: buyers = [] } = useQuery({ 
    queryKey: ['buyers'], 
    queryFn: () => base44.entities.Buyer.list().catch(() => []),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: allFeedback = [] } = useQuery({ 
    queryKey: ['propertyFeedback'], 
    queryFn: () => base44.entities.PropertyFeedback.list().catch(() => []),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: clientPortalAccess = [] } = useQuery({
    queryKey: ['clientPortalAccess'],
    queryFn: () => base44.entities.ClientPortalAccess.list().catch(() => []),
    staleTime: 5 * 60 * 1000, // 5 minutes
    gcTime: 10 * 60 * 1000, // 10 minutes
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: communications = [] } = useQuery({
    queryKey: ['communications'],
    queryFn: () => base44.entities.Communication.list().catch(() => []),
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: documents = [] } = useQuery({
    queryKey: ['documents'],
    queryFn: () => base44.entities.Document.list().catch(() => []),
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const isLoading = isUserLoading || isPropertiesLoading;
  const isRefreshing = isPropertiesFetching && !isPropertiesLoading;

  const properties = useMemo(() => {
    if (!propertiesData || !currentUser) return [];
    return filterPropertiesByRole(propertiesData, currentUser);
  }, [propertiesData, currentUser]);

  // State for matched property IDs from buyer matching
  const [matchedPropertyIds, setMatchedPropertyIds] = useState(null);

  // Parse URL parameters for buyer search
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const minPrice = urlParams.get('minPrice');
    const maxPrice = urlParams.get('maxPrice');
    const minBedrooms = urlParams.get('minBedrooms');
    const propertyType = urlParams.get('propertyType');
    const location = urlParams.get('location');
    const buyerId = urlParams.get('buyerId');
    const buyerName = urlParams.get('buyerName');
    const matchedIds = urlParams.get('matchedPropertyIds');

    // Handle matched property IDs from AI buyer matching
    if (matchedIds) {
      const idsArray = matchedIds.split(',').filter(id => id.trim());
      setMatchedPropertyIds(idsArray);
      
      if (buyerId && buyerName) {
        setBuyerSearchInfo({
          id: buyerId,
          name: buyerName,
          matchedCount: idsArray.length
        });
        toast.success(`Showing ${idsArray.length} matching properties for ${buyerName}`);
      }
    } else if (minPrice || maxPrice || buyerId || minBedrooms || propertyType || location) {
      setFilters((prev) => ({
        ...prev,
        min_price: minPrice || "",
        max_price: maxPrice || "",
        min_bedrooms: minBedrooms || "",
        property_type: propertyType || "all",
        city: location || ""
      }));

      if (buyerId && buyerName) {
        setBuyerSearchInfo({
          id: buyerId,
          name: buyerName,
          minPrice: minPrice ? parseInt(minPrice) : null,
          maxPrice: maxPrice ? parseInt(maxPrice) : null
        });
        toast.success(`Showing properties for ${buyerName}`);
      }
    }
  }, []);

  useEffect(() => {
    applyFiltersAndSort();
  }, [properties, searchQuery, filters, sortBy, matchedPropertyIds]);

  const handleManualRefresh = () => {
    toast.info("Refreshing properties...");
    queryClient.invalidateQueries({ queryKey: ["properties"] });
    queryClient.invalidateQueries({ queryKey: ["tasks"] });
    queryClient.invalidateQueries({ queryKey: ["transactions"] });
  };

  useEffect(() => {
    const handleRefresh = () => {
      handleManualRefresh();
      // Also refresh Client Love Meter data
      queryClient.invalidateQueries({ queryKey: ["clientPortalAccess"] });
      queryClient.invalidateQueries({ queryKey: ["communications"] });
      queryClient.invalidateQueries({ queryKey: ["documents"] });
    };

    window.addEventListener('refreshCounts', handleRefresh);
    window.addEventListener('refreshGlobalData', handleRefresh);
    return () => {
      window.removeEventListener('refreshCounts', handleRefresh);
      window.removeEventListener('refreshGlobalData', handleRefresh);
    };
  }, [queryClient]);

  const savePropertyMutation = useMutation({
    mutationFn: (propertyData) => {
      const { id, ...data } = propertyData;
      if (id) {
        return base44.entities.Property.update(id, data);
      }
      return base44.entities.Property.create(data);
    },
    onSuccess: (result, variables) => {
      queryClient.invalidateQueries({ queryKey: ['properties'] });
      queryClient.invalidateQueries({ queryKey: ['tasks'] });
      queryClient.invalidateQueries({ queryKey: ['transactions'] });
      window.dispatchEvent(new CustomEvent('refreshCounts'));

      const oldProperty = propertiesData.find((p) => p.id === variables.id);
      const oldStatus = oldProperty?.status;
      const newStatus = variables.status;

      toast.success(`Property ${variables.id ? 'updated' : 'created'} successfully`);

      if ((newStatus === 'sold' || newStatus === 'closed') && oldStatus !== 'sold' && oldStatus !== 'closed') {
        const updatedPropertyResult = variables.id ? { ...oldProperty, ...variables } : result;
        setCelebrationDetails({
          property: updatedPropertyResult,
          commission: updatedPropertyResult.estimated_commission || 0,
          marketingAllocation: currentUser?.marketing_commission_allocation || 10
        });
        setShowCelebrationModal(true);
      }

      setShowPropertyModal(false);
      setEditingProperty(null);
    },
    onError: (error) => {
      console.error("Error saving property:", error);
      toast.error("Failed to save property");
    }
  });

  const deletePropertyMutation = useMutation({
    mutationFn: (propertyId) => base44.entities.Property.delete(propertyId),
    onMutate: async (propertyId) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ['properties'] });
      
      // Snapshot previous value
      const previousProperties = queryClient.getQueryData(['properties']);
      
      // Optimistically update
      queryClient.setQueryData(['properties'], (old) => 
        old?.filter(p => p.id !== propertyId) || []
      );
      
      return { previousProperties };
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['tasks'] });
      queryClient.invalidateQueries({ queryKey: ['transactions'] });
      window.dispatchEvent(new CustomEvent('refreshCounts'));
      toast.success("Property deleted successfully");
    },
    onError: (error, propertyId, context) => {
      // Rollback on error
      queryClient.setQueryData(['properties'], context.previousProperties);
      console.error("Error deleting property:", error);
      toast.error("Failed to delete property");
    }
  });

  const calculatePropertyProgress = (propertyId) => {
    const propertyTasks = tasks.filter((t) => t && t.property_id === propertyId);

    if (!propertyTasks || propertyTasks.length === 0) {
      return {
        listing_side_progress: 0,
        selling_side_progress: 0,
        total_tasks: 0,
        completed_tasks: 0
      };
    }

    const listingSideTypes = ['listing', 'marketing', 'documentation', 'inspection'];
    const sellingSideTypes = ['contract', 'financing', 'closing'];

    const listingTasks = propertyTasks.filter((t) => t && listingSideTypes.includes(t.task_type));
    const sellingTasks = propertyTasks.filter((t) => t && sellingSideTypes.includes(t.task_type));

    const listingCompleted = listingTasks.filter((t) => t && t.status === 'completed').length;
    const sellingCompleted = sellingTasks.filter((t) => t && t.status === 'completed').length;
    const totalCompleted = propertyTasks.filter((t) => t.status === 'completed').length;

    const listingProgress = listingTasks.length > 0 ?
      Math.round(listingCompleted / listingTasks.length * 100) :
      0;

    const sellingProgress = sellingTasks.length > 0 ?
      Math.round(sellingCompleted / sellingTasks.length * 100) :
      0;

    return {
      listing_side_progress: listingProgress,
      selling_side_progress: sellingProgress,
      total_tasks: propertyTasks.length,
      completed_tasks: totalCompleted
    };
  };

  const getPropertyCommissionInfo = (property) => {
    const propertyTransactions = transactions.filter((t) => t.property_id === property.id);

    const closedTransaction = propertyTransactions.
      filter((t) => t.status === 'closed').
      sort((a, b) => new Date(b.updated_date || b.created_date).getTime() - new Date(a.updated_date || a.created_date).getTime())[0];

    if (!closedTransaction) {
      return {
        hasTransaction: false,
        listingCommission: 0,
        sellingCommission: 0,
        totalCommission: 0,
        listingAgentName: "Unknown",
        sellingAgentName: "Unknown"
      };
    }

    let listingAgentName = "Unknown Agent";
    if (property.listing_agent_id) {
      const listingAgentFromTeam = teamMembers.find((tm) => tm.id === property.listing_agent_id);
      const listingAgentFromUsers = users.find((u) => u.id === property.listing_agent_id);
      const listingAgent = listingAgentFromTeam || listingAgentFromUsers;

      if (listingAgent) {
        listingAgentName = listingAgent.full_name || listingAgent.email || "Unknown Agent";
      }
    }

    let sellingAgentName = "Unknown Agent";
    if (closedTransaction.selling_agent_email) {
      const sellingAgentFromTeam = teamMembers.find((tm) =>
        tm.email && tm.email.toLowerCase() === closedTransaction.selling_agent_email.toLowerCase()
      );
      const sellingAgentFromUsers = users.find((u) =>
        u.email && u.email.toLowerCase() === closedTransaction.selling_agent_email.toLowerCase()
      );
      const sellingAgent = sellingAgentFromTeam || sellingAgentFromUsers;

      if (sellingAgent) {
        sellingAgentName = sellingAgent.full_name || sellingAgent.email || closedTransaction.selling_agent_name || "Unknown Agent";
      } else {
        sellingAgentName = closedTransaction.selling_agent_name || closedTransaction.selling_agent_email || "Unknown Agent";
      }
    } else if (closedTransaction.selling_agent_id) {
      const sellingAgentFromTeam = teamMembers.find((tm) => tm.id === closedTransaction.selling_agent_id);
      const sellingAgentFromUsers = users.find((u) => u.id === closedTransaction.selling_agent_id);
      const sellingAgent = sellingAgentFromTeam || sellingAgentFromUsers;

      if (sellingAgent) {
        sellingAgentName = sellingAgent.full_name || sellingAgent.email || "Unknown Agent";
      }
    } else if (closedTransaction.selling_agent_name) {
      sellingAgentName = closedTransaction.selling_agent_name;
    }

    const totalCommission = (closedTransaction.listing_net_commission || 0) + (closedTransaction.selling_net_commission || 0);

    return {
      hasTransaction: true,
      listingCommission: closedTransaction.listing_net_commission || 0,
      sellingCommission: closedTransaction.selling_net_commission || 0,
      totalCommission,
      listingAgentName,
      sellingAgentName,
      transactionId: closedTransaction.id
    };
  };

  const applyFiltersAndSort = () => {
    let filtered = [...properties];

    // If we have matched property IDs from buyer matching, filter to only those
    if (matchedPropertyIds && matchedPropertyIds.length > 0) {
      filtered = filtered.filter(property => matchedPropertyIds.includes(property.id));
    }

    if (filters.is_stale) {
      filtered = filtered.filter((property) => {
        if (!property || !property.status || property.status !== 'active') return false;
        const listingDate = property.listing_date ? new Date(property.listing_date) : new Date(property.created_date);
        const daysOnMarket = Math.floor((new Date() - listingDate) / (1000 * 60 * 60 * 24));
        return daysOnMarket >= 60;
      });
    }

    if (searchQuery && typeof searchQuery === 'string') {
      filtered = filtered.filter((property) =>
        property && (
          (property.address && typeof property.address === 'string' && property.address.toLowerCase().includes(searchQuery.toLowerCase())) ||
          (property.city && typeof property.city === 'string' && property.city.toLowerCase().includes(searchQuery.toLowerCase())) ||
          (property.state && typeof property.state === 'string' && property.state.toLowerCase().includes(searchQuery.toLowerCase())) ||
          (property.zip_code && typeof property.zip_code === 'string' && property.zip_code.includes(searchQuery))
        )
      );
    }

    if (filters.status !== "all") {
      filtered = filtered.filter((property) => property && property.status === filters.status);
    }

    if (filters.property_type !== "all") {
      filtered = filtered.filter((property) => property && property.property_type === filters.property_type);
    }

    if (filters.min_price) {
      const minPrice = parseInt(filters.min_price);
      if (!isNaN(minPrice)) {
        filtered = filtered.filter((property) => property && (property.price || 0) >= minPrice);
      }
    }

    if (filters.max_price) {
      const maxPrice = parseInt(filters.max_price);
      if (!isNaN(maxPrice)) {
        filtered = filtered.filter((property) => property && (property.price || 0) <= maxPrice);
      }
    }

    if (filters.min_bedrooms) {
      const minBeds = parseInt(filters.min_bedrooms);
      if (!isNaN(minBeds)) {
        filtered = filtered.filter((property) => property && (property.bedrooms || 0) >= minBeds);
      }
    }

    if (filters.city && typeof filters.city === 'string') {
      filtered = filtered.filter((property) =>
        property && property.city && typeof property.city === 'string' &&
        property.city.toLowerCase().includes(filters.city.toLowerCase())
      );
    }

    filtered.sort((a, b) => {
      if (!a || !b) return 0;

      switch (sortBy) {
        case "newest":
          const getSortScore = (property) => {
            if (!property) return 4;
            const listingDate = property.listing_date ? new Date(property.listing_date) : new Date(property.created_date);
            const daysOnMarket = Math.floor((new Date() - listingDate) / (1000 * 60 * 60 * 24));
            const isStale = daysOnMarket >= 60 && property.status === 'active';

            if (isStale) return 0;
            if (property.status === 'active' || property.status === 'pending') return 1;
            if (property.status === 'sold' || property.status === 'closed') return 2;
            if (property.status === 'cancelled' || property.status === 'expired') return 3;
            return 4;
          };

          const scoreA = getSortScore(a);
          const scoreB = getSortScore(b);

          if (scoreA !== scoreB) {
            return scoreA - scoreB;
          }
          return new Date(b.created_date || 0) - new Date(a.created_date || 0);
        case "oldest":
          return new Date(a.created_date || 0) - new Date(b.created_date || 0);
        case "price_high":
          return (b.price || 0) - (a.price || 0);
        case "price_low":
          return (a.price || 0) - (b.price || 0);
        case "dom_high":
          const domA_high = a.listing_date ? Math.floor((new Date() - new Date(a.listing_date)) / (1000 * 60 * 60 * 24)) : 0;
          const domB_high = b.listing_date ? Math.floor((new Date() - new Date(b.listing_date)) / (1000 * 60 * 60 * 24)) : 0;
          return domB_high - domA_high;
        case "dom_low":
          const domA_low = a.listing_date ? Math.floor((new Date() - new Date(a.listing_date)) / (1000 * 60 * 60 * 24)) : 0;
          const domB_low = b.listing_date ? Math.floor((new Date() - new Date(b.listing_date)) / (1000 * 60 * 60 * 24)) : 0;
          return domA_low - domB_low;
        default:
          return 0;
      }
    });

    setFilteredProperties(filtered);
  };

  const handleSaveProperty = async (propertyData) => {
    const dataToSave = editingProperty ? { id: editingProperty.id, ...propertyData } : propertyData;
    savePropertyMutation.mutate(dataToSave);
  };

  const handleDeleteProperty = (propertyId) => {
    if (!window.confirm("Are you sure you want to delete this property? This action cannot be undone.")) {
      return;
    }
    deletePropertyMutation.mutate(propertyId);
  };

  const handleBulkDelete = async () => {
    if (selectedProperties.length === 0) return;
    
    if (!window.confirm(`Are you sure you want to delete ${selectedProperties.length} properties? This action cannot be undone.`)) {
      return;
    }

    // Optimistically update UI
    const previousProperties = queryClient.getQueryData(['properties']);
    queryClient.setQueryData(['properties'], (old) => 
      old?.filter(p => !selectedProperties.includes(p.id)) || []
    );
    setSelectedProperties([]);

    try {
      await Promise.all(selectedProperties.map(id => base44.entities.Property.delete(id)));
      toast.success(`Successfully deleted ${selectedProperties.length} properties`);
      queryClient.invalidateQueries({ queryKey: ['tasks'] });
      queryClient.invalidateQueries({ queryKey: ['transactions'] });
      window.dispatchEvent(new CustomEvent('refreshCounts'));
    } catch (error) {
      // Rollback on error
      queryClient.setQueryData(['properties'], previousProperties);
      console.error("Bulk delete error:", error);
      toast.error("Failed to delete some properties");
    }
  };

  const toggleSelectProperty = (propertyId) => {
    setSelectedProperties(prev => 
      prev.includes(propertyId) 
        ? prev.filter(id => id !== propertyId)
        : [...prev, propertyId]
    );
  };

  const toggleSelectAll = () => {
    if (selectedProperties.length === filteredProperties.length) {
      setSelectedProperties([]);
    } else {
      setSelectedProperties(filteredProperties.map(p => p.id));
    }
  };

  const handleEditProperty = (property) => {
    if (!canEditProperty(currentUser, property)) {
      toast.error("You don't have permission to edit this property");
      return;
    }
    setEditingProperty(property);
    setShowPropertyModal(true);
  };

  const handleViewProperty = (propertyId) => {
    navigate(createPageUrl(`PropertyDetail?id=${propertyId}`));
  };

  const handleCleanup = async () => {
    const confirmed = window.confirm(
      "Are you sure you want to delete all properties that are missing a valid address? This action cannot be undone."
    );

    if (!confirmed) {
      return;
    }

    setIsCleaning(true);
    toast.info("Starting cleanup process...");

    try {
      const allProperties = await base44.entities.Property.list(null, 10000);

      const propertiesToDelete = allProperties.filter((p) => !p.address || p.address.trim() === '');

      if (propertiesToDelete.length === 0) {
        toast.success("Cleanup complete. No invalid properties found to remove.");
        setIsCleaning(false);
        return;
      }

      const idsToDelete = propertiesToDelete.map((p) => p.id);

      await Promise.all(idsToDelete.map((id) => base44.entities.Property.delete(id)));

      toast.success(`Successfully deleted ${idsToDelete.length} properties that were missing an address.`);

      queryClient.invalidateQueries({ queryKey: ['properties'] });
      queryClient.invalidateQueries({ queryKey: ['tasks'] });
      queryClient.invalidateQueries({ queryKey: ['transactions'] });

    } catch (error) {
      console.error("Cleanup failed:", error);
      toast.error(`Failed to clean up properties: ${error.message || "An unknown error occurred."}`);
    } finally {
      setIsCleaning(false);
    }
  };

  const getStatusColor = (status) => {
    const colors = {
      active: "bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300",
      pending: "bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300",
      sold: "bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300",
      closed: "bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300",
      cancelled: "bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300"
    };
    return colors[status] || colors.active;
  };

  const getStatusIcon = (status) => {
    const icons = {
      active: TrendingUp,
      pending: Clock,
      sold: CheckCircle2,
      closed: CheckCircle2,
      cancelled: AlertCircle
    };
    return icons[status] || TrendingUp;
  };

  const stats = useMemo(() => ({
    total: properties.length,
    active: properties.filter((p) => p.status === 'active').length,
    pending: properties.filter((p) => p.status === 'pending').length,
    sold: properties.filter((p) => p.status === 'sold' || p.status === 'closed').length,
    totalValue: properties.reduce((sum, p) => sum + (p.price || 0), 0),
    avgPrice: properties.length > 0 ?
      properties.reduce((sum, p) => sum + (p.price || 0), 0) / properties.length :
      0
  }), [properties]);

  if (isLoading) {
    return <LoadingSpinner icon={Home} title="Loading Properties..." description="Loading your property listings" />;
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-6">
      <div className="max-w-7xl mx-auto space-y-3">
        {limitCheck && !limitCheck.allowed && (
          <UpgradePrompt 
            feature="properties"
            limit={limitCheck.limit}
            current={limitCheck.current}
            planName={limitCheck.planName}
          />
        )}
        {buyerSearchInfo &&
          <Card className="bg-gradient-to-r from-green-500 to-emerald-600 text-white border-0">
            <CardContent className="p-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                    <Sparkles className="w-5 h-5" />
                  </div>
                  <div>
                    <h3 className="text-sm font-bold">AI Matched Properties for: {buyerSearchInfo.name}</h3>
                    <p className="text-white/90 text-xs">
                      {buyerSearchInfo.matchedCount 
                        ? `${buyerSearchInfo.matchedCount} properties match buyer criteria`
                        : `Price Range: $${buyerSearchInfo.minPrice?.toLocaleString()} - $${buyerSearchInfo.maxPrice?.toLocaleString()}`
                      }
                      {filters.min_bedrooms && ` ‚Ä¢ ${filters.min_bedrooms}+ beds`}
                      {filters.city && ` ‚Ä¢ ${filters.city}`}
                    </p>
                  </div>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => {
                    setBuyerSearchInfo(null);
                    setMatchedPropertyIds(null);
                    setFilters({
                      status: "all",
                      property_type: "all",
                      min_price: "",
                      max_price: "",
                      min_bedrooms: "",
                      city: "",
                      is_stale: false
                    });
                    navigate(createPageUrl("Properties"));
                  }}
                  className="text-white hover:bg-white/20 h-8">
                  Show All Properties
                </Button>
              </div>
            </CardContent>
          </Card>
        }

        {/* Header with Stats */}
        <Card className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-xl">
          <CardContent className="p-4 rounded-none">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-2">
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={() => navigate(-1)}
                  className="text-white hover:bg-white/20 -ml-2"
                >
                  <ArrowLeft className="w-5 h-5" />
                </Button>
                <h1 className="text-2xl font-bold mb-1">Properties</h1>
                <p className="text-white/90 text-sm">Manage your property listings</p>
                {limitCheck && (
                  <p className="text-white/70 text-xs mt-1">
                    {limitCheck.limit === 'unlimited' ? '‚àû Unlimited' : `${limitCheck.current}/${limitCheck.limit}`} on {limitCheck.planName}
                  </p>
                )}
              </div>
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleManualRefresh}
                  disabled={isRefreshing}
                  className="border-white/30 text-white hover:bg-white/20 h-9">

                  <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                  Refresh
                </Button>
                {/* NEW: Cleanup Button */}
                <Button onClick={handleCleanup} variant="outline" disabled={isCleaning} className="border-white/30 text-white hover:bg-white/20 h-9">
                  {isCleaning ?
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" /> :

                    <Trash2 className="w-4 h-4 mr-2" />
                  }
                  Cleanup
                </Button>
                <Button
                  onClick={async () => {
                    const check = await checkLimit('properties', propertiesData.length);
                    if (!check.allowed) {
                      toast.error(`Property limit reached (${check.current}/${check.limit}). Upgrade your plan.`);
                      setTimeout(() => navigate(createPageUrl('Settings')), 2000);
                      return;
                    }
                    navigate(createPageUrl("PropertyAdd"));
                  }}
                  size="sm"
                  className="bg-white text-indigo-600 hover:bg-white/90 font-semibold shadow-lg h-9">

                  <Plus className="w-4 h-4 mr-2" />
                  Add Property
                </Button>
              </div>
            </div>

            {/* Quick Stats */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div 
                  className={`bg-white/10 backdrop-blur-sm rounded-lg p-3 border cursor-pointer hover:bg-white/20 transition-all ${filters.status === 'all' ? 'border-white ring-2 ring-white' : 'border-white/20'}`}
                  onClick={() => setFilters({ ...filters, status: "all" })}
                >
                  <div className="text-white/80 text-[10px] font-medium mb-0.5">Total Listings</div>
                  <div className="text-2xl font-bold">{properties.length}</div>
                </div>
              <div 
                className={`bg-white/10 backdrop-blur-sm rounded-lg p-3 border cursor-pointer hover:bg-white/20 transition-all ${filters.status === 'active' ? 'border-green-400 ring-2 ring-green-400' : 'border-white/20'}`}
                onClick={() => setFilters({ ...filters, status: filters.status === 'active' ? 'all' : 'active' })}
              >
                <div className="text-white/80 text-[10px] font-medium mb-0.5">Active</div>
                <div className="text-2xl font-bold text-green-300">{stats.active}</div>
              </div>
              <div 
                className={`bg-white/10 backdrop-blur-sm rounded-lg p-3 border cursor-pointer hover:bg-white/20 transition-all ${filters.status === 'pending' ? 'border-yellow-400 ring-2 ring-yellow-400' : 'border-white/20'}`}
                onClick={() => setFilters({ ...filters, status: filters.status === 'pending' ? 'all' : 'pending' })}
              >
                <div className="text-white/80 text-[10px] font-medium mb-0.5">Pending</div>
                <div className="text-2xl font-bold text-yellow-300">{stats.pending}</div>
              </div>
              <div 
                className={`bg-white/10 backdrop-blur-sm rounded-lg p-3 border cursor-pointer hover:bg-white/20 transition-all ${filters.status === 'sold' || filters.status === 'closed' ? 'border-blue-400 ring-2 ring-blue-400' : 'border-white/20'}`}
                onClick={() => setFilters({ ...filters, status: filters.status === 'sold' ? 'all' : 'sold' })}
              >
                <div className="text-white/80 text-[10px] font-medium mb-0.5">Sold</div>
                <div className="text-2xl font-bold text-blue-300">{stats.sold}</div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Bulk Actions Bar */}
        {selectedProperties.length > 0 && (
          <Card className="bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800">
            <CardContent className="p-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <Checkbox
                    checked={selectedProperties.length === filteredProperties.length}
                    onCheckedChange={toggleSelectAll}
                  />
                  <span className="text-sm font-medium text-slate-900 dark:text-white">
                    {selectedProperties.length} selected
                  </span>
                </div>
                <div className="flex gap-2">
                  <Button
                    variant="destructive"
                    size="sm"
                    onClick={handleBulkDelete}
                  >
                    <Trash2 className="w-4 h-4 mr-2" />
                    Delete Selected
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setSelectedProperties([])}
                  >
                    <X className="w-4 h-4 mr-2" />
                    Clear Selection
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Search, Filters, and View Toggle */}
        <Card>
          <CardContent className="p-3">
            <div className="flex flex-col lg:flex-row gap-3">
              {/* Search with Select All */}
              <div className="flex gap-2 items-center">
                <Checkbox
                  checked={selectedProperties.length === filteredProperties.length && filteredProperties.length > 0}
                  onCheckedChange={toggleSelectAll}
                  className="flex-shrink-0"
                />
                <div className="relative w-full lg:w-64">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                  <Input
                    type="text"
                    placeholder="Search by address..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="pl-10 h-9 text-sm" />
                </div>
              </div>

              {/* Filters */}
              <div className="flex gap-2 flex-wrap flex-1">
                <Select value={filters.status} onValueChange={(value) => setFilters({ ...filters, status: value })}>
                  <SelectTrigger className="w-32 h-9 text-sm">
                    <SelectValue placeholder="Status" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Status</SelectItem>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="pending">Pending</SelectItem>
                    <SelectItem value="sold">Sold</SelectItem>
                    <SelectItem value="closed">Closed</SelectItem>
                    <SelectItem value="cancelled">Cancelled</SelectItem>
                  </SelectContent>
                </Select>

                <Select value={filters.property_type} onValueChange={(value) => setFilters({ ...filters, property_type: value })}>
                  <SelectTrigger className="w-32 h-9 text-sm">
                    <SelectValue placeholder="Type" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Types</SelectItem>
                    <SelectItem value="single_family">Single Family</SelectItem>
                    <SelectItem value="condo">Condo</SelectItem>
                    <SelectItem value="townhouse">Townhouse</SelectItem>
                    <SelectItem value="multi_family">Multi Family</SelectItem>
                    <SelectItem value="land">Land</SelectItem>
                    <SelectItem value="commercial">Commercial</SelectItem>
                  </SelectContent>
                </Select>

                {/* NEW Price Range Filters */}
                <Input
                  type="number"
                  placeholder="Min Price"
                  value={filters.min_price}
                  onChange={(e) => setFilters({ ...filters, min_price: e.target.value })}
                  className="w-28 h-9 text-sm" />

                <Input
                  type="number"
                  placeholder="Max Price"
                  value={filters.max_price}
                  onChange={(e) => setFilters({ ...filters, max_price: e.target.value })}
                  className="w-28 h-9 text-sm" />


                <Select value={sortBy} onValueChange={setSortBy}>
                  <SelectTrigger className="w-32 h-9 text-sm">
                    <SelectValue placeholder="Sort by" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="newest">Recommended</SelectItem>
                    <SelectItem value="oldest">Oldest First</SelectItem>
                    <SelectItem value="price_high">Price: High to Low</SelectItem>
                    <SelectItem value="price_low">Price: Low to High</SelectItem>
                    <SelectItem value="dom_high">DOM: High to Low</SelectItem>
                    <SelectItem value="dom_low">DOM: Low to High</SelectItem>
                  </SelectContent>
                </Select>

                <div className="flex gap-2">
                  <Button
                    variant={viewMode === "grid" && !showMap ? "default" : "outline"}
                    size="icon"
                    onClick={() => { setViewMode("grid"); setShowMap(false); }}
                    className="h-9 w-9">

                    <Grid3x3 className="w-4 h-4" />
                  </Button>
                  <Button
                    variant={viewMode === "list" && !showMap ? "default" : "outline"}
                    size="icon"
                    onClick={() => { setViewMode("list"); setShowMap(false); }}
                    className="h-9 w-9">

                    <List className="w-4 h-4" />
                  </Button>
                  <Button
                    variant={showMap ? "default" : "outline"}
                    size="icon"
                    onClick={() => setShowMap(!showMap)}
                    className="h-9 w-9">

                    <Map className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </div>

            {/* Active Filters Display */}
            {(searchQuery || filters.status !== "all" || filters.property_type !== "all" || filters.is_stale || filters.min_price || filters.max_price || filters.min_bedrooms || filters.city) &&
              <div className="flex items-center gap-2 mt-3 flex-wrap">
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400">Active filters:</span>
                {searchQuery &&
                  <Badge variant="secondary" className="gap-2 text-xs h-6">
                  Search: {searchQuery}
                  <button onClick={() => setSearchQuery("")} className="hover:text-red-600">√ó</button>
                  </Badge>
                  }
                  {filters.status !== "all" &&
                  <Badge variant="secondary" className="gap-2 text-xs h-6">
                  Status: {filters.status}
                  <button onClick={() => setFilters({ ...filters, status: "all" })} className="hover:text-red-600">√ó</button>
                  </Badge>
                  }
                  {filters.property_type !== "all" &&
                  <Badge variant="secondary" className="gap-2 text-xs h-6">
                  Type: {filters.property_type?.replace('_', ' ')}
                  <button onClick={() => setFilters({ ...filters, property_type: "all" })} className="hover:text-red-600">√ó</button>
                  </Badge>
                  }
                  {(filters.min_price || filters.max_price) &&
                  <Badge variant="secondary" className="gap-2 text-xs h-6">
                  Price:
                    {filters.min_price && ` Min $${parseInt(filters.min_price).toLocaleString()}`}
                    {filters.min_price && filters.max_price && " - "}
                    {filters.max_price && ` Max $${parseInt(filters.max_price).toLocaleString()}`}
                    <button onClick={() => setFilters((prev) => ({ ...prev, min_price: "", max_price: "" }))} className="hover:text-red-600">√ó</button>
                  </Badge>
                }
                {filters.min_bedrooms &&
                  <Badge variant="secondary" className="gap-2 text-xs h-6">
                    Beds: {filters.min_bedrooms}+
                    <button onClick={() => setFilters((prev) => ({ ...prev, min_bedrooms: "" }))} className="hover:text-red-600">√ó</button>
                  </Badge>
                }
                {filters.city &&
                  <Badge variant="secondary" className="gap-2 text-xs h-6">
                    City: {filters.city}
                    <button onClick={() => setFilters((prev) => ({ ...prev, city: "" }))} className="hover:text-red-600">√ó</button>
                  </Badge>
                }
                {filters.is_stale &&
                  <Badge variant="secondary" className="gap-2 text-xs h-6 bg-orange-100 text-orange-800 dark:bg-orange-800/30 dark:text-orange-400 border border-orange-200 dark:border-orange-700">
                    <AlertTriangle className="w-3 h-3" />
                    Needs Attention
                    <button onClick={() => setFilters((prev) => ({ ...prev, is_stale: false }))} className="hover:text-red-600">√ó</button>
                  </Badge>
                }
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => {
                    setSearchQuery("");
                    setFilters({ status: "all", property_type: "all", min_price: "", max_price: "", min_bedrooms: "", city: "", is_stale: false });
                  }}
                  className="text-xs h-6">

                  Clear all
                </Button>
              </div>
            }
          </CardContent>
        </Card>

        {/* Stale Listings Alert - NEW */}
        {(() => {
          const staleListings = filteredProperties.filter((property) => {
            if (property.status !== 'active') return false;
            const listingDate = property.listing_date ? new Date(property.listing_date) : new Date(property.created_date);
            const daysOnMarket = Math.floor((new Date() - listingDate) / (1000 * 60 * 60 * 24));
            return daysOnMarket >= 60;
          });

          const handleDismissStaleAlert = () => {
            const dismissUntil = new Date();
            dismissUntil.setDate(dismissUntil.getDate() + 5);
            localStorage.setItem('staleAlertDismissedUntil', dismissUntil.toISOString());
            setStaleAlertDismissed(true);
            toast.success("Alert dismissed for 5 days");
          };

          return staleListings.length > 0 && !staleAlertDismissed &&
            <Card className="border-2 border-orange-300 bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-950 dark:to-red-950">
              <CardContent className="p-3">
                <div className="flex items-start gap-3">
                  <div className="p-2 rounded-lg bg-orange-100 dark:bg-orange-800/30">
                    <AlertTriangle className="w-5 h-5 text-orange-600 dark:text-orange-400" />
                  </div>
                  <div className="flex-1">
                    <h3 className="text-sm font-semibold text-slate-900 dark:text-white mb-1">
                      {staleListings.length} {staleListings.length === 1 ? 'Property' : 'Properties'} Need Attention
                    </h3>
                    <p className="text-xs text-slate-600 dark:text-slate-300 mb-2">
                      These listings have been on the market for 60+ days. Get AI-powered recommendations.
                    </p>
                    <div className="flex flex-wrap gap-2">
                      {staleListings.slice(0, 2).map((prop) => {
                        const listingDate = prop.listing_date ? new Date(prop.listing_date) : new Date(prop.created_date);
                        const daysOnMarket = Math.floor((new Date() - listingDate) / (1000 * 60 * 60 * 24));
                        return (
                          <Button
                            key={prop.id}
                            size="sm"
                            onClick={() => navigate(createPageUrl(`PropertyAdviceAI?propertyId=${prop.id}`))}
                            className="bg-orange-600 hover:bg-orange-700 text-white dark:bg-orange-700 dark:hover:bg-orange-800 h-8 text-xs">

                            <Sparkles className="w-3 h-3 mr-1" />
                            {prop.address} ({daysOnMarket} days)
                          </Button>);

                      })}
                      {staleListings.length > 2 &&
                        <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => setFilters((prev) => ({ ...prev, is_stale: true }))}
                        className="text-orange-700 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900 h-8 text-xs">

                        View all {staleListings.length} properties...
                        </Button>
                        }
                        </div>
                        </div>
                        <Button
                        variant="ghost"
                        size="sm"
                        onClick={handleDismissStaleAlert}
                        className="text-orange-600 hover:text-orange-800 hover:bg-orange-100 dark:text-orange-400 dark:hover:bg-orange-900 h-8 text-xs flex-shrink-0"
                        >
                        Dismiss for 5 days
                        </Button>
                </div>
              </CardContent>
            </Card>;

        })()}

        {/* Properties Display */}
        {showMap ? (
          <PropertiesMapViewEnhanced 
            properties={filteredProperties}
            userLocation={currentUser?.location}
          />
        ) : (
          <>
            {filteredProperties.length === 0 && !isLoading ?
              <Card className="border-2 border-dashed border-slate-300 dark:border-slate-700">
                <CardContent className="flex flex-col items-center justify-center py-16">
                  <Home className="w-20 h-20 text-slate-300 dark:text-slate-600 mb-4" />
                  <h3 className="text-xl font-semibold text-slate-900 dark:text-white mb-2">
                    No Properties Found
                  </h3>
                  <p className="text-slate-600 dark:text-slate-400 text-center mb-6 max-w-md">
                    {searchQuery || filters.status !== "all" || filters.property_type !== "all" || filters.is_stale || filters.min_price || filters.max_price || filters.min_bedrooms || filters.city ?
                      'Try adjusting your filters to see more results' :
                      'Get started by adding your first property listing'}
                  </p>
                  {!searchQuery && filters.status === "all" && filters.property_type === "all" && !filters.is_stale && !filters.min_price && !filters.max_price && !filters.min_bedrooms && !filters.city &&
                    <Button onClick={() => navigate(createPageUrl("PropertyAdd"))} size="lg">
                      <Plus className="w-5 h-5 mr-2" />
                      Add Your First Property
                    </Button>
                  }
                </CardContent>
              </Card> :

          viewMode === 'grid' ?
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {filteredProperties.map((property) => {
                const progress = calculatePropertyProgress(property.id);
                const canEdit = canEditProperty(currentUser, property);
                const canDelete = canDeleteProperty(currentUser, property);
                const commissionInfo = getPropertyCommissionInfo(property);
                const StatusIcon = getStatusIcon(property.status);

                const listingDate = property.listing_date ? new Date(property.listing_date) : new Date(property.created_date);
                const daysOnMarket = Math.floor((new Date() - listingDate) / (1000 * 60 * 60 * 24));
                const isStale = daysOnMarket >= 60 && property.status === 'active';

                return (
                  <Card
                    key={property.id}
                    className={`group overflow-hidden hover:shadow-2xl transition-all duration-300 border-2 ${
                      selectedProperties.includes(property.id) 
                        ? 'border-indigo-500 dark:border-indigo-400 ring-2 ring-indigo-300 dark:ring-indigo-600' 
                        : 'border-slate-200 dark:border-slate-700 hover:border-indigo-300 dark:hover:border-indigo-700'
                    } property-card ${isStale ? 'ring-2 ring-orange-400 dark:ring-orange-600' : ''}`
                    }>

                    {/* Selection Checkbox */}
                    <div className="absolute top-3 left-3 z-20">
                      <Checkbox
                        checked={selectedProperties.includes(property.id)}
                        onCheckedChange={() => toggleSelectProperty(property.id)}
                        onClick={(e) => e.stopPropagation()}
                        className="bg-white dark:bg-slate-800 border-2 shadow-lg"
                      />
                    </div>

                    {/* Property Image */}
                    <div
                      className="relative h-56 w-full bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-900 overflow-hidden cursor-pointer"
                      onClick={() => handleViewProperty(property.id)}>

                      {property.primary_photo_url || property.image_url ?
                        <img
                          src={property.primary_photo_url || property.image_url}
                          alt={property.address}
                          className="object-cover w-full h-full group-hover:scale-110 transition-transform duration-500"
                          onError={(e) => {
                            e.target.onerror = null;
                            e.target.src = "/placeholder-property.jpg";
                          }} /> :


                        <div className="flex items-center justify-center h-full">
                          <ImageIcon className="w-20 h-20 text-slate-300 dark:text-slate-600" />
                        </div>
                      }

                      {/* Status Badge */}
                      <div className="absolute top-3 right-3 flex flex-col gap-1 items-end">
                        <Badge className={`${getStatusColor(property.status)} border-2 shadow-lg backdrop-blur-sm flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold`}>
                          <StatusIcon className="w-3.5 h-3.5" />
                          {property.status.toUpperCase()}
                        </Badge>
                        {property.seller_needs_to_buy && (() => {
                          const linkedBuyer = property.linked_buyer_id ? buyers.find(b => b.id === property.linked_buyer_id) : null;
                          return (
                            <Badge 
                              className="bg-blue-600 text-white border-blue-700 shadow-lg backdrop-blur-sm flex items-center gap-1 px-2 py-1 text-[10px] font-bold cursor-pointer hover:bg-blue-700"
                              onClick={(e) => {
                                e.stopPropagation();
                                if (property.linked_buyer_id) {
                                  navigate(createPageUrl(`BuyerDetail?id=${property.linked_buyer_id}`));
                                }
                              }}
                            >
                              <UserCheck className="w-3 h-3" />
                              {linkedBuyer ? `${linkedBuyer.first_name} ${linkedBuyer.last_name} - Also Buying` : 'ALSO BUYING'}
                              {property.linked_buyer_id && <ExternalLink className="w-2.5 h-2.5" />}
                            </Badge>
                          );
                        })()}
                      </div>

                      {/* Days on Market */}
                      {property.days_on_market !== undefined && property.status === 'active' &&
                        <div className="absolute top-3 left-3">
                          <Badge className="bg-white/90 dark:bg-slate-800/90 text-slate-900 dark:text-white border-2 shadow-lg backdrop-blur-sm flex items-center gap-1 px-2 py-1 text-xs font-semibold">
                            <Clock className="w-3 h-3" />
                            {property.days_on_market} DOM
                          </Badge>
                        </div>
                      }

                      {/* NEW: Stale Listing Badge */}
                      {isStale &&
                        <div className="absolute top-3 left-3 z-10">
                          <Badge className="bg-orange-600 text-white border-orange-700 dark:bg-orange-700 dark:border-orange-800">
                            <AlertTriangle className="w-3 h-3 mr-1" />
                            {daysOnMarket} Days
                          </Badge>
                        </div>
                      }

                      {/* Quick Actions Overlay */}
                      <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end justify-center pb-4 gap-2">
                        <Button
                          variant="secondary"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleViewProperty(property.id);
                          }}
                          className="shadow-lg">

                          <Eye className="w-4 h-4 mr-1" />
                          View
                        </Button>
                        {canEdit &&
                        <Button
                          variant="secondary"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleEditProperty(property);
                          }}
                          className="shadow-lg">

                          <Edit className="w-4 h-4 mr-1" />
                          Edit
                        </Button>
                        }
                      </div>
                    </div>

                    {/* Property Details */}
                    <CardContent className="p-5 cursor-pointer" onClick={() => handleViewProperty(property.id)}>
                      {/* Price */}
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex-1">
                          <div className="text-2xl font-bold text-green-600 dark:text-green-400 mb-1">
                            ${property.price ? property.price.toLocaleString() : 'N/A'}
                          </div>
                          <div className="text-xs text-slate-500 dark:text-slate-400 capitalize">
                            {property.property_type?.replace('_', ' ') || 'Property'}
                          </div>
                        </div>
                        {canEdit &&
                          <DropdownMenu>
                            <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
                              <Button variant="ghost" size="icon" className="h-8 w-8">
                                <MoreVertical className="w-4 h-4" />
                              </Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="end">
                              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); handleViewProperty(property.id); }}>
                                <Eye className="w-4 h-4 mr-2" />
                                View Details
                              </DropdownMenuItem>
                              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); handleEditProperty(property); }}>
                                <Edit className="w-4 h-4 mr-2" />
                                Edit Property
                              </DropdownMenuItem>
                              <DropdownMenuSeparator />
                              {canDelete &&
                                <DropdownMenuItem
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleDeleteProperty(property.id);
                                  }}
                                  className="text-red-600 dark:text-red-400">

                                  <Trash2 className="w-4 h-4 mr-2" />
                                  Delete Property
                                </DropdownMenuItem>
                              }
                            </DropdownMenuContent>
                          </DropdownMenu>
                        }
                      </div>

                      {/* Address */}
                      <div className="mb-4">
                        <div className="flex items-start justify-between gap-2">
                          <div className="flex-1">
                            <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-1 line-clamp-1">
                              {property.address}
                            </h3>
                            <div className="flex items-center gap-1 text-sm text-slate-600 dark:text-slate-400">
                              <MapPin className="w-4 h-4 flex-shrink-0" />
                              <span className="line-clamp-1">{property.city}, {property.state} {property.zip_code}</span>
                            </div>
                          </div>
                          {(property.status === 'pending' || property.status === 'sold' || property.status === 'closed') && (
                            <ClientLoveMeter
                              property={property}
                              transaction={transactions.find(t => t.property_id === property.id)}
                              clientPortalAccess={clientPortalAccess.filter(c => c.property_id === property.id)}
                              documents={documents.filter(d => d.property_id === property.id)}
                              communications={communications.filter(c => c.property_id === property.id)}
                              onActionClick={() => navigate(createPageUrl(`Messages?propertyId=${property.id}`))}
                            />
                          )}
                        </div>
                      </div>

                      {/* Property Features */}
                      <div className="flex items-center gap-4 text-slate-700 dark:text-slate-300 text-sm mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                        {property.bedrooms !== undefined &&
                          <div className="flex items-center gap-1.5">
                            <Bed className="w-4 h-4 text-blue-500" />
                            <span className="font-semibold">{property.bedrooms}</span>
                            <span className="text-xs text-slate-500">beds</span>
                          </div>
                        }
                        {property.bathrooms !== undefined &&
                          <div className="flex items-center gap-1.5">
                            <Bath className="w-4 h-4 text-purple-500" />
                            <span className="font-semibold">{property.bathrooms}</span>
                            <span className="text-xs text-slate-500">baths</span>
                          </div>
                        }
                        {(property.square_footage || property.square_feet) &&
                          <div className="flex items-center gap-1.5">
                            <LayoutDashboard className="w-4 h-4 text-orange-500" />
                            <span className="font-semibold">{((property.square_footage || property.square_feet) / 1000).toFixed(1)}K</span>
                            <span className="text-xs text-slate-500">sqft</span>
                          </div>
                        }
                      </div>

                      {/* Task Progress */}
                      {progress.total_tasks > 0 &&
                        <div className="space-y-3 mb-4">
                          <div>
                            <div className="flex items-center justify-between text-xs text-slate-600 dark:text-slate-400 mb-1.5">
                              <span className="font-medium">Listing Progress</span>
                              <span className="font-bold">{progress.listing_side_progress}%</span>
                            </div>
                            <Progress value={progress.listing_side_progress} className="h-2 bg-blue-100 dark:bg-blue-900/30">
                              <div className="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all" style={{ width: `${progress.listing_side_progress}%` }} />
                            </Progress>
                          </div>

                          <div>
                            <div className="flex items-center justify-between text-xs text-slate-600 dark:text-slate-400 mb-1.5">
                              <span className="font-medium">Selling Progress</span>
                              <span className="font-bold">{progress.selling_side_progress}%</span>
                            </div>
                            <Progress value={progress.selling_side_progress} className="h-2 bg-purple-100 dark:bg-purple-900/30">
                              <div className="h-full bg-gradient-to-r from-purple-500 to-purple-600 rounded-full transition-all" style={{ width: `${progress.selling_side_progress}%` }} />
                            </Progress>
                          </div>

                          <div className="text-xs text-center text-slate-500 dark:text-slate-400">
                            {progress.completed_tasks} of {progress.total_tasks} tasks completed
                          </div>
                        </div>
                      }

                      {/* Feedback Summary */}
                      {(() => {
                        const propertyFeedback = allFeedback.filter(f => f.property_id === property.id);
                        if (propertyFeedback.length === 0) return null;
                        const avgRating = propertyFeedback.filter(f => f.rating).length > 0 
                          ? (propertyFeedback.reduce((sum, f) => sum + (f.rating || 0), 0) / propertyFeedback.filter(f => f.rating).length).toFixed(1)
                          : null;
                        return (
                          <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 flex items-center justify-between">
                            <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                              <MessageSquare className="w-4 h-4 text-indigo-500" />
                              <span>{propertyFeedback.length} feedback</span>
                            </div>
                            {avgRating && (
                              <div className="flex items-center gap-1">
                                <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                                <span className="text-sm font-semibold text-slate-700 dark:text-slate-300">{avgRating}</span>
                              </div>
                            )}
                          </div>
                        );
                      })()}

                      {/* Listing & Expiration Dates */}
                      {(property.listing_date || property.expiration_date) &&
                        <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                          <div className="flex items-center justify-between text-xs text-slate-600 dark:text-slate-400 flex-wrap gap-2">
                            {property.listing_date &&
                              <span className="flex items-center gap-1">
                                <Calendar className="w-3 h-3 text-blue-500" />
                                Listed: <strong className="text-slate-800 dark:text-slate-200 ml-1">{new Date(property.listing_date).toLocaleDateString()}</strong>
                              </span>
                            }
                            {property.expiration_date && (() => {
                              const expiration = new Date(property.expiration_date);
                              const now = new Date();
                              now.setHours(0, 0, 0, 0);
                              expiration.setHours(0, 0, 0, 0);
                              const daysLeft = Math.ceil((expiration.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

                              let displayExpirationText = '';
                              let spanColorClass = 'text-slate-600 dark:text-slate-400';
                              let animateClass = '';

                              if (daysLeft < 0) {
                                displayExpirationText = 'Expired';
                                spanColorClass = 'text-red-600';
                              } else if (daysLeft === 0) {
                                displayExpirationText = 'Expires Today';
                                spanColorClass = 'text-red-600';
                                animateClass = 'animate-pulse';
                              } else if (daysLeft <= 30) {
                                displayExpirationText = `${daysLeft} days left`;
                                spanColorClass = 'text-red-600';
                                animateClass = 'animate-pulse';
                              } else {
                                displayExpirationText = `${daysLeft} days left`;
                              }

                              return (
                                <span className={`flex items-center gap-1 ${spanColorClass} ${animateClass}`}>
                                  <Clock className="w-3 h-3" />
                                  Expires: <strong className="text-current ml-1">{displayExpirationText}</strong>
                                  {daysLeft <= 30 && daysLeft >= 0 && <AlertCircle className="w-3 h-3 text-red-600" />}
                                </span>);

                            })()}
                          </div>
                        </div>
                      }

                      {/* Commission Info for Sold Properties */}
                      {(property.status === 'sold' || property.status === 'closed') && commissionInfo.hasTransaction &&
                        <div className="mt-4 p-3 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg border-2 border-green-200 dark:border-green-800">
                          <div className="flex items-center gap-2 text-xs font-semibold text-green-700 dark:text-green-300 mb-2">
                            <DollarSign className="w-4 h-4" />
                            <span>Total Commission</span>
                          </div>

                          <div className="text-2xl font-bold text-green-600 dark:text-green-400 mb-2">
                            ${commissionInfo.totalCommission.toLocaleString()}
                          </div>

                          <div className="space-y-1 text-xs">
                            <div className="flex justify-between items-center">
                              <span className="text-slate-600 dark:text-slate-400">Listing ({commissionInfo.listingAgentName.split(' ')[0]}):</span>
                              <span className="font-bold text-slate-900 dark:text-white">${commissionInfo.listingCommission.toLocaleString()}</span>
                            </div>
                            {commissionInfo.sellingCommission > 0 &&
                              <div className="flex justify-between items-center">
                                <span className="text-slate-600 dark:text-slate-400">Selling ({commissionInfo.sellingAgentName.split(' ')[0]}):</span>
                                <span className="font-bold text-slate-900 dark:text-white">${commissionInfo.sellingCommission.toLocaleString()}</span>
                              </div>
                            }
                          </div>
                        </div>
                      }
                    </CardContent>

                    {/* NEW: AI Advice Button for Stale Listings */}
                    {isStale &&
                      <div className="p-3 bg-orange-50 border-t border-orange-200 dark:bg-orange-950 dark:border-orange-800">
                        <Button
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            navigate(createPageUrl(`PropertyAdviceAI?propertyId=${property.id}`));
                          }} className="bg-[#fc8303] text-zinc-950 px-3 text-sm font-medium opacity-100 rounded-md inline-flex items-center justify-center gap-2 whitespace-nowrap ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-primary/90 h-9 w-full from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700">


                          <Sparkles className="w-4 h-4 mr-2" />
                          Get AI Advice to Sell Faster
                          </Button>
                      </div>
                    }
                  </Card>);

              })}
            </div> : (

            /* List View */
            <div className="space-y-3">
              {filteredProperties.map((property) => {
                const progress = calculatePropertyProgress(property.id);
                const canEdit = canEditProperty(currentUser, property);
                const canDelete = canDeleteProperty(currentUser, property);
                const commissionInfo = getPropertyCommissionInfo(property);
                const StatusIcon = getStatusIcon(property.status);

                const borderLeftColor =
                  property.status === "active" ? "#10b981" : // green-500
                    property.status === "pending" ? "#f59e0b" : // amber-500
                      property.status === "sold" ? "#3b82f6" : // blue-500
                        property.status === "closed" ? "#3b82f6" : // blue-500
                          property.status === "cancelled" ? "#ef4444" : // red-500
                            "rgb(203 213 225)"; // slate-300

                return (
                  <Card
                    key={property.id}
                    className={`hover:shadow-lg transition-all duration-200 border border-l-4 ${
                      selectedProperties.includes(property.id)
                        ? 'border-indigo-500 dark:border-indigo-400 ring-2 ring-indigo-300 dark:ring-indigo-600'
                        : 'border-slate-200 dark:border-slate-700'
                    }`}
                    style={{
                      borderLeftColor: selectedProperties.includes(property.id) ? '#6366f1' : borderLeftColor
                    }}>

                    <CardContent className="p-4">
                      <div className="flex items-center gap-4">
                        {/* Selection Checkbox */}
                        <Checkbox
                          checked={selectedProperties.includes(property.id)}
                          onCheckedChange={() => toggleSelectProperty(property.id)}
                          onClick={(e) => e.stopPropagation()}
                          className="flex-shrink-0"
                        />
                        {/* Property Image */}
                        <div
                          className="w-32 h-32 rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-800 flex-shrink-0 cursor-pointer"
                          onClick={() => handleViewProperty(property.id)}>

                          {property.primary_photo_url || property.image_url ?
                            <img
                              src={property.primary_photo_url || property.image_url}
                              alt={property.address}
                              className="w-full h-full object-cover"
                              onError={(e) => {
                                e.target.onerror = null;
                                e.target.src = "/placeholder-property.jpg";
                              }} /> :


                            <div className="flex items-center justify-center h-full">
                              <ImageIcon className="w-12 h-12 text-slate-300" />
                            </div>
                          }
                        </div>

                        {/* Property Info */}
                        <div className="flex-1 min-w-0 cursor-pointer" onClick={() => handleViewProperty(property.id)}>
                          <div className="flex items-start justify-between gap-4 mb-2">
                            <div className="flex-1 min-w-0">
                              <h3 className="text-xl font-bold text-slate-900 dark:text-white truncate mb-1">
                                {property.address}
                              </h3>
                              <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 mb-2">
                                <MapPin className="w-4 h-4" />
                                {property.city}, {property.state} {property.zip_code}
                              </div>
                            </div>
                            <div className="text-right flex-shrink-0">
                              <div className="text-2xl font-bold text-green-600 dark:text-green-400">
                                ${property.price ? property.price.toLocaleString() : 'N/A'}
                              </div>
                              <Badge className={`${getStatusColor(property.status)} border flex items-center gap-1 mt-2`}>
                                <StatusIcon className="w-3 h-3" />
                                {property.status}
                              </Badge>
                              {property.seller_needs_to_buy && (() => {
                                const linkedBuyer = property.linked_buyer_id ? buyers.find(b => b.id === property.linked_buyer_id) : null;
                                return (
                                  <Badge 
                                    className="bg-blue-600 text-white border-blue-700 flex items-center gap-1 mt-1 text-[10px] cursor-pointer hover:bg-blue-700"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      if (property.linked_buyer_id) {
                                        navigate(createPageUrl(`BuyerDetail?id=${property.linked_buyer_id}`));
                                      }
                                    }}
                                  >
                                    <UserCheck className="w-3 h-3" />
                                    {linkedBuyer ? `${linkedBuyer.first_name} ${linkedBuyer.last_name} - Also Buying` : 'Also Buying'}
                                    {property.linked_buyer_id && <ExternalLink className="w-2.5 h-2.5" />}
                                  </Badge>
                                );
                              })()}
                              {(() => {
                                if (!property.expiration_date) return null;
                                const expiration = new Date(property.expiration_date);
                                const now = new Date();
                                now.setHours(0, 0, 0, 0); // normalize 'now' to start of day for comparison
                                expiration.setHours(0, 0, 0, 0);
                                const daysLeft = Math.ceil((expiration - now) / (1000 * 60 * 60 * 24));

                                let badgeClass = 'text-slate-600 dark:text-slate-400 border-slate-300 dark:border-slate-600';
                                if (daysLeft < 0) {
                                  badgeClass = 'text-red-600 dark:text-red-400 border-red-300 dark:border-red-600';
                                } else if (daysLeft < 30) {
                                  badgeClass = 'text-red-600 dark:text-red-400 border-red-300 dark:border-red-600 animate-pulse';
                                }

                                let expirationText = `${daysLeft}d left`;
                                if (daysLeft < 0) expirationText = 'Expired'; else
                                  if (daysLeft === 0) expirationText = 'Expires Today'; else
                                    if (daysLeft === 1) expirationText = 'Expires Tomorrow';

                                return (
                                  <Badge variant="outline" className={`text-xs mt-1 flex items-center gap-1.5 px-2 py-1 ${badgeClass}`}>
                                    <Clock className="w-3 h-3" />
                                    {expirationText}
                                  </Badge>);

                              })()}
                            </div>
                          </div>

                          {/* Features */}
                          <div className="flex items-center gap-4 text-sm text-slate-700 dark:text-slate-300 mb-3">
                            {property.bedrooms !== undefined &&
                              <div className="flex items-center gap-1">
                                <Bed className="w-4 h-4 text-blue-500" />
                                <span className="font-semibold">{property.bedrooms}</span>
                              </div>
                            }
                            {property.bathrooms !== undefined &&
                              <div className="flex items-center gap-1">
                                <Bath className="w-4 h-4 text-purple-500" />
                                <span className="font-semibold">{property.bathrooms}</span>
                              </div>
                            }
                            {(property.square_footage || property.square_feet) &&
                              <div className="flex items-center gap-1">
                                <LayoutDashboard className="w-4 h-4 text-orange-500" />
                                <span className="font-semibold">{((property.square_footage || property.square_feet) / 1000).toFixed(1)}K sqft</span>
                              </div>
                            }
                          </div>

                          {/* Progress Bars */}
                          {progress.total_tasks > 0 &&
                            <div className="grid grid-cols-2 gap-4 mb-3">
                              <div>
                                <div className="flex items-center justify-between text-xs text-slate-600 dark:text-slate-400 mb-1">
                                  <span>Listing</span>
                                  <span className="font-bold">{progress.listing_side_progress}%</span>
                                </div>
                                <Progress value={progress.listing_side_progress} className="h-2" />
                              </div>
                              <div>
                                <div className="flex items-center justify-between text-xs text-slate-600 dark:text-slate-400 mb-1">
                                  <span>Selling</span>
                                  <span className="font-bold">{progress.selling_side_progress}%</span>
                                </div>
                                <Progress value={progress.selling_side_progress} className="h-2" />
                              </div>
                            </div>
                          }

                          {/* Dates Row */}
                          <div className="flex items-center gap-4 text-xs text-slate-500 dark:text-slate-400 flex-wrap">
                            {property.listing_date &&
                              <span className="flex items-center gap-1">
                                <Calendar className="w-3 h-3 text-blue-500" />
                                Listed: <strong className="text-slate-700 dark:text-slate-300 ml-1">{new Date(property.listing_date).toLocaleDateString()}</strong>
                              </span>
                            }
                            {property.expiration_date && (() => {
                              const expiration = new Date(property.expiration_date);
                              const now = new Date();
                              now.setHours(0, 0, 0, 0);
                              expiration.setHours(0, 0, 0, 0);
                              const daysLeft = Math.ceil((expiration.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

                              let displayExpirationText = '';
                              let spanColorClass = 'text-slate-600 dark:text-slate-400';
                              let animateClass = '';

                              if (daysLeft < 0) {
                                displayExpirationText = 'Expired';
                                spanColorClass = 'text-red-600';
                              } else if (daysLeft === 0) {
                                displayExpirationText = 'Expires Today';
                                spanColorClass = 'text-red-600';
                                animateClass = 'animate-pulse';
                              } else if (daysLeft <= 30) {
                                displayExpirationText = `${daysLeft} days left`;
                                spanColorClass = 'text-red-600';
                                animateClass = 'animate-pulse';
                              } else {
                                displayExpirationText = `${daysLeft} days left`;
                              }

                              return (
                                <span className={`flex items-center gap-1 ${spanColorClass} ${animateClass}`}>
                                  <Clock className="w-3 h-3" />
                                  Expires: <strong className="text-current ml-1">{displayExpirationText}</strong>
                                </span>);

                            })()}
                            {property.days_on_market > 0 &&
                              <span className="flex items-center gap-1">
                                <Clock className="w-3 h-3 text-slate-500" />
                                {property.days_on_market} days on market
                              </span>
                            }
                          </div>

                          {/* Commission Info */}
                          {(property.status === 'sold' || property.status === 'closed') && commissionInfo.hasTransaction &&
                            <div className="inline-flex items-center gap-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1 rounded-lg text-sm font-bold mt-3">
                              <DollarSign className="w-4 h-4" />
                              ${commissionInfo.totalCommission.toLocaleString()} commission
                            </div>
                          }
                        </div>

                        {/* Actions */}
                        <div className="flex flex-col gap-2 flex-shrink-0">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={(e) => {
                              e.stopPropagation();
                              handleViewProperty(property.id);
                            }}>

                            <Eye className="w-4 h-4 mr-1" />
                            View
                          </Button>
                          {canEdit &&
                            <>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleEditProperty(property);
                                }}>

                                <Edit className="w-4 h-4 mr-1" />
                                Edit
                              </Button>
                              {canDelete &&
                                <Button
                                  variant="destructive"
                                  size="sm"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleDeleteProperty(property.id);
                                  }}>

                                  <Trash2 className="w-4 h-4 mr-1" />
                                  Delete
                                </Button>
                              }
                            </>
                          }
                        </div>
                      </div>
                    </CardContent>
                  </Card>);

              })}
            </div>)

            }
          </>
        )}
      </div>

      {showPropertyModal &&
        <PropertyModal
          property={editingProperty}
          users={users}
          onSave={handleSaveProperty}
          onClose={() => {
            setShowPropertyModal(false);
            setEditingProperty(null);
          }} />

      }

      <SoldCelebrationModal
        isOpen={showCelebrationModal}
        onClose={() => setShowCelebrationModal(false)}
        property={celebrationDetails.property}
        commission={celebrationDetails.commission}
        marketingAllocation={celebrationDetails.marketingAllocation} />

    </div>);

}
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { base44 } from "@/api/base44Client";
import { createPageUrl } from "@/utils";
import { useMutation, useQueryClient, useQuery } from "@tanstack/react-query";
import { toast } from "sonner";
import AddressAutocomplete from "../components/properties/AddressAutocomplete";
import WorkflowWizard from "../components/common/WorkflowWizard";
import { useWorkflow } from "../components/common/WorkflowProvider";

import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Separator } from "@/components/ui/separator";
import { Badge } from "@/components/ui/badge";
import {
  ArrowLeft, Building2, DollarSign, Upload, Trash2, UserPlus,
  Home, Bed, Bath, Square, Calendar, User, Building, Phone, Mail, Loader2, List, Sparkles, Search, CheckCircle2, Image as ImageIcon, MapPin, Database
} from "lucide-react";
import { attomPropertyData } from "@/api/functions";

export default function PropertyAdd() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  const urlParams = new URLSearchParams(window.location.search);
  const propertyId = urlParams.get("id");
  // Pre-fill seller info if coming from lead conversion
  const sellerName = urlParams.get("sellerName");
  const sellerEmail = urlParams.get("sellerEmail");
  const sellerPhone = urlParams.get("sellerPhone");
  const propertyAddress = urlParams.get("propertyAddress");
  const leadId = urlParams.get("leadId"); // Lead to delete after successful property creation
  const leadNotes = urlParams.get("notes");
  const linkedBuyerId = urlParams.get("linkedBuyerId"); // If seller is also a buyer
  const buyerNeedsToBuy = urlParams.get("buyerNeedsToBuy") === "true";
  
  const [isLoading, setIsLoading] = useState(!!propertyId);
  const [uploadingPhoto, setUploadingPhoto] = useState(false);

  // MLS Import States
  const [searchInput, setSearchInput] = useState("");
  const [isImportingMLS, setIsImportingMLS] = useState(false);
  const [importedPhotos, setImportedPhotos] = useState([]);
  const [addressSuggestions, setAddressSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false);
  const searchInputRef = React.useRef(null);
  const [estimatedValue, setEstimatedValue] = useState(null);

  const { data: currentUser } = useQuery({
    queryKey: ["currentUser"],
    queryFn: () => base44.auth.me(),
    staleTime: Infinity,
  });

  const { data: teamMembers = [] } = useQuery({
    queryKey: ["teamMembers"],
    queryFn: async () => {
      try {
        return await base44.entities.TeamMember.list();
      } catch (error) {
        console.error('Failed to load team members:', error);
        return [];
      }
    },
    staleTime: Infinity,
    initialData: [],
  });

  // Combine current user and team members for agent selection
  const agents = React.useMemo(() => {
    const agentList = [];
    
    // Add current user first
    if (currentUser) {
      agentList.push({
        id: currentUser.id,
        name: currentUser.full_name || currentUser.email,
        isCurrentUser: true
      });
    }
    
    // Add team members (excluding current user by email)
    teamMembers.forEach(member => {
      const memberEmail = member.email?.toLowerCase();
      const currentUserEmail = currentUser?.email?.toLowerCase();
      
      if (memberEmail !== currentUserEmail) {
        agentList.push({
          id: member.id,
          name: member.full_name || member.email,
          isCurrentUser: false
        });
      }
    });
    
    return agentList;
  }, [currentUser, teamMembers]);

  const [formData, setFormData] = useState({
    address: propertyAddress ? decodeURIComponent(propertyAddress) : "",
    city: "",
    state: "",
    zip_code: "",
    price: "",
    property_type: "single_family",
    bedrooms: "",
    bathrooms: "",
    square_feet: "",
    lot_size: "",
    year_built: "",
    listing_agent_id: "",
    selling_agent_id: "",
    status: "active",
    listing_date: "",
    closing_date: "",
    mls_number: "",
    virtual_tour_url: "",
    description: "",
    features: "",
    primary_photo_url: "",
    title_company: "",
    mortgage_company: "",
    inspection_company: "",
    days_on_market: 0,
    commission_rate: 6,
    listing_side_commission: 3,
    selling_side_commission: 3,
    agent_split_percentage: 50,
    listing_type: "sale", // New field
    expiration_date: "", // New field
    // Tax record fields
    parcel_id: "",
    property_use: "",
    land_use: "",
    zoning: "",
    waterfront: false,
    development_name: "",
    subdivision: "",
    census_tract: "",
    coordinates: "",
    township: "",
    range: "",
    section: "",
    block: "",
    lot: "",
    legal_description: "",
  });

  const [sellers, setSellers] = useState([
    { 
      name: sellerName ? decodeURIComponent(sellerName) : "", 
      email: sellerEmail ? decodeURIComponent(sellerEmail) : "", 
      cell_phone: sellerPhone ? decodeURIComponent(sellerPhone) : "",
      home_phone: "",
      mailing_address: "" 
    }
  ]);

  const [formSections, setFormSections] = useState({
    basicInfo: true,
    details: true,
    commission: false,
    owner: false,
    propertyDetails: true,
    legalLocation: true,
    primaryPhoto: true,
    currentOwner: true,
    agentInfo: true,
    serviceProviders: true,
    listingInformation: true,
  });

  // Workflow wizard state from context
  const { activeWorkflow, currentStepId, entityId, startWorkflow, nextStep, completeWorkflow, dismissWorkflow } = useWorkflow();
  const showWorkflow = activeWorkflow === 'new_listing' && !propertyId;

  useEffect(() => {
    if (currentUser && !formData.listing_agent_id) {
      setFormData(prev => ({
        ...prev,
        listing_agent_id: currentUser.id
      }));
    }
  }, [currentUser, formData.listing_agent_id]);

  // Start workflow automatically when adding new property
  useEffect(() => {
    if (!propertyId && !activeWorkflow) {
      startWorkflow('new_listing', 'basic_info');
    }
  }, [propertyId, activeWorkflow]);

  // Address autocomplete for Quick Import
  useEffect(() => {
    const fetchSuggestions = async () => {
      if (searchInput.length < 5 || searchInput.match(/^MLS/i)) {
        setAddressSuggestions([]);
        setShowSuggestions(false);
        return;
      }

      setIsLoadingSuggestions(true);
      try {
        const result = await base44.integrations.Core.InvokeLLM({
          prompt: `Given this partial US property address: "${searchInput}"
          
Return up to 5 possible complete property addresses that match or are similar.
Format each address as: "Street Address, City, State ZIP"

Only return valid, realistic US addresses. If the input looks like it could be multiple addresses, suggest variations.`,
          response_json_schema: {
            type: "object",
            properties: {
              suggestions: {
                type: "array",
                items: { type: "string" },
                maxItems: 5
              }
            }
          }
        });

        if (result?.suggestions && Array.isArray(result.suggestions)) {
          setAddressSuggestions(result.suggestions.slice(0, 5));
          setShowSuggestions(true);
        }
      } catch (error) {
        console.error("Error fetching address suggestions:", error);
      } finally {
        setIsLoadingSuggestions(false);
      }
    };

    const debounce = setTimeout(fetchSuggestions, 500);
    return () => clearTimeout(debounce);
  }, [searchInput]);

  // Close suggestions when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (searchInputRef.current && !searchInputRef.current.contains(event.target)) {
        setShowSuggestions(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  useEffect(() => {
    if (propertyId) {
      loadPropertyForEditing(propertyId);
    }
  }, [propertyId]);

  const loadPropertyForEditing = async (id) => {
    try {
      setIsLoading(true);
      const propertyData = await base44.entities.Property.get(id);
      setFormData(prev => ({
        ...prev,
        ...propertyData,
        price: propertyData.price ? String(propertyData.price) : "",
        bedrooms: propertyData.bedrooms ? String(propertyData.bedrooms) : "",
        bathrooms: propertyData.bathrooms ? String(propertyData.bathrooms) : "",
        square_feet: propertyData.square_feet ? String(propertyData.square_feet) : "",
        lot_size: propertyData.lot_size ? String(propertyData.lot_size) : "",
        year_built: propertyData.year_built ? String(propertyData.year_built) : "",
        days_on_market: propertyData.days_on_market ? String(propertyData.days_on_market) : "",
        commission_rate: propertyData.commission_rate ? String(propertyData.commission_rate) : "",
        listing_side_commission: propertyData.listing_side_commission ? String(propertyData.listing_side_commission) : "",
        selling_side_commission: propertyData.selling_side_commission ? String(propertyData.selling_side_commission) : "",
        agent_split_percentage: propertyData.agent_split_percentage ? String(propertyData.agent_split_percentage) : "",
        listing_date: propertyData.listing_date ? new Date(propertyData.listing_date).toISOString().split('T')[0] : "",
        closing_date: propertyData.closing_date ? new Date(propertyData.closing_date).toISOString().split('T')[0] : "",
        expiration_date: propertyData.expiration_date ? new Date(propertyData.expiration_date).toISOString().split('T')[0] : "",
        waterfront: propertyData.waterfront || false,
        listing_agent_id: propertyData.listing_agent_id || "",
        selling_agent_id: propertyData.selling_agent_id || "",
        listing_type: propertyData.listing_type || "sale",
      }));

      if (propertyData.sellers_info) {
        setSellers(JSON.parse(propertyData.sellers_info));
      }

      toast.success("Property loaded successfully for editing.");
    } catch (error) {
      console.error("Error loading property for editing:", error);
      toast.error("Failed to load property. Please try again.");
      navigate(createPageUrl("Properties"));
    } finally {
      setIsLoading(false);
    }
  };

  const handleImportFromMLS = async () => {
    if (!searchInput.trim()) {
      toast.error("Please enter an MLS number or property address");
      return;
    }

    setIsImportingMLS(true);
    const loadingToast = toast.loading("üîç Searching real estate sites for property...");
    
    try {
      console.log('üîç Calling searchZillow function with:', searchInput.trim());
      
      const response = await base44.functions.invoke('searchZillow', { searchQuery: searchInput.trim() });
      
      console.log('üì° Function response:', response);
      
      const result = response.data;
      
      console.log('üì¶ Result data:', result);

      toast.dismiss(loadingToast);

      // Check for errors
      if (!result || typeof result !== 'object') {
        console.error('‚ùå Invalid result:', result);
        toast.error("‚ùå Failed to import from Zillow", {
          description: "The search returned invalid data. Please try again.",
          duration: 5000
        });
        return;
      }

      if (result.status === "error") {
        console.error('‚ùå Error from function:', result.error);
        toast.error("‚ùå Failed to search Zillow", {
          description: result.error || "An error occurred while searching. Please try again.",
          duration: 5000
        });
        return;
      }

      if (result.status === "not_found") {
        toast.error("‚ùå Property not found on Zillow", {
          description: "Couldn't find this property. Try a different MLS# or address, or enter details manually.",
          duration: 5000
        });
        return;
      }

      // Download and upload primary photo (skip photos that fail)
      let uploadedPrimaryPhotoUrl = "";
      if (result.primary_photo_url) {
        try {
          const photoResponse = await fetch(result.primary_photo_url, { mode: 'cors' });
          if (!photoResponse.ok) throw new Error('Failed to fetch image');
          
          const photoBlob = await photoResponse.blob();
          const photoFile = new File([photoBlob], `property-${searchInput.replace(/[^a-zA-Z0-9]/g, '')}-primary.jpg`, { type: 'image/jpeg' });
          
          const { file_url } = await base44.integrations.Core.UploadFile({ file: photoFile });
          uploadedPrimaryPhotoUrl = file_url;
          toast.success("‚úÖ Primary photo uploaded!");
        } catch (error) {
          console.warn("Skipping primary photo (CORS/network issue):", error.message);
          // Skip photo silently - no error toast
        }
      }

      // Download and upload additional photos (skip failed ones silently)
      const uploadedAdditionalPhotos = [];
      if (result.additional_photos && Array.isArray(result.additional_photos) && result.additional_photos.length > 0) {
        const validPhotos = result.additional_photos.slice(0, 15);
        let successCount = 0;
        
        for (const [index, photoUrl] of validPhotos.entries()) {
          try {
            const response = await fetch(photoUrl, { mode: 'cors' });
            if (!response.ok) continue; // Skip this photo
            
            const blob = await response.blob();
            const file = new File([blob], `property-${searchInput.replace(/[^a-zA-Z0-9]/g, '')}-photo-${index + 1}.jpg`, { type: 'image/jpeg' });
            
            const { file_url } = await base44.integrations.Core.UploadFile({ file });
            uploadedAdditionalPhotos.push(file_url);
            successCount++;
          } catch (err) {
            console.warn(`Skipping photo ${index + 1} (CORS/network issue)`);
            // Skip silently
          }
        }
        
        if (successCount > 0) {
          toast.success(`‚úÖ ${successCount} photos uploaded!`);
        }
      }
      
      setImportedPhotos(uploadedAdditionalPhotos);

      // Auto-fill ALL form fields with imported data
      const mlsData = {
        ...formData,
        // MLS & Identification
        mls_number: result.mls_number || formData.mls_number || searchInput,
        parcel_id: result.parcel_id || formData.parcel_id,
        
        // Address fields (CRITICAL)
        address: result.address || formData.address,
        city: result.city || formData.city,
        state: result.state || formData.state,
        zip_code: result.zip_code || formData.zip_code,
        
        // Property details
        price: result.price ? String(result.price) : formData.price,
        property_type: result.property_type || formData.property_type,
        bedrooms: result.bedrooms ? String(result.bedrooms) : formData.bedrooms,
        bathrooms: result.bathrooms ? String(result.bathrooms) : formData.bathrooms,
        square_feet: result.square_feet ? String(result.square_feet) : formData.square_feet,
        lot_size: result.lot_size ? String(result.lot_size) : formData.lot_size,
        year_built: result.year_built ? String(result.year_built) : formData.year_built,
        
        // Property characteristics
        property_use: result.property_use || formData.property_use,
        land_use: result.land_use || formData.land_use,
        zoning: result.zoning || formData.zoning,
        waterfront: result.waterfront !== undefined ? result.waterfront : formData.waterfront,
        subdivision: result.subdivision || formData.subdivision,
        development_name: result.development_name || formData.development_name,
        
        // Marketing content
        description: result.description || formData.description,
        features: result.features || formData.features,
        
        // Primary image - use uploaded URL
        primary_photo_url: uploadedPrimaryPhotoUrl || formData.primary_photo_url,
        
        // Status & dates
        status: result.property_status === 'active' || result.mls_status === 'active' ? 'active' : 
                (result.property_status === 'pending' || result.mls_status === 'pending' ? 'pending' : 
                (result.property_status === 'sold' || result.mls_status === 'sold' ? 'sold' : formData.status)),
        days_on_market: result.days_on_market ? String(result.days_on_market) : (formData.days_on_market || 0),
        listing_date: result.listing_date || formData.listing_date
      };

      setFormData(mlsData);
      
      console.log('üìä Form data after MLS import:', mlsData);
      
      // Build detailed success message showing EVERYTHING imported
      const importedFields = [];
      if (result.address) importedFields.push("Address");
      if (result.price) importedFields.push("Price");
      if (result.bedrooms) importedFields.push("Bedrooms");
      if (result.bathrooms) importedFields.push("Bathrooms");
      if (result.square_feet) importedFields.push("Sq Ft");
      if (result.lot_size) importedFields.push("Lot Size");
      if (result.year_built) importedFields.push("Year Built");
      if (result.property_type) importedFields.push("Type");
      if (result.description) importedFields.push("Description");
      if (result.features) importedFields.push("Features");
      if (result.mls_number) importedFields.push("MLS#");
      if (uploadedPrimaryPhotoUrl) importedFields.push("Primary Photo");
      
      toast.success("‚úÖ MLS Data Imported!", {
        description: `Imported: ${importedFields.join(", ")}${uploadedAdditionalPhotos.length > 0 ? ` + ${uploadedAdditionalPhotos.length} photos` : ''}`,
        duration: 8000
      });

      if (uploadedAdditionalPhotos.length > 0) {
        toast.info(`üì∏ ${uploadedAdditionalPhotos.length} additional photos ready to upload after saving`, {
          duration: 5000
        });
      }

      // Auto-fetch ATTOM tax records data after MLS import if we have address
      if (result.address && result.city && result.state) {
        console.log('üîç Auto-fetching ATTOM data for:', result.address, result.city, result.state);
        await fetchATTOMDataForAddress(result.address, result.city, result.state, result.zip_code);
      }

    } catch (error) {
      toast.dismiss(loadingToast);
      console.error("Error importing MLS data:", error);
      toast.error("Failed to import MLS data", {
        description: error.message || "AI couldn't retrieve this listing. Try different MLS format or enter manually.",
        duration: 5000
      });
    } finally {
      setIsImportingMLS(false);
    }
  };

  const savePropertyMutation = useMutation({
    mutationFn: async (propertyData) => {
      if (propertyId) {
        return base44.entities.Property.update(propertyId, propertyData);
      } else {
        return base44.entities.Property.create(propertyData);
      }
    },
    onSuccess: async (savedProperty) => {
      queryClient.invalidateQueries({ queryKey: ["properties"] });
      queryClient.invalidateQueries({ queryKey: ["property", propertyId || savedProperty.id] });
      
      // If this property was created from a lead, delete the lead now
      if (leadId) {
        try {
          await base44.entities.Lead.delete(leadId);
          queryClient.invalidateQueries({ queryKey: ["leads"] });
          
          // If there's a linked buyer, update both records with cross-references
          if (linkedBuyerId && savedProperty.id) {
            try {
              // Update the property with buyer link
              await base44.entities.Property.update(savedProperty.id, {
                seller_needs_to_buy: true,
                linked_buyer_id: linkedBuyerId
              });
              
              // Update the buyer with property link
              await base44.entities.Buyer.update(linkedBuyerId, {
                linked_property_id: savedProperty.id
              });
              
              queryClient.invalidateQueries({ queryKey: ["buyers"] });
              toast.success(`Property created and linked to buyer successfully!`);
            } catch (linkError) {
              console.error("Failed to link buyer and property:", linkError);
              toast.success(`Property created! (Note: linking to buyer failed)`);
            }
          } else {
            toast.success(`Property created and lead converted successfully!`);
          }
        } catch (error) {
          console.error("Failed to delete lead after property creation:", error);
          toast.success(`Property ${propertyId ? "updated" : "created"} successfully!`);
        }
      } else {
        toast.success(`Property ${propertyId ? "updated" : "created"} successfully!`);
      }
      
      // Advance workflow to next step after save completes
      if (activeWorkflow === 'new_listing' && currentStepId === 'basic_info') {
        nextStep('photos');
        // Navigate to photos page with property ID
        navigate(createPageUrl(`Photos`));
        return; // Don't navigate to Properties list
      }
      
      // Add additional photos to property records if we have them from MLS import
      if (importedPhotos.length > 0 && savedProperty.id) {
        toast.loading(`üì∏ Adding ${importedPhotos.length} photos to property record...`, {
          id: 'bulk-photo-upload'
        });

        try {
          let addedCount = 0;
          const addPromises = importedPhotos.slice(0, 10).map(async (photoUrl, index) => { // Limit to 10 for now
            try {
              await base44.entities.Photo.create({
                property_id: savedProperty.id,
                file_url: photoUrl,
                caption: `MLS Photo ${index + 1}`,
                category: 'interior', // Default category, can be refined
                uploaded_by: currentUser?.id || 'system',
                approval_status: 'approved',
                display_order: index + 1
              });
              addedCount++;
            } catch (err) {
              console.error(`Failed to add photo record ${index + 1}:`, err);
            }
          });

          await Promise.all(addPromises);

          toast.success(`‚úÖ ${addedCount} photos added to property successfully!`, {
            id: 'bulk-photo-upload',
            duration: 5000
          });
        } catch (error) {
          console.error("Error adding additional photos:", error);
          toast.error("Some photo records failed to add", { id: 'bulk-photo-upload' });
        }
      }

      window.dispatchEvent(new CustomEvent('refreshCounts'));
      navigate(createPageUrl("Properties"));
    },
    onError: (error) => {
      console.error("Error saving property:", error);
      toast.error("Failed to save property. Please try again.");
    },
  });

  const handleFormChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleAddressSelect = async (addressData) => {
    setFormData(prev => ({
      ...prev,
      address: addressData.address,
      city: addressData.city,
      state: addressData.state,
      zip_code: addressData.zip_code
    }));
    toast.success("Address details auto-filled!");
    
    // Auto-fetch ATTOM data when address is selected
    if (addressData.address && addressData.city && addressData.state) {
      await fetchATTOMDataForAddress(addressData.address, addressData.city, addressData.state, addressData.zip_code);
    }
  };

  const fetchATTOMDataForAddress = async (address, city, state, zip) => {
    const loadingToast = toast.loading("üîç Fetching property data from ATTOM...");
    
    try {
      // Fetch comprehensive property data from ATTOM
      const [detailWithOwner, expandedProfile, propertyDetail] = await Promise.all([
        attomPropertyData({
          action: 'propertyDetailWithOwner',
          address,
          city,
          state,
          zip
        }).catch(e => ({ data: { error: e.message } })),
        attomPropertyData({
          action: 'propertyExpandedProfile',
          address,
          city,
          state,
          zip
        }).catch(e => ({ data: { error: e.message } })),
        attomPropertyData({
          action: 'propertyDetail',
          address,
          city,
          state,
          zip
        }).catch(e => ({ data: { error: e.message } }))
      ]);

      let importedFieldsCount = 0;
      const updates = {};

      // Extract data from responses
      const ownerData = detailWithOwner.data?.data?.property?.[0];
      const expandedData = expandedProfile.data?.data?.property?.[0];
      const detailData = propertyDetail.data?.data?.property?.[0];

      // Combine all sources
      const combined = ownerData || expandedData || detailData;

      if (!combined) {
        toast.dismiss(loadingToast);
        toast.info("No ATTOM data found for this address");
        return;
      }

      // Extract building details
      const building = combined.building || {};
      const summary = combined.summary || {};
      const lot = combined.lot || {};
      const address_info = combined.address || {};

      // Parcel ID
      if (summary.apn?.apnOneLine) {
        updates.parcel_id = summary.apn.apnOneLine;
        importedFieldsCount++;
      }

      // Property characteristics
      if (building.rooms?.beds) {
        updates.bedrooms = String(building.rooms.beds);
        importedFieldsCount++;
      }
      if (building.rooms?.bathstotal) {
        updates.bathrooms = String(building.rooms.bathstotal);
        importedFieldsCount++;
      }
      if (building.size?.livingsize) {
        updates.square_feet = String(building.size.livingsize);
        importedFieldsCount++;
      }
      if (lot.lotsize2) {
        // Convert sq ft to acres
        updates.lot_size = String((lot.lotsize2 / 43560).toFixed(2));
        importedFieldsCount++;
      }
      if (summary.yearbuilt) {
        updates.year_built = String(summary.yearbuilt);
        importedFieldsCount++;
      }

      // Property type
      if (summary.propclass) {
        const propClass = summary.propclass.toLowerCase();
        if (propClass.includes('single') || propClass.includes('sfr')) {
          updates.property_type = 'single_family';
        } else if (propClass.includes('condo')) {
          updates.property_type = 'condo';
        } else if (propClass.includes('town')) {
          updates.property_type = 'townhouse';
        } else if (propClass.includes('multi')) {
          updates.property_type = 'multi_family';
        }
        importedFieldsCount++;
      }

      // Zoning and use
      if (lot.zoning) {
        updates.zoning = lot.zoning;
        importedFieldsCount++;
      }
      if (summary.propLandUse) {
        updates.land_use = summary.propLandUse;
        importedFieldsCount++;
      }

      // Subdivision
      if (summary.subdivision) {
        updates.subdivision = summary.subdivision;
        importedFieldsCount++;
      }

      // Location details
      if (address_info.censusTract) {
        updates.census_tract = address_info.censusTract;
        importedFieldsCount++;
      }
      if (combined.location?.latitude && combined.location?.longitude) {
        updates.coordinates = `${combined.location.latitude}, ${combined.location.longitude}`;
        updates.location_lat = combined.location.latitude;
        updates.location_lng = combined.location.longitude;
        importedFieldsCount++;
      }

      // Features
      const features = [];
      if (building.interior?.fplccount > 0) features.push('Fireplace');
      if (building.parking?.prkgsize) features.push(`${building.parking.prkgsize} car garage`);
      if (building.construction?.actype) features.push('A/C');
      if (lot.pooltype) features.push('Pool');
      if (features.length > 0) {
        updates.features = features.join(', ');
        importedFieldsCount++;
      }

      // Owner information from ATTOM
      // ATTOM may return co-owners in owner1.name as "Name1; Name2" format
      // or in separate owner1/owner2 fields - but owner2 is often previous owner, not co-owner
      // We need to parse owner1 for multiple names separated by ; or &
      const owner = ownerData?.owner || {};
      
      if (owner.owner1?.name) {
        const owners = [];
        const owner1Name = owner.owner1?.fullName || owner.owner1?.name || "";
        
        // Check if owner1 contains multiple co-owners (separated by ; or &)
        // ATTOM often formats co-owners as "John Smith; Jane Smith" in owner1
        const coOwnerSeparators = /[;&]/;
        if (coOwnerSeparators.test(owner1Name)) {
          const ownerNames = owner1Name.split(coOwnerSeparators).map(n => n.trim()).filter(n => n);
          ownerNames.forEach((name, idx) => {
            owners.push({
              name: name,
              email: "",
              phone: "",
              mailing_address: owner.mailingAddress?.oneLine || ""
            });
          });
        } else {
          // Single owner in owner1
          owners.push({
            name: owner1Name,
            email: "",
            phone: "",
            mailing_address: owner.mailingAddress?.oneLine || ""
          });
          
          // Only add owner2 if it appears to be a co-owner (same last name or relationship indicator)
          // Skip owner2 if it looks like a previous owner (different last name, no relationship)
          const owner2Name = owner.owner2?.fullName || owner.owner2?.name;
          if (owner2Name && owner2Name !== owner1Name) {
            // Check if likely co-owner (shares last name or contains relationship keywords)
            const owner1LastName = owner1Name.split(' ').pop()?.toLowerCase();
            const owner2LastName = owner2Name.split(' ').pop()?.toLowerCase();
            const relationshipKeywords = ['trust', 'llc', 'inc', 'corp', 'estate'];
            const isLikelyCoOwner = owner1LastName === owner2LastName || 
              relationshipKeywords.some(kw => owner2Name.toLowerCase().includes(kw));
            
            if (isLikelyCoOwner) {
              owners.push({
                name: owner2Name,
                email: "",
                phone: "",
                mailing_address: owner.mailingAddress?.oneLine || ""
              });
            }
          }
        }

        if (owners.length > 0) {
          // Update owners array to use cell_phone and home_phone
          const updatedOwners = owners.map(o => ({
            ...o,
            cell_phone: o.phone || "",
            home_phone: "",
            phone: undefined
          }));
          setSellers(updatedOwners);
          importedFieldsCount++;
        }
      }

      // Apply updates to form
      setFormData(prev => ({
        ...prev,
        ...updates
      }));

      // Fetch AVM estimate
      try {
        const avmResult = await attomPropertyData({
          action: 'avm',
          address,
          city,
          state,
          zip
        });

        if (avmResult.data?.success) {
          const avmInfo = avmResult.data.data?.property?.[0]?.avm;
          if (avmInfo?.amount?.value) {
            const estValue = avmInfo.amount.value;
            setEstimatedValue(estValue);
            // Always pre-fill the price field with estimated value
            setFormData(prev => ({
              ...prev,
              price: String(estValue)
            }));
            toast.success(`üí∞ Estimated home value: $${estValue.toLocaleString()} (pre-filled in Price)`, {
              duration: 4000
            });
          }
        }
      } catch (error) {
        console.warn("Could not fetch AVM:", error);
      }

      toast.dismiss(loadingToast);
      
      if (importedFieldsCount > 0) {
        toast.success(`‚úÖ Imported ${importedFieldsCount} fields from ATTOM property records!`, {
          duration: 5000
        });
      } else {
        toast.info("ATTOM data found but no additional fields to import");
      }

    } catch (error) {
      toast.dismiss(loadingToast);
      console.error("Error fetching ATTOM data:", error);
      toast.error("Could not fetch ATTOM property data");
    }
  };

  const handlePropertyDataFetch = (propertyData) => {
    console.log("üìã Auto-filling property data:", propertyData);

    if (propertyData.owners && propertyData.owners.length > 0) {
      const ownersSellers = propertyData.owners.map(owner => ({
        name: owner.name || "",
        email: owner.email || "",
        cell_phone: owner.phone || "",
        home_phone: "",
        mailing_address: owner.mailing_address || ""
      }));

      console.log("üìû Setting owner/seller data with phones:", ownersSellers);
      setSellers(ownersSellers);

      const phonesFound = ownersSellers.filter(s => s.cell_phone).length;
      if (phonesFound > 0) {
        toast.success(`Auto-filled ${phonesFound} phone number${phonesFound > 1 ? 's' : ''} from tax records!`);
      }
      
      delete propertyData.owners;
    }
    
    setFormData(prev => ({
      ...prev,
      ...propertyData,
      waterfront: !!propertyData.waterfront,
      price: propertyData.price ? String(propertyData.price) : "",
      bedrooms: propertyData.bedrooms ? String(propertyData.bedrooms) : "",
      bathrooms: propertyData.bathrooms ? String(propertyData.bathrooms) : "",
      square_feet: propertyData.square_feet ? String(propertyData.square_feet) : "",
      lot_size: propertyData.lot_size ? String(propertyData.lot_size) : "",
      year_built: propertyData.year_built ? String(propertyData.year_built) : "",
    }));
    
    console.log("üìã Final form data after tax records (next render):", { ...formData, ...propertyData });
  };

  const handleSellerChange = (index, field, value) => {
    const updatedSellers = [...sellers];
    updatedSellers[index][field] = value;
    setSellers(updatedSellers);
  };

  const addSeller = () => {
    setSellers([...sellers, { name: "", email: "", cell_phone: "", home_phone: "", mailing_address: "" }]);
  };

  const removeSeller = (index) => {
    if (sellers.length > 1) {
      setSellers(sellers.filter((_, i) => i !== index));
    }
  };

  const handlePhotoUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setUploadingPhoto(true);
    try {
      const { file_url } = await base44.integrations.Core.UploadFile({ file }); // Fix applied here
      handleFormChange("primary_photo_url", file_url);
      toast.success("Photo uploaded successfully!");
    } catch (error) {
      console.error("Error uploading photo:", error);
      toast.error("Failed to upload photo. Please try again.");
    }
    setUploadingPhoto(false);
  };

  const handleGenerateDescription = async () => {
    if (!formData.address || !formData.city || !formData.state || !formData.bedrooms || !formData.bathrooms || !formData.square_feet) {
      toast.error("Please fill in address, city, state, bedrooms, bathrooms, and square feet to generate a description.");
      return;
    }

    try {
      toast.info("Generating description...");
      const mockDescription = `Discover this beautiful property located at ${formData.address}, ${formData.city}, ${formData.state}. This spacious ${formData.property_type.replace(/_/g, ' ')} features ${formData.bedrooms} bedrooms and ${formData.bathrooms} bathrooms, spread across ${formData.square_feet} square feet. ${formData.features ? `Highlights include: ${formData.features}.` : ''} A perfect home for comfortable living.`;
      handleFormChange("description", mockDescription);
      toast.success("Description generated successfully!");
    } catch (error) {
      console.error("Error generating description:", error);
      toast.error("Failed to generate description. Please try again.");
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();

    // Validate required fields for workflow
    if (!formData.address || !formData.city || !formData.state || !formData.price) {
      toast.error("Please fill in all required fields: Address, City, State, and Price");
      return;
    }

    try {
      const propertyData = {
        ...formData,
        price: parseFloat(formData.price) || 0,
        bedrooms: parseInt(formData.bedrooms) || 0,
        bathrooms: parseFloat(formData.bathrooms) || 0,
        square_feet: parseInt(formData.square_feet) || 0,
        lot_size: formData.lot_size ? parseFloat(formData.lot_size) : null,
        year_built: parseInt(formData.year_built) || 0,
        days_on_market: parseInt(formData.days_on_market) || 0,
        commission_rate: parseFloat(formData.commission_rate) || 0,
        listing_side_commission: parseFloat(formData.listing_side_commission) || 0,
        selling_side_commission: parseFloat(formData.selling_side_commission) || 0,
        agent_split_percentage: parseFloat(formData.agent_split_percentage) || 0,
        listing_agent_id: formData.listing_agent_id || null,
        selling_agent_id: formData.selling_agent_id || null,
        waterfront: formData.waterfront,
        sellers_info: JSON.stringify(sellers.filter(s => s.name || s.email || s.cell_phone || s.home_phone || s.mailing_address)),
        listing_date: formData.listing_date || null,
        closing_date: formData.closing_date || null,
        expiration_date: formData.expiration_date || null,
        listing_type: formData.listing_type,
      };
      
      savePropertyMutation.mutate(propertyData);

    } catch (error) {
      console.error("Error preparing property data:", error);
      toast.error("Failed to prepare property data. Please check your inputs.");
    }
  };

  const toggleSection = (section) => {
    setFormSections(prev => ({ ...prev, [section]: !prev[section] }));
  };

  const getSectionState = (section) => {
    return formSections[section];
  };
  
  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900">
        <Loader2 className="h-8 w-8 animate-spin text-indigo-500" />
        <span className="ml-2 text-lg text-slate-700 dark:text-slate-300">Loading Property...</span>
      </div>
    );
  }

  const isSubmitting = savePropertyMutation.isPending || uploadingPhoto;


  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 p-4 sm:p-6 lg:p-8">
      <div className="max-w-4xl mx-auto">
        {/* Workflow Progress Banner */}
        {showWorkflow && (
          <div className="mb-6">
            <WorkflowWizard
              workflowId="new_listing"
              currentStepId={currentStepId}
              onStepChange={nextStep}
              onComplete={() => {
                completeWorkflow();
                toast.success("üéâ Listing workflow complete!");
              }}
              onDismiss={dismissWorkflow}
              compact
            />
          </div>
        )}

        <div className="mb-6 flex items-center gap-4">
          <Button
            variant="ghost"
            size="icon"
            onClick={() => navigate(createPageUrl("Properties"))}
            className="rounded-full"
          >
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white">
              {propertyId ? "Edit Property" : "Add New Property"}
            </h1>
            <p className="text-slate-500 dark:text-slate-400 mt-1">
              {propertyId ? "Update the details for this property." : "Import from MLS or fill in details manually"}
            </p>
          </div>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Lead Conversion Banner - Show when coming from a lead */}
          {leadId && (
            <Card className="border-2 border-amber-300 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20">
              <CardContent className="p-4">
                <div className="flex items-start gap-4">
                  <div className="p-3 bg-amber-500 rounded-xl">
                    <User className="w-6 h-6 text-white" />
                  </div>
                  <div className="flex-1">
                    <p className="text-sm font-semibold text-amber-800 dark:text-amber-200 mb-1">CONVERTING SELLER LEAD</p>
                    <p className="text-lg font-bold text-slate-900 dark:text-white">
                      {sellerName ? decodeURIComponent(sellerName) : "Unknown Seller"}
                    </p>
                    <div className="flex flex-wrap gap-4 mt-2 text-sm text-slate-600 dark:text-slate-400">
                      {sellerEmail && (
                        <span className="flex items-center gap-1">
                          <Mail className="w-4 h-4" />
                          {decodeURIComponent(sellerEmail)}
                        </span>
                      )}
                      {sellerPhone && (
                        <span className="flex items-center gap-1">
                          <Phone className="w-4 h-4" />
                          {decodeURIComponent(sellerPhone)}
                        </span>
                      )}
                    </div>
                    {leadNotes && (
                      <p className="mt-2 text-sm text-slate-500 dark:text-slate-400 italic">
                        Note: {decodeURIComponent(leadNotes)}
                      </p>
                    )}
                    <p className="mt-3 text-xs text-amber-700 dark:text-amber-300">
                      ‚ö†Ô∏è The lead will only be removed after you successfully save this property.
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* MLS SEARCH - PROMINENT AT TOP */}
          {!propertyId && (
            <Card className="border-4 border-indigo-300 dark:border-indigo-700 shadow-2xl overflow-hidden">
              <div className="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-6 text-white">
                <div className="flex items-center gap-3 mb-3">
                  <div className="p-3 bg-white/20 backdrop-blur-sm rounded-xl">
                    <Search className="w-7 h-7 text-white" />
                  </div>
                  <div className="flex-1">
                    <h2 className="text-2xl font-bold">Quick Import Property Data</h2>
                    <p className="text-white/90 text-sm">
                      Search by MLS# or address - imports from Zillow + ATTOM tax records
                    </p>
                  </div>
                  <Badge className="bg-teal-500 text-white px-3 py-1 flex items-center gap-1">
                    <Database className="w-4 h-4" />
                    ATTOM Data
                  </Badge>
                </div>

                <div className="flex gap-3">
                  <div className="flex-1 relative" ref={searchInputRef}>
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 z-10" />
                    {isLoadingSuggestions && (
                      <Loader2 className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 animate-spin z-10" />
                    )}
                    <Input
                      placeholder="Enter MLS# or Property Address (e.g., MLS123456 or 123 Main St, Miami)"
                      value={searchInput}
                      onChange={(e) => setSearchInput(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), setShowSuggestions(false), handleImportFromMLS())}
                      onFocus={() => addressSuggestions.length > 0 && setShowSuggestions(true)}
                      className="pl-12 h-14 text-lg font-semibold bg-white dark:bg-slate-900 border-2 border-white/30 text-slate-900 dark:text-white"
                    />
                    
                    {/* Address Suggestions Dropdown */}
                    {showSuggestions && addressSuggestions.length > 0 && (
                      <div className="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-slate-800 rounded-lg shadow-2xl border-2 border-indigo-200 dark:border-indigo-700 z-50 overflow-hidden">
                        {addressSuggestions.map((suggestion, index) => (
                          <button
                            key={index}
                            type="button"
                            onClick={() => {
                              setSearchInput(suggestion);
                              setShowSuggestions(false);
                              setAddressSuggestions([]);
                            }}
                            className="w-full px-4 py-3 text-left hover:bg-indigo-50 dark:hover:bg-indigo-900/30 flex items-center gap-3 border-b border-slate-100 dark:border-slate-700 last:border-b-0 transition-colors"
                          >
                            <MapPin className="w-5 h-5 text-indigo-500 flex-shrink-0" />
                            <span className="text-slate-900 dark:text-white font-medium">{suggestion}</span>
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                  <Button
                    type="button"
                    onClick={handleImportFromMLS}
                    disabled={isImportingMLS || !searchInput.trim()}
                    className="bg-white text-indigo-600 hover:bg-white/90 h-14 px-8 text-base font-bold shadow-lg"
                    size="lg"
                  >
                    {isImportingMLS ? (
                      <>
                        <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                        Searching...
                      </>
                    ) : (
                      <>
                        <Sparkles className="w-5 h-5 mr-2" />
                        Import Property
                      </>
                    )}
                  </Button>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mt-4">
                  <div className="flex items-center gap-2 text-sm bg-white/10 backdrop-blur-sm px-3 py-2 rounded-lg">
                    <CheckCircle2 className="w-4 h-4" />
                    <span>MLS Data</span>
                  </div>
                  <div className="flex items-center gap-2 text-sm bg-teal-500/30 backdrop-blur-sm px-3 py-2 rounded-lg border border-teal-400">
                    <Database className="w-4 h-4" />
                    <span>Tax Records</span>
                  </div>
                  <div className="flex items-center gap-2 text-sm bg-white/10 backdrop-blur-sm px-3 py-2 rounded-lg">
                    <CheckCircle2 className="w-4 h-4" />
                    <span>Owner Info</span>
                  </div>
                  <div className="flex items-center gap-2 text-sm bg-white/10 backdrop-blur-sm px-3 py-2 rounded-lg">
                    <CheckCircle2 className="w-4 h-4" />
                    <span>Description</span>
                  </div>
                  <div className="flex items-center gap-2 text-sm bg-white/10 backdrop-blur-sm px-3 py-2 rounded-lg">
                    <CheckCircle2 className="w-4 h-4" />
                    <span>All Photos</span>
                  </div>
                </div>
              </div>

              {/* Show imported photos preview immediately */}
              {formData.primary_photo_url && (
                <div className="p-4 bg-white dark:bg-slate-800 border-t-2 border-indigo-300">
                  <div className="flex items-center gap-4 mb-3">
                    <ImageIcon className="w-6 h-6 text-indigo-600" />
                    <p className="font-bold text-indigo-900 dark:text-indigo-100">
                      Primary Photo Imported Successfully!
                    </p>
                  </div>
                  <img
                    src={formData.primary_photo_url}
                    alt="Property"
                    className="w-full max-h-64 object-cover rounded-xl shadow-lg"
                    onError={(e) => {
                      toast.error("Primary photo URL failed to load. The link may be invalid.");
                      console.error("Image load error:", formData.primary_photo_url);
                    }}
                  />
                </div>
              )}

              {importedPhotos.length > 0 && (
                <div className="p-4 bg-green-50 dark:bg-green-900/20 border-t-2 border-green-300">
                  <div className="flex items-center gap-3">
                    <ImageIcon className="w-6 h-6 text-green-600" />
                    <div>
                      <p className="font-bold text-green-900 dark:text-green-100">
                        {importedPhotos.length} Additional Photos Ready!
                      </p>
                      <p className="text-xs text-green-700 dark:text-green-300">
                        Will be automatically added to the property record after you save
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </Card>
          )}

          {/* Comprehensive Imported Data Summary */}
          {formData.address && (
            <Card className="border-2 border-blue-200 dark:border-blue-800 bg-gradient-to-br from-blue-50 to-sky-50 dark:from-blue-900/20 dark:to-sky-900/20">
              <CardHeader className="bg-gradient-to-r from-blue-600 to-sky-600 text-white">
                <CardTitle className="flex items-center gap-3">
                  <MapPin className="w-6 h-6" />
                  <div>
                    <div className="text-2xl font-bold">Imported Property Data</div>
                    <div className="text-sm text-white/80 font-normal mt-1">All data imported from MLS and ATTOM tax records</div>
                  </div>
                </CardTitle>
              </CardHeader>
              <CardContent className="p-6">
                {/* Property Location */}
                <div className="bg-white dark:bg-slate-800 rounded-lg p-4 mb-4 border-2 border-blue-300">
                  <p className="text-xs font-semibold text-blue-600 dark:text-blue-400 mb-2 flex items-center gap-2">
                    üìç LOCATION
                  </p>
                  <p className="text-2xl font-bold text-slate-900 dark:text-white">
                    {formData.address}
                  </p>
                  <p className="text-lg text-slate-600 dark:text-slate-400">
                    {formData.city}, {formData.state} {formData.zip_code}
                  </p>
                  <div className="flex flex-wrap gap-2 mt-3">
                    {formData.mls_number && (
                      <Badge className="bg-blue-600 text-white">MLS# {formData.mls_number}</Badge>
                    )}
                    {formData.parcel_id && (
                      <Badge className="bg-teal-600 text-white">
                        <Database className="w-3 h-3 mr-1" />
                        Parcel: {formData.parcel_id}
                      </Badge>
                    )}
                  </div>
                </div>

                {/* Property Details Grid - Always Show All Fields */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                  <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border">
                    <p className="text-xs text-slate-500 mb-1">üí∞ Price</p>
                    <p className="text-lg font-bold text-green-600">
                      {formData.price ? `$${parseFloat(formData.price).toLocaleString()}` : 'Not Set'}
                    </p>
                    {estimatedValue && (
                      <p className="text-xs text-slate-500">Est: ${estimatedValue.toLocaleString()}</p>
                    )}
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border">
                    <p className="text-xs text-slate-500 mb-1">üõèÔ∏è Bedrooms</p>
                    <p className="text-lg font-bold text-slate-900 dark:text-white">
                      {formData.bedrooms || 'N/A'}
                    </p>
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border">
                    <p className="text-xs text-slate-500 mb-1">üõÅ Bathrooms</p>
                    <p className="text-lg font-bold text-slate-900 dark:text-white">
                      {formData.bathrooms || 'N/A'}
                    </p>
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border">
                    <p className="text-xs text-slate-500 mb-1">üìê Sq Ft</p>
                    <p className="text-lg font-bold text-slate-900 dark:text-white">
                      {formData.square_feet ? parseInt(formData.square_feet).toLocaleString() : 'N/A'}
                    </p>
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border">
                    <p className="text-xs text-slate-500 mb-1">üå≥ Lot Size</p>
                    <p className="text-lg font-bold text-slate-900 dark:text-white">
                      {formData.lot_size ? `${formData.lot_size} ac` : 'N/A'}
                    </p>
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border">
                    <p className="text-xs text-slate-500 mb-1">üìÖ Year Built</p>
                    <p className="text-lg font-bold text-slate-900 dark:text-white">
                      {formData.year_built || 'N/A'}
                    </p>
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border">
                    <p className="text-xs text-slate-500 mb-1">üè† Type</p>
                    <p className="text-sm font-bold text-slate-900 dark:text-white capitalize">
                      {formData.property_type ? formData.property_type.replace(/_/g, ' ') : 'N/A'}
                    </p>
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border">
                    <p className="text-xs text-slate-500 mb-1">üìä Status</p>
                    <p className="text-sm font-bold text-slate-900 dark:text-white capitalize">
                      {formData.status || 'N/A'}
                    </p>
                  </div>
                </div>

                {/* Owner Information */}
                {sellers.length > 0 && sellers[0].name && (
                  <div className="bg-amber-50 dark:bg-amber-900/20 rounded-lg p-4 mb-4 border-2 border-amber-300">
                    <p className="text-xs font-semibold text-amber-700 dark:text-amber-400 mb-3 flex items-center gap-2">
                      üë§ CURRENT OWNER{sellers.length > 1 ? 'S' : ''}
                      <Badge className="bg-teal-600 text-white text-xs">
                        <Database className="w-3 h-3 mr-1" />
                        Tax Records
                      </Badge>
                    </p>
                    {sellers.map((seller, idx) => (
                      <div key={idx} className={`${idx > 0 ? 'mt-3 pt-3 border-t border-amber-200 dark:border-amber-700' : ''}`}>
                        <p className="font-bold text-slate-900 dark:text-white">{seller.name}</p>
                        <div className="flex flex-wrap gap-3 mt-1 text-sm">
                          {seller.email && (
                            <span className="text-slate-600 dark:text-slate-400 flex items-center gap-1">
                              <Mail className="w-3 h-3" /> {seller.email}
                            </span>
                          )}
                          {seller.cell_phone && (
                            <span className="text-slate-600 dark:text-slate-400 flex items-center gap-1">
                              <Phone className="w-3 h-3" /> Cell: {seller.cell_phone}
                            </span>
                          )}
                          {seller.home_phone && (
                            <span className="text-slate-600 dark:text-slate-400 flex items-center gap-1">
                              <Phone className="w-3 h-3" /> Home: {seller.home_phone}
                            </span>
                          )}
                        </div>
                        {seller.mailing_address && (
                          <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">üì¨ {seller.mailing_address}</p>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* Additional Details - Always Show */}
                <div className="space-y-3">
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3 border">
                    <p className="text-xs text-slate-500 mb-1">üèòÔ∏è Subdivision</p>
                    <p className="font-semibold text-slate-900 dark:text-white">{formData.subdivision || 'Not Available'}</p>
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3 border">
                    <p className="text-xs text-slate-500 mb-1">üó∫Ô∏è Zoning</p>
                    <p className="font-semibold text-slate-900 dark:text-white">{formData.zoning || 'Not Available'}</p>
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3 border">
                    <p className="text-xs text-slate-500 mb-1">‚ú® Features</p>
                    <p className="text-sm text-slate-900 dark:text-white">{formData.features || 'Not Available'}</p>
                  </div>
                  
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3 border">
                    <p className="text-xs text-slate-500 mb-1">üìù Description</p>
                    <p className="text-sm text-slate-700 dark:text-slate-300">
                      {formData.description ? (
                        formData.description.length > 200 ? `${formData.description.substring(0, 200)}...` : formData.description
                      ) : 'Not Available'}
                    </p>
                  </div>
                </div>

                <p className="text-xs text-blue-700 dark:text-blue-300 mt-4 text-center font-medium">
                  ‚úÖ All data above has been automatically filled in the form below. Scroll down to review and edit if needed.
                </p>
              </CardContent>
            </Card>
          )}

          {/* Primary Photo Preview */}
          {formData.primary_photo_url && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <ImageIcon className="w-5 h-5 text-indigo-600" />
                  Primary Photo
                  {importedPhotos.length > 0 && (
                    <Badge className="ml-2 bg-green-600 text-white">
                      +{importedPhotos.length} more photos from MLS
                    </Badge>
                  )}
                </CardTitle>
              </CardHeader>
              <CardContent>
                <img
                  src={formData.primary_photo_url}
                  alt="Property"
                  className="w-full h-80 object-cover rounded-xl shadow-lg"
                />
                  <Button
                    type="button"
                    variant="destructive"
                    size="sm"
                    onClick={() => handleFormChange("primary_photo_url", "")}
                    className="absolute top-2 right-2 flex items-center gap-1"
                  >
                    <Trash2 className="w-4 h-4" /> Remove
                  </Button>
              </CardContent>
            </Card>
          )}

          {/* Property Address */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Home className="w-5 h-5 text-indigo-500" />
                Property Address
              </CardTitle>
            </CardHeader>
            <CardContent>
              <AddressAutocomplete
                value={formData.address}
                city={formData.city}
                state={formData.state}
                zipCode={formData.zip_code}
                onChange={(value) => handleFormChange("address", value)}
                onAddressSelect={handleAddressSelect}
                onPropertyDataFetch={handlePropertyDataFetch}
              />
            </CardContent>
          </Card>

          {/* Property Details */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Building className="w-5 h-5 text-purple-500" />
                Property Details
              </CardTitle>
            </CardHeader>
            <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-2">
                <Label htmlFor="parcel_id">PID # / Parcel ID</Label>
                <Input
                  id="parcel_id"
                  type="text"
                  value={formData.parcel_id}
                  onChange={(e) => handleFormChange("parcel_id", e.target.value)}
                  placeholder="e.g., 12-34-567-890"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="price" className="flex items-center gap-2">
                  Price *
                  {estimatedValue && (
                    <Badge className="bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-300 font-normal">
                      <Database className="w-3 h-3 mr-1" />
                      Est: ${estimatedValue.toLocaleString()}
                    </Badge>
                  )}
                </Label>
                <div className="relative">
                  <DollarSign className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-500" />
                  <Input
                    id="price"
                    type="number"
                    value={formData.price}
                    onChange={(e) => handleFormChange("price", e.target.value)}
                    placeholder={estimatedValue ? estimatedValue.toString() : "500000"}
                    required
                    className="pl-9"
                  />
                </div>
                {estimatedValue && formData.price && (
                  <p className="text-xs text-slate-500">
                    {((parseFloat(formData.price) - estimatedValue) / estimatedValue * 100).toFixed(1)}% 
                    {parseFloat(formData.price) > estimatedValue ? ' above' : ' below'} ATTOM estimate
                  </p>
                )}
              </div>

              <div className="space-y-2">
                <Label htmlFor="property_type">Property Type</Label>
                <Select
                  value={formData.property_type}
                  onValueChange={(value) => handleFormChange("property_type", value)}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="Select a type" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="single_family">Single Family</SelectItem>
                    <SelectItem value="condo">Condo</SelectItem>
                    <SelectItem value="townhouse">Townhouse</SelectItem>
                    <SelectItem value="multi_family">Multi-Family</SelectItem>
                    <SelectItem value="land">Land</SelectItem>
                    <SelectItem value="commercial">Commercial</SelectItem>
                    <SelectItem value="other">Other</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="listing_type">Listing Type</Label>
                <Select
                  value={formData.listing_type}
                  onValueChange={(value) => handleFormChange("listing_type", value)}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="sale">For Sale</SelectItem>
                    <SelectItem value="lease">For Lease</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="property_use">Property Use</Label>
                <Input
                  id="property_use"
                  type="text"
                  value={formData.property_use}
                  onChange={(e) => handleFormChange("property_use", e.target.value)}
                  placeholder="e.g., Residential, Commercial"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="land_use">Land Use</Label>
                <Input
                  id="land_use"
                  type="text"
                  value={formData.land_use}
                  onChange={(e) => handleFormChange("land_use", e.target.value)}
                  placeholder="e.g., Single Family Residential"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="zoning">Zoning</Label>
                <Input
                  id="zoning"
                  type="text"
                  value={formData.zoning}
                  onChange={(e) => handleFormChange("zoning", e.target.value)}
                  placeholder="e.g., R-1, C-2"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="bedrooms" className="flex items-center gap-1"><Bed className="w-4 h-4" /> Bedrooms</Label>
                <Input
                  id="bedrooms"
                  type="number"
                  value={formData.bedrooms}
                  onChange={(e) => handleFormChange("bedrooms", e.target.value)}
                  placeholder="3"
                  min="0"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="bathrooms" className="flex items-center gap-1"><Bath className="w-4 h-4" /> Bathrooms</Label>
                <Input
                  id="bathrooms"
                  type="number"
                  step="0.5"
                  value={formData.bathrooms}
                  onChange={(e) => handleFormChange("bathrooms", e.target.value)}
                  placeholder="2.5"
                  min="0"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="square_feet" className="flex items-center gap-1"><Square className="w-4 h-4" /> Square Feet</Label>
                <Input
                  id="square_feet"
                  type="number"
                  value={formData.square_feet}
                  onChange={(e) => handleFormChange("square_feet", e.target.value)}
                  placeholder="2000"
                  min="0"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="lot_size">Lot Size (acres)</Label>
                <Input
                  id="lot_size"
                  type="number"
                  step="0.01"
                  value={formData.lot_size}
                  onChange={(e) => handleFormChange("lot_size", e.target.value)}
                  placeholder="0.25"
                  min="0"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="year_built" className="flex items-center gap-1"><Calendar className="w-4 h-4" /> Year Built</Label>
                <Input
                  id="year_built"
                  type="number"
                  value={formData.year_built}
                  onChange={(e) => handleFormChange("year_built", e.target.value)}
                  placeholder="2020"
                  min="1800"
                  max={new Date().getFullYear()}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="waterfront">Waterfront</Label>
                <Select
                  value={formData.waterfront.toString()}
                  onValueChange={(value) => handleFormChange("waterfront", value === 'true')}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="Is it waterfront?" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="false">No</SelectItem>
                    <SelectItem value="true">Yes</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="mls_number">MLS Number</Label>
                <Input
                  id="mls_number"
                  type="text"
                  value={formData.mls_number}
                  onChange={(e) => handleFormChange("mls_number", e.target.value)}
                  placeholder="MLS123456"
                />
              </div>
            </CardContent>

            <Separator className="my-6" />

            <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-2">
                <Label htmlFor="development_name">Development Name</Label>
                <Input
                  id="development_name"
                  type="text"
                  value={formData.development_name}
                  onChange={(e) => handleFormChange("development_name", e.target.value)}
                  placeholder="e.g., Oak Ridge Estates"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="subdivision">Subdivision</Label>
                <Input
                  id="subdivision"
                  type="text"
                  value={formData.subdivision}
                  onChange={(e) => handleFormChange("subdivision", e.target.value)}
                  placeholder="e.g., Sunset Hills Phase 2"
                />
              </div>
            </CardContent>

            <Separator className="my-6" />

            <CardContent className="space-y-6">
              <div className="space-y-2">
                <div className="flex justify-between items-center">
                  <Label htmlFor="description">Description</Label>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={handleGenerateDescription}
                    className="flex items-center gap-1 text-sm"
                  >
                    <Sparkles className="w-4 h-4" /> Generate with AI
                  </Button>
                </div>
                <Textarea
                  id="description"
                  value={formData.description}
                  onChange={(e) => handleFormChange("description", e.target.value)}
                  placeholder="Beautiful property with modern amenities..."
                  rows={4}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="features">Features (comma-separated)</Label>
                <Input
                  id="features"
                  type="text"
                  value={formData.features}
                  onChange={(e) => handleFormChange("features", e.target.value)}
                  placeholder="Pool, Hardwood Floors, Granite Countertops"
                />
              </div>
            </CardContent>
          </Card>

          {/* Legal & Location Information */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <List className="w-5 h-5 text-green-500" />
                Legal & Location Information
              </CardTitle>
            </CardHeader>
            <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-2">
                <Label htmlFor="census_tract">Census Tract/Block</Label>
                <Input
                  id="census_tract"
                  type="text"
                  value={formData.census_tract}
                  onChange={(e) => handleFormChange("census_tract", e.target.value)}
                  placeholder="e.g., 123.45"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="coordinates">Coordinates (Lat, Long)</Label>
                <Input
                  id="coordinates"
                  type="text"
                  value={formData.coordinates}
                  onChange={(e) => handleFormChange("coordinates", e.target.value)}
                  placeholder="e.g., 37.7749, -122.4194"
                />
              </div>
            </CardContent>

            <CardContent className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
              <div className="space-y-2">
                <Label htmlFor="township">Township (Twn)</Label>
                <Input
                  id="township"
                  type="text"
                  value={formData.township}
                  onChange={(e) => handleFormChange("township", e.target.value)}
                  placeholder="e.g., 12N"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="range">Range (Rng)</Label>
                <Input
                  id="range"
                  type="text"
                  value={formData.range}
                  onChange={(e) => handleFormChange("range", e.target.value)}
                  placeholder="e.g., 8W"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="section">Section (Sec)</Label>
                <Input
                  id="section"
                  type="text"
                  value={formData.section}
                  onChange={(e) => handleFormChange("section", e.target.value)}
                  placeholder="e.g., 15"
                />
              </div>
            </CardContent>

            <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
              <div className="space-y-2">
                <Label htmlFor="block">Block</Label>
                <Input
                  id="block"
                  type="text"
                  value={formData.block}
                  onChange={(e) => handleFormChange("block", e.target.value)}
                  placeholder="e.g., 12"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="lot">Lot</Label>
                <Input
                  id="lot"
                  type="text"
                  value={formData.lot}
                  onChange={(e) => handleFormChange("lot", e.target.value)}
                  placeholder="e.g., 5"
                />
              </div>
            </CardContent>

            <CardContent className="mt-4">
              <div className="space-y-2">
                <Label htmlFor="legal_description">Legal Description</Label>
                <Textarea
                  id="legal_description"
                  value={formData.legal_description}
                  onChange={(e) => handleFormChange("legal_description", e.target.value)}
                  placeholder="Full legal property description from tax records..."
                  rows={3}
                />
              </div>
            </CardContent>
          </Card>

          {/* Primary Photo */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Upload className="w-5 h-5 text-amber-500" />
                Primary Photo
              </CardTitle>
            </CardHeader>
            <CardContent className="flex flex-col items-center gap-4">
              {formData.primary_photo_url ? (
                <div className="relative w-full max-w-md">
                  <img
                    src={formData.primary_photo_url}
                    alt="Property"
                    className="w-full h-64 object-cover rounded-xl border border-slate-200"
                  />
                  <Button
                    type="button"
                    variant="destructive"
                    size="sm"
                    onClick={() => handleFormChange("primary_photo_url", "")}
                    className="absolute top-2 right-2 flex items-center gap-1"
                  >
                    <Trash2 className="w-4 h-4" /> Remove
                  </Button>
                </div>
              ) : (
                <Label className="flex flex-col items-center justify-center w-full max-w-md h-48 border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:border-amber-500 transition-colors">
                  <Input
                    type="file"
                    accept="image/*"
                    onChange={handlePhotoUpload}
                    className="hidden"
                    disabled={uploadingPhoto}
                  />
                  <Upload className="w-12 h-12 mx-auto mb-4 text-slate-400" />
                  <p className="text-slate-600 dark:text-slate-400">
                    {uploadingPhoto ? "Uploading..." : "Click to upload property photo"}
                  </p>
                  {uploadingPhoto && <Loader2 className="w-4 h-4 animate-spin text-amber-500 mt-2" />}
                </Label>
              )}
            </CardContent>
          </Card>

          {/* Current Owner Information */}
          <Card>
            <CardHeader>
              <div className="flex justify-between items-center">
                <CardTitle className="flex items-center gap-2">
                  <User className="w-5 h-5 text-blue-500" />
                  Current Property Owner(s)
                </CardTitle>
                <Button
                  type="button"
                  onClick={addSeller}
                  variant="outline"
                  size="sm"
                  className="flex items-center gap-1"
                  disabled={sellers.length >= 2}
                >
                  <UserPlus className="w-4 h-4" /> Add Co-Owner
                </Button>
              </div>
              <CardDescription>
                Owner details can be auto-filled from tax records.
              </CardDescription>
            </CardHeader>

            <CardContent className="space-y-6">
              {sellers.map((seller, index) => (
                <div key={index} className="relative rounded-lg border p-4 bg-slate-50 dark:bg-slate-800">
                  {sellers.length > 1 && (
                    <Button
                      type="button"
                      onClick={() => removeSeller(index)}
                      variant="ghost"
                      size="icon"
                      className="absolute top-2 right-2 text-destructive hover:text-destructive/80"
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  )}
                  <h3 className="text-md font-semibold text-slate-900 dark:text-white mb-4">
                    {index === 0 ? "Current Owner" : `Co-Owner ${index + 1}`}
                  </h3>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="md:col-span-2 space-y-2">
                      <Label htmlFor={`seller-name-${index}`}>Full Name</Label>
                      <Input
                        id={`seller-name-${index}`}
                        type="text"
                        value={seller.name}
                        onChange={(e) => handleSellerChange(index, 'name', e.target.value)}
                        placeholder="John Doe"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor={`seller-email-${index}`}>Email Address</Label>
                      <Input
                        id={`seller-email-${index}`}
                        type="email"
                        value={seller.email}
                        onChange={(e) => handleSellerChange(index, 'email', e.target.value)}
                        placeholder="john@example.com"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor={`seller-cell-phone-${index}`}>Cell Phone</Label>
                      <Input
                        id={`seller-cell-phone-${index}`}
                        type="tel"
                        value={seller.cell_phone}
                        onChange={(e) => handleSellerChange(index, 'cell_phone', e.target.value)}
                        placeholder="+1 555-123-4567"
                      />
                    </div>

                    <div className="md:col-span-2 space-y-2">
                      <Label htmlFor={`seller-home-phone-${index}`}>Home Phone</Label>
                      <Input
                        id={`seller-home-phone-${index}`}
                        type="tel"
                        value={seller.home_phone}
                        onChange={(e) => handleSellerChange(index, 'home_phone', e.target.value)}
                        placeholder="+1 555-987-6543"
                      />
                    </div>
                  </div>

                  <div className="mt-4 space-y-2">
                    <Label htmlFor={`seller-mailing-address-${index}`}>Tax Mailing Address</Label>
                    <Input
                      id={`seller-mailing-address-${index}`}
                      type="text"
                      value={seller.mailing_address}
                      onChange={(e) => handleSellerChange(index, 'mailing_address', e.target.value)}
                      placeholder="Mailing address from tax records"
                    />
                    <p className="text-xs text-slate-500 dark:text-slate-400">Where the owner receives tax bills and official correspondence</p>
                  </div>
                </div>
              ))}
            </CardContent>
          </Card>

          {/* Agents */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <UserPlus className="w-5 h-5 text-pink-500" />
                Agent Information
              </CardTitle>
            </CardHeader>

            <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-2">
                <Label htmlFor="listing_agent_id">Listing Agent</Label>
                <Select
                  value={formData.listing_agent_id || ""}
                  onValueChange={(value) => handleFormChange("listing_agent_id", value)}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="Select listing agent" />
                  </SelectTrigger>
                  <SelectContent>
                    {agents.length === 0 ? (
                      <div className="px-2 py-4 text-center text-sm text-slate-500">
                        No agents found
                      </div>
                    ) : (
                      agents.map(agent => (
                        <SelectItem key={agent.id} value={agent.id}>
                          {agent.name}{agent.isCurrentUser ? " (Me)" : ""}
                        </SelectItem>
                      ))
                    )}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="selling_agent_id">Selling Agent</Label>
                <Select
                  value={formData.selling_agent_id || ""}
                  onValueChange={(value) => handleFormChange("selling_agent_id", value)}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="Select selling agent" />
                  </SelectTrigger>
                  <SelectContent>
                    {agents.length === 0 ? (
                      <div className="px-2 py-4 text-center text-sm text-slate-500">
                        No agents found
                      </div>
                    ) : (
                      agents.map(agent => (
                        <SelectItem key={agent.id} value={agent.id}>
                          {agent.name}{agent.isCurrentUser ? " (Me)" : ""}
                        </SelectItem>
                      ))
                    )}
                  </SelectContent>
                </Select>
              </div>
            </CardContent>
          </Card>

          {/* Service Providers */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Building2 className="w-5 h-5 text-cyan-500" />
                Service Providers
              </CardTitle>
            </CardHeader>
            <CardContent className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="space-y-2">
                <Label htmlFor="title_company">Title Company</Label>
                <Input
                  id="title_company"
                  type="text"
                  value={formData.title_company}
                  onChange={(e) => handleFormChange("title_company", e.target.value)}
                  placeholder="ABC Title Company"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="mortgage_company">Mortgage Company</Label>
                <Input
                  id="mortgage_company"
                  type="text"
                  value={formData.mortgage_company}
                  onChange={(e) => handleFormChange("mortgage_company", e.target.value)}
                  placeholder="XYZ Mortgage"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="inspection_company">Inspection Company</Label>
                <Input
                  id="inspection_company"
                  type="text"
                  value={formData.inspection_company}
                  onChange={(e) => handleFormChange("inspection_company", e.target.value)}
                  placeholder="Quality Inspections"
                />
              </div>
            </CardContent>
          </Card>

          {/* Listing Information */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <List className="w-5 h-5 text-orange-500" />
                Listing Information
              </CardTitle>
            </CardHeader>
            <CardContent className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="space-y-2">
                <Label htmlFor="status">Status</Label>
                <Select
                  value={formData.status}
                  onValueChange={(value) => handleFormChange("status", value)}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="Select status" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="pending">Pending</SelectItem>
                    <SelectItem value="sold">Sold</SelectItem>
                    <SelectItem value="cancelled">Cancelled</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="listing_date">Listing Date</Label>
                <Input
                  id="listing_date"
                  type="date"
                  value={formData.listing_date}
                  onChange={(e) => handleFormChange("listing_date", e.target.value)}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="closing_date">Closing Date</Label>
                <Input
                  id="closing_date"
                  type="date"
                  value={formData.closing_date}
                  onChange={(e) => handleFormChange("closing_date", e.target.value)}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="expiration_date">Expiration Date</Label>
                <Input
                  id="expiration_date"
                  type="date"
                  value={formData.expiration_date}
                  onChange={(e) => handleFormChange("expiration_date", e.target.value)}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="days_on_market">Days on Market</Label>
                <Input
                  id="days_on_market"
                  type="number"
                  value={formData.days_on_market}
                  onChange={(e) => handleFormChange("days_on_market", e.target.value)}
                  min="0"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="virtual_tour_url">Virtual Tour URL</Label>
                <Input
                  id="virtual_tour_url"
                  type="url"
                  value={formData.virtual_tour_url}
                  onChange={(e) => handleFormChange("virtual_tour_url", e.target.value)}
                  placeholder="https://tour.example.com"
                />
              </div>
            </CardContent>

            <CardContent className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-4">
              <div className="space-y-2">
                <Label htmlFor="commission_rate">Commission Rate (%)</Label>
                <Input
                  id="commission_rate"
                  type="number"
                  step="0.1"
                  value={formData.commission_rate}
                  onChange={(e) => handleFormChange("commission_rate", e.target.value)}
                  min="0"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="listing_side_commission">Listing Side Commission (%)</Label>
                <Input
                  id="listing_side_commission"
                  type="number"
                  step="0.1"
                  value={formData.listing_side_commission}
                  onChange={(e) => handleFormChange("listing_side_commission", e.target.value)}
                  min="0"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="selling_side_commission">Selling Side Commission (%)</Label>
                <Input
                  id="selling_side_commission"
                  type="number"
                  step="0.1"
                  value={formData.selling_side_commission}
                  onChange={(e) => handleFormChange("selling_side_commission", e.target.value)}
                  min="0"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="agent_split_percentage">Agent Split Percentage (%)</Label>
                <Input
                  id="agent_split_percentage"
                  type="number"
                  step="1"
                  value={formData.agent_split_percentage}
                  onChange={(e) => handleFormChange("agent_split_percentage", e.target.value)}
                  min="0"
                  max="100"
                />
              </div>
            </CardContent>
          </Card>


          {/* Submit Button */}
          <div className="flex justify-end gap-4">
            <Button
              type="button"
              variant="outline"
              onClick={() => navigate(createPageUrl("Properties"))}
            >
              Cancel
            </Button>
            <Button
              type="submit"
              disabled={isSubmitting}
              className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
              size="lg"
            >
              {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              {propertyId ? (isSubmitting ? "Updating..." : "Update Property") : (isSubmitting ? "Creating..." : "Create Property")}
            </Button>
          </div>
        </form>
      </div>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import { base44 } from "@/api/base44Client";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { 
  ArrowLeft, 
  AlertTriangle, 
  TrendingDown, 
  DollarSign, 
  Camera, 
  MapPin, 
  Calendar,
  Sparkles,
  CheckCircle,
  XCircle,
  Target,
  MessageSquare,
  Share2,
  RefreshCw,
  Mail, // Added Mail icon
  Send // Added Send icon
} from "lucide-react";
import { createPageUrl } from "@/utils";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Input } from "@/components/ui/input"; // Added Input component
import { toast } from "sonner";

export default function PropertyAdviceAI() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const propertyId = searchParams.get('propertyId');
  
  const playGeneratingSound = () => {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAo=');
    audio.volume = 0.4;
    audio.play().catch(() => {});
  };
  
  const playSuccessSound = () => {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAo=');
    audio.volume = 0.5;
    audio.play().catch(() => {});
  };
  
  const playErrorSound = () => {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAo=');
    audio.volume = 0.3;
    audio.play().catch(() => {});
  };
  
  const [property, setProperty] = useState(null);
  const [analysis, setAnalysis] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [showEmailModal, setShowEmailModal] = useState(false);
  const [isSendingEmail, setIsSendingEmail] = useState(false);
  const [owners, setOwners] = useState([]); // New state for owners
  const [hasShownToast, setHasShownToast] = useState(false);
  const [progress, setProgress] = useState(0);
  const [emailForm, setEmailForm] = useState({
    selectedOwners: [], // Changed from sendToOwner to selectedOwners array
    sendToAgent: false,
    customEmails: '',
    customMessage: ''
  });

  useEffect(() => {
    if (propertyId) {
      setHasShownToast(false);
      loadPropertyAndAnalyze();
    }
  }, [propertyId]);

  const loadPropertyAndAnalyze = async () => {
    setIsLoading(true);
    try {
      // Load property
      const properties = await base44.entities.Property.filter({ id: propertyId });
      const prop = properties.length > 0 ? properties[0] : null;
      
      if (!prop) {
        throw new Error("Property not found");
      }
      
      setProperty(prop);

      // Parse sellers info to get owners
      if (prop.sellers_info) {
        try {
          const sellersData = JSON.parse(prop.sellers_info);
          if (Array.isArray(sellersData)) {
            setOwners(sellersData);
          }
        } catch (e) {
          console.error("Error parsing sellers_info:", e);
          setOwners([]);
        }
      } else {
        setOwners([]);
      }
      
      // Load saved AI advice if exists
      if (prop.enriched_data) {
        try {
          const enrichedData = typeof prop.enriched_data === 'string' 
            ? JSON.parse(prop.enriched_data) 
            : prop.enriched_data;
          
          if (enrichedData.ai_advice) {
            setAnalysis(enrichedData.ai_advice);
            setIsLoading(false);
            return; // Don't generate new analysis if we have saved one
          }
        } catch (e) {
          console.error("Error loading saved AI advice:", e);
        }
      }
      
      // Calculate days on market
      const listingDate = prop.listing_date ? new Date(prop.listing_date) : new Date(prop.created_date);
      const today = new Date();
      const daysOnMarket = Math.floor((today - listingDate) / (1000 * 60 * 60 * 24));
      
      setIsLoading(false);
      
      // Generate AI analysis only if no saved data
      await generateAnalysis(prop, daysOnMarket);
      
    } catch (error) {
      console.error("Error loading property:", error);
      toast.error("Failed to load property data.");
      setIsLoading(false);
    }
  };

  const generateAnalysis = async (prop, daysOnMarket) => {
    setIsAnalyzing(true);
    setProgress(0);
    
    playGeneratingSound();
    
    // Animate progress from 0 to 90% over 10 seconds
    const progressInterval = setInterval(() => {
      setProgress(prev => {
        if (prev >= 90) return 90;
        return prev + 2;
      });
    }, 200);
    
    try {
      const prompt = `You are an expert real estate advisor analyzing a property that has been on the market for ${daysOnMarket} days.

Property Details:
- Address: ${prop.address}, ${prop.city}, ${prop.state}
- Price: $${prop.price?.toLocaleString()}
- Type: ${prop.property_type}
- Bedrooms: ${prop.bedrooms || 'N/A'}
- Bathrooms: ${prop.bathrooms || 'N/A'}
- Square Feet: ${prop.square_feet?.toLocaleString() || 'N/A'}
- Days on Market: ${daysOnMarket}
- Description: ${prop.description || 'No description provided'}
- Features: ${prop.features || 'None listed'}

Provide a comprehensive analysis in JSON format with the following structure:
{
  "severity": "critical|high|moderate",
  "primaryIssue": "Brief description of the main problem",
  "detailedAnalysis": {
    "pricing": {
      "issue": "Description of pricing issue",
      "recommendation": "Specific pricing recommendation",
      "impact": "Expected impact of change"
    },
    "marketing": {
      "issue": "Marketing weaknesses identified",
      "recommendation": "Specific marketing improvements",
      "impact": "Expected results"
    },
    "presentation": {
      "issue": "Property presentation problems",
      "recommendation": "How to improve showing",
      "impact": "Expected improvement"
    },
    "timing": {
      "issue": "Market timing considerations",
      "recommendation": "Strategic timing advice",
      "impact": "Potential outcomes"
    }
  },
  "immediateActions": [
    {
      "priority": 1-5,
      "action": "Specific action to take",
      "timeframe": "When to do it",
      "difficulty": "easy|moderate|hard"
    }
  ],
  "longTermStrategy": [
    "Strategic recommendation 1",
    "Strategic recommendation 2",
    "Strategic recommendation 3"
  ],
  "marketInsights": {
    "competitivePosition": "Analysis of how property compares",
    "buyerPsychology": "What buyers might be thinking",
    "seasonalFactors": "How season/timing affects sale"
  },
  "successPrediction": {
    "withChanges": "Probability of sale if recommendations followed",
    "withoutChanges": "Probability if no changes made",
    "timeToSale": "Expected days to sale with changes"
  }
}`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt: prompt,
        response_json_schema: {
          type: "object",
          properties: {
            severity: { type: "string" },
            primaryIssue: { type: "string" },
            detailedAnalysis: { type: "object" },
            immediateActions: {
              type: "array",
              items: { type: "object" }
            },
            longTermStrategy: {
              type: "array",
              items: { type: "string" }
            },
            marketInsights: { type: "object" },
            successPrediction: { type: "object" }
          }
        }
      });

      const adviceData = {
        ...response,
        generated_at: new Date().toISOString(),
        days_on_market: daysOnMarket
      };

      setAnalysis(adviceData);

      // Save to property enriched_data
      if (prop?.id) {
        try {
          const existingEnrichedData = prop.enriched_data 
            ? (typeof prop.enriched_data === 'string' ? JSON.parse(prop.enriched_data) : prop.enriched_data)
            : {};

          await base44.entities.Property.update(prop.id, {
            enriched_data: JSON.stringify({
              ...existingEnrichedData,
              ai_advice: adviceData
            })
          });

          // Refresh global data
          window.dispatchEvent(new Event('refreshGlobalData'));
        } catch (saveError) {
          console.error('Error saving AI advice:', saveError);
        }
      }
      
      clearInterval(progressInterval);
      setProgress(100);
      
      playSuccessSound();
      
      // Scroll to results section smoothly
      setTimeout(() => {
        const resultsSection = document.getElementById('analysis-results');
        if (resultsSection) {
          resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);

      // Only show toast once per generation
      if (!hasShownToast) {
        setHasShownToast(true);
        toast.success("Analysis Generated - New AI recommendations are ready!", {
          duration: 7000,
          action: {
            label: "View Now",
            onClick: () => {
              const resultsSection = document.getElementById('analysis-results');
              if (resultsSection) {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }
          }
        });
      }
    } catch (error) {
      console.error("Error generating analysis:", error);
      toast.error("Failed to generate AI analysis. Please try again.");
      playErrorSound();
      clearInterval(progressInterval);
    } finally {
      setIsAnalyzing(false);
      setProgress(0);
    }
  };

  const getSeverityColor = (severity) => {
    const colors = {
      critical: "bg-red-100 text-red-800 border-red-300",
      high: "bg-orange-100 text-orange-800 border-orange-300",
      moderate: "bg-yellow-100 text-yellow-800 border-yellow-300"
    };
    return colors[severity] || colors.moderate;
  };

  const getDifficultyIcon = (difficulty) => {
    if (difficulty === 'easy') return <CheckCircle className="w-4 h-4 text-green-600" />;
    if (difficulty === 'moderate') return <Target className="w-4 h-4 text-orange-600" />;
    return <AlertTriangle className="w-4 h-4 text-red-600" />;
  };

  const handleSendEmail = async () => {
    if (!property || !analysis) return;

    const recipients = new Set(); // Use a Set to avoid duplicate emails
    
    // Add selected owner emails
    emailForm.selectedOwners.forEach(ownerEmail => {
      const owner = owners.find(o => o.email === ownerEmail);
      if (owner && owner.email) {
        recipients.add(owner.email);
      }
    });
    
    // Add listing agent email
    if (emailForm.sendToAgent && property.listing_agent_id) {
      try {
        const users = await base44.entities.User.filter({ id: property.listing_agent_id });
        if (users.length > 0 && users[0].email) {
          recipients.add(users[0].email);
        }
      } catch (error) {
        console.error("Error getting agent email:", error);
        toast.error("Failed to retrieve listing agent's email.");
      }
    }
    
    // Add custom emails
    if (emailForm.customEmails.trim()) {
      const customEmails = emailForm.customEmails
        .split(',')
        .map(e => e.trim())
        .filter(e => e.length > 0 && e.includes('@')); // Basic email validation
      customEmails.forEach(email => recipients.add(email));
    }

    if (recipients.size === 0) {
      toast.error("Please select at least one recipient.");
      return;
    }

    setIsSendingEmail(true);

    try {
      const listingDate = property.listing_date ? new Date(property.listing_date) : new Date(property.created_date);
      const daysOnMarket = Math.floor((new Date() - listingDate) / (1000 * 60 * 60 * 24));

      // Format the advice as HTML email
      const emailBody = `
        <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;">
          <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px;">
            <h1 style="color: white; margin: 0; font-size: 28px; text-align: center;">üè† Property Action Plan & Recommendations</h1>
            <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 16px; text-align: center;">AI-Powered Strategic Analysis by RealtyMind</p>
          </div>

          <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
            <h2 style="color: #1e293b; margin: 0 0 15px 0;">üìç Property Details</h2>
            <p style="margin: 5px 0;"><strong>Address:</strong> ${property.address}, ${property.city}, ${property.state}</p>
            <p style="margin: 5px 0;"><strong>Price:</strong> $${property.price?.toLocaleString()}</p>
            <p style="margin: 5px 0;"><strong>Days on Market:</strong> ${daysOnMarket} days</p>
            <p style="margin: 5px 0;"><strong>Type:</strong> ${property.property_type?.replace('_', ' ')}</p>
            <p style="margin: 5px 0;"><strong>Beds/Baths:</strong> ${property.bedrooms || 'N/A'}/${property.bathrooms || 'N/A'}</p>
            ${property.square_feet ? `<p style="margin: 5px 0;"><strong>Square Feet:</strong> ${property.square_feet.toLocaleString()}</p>` : ''}
          </div>

          ${emailForm.customMessage ? `
            <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 20px;">
              <h3 style="color: #1e40af; margin: 0 0 10px 0;">üìù Personal Message</h3>
              <p style="color: #1e293b; margin: 0; white-space: pre-wrap;">${emailForm.customMessage}</p>
            </div>
          ` : ''}

          <div style="background: #fef2f2; padding: 20px; border-radius: 8px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
            <h2 style="color: #991b1b; margin: 0 0 10px 0;">‚ö†Ô∏è Primary Issue: <span style="font-weight: normal;">${analysis.severity?.toUpperCase()}</span></h2>
            <p style="color: #1e293b; margin: 0;">${analysis.primaryIssue}</p>
          </div>

          <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
            <h2 style="color: #1e293b; margin: 0 0 20px 0;">üìä Detailed Analysis</h2>
            
            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
              <h3 style="color: #dc2626; margin: 0 0 10px 0;">üí∞ Pricing Analysis</h3>
              <p style="margin: 5px 0;"><strong>Issue:</strong> ${analysis.detailedAnalysis?.pricing?.issue || 'N/A'}</p>
              <p style="margin: 5px 0;"><strong>Recommendation:</strong> ${analysis.detailedAnalysis?.pricing?.recommendation || 'N/A'}</p>
              <p style="margin: 5px 0; color: #059669;"><strong>Expected Impact:</strong> ${analysis.detailedAnalysis?.pricing?.impact || 'N/A'}</p>
            </div>

            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
              <h3 style="color: #2563eb; margin: 0 0 10px 0;">üì¢ Marketing Analysis</h3>
              <p style="margin: 5px 0;"><strong>Issue:</strong> ${analysis.detailedAnalysis?.marketing?.issue || 'N/A'}</p>
              <p style="margin: 5px 0;"><strong>Recommendation:</strong> ${analysis.detailedAnalysis?.marketing?.recommendation || 'N/A'}</p>
              <p style="margin: 5px 0; color: #059669;"><strong>Expected Impact:</strong> ${analysis.detailedAnalysis?.marketing?.impact || 'N/A'}</p>
            </div>

            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
              <h3 style="color: #7c3aed; margin: 0 0 10px 0;">üì∏ Presentation Analysis</h3>
              <p style="margin: 5px 0;"><strong>Issue:</strong> ${analysis.detailedAnalysis?.presentation?.issue || 'N/A'}</p>
              <p style="margin: 5px 0;"><strong>Recommendation:</strong> ${analysis.detailedAnalysis?.presentation?.recommendation || 'N/A'}</p>
              <p style="margin: 5px 0; color: #059669;"><strong>Expected Impact:</strong> ${analysis.detailedAnalysis?.presentation?.impact || 'N/A'}</p>
            </div>

            <div style="padding-bottom: 15px;">
              <h3 style="color: #f97316; margin: 0 0 10px 0;">üìÖ Timing Analysis</h3>
              <p style="margin: 5px 0;"><strong>Issue:</strong> ${analysis.detailedAnalysis?.timing?.issue || 'N/A'}</p>
              <p style="margin: 5px 0;"><strong>Recommendation:</strong> ${analysis.detailedAnalysis?.timing?.recommendation || 'N/A'}</p>
              <p style="margin: 5px 0; color: #059669;"><strong>Expected Impact:</strong> ${analysis.detailedAnalysis?.timing?.impact || 'N/A'}</p>
            </div>
          </div>

          <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 20px;">
            <h2 style="color: #065f46; margin: 0 0 15px 0;">üéØ Immediate Action Plan</h2>
            ${analysis.immediateActions?.sort((a, b) => a.priority - b.priority).map((action, idx) => `
              <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #d1fae5;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                  <span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 14px; white-space: nowrap;">Priority ${action.priority}</span>
                  <span style="background: #e2e8f0; color: #475569; padding: 4px 8px; border-radius: 4px; font-size: 12px; text-transform: uppercase; white-space: nowrap;">${action.difficulty}</span>
                  <span style="color: #64748b; font-size: 14px; white-space: nowrap;">‚è±Ô∏è ${action.timeframe}</span>
                </div>
                <p style="margin: 0; font-weight: 600; color: #1e293b;">${action.action}</p>
              </div>
            `).join('')}
          </div>

          <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
            <h2 style="color: #1e293b; margin: 0 0 15px 0;">üìà Long-Term Strategy</h2>
            <ul style="margin: 0; padding-left: 20px;">
              ${analysis.longTermStrategy?.map(strategy => `
                <li style="margin-bottom: 10px; color: #475569;">${strategy}</li>
              `).join('')}
            </ul>
          </div>

          <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
            <h2 style="color: #92400e; margin: 0 0 15px 0;">üí° Market Insights</h2>
            <div style="margin-bottom: 10px;">
              <strong style="color: #78350f;">Competitive Position:</strong>
              <p style="margin: 5px 0 0 0; color: #1e293b;">${analysis.marketInsights?.competitivePosition || 'N/A'}</p>
            </div>
            <div style="margin-bottom: 10px;">
              <strong style="color: #78350f;">Buyer Psychology:</strong>
              <p style="margin: 5px 0 0 0; color: #1e293b;">${analysis.marketInsights?.buyerPsychology || 'N/A'}</p>
            </div>
            <div>
              <strong style="color: #78350f;">Seasonal Factors:</strong>
              <p style="margin: 5px 0 0 0; color: #1e293b;">${analysis.marketInsights?.seasonalFactors || 'N/A'}</p>
            </div>
          </div>

          <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); padding: 25px; border-radius: 8px; text-align: center;">
            <h2 style="color: white; margin: 0 0 20px 0;">üéØ Success Prediction</h2>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 6px;">
                <p style="color: rgba(255,255,255,0.8); margin: 0 0 5px 0; font-size: 12px;">With Changes</p>
                <p style="color: white; margin: 0; font-size: 24px; font-weight: bold;">${analysis.successPrediction?.withChanges || 'N/A'}</p>
              </div>
              <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 6px;">
                <p style="color: rgba(255,255,255,0.8); margin: 0 0 5px 0; font-size: 12px;">Without Changes</p>
                <p style="color: white; margin: 0; font-size: 24px; font-weight: bold;">${analysis.successPrediction?.withoutChanges || 'N/A'}</p>
              </div>
              <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 6px;">
                <p style="color: rgba(255,255,255,0.8); margin: 0 0 5px 0; font-size: 12px;">Time to Sale</p>
                <p style="color: white; margin: 0; font-size: 24px; font-weight: bold;">${analysis.successPrediction?.timeToSale || 'N/A'}</p>
              </div>
            </div>
          </div>

          <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; color: #64748b; font-size: 14px;">
            <p style="margin: 0;">Generated by <strong>RealtyMind</strong> - The Mind Behind Every Deal</p>
            <p style="margin: 5px 0 0 0;">AI-Powered Real Estate Intelligence</p>
          </div>
        </div>
      `;

      // Send email to all recipients
      for (const recipient of Array.from(recipients)) { // Convert Set to Array
        await base44.integrations.Core.SendEmail({
          to: recipient,
          subject: `üè† Action Plan & Recommendations - ${property.address}`,
          body: emailBody,
          from_name: "RealtyMind"
        });
      }

      toast.success(`Email sent successfully to ${recipients.size} recipient${recipients.size > 1 ? 's' : ''}!`);
      setShowEmailModal(false);
      setEmailForm({
        selectedOwners: [],
        sendToAgent: false,
        customEmails: '',
        customMessage: ''
      });

    } catch (error) {
      console.error("Error sending email:", error);
      toast.error("Failed to send email. Please try again.");
    } finally {
      setIsSendingEmail(false);
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6 flex items-center justify-center">
        <Card className="border-2 border-indigo-200 bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 overflow-hidden relative max-w-md w-full">
          <div className="absolute inset-0 bg-gradient-to-r from-indigo-500/5 via-purple-500/5 to-pink-500/5 animate-pulse"></div>
          <CardContent className="p-12 text-center relative z-10">
            <div className="relative w-32 h-32 mx-auto mb-8">
              <div className="absolute inset-0 border-4 border-indigo-200 rounded-full"></div>
              <div className="absolute inset-0 border-4 border-transparent border-t-indigo-600 rounded-full animate-spin"></div>
              <div className="absolute inset-3 border-4 border-purple-200 rounded-full"></div>
              <div className="absolute inset-3 border-4 border-transparent border-b-purple-600 rounded-full animate-spin" style={{ animationDirection: 'reverse', animationDuration: '1.5s' }}></div>
              <div className="absolute inset-0 flex items-center justify-center">
                <div className="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg animate-pulse">
                  <Sparkles className="w-8 h-8 text-white" />
                </div>
              </div>
            </div>
            <div className="space-y-4">
              <h3 className="text-2xl font-bold text-slate-900">Loading Property...</h3>
              <p className="text-slate-600 max-w-md mx-auto">
                Preparing AI analysis tools
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!property) {
    return (
      <div className="p-8 max-w-7xl mx-auto">
        <Card>
          <CardContent className="p-12 text-center">
            <XCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h2 className="text-2xl font-bold mb-2">Property Not Found</h2>
            <p className="text-slate-600 mb-6">The requested property could not be found.</p>
            <Button onClick={() => navigate(createPageUrl("Properties"))}>
              Back to Properties
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  const listingDate = property.listing_date ? new Date(property.listing_date) : new Date(property.created_date);
  const daysOnMarket = Math.floor((new Date() - listingDate) / (1000 * 60 * 60 * 24));

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <Card className="border-2 border-indigo-200 bg-gradient-to-r from-indigo-50 to-purple-50">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <Button
                variant="ghost"
                onClick={() => navigate(createPageUrl("PropertyDetail") + `?id=${propertyId}`)}
              >
                <ArrowLeft className="w-4 h-4 mr-2" />
                Back to Property
              </Button>
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  onClick={() => generateAnalysis(property, daysOnMarket)}
                  disabled={isAnalyzing}
                >
                  <RefreshCw className={`w-4 h-4 mr-2 ${isAnalyzing ? 'animate-spin' : ''}`} />
                  Regenerate Analysis
                </Button>
                {analysis && (
                  <Button
                    onClick={() => setShowEmailModal(true)}
                    className="bg-green-600 hover:bg-green-700 text-white"
                    disabled={isAnalyzing}
                  >
                    <Mail className="w-4 h-4 mr-2" />
                    Email Advice
                  </Button>
                )}
              </div>
            </div>

            <div className="flex items-start gap-4">
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                <Sparkles className="w-6 h-6 text-white" />
              </div>
              <div className="flex-1">
                <h1 className="text-3xl font-bold text-slate-900 mb-2">
                  AI Property Analysis & Recommendations
                </h1>
                <p className="text-slate-600 mb-4">
                  Intelligent insights powered by PropertySync AI to help you sell faster
                </p>
                
                <div className="flex flex-wrap items-center gap-4">
                  <div className="flex items-center gap-2 text-slate-700">
                    <MapPin className="w-4 h-4" />
                    <span className="font-semibold">{property.address}</span>
                  </div>
                  <div className="flex items-center gap-2 text-slate-700">
                    <DollarSign className="w-4 h-4" />
                    <span className="font-semibold">${property.price?.toLocaleString()}</span>
                  </div>
                  <Badge className="bg-red-100 text-red-800 border-red-300">
                    <Calendar className="w-3 h-3 mr-1" />
                    {daysOnMarket} Days on Market
                  </Badge>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {isAnalyzing ? (
          <Card className="border-2 border-indigo-200 bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 overflow-hidden relative">
            <div className="absolute inset-0 bg-gradient-to-r from-indigo-500/5 via-purple-500/5 to-pink-500/5 animate-pulse"></div>
            <CardContent className="p-12 text-center relative z-10">
              <div className="relative w-32 h-32 mx-auto mb-8">
                {/* Outer rotating ring */}
                <div className="absolute inset-0 border-4 border-indigo-200 dark:border-indigo-800 rounded-full"></div>
                <div className="absolute inset-0 border-4 border-transparent border-t-indigo-600 rounded-full animate-spin"></div>
                
                {/* Middle rotating ring - opposite direction */}
                <div className="absolute inset-3 border-4 border-purple-200 dark:border-purple-800 rounded-full"></div>
                <div className="absolute inset-3 border-4 border-transparent border-b-purple-600 rounded-full animate-spin" style={{ animationDirection: 'reverse', animationDuration: '1.5s' }}></div>
                
                {/* Center icon */}
                <div className="absolute inset-0 flex items-center justify-center">
                  <div className="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg animate-pulse">
                    <Sparkles className="w-8 h-8 text-white" />
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <h3 className="text-2xl font-bold text-slate-900 dark:text-white">
                  Generating AI Analysis...
                </h3>
                <p className="text-slate-600 dark:text-slate-400 max-w-md mx-auto">
                  Our AI is analyzing market data, comparable properties, and strategic opportunities to create personalized recommendations
                </p>
                
                {/* Loading steps */}
                <div className="mt-8 space-y-3 max-w-sm mx-auto">
                  <div className="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-300">
                    <div className="w-2 h-2 bg-indigo-600 rounded-full animate-pulse"></div>
                    <span>Analyzing pricing strategy...</span>
                  </div>
                  <div className="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-300">
                    <div className="w-2 h-2 bg-purple-600 rounded-full animate-pulse" style={{ animationDelay: '0.2s' }}></div>
                    <span>Reviewing marketing effectiveness...</span>
                  </div>
                  <div className="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-300">
                    <div className="w-2 h-2 bg-pink-600 rounded-full animate-pulse" style={{ animationDelay: '0.4s' }}></div>
                    <span>Evaluating presentation quality...</span>
                  </div>
                  <div className="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-300">
                    <div className="w-2 h-2 bg-blue-600 rounded-full animate-pulse" style={{ animationDelay: '0.6s' }}></div>
                    <span>Generating action plan...</span>
                  </div>
                </div>

                <div className="mt-6 max-w-xs mx-auto">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-semibold text-slate-700">Progress</span>
                    <span className="text-sm font-bold text-indigo-600">{progress}%</span>
                  </div>
                  <div className="h-3 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                    <div 
                      className="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-200 rounded-full"
                      style={{ width: `${progress}%` }}
                    ></div>
                  </div>
                </div>

                <p className="text-xs text-slate-500 dark:text-slate-400 mt-4">
                  This usually takes 10-15 seconds
                </p>
              </div>
            </CardContent>
          </Card>
        ) : !isAnalyzing && analysis && (
          <div id="analysis-results">
            {/* Primary Issue Alert */}
            <Card className={`border-2 ${getSeverityColor(analysis.severity)}`}>
              <CardContent className="p-6">
                <div className="flex items-center gap-3 mb-3">
                  <AlertTriangle className="w-6 h-6" />
                  <h2 className="text-xl font-bold">Primary Issue Identified</h2>
                  <Badge className={getSeverityColor(analysis.severity)}>
                    {analysis.severity?.toUpperCase()}
                  </Badge>
                </div>
                <p className="text-lg">{analysis.primaryIssue}</p>
              </CardContent>
            </Card>

            {/* Detailed Analysis */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* Pricing Analysis */}
              <Card className="border-l-4 border-l-red-500">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <DollarSign className="w-5 h-5 text-red-600" />
                    Pricing Analysis
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Issue</h4>
                    <p className="text-slate-700">{analysis.detailedAnalysis?.pricing?.issue}</p>
                  </div>
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Recommendation</h4>
                    <p className="text-slate-700">{analysis.detailedAnalysis?.pricing?.recommendation}</p>
                  </div>
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Expected Impact</h4>
                    <p className="text-green-700 font-medium">{analysis.detailedAnalysis?.pricing?.impact}</p>
                  </div>
                </CardContent>
              </Card>

              {/* Marketing Analysis */}
              <Card className="border-l-4 border-l-blue-500">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Share2 className="w-5 h-5 text-blue-600" />
                    Marketing Analysis
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Issue</h4>
                    <p className="text-slate-700">{analysis.detailedAnalysis?.marketing?.issue}</p>
                  </div>
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Recommendation</h4>
                    <p className="text-slate-700">{analysis.detailedAnalysis?.marketing?.recommendation}</p>
                  </div>
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Expected Impact</h4>
                    <p className="text-green-700 font-medium">{analysis.detailedAnalysis?.marketing?.impact}</p>
                  </div>
                </CardContent>
              </Card>

              {/* Presentation Analysis */}
              <Card className="border-l-4 border-l-purple-500">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Camera className="w-5 h-5 text-purple-600" />
                    Presentation Analysis
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Issue</h4>
                    <p className="text-slate-700">{analysis.detailedAnalysis?.presentation?.issue}</p>
                  </div>
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Recommendation</h4>
                    <p className="text-slate-700">{analysis.detailedAnalysis?.presentation?.recommendation}</p>
                  </div>
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Expected Impact</h4>
                    <p className="text-green-700 font-medium">{analysis.detailedAnalysis?.presentation?.impact}</p>
                  </div>
                </CardContent>
              </Card>

              {/* Timing Analysis */}
              <Card className="border-l-4 border-l-orange-500">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Calendar className="w-5 h-5 text-orange-600" />
                    Timing Analysis
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Issue</h4>
                    <p className="text-slate-700">{analysis.detailedAnalysis?.timing?.issue}</p>
                  </div>
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Recommendation</h4>
                    <p className="text-slate-700">{analysis.detailedAnalysis?.timing?.recommendation}</p>
                  </div>
                  <div>
                    <h4 className="font-semibold text-sm text-slate-500 mb-1">Expected Impact</h4>
                    <p className="text-green-700 font-medium">{analysis.detailedAnalysis?.timing?.impact}</p>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Immediate Actions */}
            <Card className="border-2 border-green-200 bg-green-50">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Target className="w-5 h-5 text-green-600" />
                  Immediate Action Plan
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {analysis.immediateActions?.sort((a, b) => a.priority - b.priority).map((action, idx) => (
                    <div key={idx} className="flex items-start gap-3 p-4 bg-white rounded-lg border border-green-200">
                      <div className="flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-700 font-bold text-sm">
                        {action.priority}
                      </div>
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          {getDifficultyIcon(action.difficulty)}
                          <span className="text-xs text-slate-500">{action.difficulty?.toUpperCase()}</span>
                          <Badge variant="outline" className="text-xs">{action.timeframe}</Badge>
                        </div>
                        <p className="font-medium text-slate-900">{action.action}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            {/* Long Term Strategy */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <TrendingDown className="w-5 h-5 text-indigo-600" />
                  Long-Term Strategy
                </CardTitle>
              </CardHeader>
              <CardContent>
                <ul className="space-y-3">
                  {analysis.longTermStrategy?.map((strategy, idx) => (
                    <li key={idx} className="flex items-start gap-3">
                      <CheckCircle className="w-5 h-5 text-indigo-600 mt-0.5 flex-shrink-0" />
                      <span className="text-slate-700">{strategy}</span>
                    </li>
                  ))}
                </ul>
              </CardContent>
            </Card>

            {/* Market Insights */}
            <Card className="border-2 border-purple-200 bg-purple-50">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <MessageSquare className="w-5 h-5 text-purple-600" />
                  Market Insights
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <h4 className="font-semibold text-sm text-slate-700 mb-2">Competitive Position</h4>
                  <p className="text-slate-600">{analysis.marketInsights?.competitivePosition}</p>
                </div>
                <div>
                  <h4 className="font-semibold text-sm text-slate-700 mb-2">Buyer Psychology</h4>
                  <p className="text-slate-600">{analysis.marketInsights?.buyerPsychology}</p>
                </div>
                <div>
                  <h4 className="font-semibold text-sm text-slate-700 mb-2">Seasonal Factors</h4>
                  <p className="text-slate-600">{analysis.marketInsights?.seasonalFactors}</p>
                </div>
              </CardContent>
            </Card>

            {/* Success Prediction */}
            <Card className="border-2 border-indigo-200 bg-gradient-to-r from-indigo-50 to-blue-50">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Sparkles className="w-5 h-5 text-indigo-600" />
                  Success Prediction
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="text-center p-4 bg-white rounded-lg border border-indigo-200">
                    <p className="text-sm text-slate-500 mb-2">With Changes</p>
                    <p className="text-3xl font-bold text-green-600">{analysis.successPrediction?.withChanges}</p>
                  </div>
                  <div className="text-center p-4 bg-white rounded-lg border border-indigo-200">
                    <p className="text-sm text-slate-500 mb-2">Without Changes</p>
                    <p className="text-3xl font-bold text-red-600">{analysis.successPrediction?.withoutChanges}</p>
                  </div>
                  <div className="text-center p-4 bg-white rounded-lg border border-indigo-200">
                    <p className="text-sm text-slate-500 mb-2">Expected Time to Sale</p>
                    <p className="text-3xl font-bold text-indigo-600">{analysis.successPrediction?.timeToSale}</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        )}
      </div>

      {/* Email Modal */}
      <Dialog open={showEmailModal} onOpenChange={setShowEmailModal}>
        <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <Mail className="w-5 h-5 text-indigo-600" />
              Email Property Action Plan
            </DialogTitle>
            <DialogDescription>
              Send the comprehensive action plan and recommendations to property stakeholders
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-6 py-4"> {/* Added padding-y for consistent spacing */}
            {/* Property Quick Info */}
            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
              <p className="font-semibold text-slate-900">{property?.address}</p>
              <p className="text-sm text-slate-600">{property?.city}, {property?.state}</p>
            </div>

            {/* Recipients */}
            <div className="space-y-4">
              <h3 className="font-semibold text-slate-900">Select Recipients</h3>
              
              {/* Property Owners */}
              {owners.length > 0 && (
                <div className="space-y-2">
                  <Label className="text-sm font-medium text-slate-700">Property Owners:</Label>
                  {owners.map((owner, idx) => (
                    <div key={idx} className="flex items-center space-x-2">
                      <Checkbox
                        id={`owner-${idx}`}
                        checked={emailForm.selectedOwners.includes(owner.email)}
                        onCheckedChange={(checked) => {
                          setEmailForm(prev => ({
                            ...prev,
                            selectedOwners: checked 
                              ? [...prev.selectedOwners, owner.email]
                              : prev.selectedOwners.filter(e => e !== owner.email)
                          }));
                        }}
                        disabled={!owner.email} // Disable if no email is available
                      />
                      <Label htmlFor={`owner-${idx}`} className="cursor-pointer flex-1 text-slate-700">
                        <span className="font-medium">{owner.name || `Owner ${idx + 1}`}</span>
                        {owner.email ? (
                          <span className="text-sm text-slate-600 ml-2">({owner.email})</span>
                        ) : (
                          <span className="text-sm text-red-600 ml-2">(No email provided)</span>
                        )}
                      </Label>
                    </div>
                  ))}
                </div>
              )}

              {/* Listing Agent */}
              {property?.listing_agent_id && (
                <div className="flex items-center space-x-2">
                  <Checkbox
                    id="sendToAgent"
                    checked={emailForm.sendToAgent}
                    onCheckedChange={(checked) => 
                      setEmailForm(prev => ({...prev, sendToAgent: checked}))
                    }
                  />
                  <Label htmlFor="sendToAgent" className="cursor-pointer text-slate-700">
                    Listing Agent
                  </Label>
                </div>
              )}

              <div>
                <Label htmlFor="customEmails" className="mb-2 block text-slate-700">
                  Additional Recipients (comma-separated email addresses)
                </Label>
                <Input
                  id="customEmails"
                  type="text"
                  placeholder="email1@example.com, email2@example.com"
                  value={emailForm.customEmails}
                  onChange={(e) => 
                    setEmailForm(prev => ({...prev, customEmails: e.target.value}))
                  }
                />
              </div>
            </div>

            {/* Custom Message */}
            <div>
              <Label htmlFor="customMessage" className="mb-2 block text-slate-700">
                Personal Message (Optional)
              </Label>
              <Textarea
                id="customMessage"
                placeholder="Add a personal message to include with the action plan..."
                rows={4}
                value={emailForm.customMessage}
                onChange={(e) => 
                  setEmailForm(prev => ({...prev, customMessage: e.target.value}))
                }
              />
            </div>

            {/* Actions */}
            <div className="flex justify-end gap-3 pt-4 border-t">
              <Button
                variant="outline"
                onClick={() => setShowEmailModal(false)}
                disabled={isSendingEmail}
              >
                Cancel
              </Button>
              <Button
                onClick={handleSendEmail}
                disabled={isSendingEmail}
                className="bg-green-600 hover:bg-green-700 text-white"
              >
                {isSendingEmail ? (
                  <>
                    <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                    Sending...
                  </>
                ) : (
                  <>
                    <Send className="w-4 h-4 mr-2" />
                    Send Email
                  </>
                )}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { createPageUrl } from "@/utils";
import { toast } from "sonner";
import {
  ArrowLeft,
  Sparkles,
  DollarSign,
  Building2,
  Loader2,
  Search,
  MapPin,
  Calendar,
  Home,
  AlertCircle,
  Clock,
  TrendingUp,
  Eye,
  ChevronDown,
  ChevronUp,
  FileText,
  CheckCircle,
  RefreshCw,
  Target
} from "lucide-react";

export default function PropertyAdvisor() {
  const navigate = useNavigate();
  const [properties, setProperties] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [filters, setFilters] = useState({
    status: "all",
    property_type: "all"
  });
  const [isLoading, setIsLoading] = useState(true);
  const [analyzingPropertyId, setAnalyzingPropertyId] = useState(null);
  const [generatingActionPlan, setGeneratingActionPlan] = useState(null);
  const [generatingOptimizationPlan, setGeneratingOptimizationPlan] = useState(null); // New State
  const [recommendations, setRecommendations] = useState({});
  const [actionPlans, setActionPlans] = useState({});
  const [optimizationPlans, setOptimizationPlans] = useState({}); // New State
  const [propertyMarketInsights, setPropertyMarketInsights] = useState({});
  const [expandedPropertyId, setExpandedPropertyId] = useState(null);
  const [expandedActionPlanId, setExpandedActionPlanId] = useState(null);
  const [expandedOptimizationPlanId, setExpandedOptimizationPlanId] = useState(null); // New State

  useEffect(() => {
    loadProperties();
  }, []);

  const loadProperties = async () => {
    setIsLoading(true);
    try {
      const [user, propertyData] = await Promise.all([
        base44.auth.me(),
        base44.entities.Property.list("-created_date")
      ]);

      setCurrentUser(user);

      // Filter only active properties (not sold)
      const activeProperties = propertyData.filter(p =>
        p.status === 'active' || p.status === 'pending'
      );

      setProperties(activeProperties);
    } catch (error) {
      console.error("Error loading properties:", error);
    }
    setIsLoading(false);
  };

  const calculateDaysToExpiration = (property) => {
    if (!property.expiration_date) return null;
    
    const expirationDate = new Date(property.expiration_date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    expirationDate.setHours(0, 0, 0, 0);
    
    const diffTime = expirationDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays;
  };

  const generate30DayOptimizationPlan = async (property, daysOnMarket) => {
    setGeneratingOptimizationPlan(property.id);
    setExpandedOptimizationPlanId(property.id);
    setExpandedPropertyId(null); // Collapse other plans
    setExpandedActionPlanId(null); // Collapse other plans

    try {
      toast.info("Generating 30-day optimization plan...");
      
      const prompt = `You are an expert real estate strategist. A property has been on the market for ${daysOnMarket} days and is entering the optimization zone where strategic adjustments can prevent it from becoming stale.

Property Details:
- Address: ${property.address}, ${property.city}, ${property.state}
- Price: $${property.price?.toLocaleString()}
- Type: ${property.property_type?.replace('_', ' ')}
- Beds/Baths: ${property.bedrooms || 'N/A'}/${property.bathrooms || 'N/A'}
- Square Feet: ${property.square_feet?.toLocaleString() || 'N/A'}
- Year Built: ${property.year_built || 'N/A'}
- Days on Market: ${daysOnMarket}
- Description: ${property.description || 'No description'}
- Features: ${property.features || 'None'}

Generate a comprehensive 30-DAY MARKET OPTIMIZATION PLAN in JSON format with these key sections:

1.  situation_analysis:
    - market_position_and_buyer_psychology: text description
    - performance_review_needs: text description
    - opportunity_for_proactive_improvements: text description

2.  assessment_framework:
    - performance_review: text description (e.g., showing activity, online engagement, feedback patterns)
    - property_optimization_review: text description (e.g., staging, presentation, marketing materials)

3.  weekly_action_plan:
    - week1: {focus: string, tasks: array of strings, deliverables: array of strings}
    - week2: {focus: string, tasks: array of strings, deliverables: array of strings}
    - week3: {focus: string, tasks: array of strings, deliverables: array of strings}
    - week4: {focus: string, tasks: array of strings, deliverables: array of strings}

4.  specific_action_items:
    - daily_action_schedule_for_each_week: array of strings
    - analytics_and_tracking_metrics: array of strings
    - creative_marketing_tactics: array of strings
    - relationship_building_strategies: array of strings

5.  success_metrics:
    - engagement_metrics: text description (Week 1-2)
    - lead_generation_metrics: text description (Week 2-3)
    - market_response_metrics: text description (Week 3-4)
    - warning_signs_to_monitor: text description
    - positive_indicators_of_success: text description

6.  optimization_strategies:
    - pricing_psychology_tactics: text description
    - staging_and_presentation_optimization: text description
    - digital_marketing_optimization: text description

7.  expected_outcomes:
    - week1_2_enhanced_engagement_results: text description
    - week3_4_market_response_improvements: text description
    - success_probability_and_timeline: text description`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt: prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            situation_analysis: { 
              type: "object",
              properties: {
                market_position_and_buyer_psychology: { type: "string" },
                performance_review_needs: { type: "string" },
                opportunity_for_proactive_improvements: { type: "string" }
              }
            },
            assessment_framework: { 
              type: "object",
              properties: {
                performance_review: { type: "string" },
                property_optimization_review: { type: "string" }
              }
            },
            weekly_action_plan: { 
              type: "object",
              properties: {
                week1: { type: "object", properties: { focus: { type: "string" }, tasks: { type: "array", items: { type: "string" } }, deliverables: { type: "array", items: { type: "string" } } } },
                week2: { type: "object", properties: { focus: { type: "string" }, tasks: { type: "array", items: { type: "string" } }, deliverables: { type: "array", items: { type: "string" } } } },
                week3: { type: "object", properties: { focus: { type: "string" }, tasks: { type: "array", items: { type: "string" } }, deliverables: { type: "array", items: { type: "string" } } } },
                week4: { type: "object", properties: { focus: { type: "string" }, tasks: { type: "array", items: { type: "string" } }, deliverables: { type: "array", items: { type: "string" } } } }
              }
            },
            specific_action_items: { 
              type: "object",
              properties: {
                daily_action_schedule_for_each_week: { type: "array", items: { type: "string" } },
                analytics_and_tracking_metrics: { type: "array", items: { type: "string" } },
                creative_marketing_tactics: { type: "array", items: { type: "string" } },
                relationship_building_strategies: { type: "array", items: { type: "string" } }
              }
            },
            success_metrics: { 
              type: "object",
              properties: {
                engagement_metrics: { type: "string" },
                lead_generation_metrics: { type: "string" },
                market_response_metrics: { type: "string" },
                warning_signs_to_monitor: { type: "string" },
                positive_indicators_of_success: { type: "string" }
              }
            },
            optimization_strategies: { 
              type: "object",
              properties: {
                pricing_psychology_tactics: { type: "string" },
                staging_and_presentation_optimization: { type: "string" },
                digital_marketing_optimization: { type: "string" }
              }
            },
            expected_outcomes: { 
              type: "object",
              properties: {
                week1_2_enhanced_engagement_results: { type: "string" },
                week3_4_market_response_improvements: { type: "string" },
                success_probability_and_timeline: { type: "string" }
              }
            }
          }
        }
      });

      setOptimizationPlans(prev => ({
        ...prev,
        [property.id]: response
      }));

      toast.success("30-day optimization plan generated!");

    } catch (error) {
      console.error("Error generating optimization plan:", error);
      toast.error("Failed to generate optimization plan. Please try again.");
    }

    setGeneratingOptimizationPlan(null);
  };

  const generateComprehensiveActionPlan = async (property, daysOnMarket) => {
    setGeneratingActionPlan(property.id);
    setExpandedActionPlanId(property.id);
    setExpandedPropertyId(null); // Collapse other plans
    setExpandedOptimizationPlanId(null); // Collapse other plans

    try {
      toast.info("Generating comprehensive 60-day action plan...");
      
      const prompt = `You are an expert real estate strategist. A property has been on the market for ${daysOnMarket} days without selling and requires immediate strategic intervention.

Property Details:
- Address: ${property.address}, ${property.city}, ${property.state}
- Price: $${property.price?.toLocaleString()}
- Type: ${property.property_type?.replace('_', ' ')}
- Beds/Baths: ${property.bedrooms || 'N/A'}/${property.bathrooms || 'N/A'}
- Square Feet: ${property.square_feet?.toLocaleString() || 'N/A'}
- Year Built: ${property.year_built || 'N/A'}
- Days on Market: ${daysOnMarket}
- Description: ${property.description || 'No description'}
- Features: ${property.features || 'None'}

Generate a COMPREHENSIVE 60-DAY ACTION PLAN in JSON format with these sections:
1. situation_analysis - severity, buyer_perception, market_position, agent_motivation
2. immediate_assessment - market_analysis, property_evaluation, marketing_analysis (as text descriptions)
3. strategic_action_plan - pricing_strategy (3 options), property_improvements, marketing_makeover, event_marketing, agent_network_activation
4. weekly_action_timeline - week1, week2, week3, week4 with focus, tasks, deliverables
5. immediate_to_do_list - array of prioritized actions
6. success_metrics - 30_day_targets, 60_day_targets, kpis
7. emergency_protocols - backup plans
8. expert_insights - buyer psychology, agent motivation, proven strategies
9. estimated_outcomes - with full/partial/no implementation`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt: prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            situation_analysis: { type: "object" },
            immediate_assessment: { type: "object" },
            strategic_action_plan: { type: "object" },
            weekly_action_timeline: { type: "object" },
            immediate_to_do_list: { 
              type: "array",
              items: { type: "object" }
            },
            success_metrics: { type: "object" },
            emergency_protocols: { type: "object" },
            expert_insights: { type: "object" },
            estimated_outcomes: { type: "object" }
          }
        }
      });

      setActionPlans(prev => ({
        ...prev,
        [property.id]: response
      }));

      toast.success("Comprehensive 60-day action plan generated!");

    } catch (error) {
      console.error("Error generating action plan:", error);
      toast.error("Failed to generate action plan. Please try again.");
    }

    setGeneratingActionPlan(null);
  };

  const analyzePropertyListing = async (property) => {
    const prompt = `You are a real estate marketing expert. Analyze this property listing and provide specific, actionable recommendations to help it sell quickly.

Property Details:
- Address: ${property.address}, ${property.city}, ${property.state}
- Price: $${property.price?.toLocaleString()}
- Type: ${property.property_type?.replace('_', ' ')}
- Bedrooms: ${property.bedrooms || 'N/A'}
- Bathrooms: ${property.bathrooms || 'N/A'}
- Square Feet: ${property.square_feet?.toLocaleString() || 'N/A'}
- Year Built: ${property.year_built || 'N/A'}
- Days on Market: ${property.days_on_market || 0}
- Description: ${property.description || 'No description provided'}
- Features: ${property.features || 'No features listed'}
- Has Photos: ${property.primary_photo_url ? 'Yes' : 'No'}

Based on current real estate market trends, comparable properties in ${property.city}, ${property.state}, and best practices for selling homes quickly, provide:

1. **Pricing Strategy** - Is the price competitive? Should it be adjusted?
2. **Marketing Improvements** - How to improve the listing description and presentation
3. **Photography & Staging** - Visual improvements needed
4. **Property Improvements** - Physical improvements that add value
5. **Target Buyer Strategy** - Who should be targeted and how
6. **Urgency Tactics** - Specific actions to create urgency

Format your response as a JSON object with these exact keys:
- pricing_strategy: {recommendation: string, priority: "high"|"medium"|"low"}
- marketing_improvements: {recommendation: string, priority: "high"|"medium"|"low"}
- photography_staging: {recommendation: string, priority: "high"|"medium"|"low"}
- property_improvements: {recommendation: string, priority: "high"|"medium"|"low"}
- target_buyer_strategy: {recommendation: string, priority: "high"|"medium"|"low"}
- urgency_tactics: {recommendation: string, priority: "high"|"medium"|"low"}
- quick_wins: array of 3-5 quick action items (strings)
- estimated_impact: "high"|"medium"|"low"`;

    const response = await base44.integrations.Core.InvokeLLM({
      prompt,
      add_context_from_internet: true,
      response_json_schema: {
        type: "object",
        properties: {
          pricing_strategy: {
            type: "object",
            properties: {
              recommendation: { type: "string" },
              priority: { type: "string", enum: ["high", "medium", "low"] }
            },
            required: ["recommendation", "priority"]
          },
          marketing_improvements: {
            type: "object",
            properties: {
              recommendation: { type: "string" },
              priority: { type: "string", enum: ["high", "medium", "low"] }
            },
            required: ["recommendation", "priority"]
          },
          photography_staging: {
            type: "object",
            properties: {
              recommendation: { type: "string" },
              priority: { type: "string", enum: ["high", "medium", "low"] }
            },
            required: ["recommendation", "priority"]
          },
          property_improvements: {
            type: "object",
            properties: {
              recommendation: { type: "string" },
              priority: { type: "string", enum: ["high", "medium", "low"] }
            },
            required: ["recommendation", "priority"]
          },
          target_buyer_strategy: {
            type: "object",
            properties: {
              recommendation: { type: "string" },
              priority: { type: "string", enum: ["high", "medium", "low"] }
            },
            required: ["recommendation", "priority"]
          },
          urgency_tactics: {
            type: "object",
            properties: {
              recommendation: { type: "string" },
              priority: { type: "string", enum: ["high", "medium", "low"] }
            },
            required: ["recommendation", "priority"]
          },
          quick_wins: {
            type: "array",
            items: { type: "string" }
          },
          estimated_impact: {
            type: "string",
            enum: ["high", "medium", "low"]
          }
        },
        required: [
          "pricing_strategy", "marketing_improvements", "photography_staging",
          "property_improvements", "target_buyer_strategy", "urgency_tactics",
          "quick_wins", "estimated_impact"
        ]
      }
    });
    return response;
  };

  const analyzePropertyWithMarket = async (property) => {
    setAnalyzingPropertyId(property.id);
    setExpandedPropertyId(property.id);
    setExpandedActionPlanId(null); // Collapse other plans
    setExpandedOptimizationPlanId(null); // Collapse other plans

    try {
      toast.info("Analyzing property with AI...");
      
      const propertyAnalysis = await analyzePropertyListing(property);

      setRecommendations(prev => ({
        ...prev,
        [property.id]: propertyAnalysis
      }));

      toast.success("Analysis complete!");

    } catch (error) {
      console.error("Error analyzing property:", error);
      toast.error("Failed to analyze property");
    }

    setAnalyzingPropertyId(null);
  };

  const togglePropertyExpansion = (propertyId) => {
    if (expandedPropertyId === propertyId) {
      setExpandedPropertyId(null);
    } else {
      setExpandedPropertyId(propertyId);
      setExpandedActionPlanId(null); // Collapse action plan if regular analysis is expanded
      setExpandedOptimizationPlanId(null); // Collapse optimization plan if regular analysis is expanded
    }
  };

  const getPriorityColor = (priority) => {
    const colors = {
      high: "bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800",
      medium: "bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800",
      low: "bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800"
    };
    return colors[priority] || "bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300";
  };

  const getImpactIcon = (impact) => {
    if (impact === 'high') return <TrendingUp className="w-5 h-5 text-green-600" />;
    if (impact === 'medium') return <TrendingUp className="w-5 h-5 text-yellow-600" />;
    return <TrendingUp className="w-5 h-5 text-slate-600" />;
  };

  const getExpirationBadge = (daysToExpiration) => {
    if (daysToExpiration === null) return null;
    
    if (daysToExpiration < 0) {
      return (
        <Badge className="bg-red-100 text-red-700 border-red-300">
          <AlertCircle className="w-3 h-3 mr-1" />
          Expired {Math.abs(daysToExpiration)} days ago
        </Badge>
      );
    } else if (daysToExpiration === 0) {
      return (
        <Badge className="bg-red-100 text-red-700 border-red-300">
          <AlertCircle className="w-3 h-3 mr-1" />
          Expires Today
        </Badge>
      );
    } else if (daysToExpiration <= 7) {
      return (
        <Badge className="bg-orange-100 text-orange-700 border-orange-300">
          <Clock className="w-3 h-3 mr-1" />
          {daysToExpiration} days to expiration
        </Badge>
      );
    } else if (daysToExpiration <= 30) {
      return (
        <Badge className="bg-yellow-100 text-yellow-700 border-yellow-300">
          <Clock className="w-3 h-3 mr-1" />
          {daysToExpiration} days to expiration
        </Badge>
      );
    } else {
      return (
        <Badge className="bg-green-100 text-green-700 border-green-300">
          <Clock className="w-3 h-3 mr-1" />
          {daysToExpiration} days to expiration
        </Badge>
      );
    }
  };

  const getSeverityBadge = (severity) => {
    const badges = {
      critical: <Badge className="bg-red-600 text-white dark:bg-red-700">üö® CRITICAL</Badge>,
      high: <Badge className="bg-orange-600 text-white dark:bg-orange-700">‚ö†Ô∏è HIGH URGENCY</Badge>,
      moderate: <Badge className="bg-yellow-600 text-white dark:bg-yellow-700">‚ö° MODERATE</Badge>
    };
    return badges[severity] || badges.moderate;
  };

  if (isLoading) {
    return (
      <div className="space-y-4 animate-pulse">
        {Array(3).fill(0).map((_, i) => (
          <div key={i} className="app-card h-64 shimmer"></div>
        ))}
      </div>
    );
  }

  const filteredProperties = properties.filter(property => {
    const matchesSearch = !searchTerm ||
      property.address?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      property.city?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesStatus = filters.status === "all" || property.status === filters.status;
    const matchesType = filters.property_type === "all" || property.property_type === filters.property_type;
    return matchesSearch && matchesStatus && matchesType;
  });

  return (
    <div className="page-container">
      {/* Header */}
      <div className="app-card p-6">
        <div className="flex items-center gap-4">
          <Button
            variant="ghost"
            size="icon"
            onClick={() => navigate(createPageUrl("Properties"))}
            className="rounded-full"
          >
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600">
                <Sparkles className="w-6 h-6 text-white" />
              </div>
              <h1 className="app-title text-2xl">AI Property Listing Advisor</h1>
            </div>
            <p className="app-subtitle">
              Get personalized AI recommendations to help your properties sell faster
            </p>
          </div>
        </div>
      </div>

      {/* Info Card */}
      <div className="app-card p-6 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-950 dark:to-purple-950 border-indigo-200 dark:border-indigo-800">
        <div className="flex items-start gap-4">
          <FileText className="w-8 h-8 text-indigo-600 flex-shrink-0 mt-1" />
          <div>
            <h3 className="app-title text-lg mb-2">How It Works</h3>
            <p className="app-text mb-3">
              Click "Generate AI Report" on any property to receive comprehensive recommendations including:
            </p>
            <ul className="space-y-2 app-text">
              <li className="flex items-start gap-2">
                <div className="w-5 h-5 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center mt-0.5">
                  <span className="text-xs text-indigo-600 dark:text-indigo-300">1</span>
                </div>
                <span>Pricing strategy and market positioning</span>
              </li>
              <li className="flex items-start gap-2">
                <div className="w-5 h-5 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center mt-0.5">
                  <span className="text-xs text-indigo-600 dark:text-indigo-300">2</span>
                </div>
                <span>Marketing improvements and messaging</span>
              </li>
              <li className="flex items-start gap-2">
                <div className="w-5 h-5 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center mt-0.5">
                  <span className="text-xs text-indigo-600 dark:text-indigo-300">3</span>
                </div>
                <span>Quick wins you can implement immediately</span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      {/* Filters */}
      <Card className="border-0 shadow-sm bg-white/80 backdrop-blur-sm dark:bg-slate-800">
        <CardContent className="p-4">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
              <Input
                placeholder="Search properties..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10"
              />
            </div>

            <Select value={filters.status} onValueChange={(value) => setFilters(prev => ({ ...prev, status: value }))}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Status</SelectItem>
                <SelectItem value="active">Active</SelectItem>
                <SelectItem value="pending">Pending</SelectItem>
              </SelectContent>
            </Select>

            <Select value={filters.property_type} onValueChange={(value) => setFilters(prev => ({ ...prev, property_type: value }))}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Types</SelectItem>
                <SelectItem value="single_family">Single Family</SelectItem>
                <SelectItem value="condo">Condo</SelectItem>
                <SelectItem value="townhouse">Townhouse</SelectItem>
                <SelectItem value="multi_family">Multi Family</SelectItem>
                <SelectItem value="land">Land</SelectItem>
                <SelectItem value="commercial">Commercial</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardContent>
      </Card>

      {/* Properties List */}
      <div className="space-y-4">
        {filteredProperties.length === 0 ? (
          <div className="app-card p-16 text-center">
            <Building2 className="w-20 h-20 mx-auto mb-6 text-slate-300" />
            <h3 className="app-title text-xl mb-3">No Active Listings</h3>
            <p className="app-subtitle mb-6">
              You don't have any active property listings.
            </p>
            <Button onClick={() => navigate(createPageUrl("Properties"))} className="app-button">
              View All Properties
            </Button>
          </div>
        ) : (
          filteredProperties.map((property) => {
            const propertyRecommendations = recommendations[property.id];
            const propertyActionPlan = actionPlans[property.id];
            const propertyOptimizationPlan = optimizationPlans[property.id]; // New
            const isExpanded = expandedPropertyId === property.id;
            const isActionPlanExpanded = expandedActionPlanId === property.id;
            const isOptimizationPlanExpanded = expandedOptimizationPlanId === property.id; // New
            const isAnalyzing = analyzingPropertyId === property.id;
            const isGeneratingPlan = generatingActionPlan === property.id;
            const isGeneratingOptimization = generatingOptimizationPlan === property.id; // New
            const daysToExpiration = calculateDaysToExpiration(property);
            const daysOnMarket = property.days_on_market || 0;
            const needsActionPlan = daysOnMarket >= 60;
            const needsOptimization = daysOnMarket >= 30 && daysOnMarket < 60; // New condition

            return (
              <Card 
                key={property.id} 
                className={`overflow-hidden hover:shadow-lg transition-all ${
                  needsActionPlan ? 'border-2 border-red-300 dark:border-red-700' : 
                  needsOptimization ? 'border-2 border-yellow-300 dark:border-yellow-700' : ''
                }`}
              >
                {/* Property Header - Always Visible */}
                <div className={`p-6 ${
                  needsActionPlan ? 'bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-950 dark:to-orange-950' :
                  needsOptimization ? 'bg-gradient-to-r from-yellow-50 to-amber-50 dark:from-yellow-950 dark:to-amber-950' :
                  'bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900'
                }`}>
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex-1">
                      {needsActionPlan && (
                        <div className="mb-3 p-3 bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 rounded-lg">
                          <div className="flex items-center gap-2">
                            <AlertCircle className="w-5 h-5 text-red-600" />
                            <span className="font-semibold text-red-900 dark:text-red-300 text-sm">
                              üö® STALE LISTING ALERT - {daysOnMarket} Days on Market
                            </span>
                          </div>
                          <p className="text-xs text-red-700 dark:text-red-400 mt-1 ml-7">
                            This property requires immediate strategic intervention
                          </p>
                        </div>
                      )}

                      {needsOptimization && !needsActionPlan && (
                        <div className="mb-3 p-3 bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-700 rounded-lg">
                          <div className="flex items-center gap-2">
                            <Clock className="w-5 h-5 text-yellow-600" />
                            <span className="font-semibold text-yellow-900 dark:text-yellow-300 text-sm">
                              ‚ö° OPTIMIZATION WINDOW - {daysOnMarket} Days on Market
                            </span>
                          </div>
                          <p className="text-xs text-yellow-700 dark:text-yellow-400 mt-1 ml-7">
                            Perfect time for strategic improvements before listing becomes stale
                          </p>
                        </div>
                      )}

                      <div className="flex items-start gap-3 mb-3">
                        <Home className="w-5 h-5 text-slate-600 mt-1" />
                        <div className="flex-1">
                          <h3 className="app-title text-xl mb-1">{property.address}</h3>
                          <p className="app-text-muted text-sm">
                            {property.city}, {property.state} {property.zip_code}
                          </p>
                        </div>
                      </div>

                      <div className="flex flex-wrap gap-3 mb-3">
                        <Badge className="app-badge-primary">
                          <DollarSign className="w-3 h-3 mr-1" />
                          ${property.price?.toLocaleString()}
                        </Badge>
                        <Badge variant="outline" className="dark:bg-slate-800 dark:text-slate-300">
                          {property.bedrooms} beds ‚Ä¢ {property.bathrooms} baths
                        </Badge>
                        {property.square_feet && (
                          <Badge variant="outline" className="dark:bg-slate-800 dark:text-slate-300">
                            {property.square_feet?.toLocaleString()} sqft
                          </Badge>
                        )}
                        <Badge 
                          variant="outline" 
                          className={`${
                            needsActionPlan ? 'bg-red-100 text-red-700 border-red-300 dark:bg-red-900/30 dark:text-red-300 dark:border-red-700' :
                            needsOptimization ? 'bg-yellow-100 text-yellow-700 border-yellow-300 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-700' :
                            'dark:bg-slate-800 dark:text-slate-300'
                          }`}
                        >
                          <Calendar className="w-3 h-3 mr-1" />
                          {daysOnMarket} days on market
                        </Badge>
                        {getExpirationBadge(daysToExpiration)}
                      </div>
                    </div>

                    <div className="flex flex-col gap-2">
                      {needsActionPlan && !propertyActionPlan && (
                        <Button
                          onClick={() => generateComprehensiveActionPlan(property, daysOnMarket)}
                          disabled={isGeneratingPlan}
                          className="bg-red-600 hover:bg-red-700 text-white whitespace-nowrap shadow-lg"
                        >
                          {isGeneratingPlan ? (
                            <>
                              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                              Generating...
                            </>
                          ) : (
                            <>
                              <AlertCircle className="w-4 h-4 mr-2" />
                              60-Day Action Plan
                            </>
                          )}
                        </Button>
                      )}

                      {needsOptimization && !needsActionPlan && !propertyOptimizationPlan && (
                        <Button
                          onClick={() => generate30DayOptimizationPlan(property, daysOnMarket)}
                          disabled={isGeneratingOptimization}
                          className="bg-yellow-600 hover:bg-yellow-700 text-white whitespace-nowrap shadow-lg"
                        >
                          {isGeneratingOptimization ? (
                            <>
                              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                              Generating...
                            </>
                          ) : (
                            <>
                              <Clock className="w-4 h-4 mr-2" />
                              30-Day Optimization
                            </>
                          )}
                        </Button>
                      )}

                      {propertyActionPlan && (
                        <Button
                          onClick={() => {
                            setExpandedActionPlanId(isActionPlanExpanded ? null : property.id);
                            if (!isActionPlanExpanded) {
                              setExpandedPropertyId(null);
                              setExpandedOptimizationPlanId(null);
                            }
                          }}
                          variant="outline"
                          className="whitespace-nowrap border-red-300 dark:border-red-700"
                        >
                          {isActionPlanExpanded ? (
                            <>
                              <ChevronUp className="w-4 h-4 mr-2" />
                              Hide Action Plan
                            </>
                          ) : (
                            <>
                              <ChevronDown className="w-4 h-4 mr-2" />
                              View 60-Day Plan
                            </>
                          )}
                        </Button>
                      )}

                      {propertyOptimizationPlan && (
                        <Button
                          onClick={() => {
                            setExpandedOptimizationPlanId(isOptimizationPlanExpanded ? null : property.id);
                            if (!isOptimizationPlanExpanded) {
                              setExpandedPropertyId(null);
                              setExpandedActionPlanId(null);
                            }
                          }}
                          variant="outline"
                          className="whitespace-nowrap border-yellow-300 dark:border-yellow-700"
                        >
                          {isOptimizationPlanExpanded ? (
                            <>
                              <ChevronUp className="w-4 h-4 mr-2" />
                              Hide Optimization
                            </>
                          ) : (
                            <>
                              <ChevronDown className="w-4 h-4 mr-2" />
                              View 30-Day Plan
                            </>
                          )}
                        </Button>
                      )}

                      {!propertyRecommendations ? (
                        <Button
                          onClick={() => analyzePropertyWithMarket(property)}
                          disabled={isAnalyzing}
                          className="app-button whitespace-nowrap"
                        >
                          {isAnalyzing ? (
                            <>
                              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                              Analyzing...
                            </>
                          ) : (
                            <>
                              <Sparkles className="w-4 h-4 mr-2" />
                              Quick Analysis
                            </>
                          )}
                        </Button>
                      ) : (
                        <Button
                          onClick={() => togglePropertyExpansion(property.id)}
                          variant="outline"
                          className="whitespace-nowrap"
                        >
                          {isExpanded ? (
                            <>
                              <ChevronUp className="w-4 h-4 mr-2" />
                              Hide Analysis
                            </>
                          ) : (
                            <>
                              <ChevronDown className="w-4 h-4 mr-2" />
                              View Analysis
                            </>
                          )}
                        </Button>
                      )}
                      
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => navigate(createPageUrl(`PropertyDetail?id=${property.id}`))}
                      >
                        <Eye className="w-4 h-4 mr-2" />
                        View Details
                      </Button>
                    </div>
                  </div>
                </div>

                {/* Comprehensive Action Plan - Expandable */}
                {propertyActionPlan && isActionPlanExpanded && (
                  <div className="p-6 space-y-6 border-t-4 border-red-500 bg-gradient-to-br from-red-50/50 to-orange-50/50 dark:from-red-950/20 dark:to-orange-950/20">
                    {/* Header Banner */}
                    <div className="bg-red-600 text-white p-6 rounded-xl shadow-lg">
                      <h2 className="text-2xl font-bold mb-2 flex items-center gap-2">
                        üö® Property Not Selling - Complete Action Plan
                      </h2>
                      <p className="text-red-100">
                        {daysOnMarket} days on market requires immediate strategic intervention
                      </p>
                    </div>

                    {/* Situation Analysis */}
                    {propertyActionPlan.situation_analysis && (
                      <Card className="dark:bg-slate-900 dark:border-red-700 border-l-4 border-l-red-500">
                        <CardHeader>
                          <CardTitle className="flex items-center justify-between dark:text-white">
                            <span className="flex items-center gap-2">
                              <AlertCircle className="w-6 h-6 text-red-600" />
                              Situation Analysis
                            </span>
                            {getSeverityBadge(propertyActionPlan.situation_analysis.severity)}
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Buyer Perception:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.situation_analysis.buyer_perception}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Market Position Weaknesses:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.situation_analysis.market_position}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Agent Motivation Concerns:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.situation_analysis.agent_motivation}
                            </p>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Immediate Assessment */}
                    {propertyActionPlan.immediate_assessment && (
                      <Card className="dark:bg-slate-900 dark:border-yellow-700 border-l-4 border-l-yellow-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Eye className="w-6 h-6 text-yellow-600" />
                            Immediate Assessment (Week 1)
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Market Analysis:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.immediate_assessment.market_analysis}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Property Evaluation:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.immediate_assessment.property_evaluation}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Marketing Analysis:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.immediate_assessment.marketing_analysis}
                            </p>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Immediate To-Do List */}
                    {propertyActionPlan.immediate_to_do_list && propertyActionPlan.immediate_to_do_list.length > 0 && (
                      <Card className="dark:bg-slate-900 dark:border-orange-700 border-l-4 border-l-orange-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <CheckCircle className="w-6 h-6 text-orange-600" />
                            Immediate Action Items - Prioritized
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="space-y-3">
                            {propertyActionPlan.immediate_to_do_list
                              .sort((a, b) => a.priority - b.priority)
                              .map((item, index) => (
                                <div key={index} className={`p-4 rounded-lg border-2 ${
                                  item.priority <= 3 
                                    ? 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800'
                                    : item.priority <= 6
                                    ? 'bg-orange-50 border-orange-200 dark:bg-orange-900/20 dark:border-orange-800'
                                    : 'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-800'
                                }`}>
                                  <div className="flex items-start gap-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold ${
                                      item.priority <= 3 ? 'bg-red-600' : item.priority <= 6 ? 'bg-orange-600' : 'bg-yellow-600'
                                    }`}>
                                      {index + 1}
                                    </div>
                                    <div className="flex-1">
                                      <div className="flex items-center gap-2 mb-2">
                                        <Badge className={getPriorityColor(
                                          item.priority <= 3 ? 'high' : item.priority <= 6 ? 'medium' : 'low'
                                        )}>
                                          {item.category}
                                        </Badge>
                                        <Badge variant="outline" className="dark:bg-slate-800 dark:text-slate-300">
                                          {item.deadline}
                                        </Badge>
                                        <Badge variant="outline" className="dark:bg-slate-800 dark:text-slate-300">
                                          {item.difficulty}
                                        </Badge>
                                        {item.expected_impact && (
                                          <Badge variant="outline" className={`dark:bg-slate-800 dark:text-slate-300 ${getPriorityColor(item.expected_impact)}`}>
                                            Impact: {item.expected_impact}
                                          </Badge>
                                        )}
                                      </div>
                                      <p className="font-semibold text-slate-900 dark:text-white mb-1">
                                        {item.task}
                                      </p>
                                      <p className="text-xs text-slate-600 dark:text-slate-400">
                                        Responsible: {item.responsible}
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              ))}
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Pricing Strategy Options */}
                    {propertyActionPlan.strategic_action_plan?.pricing_strategy && (
                      <Card className="dark:bg-slate-900 dark:border-green-700 border-l-4 border-l-green-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <DollarSign className="w-6 h-6 text-green-600" />
                            Pricing Strategy Options
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                          {Object.entries(propertyActionPlan.strategic_action_plan.pricing_strategy)
                            .filter(([key]) => key.startsWith('option'))
                            .map(([key, option]) => {
                              const isRecommended = propertyActionPlan.strategic_action_plan.pricing_strategy.recommended_option === key;
                              return (
                                <div key={key} className={`p-4 rounded-lg border-2 ${
                                  isRecommended 
                                    ? 'bg-green-50 border-green-300 dark:bg-green-900/20 dark:border-green-700'
                                    : 'bg-slate-50 border-slate-200 dark:bg-slate-800 dark:border-slate-700'
                                }`}>
                                  <div className="flex items-start justify-between mb-2">
                                    <h4 className="font-semibold text-slate-900 dark:text-white">{option.title}</h4>
                                    {isRecommended && (
                                      <Badge className="bg-green-600 text-white">
                                        ‚≠ê Recommended
                                      </Badge>
                                    )}
                                  </div>
                                  <p className="text-sm text-slate-700 dark:text-slate-300 mb-2">
                                    <strong>Action:</strong> {option.action}
                                  </p>
                                  <p className="text-sm text-slate-600 dark:text-slate-400 mb-2">
                                    <strong>Timing:</strong> {option.timing}
                                  </p>
                                  <p className="text-sm text-slate-600 dark:text-slate-400">
                                    <strong>Expected Impact:</strong> {option.expected_impact}
                                  </p>
                                </div>
                              );
                            })}
                        </CardContent>
                      </Card>
                    )}

                    {/* Property Improvements */}
                    {propertyActionPlan.strategic_action_plan?.property_improvements && (
                      <Card className="dark:bg-slate-900 dark:border-blue-700 border-l-4 border-l-blue-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Building2 className="w-6 h-6 text-blue-600" />
                            Property Improvements Plan
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                          {/* High Impact Low Cost */}
                          {propertyActionPlan.strategic_action_plan.property_improvements.high_impact_low_cost?.length > 0 && (
                            <div>
                              <h4 className="font-semibold text-green-700 dark:text-green-400 mb-3 flex items-center gap-2">
                                <Sparkles className="w-4 h-4" />
                                High Impact, Low Cost (Do First!)
                              </h4>
                              <div className="space-y-2">
                                {propertyActionPlan.strategic_action_plan.property_improvements.high_impact_low_cost.map((item, index) => (
                                  <div key={index} className="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                                    <p className="font-medium text-slate-900 dark:text-white text-sm mb-1">
                                      {item.action}
                                    </p>
                                    <div className="flex flex-wrap gap-2 text-xs text-slate-600 dark:text-slate-400">
                                      <span>üí∞ {item.cost_estimate}</span>
                                      <span>‚Ä¢ ‚è±Ô∏è {item.timeframe}</span>
                                      <span>‚Ä¢ üìà {item.roi_impact}</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {/* Medium Investment */}
                          {propertyActionPlan.strategic_action_plan.property_improvements.medium_investment?.length > 0 && (
                            <div>
                              <h4 className="font-semibold text-yellow-700 dark:text-yellow-400 mb-3">
                                Medium Investment
                              </h4>
                              <div className="space-y-2">
                                {propertyActionPlan.strategic_action_plan.property_improvements.medium_investment.map((item, index) => (
                                  <div key={index} className="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
                                    <p className="font-medium text-slate-900 dark:text-white text-sm mb-1">
                                      {item.action}
                                    </p>
                                    <div className="flex flex-wrap gap-2 text-xs text-slate-600 dark:text-slate-400">
                                      <span>üí∞ {item.cost_estimate}</span>
                                      <span>‚Ä¢ ‚è±Ô∏è {item.timeframe}</span>
                                      <span>‚Ä¢ üìà {item.roi_impact}</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {/* Major Improvements */}
                          {propertyActionPlan.strategic_action_plan.property_improvements.major_improvements?.length > 0 && (
                            <div>
                              <h4 className="font-semibold text-red-700 dark:text-red-400 mb-3">
                                Major Improvements (If Justified)
                              </h4>
                              <div className="space-y-2">
                                {propertyActionPlan.strategic_action_plan.property_improvements.major_improvements.map((item, index) => (
                                  <div key={index} className="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                                    <p className="font-medium text-slate-900 dark:text-white text-sm mb-1">
                                      {item.action}
                                    </p>
                                    <p className="text-xs text-slate-600 dark:text-slate-400 mb-2">
                                      {item.justification}
                                    </p>
                                    <div className="flex flex-wrap gap-2 text-xs text-slate-600 dark:text-slate-400">
                                      <span>üí∞ {item.cost_estimate}</span>
                                      <span>‚Ä¢ ‚è±Ô∏è {item.timeframe}</span>
                                      <span>‚Ä¢ üìà {item.roi_impact}</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </CardContent>
                      </Card>
                    )}

                    {/* Marketing Makeover */}
                    {propertyActionPlan.strategic_action_plan?.marketing_makeover && (
                      <Card className="dark:bg-slate-900 dark:border-indigo-700 border-l-4 border-l-indigo-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Sparkles className="w-6 h-6 text-indigo-600" />
                            Marketing Makeover
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Photography & Visual Content:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.strategic_action_plan.marketing_makeover.photography_visual_content}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Listing Description Overhaul:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.strategic_action_plan.marketing_makeover.listing_description_overhaul}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Digital Marketing Expansion:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.strategic_action_plan.marketing_makeover.digital_marketing_expansion}
                            </p>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Event Marketing */}
                    {propertyActionPlan.strategic_action_plan?.event_marketing && (
                      <Card className="dark:bg-slate-900 dark:border-pink-700 border-l-4 border-l-pink-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Calendar className="w-6 h-6 text-pink-600" />
                            Event Marketing
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Open House Strategy:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.strategic_action_plan.event_marketing.open_house_strategy}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Creative Marketing Events:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.strategic_action_plan.event_marketing.creative_marketing_events}
                            </p>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Agent & Network Activation */}
                    {propertyActionPlan.strategic_action_plan?.agent_network_activation && (
                      <Card className="dark:bg-slate-900 dark:border-teal-700 border-l-4 border-l-teal-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <MapPin className="w-6 h-6 text-teal-600" />
                            Agent & Network Activation
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Agent Incentive Programs:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.strategic_action_plan.agent_network_activation.agent_incentive_programs}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Network Expansion:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                              {propertyActionPlan.strategic_action_plan.agent_network_activation.network_expansion}
                            </p>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Weekly Timeline */}
                    {propertyActionPlan.weekly_action_timeline && (
                      <Card className="dark:bg-slate-900 dark:border-purple-700 border-l-4 border-l-purple-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Calendar className="w-6 h-6 text-purple-600" />
                            4-Week Action Timeline
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                          {Object.entries(propertyActionPlan.weekly_action_timeline).map(([week, data]) => (
                            <div key={week} className="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-800">
                              <h4 className="font-semibold text-purple-900 dark:text-purple-300 mb-2 capitalize">
                                {week.replace(/(\d+)/, ' $1')}: {data.focus}
                              </h4>
                              <div className="space-y-2">
                                <div>
                                  <p className="text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    Critical Tasks:
                                  </p>
                                  <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                    {data.critical_tasks?.map((task, idx) => (
                                      <li key={idx}>{task}</li>
                                    ))}
                                  </ul>
                                </div>
                                <div>
                                  <p className="text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    Deliverables:
                                  </p>
                                  <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                    {data.deliverables?.map((deliverable, idx) => (
                                      <li key={idx}>{deliverable}</li>
                                    ))}
                                  </ul>
                                </div>
                              </div>
                            </div>
                          ))}
                        </CardContent>
                      </Card>
                    )}

                    {/* Success Metrics */}
                    {propertyActionPlan.success_metrics && (
                      <Card className="dark:bg-slate-900 dark:border-cyan-700 border-l-4 border-l-cyan-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <TrendingUp className="w-6 h-6 text-cyan-600" />
                            Success Metrics & Targets
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                          {propertyActionPlan.success_metrics['thirty_day_targets'] && (
                            <div>
                              <h4 className="font-semibold text-slate-900 dark:text-white mb-2">30-Day Targets:</h4>
                              <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                {propertyActionPlan.success_metrics['thirty_day_targets'].map((target, idx) => (
                                  <li key={idx}>{target}</li>
                                ))}
                              </ul>
                            </div>
                          )}
                          {propertyActionPlan.success_metrics['sixty_day_targets'] && (
                            <div>
                              <h4 className="font-semibold text-slate-900 dark:text-white mb-2">60-Day Targets:</h4>
                              <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                {propertyActionPlan.success_metrics['sixty_day_targets'].map((target, idx) => (
                                  <li key={idx}>{target}</li>
                                ))}
                              </ul>
                            </div>
                          )}
                          {propertyActionPlan.success_metrics['kpis_to_track'] && (
                            <div>
                              <h4 className="font-semibold text-slate-900 dark:text-white mb-2">KPIs to Track Weekly:</h4>
                              <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                {propertyActionPlan.success_metrics['kpis_to_track'].map((kpi, idx) => (
                                  <li key={idx}>{kpi}</li>
                                ))}
                              </ul>
                            </div>
                          )}
                        </CardContent>
                      </Card>
                    )}

                    {/* Emergency Protocols */}
                    {propertyActionPlan.emergency_protocols && (
                      <Card className="dark:bg-slate-900 dark:border-orange-700 border-l-4 border-l-orange-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <AlertCircle className="w-6 h-6 text-orange-600" />
                            Emergency Protocols
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                          {propertyActionPlan.emergency_protocols.if_no_improvement && (
                            <div>
                              <h4 className="font-semibold text-slate-900 dark:text-white mb-2">If No Improvement After 30 Days:</h4>
                              <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                {propertyActionPlan.emergency_protocols.if_no_improvement.map((action, idx) => (
                                  <li key={idx}>{action}</li>
                                ))}
                              </ul>
                            </div>
                          )}
                          {propertyActionPlan.emergency_protocols.red_flags && (
                            <div>
                              <h4 className="font-semibold text-slate-900 dark:text-white mb-2">Red Flags to Watch For:</h4>
                              <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                {propertyActionPlan.emergency_protocols.red_flags.map((flag, idx) => (
                                  <li key={idx}>{flag}</li>
                                ))}
                              </ul>
                            </div>
                          )}
                          {propertyActionPlan.emergency_protocols.alternative_strategies && (
                            <div>
                              <h4 className="font-semibold text-slate-900 dark:text-white mb-2">Alternative Strategies:</h4>
                              <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                {propertyActionPlan.emergency_protocols.alternative_strategies.map((strategy, idx) => (
                                  <li key={idx}>{strategy}</li>
                                ))}
                              </ul>
                            </div>
                          )}
                        </CardContent>
                      </Card>
                    )}

                    {/* Expert Insights */}
                    {propertyActionPlan.expert_insights && (
                      <Card className="dark:bg-slate-900 dark:border-pink-700 border-l-4 border-l-pink-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Sparkles className="w-6 h-6 text-pink-600" />
                            Expert Insights
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Buyer Psychology Strategies:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">{propertyActionPlan.expert_insights.buyer_psychology}</p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Agent Motivation Techniques:</p>
                            <p className="text-sm text-slate-600 dark:text-slate-400">{propertyActionPlan.expert_insights.agent_motivation}</p>
                          </div>
                          {propertyActionPlan.expert_insights.proven_strategies && (
                            <div>
                              <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Proven Success Strategies from Top Agents:</p>
                              <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                {propertyActionPlan.expert_insights.proven_strategies.map((strategy, idx) => (
                                  <li key={idx}>{strategy}</li>
                                ))}
                              </ul>
                            </div>
                          )}
                        </CardContent>
                      </Card>
                    )}

                    {/* Estimated Outcomes */}
                    {propertyActionPlan.estimated_outcomes && (
                      <Card className="dark:bg-slate-900 dark:border-indigo-700 border-l-4 border-l-indigo-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Target className="w-6 h-6 text-indigo-600" />
                            Estimated Outcomes
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {propertyActionPlan.estimated_outcomes.with_full_implementation && (
                              <div className="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-2 border-green-300 dark:border-green-700">
                                <h5 className="font-semibold text-green-900 dark:text-green-300 mb-3">
                                  ‚úÖ With Full Implementation
                                </h5>
                                <div className="space-y-2 text-sm">
                                  <p><strong>Time to Sale:</strong> {propertyActionPlan.estimated_outcomes.with_full_implementation.time_to_sale}</p>
                                  <p><strong>Probability:</strong> {propertyActionPlan.estimated_outcomes.with_full_implementation.probability_of_sale}</p>
                                  <p><strong>Expected Price:</strong> {propertyActionPlan.estimated_outcomes.with_full_implementation.expected_price}</p>
                                </div>
                              </div>
                            )}

                            {propertyActionPlan.estimated_outcomes.with_partial_implementation && (
                              <div className="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-2 border-yellow-300 dark:border-yellow-700">
                                <h5 className="font-semibold text-yellow-900 dark:text-yellow-300 mb-3">
                                  ‚ö° With Partial Implementation
                                </h5>
                                <div className="space-y-2 text-sm">
                                  <p><strong>Time to Sale:</strong> {propertyActionPlan.estimated_outcomes.with_partial_implementation.time_to_sale}</p>
                                  <p><strong>Probability:</strong> {propertyActionPlan.estimated_outcomes.with_partial_implementation.probability_of_sale}</p>
                                  <p><strong>Expected Price:</strong> {propertyActionPlan.estimated_outcomes.with_partial_implementation.expected_price}</p>
                                </div>
                              </div>
                            )}

                            {propertyActionPlan.estimated_outcomes.without_changes && (
                              <div className="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border-2 border-red-300 dark:border-red-700">
                                <h5 className="font-semibold text-red-900 dark:text-red-300 mb-3">
                                  ‚ùå Without Changes
                                </h5>
                                <div className="space-y-2 text-sm">
                                  <p><strong>Time to Sale:</strong> {propertyActionPlan.estimated_outcomes.without_changes.time_to_sale}</p>
                                  <p><strong>Probability:</strong> {propertyActionPlan.estimated_outcomes.without_changes.probability_of_sale}</p>
                                  <p><strong>Expected Price:</strong> {propertyActionPlan.estimated_outcomes.without_changes.expected_price}</p>
                                </div>
                              </div>
                            )}
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Action Buttons */}
                    <div className="flex flex-wrap justify-end gap-3 pt-4 border-t-2 border-red-300 dark:border-red-700">
                      <Button
                        onClick={() => navigate(createPageUrl(`PropertyDetail?id=${property.id}`))}
                        variant="outline"
                        className="dark:border-slate-700 dark:text-slate-300"
                      >
                        View Property Details
                      </Button>
                      <Button
                        onClick={() => generateComprehensiveActionPlan(property, daysOnMarket)}
                        disabled={isGeneratingPlan}
                        className="bg-red-600 hover:bg-red-700"
                      >
                        {isGeneratingPlan ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Refreshing...
                          </>
                        ) : (
                          <>
                            <RefreshCw className="w-4 h-4 mr-2" />
                            Refresh Action Plan
                          </>
                        )}
                      </Button>
                    </div>
                  </div>
                )}

                {/* 30-Day Optimization Plan - Expandable */}
                {propertyOptimizationPlan && isOptimizationPlanExpanded && (
                  <div className="p-6 space-y-6 border-t-4 border-yellow-500 bg-gradient-to-br from-yellow-50/50 to-amber-50/50 dark:from-yellow-950/20 dark:to-amber-950/20">
                    {/* Header Banner */}
                    <div className="bg-yellow-600 text-white p-6 rounded-xl shadow-lg">
                      <h2 className="text-2xl font-bold mb-2 flex items-center gap-2">
                        ‚ö° 30-Day Market Optimization Plan
                      </h2>
                      <p className="text-yellow-100">
                        {daysOnMarket} days on market - Perfect time for strategic improvements
                      </p>
                    </div>

                    {/* Situation Analysis */}
                    {propertyOptimizationPlan.situation_analysis && (
                      <Card className="dark:bg-slate-900 dark:border-yellow-700 border-l-4 border-l-yellow-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Target className="w-6 h-6 text-yellow-600" />
                            Situation Analysis
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          {Object.entries(propertyOptimizationPlan.situation_analysis).map(([key, value]) => (
                            <div key={key}>
                              <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1 capitalize">
                                {key.replace(/_/g, ' ')}:
                              </p>
                              <p className="text-sm text-slate-600 dark:text-slate-400">{value}</p>
                            </div>
                          ))}
                        </CardContent>
                      </Card>
                    )}

                    {/* Assessment Framework */}
                    {propertyOptimizationPlan.assessment_framework && (
                      <Card className="dark:bg-slate-900 dark:border-blue-700 border-l-4 border-l-blue-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <FileText className="w-6 h-6 text-blue-600" />
                            Assessment Framework
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          {Object.entries(propertyOptimizationPlan.assessment_framework).map(([key, value]) => (
                            <div key={key}>
                              <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1 capitalize">
                                {key.replace(/_/g, ' ')}:
                              </p>
                              <p className="text-sm text-slate-600 dark:text-slate-400">
                                {typeof value === 'object' ? JSON.stringify(value, null, 2) : value}
                              </p>
                            </div>
                          ))}
                        </CardContent>
                      </Card>
                    )}

                    {/* Weekly Action Plan */}
                    {propertyOptimizationPlan.weekly_action_plan && (
                      <Card className="dark:bg-slate-900 dark:border-purple-700 border-l-4 border-l-purple-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Calendar className="w-6 h-6 text-purple-600" />
                            4-Week Action Timeline
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                          {Object.entries(propertyOptimizationPlan.weekly_action_plan).map(([week, data]) => (
                            <div key={week} className="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-800">
                              <h4 className="font-semibold text-purple-900 dark:text-purple-300 mb-2 capitalize">
                                {week.replace(/(\d+)/, ' $1')}: {data.focus}
                              </h4>
                              <div className="space-y-2 text-sm">
                                <div>
                                  <p className="text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    Tasks:
                                  </p>
                                  <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                    {data.tasks?.map((task, idx) => (
                                      <li key={idx}>{task}</li>
                                    ))}
                                  </ul>
                                </div>
                                <div>
                                  <p className="text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    Deliverables:
                                  </p>
                                  <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                    {data.deliverables?.map((deliverable, idx) => (
                                      <li key={idx}>{deliverable}</li>
                                    ))}
                                  </ul>
                                </div>
                              </div>
                            </div>
                          ))}
                        </CardContent>
                      </Card>
                    )}

                    {/* Specific Action Items */}
                    {propertyOptimizationPlan.specific_action_items && (
                      <Card className="dark:bg-slate-900 dark:border-orange-700 border-l-4 border-l-orange-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <CheckCircle className="w-6 h-6 text-orange-600" />
                            Specific Action Items
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          {Object.entries(propertyOptimizationPlan.specific_action_items).map(([key, value]) => (
                            <div key={key}>
                              <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1 capitalize">
                                {key.replace(/_/g, ' ')}:
                              </p>
                              {Array.isArray(value) ? (
                                <ul className="list-disc list-inside space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                  {value.map((item, idx) => <li key={idx}>{item}</li>)}
                                </ul>
                              ) : (
                                <p className="text-sm text-slate-600 dark:text-slate-400">{value}</p>
                              )}
                            </div>
                          ))}
                        </CardContent>
                      </Card>
                    )}

                    {/* Success Metrics */}
                    {propertyOptimizationPlan.success_metrics && (
                      <Card className="dark:bg-slate-900 dark:border-green-700 border-l-4 border-l-green-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <TrendingUp className="w-6 h-6 text-green-600" />
                            Success Metrics & Targets
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          {Object.entries(propertyOptimizationPlan.success_metrics).map(([key, value]) => (
                            <div key={key}>
                              <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1 capitalize">
                                {key.replace(/_/g, ' ')}:
                              </p>
                              <p className="text-sm text-slate-600 dark:text-slate-400">
                                {typeof value === 'object' ? JSON.stringify(value, null, 2) : value}
                              </p>
                            </div>
                          ))}
                        </CardContent>
                      </Card>
                    )}

                    {/* Optimization Strategies */}
                    {propertyOptimizationPlan.optimization_strategies && (
                      <Card className="dark:bg-slate-900 dark:border-cyan-700 border-l-4 border-l-cyan-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Sparkles className="w-6 h-6 text-cyan-600" />
                            Optimization Strategies
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          {Object.entries(propertyOptimizationPlan.optimization_strategies).map(([key, value]) => (
                            <div key={key}>
                              <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1 capitalize">
                                {key.replace(/_/g, ' ')}:
                              </p>
                              <p className="text-sm text-slate-600 dark:text-slate-400">{value}</p>
                            </div>
                          ))}
                        </CardContent>
                      </Card>
                    )}

                    {/* Expected Outcomes */}
                    {propertyOptimizationPlan.expected_outcomes && (
                      <Card className="dark:bg-slate-900 dark:border-indigo-700 border-l-4 border-l-indigo-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white">
                            <Target className="w-6 h-6 text-indigo-600" />
                            Expected Outcomes
                          </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-3">
                          {Object.entries(propertyOptimizationPlan.expected_outcomes).map(([key, value]) => (
                            <div key={key}>
                              <p className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1 capitalize">
                                {key.replace(/_/g, ' ')}:
                              </p>
                              <p className="text-sm text-slate-600 dark:text-slate-400">
                                {typeof value === 'object' ? JSON.stringify(value, null, 2) : value}
                              </p>
                            </div>
                          ))}
                        </CardContent>
                      </Card>
                    )}

                    {/* Action Buttons */}
                    <div className="flex flex-wrap justify-end gap-3 pt-4 border-t-2 border-yellow-300 dark:border-yellow-700">
                      <Button
                        onClick={() => navigate(createPageUrl(`PropertyDetail?id=${property.id}`))}
                        variant="outline"
                        className="dark:border-slate-700 dark:text-slate-300"
                      >
                        View Property Details
                      </Button>
                      <Button
                        onClick={() => generate30DayOptimizationPlan(property, daysOnMarket)}
                        disabled={isGeneratingOptimization}
                        className="bg-yellow-600 hover:bg-yellow-700"
                      >
                        {isGeneratingOptimization ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Refreshing...
                          </>
                        ) : (
                          <>
                            <RefreshCw className="w-4 h-4 mr-2" />
                            Refresh Plan
                          </>
                        )}
                      </Button>
                    </div>
                  </div>
                )}

                {/* Regular Analysis Results - Expandable */}
                {propertyRecommendations && isExpanded && !isActionPlanExpanded && !isOptimizationPlanExpanded && ( // Only show if other plans are NOT expanded
                  <div className="p-6 space-y-6 border-t border-slate-200 dark:border-slate-700">
                    {/* Impact Banner */}
                    <div className={`p-4 rounded-lg border-2 ${
                      propertyRecommendations.estimated_impact === 'high'
                        ? 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800'
                        : propertyRecommendations.estimated_impact === 'medium'
                        ? 'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-800'
                        : 'bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800'
                    }`}>
                      <div className="flex items-center gap-3">
                        {getImpactIcon(propertyRecommendations.estimated_impact)}
                        <div>
                          <p className="font-semibold text-slate-900 dark:text-white">
                            Estimated Impact: {propertyRecommendations.estimated_impact?.toUpperCase()}
                          </p>
                          <p className="text-sm text-slate-600 dark:text-slate-300">
                            Implementing these recommendations could significantly improve listing performance
                          </p>
                        </div>
                      </div>
                    </div>

                    {/* Quick Wins */}
                    {propertyRecommendations.quick_wins && propertyRecommendations.quick_wins.length > 0 && (
                      <Card className="dark:bg-slate-900 dark:border-slate-700 border-l-4 border-l-green-500">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 dark:text-white text-base">
                            <Sparkles className="w-5 h-5 text-green-600" />
                            Quick Wins - Implement Today
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <ul className="space-y-3">
                            {propertyRecommendations.quick_wins.map((win, index) => (
                              <li key={index} className="flex items-start gap-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div className="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 flex items-center justify-center text-sm font-semibold flex-shrink-0">
                                  {index + 1}
                                </div>
                                <span className="app-text dark:text-slate-300 flex-1">{win}</span>
                              </li>
                            ))}
                          </ul>
                        </CardContent>
                      </Card>
                    )}

                    {/* Detailed Recommendations */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {[
                        { key: 'pricing_strategy', title: 'Pricing Strategy', icon: DollarSign, color: 'red' },
                        { key: 'marketing_improvements', title: 'Marketing', icon: TrendingUp, color: 'blue' },
                        { key: 'photography_staging', title: 'Photos & Staging', icon: Eye, color: 'purple' },
                        { key: 'property_improvements', title: 'Property Updates', icon: Building2, color: 'green' },
                        { key: 'target_buyer_strategy', title: 'Target Buyers', icon: MapPin, color: 'indigo' },
                        { key: 'urgency_tactics', title: 'Urgency Tactics', icon: AlertCircle, color: 'orange' }
                      ].map(({ key, title, icon: Icon, color }) => {
                        const rec = propertyRecommendations[key];
                        if (!rec) return null;

                        return (
                          <Card key={key} className={`dark:bg-slate-900 dark:border-slate-700 border-l-4 border-l-${color}-500`}>
                            <CardHeader className="pb-3">
                              <div className="flex items-center justify-between">
                                <CardTitle className="flex items-center gap-2 text-sm dark:text-white">
                                  <Icon className="w-4 h-4" />
                                  {title}
                                </CardTitle>
                                <Badge className={getPriorityColor(rec.priority)}>
                                  {rec.priority}
                                </Badge>
                              </div>
                            </CardHeader>
                            <CardContent>
                              <p className="app-text text-sm leading-relaxed dark:text-slate-300">
                                {rec.recommendation}
                              </p>
                            </CardContent>
                          </Card>
                        );
                      })}
                    </div>

                    {/* Action Buttons */}
                    <div className="flex flex-wrap justify-end gap-3 pt-4 border-t border-slate-200 dark:border-slate-700">
                      <Button
                        onClick={() => navigate(createPageUrl(`PropertyDetail?id=${property.id}`))}
                        variant="outline"
                        className="dark:border-slate-700 dark:text-slate-300"
                      >
                        View Property Details
                      </Button>
                      <Button
                        onClick={() => analyzePropertyWithMarket(property)}
                        disabled={isAnalyzing}
                        className="app-button"
                      >
                        {isAnalyzing ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Re-analyzing...
                          </>
                        ) : (
                          <>
                            <Sparkles className="w-4 h-4 mr-2" />
                            Refresh Analysis
                          </>
                        )}
                      </Button>
                    </div>
                  </div>
                )}
              </Card>
            );
          })
        )}
      </div>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { base44 } from "@/api/base44Client";
import { Property } from "@/api/entities";
import { createPageUrl } from "@/utils";
import {
  ArrowLeft,
  Building2,
  TrendingUp,
  Home,
  Loader2,
  BarChart3,
  AlertCircle,
  Sparkles
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";

export default function PropertyAnalysis() {
  const navigate = useNavigate();
  const location = useLocation();
  const searchParams = new URLSearchParams(location.search);
  const propertyId = searchParams.get('id');

  const [property, setProperty] = useState(null);
  const [address, setAddress] = useState("");
  const [apiToken, setApiToken] = useState("");
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysis, setAnalysis] = useState(null);
  const [currentUser, setCurrentUser] = useState(null);

  useEffect(() => {
    loadData();
  }, [propertyId]);

  const loadData = async () => {
    try {
      const user = await base44.auth.me();
      setCurrentUser(user);
      
      // Load API token from user settings
      if (user.homesage_api_token) {
        setApiToken(user.homesage_api_token);
      }

      if (propertyId) {
        const propertyData = await Property.get(propertyId);
        setProperty(propertyData);
        setAddress(`${propertyData.address}, ${propertyData.city}, ${propertyData.state} ${propertyData.zip_code}`);
      }
    } catch (error) {
      console.error("Error loading data:", error);
    }
  };

  const saveApiToken = async () => {
    try {
      await base44.auth.updateMe({ homesage_api_token: apiToken });
      toast.success("API token saved!");
    } catch (error) {
      console.error("Error saving token:", error);
      toast.error("Failed to save API token");
    }
  };

  const analyzeProperty = async () => {
    if (!address.trim()) {
      toast.error("Please enter a property address");
      return;
    }

    if (!apiToken.trim()) {
      toast.error("Please enter your HomeSage AI API token");
      return;
    }

    setIsAnalyzing(true);
    setAnalysis(null);

    try {
      const baseUrl = 'https://developers.homesage.ai';
      const headers = { 
        'Authorization': `Bearer ${apiToken}`,
        'Content-Type': 'application/json'
      };

      toast.info("Fetching property details...");

      // 1. Get property details
      const propertyInfoResponse = await fetch(
        `${baseUrl}/api/properties/info/?property_address=${encodeURIComponent(address)}`,
        { headers }
      );
      
      if (!propertyInfoResponse.ok) {
        throw new Error(`API Error: ${propertyInfoResponse.status} - ${propertyInfoResponse.statusText}`);
      }
      
      const propertyInfo = await propertyInfoResponse.json();

      toast.info("Analyzing comparable properties...");

      // 2. Get comparable properties
      const compsResponse = await fetch(
        `${baseUrl}/api/properties/comps/?property_address=${encodeURIComponent(address)}`,
        { headers }
      );
      const comps = compsResponse.ok ? await compsResponse.json() : null;

      toast.info("Calculating investment potential...");

      // 3. Get investment analysis
      const investmentResponse = await fetch(
        `${baseUrl}/api/properties/investment_potential/?property_address=${encodeURIComponent(address)}`,
        { headers }
      );
      const investment = investmentResponse.ok ? await investmentResponse.json() : null;

      setAnalysis({
        property: propertyInfo,
        comparables: comps,
        investment: investment
      });

      toast.success("Analysis complete!");
    } catch (error) {
      console.error('Error analyzing property:', error);
      toast.error(error.message || "Failed to analyze property. Please check your API token and try again.");
    }

    setIsAnalyzing(false);
  };

  return (
    <div className="page-container">
      {/* Header */}
      <Card>
        <CardContent className="p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(propertyId ? createPageUrl(`PropertyDetail?id=${propertyId}`) : createPageUrl("Properties"))}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <Sparkles className="w-6 h-6 text-purple-600" />
                <h1 className="app-title text-2xl">AI Property Analysis</h1>
              </div>
              <p className="app-subtitle">Powered by HomeSage AI</p>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* API Token Setup */}
      {!currentUser?.homesage_api_token && (
        <Card className="border-l-4 border-l-amber-500">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-amber-700">
              <AlertCircle className="w-5 h-5" />
              Setup Required
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <p className="text-sm text-slate-600">
              To use AI property analysis, you need a HomeSage AI API token. Get your free token at{" "}
              <a 
                href="https://developers.homesage.ai" 
                target="_blank" 
                rel="noopener noreferrer"
                className="text-purple-600 hover:underline font-medium"
              >
                developers.homesage.ai
              </a>
            </p>
            <div className="flex gap-2">
              <Input
                type="password"
                value={apiToken}
                onChange={(e) => setApiToken(e.target.value)}
                placeholder="Enter your HomeSage AI JWT token"
                className="flex-1"
              />
              <Button onClick={saveApiToken} disabled={!apiToken.trim()}>
                Save Token
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Search Form */}
      <Card>
        <CardHeader>
          <CardTitle>Property Address</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label>Full Property Address</Label>
            <Input
              value={address}
              onChange={(e) => setAddress(e.target.value)}
              placeholder="123 Main St, Austin, TX 78701"
              className="mt-2"
            />
          </div>

          {!currentUser?.homesage_api_token && (
            <div>
              <Label>API Token</Label>
              <Input
                type="password"
                value={apiToken}
                onChange={(e) => setApiToken(e.target.value)}
                placeholder="Your HomeSage AI JWT token"
                className="mt-2"
              />
            </div>
          )}

          <Button
            onClick={analyzeProperty}
            disabled={isAnalyzing || !address.trim() || !apiToken.trim()}
            className="w-full bg-gradient-to-r from-purple-600 to-indigo-600"
            size="lg"
          >
            {isAnalyzing ? (
              <>
                <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                Analyzing Property...
              </>
            ) : (
              <>
                <Sparkles className="w-5 h-5 mr-2" />
                Analyze Property
              </>
            )}
          </Button>
        </CardContent>
      </Card>

      {/* Analysis Results */}
      {analysis && (
        <>
          {/* Property Details */}
          {analysis.property && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Building2 className="w-5 h-5" />
                  Property Details
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {Object.entries(analysis.property).map(([key, value]) => (
                    <div key={key} className="p-4 bg-slate-50 rounded-lg">
                      <div className="text-xs text-slate-500 mb-1 uppercase">
                        {key.replace(/_/g, ' ')}
                      </div>
                      <div className="font-semibold text-slate-900">
                        {typeof value === 'object' ? JSON.stringify(value) : String(value)}
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}

          {/* Comparable Properties */}
          {analysis.comparables && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Home className="w-5 h-5" />
                  Comparable Properties
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {Array.isArray(analysis.comparables.comps) && analysis.comparables.comps.length > 0 ? (
                    analysis.comparables.comps.map((comp, idx) => (
                      <div key={idx} className="p-4 border border-slate-200 rounded-lg hover:shadow-md transition-shadow">
                        <div className="flex items-start justify-between mb-3">
                          <div>
                            <h4 className="font-semibold text-slate-900">{comp.address || 'Address not available'}</h4>
                            <p className="text-sm text-slate-500">{comp.city || ''}, {comp.state || ''} {comp.zip || ''}</p>
                          </div>
                          <Badge className="bg-green-100 text-green-700">
                            ${typeof comp.price === 'number' ? comp.price.toLocaleString() : comp.price || 'N/A'}
                          </Badge>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                          {comp.beds && <div><span className="text-slate-500">Beds:</span> <span className="font-medium">{comp.beds}</span></div>}
                          {comp.baths && <div><span className="text-slate-500">Baths:</span> <span className="font-medium">{comp.baths}</span></div>}
                          {comp.sqft && <div><span className="text-slate-500">Sq Ft:</span> <span className="font-medium">{comp.sqft.toLocaleString()}</span></div>}
                          {comp.year_built && <div><span className="text-slate-500">Built:</span> <span className="font-medium">{comp.year_built}</span></div>}
                        </div>
                      </div>
                    ))
                  ) : (
                    <p className="text-center text-slate-500 py-8">
                      {JSON.stringify(analysis.comparables, null, 2)}
                    </p>
                  )}
                </div>
              </CardContent>
            </Card>
          )}

          {/* Investment Analysis */}
          {analysis.investment && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <TrendingUp className="w-5 h-5" />
                  Investment Potential
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {Object.entries(analysis.investment).map(([key, value]) => (
                    <div key={key} className="p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg">
                      <div className="text-sm text-slate-600 mb-2">
                        {key.replace(/_/g, ' ').toUpperCase()}
                      </div>
                      <div className="text-2xl font-bold text-indigo-600">
                        {typeof value === 'number' ? 
                          (key.includes('rate') || key.includes('yield') ? `${value}%` : 
                           key.includes('price') || key.includes('value') ? `$${value.toLocaleString()}` : 
                           value) : 
                          String(value)}
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}
        </>
      )}

      {/* Empty State */}
      {!analysis && !isAnalyzing && (
        <Card>
          <CardContent className="p-12 text-center">
            <BarChart3 className="w-16 h-16 mx-auto mb-4 text-slate-300" />
            <h3 className="text-xl font-semibold text-slate-900 mb-2">
              Ready to Analyze
            </h3>
            <p className="text-slate-500 mb-6">
              Enter a property address above to get comprehensive AI-powered analysis including property details, comparable sales, and investment potential.
            </p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
import React, { useState, useEffect, useMemo, useLayoutEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { base44 } from "@/api/base44Client";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { createPageUrl } from "@/utils";
import { DragDropContext } from "@hello-pangea/dnd";
import { toast } from "sonner";

import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import { Badge } from "@/components/ui/badge";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuLabel,
  DropdownMenuTrigger } from
"@/components/ui/dropdown-menu";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger } from
"@/components/ui/tooltip";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription } from
"@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue } from
"@/components/ui/select";
import {
  Building2,
  DollarSign,
  BedDouble,
  Bath,
  Square,
  User as UserIcon,
  Edit,
  ArrowLeft,
  MapPin,
  Plus,
  Phone,
  Mail,
  MessageSquare,
  Users,
  X,
  Sparkles,
  ChevronDown,
  ChevronUp,
  Package,
  UserPlus,
  Shield,
  CheckCircle2,
  AlertCircle,
  Calendar,
  FileText,
  Image as ImageIcon,
  TrendingUp,
  MoreVertical,
  Home,
  Briefcase,
  ArrowRight,
  Clock,
  Star, // For celebration modal
  Trophy, // For celebration modal
  Award, // For celebration modal
  CheckSquare, // For tasks icon
  LayoutGrid, // New: for Overview tab
  ListChecks, // New: for Tasks tab
  FileCheck2, // New: for Transactions tab
  Folder, // New: for Documents tab
  Camera, // New: for Photos tab
  Brain, // NEW: for AI Insights tab
  Megaphone, // NEW: for Marketing tab
  Loader2 // NEW: for loading spinner
} from "lucide-react";
import { format } from "date-fns";

import TaskKanbanBoard from "../components/tasks/TaskKanbanBoard";
import DocumentList from "../components/documents/DocumentList";
import DocumentPreviewModal from "../components/documents/DocumentPreviewModal";
import PhotoGallery from "../components/photos/PhotoGallery";
import PropertyImageGallery from "../components/properties/PropertyImageGallery";
import TransactionCard from "../components/transactions/TransactionCard";
import TransactionTimeline from "../components/transactions/TransactionTimeline";
import PropertyEditModal from "../components/properties/PropertyEditModal";
import TransactionModal from "../components/transactions/TransactionModal";
import TaskModal from "../components/tasks/TaskModal";
import DocumentUploadModal from "../components/documents/DocumentUploadModal";
import PhotoUpload from "../components/photos/PhotoUpload";
import ContactCard from "../components/properties/ContactCard";
import ServiceProviderModal from "../components/properties/ServiceProviderModal";
import SellerModal from "../components/properties/SellerModal";
import SellingAgentModal from "../components/properties/SellingAgentModal";
import UnderContractTracker from "../components/properties/UnderContractTracker";
import PropertyMessaging from "../components/properties/PropertyMessaging";
import AIPropertyInsights from "../components/properties/AIPropertyInsights";
import AIMarketingAssistant from "../components/properties/AIMarketingAssistant"; // NEW
import PropertyValuation from "../components/properties/PropertyValuation"; // NEW
import PropertyAdviceCard from "../components/properties/PropertyAdviceCard"; // NEW
import PropertyFeedbackInsights from "../components/properties/PropertyFeedbackInsights"; // NEW
import AttomDataViewer from "../components/properties/AttomDataViewer";
import LoadingSpinner from "../components/common/LoadingSpinner";
import ClientLoveMeter from "../components/common/ClientLoveMeter";
import MarketTrendsCard from "../components/properties/MarketTrendsCard";
import ComparableSalesCard from "../components/properties/ComparableSalesCard";
import SchoolRatingsCard from "../components/properties/SchoolRatingsCard";
import DemographicsCard from "../components/properties/DemographicsCard";
import PropertyHistoryCard from "../components/properties/PropertyHistoryCard";
import { enrichPropertyData } from "@/api/functions";
import { canEditProperty, canDeleteProperty } from "../components/utils/rolePermissions";

const baseTabStyle = "group flex flex-col items-center justify-center h-auto py-3 rounded-lg transition-all text-xs font-medium gap-1";
const inactiveText = "text-slate-600 dark:text-slate-300";

const tabColors = {
  overview: { icon: "text-slate-500", hover: "hover:bg-slate-100 dark:hover:bg-slate-800", active: "data-[state=active]:bg-slate-600" },
  contacts: { icon: "text-sky-500", hover: "hover:bg-sky-100 dark:hover:bg-sky-900/20", active: "data-[state=active]:bg-sky-500" },
  tasks: { icon: "text-amber-500", hover: "hover:bg-amber-100 dark:hover:bg-amber-900/20", active: "data-[state=active]:bg-amber-500" },
  transactions: { icon: "text-emerald-500", hover: "hover:bg-emerald-100 dark:hover:bg-emerald-900/20", active: "data-[state=active]:bg-emerald-600" },
  documents: { icon: "text-violet-500", hover: "hover:bg-violet-100 dark:hover:bg-violet-900/20", active: "data-[state=active]:bg-violet-500" },
  photos: { icon: "text-rose-500", hover: "hover:bg-rose-100 dark:hover:bg-rose-900/20", active: "data-[state=active]:bg-rose-500" },
  messages: { icon: "text-cyan-500", hover: "hover:bg-cyan-100 dark:hover:bg-cyan-900/20", active: "data-[state=active]:bg-cyan-500" },
  'ai_advice': { icon: "text-indigo-500", hover: "hover:bg-indigo-100 dark:hover:bg-indigo-900/20", active: "data-[state=active]:bg-indigo-500" },
  'ai_insights': { icon: "text-purple-500", hover: "hover:bg-purple-100 dark:hover:bg-purple-900/20", active: "data-[state=active]:bg-purple-500" }, // NEW
  'marketing': { icon: "text-pink-500", hover: "hover:bg-pink-100 dark:hover:bg-pink-900/20", active: "data-[state=active]:bg-pink-500" }, // NEW
  'valuation': { icon: "text-teal-500", hover: "hover:bg-teal-100 dark:hover:bg-teal-900/20", active: "data-[state=active]:bg-teal-500" }, // NEW
  'feedback': { icon: "text-orange-500", hover: "hover:bg-orange-100 dark:hover:bg-orange-900/20", active: "data-[state=active]:bg-orange-500" } // NEW
};


function PropertyExpirationBadge({ expirationDate }) {
  const expDate = new Date(expirationDate);
  const today = new Date();
  const daysLeft = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
  const isExpired = daysLeft <= 0;
  const isExpiringSoon = daysLeft > 0 && daysLeft < 30;

  let statusClass = 'bg-white/20';
  if (isExpired) {
    statusClass = 'bg-red-500/30 border border-red-400';
  } else if (isExpiringSoon) {
    statusClass = 'bg-amber-500/30 border border-amber-400';
  }

  let statusText = '';
  if (isExpired) {
    statusText = ' (EXPIRED)';
  } else if (isExpiringSoon) {
    statusText = ` (${daysLeft}d left)`;
  }

  return (
    <div className={`flex items-center gap-2 backdrop-blur-md px-3 py-1.5 rounded-lg ${statusClass}`}>
      <Clock className="w-4 h-4 text-white" />
      <span className="text-white text-sm">
        Expires: {format(expDate, 'MMM dd, yyyy')}{statusText}
      </span>
    </div>);

}

// CelebrationModal Component (New)
function CelebrationModal({ isOpen, onClose, celebrationType, details }) {
  let title = '';
  let description = '';
  let Icon = Star;
  let iconClass = 'text-yellow-400';

  if (!details) return null;

  switch (celebrationType) {
    case 'listing_side_complete':
      title = 'Listing Side Completed!';
      description = `Congratulations! All listing-related tasks for ${details.propertyAddress} are now 100% complete.`;
      Icon = Award;
      iconClass = 'text-blue-500';
      break;
    case 'selling_side_complete':
      title = 'Under Contract Side Completed!';
      description = `Fantastic! All tasks related to the selling side for ${details.propertyAddress} have reached 100% completion.`;
      Icon = Trophy;
      iconClass = 'text-purple-500';
      break;
    case 'property_100_percent':
      title = 'Property Process 100% Complete!';
      description = `Incredible work! All tasks for ${details.propertyAddress} are now finished. Time to celebrate!`;
      Icon = Star;
      iconClass = 'text-green-500';
      break;
    default:
      return null;
  }

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-[425px] text-center p-6">
        <DialogHeader>
          <div className="flex justify-center mb-4">
            <Icon className={`w-16 h-16 ${iconClass}`} />
          </div>
          <DialogTitle className="text-3xl font-extrabold text-slate-900 dark:text-white mb-2">{title}</DialogTitle>
          <DialogDescription className="text-md text-slate-600 dark:text-slate-300">
            {description}
          </DialogDescription>
        </DialogHeader>
        <div className="mt-4 grid grid-cols-2 gap-4">
          {details.stats && details.stats.map((stat, index) =>
          <div key={index} className="bg-slate-100 dark:bg-slate-800 p-3 rounded-lg">
              <p className="text-xl font-bold text-indigo-600 dark:text-indigo-400">{stat.value}</p>
              <p className="text-sm text-slate-500 dark:text-slate-400">{stat.label}</p>
            </div>
          )}
        </div>
        <Button onClick={onClose} className="mt-6 w-full">Awesome!</Button>
      </DialogContent>
    </Dialog>);

}


export default function PropertyDetail() {
  const { id } = useParams();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [property, setProperty] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [documents, setDocuments] = useState([]);
  const [photos, setPhotos] = useState([]);
  const [clientPortalAccess, setClientPortalAccess] = useState([]);
  const [communications, setCommunications] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showTransactionModal, setShowTransactionModal] = useState(false);
  const [showTaskModal, setShowTaskModal] = useState(false);
  const [showDocumentModal, setShowDocumentModal] = useState(false);
  const [documentUploadType, setDocumentUploadType] = useState(null);
  const [showPhotoUpload, setShowPhotoUpload] = useState(false);
  const [showServiceProviderModal, setShowServiceProviderModal] = useState(false);
  const [showSellerModal, setShowSellerModal] = useState(false);
  const [showSellingAgentModal, setShowSellingAgentModal] = useState(false);
  const [editingServiceProvider, setEditingServiceProvider] = useState(null);
  const [editingSeller, setEditingSeller] = useState(null);
  const [editingTransaction, setEditingTransaction] = useState(null);
  const [editingTask, setEditingTask] = useState(null);

  const [activeTab, setActiveTab] = useState("overview");
  const [preSelectedRecipient, setPreSelectedRecipient] = useState(null); // NEW: for pre-selecting message recipient

  const [expandedSections, setExpandedSections] = useState({
    propertyDetails: true,
    additionalInfo: false,
    description: false,
    features: false
  });

  const [highlightedTaskIds, setHighlightedTaskIds] = useState([]);
  const [taskFilter, setTaskFilter] = useState(null);

  const [aiReviews, setAIReviews] = useState({
    listing_agent: null,
    title: null,
    mortgage: null,
    inspection: null
  });
  const [loadingAIReviews, setLoadingAIReviews] = useState({
    listing_agent: false,
    title: false,
    mortgage: false,
    inspection: false
  });

  const [documentTypeFilter, setDocumentTypeFilter] = useState('all');
  const [selectedDocuments, setSelectedDocuments] = useState([]);

  const [showCelebration, setShowCelebration] = useState(false);
  const [celebrationType, setCelebrationType] = useState(null);
  const [celebrationDetails, setCelebrationDetails] = useState(null);
  const [enrichedData, setEnrichedData] = useState(null);
  const [loadingEnrichedData, setLoadingEnrichedData] = useState(false);
  const [previewDocument, setPreviewDocument] = useState(null);

  // Use cached data from Layout instead of fetching
  const { data: currentUser } = useQuery({
    queryKey: ['user'],
    enabled: false // Don't refetch, use cache only
  });

  const { data: users = [] } = useQuery({
    queryKey: ['users'],
    queryFn: () => base44.entities.User.list(),
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
    refetchOnMount: false,
    refetchOnWindowFocus: false
  });

  const { data: teamMembers = [] } = useQuery({
    queryKey: ['teamMembers'],
    enabled: false // Use cache from Layout
  });

  const { data: allProperties = [] } = useQuery({
    queryKey: ['properties', currentUser?.id],
    enabled: false // Use cache from Layout - don't refetch
  });

  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const propertyId = urlParams.get('id') || id;
    const highlightTask = urlParams.get('highlightTask');

    if (highlightTask) {
      setHighlightedTaskIds([highlightTask]);
      setActiveTab("tasks");

      setTimeout(() => {
        const taskElement = document.getElementById(`task-${highlightTask}`);
        if (taskElement) {
          taskElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => setHighlightedTaskIds([]), 5000);
        }
      }, 500);
    }

    if (propertyId) {
      loadData(propertyId);
    } else {
      setError("No property ID provided");
      setIsLoading(false);
    }

    const handleRefresh = () => {
      console.log('üîÑ Refreshing property detail from external update...');
      const urlParams = new URLSearchParams(window.location.search);
      const currentPropertyId = urlParams.get('id') || id;
      if (currentPropertyId) loadData(currentPropertyId);
    };

    window.addEventListener('refreshCounts', handleRefresh);
    window.addEventListener('refreshGlobalData', handleRefresh);
    return () => {
      window.removeEventListener('refreshCounts', handleRefresh);
      window.removeEventListener('refreshGlobalData', handleRefresh);
    };
  }, [id]);

  const calculateProgressFromTasks = (tasksArray) => {
    if (!tasksArray || !Array.isArray(tasksArray) || tasksArray.length === 0) {
      console.log('‚ö†Ô∏è No tasks to calculate progress from');
      return {
        listing_side_progress: null,
        selling_side_progress: null,
        listing_tasks_count: 0,
        selling_tasks_count: 0
      };
    }

    const listingSideTypes = ['listing', 'marketing', 'documentation', 'inspection'];
    const sellingSideTypes = ['contract', 'financing', 'closing'];

    const listingTasks = tasksArray.filter((t) => t && t.task_type && typeof t.task_type === 'string' && listingSideTypes.includes(t.task_type));
    const sellingTasks = tasksArray.filter((t) => t && t.task_type && typeof t.task_type === 'string' && sellingSideTypes.includes(t.task_type));

    const listingCompleted = listingTasks.filter((t) => t && t.status === 'completed').length;
    const sellingCompleted = sellingTasks.filter((t) => t && t.status === 'completed').length;

    const listingProgress = listingTasks.length > 0 ?
    Math.round(listingCompleted / listingTasks.length * 100) :
    null;

    const sellingProgress = sellingTasks.length > 0 ?
    Math.round(sellingCompleted / sellingTasks.length * 100) :
    null;

    console.log('üìä Progress Calculation Details:', {
      totalTasks: tasksArray.length,
      listingSide: {
        total: listingTasks.length,
        completed: listingCompleted,
        progress: listingProgress,
        taskList: listingTasks.map((t) => `${t.title} (${t.task_type}) - ${t.status}`)
      },
      sellingSide: {
        total: sellingTasks.length,
        completed: sellingCompleted,
        progress: sellingProgress,
        taskList: sellingTasks.map((t) => `${t.title} (${t.task_type}) - ${t.status}`)
      }
    });

    return {
      listing_side_progress: listingProgress,
      selling_side_progress: sellingProgress,
      listing_tasks_count: listingTasks.length,
      selling_tasks_count: sellingTasks.length
    };
  };

  const loadData = async (propertyId) => {
    setIsLoading(true);
    setError(null);
    try {
      console.log('üîÑ Loading property data:', propertyId);

      // Safely get cached properties or fetch if not available
      let propData = null;
      
      try {
        const cachedProperties = queryClient.getQueryData(['properties', currentUser?.id]) || [];
        propData = cachedProperties.find((p) => p && p.id === propertyId);
      } catch (cacheError) {
        console.log('‚ö†Ô∏è Cache not available, fetching directly');
      }
      
      // Fallback: fetch directly if not in cache
      if (!propData) {
        const allProps = await base44.entities.Property.list().catch(() => []);
        propData = allProps.find((p) => p && p.id === propertyId);
      }

      if (!propData) {
        setError("Property not found");
        setIsLoading(false);
        return;
      }

      setProperty(propData);

      const [taskData, transData, docData, photoData, portalAccessData, commData] = await Promise.all([
      base44.entities.Task.filter({ property_id: propertyId }).catch(() => []),
      base44.entities.Transaction.filter({ property_id: propertyId }).catch(() => []),
      base44.entities.Document.filter({ property_id: propertyId }).catch(() => []),
      base44.entities.Photo.filter({ property_id: propertyId }).catch(() => []),
      base44.entities.ClientPortalAccess.filter({ property_id: propertyId }).catch(() => []),
      base44.entities.Communication.filter({ property_id: propertyId }).catch(() => [])]
      );

      setTasks(Array.isArray(taskData) ? taskData : []);
      setDocuments(Array.isArray(docData) ? docData : []);
      setPhotos(Array.isArray(photoData) ? photoData : []);
      setClientPortalAccess(Array.isArray(portalAccessData) ? portalAccessData : []);
      setCommunications(Array.isArray(commData) ? commData : []);

      console.log('üì¶ Data loaded:', {
        transactions: transData?.length || 0,
        tasks: taskData?.length || 0,
        documents: docData?.length || 0,
        photos: photoData?.length || 0,
        teamMembers: teamMembersData?.length || 0
      });

      const progress = calculateProgressFromTasks(taskData);

      console.log('üíæ Updating active/pending transactions with progress:', progress);

      if (Array.isArray(transData) && transData.length > 0) {
        const updatePromises = transData.
        filter((transaction) => transaction && transaction.id && (transaction.status === 'active' || transaction.status === 'pending')).
        map((transaction) => {
          console.log(`üìù Updating ${transaction.status} transaction ${transaction.id} with:`, progress);
          return base44.entities.Transaction.update(transaction.id, {
            listing_side_progress: progress.listing_side_progress || 0,
            selling_side_progress: progress.selling_side_progress || 0
          }).catch((err) => {
            console.error(`‚ùå Failed to update transaction ${transaction.id}:`, err);
          });
        });

        await Promise.all(updatePromises);

        console.log('‚è≥ Waiting for database updates...');
        await new Promise((resolve) => setTimeout(resolve, 300));

        console.log('üîÑ Reloading transactions to get updated values...');
        const freshTransData = await base44.entities.Transaction.filter({ property_id: propertyId }).catch(() => []);

        console.log('‚úÖ Fresh transactions loaded:', freshTransData.map((t) => ({
          id: t.id,
          status: t.status,
          listing_progress: t.listing_side_progress,
          selling_progress: t.selling_side_progress
        })));

        setTransactions(Array.isArray(freshTransData) ? freshTransData : []);
      } else {
        console.log('‚ÑπÔ∏è No transactions found');
        setTransactions([]);
      }

      console.log('‚úÖ Property detail load complete');
    } catch (error) {
      console.error("‚ùå Error loading property details:", error);
      if (error.response?.status === 429 || error.message?.includes('Rate limit')) {
        setError("Too many requests. Please wait a moment and try refreshing the page.");
        toast.error("Rate limit exceeded. Please wait a moment before refreshing.");
      } else {
        setError("Failed to load property details");
      }
    }
    setIsLoading(false);
  };

  const checkForCelebrations = (tasksArray, propertyData) => {
    if (!tasksArray || !Array.isArray(tasksArray) || tasksArray.length === 0 || !propertyData) return;

    const listingSideTypes = ['listing', 'marketing', 'documentation', 'inspection'];
    const sellingSideTypes = ['contract', 'financing', 'closing'];

    const listingTasks = tasksArray.filter((t) => t && t.task_type && typeof t.task_type === 'string' && listingSideTypes.includes(t.task_type));
    const sellingTasks = tasksArray.filter((t) => t && t.task_type && typeof t.task_type === 'string' && sellingSideTypes.includes(t.task_type));

    const listingCompleted = listingTasks.filter((t) => t && t.status && t.status === 'completed').length;
    const sellingCompleted = sellingTasks.filter((t) => t && t.status && t.status === 'completed').length;

    const listingProgress = listingTasks.length > 0 ? listingCompleted / listingTasks.length * 100 : 0;
    const sellingProgress = sellingTasks.length > 0 ? sellingCompleted / sellingTasks.length * 100 : 0;

    // Check if listing side just completed (100%)
    if (listingTasks.length > 0 && listingProgress === 100 && !localStorage.getItem(`listing_celebrated_${propertyData.id}`)) {
      setCelebrationType('listing_side_complete');
      setCelebrationDetails({
        propertyAddress: propertyData.address,
        stats: [
        { value: listingTasks.length, label: 'Tasks Completed' },
        { value: '100%', label: 'Listing Progress' }]

      });
      setShowCelebration(true);
      localStorage.setItem(`listing_celebrated_${propertyData.id}`, 'true');
      return;
    }

    // Check if selling side just completed (100%)
    if (sellingTasks.length > 0 && sellingProgress === 100 && !localStorage.getItem(`selling_celebrated_${propertyData.id}`)) {
      setCelebrationType('selling_side_complete');
      setCelebrationDetails({
        propertyAddress: propertyData.address,
        stats: [
        { value: sellingTasks.length, label: 'Tasks Completed' },
        { value: '100%', label: 'Contract Progress' }]

      });
      setShowCelebration(true);
      localStorage.setItem(`selling_celebrated_${propertyData.id}`, 'true');
      return;
    }

    // Check if entire property is 100% complete
    const allTasks = tasksArray.filter((t) => t && t.status && t.status !== 'cancelled');
    const allCompleted = allTasks.filter((t) => t && t.status && t.status === 'completed').length;
    const totalProgress = allTasks.length > 0 ? allCompleted / allTasks.length * 100 : 0;

    if (allTasks.length > 0 && totalProgress === 100 && !localStorage.getItem(`property_celebrated_${propertyData.id}`)) {
      setCelebrationType('property_100_percent');
      setCelebrationDetails({
        propertyAddress: propertyData.address,
        stats: [
        { value: allTasks.length, label: 'Total Tasks' },
        { value: '100%', label: 'Complete' }]

      });
      setShowCelebration(true);
      localStorage.setItem(`property_celebrated_${propertyData.id}`, 'true');
    }
  };


  const updateAllTransactionProgress = async (propertyId) => {
    try {
      console.log('üîÑ Starting progress update for property:', propertyId);

      const [allTransactions, allTasks] = await Promise.all([
      base44.entities.Transaction.filter({ property_id: propertyId }).catch(() => []),
      base44.entities.Task.filter({ property_id: propertyId }).catch(() => [])]
      );

      console.log('üìä Loaded for progress update:', {
        transactions: allTransactions?.length || 0,
        tasks: allTasks?.length || 0
      });

      if (!allTransactions || !Array.isArray(allTransactions) || allTransactions.length === 0) {
        console.warn('‚ö†Ô∏è No transactions to update');
        return;
      }

      const progress = calculateProgressFromTasks(allTasks);

      console.log('üíæ Applying calculated progress to active/pending transactions only:', {
        transactionCount: allTransactions.length,
        listingProgress: progress.listing_side_progress + '%',
        sellingProgress: progress.selling_side_progress + '%'
      });

      const updatePromises = allTransactions.
      filter((transaction) => transaction && transaction.id && (transaction.status === 'active' || transaction.status === 'pending')).
      map((transaction) => {
        console.log(`üìù Updating ${transaction.status} transaction ${transaction.id}...`);
        return base44.entities.Transaction.update(transaction.id, {
          listing_side_progress: progress.listing_side_progress || 0,
          selling_side_progress: progress.selling_side_progress || 0
        }).catch((err) => {
          console.error(`‚ùå Failed to update transaction ${transaction.id}:`, err);
        });
      });

      await Promise.all(updatePromises);

      console.log('‚úÖ All transaction progress updates complete');

      await new Promise((resolve) => setTimeout(resolve, 300));

    } catch (error) {
      console.error("‚ùå Error updating transaction progress:", error);
      if (error.response?.status === 429 || error.message?.includes('Rate limit')) {
        console.log("‚è≥ Rate limit hit during progress update");
        toast.error("Rate limit exceeded. Progress will update shortly.");
      }
    }
  };

  const getUser = (userId) => {
    if (!userId || !users || users.length === 0) return null;
    return users.find((u) => u && u.id === userId);
  };

  const getListingAgent = () => {
    if (!property || !property.listing_agent_id) return null;

    const listingAgentFromTeam = (teamMembers || []).find((tm) => tm && tm.id === property.listing_agent_id);
    const listingAgentFromUsers = (users || []).find((u) => u && u.id === property.listing_agent_id);

    const listingAgent = listingAgentFromTeam || listingAgentFromUsers;

    console.log("üîç PropertyDetail - Listing Agent Lookup:", {
      listing_agent_id: property.listing_agent_id,
      found_in_team: !!listingAgentFromTeam,
      found_in_users: !!listingAgentFromUsers,
      name: listingAgent?.full_name || listingAgent?.email,
      teamMembers_count: teamMembers?.length || 0,
      users_count: users?.length || 0
    });

    return listingAgent;
  };

  const getSellers = () => {
    if (!property || !property.sellers_info) return [];
    try {
      const sellersInfo = typeof property.sellers_info === 'string' ?
      JSON.parse(property.sellers_info) :
      property.sellers_info;
      return Array.isArray(sellersInfo) ? sellersInfo : [];
    } catch (error) {
      console.error("Error parsing sellers_info:", error);
      return [];
    }
  };

  const getBuyer = () => {
    if (!property) return null;

    if (property.buyer_name) {
      return {
        name: property.buyer_name,
        email: property.buyer_email,
        phone: property.buyer_phone,
        isManual: true
      };
    }

    if (property.buyer_id) {
      const user = getUser(property.buyer_id);
      if (user) {
        return {
          name: user.full_name || user.email,
          email: user.email,
          phone: user.phone,
          id: user.id,
          isManual: false
        };
      }
    }

    return null;
  };

  const getContactTaskStatus = (contactType) => {
    if (!tasks || !Array.isArray(tasks) || tasks.length === 0) {
      return null;
    }

    const now = new Date();
    const threeDaysFromNow = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);

    let allRelevantTasks = [];

    switch (contactType) {
      case 'inspection':
        allRelevantTasks = tasks.filter((t) => t && t.task_type && t.task_type === 'inspection');
        break;
      case 'mortgage':
        allRelevantTasks = tasks.filter((t) => t && t.task_type && t.task_type === 'financing');
        break;
      case 'title':
        allRelevantTasks = tasks.filter((t) => t && t.title && typeof t.title === 'string' && t.task_type && ((t.title || '').toLowerCase().includes('title') || t.task_type === 'documentation'));
        break;
      case 'listing_agent':
        allRelevantTasks = tasks.filter((t) => t && t.assigned_to === property?.listing_agent_id);
        break;
      default:
        return null;
    }

    if (allRelevantTasks.length === 0) {
      return { status: 'good', message: 'No tasks assigned yet', count: 0, tasks: [], completedCount: 0, totalCount: 0 };
    }

    const incompleteTasks = allRelevantTasks.filter((t) => t && t.status && t.status !== 'completed' && t.status !== 'cancelled');
    const completedTasks = allRelevantTasks.filter((t) => t && t.status && t.status === 'completed');

    let overdueTasks = [];
    let upcomingTasks = [];

    incompleteTasks.forEach((task) => {
      if (task && task.due_date) {
        const dueDate = new Date(task.due_date);
        if (dueDate < now) {
          overdueTasks.push(task);
        } else if (dueDate <= threeDaysFromNow) {
          upcomingTasks.push(task);
        }
      }
    });

    if (overdueTasks.length > 0) {
      return {
        status: 'overdue',
        message: `${overdueTasks.length} task(s) overdue`,
        count: overdueTasks.length,
        tasks: overdueTasks
      };
    }

    if (upcomingTasks.length > 0) {
      return {
        status: 'warning',
        message: `${upcomingTasks.length} task(s) due within 3 days`,
        count: upcomingTasks.length,
        tasks: upcomingTasks
      };
    }

    return {
      status: 'good',
      message: 'All tasks on track',
      count: completedTasks.length,
      tasks: allRelevantTasks,
      completedCount: completedTasks.length,
      totalCount: allRelevantTasks.length
    };
  };

  const getAIPerformanceReview = async (contactType, taskStatus) => {
    if (!taskStatus || !taskStatus.tasks || taskStatus.status !== 'good') {
      return null;
    }

    try {
      const completedTasks = taskStatus.tasks.filter((t) => t.status === 'completed');
      const totalTasks = taskStatus.tasks.length;
      const completionRate = totalTasks > 0 ? completedTasks.length / totalTasks * 100 : 0;

      const onTimeTasks = completedTasks.filter((t) => {
        if (!t.due_date || !t.completed_date) return true;
        return new Date(t.completed_date) <= new Date(t.due_date);
      });

      const onTimeRate = completedTasks.length > 0 ? onTimeTasks.length / completedTasks.length * 100 : 100;

      const prompt = `Based on the following performance data for a ${contactType} in a real estate transaction:
- Total tasks: ${totalTasks}
- Completed tasks: ${completedTasks.length}
- Completion rate: ${completionRate.toFixed(1)}%
- On-time completion rate: ${onTimeRate.toFixed(1)}%

Generate a short, positive performance review (max 2 sentences) and a star rating (0-5).

Consider:
- 90-100% completion & on-time = 5 stars (Exceptional)
- 80-89% = 4 stars (Excellent)
- 70-79% = 3 stars (Good)
- 60-69% = 2 stars (Fair)
- Below 60% = 1 star (Needs improvement)
- No completed tasks yet = 3 stars (Just getting started)

Return ONLY a JSON object with this exact format:
{
  "review": "Short positive review here",
  "stars": 4.5
}`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt: prompt,
        response_json_schema: {
          type: "object",
          properties: {
            review: { type: "string" },
            stars: { type: "number" }
          }
        },
        max_tokens: 150
      });

      console.log('üåü AI Performance Review:', response);
      return response;
    } catch (error) {
      console.error('Error generating AI review:', error);
      return null;
    }
  };

  useEffect(() => {
    if (!tasks || !property) return;

    const loadAIReviews = async () => {
      const contactTypes = ['listing_agent', 'title', 'mortgage', 'inspection'];

      for (const contactType of contactTypes) {
        const taskStatus = getContactTaskStatus(contactType);

        if (taskStatus && taskStatus.status === 'good' && taskStatus.totalCount > 0 && !aiReviews[contactType] && !loadingAIReviews[contactType]) {
          setLoadingAIReviews((prev) => ({ ...prev, [contactType]: true }));

          try {
            const review = await getAIPerformanceReview(contactType, taskStatus);
            setAIReviews((prev) => ({ ...prev, [contactType]: review }));
          } catch (error) {
            console.error(`Error loading AI review for ${contactType}:`, error);
          } finally {
            setLoadingAIReviews((prev) => ({ ...prev, [contactType]: false }));
          }
        } else if (taskStatus && (taskStatus.status !== 'good' || taskStatus.totalCount === 0) && aiReviews[contactType]) {
          setAIReviews((prev) => ({ ...prev, [contactType]: null }));
        }
      }
    };

    loadAIReviews();
  }, [tasks, property, aiReviews, loadingAIReviews]);

  const getSellingAgent = () => {
    if (!property) return null;

    if (property.selling_agent_name) {
      return {
        name: property.selling_agent_name,
        email: property.selling_agent_email,
        phone: property.selling_agent_phone,
        office: property.selling_agent_office,
        isManual: true
      };
    }

    if (property.selling_agent_id) {
      const user = getUser(property.selling_agent_id);
      if (user) {
        return {
          name: user.full_name || user.email,
          email: user.email,
          phone: user.phone,
          office: user.office,
          id: user.id,
          isManual: false
        };
      }
    }

    return null;
  };

  const getServiceProviderContact = (fieldName) => {
    if (!property || !property[fieldName]) return null;
    try {
      return typeof property[fieldName] === 'string' ?
      JSON.parse(property[fieldName]) :
      property[fieldName];
    } catch (error) {
      console.error(`Error parsing ${fieldName}:`, error);
      return null;
    }
  };

  const handleSaveProperty = async (updatedData) => {
    try {
      await base44.entities.Property.update(property.id, updatedData);
      setShowEditModal(false);
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);
      window.dispatchEvent(new CustomEvent('refreshCounts'));
    } catch (error) {
      console.error("Error updating property:", error);
      alert("Failed to update property. Please try again.");
    }
  };

  const handleSaveServiceProvider = async (providerData) => {
    try {
      const updateData = {};

      if (editingServiceProvider === 'title') {
        updateData.title_company = providerData.company_name;
        updateData.title_company_contact = JSON.stringify({
          name: providerData.contact_name,
          phone: providerData.phone,
          email: providerData.email
        });
      } else if (editingServiceProvider === 'mortgage') {
        updateData.mortgage_company = providerData.company_name;
        updateData.mortgage_company_contact = JSON.stringify({
          name: providerData.contact_name,
          phone: providerData.phone,
          email: providerData.email
        });
      } else if (editingServiceProvider === 'inspection') {
        updateData.inspection_company = providerData.company_name;
        updateData.inspection_company_contact = JSON.stringify({
          name: providerData.contact_name,
          phone: providerData.phone,
          email: providerData.email
        });
      }

      await base44.entities.Property.update(property.id, updateData);
      setShowServiceProviderModal(false);
      setEditingServiceProvider(null);
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);
      window.dispatchEvent(new CustomEvent('refreshCounts'));
    } catch (error) {
      console.error("Error saving service provider:", error);
      alert("Failed to save service provider. Please try again.");
    }
  };

  const handleSaveSeller = async (sellerData) => {
    try {
      let updatedSellers = [...getSellers()];

      if (editingSeller !== null && editingSeller.index !== undefined) {
        updatedSellers[editingSeller.index] = sellerData;
        console.log('üìù Updating seller at index', editingSeller.index, sellerData);
      } else {
        updatedSellers.push(sellerData);
        console.log('‚ûï Adding new seller:', sellerData);
      }

      console.log('üíæ Saving sellers_info:', updatedSellers);

      await base44.entities.Property.update(property.id, {
        sellers_info: JSON.stringify(updatedSellers)
      });

      setShowSellerModal(false);
      setEditingSeller(null);

      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);

      window.dispatchEvent(new CustomEvent('refreshCounts'));
    } catch (error) {
      console.error("Error saving seller:", error);
      alert("Failed to save seller. Please try again.");
    }
  };

  const handleSaveSellingAgent = async (agentData) => {
    try {
      await base44.entities.Property.update(property.id, {
        selling_agent_name: agentData.name,
        selling_agent_email: agentData.email,
        selling_agent_phone: agentData.phone,
        selling_agent_office: agentData.office
      });
      setShowSellingAgentModal(false);
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);
      toast.success("Selling agent information updated successfully!");
    } catch (error) {
      console.error("Error saving selling agent:", error);
      toast.error("Failed to save selling agent information");
    }
  };

  const handleSendEmail = async (email, subject, body) => {
    const recipientUser = users.find((u) => u.email === email);

    if (!recipientUser) {
      navigator.clipboard.writeText(email).then(() => {
        toast.info(`Email copied to clipboard: ${email}. The SendEmail integration only works for registered users in the app.`);
      }).catch((err) => {
        console.error('Failed to copy email:', err);
        toast.error(`Cannot send email to ${email}. Please copy it manually or use the internal messaging for registered users.`);
      });
      return;
    }

    try {
      await base44.integrations.Core.SendEmail({
        to: email,
        subject: subject || `Regarding ${property.address}`,
        body: body || `Hello,\n\nI wanted to reach out regarding the property at ${property.address}.\n\nBest regards,\n${currentUser?.full_name || ''}`
      });
      toast.success("Email sent successfully!");
    } catch (error) {
      console.error("Error sending email via integration:", error);
      toast.error(`Failed to send email: ${error.message}. Please try using your regular email client instead.`);
    }
  };

  const handleSendSMS = (phone, userId) => {
    if (!phone) {
      toast.error("No phone number available");
      return;
    }

    if (userId) {
      const user = users.find((u) => u && u.id === userId);
      if (user) {
        console.log("üì± SMS clicked - Internal messaging system is now handled by the dedicated Messages tab.");
        setPreSelectedRecipient(user); // Set the recipient for the messaging component
        setActiveTab("messages");
        toast.info("Please use the internal messaging system in the 'Messages' tab.");
        return;
      }
    }

    window.open(`sms:${phone}`, '_blank');
  };

  const handleMessageContact = (contact) => {
    if (!contact || !contact.email && !contact.phone) {
      toast.error("No contact information available to send a message.");
      return;
    }

    if (contact.isUser) {
      const user = users.find((u) => u && u.id === contact.id) || teamMembers.find((tm) => tm && tm.id === contact.id);
      if (user) {
        setPreSelectedRecipient(user);
        setActiveTab("messages");
        toast.info(`Opening chat with ${contact.full_name} in Messages tab.`);
      } else {
        // Fallback for user not found in local state, though contact.isUser implies they should be
        toast.error("Could not find internal user for messaging. Please use external options.");
        console.warn("Could not find internal user for messaging:", contact);
      }
    } else {
      // For non-internal users, direct to messages tab. PropertyMessaging component handles this type.
      setPreSelectedRecipient(contact);
      setActiveTab("messages");
      toast.info(`Opening chat with ${contact.full_name} in Messages tab.`);
    }
  };

  const handleCopyEmail = (email) => {
    if (!email) {
      alert("No email address available");
      return;
    }

    navigator.clipboard.writeText(email).then(() => {
      alert(`‚úÖ Email copied to clipboard: ${email}\n\nYou can now paste it into your email client.`);
    }).catch((err) => {
      console.error('Failed to copy email:', err);
      alert(`Email address: ${email}\n\nPlease copy it manually.`);
    });
  };

  const handleSaveTransaction = async (transactionData) => {
    console.log('üéØ handleSaveTransaction called with:', transactionData);
    console.log('üìã Current editingTransaction:', editingTransaction);

    try {
      let transactionId;
      const isNewTransaction = !editingTransaction || !editingTransaction.id;
      const wasActiveOrPending = editingTransaction && (editingTransaction.status === 'active' || editingTransaction.status === 'pending');
      const isBeingCancelled = transactionData.status === 'cancelled' && wasActiveOrPending;
      const isBeingClosed = transactionData.status === 'closed';

      console.log('üíæ Saving transaction:', {
        isNewTransaction,
        hasId: !!editingTransaction?.id,
        editingTransactionId: editingTransaction?.id,
        newStatus: transactionData.status,
        dataToSave: transactionData
      });

      if (isNewTransaction) {
        transactionData.listing_side_progress = 0;
        transactionData.selling_side_progress = 0;
        console.log('üÜï Creating new transaction with initial 0% progress');
      }

      if (editingTransaction?.id) {
        console.log('üìù Updating existing transaction:', editingTransaction.id, 'with status:', transactionData.status);
        console.log('üìã Full transaction data being saved:', transactionData);
        await base44.entities.Transaction.update(editingTransaction.id, transactionData);
        transactionId = editingTransaction.id;
        console.log('‚úÖ Transaction updated:', transactionId, 'new status:', transactionData.status);

        if (isBeingCancelled) {
          console.log('üóÑÔ∏è Transaction cancelled - archiving related items...');

          const transactionDocs = documents.filter((doc) => doc && doc.transaction_id === transactionId);
          console.log(`üìÑ Archiving ${transactionDocs.length} documents...`);

          for (const doc of transactionDocs) {
            try {
              await base44.entities.Document.update(doc.id, {
                status: 'archived'
              });
            } catch (err) {
              console.error(`Failed to archive document ${doc.id}:`, err);
            }
          }

          const contractTaskTypes = ['contract', 'financing', 'closing'];
          const contractTasks = tasks.filter((t) =>
          t && t.property_id === property.id &&
          t.task_type && contractTaskTypes.includes(t.task_type)
          );

          console.log(`üìã Cancelling ${contractTasks.length} under contract tasks...`);

          for (const task of contractTasks) {
            try {
              await base44.entities.Task.update(task.id, {
                status: 'cancelled'
              });
            } catch (err) {
              console.error(`Failed to cancel task ${task.id}:`, err);
            }
          }

          toast.success(`Transaction cancelled. ${transactionDocs.length} documents archived and ${contractTasks.length} tasks cancelled.`);
        }
      } else {
        console.log('üÜï Creating NEW transaction with data:', { ...transactionData, property_id: property.id });
        const newTransaction = await base44.entities.Transaction.create({ ...transactionData, property_id: property.id });
        transactionId = newTransaction.id;
        console.log('‚úÖ New transaction created:', newTransaction);
      }

      await new Promise((resolve) => setTimeout(resolve, 500));

      const allTransactions = await base44.entities.Transaction.filter({ property_id: property.id }).catch(() => []);

      if (!allTransactions || !Array.isArray(allTransactions)) {
        toast.error("Failed to load transactions");
        return;
      }

      console.log('üìä All transactions after save:', allTransactions.map((t) => ({ id: t.id, status: t.status })));

      let newPropertyStatus = 'active';

      const hasClosedTransaction = allTransactions.some((t) => t && t.status === 'closed');
      const hasActivePendingTransaction = allTransactions.some((t) =>
      t && (t.status === 'active' || t.status === 'pending')
      );

      if (hasClosedTransaction) {
        newPropertyStatus = 'sold';
        console.log('‚úÖ Found closed transaction - setting property to SOLD');
      } else if (hasActivePendingTransaction) {
        newPropertyStatus = 'pending';
        console.log('‚úÖ Found active/pending transaction - setting property to PENDING');
      } else {
        console.log('‚úÖ No active/pending/closed transactions - setting property to ACTIVE');
      }

      console.log('üîÑ Updating property status:', { from: property.status, to: newPropertyStatus });
      await base44.entities.Property.update(property.id, { status: newPropertyStatus });

      if (newPropertyStatus !== property.status) {
        toast.success(`Property status updated to "${newPropertyStatus.toUpperCase()}"`);
      } else if (isNewTransaction) {
        toast.success("Transaction created!");
      } else if (!isBeingCancelled) {
        toast.success("Transaction saved successfully");
      }

      if (transactionData.status === 'active' || transactionData.status === 'pending') {
        console.log('üîÑ Transaction is active/pending - updating with current task progress...');
        await updateAllTransactionProgress(property.id);
      }

      setShowTransactionModal(false);
      setEditingTransaction(null);

      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);

      window.dispatchEvent(new CustomEvent('refreshCounts'));

    } catch (error) {
      console.error("‚ùå Error saving transaction:", error);
      toast.error("Failed to save transaction. Please try again.");
    }
  };

  const handleDeleteTransaction = async (transactionId) => {
    if (!window.confirm("Are you sure you want to delete this transaction? This action cannot be undone.")) {
      return;
    }

    try {
      await base44.entities.Transaction.delete(transactionId);

      console.log('üóëÔ∏è Transaction deleted:', transactionId);

      await new Promise((resolve) => setTimeout(resolve, 300));

      const allTransactions = await base44.entities.Transaction.filter({ property_id: property.id }).catch(() => []);

      if (!allTransactions || !Array.isArray(allTransactions)) {
        toast.error("Failed to load transactions after delete.");
        return;
      }

      console.log('üìä Remaining transactions:', allTransactions.map((t) => ({ id: t.id, status: t.status })));

      let newPropertyStatus = 'active';

      const hasClosedTransaction = allTransactions.some((t) => t && t.status === 'closed');
      const hasActivePendingTransaction = allTransactions.some((t) =>
      t && (t.status === 'active' || t.status === 'pending')
      );

      if (hasClosedTransaction) {
        newPropertyStatus = 'sold';
      } else if (hasActivePendingTransaction) {
        newPropertyStatus = 'pending';
      }

      console.log('üîÑ Property status after delete:', {
        from: property.status,
        to: newPropertyStatus
      });

      await base44.entities.Property.update(property.id, { status: newPropertyStatus });

      if (newPropertyStatus !== property.status) {
        toast.success(`Transaction deleted and property status updated to "${newPropertyStatus.toUpperCase()}"`);
      } else {
        toast.success("Transaction deleted successfully");
      }

      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);

      window.dispatchEvent(new CustomEvent('refreshCounts'));

    } catch (error) {
      console.error("‚ùå Error deleting transaction:", error);
      toast.error("Failed to delete transaction. Please try again.");
    }
  };

  const handleSaveTask = async (taskData) => {
    try {
      let updatedTask = null;
      const previousStatus = editingTask?.status;
      const isNewTask = !editingTask;

      if (editingTask) {
        updatedTask = { ...editingTask, ...taskData };

        // Optimistically update UI
        setTasks((prevTasks) =>
        prevTasks.map((t) => t.id === editingTask.id ? updatedTask : t)
        );

        await base44.entities.Task.update(editingTask.id, taskData);

        // Remove notifications in background
        if (currentUser && previousStatus !== 'completed' && taskData.status === 'completed') {
          base44.entities.Notification.filter({
            user_id: currentUser.id,
            related_entity_type: 'task',
            related_entity_id: editingTask.id
          }).then((allNotifications) => {
            Promise.all(allNotifications.map((n) => base44.entities.Notification.delete(n.id)));
            window.dispatchEvent(new Event('refreshCounts'));
          }).catch(console.error);
        }
      } else {
        const newTask = await base44.entities.Task.create({ ...taskData, property_id: property.id });
        updatedTask = newTask;

        // Add to UI immediately
        setTasks((prevTasks) => [...prevTasks, newTask]);
      }

      setShowTaskModal(false);
      setEditingTask(null);

      // Update transaction progress in background
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;

      updateAllTransactionProgress(propertyId).then(() => {
        base44.entities.Transaction.filter({ property_id: propertyId }).then((freshTrans) => {
          setTransactions(freshTrans || []);
        });
      });

      // Check for celebrations
      if (updatedTask && updatedTask.status === 'completed') {
        setTimeout(() => {
          const tasksAfterUpdate = isNewTask ?
          [...tasks, updatedTask] :
          tasks.map((t) => t.id === updatedTask.id ? updatedTask : t);

          checkForCelebrations(tasksAfterUpdate, property);
        }, 100);
      }

      toast.success("Task saved");
      window.dispatchEvent(new Event('refreshCounts'));
    } catch (error) {
      console.error("‚ùå Error saving task:", error);
      toast.error("Failed to save task.");
      // Reload on error
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      loadData(propertyId);
    }
  };

  const handleUploadDocument = async (file, transactionId, category) => {
    const toastId = toast.loading('Uploading document...');

    try {
      console.log('üì§ Starting document upload:', {
        fileName: file.name,
        fileSize: file.size,
        transactionId,
        category,
        documentType: documentUploadType
      });

      let retries = 3;
      let file_uri = null;

      while (retries > 0) {
        try {
          const uploadResult = await base44.integrations.Core.UploadPrivateFile({ file });
          file_uri = uploadResult.file_uri;
          console.log('‚úÖ File uploaded successfully:', file_uri);
          break;
        } catch (uploadError) {
          retries--;
          console.warn(`‚ö†Ô∏è Upload attempt failed, ${retries} retries left:`, uploadError);

          if (retries === 0) {
            throw uploadError;
          }

          await new Promise((resolve) => setTimeout(resolve, (4 - retries) * 1000));
          toast.loading(`Retrying upload... (${3 - retries}/3)`, { id: toastId });
        }
      }

      if (!file_uri) {
        throw new Error('Failed to upload file after multiple attempts');
      }

      console.log('üíæ Creating document record with category:', category);
      const newDoc = await base44.entities.Document.create({
        property_id: property.id,
        transaction_id: transactionId,
        file_url: file_uri,
        document_name: file.name,
        category: category,
        uploaded_by: currentUser?.id || "demo-user",
        status: "pending"
      });

      console.log('‚úÖ Document created:', newDoc);
      console.log('üìä Document category saved as:', newDoc.category);

      toast.success('Document uploaded successfully!', { id: toastId });
      setShowDocumentModal(false);
      setDocumentUploadType(null);

      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);

    } catch (error) {
      console.error("‚ùå Error uploading document:", error);

      let errorMessage = "Failed to upload document. ";

      if (error.message?.includes('timeout') || error.message?.includes('DatabaseTimeout')) {
        errorMessage += "The server is experiencing high load. Please try again in a moment.";
      } else if (error.message?.includes('too large') || error.message?.includes('size')) {
        errorMessage += "File size may be too large. Please try a smaller file.";
      } else if (error.response?.status === 429) {
        errorMessage += "Too many requests. Please wait a moment before trying again.";
      } else {
        errorMessage += "Please try again.";
      }

      toast.error(errorMessage, { id: toastId });
    }
  };

  const handleUploadPhotos = async (files, propertyIdParam, caption) => {
    try {
      for (const file of files) {
        const { file_url } = await base44.integrations.Core.UploadFile({ file });
        await base44.entities.Photo.create({
          property_id: property.id,
          file_url,
          caption,
          uploaded_by: currentUser?.id || "demo-user",
          approval_status: "pending"
        });
      }
      setShowPhotoUpload(false);
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);
    } catch (error) {
      console.error("Error uploading photos:", error);
      alert("Failed to upload photos. Please try again.");
    }
  };

  const handleEditTransaction = (transaction) => {
    setEditingTransaction(transaction);
    setShowTransactionModal(true);
  };

  const handleEditTask = (task) => {
    setEditingTask(task);
    setShowTaskModal(true);
  };

  const handleAddSeller = () => {
    setEditingSeller(null);
    setShowSellerModal(true);
  };

  const handleEditSeller = (seller, index) => {
    setEditingSeller({ seller, index });
    setShowSellerModal(true);
  };

  const handleTaskDragEnd = async (result) => {
    if (!result.destination) return;

    const canEdit = currentUser && property && canEditProperty(currentUser, property);
    if (!canEdit) {
      toast.error("You do not have permission to update task status.");
      return;
    }

    const { source, destination, draggableId } = result;
    if (source.droppableId === destination.droppableId) return;

    try {
      const updatedTaskData = {
        status: destination.droppableId,
        completed_date: destination.droppableId === 'completed' ? new Date().toISOString() : null
      };

      // Optimistically update UI immediately
      setTasks((prevTasks) =>
      prevTasks.map((t) => t.id === draggableId ? { ...t, ...updatedTaskData } : t)
      );

      // Update in background
      await base44.entities.Task.update(draggableId, updatedTaskData);

      // Remove notifications silently in background
      if (currentUser && destination.droppableId === 'completed') {
        base44.entities.Notification.filter({
          user_id: currentUser.id,
          related_entity_type: 'task',
          related_entity_id: draggableId
        }).then((allNotifications) => {
          Promise.all(allNotifications.map((n) => base44.entities.Notification.delete(n.id)));
          window.dispatchEvent(new Event('refreshCounts'));
        }).catch(console.error);
      }

      // Update transaction progress in background without reloading
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      updateAllTransactionProgress(propertyId).then(() => {
        // Refresh transactions only
        base44.entities.Transaction.filter({ property_id: propertyId }).then((freshTrans) => {
          setTransactions(freshTrans || []);
        });
      });

      // Check for celebrations
      if (destination.droppableId === 'completed') {
        setTimeout(() => {
          const tasksAfterDrag = tasks.map((t) => t.id === draggableId ? { ...t, status: 'completed' } : t);
          checkForCelebrations(tasksAfterDrag, property);
        }, 100);
      }

      toast.success("Task updated");
      window.dispatchEvent(new Event('refreshCounts'));

    } catch (error) {
      console.error("‚ùå Error updating task status:", error);
      toast.error("Failed to update task status.");
      // Revert on error
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      loadData(propertyId);
    }
  };

  const toggleSection = (section) => {
    setExpandedSections((prev) => ({
      ...prev,
      [section]: !prev[section]
    }));
  };

  const handleTaskWarningClick = (taskStatus) => {
    if (!taskStatus || !taskStatus.tasks || taskStatus.tasks.length === 0) return;

    console.log('üéØ Task warning clicked:', taskStatus);

    const taskIds = taskStatus.tasks.map((t) => t.id);
    setHighlightedTaskIds(taskIds);
    setTaskFilter(taskStatus.status);

    setActiveTab("tasks");

    setTimeout(() => {
      const tasksSection = document.getElementById('tasks-section');
      if (tasksSection) {
        tasksSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 100);

    setTimeout(() => {
      setHighlightedTaskIds([]);
      setTaskFilter(null);
    }, 10000);
  };

  const handleDeleteDocument = async (documentId) => {
    if (!window.confirm("Are you sure you want to delete this document?")) return;
    try {
      await base44.entities.Document.delete(documentId);
      toast.success("Document deleted successfully!");
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);
    } catch (error) {
      console.error("Error deleting document:", error);
      toast.error("Failed to delete document.");
    }
  };

  const handlePreviewDocument = (doc) => {
    if (doc) {
      setPreviewDocument(doc);
    } else {
      toast.error("No document available for preview.");
    }
  };

  const handleDocumentStatusChange = async (documentId, newStatus) => {
    try {
      await base44.entities.Document.update(documentId, { status: newStatus });
      toast.success("Document status updated!");
      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);
    } catch (error) {
      console.error("Error updating document status:", error);
      toast.error("Failed to update document status.");
    }
  };

  const handleUpdateDocumentCategory = async (documentId, newCategory) => {
    try {
      await base44.entities.Document.update(documentId, { category: newCategory });
      toast.success("Document category updated");

      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);
    } catch (error) {
      console.error("Error updating document category:", error);
      toast.error("Failed to update document category");
    }
  };

  const handleBulkUpdateCategory = async (newCategory) => {
    if (selectedDocuments.length === 0) {
      toast.error("No documents selected");
      return;
    }

    try {
      await Promise.all(
        selectedDocuments.map((docId) =>
        base44.entities.Document.update(docId, { category: newCategory })
        )
      );

      toast.success(`${selectedDocuments.length} document(s) moved to ${newCategory}`);
      setSelectedDocuments([]);

      const urlParams = new URLSearchParams(window.location.search);
      const propertyId = urlParams.get('id') || id;
      await loadData(propertyId);
    } catch (error) {
      console.error("Error bulk updating documents:", error);
      toast.error("Failed to update documents");
    }
  };

  const toggleDocumentSelection = (docId) => {
    setSelectedDocuments((prev) =>
    prev.includes(docId) ? prev.filter((id_val) => id_val !== docId) : [...prev, docId]
    );
  };

  const selectAllFilteredDocuments = () => {
    if (selectedDocuments.length === filteredDocuments.length && filteredDocuments.length > 0) {
      setSelectedDocuments([]);
    } else {
      setSelectedDocuments(filteredDocuments.map((d) => d.id));
    }
  };

  const handleEnrichPropertyData = async () => {
    if (!property || loadingEnrichedData) return;

    setLoadingEnrichedData(true);
    try {
      const response = await enrichPropertyData({
        property_id: property.id,
        address: property.address,
        city: property.city,
        state: property.state,
        zip_code: property.zip_code,
        property_type: property.property_type
      });

      if (response.data?.success && response.data?.data) {
        setEnrichedData(response.data.data);
        toast.success("Property data enriched successfully!");
      } else {
        throw new Error(response.data?.error || "Failed to enrich data");
      }
    } catch (error) {
      console.error("Error enriching property data:", error);
      toast.error("Failed to enrich property data");
    } finally {
      setLoadingEnrichedData(false);
    }
  };

  // Load enriched data if it exists on the property
  useEffect(() => {
    if (property?.enriched_data) {
      try {
        const parsed = typeof property.enriched_data === 'string' ?
        JSON.parse(property.enriched_data) :
        property.enriched_data;
        setEnrichedData(parsed);
      } catch (e) {
        console.error("Error parsing enriched data:", e);
      }
    }
  }, [property]);

  const listingCategories = useMemo(() => ['disclosure', 'marketing', 'listing_agreement', 'property_info', 'appraisal'], []);
  const contractCategories = useMemo(() => ['contract', 'offer', 'inspection', 'addendum', 'amendment', 'closing', 'financing', 'title'], []);

  const filteredDocuments = useMemo(() => {
    if (!documents || !Array.isArray(documents)) {
      return [];
    }

    if (documentTypeFilter === 'all') {
      return documents;
    }

    const filtered = documents.filter((doc) => {
      if (!doc || !doc.category) {
        return false;
      }

      if (documentTypeFilter === 'listing') {
        return listingCategories.includes(doc.category);
      } else if (documentTypeFilter === 'contract') {
        return contractCategories.includes(doc.category);
      }
      return false;
    });

    return filtered;
  }, [documents, documentTypeFilter, listingCategories, contractCategories]);

  const listingDocsCount = useMemo(() => {
    if (!documents || !Array.isArray(documents)) return 0;
    return documents.filter((doc) => doc && doc.category && listingCategories.includes(doc.category)).length;
  }, [documents, listingCategories]);

  const contractDocsCount = useMemo(() => {
    if (!documents || !Array.isArray(documents)) return 0;
    return documents.filter((doc) => doc && doc.category && contractCategories.includes(doc.category)).length;
  }, [documents, contractCategories]);

  if (isLoading) {
    return <LoadingSpinner icon={Home} title="Loading Property..." description="Loading property details and related information" />;
  }

  if (error || !property) {
    return (
      <div className="page-container">
        <div className="p-6 text-center">
          <Building2 className="w-12 h-12 mx-auto mb-3 text-slate-300 dark:text-slate-600" />
          <h2 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
            {error || "Property not found"}
          </h2>
          <p className="text-sm text-slate-500 dark:text-slate-400 mb-3">
            {error && error.includes("Too many requests") ?
            "The system is experiencing high load. Please wait 30 seconds and try again." :
            "The property you're looking for doesn't exist or may have been removed."}
          </p>
          <div className="flex gap-3 justify-center">
            <Button onClick={() => navigate(createPageUrl("Properties"))} size="sm">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back to Properties
            </Button>
            {error && error.includes("Rate limit") &&
            <Button onClick={() => window.location.reload()} size="sm" variant="outline">
                Try Again
              </Button>
            }
          </div>
        </div>
      </div>);

  }

  const sellingAgent = getSellingAgent();
  const buyer = getBuyer();
  const sellers = getSellers() || [];
  const titleContact = getServiceProviderContact('title_company_contact');
  const mortgageContact = getServiceProviderContact('mortgage_company_contact');
  const inspectionContact = getServiceProviderContact('inspection_company_contact');

  const canEdit = currentUser && property && canEditProperty(currentUser, property);
  const canDelete = currentUser && property && canDeleteProperty(currentUser, property);

  console.log('üîê Permission Debug:', {
    hasCurrentUser: !!currentUser,
    currentUserRole: currentUser?.role,
    hasProperty: !!property,
    canEdit,
    canDelete,
    propertyListingAgentId: property?.listing_agent_id,
    propertySellingAgentId: property?.selling_agent_id,
    currentUserId: currentUser?.id
  });

  const currentProgress = calculateProgressFromTasks(tasks);

  const listingSideTaskTypes = ['listing', 'marketing', 'documentation', 'inspection'];
  const contractSideTaskTypes = ['contract', 'financing', 'closing'];

  const listingPackageTasks = (tasks || []).filter((t) => t && t.task_type && typeof t.task_type === 'string' && listingSideTaskTypes.includes(t.task_type));
  const underContractTasks = (tasks || []).filter((t) => t && t.task_type && typeof t.task_type === 'string' && contractSideTaskTypes.includes(t.task_type));

  const hasActiveTransaction = (transactions || []).some((t) =>
  t && t.status && (t.status === 'active' || t.status === 'pending')
  );

  const pendingTasks = (tasks || []).filter((t) => t && t.status && t.status !== 'completed' && t.status !== 'cancelled').length;


  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 p-4 lg:p-6">
      <Card className="max-w-8xl mx-auto bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-800 shadow-sm">
        <CardContent className="p-0">
          <div className="relative h-80 lg:h-96 w-full">
            {property.primary_photo_url ?
            <>
                <img
                src={property.primary_photo_url}
                alt={property.address}
                className="w-full h-full object-cover" />

                <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
              </> :

            <div className="w-full h-full bg-gradient-to-br from-slate-800 to-slate-900"></div>
            }

            <div className="absolute top-6 left-6">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => navigate(createPageUrl("Properties"))}
                className="bg-white/10 backdrop-blur-md hover:bg-white/20 text-white border border-white/30">

                <ArrowLeft className="w-4 h-4 mr-2" />
                All Properties
              </Button>
            </div>

            <div className="absolute top-6 right-6">
              <Badge className={`px-4 py-2 text-sm font-bold shadow-2xl backdrop-blur-md border-2 ${
              property.status === 'active' ? 'bg-green-500/90 text-white border-green-300' :
              property.status === 'pending' ? 'bg-yellow-500/90 text-white border-yellow-300' :
              property.status === 'sold' ? 'bg-blue-500/90 text-white border-blue-300' :
              'bg-red-500/90 text-white border-red-300'}`
              }>
                ‚óè {property.status?.toUpperCase() || 'ACTIVE'}
              </Badge>
            </div>

            <div className="absolute bottom-0 left-0 right-0 p-6">
              <div className="max-w-7xl mx-auto">
                <div className="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                  <div>
                    <h1 className="text-3xl lg:text-4xl font-bold text-white mb-2 drop-shadow-lg">
                      {property.address}
                    </h1>
                    <div className="flex items-center gap-2 text-white/90 text-lg drop-shadow-lg">
                      <MapPin className="w-5 h-5" />
                      <span>{property.city}, {property.state} {property.zip_code}</span>
                    </div>
                    
                    <div className="flex flex-wrap gap-4 mt-4">
                      <div className="flex items-center gap-2 bg-white/20 backdrop-blur-md px-4 py-2 rounded-lg">
                        <DollarSign className="w-5 h-5 text-white" />
                        <span className="text-white font-bold text-lg">
                          ${property.price?.toLocaleString()}
                        </span>
                      </div>
                      {property.bedrooms &&
                      <div className="flex items-center gap-2 bg-white/20 backdrop-blur-md px-4 py-2 rounded-lg">
                          <BedDouble className="w-5 h-5 text-white" />
                          <span className="text-white font-semibold">{property.bedrooms} Beds</span>
                        </div>
                      }
                      {property.bathrooms &&
                      <div className="flex items-center gap-2 bg-white/20 backdrop-blur-md px-4 py-2 rounded-lg">
                          <Bath className="w-5 h-5 text-white" />
                          <span className="text-white font-semibold">{property.bathrooms} Baths</span>
                        </div>
                      }
                      {property.square_feet &&
                      <div className="flex items-center gap-2 bg-white/20 backdrop-blur-md px-4 py-2 rounded-lg">
                          <Square className="w-5 h-5 text-white" />
                          <span className="text-white font-semibold">{property.square_feet.toLocaleString()} sq ft</span>
                        </div>
                      }
                      {property.listing_date &&
                      <div className="flex items-center gap-2 bg-white/20 backdrop-blur-md px-3 py-1.5 rounded-lg">
                          <Calendar className="w-4 h-4 text-white" />
                          <span className="text-white text-sm">
                            Listed: {format(new Date(property.listing_date), 'MMM dd, yyyy')}
                            {property.expiration_date && (() => {
                            const expDate = new Date(property.expiration_date);
                            const today = new Date();
                            const daysLeft = Math.ceil((expDate - today) / (1000 * 60 * 60 * 1000));

                            if (daysLeft <= 0) {
                              return <span className="ml-2 text-red-300 font-semibold">(Expired)</span>;
                            } else if (daysLeft < 30) {
                              return <span className="ml-2 text-amber-300 font-semibold">({daysLeft}d left)</span>;
                            } else {
                              return <span className="ml-2 text-white/70">({daysLeft}d left)</span>;
                            }
                          })()}
                          </span>
                        </div>
                      }
                      {property.expiration_date &&
                      <PropertyExpirationBadge expirationDate={property.expiration_date} />
                      }
                    </div>
                  </div>

                  <div className="flex flex-wrap gap-2">
                    {canEdit &&
                    <>
                        <Button
                        onClick={() => navigate(createPageUrl(`TaskPackages?propertyId=${property.id}`))}
                        className="bg-indigo-600/95 backdrop-blur-md hover:bg-indigo-700 text-white shadow-xl">

                          <Package className="w-4 h-4 mr-2" />
                          Task Packages
                        </Button>
                        <Button
                        onClick={() => navigate(createPageUrl(`AIPropertyDescriptionGenerator?id=${property.id}`))}
                        className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white shadow-xl">

                          <Sparkles className="w-4 h-4 mr-2" />
                          AI Tools
                        </Button>
                        <Button
                        onClick={() => setShowEditModal(true)}
                        className="bg-white/95 backdrop-blur-md text-slate-900 hover:bg-white shadow-xl">

                          <Edit className="w-4 h-4 mr-2" />
                          Edit
                        </Button>
                      </>
                    }
                    {canDelete &&
                    <Button
                      variant="destructive"
                      className="bg-red-600/95 backdrop-blur-md hover:bg-red-700 text-white shadow-xl"
                      onClick={async () => {
                        if (window.confirm("Are you sure you want to delete this property? This action cannot be undone.")) {
                          try {
                            await base44.entities.Property.delete(property.id);
                            navigate(createPageUrl("Properties"));
                          } catch (error) {
                            console.error("Error deleting property:", error);
                            alert("Failed to delete property. Please try again.");
                          }
                        }
                      }}>

                        <X className="w-4 h-4 mr-2" />
                        Delete
                      </Button>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <Card className="border-2 border-blue-200 dark:border-blue-800 shadow-lg">
                <CardContent className="py-2">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                        <Home className="w-6 h-6 text-blue-600 dark:text-blue-400" />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-slate-900 dark:text-white">Listing Progress</h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400">
                          Marketing & preparation
                        </p>
                      </div>
                    </div>
                    <div className="text-3xl font-bold text-blue-600 dark:text-blue-400">
                      {currentProgress.listing_side_progress !== null ? `${currentProgress.listing_side_progress}%` : '‚Äî'}
                    </div>
                  </div>
                  <div className="h-4 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-gradient-to-r from-blue-500 to-blue-600 transition-all duration-500"
                      style={{ width: `${currentProgress.listing_side_progress || 0}%` }} />

                  </div>
                  <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                    {currentProgress.listing_tasks_count > 0 ?
                    `Based on ${currentProgress.listing_tasks_count} listing, marketing, documentation, and inspection tasks` :
                    "No listing tasks yet - add tasks to track progress"}
                  </p>
                </CardContent>
              </Card>

              <Card className="border-2 border-purple-200 dark:border-purple-800 shadow-lg">
                <CardContent className="px-2">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center">
                        <Briefcase className="w-6 h-6 text-purple-600 dark:text-purple-400" />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-slate-900 dark:text-white">Selling Progress</h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400">
                          Contract to closing
                        </p>
                      </div>
                    </div>
                    <div className="text-3xl font-bold text-purple-600 dark:text-purple-400">
                      {currentProgress.selling_side_progress !== null ? `${currentProgress.selling_side_progress}%` : '‚Äî'}
                    </div>
                  </div>
                  <div className="h-4 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-gradient-to-r from-purple-500 to-purple-600 transition-all duration-500"
                      style={{ width: `${currentProgress.selling_side_progress || 0}%` }} />

                  </div>
                  <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                    {currentProgress.selling_tasks_count > 0 ?
                    `Based on ${currentProgress.selling_tasks_count} contract, financing, and closing tasks` :
                    "No selling tasks yet - add contract tasks to track progress"}
                  </p>
                </CardContent>
              </Card>
            </div>

            <Card className="mb-8 shadow-lg border-2">
              <CardContent className="p-4">
                <div className="flex flex-wrap items-center justify-between gap-4">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-semibold text-slate-700 dark:text-slate-300">Quick Actions:</span>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {canEdit &&
                    <>
                        <Button
                        size="sm"
                        onClick={() => {
                          setEditingTask(null);
                          setShowTaskModal(true);
                        }}
                        className="bg-indigo-600 hover:bg-indigo-700">

                          <Plus className="w-4 h-4 mr-1" />
                          Add Task
                        </Button>
                        
                        <TooltipProvider>
                          <Tooltip>
                            <TooltipTrigger asChild>
                              <span>
                                <Button
                                size="sm"
                                onClick={() => {
                                  if (hasActiveTransaction) {
                                    toast.error("Transaction already pending. Can't add more before canceling the current transaction.");
                                    return;
                                  }
                                  console.log('üîò Add Transaction clicked');
                                  // Pre-fill with property data
                                  setEditingTransaction({
                                    property_id: property.id,
                                    contract_price: property.price,
                                    commission_listing: property.listing_side_commission || 3,
                                    commission_selling: property.selling_side_commission || 3,
                                    agent_split_percentage: property.agent_split_percentage || 50,
                                    sellers_info: property.sellers_info,
                                    buyers_info: property.buyer_name ? JSON.stringify([{
                                      name: property.buyer_name,
                                      email: property.buyer_email,
                                      phone: property.buyer_phone
                                    }]) : null,
                                    roles: {
                                      listing_agent_id: property.listing_agent_id
                                    },
                                    selling_agent_name: property.selling_agent_name,
                                    selling_agent_email: property.selling_agent_email,
                                    selling_agent_phone: property.selling_agent_phone,
                                    selling_agent_office: property.selling_agent_office
                                  });
                                  setShowTransactionModal(true);
                                }}
                                disabled={hasActiveTransaction}
                                className="bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">

                                  <Plus className="w-4 h-4 mr-1" />
                                  Add Transaction
                                </Button>
                              </span>
                            </TooltipTrigger>
                            {hasActiveTransaction &&
                          <TooltipContent>
                                <p>Transaction already pending. Can't add more before canceling the current transaction.</p>
                              </TooltipContent>
                          }
                          </Tooltip>
                        </TooltipProvider>
                        
                        <DropdownMenu>
                          <DropdownMenuTrigger asChild>
                            <Button
                            size="sm"
                            className="bg-blue-600 hover:bg-blue-700">

                              <Plus className="w-4 h-4 mr-1" />
                              Upload Documents
                            </Button>
                          </DropdownMenuTrigger>
                          <DropdownMenuContent align="end">
                            <DropdownMenuItem
                            onClick={() => {
                              setDocumentUploadType('listing');
                              setShowDocumentModal(true);
                            }}>

                              <FileText className="w-4 h-4 mr-2 text-blue-600" />
                              <div>
                                <div className="font-semibold">Listing Documents</div>
                                <div className="text-xs text-slate-500">Disclosures, marketing materials, etc.</div>
                              </div>
                            </DropdownMenuItem>
                            <DropdownMenuSeparator />
                            <DropdownMenuItem
                            onClick={() => {
                              setDocumentUploadType('contract');
                              setShowDocumentModal(true);
                            }}>

                              <FileText className="w-4 h-4 mr-2 text-purple-600" />
                              <div>
                                <div className="font-semibold">Under Contract Documents</div>
                                <div className="text-xs text-slate-500">Contracts, inspection reports, etc.</div>
                              </div>
                            </DropdownMenuItem>
                          </DropdownMenuContent>
                        </DropdownMenu>
                        
                        <Button
                        size="sm"
                        onClick={() => setShowPhotoUpload(true)}
                        className="bg-purple-600 hover:bg-purple-700">

                          <Plus className="w-4 h-4 mr-1" />
                          Add Photos
                        </Button>
                        <Button
                        size="sm"
                        onClick={() => setActiveTab("messages")}
                        className="bg-slate-600 hover:bg-slate-700">

                          <MessageSquare className="w-4 h-4 mr-1" />
                          Send Message
                        </Button>
                      </>
                    }
                  </div>
                </div>
              </CardContent>
            </Card>

            {property && property.status === 'pending' && transactions && transactions.some((t) => t && (t.status === 'active' || t.status === 'pending')) &&
            <div className="mb-8">
                <UnderContractTracker
                property={property}
                currentUser={currentUser}
                onTasksGenerated={async () => {
                  const urlParams = new URLSearchParams(window.location.search);
                  const propertyId = urlParams.get('id') || id;
                  await new Promise((resolve) => setTimeout(resolve, 1000));
                  await loadData(propertyId);
                  toast.success("Tasks generated and progress updated!");
                }} />

              </div>
            }

            <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
              <TabsList className="bg-white dark:bg-slate-800 mb-6 p-3 rounded-xl sticky top-0 z-50 grid w-full grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 shadow-lg border border-slate-200 dark:border-slate-700 h-auto">
                <TabsTrigger value="overview" className={`${baseTabStyle} ${inactiveText} ${tabColors.overview.hover} ${tabColors.overview.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <LayoutGrid className={`w-5 h-5 ${tabColors.overview.icon} group-data-[state=active]:text-white`} />
                  <span>Overview</span>
                </TabsTrigger>
                <TabsTrigger value="contacts" className={`${baseTabStyle} ${inactiveText} ${tabColors.contacts.hover} ${tabColors.contacts.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <Users className={`w-5 h-5 ${tabColors.contacts.icon} group-data-[state=active]:text-white`} />
                  <span className="flex items-center">
                    Contacts
                    {tasks.length > 0 && tasks.filter((t) => t && t.due_date && t.status && t.status !== 'completed' && (t.status === 'overdue' || new Date(t.due_date) < new Date(new Date().getTime() + 3 * 24 * 60 * 60 * 1000))).length > 0 &&
                    <Badge className="ml-1 px-1.5 py-0.5 text-[9px] h-4 bg-purple-600">
                        <AlertCircle className="w-3 h-3" />
                      </Badge>
                    }
                  </span>
                </TabsTrigger>
                <TabsTrigger value="tasks" className={`${baseTabStyle} ${inactiveText} ${tabColors.tasks.hover} ${tabColors.tasks.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <ListChecks className={`w-5 h-5 ${tabColors.tasks.icon} group-data-[state=active]:text-white`} />
                  <span className="flex items-center">
                    Tasks
                    {pendingTasks > 0 && <Badge className="ml-1.5 px-1.5 py-0.5 text-[9px] h-4 bg-white/30 text-white">{pendingTasks}</Badge>}
                  </span>
                </TabsTrigger>
                <TabsTrigger value="transactions" className={`${baseTabStyle} ${inactiveText} ${tabColors.transactions.hover} ${tabColors.transactions.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <FileCheck2 className={`w-5 h-5 ${tabColors.transactions.icon} group-data-[state=active]:text-white`} />
                  <span className="flex items-center">
                    Transactions
                    {transactions.length > 0 &&
                    <Badge className="ml-1 px-1.5 py-0.5 text-[9px] h-4 bg-green-600">{transactions.length}</Badge>
                    }
                  </span>
                </TabsTrigger>
                <TabsTrigger value="documents" className={`${baseTabStyle} ${inactiveText} ${tabColors.documents.hover} ${tabColors.documents.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <Folder className={`w-5 h-5 ${tabColors.documents.icon} group-data-[state=active]:text-white`} />
                  <span className="flex items-center">
                    Documents
                    {documents.length > 0 &&
                    <Badge className="ml-1 px-1.5 py-0.5 text-[9px] h-4 bg-blue-600">{documents.length}</Badge>
                    }
                  </span>
                </TabsTrigger>
                <TabsTrigger value="photos" className={`${baseTabStyle} ${inactiveText} ${tabColors.photos.hover} ${tabColors.photos.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <Camera className={`w-5 h-5 ${tabColors.photos.icon} group-data-[state=active]:text-white`} />
                  <span className="flex items-center">
                    Photos
                    {photos.length > 0 &&
                    <Badge className="ml-1 px-1.5 py-0.5 text-[9px] h-4 bg-purple-600">{photos.length}</Badge>
                    }
                  </span>
                </TabsTrigger>

                <TabsTrigger value="valuation" className={`${baseTabStyle} ${inactiveText} ${tabColors.valuation.hover} ${tabColors.valuation.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <TrendingUp className={`w-5 h-5 ${tabColors.valuation.icon} group-data-[state=active]:text-white`} />
                  <span>Valuation</span>
                </TabsTrigger>
                <TabsTrigger value="deal_room" className={`${baseTabStyle} ${inactiveText} ${tabColors.messages.hover} ${tabColors.messages.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <Shield className={`w-5 h-5 ${tabColors.messages.icon} group-data-[state=active]:text-white`} />
                  <span>Deal Room</span>
                </TabsTrigger>
                <TabsTrigger value="ai_insights" className={`${baseTabStyle} ${inactiveText} ${tabColors['ai_insights'].hover} ${tabColors['ai_insights'].active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <Brain className={`w-5 h-5 ${tabColors['ai_insights'].icon} group-data-[state=active]:text-white`} />
                  <span>AI Insights</span>
                </TabsTrigger>
                <TabsTrigger value="marketing" className={`${baseTabStyle} ${inactiveText} ${tabColors.marketing.hover} ${tabColors.marketing.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <Megaphone className={`w-5 h-5 ${tabColors.marketing.icon} group-data-[state=active]:text-white`} />
                  <span>Marketing</span>
                </TabsTrigger>
                <TabsTrigger value="ai_advice" className={`${baseTabStyle} ${inactiveText} ${tabColors['ai_advice'].hover} ${tabColors['ai_advice'].active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <Sparkles className={`w-5 h-5 ${tabColors['ai_advice'].icon} group-data-[state=active]:text-white`} />
                  <span>AI Advice</span>
                </TabsTrigger>
                <TabsTrigger value="feedback" className={`${baseTabStyle} ${inactiveText} ${tabColors.feedback.hover} ${tabColors.feedback.active} data-[state=active]:text-white data-[state=active]:shadow-md`}>
                  <MessageSquare className={`w-5 h-5 ${tabColors.feedback.icon} group-data-[state=active]:text-white`} />
                  <span>Feedback</span>
                </TabsTrigger>
              </TabsList>

              <div style={{ paddingTop: '80px' }} className="">
                <TabsContent value="overview" className="space-y-6 mt-0">
                  {/* Key Property Stats - Visual Cards */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {property.property_type &&
                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800">
                        <div className="flex items-center gap-2 mb-2">
                          <div className="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center">
                            <Home className="w-4 h-4 text-white" />
                          </div>
                          <span className="text-xs font-medium text-blue-600 dark:text-blue-400 uppercase tracking-wide">Type</span>
                        </div>
                        <p className="text-lg font-bold text-slate-900 dark:text-white capitalize">{property.property_type.replace('_', ' ')}</p>
                      </div>
                    }
                    {property.year_built &&
                    <div className="bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900/30 dark:to-amber-800/20 rounded-xl p-4 border border-amber-200 dark:border-amber-800">
                        <div className="flex items-center gap-2 mb-2">
                          <div className="w-8 h-8 rounded-lg bg-amber-500 flex items-center justify-center">
                            <Calendar className="w-4 h-4 text-white" />
                          </div>
                          <span className="text-xs font-medium text-amber-600 dark:text-amber-400 uppercase tracking-wide">Built</span>
                        </div>
                        <p className="text-lg font-bold text-slate-900 dark:text-white">{property.year_built}</p>
                      </div>
                    }
                    {property.lot_size &&
                    <div className="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/20 rounded-xl p-4 border border-green-200 dark:border-green-800">
                        <div className="flex items-center gap-2 mb-2">
                          <div className="w-8 h-8 rounded-lg bg-green-500 flex items-center justify-center">
                            <Square className="w-4 h-4 text-white" />
                          </div>
                          <span className="text-xs font-medium text-green-600 dark:text-green-400 uppercase tracking-wide">Lot Size</span>
                        </div>
                        <p className="text-lg font-bold text-slate-900 dark:text-white">{property.lot_size} acres</p>
                      </div>
                    }
                    {property.mls_number &&
                    <div className="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/20 rounded-xl p-4 border border-purple-200 dark:border-purple-800">
                        <div className="flex items-center gap-2 mb-2">
                          <div className="w-8 h-8 rounded-lg bg-purple-500 flex items-center justify-center">
                            <FileText className="w-4 h-4 text-white" />
                          </div>
                          <span className="text-xs font-medium text-purple-600 dark:text-purple-400 uppercase tracking-wide">MLS #</span>
                        </div>
                        <p className="text-lg font-bold text-slate-900 dark:text-white">{property.mls_number}</p>
                      </div>
                    }
                  </div>

                  {/* Description Card */}
                  {property.description &&
                  <Card className="shadow-lg overflow-hidden">
                      <CardHeader className="bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 pb-3">
                        <CardTitle className="flex items-center gap-2 text-base">
                          <FileText className="w-5 h-5 text-slate-600" />
                          Property Description
                        </CardTitle>
                      </CardHeader>
                      <CardContent className="pt-4">
                        <p className="text-slate-700 dark:text-slate-300 leading-relaxed whitespace-pre-line">{property.description}</p>
                      </CardContent>
                    </Card>
                  }

                  {/* Features Card */}
                  {property.features &&
                  <Card className="shadow-lg overflow-hidden">
                      <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 pb-3">
                        <CardTitle className="flex items-center gap-2 text-base">
                          <Sparkles className="w-5 h-5 text-indigo-600" />
                          Property Features
                        </CardTitle>
                      </CardHeader>
                      <CardContent className="pt-4">
                        <div className="flex flex-wrap gap-2">
                          {property.features.split(',').map((feature, index) =>
                        <Badge
                          key={index}
                          className="bg-gradient-to-r from-indigo-100 to-purple-100 dark:from-indigo-900/40 dark:to-purple-900/40 text-indigo-700 dark:text-indigo-300 border-0 px-3 py-1.5 text-sm font-medium">

                              {feature.trim()}
                            </Badge>
                        )}
                        </div>
                      </CardContent>
                    </Card>
                  }

                </TabsContent>

                <TabsContent value="contacts" className="space-y-6">
                  {buyer && transactions.some((t) => t.status === 'active' || t.status === 'pending') &&
                  <Card className="shadow-lg border-2 border-pink-200 dark:border-pink-800 bg-gradient-to-r from-pink-50 to-purple-50 dark:from-pink-900/20 dark:to-purple-900/20">
                      <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                          <div>
                            <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-1">Client Relationship Health</h3>
                            <p className="text-sm text-slate-600 dark:text-slate-400">Real-time engagement tracking for {buyer.name}</p>
                          </div>
                          <ClientLoveMeter
                          property={property}
                          transaction={transactions.find((t) => t.status === 'active' || t.status === 'pending')}
                          clientPortalAccess={clientPortalAccess.filter((a) => a.access_type === 'buyer')}
                          documents={documents}
                          communications={communications}
                          onActionClick={() => setActiveTab("messages")} />

                        </div>
                      </CardContent>
                    </Card>
                  }

                  <Card className="shadow-lg">
                    <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
                      <div className="flex items-center justify-between">
                        <CardTitle className="flex items-center gap-2">
                          <Users className="w-5 h-5 text-indigo-600" />
                          All Contacts
                        </CardTitle>
                        {canEdit &&
                        <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                              <Button size="sm">
                                <Plus className="w-4 h-4 mr-2" />
                                Add Contact
                              </Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="end" className="w-48">
                              <DropdownMenuLabel>Add Contact Type</DropdownMenuLabel>
                              <DropdownMenuSeparator />
                              <DropdownMenuItem onClick={() => {setEditingSeller(null);setShowSellerModal(true);}}>
                                <Users className="w-4 h-4 mr-2" />
                                Seller
                              </DropdownMenuItem>
                              <DropdownMenuItem onClick={() => setShowEditModal(true)}>
                                <UserIcon className="w-4 h-4 mr-2" />
                                Listing Agent
                              </DropdownMenuItem>
                              <DropdownMenuItem onClick={() => setShowSellingAgentModal(true)}>
                                <UserIcon className="w-4 h-4 mr-2" />
                                Selling Agent
                              </DropdownMenuItem>
                              <DropdownMenuItem onClick={() => setShowEditModal(true)}>
                                <UserIcon className="w-4 h-4 mr-2" />
                                Buyer
                              </DropdownMenuItem>
                              <DropdownMenuSeparator />
                              <DropdownMenuItem onClick={() => {setEditingServiceProvider('title');setShowServiceProviderModal(true);}}>
                                <Building2 className="w-4 h-4 mr-2" />
                                Title Company
                              </DropdownMenuItem>
                              <DropdownMenuItem onClick={() => {setEditingServiceProvider('mortgage');setShowServiceProviderModal(true);}}>
                                <DollarSign className="w-4 h-4 mr-2" />
                                Mortgage Company
                              </DropdownMenuItem>
                              <DropdownMenuItem onClick={() => {setEditingServiceProvider('inspection');setShowServiceProviderModal(true);}}>
                                <Building2 className="w-4 h-4 mr-2" />
                                Inspection Company
                              </DropdownMenuItem>
                            </DropdownMenuContent>
                          </DropdownMenu>
                        }
                      </div>
                    </CardHeader>
                    <CardContent className="pt-6">
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {(() => {
                          const listingAgent = getListingAgent();
                          const taskStatus = getContactTaskStatus('listing_agent');

                          return listingAgent ?
                          <ContactCard
                            title="Listing Agent"
                            name={listingAgent.full_name || listingAgent.email}
                            phone={listingAgent.phone}
                            email={listingAgent.email}
                            office={listingAgent.office}
                            taskStatus={taskStatus}
                            aiReview={aiReviews.listing_agent}
                            loadingAIReview={loadingAIReviews.listing_agent}
                            onTaskClick={handleTaskWarningClick}
                            onMessage={listingAgent.email || listingAgent.phone ? () => handleMessageContact({
                              id: listingAgent.id,
                              full_name: listingAgent.full_name || listingAgent.email,
                              email: listingAgent.email,
                              phone: listingAgent.phone,
                              role: 'Listing Agent',
                              isUser: true
                            }) : undefined}
                            onEmail={listingAgent.email ? () => handleSendEmail(listingAgent.email) : undefined}
                            onSMS={listingAgent.phone ? () => handleSendSMS(listingAgent.phone, listingAgent.id) : undefined}
                            onEdit={canEdit ? () => setShowEditModal(true) : undefined} /> :


                          <Card className="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-400 transition-colors">
                              <p className="text-xs font-bold uppercase text-slate-500 mb-2">Listing Agent</p>
                              <p className="text-sm font-semibold mb-3">Not assigned</p>
                              {canEdit &&
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => setShowEditModal(true)}
                              className="w-full">

                                  <Plus className="w-4 h-4 mr-2" />
                                  Assign
                                </Button>
                            }
                            </Card>;

                        })()}

                        {sellers && sellers.map((seller, index) => {
                          if (!seller) return null;
                          const sellerUser = (users || []).find((u) => u && u.id === seller.user_id) || (seller.email ? (users || []).find((u) => u && u.email === seller.email) : undefined);

                          return (
                            <ContactCard
                              key={index}
                              title={`Seller${sellers.length > 1 ? ` ${index + 1}` : ''}`}
                              name={seller.name}
                              phone={seller.phone}
                              email={seller.email}
                              onMessage={seller.email || seller.phone ? () => handleMessageContact({
                                id: sellerUser?.id || `external_${seller.email}`,
                                full_name: seller.name,
                                email: seller.email,
                                phone: seller.phone,
                                role: `Seller${sellers.length > 1 ? ` ${index + 1}` : ''}`,
                                isUser: !!sellerUser
                              }) : undefined}
                              onEmail={seller.email ? () => handleSendEmail(seller.email) : undefined}
                              onSMS={seller.phone ? () => handleSendSMS(seller.phone, sellerUser?.id) : undefined}
                              onEdit={canEdit ? () => handleEditSeller(seller, index) : undefined} />);


                        })}

                        {(!sellers || sellers.length === 0) &&
                        <Card className="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-400 transition-colors">
                            <p className="text-xs font-bold uppercase text-slate-500 mb-2">Seller</p>
                            <p className="text-sm font-semibold mb-3">Not added</p>
                            {canEdit &&
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={handleAddSeller}
                            className="w-full">

                                <Plus className="w-4 h-4 mr-2" />
                                Add
                              </Button>
                          }
                          </Card>
                        }

                        {buyer ?
                        <ContactCard
                          title="Buyer"
                          name={buyer.name}
                          phone={buyer.phone}
                          email={buyer.email}
                          onMessage={buyer.email || buyer.phone ? () => handleMessageContact({
                            id: buyer.id || `external_${buyer.email || buyer.name}`,
                            full_name: buyer.name,
                            email: buyer.email,
                            phone: buyer.phone,
                            role: 'Buyer',
                            isUser: !!buyer.id
                          }) : undefined}
                          onEmail={buyer.email ? () => handleSendEmail(buyer.email) : undefined}
                          onSMS={buyer.phone ? () => handleSendSMS(buyer.phone, buyer.id) : undefined}
                          onEdit={canEdit ? () => setShowEditModal(true) : undefined} /> :


                        <Card className="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-400 transition-colors">
                            <p className="text-xs font-bold uppercase text-slate-500 mb-2">Buyer</p>
                            <p className="text-sm font-semibold mb-3">Not added</p>
                            {canEdit &&
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => setShowEditModal(true)}
                            className="w-full">

                                <Plus className="w-4 h-4 mr-2" />
                                Add
                              </Button>
                          }
                          </Card>
                        }

                        {sellingAgent ?
                        <ContactCard
                          title="Selling Agent"
                          name={sellingAgent.name}
                          phone={sellingAgent.phone}
                          email={sellingAgent.email}
                          office={sellingAgent.office}
                          onMessage={sellingAgent.email || sellingAgent.phone ? () => handleMessageContact({
                            id: sellingAgent.id || `external_${sellingAgent.email || sellingAgent.name}`,
                            full_name: sellingAgent.name,
                            email: sellingAgent.email,
                            phone: sellingAgent.phone,
                            role: 'Selling Agent',
                            isUser: !!sellingAgent.id
                          }) : undefined}
                          onEmail={sellingAgent.email ? () => handleSendEmail(sellingAgent.email) : undefined}
                          onSMS={sellingAgent.phone ? () => handleSendSMS(sellingAgent.phone, sellingAgent.id) : undefined}
                          onEdit={canEdit ? () => setShowSellingAgentModal(true) : undefined} /> :


                        <Card className="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-400 transition-colors">
                            <p className="text-xs font-bold uppercase text-slate-500 mb-2">Selling Agent</p>
                            <p className="text-sm font-semibold mb-3">Not assigned</p>
                            {canEdit &&
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => setShowSellingAgentModal(true)}
                            className="w-full">

                                <Plus className="w-4 h-4 mr-2" />
                                Add
                              </Button>
                          }
                          </Card>
                        }

                        {property.title_company ? (() => {
                          const taskStatus = getContactTaskStatus('title');

                          return (
                            <ContactCard
                              title="Title Company"
                              name={titleContact?.name || property.title_company}
                              company={property.title_company}
                              phone={titleContact?.phone}
                              email={titleContact?.email}
                              taskStatus={taskStatus}
                              aiReview={aiReviews.title}
                              loadingAIReview={loadingAIReviews.title}
                              onTaskClick={handleTaskWarningClick}
                              onMessage={titleContact?.email || titleContact?.phone ? () => handleMessageContact({
                                id: `external_${titleContact?.email || property.title_company}`,
                                full_name: titleContact?.name || property.title_company,
                                email: titleContact?.email,
                                phone: titleContact?.phone,
                                role: 'Title Company',
                                isUser: false
                              }) : undefined}
                              onEdit={canEdit ? () => {
                                setEditingServiceProvider('title');
                                setShowServiceProviderModal(true);
                              } : undefined}
                              onEmail={titleContact?.email ? () => handleSendEmail(titleContact.email) : undefined}
                              onSMS={titleContact?.phone ? () => handleSendSMS(titleContact.phone) : undefined} />);


                        })() :
                        <Card className="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-400 transition-colors">
                            <p className="text-xs font-bold uppercase text-slate-500 mb-2">Title Company</p>
                            <p className="text-sm font-semibold mb-3">Not assigned</p>
                            {canEdit &&
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => {
                              setEditingServiceProvider('title');
                              setShowServiceProviderModal(true);
                            }}
                            className="w-full">

                                <Plus className="w-4 h-4 mr-2" />
                                Add
                              </Button>
                          }
                          </Card>
                        }

                        {property.mortgage_company ? (() => {
                          const taskStatus = getContactTaskStatus('mortgage');

                          return (
                            <ContactCard
                              title="Mortgage Company"
                              name={mortgageContact?.name || property.mortgage_company}
                              company={property.mortgage_company}
                              phone={mortgageContact?.phone}
                              email={mortgageContact?.email}
                              taskStatus={taskStatus}
                              aiReview={aiReviews.mortgage}
                              loadingAIReview={loadingAIReviews.mortgage}
                              onTaskClick={handleTaskWarningClick}
                              onMessage={mortgageContact?.email || mortgageContact?.phone ? () => handleMessageContact({
                                id: `external_${mortgageContact?.email || property.mortgage_company}`,
                                full_name: mortgageContact?.name || property.mortgage_company,
                                email: mortgageContact?.email,
                                phone: mortgageContact?.phone,
                                role: 'Mortgage Company',
                                isUser: false
                              }) : undefined}
                              onEdit={canEdit ? () => {
                                setEditingServiceProvider('mortgage');
                                setShowServiceProviderModal(true);
                              } : undefined}
                              onEmail={mortgageContact?.email ? () => handleSendEmail(mortgageContact.email) : undefined}
                              onSMS={mortgageContact?.phone ? () => handleSendSMS(mortgageContact.phone) : undefined} />);


                        })() :
                        <Card className="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-400 transition-colors">
                            <p className="text-xs font-bold uppercase text-slate-500 mb-2">Mortgage Company</p>
                            <p className="text-sm font-semibold mb-3">Not assigned</p>
                            {canEdit &&
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => {
                              setEditingServiceProvider('mortgage');
                              setShowServiceProviderModal(true);
                            }}
                            className="w-full">

                                <Plus className="w-4 h-4 mr-2" />
                                Add
                              </Button>
                          }
                          </Card>
                        }

                        {property.inspection_company ? (() => {
                          const taskStatus = getContactTaskStatus('inspection');

                          return (
                            <ContactCard
                              title="Inspection Company"
                              name={inspectionContact?.name || property.inspection_company}
                              company={property.inspection_company}
                              phone={inspectionContact?.phone}
                              email={inspectionContact?.email}
                              taskStatus={taskStatus}
                              aiReview={aiReviews.inspection}
                              loadingAIReview={loadingAIReviews.inspection}
                              onTaskClick={handleTaskWarningClick}
                              onMessage={inspectionContact?.email || inspectionContact?.phone ? () => handleMessageContact({
                                id: `external_${inspectionContact?.email || property.inspection_company}`,
                                full_name: inspectionContact?.name || property.inspection_company,
                                email: inspectionContact?.email,
                                phone: inspectionContact?.phone,
                                role: 'Inspection Company',
                                isUser: false
                              }) : undefined}
                              onEdit={canEdit ? () => {
                                setEditingServiceProvider('inspection');
                                setShowServiceProviderModal(true);
                              } : undefined}
                              onEmail={inspectionContact?.email ? () => handleSendEmail(inspectionContact.email) : undefined}
                              onSMS={inspectionContact?.phone ? () => handleSendSMS(inspectionContact.phone) : undefined} />);


                        })() :
                        <Card className="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-400 transition-colors">
                            <p className="text-xs font-bold uppercase text-slate-500 mb-2">Inspection Company</p>
                            <p className="text-sm font-semibold mb-3">Not assigned</p>
                            {canEdit &&
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => {
                              setEditingServiceProvider('inspection');
                              setShowServiceProviderModal(true);
                            }}
                            className="w-full">

                                <Plus className="w-4 h-4 mr-2" />
                                Add
                              </Button>
                          }
                          </Card>
                        }
                      </div>
                    </CardContent>
                  </Card>
                </TabsContent>

                <TabsContent value="tasks" className="pt-6" id="tasks-section">
                  {Array.isArray(tasks) && tasks.length > 0 ?
                  <Tabs defaultValue="listing" className="w-full">
                      <TabsList className="grid w-full grid-cols-2 mb-4">
                        <TabsTrigger value="listing">
                          <span className="font-semibold text-blue-600 dark:text-blue-400">Listing Package</span>
                          <Badge className="ml-2">{tasks.filter((t) => t && t.task_type && typeof t.task_type === 'string' && ['listing', 'marketing', 'documentation', 'inspection'].includes(t.task_type)).length}</Badge>
                        </TabsTrigger>
                        <TabsTrigger value="contract">
                          <span className="font-semibold text-red-600 dark:text-red-400">Under Contract</span>
                          <Badge className="ml-2">{tasks.filter((t) => t && t.task_type && typeof t.task_type === 'string' && ['contract', 'financing', 'closing'].includes(t.task_type)).length}</Badge>
                        </TabsTrigger>
                      </TabsList>

                      <TabsContent value="listing">
                        <DragDropContext onDragEnd={handleTaskDragEnd}>
                          <TaskKanbanBoard
                          tasks={tasks.filter((t) => t && t.task_type && typeof t.task_type === 'string' && ['listing', 'marketing', 'documentation', 'inspection'].includes(t.task_type))}
                          users={users}
                          properties={[property]}
                          onEditTask={canEdit ? handleEditTask : undefined}
                          highlightedTaskIds={highlightedTaskIds}
                          taskFilter={taskFilter} />

                        </DragDropContext>
                      </TabsContent>

                      <TabsContent value="contract">
                        <DragDropContext onDragEnd={handleTaskDragEnd}>
                          <TaskKanbanBoard
                          tasks={tasks.filter((t) => t && t.task_type && typeof t.task_type === 'string' && ['contract', 'financing', 'closing'].includes(t.task_type))}
                          users={users}
                          properties={[property]}
                          onEditTask={canEdit ? handleEditTask : undefined}
                          highlightedTaskIds={highlightedTaskIds}
                          taskFilter={taskFilter} />

                        </DragDropContext>
                      </TabsContent>
                    </Tabs> :

                  <Card className="p-12 text-center">
                      <CheckCircle2 className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                      <h3 className="text-lg font-semibold mb-2">No tasks yet</h3>
                      <p className="text-slate-500 mb-4">Create your first task to get started</p>
                      {canEdit &&
                    <Button onClick={() => setShowTaskModal(true)}>
                          <Plus className="w-4 h-4 mr-2" />
                          Add First Task
                        </Button>
                    }
                    </Card>
                  }
                </TabsContent>

                <TabsContent value="transactions" className="pt-6">
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {Array.isArray(transactions) && transactions.map((t) => t &&
                    <TransactionCard
                      key={t.id}
                      transaction={t}
                      property={property}
                      onEdit={canEdit ? () => handleEditTransaction(t) : undefined}
                      onDelete={canEdit ? () => handleDeleteTransaction(t.id) : undefined} />

                    )}
                  </div>
                  {(!transactions || !Array.isArray(transactions) || transactions.length === 0) &&
                  <Card className="p-12 text-center">
                     <DollarSign className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                     <h3 className="text-lg font-semibold mb-2">No transactions yet</h3>
                     <p className="text-slate-500 mb-4">Create your first transaction to get started</p>
                     {canEdit &&
                    <Button onClick={() => {
                      setEditingTransaction({
                        property_id: property.id,
                        contract_price: property.price,
                        commission_listing: property.listing_side_commission || 3,
                        commission_selling: property.selling_side_commission || 3,
                        agent_split_percentage: property.agent_split_percentage || 50,
                        sellers_info: property.sellers_info,
                        buyers_info: property.buyer_name ? JSON.stringify([{
                          name: property.buyer_name,
                          email: property.buyer_email,
                          phone: property.buyer_phone
                        }]) : null,
                        roles: {
                          listing_agent_id: property.listing_agent_id
                        },
                        selling_agent_name: property.selling_agent_name,
                        selling_agent_email: property.selling_agent_email,
                        selling_agent_phone: property.selling_agent_phone,
                        selling_agent_office: property.selling_agent_office
                      });
                      setShowTransactionModal(true);
                    }}>
                         <Plus className="w-4 h-4 mr-2" />
                         Add First Transaction
                       </Button>
                    }
                    </Card>
                  }
                </TabsContent>

                <TabsContent value="documents" className="ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                  {selectedDocuments.length > 0 &&
                  <div className="mb-4 bg-indigo-50 border border-indigo-200 rounded-lg p-4 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <Checkbox
                        checked={selectedDocuments.length === filteredDocuments.length && filteredDocuments.length > 0}
                        onCheckedChange={selectAllFilteredDocuments}
                        className="data-[state=checked]:bg-indigo-600 data-[state=checked]:border-indigo-600" />

                        <span className="text-sm font-medium text-indigo-900">
                          {selectedDocuments.length} document(s) selected
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        <DropdownMenu>
                          <DropdownMenuTrigger asChild>
                            <Button size="sm" className="bg-indigo-600 hover:bg-indigo-700">
                              <ArrowRight className="w-4 h-4 mr-2" />
                              Move Selected To
                            </Button>
                          </DropdownMenuTrigger>
                          <DropdownMenuContent align="end">
                            <div className="px-2 py-1.5 text-xs font-semibold text-blue-600">Listing Package</div>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('disclosure')}>
                              Disclosure
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('marketing')}>
                              Marketing Material
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('listing_agreement')}>
                              Listing Agreement
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('property_info')}>
                              Property Information
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('appraisal')}>
                              Appraisal
                            </DropdownMenuItem>
                            <DropdownMenuSeparator />
                            <div className="px-2 py-1.5 text-xs font-semibold text-purple-600">Under Contract</div>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('contract')}>
                              Purchase Contract
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('offer')}>
                              Offer
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('inspection')}>
                              Inspection Report
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('addendum')}>
                              Addendum
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('amendment')}>
                              Amendment
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('closing')}>
                              Closing Document
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('financing')}>
                              Financing Document
                            </DropdownMenuItem>
                            <DropdownMenuItem onClick={() => handleBulkUpdateCategory('title')}>
                              Title Document
                            </DropdownMenuItem>
                          </DropdownMenuContent>
                        </DropdownMenu>
                        <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setSelectedDocuments([])}>

                          Clear Selection
                        </Button>
                      </div>
                    </div>
                  }

                  <div className="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <div className="flex items-center gap-2 flex-wrap">
                      <Button
                        variant={documentTypeFilter === 'all' ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => setDocumentTypeFilter('all')}
                        className={documentTypeFilter === 'all' ? 'bg-slate-800 text-white hover:bg-slate-700' : 'border-slate-300 dark:border-slate-700'}>

                        All Documents
                        {documents.length > 0 &&
                        <Badge className="ml-2 bg-slate-700">{documents.length}</Badge>
                        }
                      </Button>
                      <Button
                        variant={documentTypeFilter === 'listing' ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => setDocumentTypeFilter('listing')}
                        className={documentTypeFilter === 'listing' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'border-blue-300 dark:border-blue-700'}>

                        <FileText className="w-4 h-4 mr-2" />
                        Listing Package
                        {listingDocsCount > 0 &&
                        <Badge className="ml-2 bg-blue-700">{listingDocsCount}</Badge>
                        }
                      </Button>
                      <Button
                        variant={documentTypeFilter === 'contract' ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => setDocumentTypeFilter('contract')}
                        className={documentTypeFilter === 'contract' ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'border-purple-300 dark:border-purple-700'}>

                        <FileText className="w-4 h-4 mr-2" />
                        Under Contract
                        {contractDocsCount > 0 &&
                        <Badge className="ml-2 bg-purple-700">{contractDocsCount}</Badge>
                        }
                      </Button>
                    </div>

                    <div className="flex items-center gap-2">
                      {canEdit &&
                      <DropdownMenu>
                          <DropdownMenuTrigger asChild>
                            <Button size="sm" className="bg-indigo-600 hover:bg-indigo-700">
                              <Plus className="w-4 h-4 mr-2" />
                              Upload Document
                            </Button>
                          </DropdownMenuTrigger>
                          <DropdownMenuContent align="end">
                            <DropdownMenuItem
                            onClick={() => {
                              setDocumentUploadType('listing');
                              setShowDocumentModal(true);
                            }}>

                              <FileText className="w-4 h-4 mr-2 text-blue-600" />
                              <div>
                                <div className="font-semibold">Listing Documents</div>
                                <div className="text-xs text-slate-500">Disclosures, marketing materials, etc.</div>
                              </div>
                            </DropdownMenuItem>
                            <DropdownMenuSeparator />
                            <DropdownMenuItem
                            onClick={() => {
                              setDocumentUploadType('contract');
                              setShowDocumentModal(true);
                            }}>

                              <FileText className="w-4 h-4 mr-2 text-purple-600" />
                              <div>
                                <div className="font-semibold">Under Contract Documents</div>
                                <div className="text-xs text-slate-500">Contracts, inspection reports, etc.</div>
                              </div>
                            </DropdownMenuItem>
                          </DropdownMenuContent>
                        </DropdownMenu>
                      }
                    </div>
                  </div>

                  {filteredDocuments.length === 0 ?
                  <Card>
                      <CardContent className="p-12 text-center">
                        <FileText className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                        <h3 className="text-lg font-medium text-slate-900 mb-2">No documents in this category</h3>
                        <p className="text-slate-600 mb-4">
                          {documentTypeFilter === 'all' ? 'Upload your first document to get started' : `No ${documentTypeFilter === 'listing' ? 'listing' : 'contract'} documents yet`}
                        </p>
                        {canEdit &&
                      <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                              <Button>
                                <Plus className="w-4 h-4 mr-2" />
                                Upload Document
                              </Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="center">
                              <DropdownMenuItem onClick={() => {
                            setDocumentUploadType('listing');
                            setShowDocumentModal(true);
                          }}>
                                <FileText className="w-4 h-4 mr-2 text-blue-600" />
                                Listing Documents
                              </DropdownMenuItem>
                              <DropdownMenuSeparator />
                              <DropdownMenuItem onClick={() => {
                            setDocumentUploadType('contract');
                            setShowDocumentModal(true);
                          }}>
                                <FileText className="w-4 h-4 mr-2 text-purple-600" />
                                Under Contract Documents
                              </DropdownMenuItem>
                            </DropdownMenuContent>
                          </DropdownMenu>
                      }
                      </CardContent>
                    </Card> :

                  <DocumentList
                    documents={filteredDocuments}
                    transactions={transactions}
                    properties={[property]}
                    users={users}
                    currentUser={currentUser}
                    selectedDocuments={selectedDocuments}
                    onToggleSelect={toggleDocumentSelection}
                    onUpdateCategory={handleUpdateDocumentCategory}
                    onDelete={handleDeleteDocument}
                    onPreview={handlePreviewDocument}
                    onStatusChange={handleDocumentStatusChange} />

                  }
                </TabsContent>

                <TabsContent value="photos" className="pt-6">
                  {Array.isArray(photos) && photos.length > 0 || property.primary_photo_url ?
                  <div className="space-y-6">
                      <PropertyImageGallery
                      photos={photos}
                      primaryPhotoUrl={property.primary_photo_url} />

                      
                      <Card>
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2">
                            <ImageIcon className="w-5 h-5" />
                            All Photos
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <PhotoGallery
                          photos={photos}
                          properties={[property]}
                          viewMode="grid" />

                        </CardContent>
                      </Card>
                    </div> :

                  <Card className="p-12 text-center">
                      <ImageIcon className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                      <h3 className="text-lg font-semibold mb-2">No photos yet</h3>
                      <p className="text-slate-500 mb-4">Upload your first photo to get started</p>
                      {canEdit &&
                    <Button onClick={() => setShowPhotoUpload(true)}>
                          <Plus className="w-4 h-4 mr-2" />
                          Upload First Photo
                        </Button>
                    }
                    </Card>
                  }
                </TabsContent>

                <TabsContent value="deal_room" className="pt-6">
                  <Card className="mb-6 border-2 border-indigo-200 dark:border-indigo-800 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
                    <CardContent className="p-6">
                      <div className="flex items-start gap-4">
                        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                          <Shield className="w-6 h-6 text-white" />
                        </div>
                        <div>
                          <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-1">Secure Deal Room</h3>
                          <p className="text-sm text-slate-600 dark:text-slate-400">
                            Share documents and tasks with clients, track progress, and communicate securely in one central hub
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  <div className="grid grid-cols-1 gap-6">
                    {transactions.find((t) => t.status === 'active' || t.status === 'pending') &&
                    <TransactionTimeline transaction={transactions.find((t) => t.status === 'active' || t.status === 'pending')} />
                    }

                    <ClientPortalTab
                      property={property}
                      sellers={sellers}
                      buyer={buyer}
                      documents={documents}
                      currentUser={currentUser}
                      users={users}
                      onAccessCreated={async () => {
                        const urlParams = new URLSearchParams(window.location.search);
                        const propertyId = urlParams.get('id') || id;
                        await loadData(propertyId);
                      }} />


                    <Card className="shadow-lg border-2 border-cyan-200 dark:border-cyan-800">
                      <CardHeader className="bg-gradient-to-r from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20">
                        <CardTitle className="flex items-center gap-2">
                          <MessageSquare className="w-5 h-5 text-cyan-600" />
                          Communication Hub
                        </CardTitle>
                      </CardHeader>
                      <CardContent className="pt-6">
                        <PropertyMessaging
                          property={property}
                          currentUser={currentUser}
                          users={users}
                          teamMembers={teamMembers}
                          listingAgent={getListingAgent()}
                          sellingAgent={getSellingAgent()}
                          buyer={getBuyer()}
                          sellers={getSellers()}
                          initialRecipient={preSelectedRecipient}
                          onRecipientChange={() => setPreSelectedRecipient(null)} />

                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>

                <TabsContent value="ai_insights" className="space-y-6">
                  {/* Enrich Data Button */}
                  <Card>
                    <CardContent className="p-6">
                      <div className="flex items-center justify-between">
                        <div>
                          <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-1">
                            Real Estate Data Intelligence
                          </h3>
                          <p className="text-sm text-slate-600 dark:text-slate-400">
                            Get market trends, comparable sales, school ratings, demographics and more
                          </p>
                        </div>
                        <Button
                          onClick={handleEnrichPropertyData}
                          disabled={loadingEnrichedData}
                          className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700">

                          {loadingEnrichedData ?
                          <>
                              <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2" />
                              Loading...
                            </> :

                          <>
                              <TrendingUp className="w-4 h-4 mr-2" />
                              {enrichedData ? 'Refresh Data' : 'Get Market Data'}
                            </>
                          }
                        </Button>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Enriched Data Display */}
                  {enrichedData &&
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <MarketTrendsCard marketTrends={enrichedData.market_trends} />
                      <DemographicsCard demographics={enrichedData.demographics} />
                      <ComparableSalesCard comparables={enrichedData.comparable_sales} />
                      <SchoolRatingsCard schools={enrichedData.schools} />
                      <PropertyHistoryCard history={enrichedData.property_history} />
                      
                      {/* Market Statistics Card */}
                      {enrichedData.market_statistics &&
                    <Card>
                          <CardHeader>
                            <CardTitle className="flex items-center gap-2">
                              <TrendingUp className="w-5 h-5" />
                              Market Statistics
                            </CardTitle>
                          </CardHeader>
                          <CardContent className="space-y-3">
                            <div className="flex items-center justify-between">
                              <span className="text-sm text-slate-600 dark:text-slate-400">Median Home Price</span>
                              <span className="font-semibold">${enrichedData.market_statistics.median_home_price?.toLocaleString()}</span>
                            </div>
                            <div className="flex items-center justify-between">
                              <span className="text-sm text-slate-600 dark:text-slate-400">Price per Sqft</span>
                              <span className="font-semibold">${enrichedData.market_statistics.median_price_per_sqft}</span>
                            </div>
                            <div className="flex items-center justify-between">
                              <span className="text-sm text-slate-600 dark:text-slate-400">Inventory Level</span>
                              <Badge className={
                          enrichedData.market_statistics.inventory_level === 'low' ? 'bg-red-100 text-red-800' :
                          enrichedData.market_statistics.inventory_level === 'high' ? 'bg-green-100 text-green-800' :
                          'bg-blue-100 text-blue-800'
                          }>
                                {enrichedData.market_statistics.inventory_level?.toUpperCase()}
                              </Badge>
                            </div>
                            <div className="flex items-center justify-between">
                              <span className="text-sm text-slate-600 dark:text-slate-400">Months of Supply</span>
                              <span className="font-semibold">{enrichedData.market_statistics.months_of_supply} months</span>
                            </div>
                          </CardContent>
                        </Card>
                    }
                    </div>
                  }

                  {/* Original AI Property Insights */}
                  <AIPropertyInsights
                    property={property}
                    allProperties={allProperties} />

                </TabsContent>

                <TabsContent value="marketing" className="space-y-6">
                  <AIMarketingAssistant property={property} />
                </TabsContent>

                <TabsContent value="valuation" className="space-y-6">
                  <AttomDataViewer property={property} />
                  
                  <PropertyValuation
                    property={property}
                    properties={allProperties}
                    tasks={tasks} />

                </TabsContent>

                <TabsContent value="ai_advice" className="pt-6">
                  <PropertyAdviceCard property={property} />
                </TabsContent>

                <TabsContent value="feedback" className="pt-6">
                  <PropertyFeedbackInsights property={property} />
                </TabsContent>
              </div>
            </Tabs>
          </div>
        </CardContent>
      </Card>

      {showEditModal &&
      <PropertyEditModal
        property={property}
        users={users}
        onSave={handleSaveProperty}
        onClose={() => setShowEditModal(false)} />

      }

      {showTransactionModal &&
      <TransactionModal
        transaction={editingTransaction}
        properties={property ? [property] : []}
        users={users}
        onSave={handleSaveTransaction}
        onClose={() => {
          console.log('üîò Transaction modal closed');
          setShowTransactionModal(false);
          setEditingTransaction(null);
        }} />

      }

      {showTaskModal &&
      <TaskModal
        task={editingTask}
        users={users}
        properties={property ? [property] : []}
        onSave={handleSaveTask}
        onClose={() => {
          setShowTaskModal(false);
          setEditingTask(null);
        }} />

      }

      {showDocumentModal &&
      <DocumentUploadModal
        transactions={transactions || []}
        properties={allProperties || []}
        documentType={documentUploadType}
        onUpload={handleUploadDocument}
        onClose={() => {
          setShowDocumentModal(false);
          setDocumentUploadType(null);
        }} />

      }

      {showPhotoUpload &&
      <PhotoUpload
        properties={property ? [property] : []}
        onUpload={handleUploadPhotos}
        onClose={() => setShowPhotoUpload(false)} />

      }

      {showServiceProviderModal &&
      <ServiceProviderModal
        type={editingServiceProvider}
        currentData={{
          company_name: editingServiceProvider === 'title' ? property.title_company :
          editingServiceProvider === 'mortgage' ? property.mortgage_company :
          property.inspection_company,
          contact_name: editingServiceProvider === 'title' ? titleContact?.name :
          editingServiceProvider === 'mortgage' ? mortgageContact?.name :
          inspectionContact?.name,
          phone: editingServiceProvider === 'title' ? titleContact?.phone :
          editingServiceProvider === 'mortgage' ? mortgageContact?.phone :
          inspectionContact?.phone,
          email: editingServiceProvider === 'title' ? titleContact?.email :
          editingServiceProvider === 'mortgage' ? mortgageContact?.email :
          inspectionContact?.email
        }}
        onSave={handleSaveServiceProvider}
        onClose={() => {
          setShowServiceProviderModal(false);
          setEditingServiceProvider(null);
        }} />

      }

      {showSellerModal &&
      <SellerModal
        seller={editingSeller ? editingSeller.seller : null}
        onSave={handleSaveSeller}
        onClose={() => {
          setShowSellerModal(false);
          setEditingSeller(null);
        }} />

      }

      {showSellingAgentModal &&
      <SellingAgentModal
        currentData={sellingAgent ? {
          name: sellingAgent.name,
          email: sellingAgent.email,
          phone: sellingAgent.phone,
          office: sellingAgent.office
        } : null}
        onSave={handleSaveSellingAgent}
        onClose={() => setShowSellingAgentModal(false)} />

      }

      <CelebrationModal
        isOpen={showCelebration}
        onClose={() => setShowCelebration(false)}
        celebrationType={celebrationType}
        details={celebrationDetails} />


      {previewDocument &&
      <DocumentPreviewModal
        document={previewDocument}
        onClose={() => setPreviewDocument(null)}
        onApprove={() => {
          handleDocumentStatusChange(previewDocument.id, 'approved');
          setPreviewDocument(null);
        }}
        onReject={() => {
          handleDocumentStatusChange(previewDocument.id, 'archived');
          setPreviewDocument(null);
        }} />

      }
    </div>);

}

function ClientPortalTab({ property, sellers, buyer, documents, currentUser, users, onAccessCreated }) {
  const [selectedSellerEmails, setSelectedSellerEmails] = useState([]);
  const [selectedSellerDocuments, setSelectedSellerDocuments] = useState([]);
  const [selectedBuyerDocuments, setSelectedBuyerDocuments] = useState([]);
  const [isCreatingSeller, setIsCreatingSeller] = useState(false);
  const [isCreatingBuyer, setIsCreatingBuyer] = useState(false);
  const [existingAccess, setExistingAccess] = useState([]);
  const [showSharedDocsForSeller, setShowSharedDocsForSeller] = useState(false);
  const [showSharedDocsForBuyer, setShowSharedDocsForBuyer] = useState(false);
  const [showSharedTasksForSeller, setShowSharedTasksForSeller] = useState(false);
  const [showSharedTasksForBuyer, setShowSharedTasksForBuyer] = useState(false);
  const [includeBuyer, setIncludeBuyer] = useState(false);
  const [tasks, setTasks] = useState([]);

  const listingCategories = ['disclosure', 'marketing', 'listing_agreement', 'property_info', 'appraisal'];
  const contractCategories = ['contract', 'offer', 'inspection', 'addendum', 'amendment', 'closing', 'financing', 'title'];

  useEffect(() => {
    if (property?.id) {
      loadExistingAccess();
      loadTasks();
    }
  }, [property]);

  const loadTasks = async () => {
    try {
      const allTasks = await base44.entities.Task.filter({ property_id: property.id });
      setTasks(allTasks || []);
    } catch (error) {
      console.warn("Error loading tasks:", error.message);
      setTasks([]);
    }
  };

  const loadExistingAccess = async () => {
    try {
      const allAccess = await base44.entities.ClientPortalAccess.list();
      const propertyAccess = (allAccess || []).filter((a) => a && a.property_id === property.id);
      setExistingAccess(propertyAccess);
    } catch (error) {
      console.warn("Error loading existing access:", error.message);
      setExistingAccess([]);
    }
  };

  const getListingTasks = () => {
    const listingSideTypes = ['listing', 'marketing', 'documentation', 'inspection'];
    return tasks.filter((t) => t && t.task_type && typeof t.task_type === 'string' && listingSideTypes.includes(t.task_type) && t.status !== 'cancelled');
  };

  const getUnderContractTasks = () => {
    const contractSideTypes = ['contract', 'financing', 'closing'];
    return tasks.filter((t) => t && t.task_type && typeof t.task_type === 'string' && contractSideTypes.includes(t.task_type) && t.status !== 'cancelled');
  };

  const sharedDocIds = useMemo(() => {
    const shared = new Set();
    existingAccess.forEach((access) => {
      if (access && access.document_access) {
        if (Array.isArray(access.document_access)) {
          access.document_access.forEach((docId) => shared.add(docId));
        } else if (typeof access.document_access === 'string' && access.document_access) {
          try {
            const parsed = JSON.parse(access.document_access);
            if (Array.isArray(parsed)) {
              parsed.forEach((docId) => shared.add(docId));
            }
          } catch (e) {
            console.warn('Could not parse document_access:', access.document_access);
          }
        }
      }
    });
    return Array.from(shared);
  }, [existingAccess]);

  const allDocumentsNotYetShared = useMemo(() => {
    return documents.filter((doc) =>
    doc && doc.property_id === property.id &&
    !sharedDocIds.includes(doc.id)
    );
  }, [documents, property.id, sharedDocIds]);

  const availableSellerDocuments = useMemo(() => {
    return allDocumentsNotYetShared.filter((doc) => doc && doc.category && listingCategories.includes(doc.category));
  }, [allDocumentsNotYetShared, listingCategories]);

  const availableBuyerDocuments = useMemo(() => {
    return allDocumentsNotYetShared.filter((doc) => doc && doc.category && contractCategories.includes(doc.category));
  }, [allDocumentsNotYetShared, contractCategories]);

  const sharedDocuments = useMemo(() => {
    return documents.filter((doc) => doc && sharedDocIds.includes(doc.id));
  }, [documents, sharedDocIds]);

  const hasAccessForThisSeller = (email) => {
    if (!email) return false;
    const user = users.find((u) => u && u.email === email);
    if (!user) return false;

    return existingAccess.some((a) =>
    a && a.client_user_id === user.id &&
    a.property_id === property.id &&
    a.access_type === 'seller' &&
    a.is_active
    );
  };

  const hasAccessForBuyer = () => {
    if (!buyer || !buyer.email) return false;

    const user = users.find((u) => u && u.email === buyer.email);
    if (!user) return false;

    return existingAccess.some((a) =>
    a && a.client_user_id === user.id &&
    a.property_id === property.id &&
    a.access_type === 'buyer' &&
    a.is_active
    );
  };

  const isRecipientSelected = (email) => {
    return selectedSellerEmails.includes(email);
  };

  const toggleSellerEmail = (email) => {
    setSelectedSellerEmails((prev) =>
    prev.includes(email) ? prev.filter((e) => e !== email) : [...prev, email]
    );
  };

  const toggleSellerDocument = (docId) => {
    setSelectedSellerDocuments((prev) =>
    prev.includes(docId) ? prev.filter((id_val) => id_val !== docId) : [...prev, docId]
    );
  };

  const toggleBuyerDocument = (docId) => {
    setSelectedBuyerDocuments((prev) =>
    prev.includes(docId) ? prev.filter((id_val) => id_val !== docId) : [...prev, docId]
    );
  };

  const handleCreateAccess = async (type) => {
    const recipients = type === 'seller' ? selectedSellerEmails : includeBuyer && buyer?.email ? [buyer.email] : [];
    const selectedDocsToShare = type === 'seller' ? selectedSellerDocuments : selectedBuyerDocuments;
    const setIsCreating = type === 'seller' ? setIsCreatingSeller : setIsCreatingBuyer;

    if (!recipients || recipients.length === 0 || !recipients[0]) {
      toast.error("Please select at least one recipient");
      return;
    }

    setIsCreating(true);
    try {
      const allUsers = await base44.entities.User.list();

      let successCount = 0;
      let updateCount = 0;

      for (const email of recipients) {
        let clientUser = allUsers.find((u) => u && u.email === email);

        if (!clientUser) {
          toast.info(`User with email ${email} not found. They need to be invited to the platform first.`);
          continue;
        }

        const existing = existingAccess.find((a) =>
        a && a.client_user_id === clientUser.id &&
        a.property_id === property.id &&
        a.access_type === type
        );

        if (existing) {
          let existingDocsArray = [];
          if (Array.isArray(existing.document_access)) {
            existingDocsArray = existing.document_access;
          } else if (typeof existing.document_access === 'string' && existing.document_access) {
            try {
              existingDocsArray = JSON.parse(existing.document_access);
              if (!Array.isArray(existingDocsArray)) existingDocsArray = [];
            } catch (e) {
              existingDocsArray = [];
            }
          }

          const mergedDocs = [...new Set([...existingDocsArray, ...selectedDocsToShare])];

          await base44.entities.ClientPortalAccess.update(existing.id, {
            document_access: mergedDocs
          });

          updateCount++;
          continue;
        }

        const accessData = {
          client_user_id: clientUser.id,
          agent_id: currentUser.id,
          access_type: type,
          property_id: property.id,
          is_active: true,
          document_access: selectedDocsToShare.length > 0 ? selectedDocsToShare : [],
          preferences: {}
        };

        await base44.entities.ClientPortalAccess.create(accessData);
        successCount++;
      }

      if (successCount > 0) {
        toast.success(`${type === 'seller' ? 'Seller' : 'Buyer'} portal access granted to ${successCount} recipient(s)!`);
      }

      if (updateCount > 0) {
        toast.success(`Updated access for ${updateCount} recipient(s) with ${selectedDocsToShare.length} new document(s)!`);
      }

      if (type === 'seller') {
        setSelectedSellerEmails([]);
        setSelectedSellerDocuments([]);
      } else {
        setIncludeBuyer(false);
        setSelectedBuyerDocuments([]);
      }

      await new Promise((resolve) => setTimeout(resolve, 1000));
      await loadExistingAccess();

      if (onAccessCreated) {
        onAccessCreated();
      }

    } catch (error) {
      console.error("‚ùå Error creating portal access:", error);
      toast.error(`Failed to create portal access: ${error.message}`);
    }
    setIsCreating(false);
  };

  const handleRevokeAccess = async (accessId) => {
    if (!window.confirm("Are you sure you want to revoke this portal access?")) {
      return;
    }

    try {
      await base44.entities.ClientPortalAccess.delete(accessId);
      toast.success("Portal access revoked");
      await loadExistingAccess();
      if (onAccessCreated) onAccessCreated();
    } catch (error) {
      console.error("Error revoking access:", error);
      toast.error("Failed to revoke access");
    }
  };

  const isPropertyUnderContract = () => {
    return property?.status === 'pending' && buyer;
  };

  const buyerHasAccess = hasAccessForBuyer();
  const hasExistingSellerAccess = selectedSellerEmails.some((email) => hasAccessForThisSeller(email));

  const listingTasks = getListingTasks();
  const underContractTasks = getUnderContractTasks();

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <Card>
        <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
          <CardTitle className="flex items-center gap-2">
            <Users className="w-5 h-5 text-indigo-600" />
            Seller Portal Access
          </CardTitle>
        </CardHeader>
        <CardContent className="pt-6 space-y-4">
          {sellers && sellers.length > 0 ?
          <>
              <div className="space-y-2">
                <Label className="text-sm font-semibold">Select Sellers to Grant/Update Access:</Label>
                <div className="space-y-2">
                  {sellers.map((seller, index) => {
                  const accessGranted = hasAccessForThisSeller(seller.email);
                  return (
                    <div
                      key={index}
                      className={`flex items-start gap-3 p-3 rounded-lg border transition-colors
                        ${accessGranted ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:border-indigo-300 dark:hover:border-indigo-600'}`}>

                        <Checkbox
                        checked={isRecipientSelected(seller.email)}
                        onCheckedChange={() => toggleSellerEmail(seller.email)}
                        className={`mt-1 ${accessGranted ? 'data-[state=checked]:bg-green-600 data-[state=checked]:border-green-600' : 'data-[state=checked]:bg-indigo-600 data-[state=checked]:border-indigo-600'}`} />

                        <div className="flex-1">
                          <div className="font-semibold text-sm">
                            {seller.name}
                            {accessGranted && <span className="text-xs text-green-600 ml-2">(Has Access - Can Add More Docs)</span>}
                          </div>
                          <div className="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1 mt-1">
                            <Mail className="w-3 h-3" />
                            {seller.email}
                          </div>
                          {seller.phone &&
                        <div className="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1">
                              <Phone className="w-3 h-3" />
                              {seller.phone}
                            </div>
                        }
                          <Badge variant="outline" className="mt-1 text-xs">
                            Seller
                          </Badge>
                        </div>
                      </div>);

                })}
                </div>
                {selectedSellerEmails.length > 0 &&
              <p className="text-xs text-indigo-600 font-medium mt-2">
                    {selectedSellerEmails.length} seller(s) selected
                  </p>
              }
              </div>

              {listingTasks.length > 0 &&
            <div className="space-y-2">
                  <div
                className="flex items-center justify-between cursor-pointer p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg"
                onClick={() => setShowSharedTasksForSeller(!showSharedTasksForSeller)}>

                    <Label className="text-sm font-semibold flex items-center gap-2 cursor-pointer">
                      <CheckCircle2 className="w-4 h-4 text-blue-600" />
                      Shared Listing Tasks ({listingTasks.length})
                    </Label>
                    {showSharedTasksForSeller ?
                <ChevronUp className="w-4 h-4 text-slate-500" /> :

                <ChevronDown className="w-4 h-4 text-slate-500" />
                }
                  </div>
                  {showSharedTasksForSeller &&
              <div className="border rounded-lg p-3 bg-blue-50 dark:bg-blue-900/10 space-y-2 max-h-48 overflow-y-auto">
                      <p className="text-xs text-blue-700 dark:text-blue-400 mb-2">
                        Sellers can view these listing package tasks automatically
                      </p>
                      {listingTasks.map((task) =>
                <div
                  key={task.id}
                  className="flex items-center gap-2 p-2 bg-white dark:bg-slate-800 rounded">

                          <CheckCircle2 className={`w-4 h-4 flex-shrink-0 ${
                  task.status === 'completed' ? 'text-green-600' : 'text-blue-600'}`
                  } />
                          <div className="flex-1 min-w-0">
                            <span className={`text-sm block ${task.status === 'completed' ? 'line-through text-slate-500' : ''}`}>
                              {task.title}
                            </span>
                            <Badge variant="outline" className="text-xs mt-1 capitalize">
                              {task.task_type}
                            </Badge>
                          </div>
                        </div>
                )}
                    </div>
              }
                </div>
            }

              {sharedDocuments.length > 0 &&
            <div className="space-y-2">
                  <div
                className="flex items-center justify-between cursor-pointer p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg"
                onClick={() => setShowSharedDocsForSeller(!showSharedDocsForSeller)}>

                    <Label className="text-sm font-semibold flex items-center gap-2 cursor-pointer">
                      <CheckCircle2 className="w-4 h-4 text-green-600" />
                      Shared Documents ({sharedDocuments.length})
                    </Label>
                    {showSharedDocsForSeller ?
                <ChevronUp className="w-4 h-4 text-slate-500" /> :

                <ChevronDown className="w-4 h-4 text-slate-500" />
                }
                  </div>
                  {showSharedDocsForSeller &&
              <div className="border rounded-lg p-3 bg-green-50 dark:bg-green-900/10 space-y-2 max-h-48 overflow-y-auto">
                      {sharedDocuments.map((doc) =>
                <div
                  key={doc.id}
                  className="flex items-center gap-2 p-2 bg-white dark:bg-slate-800 rounded">

                          <CheckCircle2 className="w-4 h-4 text-green-600 flex-shrink-0" />
                          <div className="flex-1 min-w-0">
                            <span className="text-sm truncate block">{doc.document_name}</span>
                            <Badge variant="outline" className="text-xs mt-1">
                              {doc.category || 'General'}
                            </Badge>
                          </div>
                        </div>
                )}
                    </div>
              }
                </div>
            }

              <div className="space-y-2">
                <Label className="text-sm font-semibold">Select Listing Documents to Share with Sellers (Optional):</Label>
                {availableSellerDocuments.length > 0 ?
              <div className="border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2 bg-slate-50 dark:bg-slate-800">
                    {availableSellerDocuments.map((doc) =>
                <div
                  key={doc.id}
                  className="flex items-center gap-2 p-2 hover:bg-white dark:hover:bg-slate-700 rounded transition-colors">

                        <Checkbox
                    checked={selectedSellerDocuments.includes(doc.id)}
                    onCheckedChange={() => toggleSellerDocument(doc.id)}
                    className="data-[state=checked]:bg-indigo-600 data-[state=checked]:border-indigo-600" />

                        <div className="flex-1 min-w-0">
                          <span className="text-sm truncate block">{doc.document_name}</span>
                          <Badge variant="outline" className="text-xs mt-1">
                            {doc.category || 'General'}
                          </Badge>
                        </div>
                      </div>
                )}
                  </div> :

              <p className="text-sm text-slate-500 text-center py-4">
                    {allDocumentsNotYetShared.length > 0 && !availableSellerDocuments.length ?
                "No listing-related documents available to share." :
                "No documents available for this property."}
                  </p>
              }
                 {selectedSellerDocuments.length > 0 &&
              <p className="text-xs text-indigo-600 font-medium mt-2">
                    {selectedSellerDocuments.length} document(s) selected for sellers
                  </p>
              }
              </div>

              <Button
              onClick={() => handleCreateAccess('seller')}
              disabled={isCreatingSeller || selectedSellerEmails.length === 0}
              className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold py-6 text-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">

                {isCreatingSeller ?
              <div className="flex items-center gap-2">
                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                    <span>Processing...</span>
                  </div> :

              <div className="flex items-center gap-2">
                    <UserPlus className="w-5 h-5" />
                    <span>
                      {hasExistingSellerAccess ?
                  `Share ${selectedSellerDocuments.length} More Document(s) with Selected Sellers` :
                  `Grant Seller Portal Access (${selectedSellerEmails.length})`}
                    </span>
                  </div>
              }
              </Button>

              {existingAccess.filter((a) => a.access_type === 'seller').length > 0 &&
            <div className="mt-4 pt-4 border-t">
                  <Label className="text-sm font-semibold mb-2 block">Existing Seller Access:</Label>
                  <div className="space-y-2">
                    {existingAccess.filter((a) => a.access_type === 'seller').map((access) => {
                  const clientUser = users.find((u) => u.id === access.client_user_id);
                  return (
                    <div key={access.id} className="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                          <div className="flex items-center gap-2">
                            <CheckCircle2 className="w-4 h-4 text-green-600" />
                            <span className="text-sm font-medium">{clientUser?.full_name || clientUser?.email || 'Unknown User'}</span>
                          </div>
                          <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handleRevokeAccess(access.id)}
                        className="text-red-600 hover:text-red-700 hover:bg-red-50">

                            <X className="w-4 h-4" />
                          </Button>
                        </div>);

                })}
                  </div>
                </div>
            }
            </> :

          <div className="text-center py-8">
              <Users className="w-12 h-12 mx-auto mb-3 text-slate-300" />
              <p className="text-sm text-slate-500">No sellers added to this property yet</p>
              <p className="text-xs text-slate-400 mt-1">Add seller information in property details to enable access</p>
            </div>
          }
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20">
          <CardTitle className="flex items-center gap-2">
            <UserIcon className="w-5 h-5 text-emerald-600" />
            Buyer Portal Access
          </CardTitle>
        </CardHeader>
        <CardContent className="pt-6 space-y-4">
          {isPropertyUnderContract() && buyer ?
          <>
              <div className={`p-4 rounded-lg border ${
            buyerHasAccess ?
            'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' :
            'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800'}`
            }>
                <div className="flex items-start gap-3">
                  <Checkbox
                  checked={includeBuyer}
                  onCheckedChange={(checked) => setIncludeBuyer(checked)}
                  className={`mt-1 ${
                  buyerHasAccess ?
                  'data-[state=checked]:bg-green-600 data-[state=checked]:border-green-600' :
                  'data-[state=checked]:bg-emerald-600 data-[state=checked]:border-emerald-600'}`
                  } />

                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <CheckCircle2 className={`w-4 h-4 ${buyerHasAccess ? 'text-green-600' : 'text-emerald-600'}`} />
                      <span className="font-semibold text-sm">Property Under Contract with:</span>
                    </div>
                    <div className="space-y-1 text-sm">
                      <div className="font-semibold">
                        {buyer.name}
                        {buyerHasAccess && <span className="text-xs text-green-600 ml-2">(Has Access - Can Add More Docs)</span>}
                      </div>
                      <div className="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1">
                        <Mail className="w-3 h-3" />
                        {buyer.email}
                      </div>
                      {buyer.phone &&
                    <div className="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1">
                          <Phone className="w-3 h-3" />
                          {buyer.phone}
                        </div>
                    }
                      <Badge className={`mt-1 text-xs ${buyerHasAccess ? 'bg-green-600' : 'bg-emerald-600'}`}>
                        Buyer
                      </Badge>
                    </div>
                  </div>
                </div>
              </div>

              {underContractTasks.length > 0 &&
            <div className="space-y-2">
                  <div
                className="flex items-center justify-between cursor-pointer p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg"
                onClick={() => setShowSharedTasksForBuyer(!showSharedTasksForBuyer)}>

                    <Label className="text-sm font-semibold flex items-center gap-2 cursor-pointer">
                      <CheckCircle2 className="w-4 h-4 text-red-600" />
                      Shared Under Contract Tasks ({underContractTasks.length})
                    </Label>
                    {showSharedTasksForBuyer ?
                <ChevronUp className="w-4 h-4 text-slate-500" /> :

                <ChevronDown className="w-4 h-4 text-slate-500" />
                }
                  </div>
                  {showSharedTasksForBuyer &&
              <div className="border rounded-lg p-3 bg-red-50 dark:bg-red-900/10 space-y-2 max-h-48 overflow-y-auto">
                      <p className="text-xs text-red-700 dark:text-red-400 mb-2">
                        Buyer can view these under contract tasks automatically
                      </p>
                      {underContractTasks.map((task) =>
                <div
                  key={task.id}
                  className="flex items-center gap-2 p-2 bg-white dark:bg-slate-800 rounded">

                          <CheckCircle2 className={`w-4 h-4 flex-shrink-0 ${
                  task.status === 'completed' ? 'text-green-600' : 'text-red-600'}`
                  } />
                          <div className="flex-1 min-w-0">
                            <span className={`text-sm block ${task.status === 'completed' ? 'line-through text-slate-500' : ''}`}>
                              {task.title}
                            </span>
                            <Badge variant="outline" className="text-xs mt-1 capitalize">
                              {task.task_type}
                            </Badge>
                          </div>
                        </div>
                )}
                    </div>
              }
                </div>
            }

              {sharedDocuments.length > 0 &&
            <div className="space-y-2">
                  <div
                className="flex items-center justify-between cursor-pointer p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg"
                onClick={() => setShowSharedDocsForBuyer(!showSharedDocsForBuyer)}>

                    <Label className="text-sm font-semibold flex items-center gap-2 cursor-pointer">
                      <CheckCircle2 className="w-4 h-4 text-green-600" />
                      Shared Documents ({sharedDocuments.length})
                    </Label>
                    {showSharedDocsForBuyer ?
                <ChevronUp className="w-4 h-4 text-slate-500" /> :

                <ChevronDown className="w-4 h-4 text-slate-500" />
                }
                  </div>
                  {showSharedDocsForBuyer &&
              <div className="border rounded-lg p-3 bg-green-50 dark:bg-green-900/10 space-y-2 max-h-48 overflow-y-auto">
                      {sharedDocuments.map((doc) =>
                <div
                  key={doc.id}
                  className="flex items-center gap-2 p-2 bg-white dark:bg-slate-800 rounded">

                          <CheckCircle2 className="w-4 h-4 text-green-600 flex-shrink-0" />
                          <div className="flex-1 min-w-0">
                            <span className="text-sm truncate block">{doc.document_name}</span>
                            <Badge variant="outline" className="text-xs mt-1">
                              {doc.category || 'General'}
                            </Badge>
                          </div>
                        </div>
                )}
                    </div>
              }
                </div>
            }

              <div className="space-y-2">
                <Label className="text-sm font-semibold">Select Under Contract Documents to Share with Buyer (Optional):</Label>
                {availableBuyerDocuments.length > 0 ?
              <div className="border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2 bg-slate-50 dark:bg-slate-800">
                    {availableBuyerDocuments.map((doc) =>
                <div
                  key={doc.id}
                  className="flex items-center gap-2 p-2 hover:bg-white dark:hover:bg-slate-700 rounded transition-colors">

                        <Checkbox
                    checked={selectedBuyerDocuments.includes(doc.id)}
                    onCheckedChange={() => toggleBuyerDocument(doc.id)}
                    className="data-[state=checked]:bg-emerald-600 data-[state=checked]:border-emerald-600" />

                        <div className="flex-1 min-w-0">
                          <span className="text-sm truncate block">{doc.document_name}</span>
                          <Badge variant="outline" className="text-xs mt-1">
                            {doc.category || 'General'}
                          </Badge>
                        </div>
                      </div>
                )}
                  </div> :

              <p className="text-sm text-slate-500 text-center py-4">
                    {allDocumentsNotYetShared.length > 0 && !availableBuyerDocuments.length ?
                "No under contract documents available to share." :
                "No documents available for this property."}
                  </p>
              }
                {selectedBuyerDocuments.length > 0 &&
              <p className="text-xs text-emerald-600 font-medium mt-2">
                    {selectedBuyerDocuments.length} document(s) selected for buyer
                  </p>
              }
              </div>

              <Button
              onClick={() => handleCreateAccess('buyer')}
              disabled={isCreatingBuyer || !includeBuyer}
              className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-semibold py-6 text-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">

                {isCreatingBuyer ?
              <div className="flex items-center gap-2">
                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                    <span>Processing...</span>
                  </div> :

              <div className="flex items-center gap-2">
                    <UserPlus className="w-5 h-5" />
                    <span>
                      {buyerHasAccess ?
                  `Share ${selectedBuyerDocuments.length} More Document(s) with Buyer` :
                  'Grant Buyer Portal Access'}
                    </span>
                  </div>
              }
              </Button>

              {existingAccess.filter((a) => a.access_type === 'buyer').length > 0 &&
            <div className="mt-4 pt-4 border-t">
                  <Label className="text-sm font-semibold mb-2 block">Existing Buyer Access:</Label>
                  <div className="space-y-2">
                    {existingAccess.filter((a) => a.access_type === 'buyer').map((access) => {
                  const clientUser = users.find((u) => u.id === access.client_user_id);
                  return (
                    <div key={access.id} className="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                          <div className="flex items-center gap-2">
                            <CheckCircle2 className="w-4 h-4 text-green-600" />
                            <span className="text-sm font-medium">{clientUser?.full_name || clientUser?.email || 'Unknown User'}</span>
                          </div>
                          <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handleRevokeAccess(access.id)}
                        className="text-red-600 hover:text-red-700 hover:bg-red-50">

                            <X className="w-4 h-4" />
                          </Button>
                        </div>);

                })}
                  </div>
                </div>
            }
            </> :

          <div className="text-center py-8">
              <AlertCircle className="w-12 h-12 mx-auto mb-3 text-amber-300" />
              <p className="text-sm text-slate-500 font-semibold mb-1">Property Not Under Contract</p>
              <p className="text-xs text-slate-400 mt-1">Buyer portal access will be available once the property is under contract and buyer information is added.</p>
            </div>
          }
        </CardContent>
      </Card>
    </div>);

}
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { base44 } from '@/api/base44Client';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  ArrowLeft, 
  Lightbulb, 
  Mail, 
  Target, 
  TrendingUp, 
  Users,
  Share2,
  DollarSign,
  CheckCircle2,
  ArrowRight,
  Sparkles,
  Calendar,
  Star,
  Loader2,
  RefreshCw,
  Eye,
  EyeOff,
  Clock,
  Plus
} from "lucide-react";
import { formatDistanceToNow } from "date-fns";
import { toast } from "sonner";
import CreateTipModal from "../components/tips/CreateTipModal";

export default function RealtorTips() {
  const navigate = useNavigate();
  const [activeStrategy, setActiveStrategy] = useState(null);
  const [dailyTips, setDailyTips] = useState([]);
  const [isLoadingTips, setIsLoadingTips] = useState(true);
  const [isGenerating, setIsGenerating] = useState(false);
  const [filterMode, setFilterMode] = useState("unread");
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [isCreating, setIsCreating] = useState(false);

  useEffect(() => {
    loadDailyTips();
  }, []);

  const loadDailyTips = async () => {
    setIsLoadingTips(true);
    try {
      const allTips = await base44.entities.RealtorTip.list('-created_date');
      const tips = allTips.filter(t => !t.is_deleted);
      setDailyTips(tips);
      
      // Auto-generate a tip if none exist or if the latest is older than 24 hours
      if (tips.length === 0) {
        await generateDailyTip();
      } else {
        const latestTip = tips[0];
        const daysSinceLastTip = (Date.now() - new Date(latestTip.created_date).getTime()) / (1000 * 60 * 60 * 24);
        if (daysSinceLastTip > 1) {
          await generateDailyTip();
        }
      }
    } catch (error) {
      console.error("Error loading tips:", error);
    }
    setIsLoadingTips(false);
  };

  const generateDailyTip = async () => {
    if (isGenerating) {
      console.log("Already generating, skipping...");
      return;
    }
    
    setIsGenerating(true);
    try {
      // Get existing tips to avoid duplicates
      const existingTips = await base44.entities.RealtorTip.list();
      const existingTitles = existingTips.map(t => t.title).join(', ');
      
      const prompt = `Generate a UNIQUE and highly actionable real estate agent tip that can be implemented today. 

      CRITICAL RULES:
      1. ABSOLUTELY NO tips about: Virtual Tours, AI tools, Technology platforms, or any variation of "Boost Your Listings"
      2. The tip MUST be completely different from these existing tips: ${existingTitles}
      3. Focus on OLD-SCHOOL tactics that work: door knocking, expired listings, FSBOs, cold calling, open houses, networking events

      The tip should be:
1. Specific and actionable (not generic advice)
2. Based on proven strategies used by top-performing agents
3. Include estimated time to implement
4. Have clear, numbered action items
5. Be relevant to current market conditions
6. COMPLETELY UNIQUE - different topic from any existing tip

Focus on one of these categories (pick a DIFFERENT category than recent tips):
- Lead generation and prospecting
- Marketing and social media
- Client communication and service
- Negotiation tactics
- Technology and tools
- Time management and productivity
- Networking and sphere of influence
- Open houses and showings

Return a JSON object with:
- title: catchy, benefit-focused headline (under 80 characters) - MUST BE UNIQUE
- content: 2-3 paragraphs explaining the strategy and why it works
- category: one of [marketing, prospecting, negotiation, technology, social_media, networking, client_service, time_management, mindset, lead_generation]
- difficulty: one of [beginner, intermediate, advanced]
- estimated_time: e.g., "15 minutes", "1 hour", "30 minutes daily"
- potential_impact: one of [low, medium, high]
- action_items: array of 3-5 specific action steps

Make it fresh, unique, and DIFFERENT from all existing tips. Avoid repeating topics like virtual tours, AI tools, or anything mentioned above.`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            title: { type: "string" },
            content: { type: "string" },
            category: { 
              type: "string", 
              enum: ["marketing", "prospecting", "negotiation", "technology", "social_media", "networking", "client_service", "time_management", "mindset", "lead_generation"] 
            },
            difficulty: { type: "string", enum: ["beginner", "intermediate", "advanced"] },
            estimated_time: { type: "string" },
            potential_impact: { type: "string", enum: ["low", "medium", "high"] },
            action_items: { type: "array", items: { type: "string" } }
          }
        }
      });

      // Check if this tip already exists (by title or similar title)
      const normalizeTitle = (title) => title.toLowerCase().replace(/[^a-z0-9]/g, '');
      const newTitleNormalized = normalizeTitle(response.title);

      const duplicateTip = existingTips.find(t => {
        const existingNormalized = normalizeTitle(t.title);
        // Check exact match or if 80% of words match
        return existingNormalized === newTitleNormalized || 
               existingNormalized.includes(newTitleNormalized.slice(0, 20)) ||
               newTitleNormalized.includes(existingNormalized.slice(0, 20));
      });

      if (duplicateTip) {
        console.log("Duplicate or similar tip detected, skipping creation");
        toast.error("Generated a duplicate tip. Try again.");
        setIsGenerating(false);
        return;
      }

      await base44.entities.RealtorTip.create({
        ...response,
        source: "ai_generated",
        is_read: false,
        is_favorited: false
      });

      await loadDailyTips();
      
      // Trigger count refresh
      window.dispatchEvent(new Event('refreshCounts'));
      
      toast.success("New tip generated!");
    } catch (error) {
      console.error("Error generating tip:", error);
      toast.error("Failed to generate tip");
    }
    setIsGenerating(false);
  };

  const markTipAsRead = async (tipId) => {
    try {
      await base44.entities.RealtorTip.update(tipId, { is_read: true });
      await loadDailyTips();
      
      // Trigger count refresh
      window.dispatchEvent(new Event('refreshCounts'));
    } catch (error) {
      console.error("Error marking tip as read:", error);
    }
  };

  const toggleFavorite = async (tip) => {
    try {
      await base44.entities.RealtorTip.update(tip.id, { is_favorited: !tip.is_favorited });
      await loadDailyTips();
      toast.success(tip.is_favorited ? "Removed from favorites" : "Added to favorites");
    } catch (error) {
      console.error("Error toggling favorite:", error);
    }
  };

  const handleCreateTip = async (tipData) => {
    setIsCreating(true);
    try {
      await base44.entities.RealtorTip.create(tipData);
      await loadDailyTips();
      window.dispatchEvent(new Event('refreshCounts'));
      toast.success("Tip created successfully!");
      setShowCreateModal(false);
    } catch (error) {
      console.error("Error creating tip:", error);
      toast.error("Failed to create tip");
    }
    setIsCreating(false);
  };

  const getCategoryColor = (category) => {
    const colors = {
      marketing: "bg-purple-100 text-purple-700 border-purple-200",
      prospecting: "bg-blue-100 text-blue-700 border-blue-200",
      negotiation: "bg-red-100 text-red-700 border-red-200",
      technology: "bg-indigo-100 text-indigo-700 border-indigo-200",
      social_media: "bg-pink-100 text-pink-700 border-pink-200",
      networking: "bg-green-100 text-green-700 border-green-200",
      client_service: "bg-emerald-100 text-emerald-700 border-emerald-200",
      time_management: "bg-amber-100 text-amber-700 border-amber-200",
      mindset: "bg-violet-100 text-violet-700 border-violet-200",
      lead_generation: "bg-cyan-100 text-cyan-700 border-cyan-200",
      expired_listing: "bg-orange-100 text-orange-700 border-orange-200"
    };
    return colors[category] || "bg-slate-100 text-slate-700 border-slate-200";
  };

  const getImpactColor = (impact) => {
    const colors = {
      high: "bg-green-100 text-green-700",
      medium: "bg-yellow-100 text-yellow-700",
      low: "bg-slate-100 text-slate-700"
    };
    return colors[impact] || colors.medium;
  };

  const filteredTips = filterMode === "all" ? dailyTips : dailyTips.filter(t => !t.is_read);
  const favoriteTips = dailyTips.filter(t => t.is_favorited);
  const unreadCount = dailyTips.filter(t => !t.is_read).length;

  const strategies = [
    {
      id: 1,
      title: "Stop Sending Emails That Go Nowhere",
      icon: Mail,
      color: "from-blue-500 to-cyan-600",
      summary: "Use email to build your call list with dog whistle subject lines",
      content: `If there's one marketing channel agents consistently underutilize, it's email. Data shows that 6-8% of your database will transact every year. But here's the catch: Up to 90% of them won't use you.

The fix? Stop sending generic emails and hoping for replies. Instead, use email to build your call list.

Write subject lines that act like "dog whistles" ‚Äî they attract only the people most likely to be sellers.`,
      examples: [
        "Read this before you sell your home in 2025",
        "How to avoid losing $25,000 when you sell",
        "I started to sell my home but stopped. Here's why..."
      ],
      actionStep: "Stop worrying about open rates. Start focusing on WHO is opening. Call them. Conversations with the right 20 people beat blasting 1,000 with no plan.",
      stats: "6-8% of your database will transact yearly"
    },
    {
      id: 2,
      title: "Create Irresistible Offers",
      icon: Target,
      color: "from-purple-500 to-indigo-600",
      summary: "Frame your services as exclusive and scarce to increase demand",
      content: `Sometimes, the secret isn't what you're offering; it's how you frame it. KFC in Australia transformed a failing $2 fries promotion into a huge success by reframing it as "A deal so good you can only buy four." By creating scarcity, demand exploded ‚Äî orders jumped 86%.

That's value framing. And it works in real estate, too.`,
      examples: [
        "Most of my clients are surprised when they see how much equity they've gained. Even if you're not thinking of selling, knowing where you stand helps.",
        "These take me a while to prepare because I dig into comps, analyze recent sales and factor in details algorithms overlook.",
        "Can I prepare one for your home? (Limited spots available this week)"
      ],
      actionStep: "This week, send one email framed as an exclusive offer. Make it sound valuable and scarce. You don't send these often, but when you do, they get results.",
      stats: "86% increase in demand with scarcity framing"
    },
    {
      id: 3,
      title: "Send More Emails Than You Think You Should",
      icon: TrendingUp,
      color: "from-emerald-500 to-green-600",
      summary: "The best email marketers email daily. More touchpoints = more opportunities",
      content: `Most agents are terrified of "over-emailing." But you already send 25 emails a day ‚Äî just one at a time. Why not send 25 to your database?

The best email marketers don't email weekly. They email daily, or even twice a day. The trick? Provide value every time.

The more often you show up in inboxes, the more surface area you create for opportunity. Repetition builds recognition. Recognition builds trust.`,
      examples: [
        "Listings and open houses",
        "Market updates and neighborhood news",
        "Client success stories",
        "Educational content: '3 things buyers want in 2025'"
      ],
      actionStep: "Set a goal of 20-25 emails a month. Mix in listings, market updates, success stories, and educational content. Provide value every single time.",
      stats: "Top agents send 20-25+ emails per month"
    },
    {
      id: 4,
      title: "Market Like You Gossip",
      icon: Share2,
      color: "from-amber-500 to-orange-600",
      summary: "Use raw, curiosity-driven social media content that spreads naturally",
      content: `Social media is a low-cost listing machine ‚Äî if you use it right. One agent generated $400,000 in commissions in 18 months from Instagram alone.

The secret? "Market like you gossip."

Instead of polished, generic posts, share quick, raw, curiosity-driven content that spreads like whispers. Pair posts with Instagram polls in Stories. They're free, fast and wildly effective.`,
      examples: [
        "Over 140 price reductions in Boston this week. Want the list?",
        "Thinking of selling your house? Here's what most owners don't realize about today's market...",
        "Debated not posting this, but I'm curious, who's still planning to buy in 2025 despite rates?"
      ],
      actionStep: "Post one Instagram Reel per week (listings, market updates or faceless slideshows with text and AI voiceovers). Pair it with one Story poll every week. Collect responses and follow up immediately.",
      stats: "$400K in commissions from Instagram in 18 months"
    },
    {
      id: 5,
      title: "Repurpose Delistings",
      icon: Users,
      color: "from-rose-500 to-pink-600",
      summary: "Turn expired listings into success stories and referral magnets",
      content: `Delistings are surging ‚Äî up to nearly 50% according to Realtor.com. In some markets, for every 2-3 fresh listings, one home is being pulled.

This is your opportunity. The playbook is simple: systematic outreach, authority positioning, and story sharing.

When you win one? Share the story everywhere. Turn your success into a case study that positions you as the expert who can solve what others couldn't.`,
      examples: [
        "Send a series of 6-7 letters over 45 days",
        "Use call and text scripts to make contact",
        "Leverage authority posts: 'Longer time on market is the new normal...'",
        "Share video case studies of your expired listing wins"
      ],
      actionStep: "Pick one expired listing campaign this week. Send the first letter, post an educational video, or text homeowners whose listings just came off the market. End every success story with: 'Know someone stuck in the same situation? Send them this video.'",
      stats: "One agent relisted for $87K more than prior price"
    },
    {
      id: 6,
      title: "Add New Pillars Without New Costs",
      icon: DollarSign,
      color: "from-violet-500 to-purple-600",
      summary: "Optimize what works, then strategically add one new lead generation pillar",
      content: `Every major brand that scaled ‚Äî Birkenstock, Stanley, Carhartt ‚Äî did it the same way: They optimized their core business and added a new pillar.

The same applies to real estate. Improve what you already do (email, social, referrals), but don't stop there. Add one new lead pillar: Expireds. Instagram. Neighborhood farming.

"Get good at the things you do often. Then add one new thing."`,
      examples: [
        "Master your email marketing first",
        "Then add expired listing campaigns",
        "Layer in neighborhood farming",
        "Add Instagram Reels and Stories",
        "Optimize each before adding the next"
      ],
      actionStep: "Audit your current lead sources. Pick the top 2-3 that are working. Double down on those. Then choose ONE new pillar to test this quarter. Commit to it for 90 days before evaluating.",
      stats: "Most successful agents have 3-5 optimized lead pillars"
    }
  ];

  const quickWins = [
    {
      title: "Daily Email Commitment",
      description: "Send one value-driven email to your database every day",
      icon: Mail,
      time: "15 min/day"
    },
    {
      title: "Instagram Story Poll",
      description: "Post one engagement poll in Stories weekly",
      icon: Share2,
      time: "5 min/week"
    },
    {
      title: "Expired Listing Outreach",
      description: "Contact 5 expired listings with custom letters",
      icon: Target,
      time: "30 min/week"
    },
    {
      title: "Value Framing Practice",
      description: "Rewrite 3 generic offers as exclusive/scarce opportunities",
      icon: Sparkles,
      time: "20 min/week"
    }
  ];

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Header */}
        <div className="app-card p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(createPageUrl("Dashboard"))}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600">
                  <Lightbulb className="w-6 h-6 text-white" />
                </div>
                <h1 className="app-title text-2xl">Realtor Tips & Tricks</h1>
                {unreadCount > 0 && (
                  <Badge className="bg-red-500 text-white">
                    {unreadCount} New
                  </Badge>
                )}
              </div>
              <p className="app-subtitle">
                AI-generated daily tips + proven low-cost listing strategies
              </p>
            </div>
            <div className="flex gap-2">
              <Button 
                onClick={() => setShowCreateModal(true)}
                variant="outline"
              >
                <Plus className="w-4 h-4 mr-2" />
                Add Manual Tip
              </Button>
              <Button 
                onClick={generateDailyTip}
                disabled={isGenerating}
                className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
              >
                {isGenerating ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-4 h-4 mr-2" />
                    Generate AI Tip
                  </>
                )}
              </Button>
            </div>
          </div>
        </div>

        <Tabs defaultValue="daily" className="space-y-6">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="daily">
              <Sparkles className="w-4 h-4 mr-2" />
              Daily Tips ({dailyTips.length})
            </TabsTrigger>
            <TabsTrigger value="strategies">
              <Target className="w-4 h-4 mr-2" />
              Core Strategies (6)
            </TabsTrigger>
            <TabsTrigger value="favorites">
              <Star className="w-4 h-4 mr-2" />
              Favorites ({favoriteTips.length})
            </TabsTrigger>
          </TabsList>

          {/* Daily AI Tips */}
          <TabsContent value="daily" className="space-y-4">
            <div className="flex items-center justify-between">
              <div className="flex gap-2">
                <Button
                  variant={filterMode === "unread" ? "default" : "outline"}
                  size="sm"
                  onClick={() => setFilterMode("unread")}
                >
                  <EyeOff className="w-4 h-4 mr-2" />
                  Unread ({unreadCount})
                </Button>
                <Button
                  variant={filterMode === "all" ? "default" : "outline"}
                  size="sm"
                  onClick={() => setFilterMode("all")}
                >
                  <Eye className="w-4 h-4 mr-2" />
                  All ({dailyTips.length})
                </Button>
              </div>
            </div>

            {isLoadingTips ? (
              <div className="flex justify-center py-12">
                <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
              </div>
            ) : filteredTips.length > 0 ? (
              <div className="grid gap-4">
                {filteredTips.map((tip) => (
                  <Card 
                    key={tip.id} 
                    className={`overflow-hidden transition-all ${
                      !tip.is_read ? 'border-indigo-300 shadow-lg' : 'border-slate-200'
                    }`}
                  >
                    <CardHeader>
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <Badge className={getCategoryColor(tip.category)}>
                              {tip.category.replace('_', ' ')}
                            </Badge>
                            <Badge className={getImpactColor(tip.potential_impact)}>
                              {tip.potential_impact} impact
                            </Badge>
                            <Badge variant="outline">
                              <Clock className="w-3 h-3 mr-1" />
                              {tip.estimated_time}
                            </Badge>
                            {!tip.is_read && (
                              <Badge className="bg-red-500 text-white">NEW</Badge>
                            )}
                          </div>
                          <CardTitle className="text-xl">{tip.title}</CardTitle>
                          <p className="text-sm text-slate-500 mt-1">
                            {formatDistanceToNow(new Date(tip.created_date), { addSuffix: true })}
                          </p>
                        </div>
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => toggleFavorite(tip)}
                          className={tip.is_favorited ? "text-yellow-500" : "text-slate-400"}
                        >
                          <Star className={`w-5 h-5 ${tip.is_favorited ? 'fill-current' : ''}`} />
                        </Button>
                      </div>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <p className="text-slate-700 leading-relaxed whitespace-pre-line">
                        {tip.content}
                      </p>

                      {tip.action_items && tip.action_items.length > 0 && (
                        <div className="bg-indigo-50 rounded-lg p-4 border-2 border-indigo-200">
                          <h4 className="font-semibold text-indigo-900 mb-3 flex items-center gap-2">
                            <CheckCircle2 className="w-5 h-5" />
                            Action Steps:
                          </h4>
                          <ol className="space-y-2">
                            {tip.action_items.map((item, idx) => (
                              <li key={idx} className="flex items-start gap-2 text-sm text-indigo-800">
                                <span className="font-bold text-indigo-600">{idx + 1}.</span>
                                <span>{item}</span>
                              </li>
                            ))}
                          </ol>
                        </div>
                      )}

                      {!tip.is_read && (
                        <Button
                          onClick={() => markTipAsRead(tip.id)}
                          variant="outline"
                          size="sm"
                          className="w-full"
                        >
                          <CheckCircle2 className="w-4 h-4 mr-2" />
                          Mark as Read
                        </Button>
                      )}
                    </CardContent>
                  </Card>
                ))}
              </div>
            ) : (
              <Card>
                <CardContent className="py-12 text-center">
                  <Lightbulb className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                  <h3 className="text-xl font-semibold mb-2">No Tips Yet</h3>
                  <p className="text-slate-500 mb-4">
                    {filterMode === "unread" ? "All caught up! Generate a new tip to keep learning." : "Click 'Generate New Tip' to get started."}
                  </p>
                  <Button onClick={generateDailyTip} disabled={isGenerating}>
                    <Sparkles className="w-4 h-4 mr-2" />
                    Generate Your First Tip
                  </Button>
                </CardContent>
              </Card>
            )}
          </TabsContent>

          {/* Core Strategies */}
          <TabsContent value="strategies" className="space-y-4">
            {/* Key Insight Banner */}
            <div className="app-card p-6 bg-gradient-to-br from-indigo-50 to-purple-50 border-indigo-200">
              <div className="flex items-start gap-4">
                <div className="p-3 rounded-xl bg-indigo-600">
                  <Sparkles className="w-6 h-6 text-white" />
                </div>
                <div className="flex-1">
                  <h3 className="app-title text-lg mb-2">The Golden Rule</h3>
                  <p className="app-text mb-3">
                    "The agent who has the most conversations wins. Ball on a budget doesn't mean cutting back until there's nothing left. It means doubling down on the free and low-cost strategies that already work."
                  </p>
                  <p className="text-sm text-indigo-700 font-semibold">
                    ‚Äî Jimmy Mackin, Listing Leads Co-Founder
                  </p>
                </div>
              </div>
            </div>

            {/* Quick Wins */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <CheckCircle2 className="w-5 h-5 text-green-600" />
                  Quick Wins to Implement This Week
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {quickWins.map((win, index) => (
                    <div key={index} className="p-4 rounded-lg border border-slate-200 hover:border-indigo-300 hover:shadow-md transition-all">
                      <div className="flex items-start gap-3">
                        <div className="p-2 rounded-lg bg-indigo-100">
                          <win.icon className="w-5 h-5 text-indigo-600" />
                        </div>
                        <div className="flex-1">
                          <h4 className="font-semibold text-slate-900 mb-1">{win.title}</h4>
                          <p className="text-sm text-slate-600 mb-2">{win.description}</p>
                          <Badge variant="outline" className="text-xs">
                            <Calendar className="w-3 h-3 mr-1" />
                            {win.time}
                          </Badge>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            {/* Strategy Cards */}
            <div className="space-y-4">
              <h2 className="app-title text-xl">6 Proven Strategies</h2>
              <div className="grid grid-cols-1 gap-4">
                {strategies.map((strategy) => (
                  <Card 
                    key={strategy.id} 
                    className="overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
                    onClick={() => setActiveStrategy(activeStrategy === strategy.id ? null : strategy.id)}
                  >
                    <div className="p-6">
                      <div className="flex items-start justify-between mb-4">
                        <div className="flex items-start gap-4">
                          <div className={`p-3 rounded-xl bg-gradient-to-br ${strategy.color} shadow-lg flex-shrink-0`}>
                            <strategy.icon className="w-6 h-6 text-white" />
                          </div>
                          <div>
                            <h3 className="app-title text-lg mb-2">{strategy.title}</h3>
                            <p className="app-text-muted text-sm">{strategy.summary}</p>
                            <Badge className="mt-2 bg-green-100 text-green-700 border-green-200">
                              {strategy.stats}
                            </Badge>
                          </div>
                        </div>
                        <ArrowRight className={`w-5 h-5 text-slate-400 transition-transform ${activeStrategy === strategy.id ? 'rotate-90' : ''}`} />
                      </div>

                      {activeStrategy === strategy.id && (
                        <div className="mt-6 pt-6 border-t border-slate-200 space-y-6">
                          <div>
                            <h4 className="font-semibold text-slate-900 mb-3">The Strategy</h4>
                            <p className="app-text text-sm leading-relaxed whitespace-pre-line">
                              {strategy.content}
                            </p>
                          </div>

                          <div>
                            <h4 className="font-semibold text-slate-900 mb-3">Examples to Use</h4>
                            <div className="space-y-2">
                              {strategy.examples.map((example, index) => (
                                <div key={index} className="flex items-start gap-2 p-3 rounded-lg bg-slate-50">
                                  <CheckCircle2 className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
                                  <span className="text-sm text-slate-700">{example}</span>
                                </div>
                              ))}
                            </div>
                          </div>

                          <div className="p-4 rounded-lg bg-indigo-50 border-2 border-indigo-200">
                            <h4 className="font-semibold text-indigo-900 mb-2 flex items-center gap-2">
                              <Target className="w-5 h-5" />
                              Action Step
                            </h4>
                            <p className="text-sm text-indigo-800 leading-relaxed">
                              {strategy.actionStep}
                            </p>
                          </div>
                        </div>
                      )}
                    </div>
                  </Card>
                ))}
              </div>
            </div>

            {/* Bottom CTA */}
            <div className="app-card p-8 text-center bg-gradient-to-br from-slate-900 via-indigo-900 to-purple-900 text-white">
              <h3 className="text-2xl font-bold mb-3">Remember: Action Beats Perfection</h3>
              <p className="text-slate-300 mb-6 max-w-2xl mx-auto">
                There is nothing here that you probably don't already know, but what are you actually doing on a daily basis? 
                Make sure you have a strong system and your daily schedule is complete.
              </p>
              <div className="flex justify-center gap-4">
                <Button 
                  onClick={() => navigate(createPageUrl("Tasks"))}
                  className="bg-white text-slate-900 hover:bg-slate-100"
                >
                  <CheckCircle2 className="w-4 h-4 mr-2" />
                  Create Action Tasks
                </Button>
                <Button 
                  onClick={() => navigate(createPageUrl("Dashboard"))}
                  variant="outline"
                  className="border-white text-white hover:bg-white/10"
                >
                  Back to Dashboard
                </Button>
              </div>
            </div>
          </TabsContent>

          {/* Favorites */}
          <TabsContent value="favorites" className="space-y-4">
            {favoriteTips.length > 0 ? (
              <div className="grid gap-4">
                {favoriteTips.map((tip) => (
                  <Card key={tip.id} className="overflow-hidden">
                    <CardHeader>
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <Badge className={getCategoryColor(tip.category)}>
                              {tip.category.replace('_', ' ')}
                            </Badge>
                            <Badge className={getImpactColor(tip.potential_impact)}>
                              {tip.potential_impact} impact
                            </Badge>
                          </div>
                          <CardTitle className="text-xl">{tip.title}</CardTitle>
                        </div>
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => toggleFavorite(tip)}
                          className="text-yellow-500"
                        >
                          <Star className="w-5 h-5 fill-current" />
                        </Button>
                      </div>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <p className="text-slate-700 leading-relaxed whitespace-pre-line">
                        {tip.content}
                      </p>
                      {tip.action_items && tip.action_items.length > 0 && (
                        <div className="bg-indigo-50 rounded-lg p-4 border-2 border-indigo-200">
                          <h4 className="font-semibold text-indigo-900 mb-3 flex items-center gap-2">
                            <CheckCircle2 className="w-5 h-5" />
                            Action Steps:
                          </h4>
                          <ol className="space-y-2">
                            {tip.action_items.map((item, idx) => (
                              <li key={idx} className="flex items-start gap-2 text-sm text-indigo-800">
                                <span className="font-bold text-indigo-600">{idx + 1}.</span>
                                <span>{item}</span>
                              </li>
                            ))}
                          </ol>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                ))}
              </div>
            ) : (
              <Card>
                <CardContent className="py-12 text-center">
                  <Star className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                  <h3 className="text-xl font-semibold mb-2">No Favorites Yet</h3>
                  <p className="text-slate-500">
                    Click the star icon on tips to save them as favorites
                  </p>
                </CardContent>
              </Card>
            )}
          </TabsContent>
        </Tabs>
      </div>

      <CreateTipModal
        isOpen={showCreateModal}
        onClose={() => setShowCreateModal(false)}
        onSave={handleCreateTip}
        isSaving={isCreating}
      />
    </div>
  );
}
import React, { useState, useMemo } from "react";
import { useQuery } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import {
  BarChart, Bar, LineChart, Line, PieChart, Pie, Cell,
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
} from 'recharts';
import {
  FileText, DollarSign, TrendingUp, Clock,
  Calendar, User, BarChart3, Filter, RefreshCw, FileSpreadsheet
} from "lucide-react";
import { toast } from "sonner";
import { format, differenceInDays, parseISO, startOfMonth, subMonths } from "date-fns";

export default function ReportsPage() {
  const [dateFrom, setDateFrom] = useState(() => {
    const threeMonthsAgo = subMonths(new Date(), 3);
    return format(startOfMonth(threeMonthsAgo), 'yyyy-MM-dd');
  });
  const [dateTo, setDateTo] = useState(() => format(new Date(), 'yyyy-MM-dd'));
  const [selectedAgent, setSelectedAgent] = useState("all");

  const { data: transactions = [], isLoading: loadingTransactions } = useQuery({
    queryKey: ["transactions"],
    queryFn: () => base44.entities.Transaction.list()
  });

  const { data: properties = [] } = useQuery({
    queryKey: ["properties"],
    queryFn: () => base44.entities.Property.list()
  });

  const { data: users = [] } = useQuery({
    queryKey: ["users"],
    queryFn: () => base44.entities.User.list()
  });

  const filteredTransactions = useMemo(() => {
    return transactions.filter(t => {
      const closingDate = t.important_dates?.closing_date || t.created_date;
      if (!closingDate) return false;
      
      const transDate = new Date(closingDate);
      const fromDate = new Date(dateFrom);
      const toDate = new Date(dateTo);
      
      if (transDate < fromDate || transDate > toDate) return false;

      if (selectedAgent !== "all") {
        if (t.roles?.listing_agent_id !== selectedAgent) return false;
      }

      return true;
    });
  }, [transactions, dateFrom, dateTo, selectedAgent]);

  const metrics = useMemo(() => {
    const totalVolume = filteredTransactions.reduce((sum, t) => sum + (t.contract_price || 0), 0);
    const totalCommission = filteredTransactions.reduce((sum, t) => sum + (t.listing_net_commission || 0), 0);
    const avgDealSize = filteredTransactions.length > 0 ? totalVolume / filteredTransactions.length : 0;

    const cycleTimes = filteredTransactions
      .filter(t => t.important_dates?.offer_date && t.important_dates?.closing_date)
      .map(t => differenceInDays(parseISO(t.important_dates.closing_date), parseISO(t.important_dates.offer_date)));

    const avgCycleTime = cycleTimes.length > 0
      ? Math.round(cycleTimes.reduce((sum, days) => sum + days, 0) / cycleTimes.length)
      : 0;

    return {
      totalTransactions: filteredTransactions.length,
      totalVolume,
      totalCommission,
      avgDealSize,
      avgCycleTime,
      closedDeals: filteredTransactions.filter(t => t.status === 'closed').length,
      activeDeals: filteredTransactions.filter(t => t.status === 'active' || t.status === 'pending').length,
    };
  }, [filteredTransactions]);

  const monthlyData = useMemo(() => {
    const months = {};
    
    filteredTransactions.forEach(t => {
      const date = t.important_dates?.closing_date || t.created_date;
      if (!date) return;
      
      const monthKey = format(new Date(date), 'MMM yyyy');
      if (!months[monthKey]) {
        months[monthKey] = { month: monthKey, count: 0, commission: 0 };
      }
      
      months[monthKey].count += 1;
      months[monthKey].commission += t.listing_net_commission || 0;
    });

    return Object.values(months).sort((a, b) => new Date(a.month) - new Date(b.month));
  }, [filteredTransactions]);

  const agentCommissions = useMemo(() => {
    const byAgent = {};

    filteredTransactions.forEach(t => {
      const agentId = t.roles?.listing_agent_id;
      if (!agentId) return;

      const agent = users.find(u => u.id === agentId);
      const agentName = agent?.full_name || agent?.email || 'Unknown';

      if (!byAgent[agentId]) {
        byAgent[agentId] = { agentName, totalCommission: 0, dealCount: 0, totalVolume: 0 };
      }

      byAgent[agentId].totalCommission += t.listing_net_commission || 0;
      byAgent[agentId].dealCount += 1;
      byAgent[agentId].totalVolume += t.contract_price || 0;
    });

    return Object.values(byAgent).sort((a, b) => b.totalCommission - a.totalCommission);
  }, [filteredTransactions, users]);

  const statusData = useMemo(() => {
    const statuses = {};
    filteredTransactions.forEach(t => {
      const status = t.status || 'unknown';
      if (!statuses[status]) {
        statuses[status] = { name: status, value: 0 };
      }
      statuses[status].value += 1;
    });
    return Object.values(statuses);
  }, [filteredTransactions]);

  const cycleTimeData = useMemo(() => {
    const ranges = { '0-30 days': 0, '31-45 days': 0, '46-60 days': 0, '61+ days': 0 };

    filteredTransactions.forEach(t => {
      if (!t.important_dates?.offer_date || !t.important_dates?.closing_date) return;
      const days = differenceInDays(parseISO(t.important_dates.closing_date), parseISO(t.important_dates.offer_date));

      if (days <= 30) ranges['0-30 days']++;
      else if (days <= 45) ranges['31-45 days']++;
      else if (days <= 60) ranges['46-60 days']++;
      else ranges['61+ days']++;
    });

    return Object.entries(ranges).map(([name, value]) => ({ name, value }));
  }, [filteredTransactions]);

  const exportToCSV = () => {
    const headers = ['Property Address', 'Status', 'Contract Price', 'Listing Agent', 'Commission', 'Offer Date', 'Closing Date', 'Cycle Days'];
    const rows = filteredTransactions.map(t => {
      const property = properties.find(p => p.id === t.property_id);
      const agent = users.find(u => u.id === t.roles?.listing_agent_id);
      const cycleTime = t.important_dates?.offer_date && t.important_dates?.closing_date
        ? differenceInDays(parseISO(t.important_dates.closing_date), parseISO(t.important_dates.offer_date))
        : '';

      return [
        property?.address || t.manual_address || 'N/A',
        t.status,
        t.contract_price || 0,
        agent?.full_name || agent?.email || 'N/A',
        t.listing_net_commission || 0,
        t.important_dates?.offer_date || '',
        t.important_dates?.closing_date || '',
        cycleTime
      ];
    });

    const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `transaction-report-${format(new Date(), 'yyyy-MM-dd')}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    a.remove();
    toast.success("CSV report downloaded!");
  };

  const exportToPDF = () => {
    toast.info("Preparing PDF...");
    setTimeout(() => window.print(), 500);
  };

  const COLORS = ['#4F46E5', '#7C3AED', '#06B6D4', '#F59E0B', '#10B981', '#EF4444'];

  if (loadingTransactions) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <RefreshCw className="w-12 h-12 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                <BarChart3 className="w-6 h-6 text-white" />
              </div>
              Transaction Reports
            </h1>
            <p className="text-slate-600 dark:text-slate-400 mt-1">
              Comprehensive insights into your business performance
            </p>
          </div>

          <div className="flex items-center gap-2 print:hidden">
            <Button onClick={exportToCSV} variant="outline">
              <FileSpreadsheet className="w-4 h-4 mr-2" />
              Export CSV
            </Button>
            <Button onClick={exportToPDF} variant="outline">
              <FileText className="w-4 h-4 mr-2" />
              Print PDF
            </Button>
          </div>
        </div>

        <Card className="print:hidden">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Filter className="w-5 h-5" />
              Report Filters
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="space-y-2">
                <Label>From Date</Label>
                <Input type="date" value={dateFrom} onChange={(e) => setDateFrom(e.target.value)} />
              </div>
              <div className="space-y-2">
                <Label>To Date</Label>
                <Input type="date" value={dateTo} onChange={(e) => setDateTo(e.target.value)} />
              </div>
              <div className="space-y-2">
                <Label>Agent</Label>
                <Select value={selectedAgent} onValueChange={setSelectedAgent}>
                  <SelectTrigger><SelectValue /></SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Agents</SelectItem>
                    {users.map(u => <SelectItem key={u.id} value={u.id}>{u.full_name || u.email}</SelectItem>)}
                  </SelectContent>
                </Select>
              </div>
            </div>
            <div className="mt-4 flex items-center justify-between">
              <Badge variant="outline">
                Showing {filteredTransactions.length} transaction{filteredTransactions.length !== 1 ? 's' : ''}
              </Badge>
              <Button variant="ghost" size="sm" onClick={() => {
                setDateFrom(format(subMonths(new Date(), 3), 'yyyy-MM-dd'));
                setDateTo(format(new Date(), 'yyyy-MM-dd'));
                setSelectedAgent("all");
              }}>
                Reset Filters
              </Button>
            </div>
          </CardContent>
        </Card>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <Card className="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950 dark:to-indigo-950 border-2">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-blue-700 dark:text-blue-300">Total Transactions</p>
                  <p className="text-3xl font-bold text-blue-900 dark:text-blue-100 mt-2">{metrics.totalTransactions}</p>
                  <p className="text-xs text-blue-600 dark:text-blue-400 mt-1">{metrics.closedDeals} closed</p>
                </div>
                <BarChart3 className="w-12 h-12 text-blue-400" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-950 dark:to-emerald-950 border-2">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-green-700 dark:text-green-300">Total Volume</p>
                  <p className="text-3xl font-bold text-green-900 dark:text-green-100 mt-2">
                    ${(metrics.totalVolume / 1000000).toFixed(2)}M
                  </p>
                  <p className="text-xs text-green-600 dark:text-green-400 mt-1">
                    Avg: ${Math.round(metrics.avgDealSize).toLocaleString()}
                  </p>
                </div>
                <DollarSign className="w-12 h-12 text-green-400" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950 dark:to-pink-950 border-2">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-purple-700 dark:text-purple-300">Total Commission</p>
                  <p className="text-3xl font-bold text-purple-900 dark:text-purple-100 mt-2">
                    ${Math.round(metrics.totalCommission).toLocaleString()}
                  </p>
                </div>
                <TrendingUp className="w-12 h-12 text-purple-400" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950 dark:to-orange-950 border-2">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-amber-700 dark:text-amber-300">Avg Cycle Time</p>
                  <p className="text-3xl font-bold text-amber-900 dark:text-amber-100 mt-2">{metrics.avgCycleTime} days</p>
                </div>
                <Clock className="w-12 h-12 text-amber-400" />
              </div>
            </CardContent>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card>
            <CardHeader><CardTitle>Monthly Transaction Volume</CardTitle></CardHeader>
            <CardContent>
              {monthlyData.length > 0 ? (
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={monthlyData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="month" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Bar dataKey="count" fill="#4F46E5" name="Transactions" />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-[300px] flex items-center justify-center text-slate-400">No data</div>
              )}
            </CardContent>
          </Card>

          <Card>
            <CardHeader><CardTitle>Commission Earnings Trend</CardTitle></CardHeader>
            <CardContent>
              {monthlyData.length > 0 ? (
                <ResponsiveContainer width="100%" height={300}>
                  <LineChart data={monthlyData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="month" />
                    <YAxis />
                    <Tooltip formatter={(value) => [`$${Math.round(value).toLocaleString()}`, 'Commission']} />
                    <Legend />
                    <Line type="monotone" dataKey="commission" stroke="#7C3AED" strokeWidth={2} name="Commission" />
                  </LineChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-[300px] flex items-center justify-center text-slate-400">No data</div>
              )}
            </CardContent>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card>
            <CardHeader><CardTitle>Status Distribution</CardTitle></CardHeader>
            <CardContent>
              {statusData.length > 0 ? (
                <ResponsiveContainer width="100%" height={300}>
                  <PieChart>
                    <Pie
                      data={statusData}
                      cx="50%"
                      cy="50%"
                      label={({ name, value }) => `${name}: ${value}`}
                      outerRadius={100}
                      dataKey="value"
                    >
                      {statusData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-[300px] flex items-center justify-center text-slate-400">No data</div>
              )}
            </CardContent>
          </Card>

          <Card>
            <CardHeader><CardTitle>Cycle Time Distribution</CardTitle></CardHeader>
            <CardContent>
              {cycleTimeData.some(d => d.value > 0) ? (
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={cycleTimeData} layout="vertical">
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis type="number" />
                    <YAxis dataKey="name" type="category" width={100} />
                    <Tooltip />
                    <Bar dataKey="value" fill="#06B6D4" />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-[300px] flex items-center justify-center text-slate-400">No data</div>
              )}
            </CardContent>
          </Card>
        </div>

        {agentCommissions.length > 0 && (
          <Card>
            <CardHeader><CardTitle>Commission by Agent</CardTitle></CardHeader>
            <CardContent>
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left p-3 text-sm">Agent</th>
                    <th className="text-right p-3 text-sm">Deals</th>
                    <th className="text-right p-3 text-sm">Volume</th>
                    <th className="text-right p-3 text-sm">Commission</th>
                    <th className="text-right p-3 text-sm">Avg/Deal</th>
                  </tr>
                </thead>
                <tbody>
                  {agentCommissions.map((agent, i) => (
                    <tr key={i} className="border-b hover:bg-slate-50 dark:hover:bg-slate-900">
                      <td className="p-3 text-sm"><User className="w-4 h-4 inline mr-2" />{agent.agentName}</td>
                      <td className="p-3 text-sm text-right">{agent.dealCount}</td>
                      <td className="p-3 text-sm text-right">${Math.round(agent.totalVolume).toLocaleString()}</td>
                      <td className="p-3 text-sm text-right font-semibold text-green-700 dark:text-green-300">
                        ${Math.round(agent.totalCommission).toLocaleString()}
                      </td>
                      <td className="p-3 text-sm text-right">
                        ${Math.round(agent.totalCommission / agent.dealCount).toLocaleString()}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </CardContent>
          </Card>
        )}

        <Card>
          <CardHeader><CardTitle>Transaction Details</CardTitle></CardHeader>
          <CardContent>
            {filteredTransactions.length > 0 ? (
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left p-3 text-sm">Property</th>
                    <th className="text-left p-3 text-sm">Status</th>
                    <th className="text-right p-3 text-sm">Price</th>
                    <th className="text-left p-3 text-sm">Agent</th>
                    <th className="text-right p-3 text-sm">Commission</th>
                    <th className="text-left p-3 text-sm">Closing</th>
                    <th className="text-right p-3 text-sm">Days</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredTransactions.map(t => {
                    const property = properties.find(p => p.id === t.property_id);
                    const agent = users.find(u => u.id === t.roles?.listing_agent_id);
                    const cycleTime = t.important_dates?.offer_date && t.important_dates?.closing_date
                      ? differenceInDays(parseISO(t.important_dates.closing_date), parseISO(t.important_dates.offer_date))
                      : null;

                    return (
                      <tr key={t.id} className="border-b hover:bg-slate-50 dark:hover:bg-slate-900">
                        <td className="p-3 text-sm">{property?.address || t.manual_address || 'N/A'}</td>
                        <td className="p-3"><Badge>{t.status}</Badge></td>
                        <td className="p-3 text-sm text-right">${(t.contract_price || 0).toLocaleString()}</td>
                        <td className="p-3 text-sm">{agent?.full_name || 'N/A'}</td>
                        <td className="p-3 text-sm text-right text-green-700 dark:text-green-300 font-semibold">
                          ${Math.round(t.listing_net_commission || 0).toLocaleString()}
                        </td>
                        <td className="p-3 text-sm">
                          {t.important_dates?.closing_date ? format(parseISO(t.important_dates.closing_date), 'MMM d, yyyy') : '-'}
                        </td>
                        <td className="p-3 text-sm text-right">{cycleTime !== null ? `${cycleTime}` : '-'}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            ) : (
              <div className="p-12 text-center">
                <Calendar className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                <h3 className="text-lg font-semibold mb-2">No Transactions Found</h3>
                <p className="text-slate-600 dark:text-slate-400">Try adjusting your filters</p>
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      <style>{`
        @media print {
          .print\\:hidden { display: none !important; }
          body { print-color-adjust: exact; }
        }
      `}</style>
    </div>
  );
}

import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { toast } from 'sonner';
import { RefreshCw, AlertTriangle, Loader2 } from 'lucide-react';

export default function ResetDemo() {
    const [isResetting, setIsResetting] = useState(false);

    const handleReset = async () => {
        if (!confirm("Are you absolutely sure you want to delete all demo data? This action cannot be undone.")) {
            return;
        }

        setIsResetting(true);
        toast.info("Starting demo data reset...");

        try {
            const entitiesToDelete = [
                'Lead', 'Transaction', 'Property', 'MarketingCampaign', 
                'Task', 'Contact', 'Showing', 'OpenHouse', 'Commission',
                'FSBOLead', 'FSBOActivity'
            ];

            for (const entityName of entitiesToDelete) {
                try {
                    const records = await base44.entities[entityName].list();
                    if (records.length > 0) {
                        toast.info(`Deleting ${records.length} record(s) from ${entityName}...`);
                        // This is a simplification. Real bulk delete would be better.
                        for (const record of records) {
                            await base44.entities[entityName].delete(record.id);
                        }
                    }
                } catch (e) {
                    console.warn(`Could not list or delete records for ${entityName}. It might not exist or be empty.`, e);
                }
            }

            toast.success("All demo data has been successfully reset.");
        } catch (error) {
            console.error("Error resetting demo data:", error);
            toast.error("An error occurred during the reset process.");
        } finally {
            setIsResetting(false);
            window.dispatchEvent(new Event('refreshCounts')); // Refresh layout counts
        }
    };

    return (
        <div className="page-container flex items-center justify-center">
            <Card className="max-w-2xl w-full text-center">
                <CardHeader>
                    <CardTitle className="flex items-center justify-center gap-3 text-2xl">
                        <AlertTriangle className="w-8 h-8 text-red-600" />
                        Reset Demo Environment
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-6">
                    <p className="text-slate-600">
                        This tool will permanently delete all data across major entities like Leads, Properties, Transactions, and more. 
                        It is intended to clean up the data generated by the "Initialize Demo" tool.
                    </p>
                    
                    <div className="p-4 bg-red-50 border-l-4 border-red-500 text-left">
                        <p className="text-sm text-red-800">
                            <strong>DANGER:</strong> This action is irreversible. It will wipe clean most of your CRM data.
                            Only proceed if you are certain you want to start over from a clean slate.
                        </p>
                    </div>

                    <Button 
                        onClick={handleReset} 
                        disabled={isResetting}
                        variant="destructive" 
                        size="lg" 
                        className="w-full"
                    >
                        {isResetting ? (
                            <><Loader2 className="w-5 h-5 mr-2 animate-spin" /> Resetting...</>
                        ) : (
                            <><RefreshCw className="w-5 h-5 mr-2" /> Reset All Demo Data</>
                        )}
                    </Button>
                </CardContent>
            </Card>
        </div>
    );
}

import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    Shield, AlertTriangle, TrendingUp, Eye, Share2, Download, Search, ChevronDown, ChevronUp, ExternalLink, CheckCircle, X, Mail,
    FileText, Users, DollarSign, Calendar, Info, RefreshCw
} from 'lucide-react';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { toast } from 'sonner';
import { format, parseISO } from 'date-fns';

const alertTypeConfig = {
    wire_fraud: { label: 'Wire Fraud', color: 'bg-red-600', icon: DollarSign },
    title_fraud: { label: 'Title Fraud', color: 'bg-orange-600', icon: FileText },
    rental_scam: { label: 'Rental Scam', color: 'bg-yellow-600', icon: AlertTriangle },
    phishing: { label: 'Phishing', color: 'bg-purple-600', icon: Mail },
    identity_theft: { label: 'Identity Theft', color: 'bg-pink-600', icon: Users },
    escrow_fraud: { label: 'Escrow Fraud', color: 'bg-red-700', icon: DollarSign },
    listing_hijacking: { label: 'Listing Hijacking', color: 'bg-orange-700', icon: AlertTriangle },
    fake_buyer: { label: 'Fake Buyer', color: 'bg-indigo-600', icon: Users },
    fake_seller: { label: 'Fake Seller', color: 'bg-violet-600', icon: Users },
    other: { label: 'Other', color: 'bg-gray-600', icon: Info }
};

const severityConfig = {
    critical: { label: 'Critical', color: 'bg-red-600 text-white', ring: 'ring-red-500' },
    high: { label: 'High', color: 'bg-orange-600 text-white', ring: 'ring-orange-500' },
    medium: { label: 'Medium', color: 'bg-yellow-600 text-white', ring: 'ring-yellow-500' },
    low: { label: 'Low', color: 'bg-blue-600 text-white', ring: 'ring-blue-500' }
};

export default function ScamAlerts() {
    const navigate = useNavigate();
    const queryClient = useQueryClient();
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedType, setSelectedType] = useState('all');
    const [selectedSeverity, setSelectedSeverity] = useState('all');
    const [expandedAlert, setExpandedAlert] = useState(null);
    const [activeTab, setActiveTab] = useState('all');
    const [isSyncing, setIsSyncing] = useState(false);
    const [lastSyncTime, setLastSyncTime] = useState(null);

    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me(),
    });

    // Load last sync time from user data on mount
    React.useEffect(() => {
        if (user?.scam_alerts_last_sync) {
            setLastSyncTime(new Date(user.scam_alerts_last_sync));
        }
    }, [user]);

    const { data: alerts = [], isLoading, refetch } = useQuery({
        queryKey: ['scamAlerts'],
        queryFn: async () => {
            const data = await base44.entities.ScamAlert.list('-publish_date');
            return data;
        },
        initialData: [],
    });

    // Auto-sync daily if no sync in last 24 hours
    React.useEffect(() => {
        if (!user || isSyncing || isLoading) return;

        const checkAndSync = async () => {
            const now = new Date();
            
            // If never synced OR last sync was more than 24 hours ago
            if (!user.scam_alerts_last_sync) {
                console.log('No previous sync found, auto-syncing...');
                await syncFromIC3();
                return;
            }

            const lastSync = new Date(user.scam_alerts_last_sync);
            const hoursSinceSync = (now - lastSync) / (1000 * 60 * 60);

            if (hoursSinceSync > 24) {
                console.log('Auto-syncing alerts (last sync was', Math.floor(hoursSinceSync / 24), 'days ago)');
                await syncFromIC3();
            }
        };

        checkAndSync();
    }, [user?.id]);

    const viewMutation = useMutation({
        mutationFn: (alertId) => base44.entities.ScamAlert.update(alertId, {
            view_count: (alerts.find(a => a.id === alertId)?.view_count || 0) + 1
        }),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['scamAlerts'] });
        },
    });

    const shareMutation = useMutation({
        mutationFn: (alertId) => base44.entities.ScamAlert.update(alertId, {
            share_count: (alerts.find(a => a.id === alertId)?.share_count || 0) + 1
        }),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['scamAlerts'] });
        },
    });

    const syncFromIC3 = async () => {
        setIsSyncing(true);
        try {
            toast.loading("Fetching latest scam alerts from FBI IC3...");

            const prompt = `Visit https://www.ic3.gov/CSA and extract the latest public service announcements and crime alerts related to real estate fraud, wire fraud, title fraud, and rental scams.

For EACH alert, provide:
- title: Alert headline from IC3
- description: Brief 2-3 sentence summary
- how_it_works: How the scam operates (2-3 sentences)
- warning_signs: Array of 3-5 red flags
- prevention_steps: Array of 3-5 prevention measures
- financial_impact: Typical loss range
- alert_type: One of: wire_fraud, title_fraud, rental_scam, phishing, identity_theft, escrow_fraud, listing_hijacking, fake_buyer, fake_seller, other
- severity: One of: critical, high, medium, low
- affected_parties: Array from: agents, buyers, sellers, brokers
- source_url: IC3 link to the alert
- publish_date: Publication date in YYYY-MM-DD format

Return 5-8 alerts focusing on:
1. Real estate wire fraud
2. Title/deed fraud  
3. Rental scams
4. Business email compromise
5. Fake escrow companies

Use REAL data from IC3.gov. Keep all text concise and avoid special characters that could break JSON.`;

            const response = await base44.integrations.Core.InvokeLLM({
                prompt,
                add_context_from_internet: true,
                response_json_schema: {
                    type: "object",
                    properties: {
                        alerts: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    title: { type: "string" },
                                    description: { type: "string" },
                                    how_it_works: { type: "string" },
                                    warning_signs: { 
                                        type: "array", 
                                        items: { type: "string" }
                                    },
                                    prevention_steps: { 
                                        type: "array", 
                                        items: { type: "string" }
                                    },
                                    financial_impact: { type: "string" },
                                    alert_type: { type: "string" },
                                    severity: { type: "string" },
                                    affected_parties: { 
                                        type: "array", 
                                        items: { type: "string" }
                                    },
                                    source_url: { type: "string" },
                                    publish_date: { type: "string" }
                                },
                                required: ["title", "description", "alert_type", "severity"]
                            }
                        }
                    },
                    required: ["alerts"]
                }
            });

            if (!response || !response.alerts || !Array.isArray(response.alerts)) {
                console.error("Invalid response from LLM:", response);
                toast.error("Failed to fetch alerts. Invalid response format.");
                setIsSyncing(false);
                return;
            }

            if (response.alerts.length === 0) {
                toast.error("No new alerts found.");
                setIsSyncing(false);
                return;
            }

            const createdAlerts = [];
            const now = new Date();

            for (let i = 0; i < response.alerts.length; i++) {
                const alert = response.alerts[i];
                try {
                    // Check if alert with similar title already exists
                    const existingAlert = alerts.find(a => 
                        a.title.toLowerCase().includes(alert.title.toLowerCase().substring(0, 20))
                    );

                    if (existingAlert) {
                        console.log(`Alert already exists: ${alert.title}`);
                        continue;
                    }

                    const publishDate = alert.publish_date 
                        ? new Date(alert.publish_date) 
                        : new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));

                    // Determine if trending based on severity and recent date
                    const daysSincePublish = (now - publishDate) / (1000 * 60 * 60 * 24);
                    const isTrending = (alert.severity === 'critical' || alert.severity === 'high') && daysSincePublish < 30;

                    const protectionFeatures = [
                        "Secure document management with audit trails",
                        "Encrypted communication channels",
                        "AI-powered transaction monitoring",
                        "Multi-factor authentication for all users",
                        "Real-time scam alert notifications",
                        "Automated wire instruction verification",
                        "Digital signature verification"
                    ];

                    const recommendedActions = [
                        "Review all wire transfer instructions with clients via phone",
                        "Verify sender email addresses carefully",
                        "Never send sensitive information via unsecured email",
                        "Enable multi-factor authentication on all accounts",
                        "Report suspicious activity immediately"
                    ];

                    const newAlert = await base44.entities.ScamAlert.create({
                        title: alert.title || "Real Estate Security Alert",
                        alert_type: alert.alert_type || "other",
                        severity: alert.severity || "medium",
                        description: alert.description || "Important security information for real estate professionals",
                        how_it_works: alert.how_it_works || "",
                        warning_signs: JSON.stringify(alert.warning_signs || []),
                        prevention_steps: JSON.stringify(alert.prevention_steps || []),
                        real_case_example: "", // Will be populated separately if needed
                        financial_impact: alert.financial_impact || "Varies",
                        affected_parties: JSON.stringify(alert.affected_parties || ["agents", "buyers", "sellers"]),
                        geographic_focus: "United States",
                        source: "FBI Internet Crime Complaint Center (IC3)",
                        source_url: alert.source_url || "https://www.ic3.gov/CSA",
                        publish_date: publishDate.toISOString(),
                        is_active: true,
                        is_trending: isTrending,
                        protection_features: JSON.stringify(protectionFeatures),
                        recommended_actions: JSON.stringify(recommendedActions),
                        related_links: JSON.stringify([
                            "https://www.ic3.gov",
                            "https://www.nar.realtor/safety",
                            "https://www.fbi.gov/scams-and-safety/common-scams-and-crimes/real-estate-fraud"
                        ]),
                        client_facing: true,
                        view_count: 0,
                        share_count: 0,
                        tags: `${alert.alert_type},fraud,security,${alert.severity}`
                    });

                    createdAlerts.push(newAlert);
                } catch (alertError) {
                    console.error("Error creating alert:", alertError);
                }
            }

            toast.dismiss();

            // Update last sync time in user profile
            const syncTime = new Date();
            await base44.auth.updateMe({ 
                scam_alerts_last_sync: syncTime.toISOString() 
            });
            setLastSyncTime(syncTime);

            if (createdAlerts.length === 0) {
                toast.success("Your alerts are up to date!");
            } else {
                toast.success(`${createdAlerts.length} new scam alerts loaded from FBI IC3!`);
            }

            await refetch();
            queryClient.invalidateQueries({ queryKey: ['user'] });

        } catch (error) {
            console.error("Error syncing from IC3:", error);
            toast.dismiss();
            toast.error("Failed to fetch alerts from IC3. Please try again.");
        } finally {
            setIsSyncing(false);
        }
    };

    const filteredAlerts = useMemo(() => {
        return alerts.filter(alert => {
            if (!alert.is_active) return false;
            
            const matchesSearch = !searchTerm || 
                alert.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                alert.description?.toLowerCase().includes(searchTerm.toLowerCase());
            
            const matchesType = selectedType === 'all' || alert.alert_type === selectedType;
            const matchesSeverity = selectedSeverity === 'all' || alert.severity === selectedSeverity;
            
            const matchesTab = 
                activeTab === 'all' ||
                (activeTab === 'trending' && alert.is_trending) ||
                (activeTab === 'critical' && alert.severity === 'critical');
            
            return matchesSearch && matchesType && matchesSeverity && matchesTab;
        });
    }, [alerts, searchTerm, selectedType, selectedSeverity, activeTab]);

    const handleExpand = (alertId) => {
        if (expandedAlert !== alertId) {
            viewMutation.mutate(alertId);
        }
        setExpandedAlert(expandedAlert === alertId ? null : alertId);
    };

    const handleShare = async (alert) => {
        if (navigator.share) {
            try {
                await navigator.share({
                    title: alert.title,
                    text: alert.description,
                    url: window.location.href
                });
                shareMutation.mutate(alert.id);
                toast.success('Shared successfully!');
            } catch (error) {
                if (error.name !== 'AbortError') {
                    toast.error('Failed to share');
                }
            }
        } else {
            navigator.clipboard.writeText(window.location.href);
            shareMutation.mutate(alert.id);
            toast.success('Link copied to clipboard!');
        }
    };

    const stats = useMemo(() => {
        const activeAlerts = alerts.filter(a => a.is_active);
        return {
            total: activeAlerts.length,
            critical: activeAlerts.filter(a => a.severity === 'critical').length,
            trending: activeAlerts.filter(a => a.is_trending).length,
            totalViews: activeAlerts.reduce((sum, a) => sum + (a.view_count || 0), 0)
        };
    }, [alerts]);

    return (
        <div className="p-6 space-y-6 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 min-h-screen">
            {/* Header */}
            <div className="flex flex-col gap-4">
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center gap-4">
                            <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-red-600 to-orange-600 flex items-center justify-center">
                                <Shield className="w-7 h-7 text-white" />
                            </div>
                            <div className="flex-1">
                                <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Scam Alerts & Fraud Prevention</h1>
                                <p className="text-slate-600 dark:text-slate-400 mt-1">
                                    Real-time alerts from FBI IC3 and industry sources
                                </p>
                                {lastSyncTime && (
                                    <p className="text-xs text-slate-500 mt-1">
                                        Last synced: {format(lastSyncTime, 'MMM d, yyyy h:mm a')}
                                    </p>
                                )}
                            </div>
                            <Button
                                onClick={syncFromIC3}
                                disabled={isSyncing}
                                className="bg-red-600 hover:bg-red-700"
                                size="lg"
                            >
                                {isSyncing ? (
                                    <>
                                        <RefreshCw className="w-5 h-5 mr-2 animate-spin" />
                                        Syncing from IC3...
                                    </>
                                ) : (
                                    <>
                                        <RefreshCw className="w-5 h-5 mr-2" />
                                        Sync Latest Alerts
                                    </>
                                )}
                            </Button>
                        </div>
                    </CardContent>
                </Card>

                {/* Stats */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <Card className="bg-gradient-to-br from-red-500 to-red-600 text-white">
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-red-100 text-sm">Critical Alerts</p>
                                    <p className="text-3xl font-bold">{stats.critical}</p>
                                </div>
                                <AlertTriangle className="w-10 h-10 text-red-200" />
                            </div>
                        </CardContent>
                    </Card>

                    <Card className="bg-gradient-to-br from-orange-500 to-orange-600 text-white">
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-orange-100 text-sm">Trending Now</p>
                                    <p className="text-3xl font-bold">{stats.trending}</p>
                                </div>
                                <TrendingUp className="w-10 h-10 text-orange-200" />
                            </div>
                        </CardContent>
                    </Card>

                    <Card className="bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-blue-100 text-sm">Total Alerts</p>
                                    <p className="text-3xl font-bold">{stats.total}</p>
                                </div>
                                <Shield className="w-10 h-10 text-blue-200" />
                            </div>
                        </CardContent>
                    </Card>

                    <Card className="bg-gradient-to-br from-purple-500 to-purple-600 text-white">
                        <CardContent className="p-4">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-purple-100 text-sm">Community Views</p>
                                    <p className="text-3xl font-bold">{stats.totalViews.toLocaleString()}</p>
                                </div>
                                <Eye className="w-10 h-10 text-purple-200" />
                            </div>
                        </CardContent>
                    </Card>
                </div>
            </div>

            {/* Filters and Search */}
            <Card>
                <CardContent className="p-4">
                    <div className="flex flex-col md:flex-row gap-4">
                        <div className="flex-1">
                            <div className="relative">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                                <Input
                                    placeholder="Search scam alerts..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="pl-10"
                                />
                            </div>
                        </div>
                        <select
                            value={selectedType}
                            onChange={(e) => setSelectedType(e.target.value)}
                            className="px-4 py-2 border rounded-lg bg-white dark:bg-slate-800"
                        >
                            <option value="all">All Types</option>
                            {Object.entries(alertTypeConfig).map(([key, config]) => (
                                <option key={key} value={key}>{config.label}</option>
                            ))}
                        </select>
                        <select
                            value={selectedSeverity}
                            onChange={(e) => setSelectedSeverity(e.target.value)}
                            className="px-4 py-2 border rounded-lg bg-white dark:bg-slate-800"
                        >
                            <option value="all">All Severities</option>
                            {Object.entries(severityConfig).map(([key, config]) => (
                                <option key={key} value={key}>{config.label}</option>
                            ))}
                        </select>
                        <Button
                            onClick={syncFromIC3}
                            disabled={isSyncing}
                            variant="outline"
                        >
                            {isSyncing ? (
                                <>
                                    <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                                    Syncing...
                                </>
                            ) : (
                                <>
                                    <RefreshCw className="w-4 h-4 mr-2" />
                                    Refresh
                                </>
                            )}
                        </Button>
                    </div>
                </CardContent>
            </Card>

            {/* Tabs */}
            <Tabs value={activeTab} onValueChange={setActiveTab}>
                <TabsList className="grid w-full grid-cols-3">
                    <TabsTrigger value="all">All Alerts</TabsTrigger>
                    <TabsTrigger value="trending">Trending</TabsTrigger>
                    <TabsTrigger value="critical">Critical</TabsTrigger>
                </TabsList>

                <TabsContent value={activeTab} className="space-y-4 mt-6">
                    <AnimatePresence>
                        {filteredAlerts.map((alert, index) => (
                            <ScamAlertCard
                                key={alert.id}
                                alert={alert}
                                isExpanded={expandedAlert === alert.id}
                                onToggle={() => handleExpand(alert.id)}
                                onShare={() => handleShare(alert)}
                                index={index}
                            />
                        ))}
                    </AnimatePresence>

                    {filteredAlerts.length === 0 && (
                        <Card className="text-center py-12">
                            <CardContent>
                                <Shield className="w-16 h-16 text-slate-300 mx-auto mb-4" />
                                <p className="text-slate-600 dark:text-slate-400">
                                    {searchTerm ? 'No alerts match your search' : 'No scam alerts available'}
                                </p>
                                <Button 
                                    onClick={syncFromIC3} 
                                    className="mt-4"
                                    disabled={isSyncing}
                                >
                                    {isSyncing ? 'Syncing...' : 'Sync from FBI IC3'}
                                </Button>
                            </CardContent>
                        </Card>
                    )}
                </TabsContent>
            </Tabs>
        </div>
    );
}

function ScamAlertCard({ alert, isExpanded, onToggle, onShare, index }) {
    const typeConfig = alertTypeConfig[alert.alert_type] || alertTypeConfig.other;
    const alertSeverity = severityConfig[alert.severity] || severityConfig.medium;
    const TypeIcon = typeConfig.icon;

    let warningSigns = [];
    let preventionSteps = [];
    let protectionFeatures = [];
    let affectedParties = [];

    try {
        warningSigns = alert.warning_signs ? JSON.parse(alert.warning_signs) : [];
        preventionSteps = alert.prevention_steps ? JSON.parse(alert.prevention_steps) : [];
        protectionFeatures = alert.protection_features ? JSON.parse(alert.protection_features) : [];
        affectedParties = alert.affected_parties ? JSON.parse(alert.affected_parties) : [];
    } catch (e) {
        console.error('Error parsing alert data:', e);
    }

    return (
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            transition={{ delay: index * 0.05 }}
        >
            <Card className={`overflow-hidden border-l-4 ${isExpanded ? alertSeverity.ring + ' ring-2' : ''}`}
                  style={{ borderLeftColor: typeConfig.color.replace('bg-', '#') }}>
                <CardHeader className="cursor-pointer" onClick={onToggle}>
                    <div className="flex items-start justify-between gap-4">
                        <div className="flex items-start gap-4 flex-1">
                            <div className={`p-3 rounded-lg ${typeConfig.color} text-white`}>
                                <TypeIcon className="w-6 h-6" />
                            </div>
                            <div className="flex-1">
                                <div className="flex items-center gap-2 flex-wrap mb-2">
                                    <Badge className={alertSeverity.color}>
                                        {alertSeverity.label}
                                    </Badge>
                                    <Badge variant="outline">{typeConfig.label}</Badge>
                                    {alert.is_trending && (
                                        <Badge className="bg-orange-600 text-white">
                                            <TrendingUp className="w-3 h-3 mr-1" />
                                            Trending
                                        </Badge>
                                    )}
                                    {alert.client_facing && (
                                        <Badge variant="outline" className="text-green-600">
                                            Client-Safe
                                        </Badge>
                                    )}
                                </div>
                                <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
                                    {alert.title}
                                </h3>
                                <p className="text-slate-600 dark:text-slate-400 text-sm">
                                    {alert.description}
                                </p>
                                <div className="flex items-center gap-4 mt-3 text-xs text-slate-500">
                                    {alert.publish_date && (
                                        <span className="flex items-center gap-1">
                                            <Calendar className="w-3 h-3" />
                                            {format(parseISO(alert.publish_date), 'MMM d, yyyy')}
                                        </span>
                                    )}
                                    <span className="flex items-center gap-1">
                                        <Eye className="w-3 h-3" />
                                        {alert.view_count || 0} views
                                    </span>
                                    {alert.financial_impact && (
                                        <span className="flex items-center gap-1">
                                            <DollarSign className="w-3 h-3" />
                                            {alert.financial_impact}
                                        </span>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <Button
                                variant="ghost"
                                size="icon"
                                onClick={(e) => {
                                    e.stopPropagation();
                                    onShare();
                                }}
                            >
                                <Share2 className="w-4 h-4" />
                            </Button>
                            <Button variant="ghost" size="icon">
                                {isExpanded ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                            </Button>
                        </div>
                    </div>
                </CardHeader>

                <AnimatePresence>
                    {isExpanded && (
                        <motion.div
                            initial={{ height: 0, opacity: 0 }}
                            animate={{ height: 'auto', opacity: 1 }}
                            exit={{ height: 0, opacity: 0 }}
                        >
                            <CardContent className="pt-0 space-y-6">
                                {/* How It Works */}
                                {alert.how_it_works && (
                                    <div>
                                        <h4 className="font-semibold text-lg mb-3 flex items-center gap-2">
                                            <Info className="w-5 h-5 text-blue-600" />
                                            How This Scam Works
                                        </h4>
                                        <p className="text-slate-700 dark:text-slate-300 bg-slate-50 dark:bg-slate-900 p-4 rounded-lg">
                                            {alert.how_it_works}
                                        </p>
                                    </div>
                                )}

                                {/* Warning Signs */}
                                {warningSigns.length > 0 && (
                                    <div>
                                        <h4 className="font-semibold text-lg mb-3 flex items-center gap-2">
                                            <AlertTriangle className="w-5 h-5 text-red-600" />
                                            Warning Signs
                                        </h4>
                                        <ul className="space-y-2">
                                            {warningSigns.map((sign, idx) => (
                                                <li key={idx} className="flex items-start gap-2 text-slate-700 dark:text-slate-300">
                                                    <X className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                                                    <span>{sign}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {/* Prevention Steps */}
                                {preventionSteps.length > 0 && (
                                    <div>
                                        <h4 className="font-semibold text-lg mb-3 flex items-center gap-2">
                                            <CheckCircle className="w-5 h-5 text-green-600" />
                                            How to Protect Yourself
                                        </h4>
                                        <ul className="space-y-2">
                                            {preventionSteps.map((step, idx) => (
                                                <li key={idx} className="flex items-start gap-2 text-slate-700 dark:text-slate-300">
                                                    <CheckCircle className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
                                                    <span>{step}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {/* Real Case Example */}
                                {alert.real_case_example && (
                                    <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                                        <h4 className="font-semibold text-lg mb-2 flex items-center gap-2 text-yellow-900 dark:text-yellow-100">
                                            <FileText className="w-5 h-5" />
                                            Real Case Example
                                        </h4>
                                        <p className="text-yellow-900 dark:text-yellow-100 text-sm">
                                            {alert.real_case_example}
                                        </p>
                                    </div>
                                )}

                                {/* PropertySync Protection */}
                                {protectionFeatures.length > 0 && (
                                    <div className="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                                        <h4 className="font-semibold text-lg mb-3 flex items-center gap-2 text-blue-900 dark:text-blue-100">
                                            <Shield className="w-5 h-5" />
                                            How RealtyMind Protects You
                                        </h4>
                                        <ul className="space-y-2">
                                            {protectionFeatures.map((feature, idx) => (
                                                <li key={idx} className="flex items-start gap-2 text-blue-900 dark:text-blue-100 text-sm">
                                                    <CheckCircle className="w-4 h-4 flex-shrink-0 mt-0.5" />
                                                    <span>{feature}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {/* Source and Actions */}
                                <div className="flex items-center justify-between pt-4 border-t">
                                    <div className="flex items-center gap-2 text-sm text-slate-500">
                                        <span>Source: {alert.source}</span>
                                        {alert.source_url && (
                                            <a
                                                href={alert.source_url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="text-blue-600 hover:underline flex items-center gap-1"
                                            >
                                                View Original
                                                <ExternalLink className="w-3 h-3" />
                                            </a>
                                        )}
                                    </div>
                                    {alert.tags && (
                                        <div className="flex flex-wrap gap-1">
                                            {alert.tags.split(',').filter(Boolean).slice(0, 3).map((tag, idx) => (
                                                <Badge key={idx} variant="outline" className="text-xs">
                                                    {tag.trim()}
                                                </Badge>
                                            ))}
                                        </div>
                                    )}
                                    {alert.downloadable_pdf_url && (
                                        <Button variant="outline" size="sm" asChild>
                                            <a href={alert.downloadable_pdf_url} download>
                                                <Download className="w-4 h-4 mr-2" />
                                                Download PDF
                                            </a>
                                        </Button>
                                    )}
                                </div>
                            </CardContent>
                        </motion.div>
                    )}
                </AnimatePresence>
            </Card>
        </motion.div>
    );
}

import React, { useState, useEffect } from "react";
import { Showing } from "@/api/entities";
import { Property } from "@/api/entities";
import { Notification } from "@/api/entities";
import { User } from "@/api/entities";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Calendar, Clock, Home, CheckCircle } from "lucide-react";
import { toast } from "sonner";

export default function ScheduleShowing() {
  const [properties, setProperties] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [formData, setFormData] = useState({
    property_id: "",
    buyer_name: "",
    buyer_email: "",
    buyer_phone: "",
    scheduled_date: "",
    scheduled_time: "",
    notes: ""
  });

  useEffect(() => {
    loadProperties();
  }, []);

  const loadProperties = async () => {
    try {
      const props = await Property.list();
      // Only show active properties
      setProperties((props || []).filter(p => p.status === 'active'));
    } catch (error) {
      console.error("Error loading properties:", error);
    }
    setIsLoading(false);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsSubmitting(true);

    try {
      // Get current user (if logged in) or use null
      let currentUser = null;
      try {
        currentUser = await User.me();
      } catch (err) {
        // User not logged in, that's okay for public requests
      }

      // Create showing request
      const showing = await Showing.create({
        ...formData,
        showing_agent_id: currentUser?.id || null,
        status: 'scheduled',
        duration_minutes: 30
      });

      // Create notification for property agent
      const property = properties.find(p => p.id === formData.property_id);
      if (property && property.listing_agent_id) {
        await Notification.create({
          user_id: property.listing_agent_id,
          title: 'New Showing Request',
          message: `${formData.buyer_name} has requested a showing for ${property.address} on ${formData.scheduled_date} at ${formData.scheduled_time}`,
          notification_type: 'system_alert',
          priority: 'high',
          related_entity_type: 'showing',
          related_entity_id: showing.id,
          action_url: '/showings',
          delivery_methods: ['in_app', 'email']
        });
      }

      setSubmitted(true);
      toast.success("Showing request submitted successfully!");

    } catch (error) {
      console.error("Error submitting showing request:", error);
      toast.error("Failed to submit showing request. Please try again.");
    }

    setIsSubmitting(false);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-pulse text-center">
          <Home className="w-12 h-12 mx-auto mb-4 text-slate-400" />
          <p className="text-slate-600">Loading properties...</p>
        </div>
      </div>
    );
  }

  if (submitted) {
    return (
      <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
        <div className="max-w-md w-full bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 text-center">
          <div className="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
            <CheckCircle className="w-8 h-8 text-green-600 dark:text-green-400" />
          </div>
          <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-3">
            Request Submitted!
          </h2>
          <p className="text-slate-600 dark:text-slate-400 mb-6">
            Your showing request has been sent. The listing agent will contact you shortly to confirm the appointment.
          </p>
          <Button
            onClick={() => {
              setSubmitted(false);
              setFormData({
                property_id: "",
                buyer_name: "",
                buyer_email: "",
                buyer_phone: "",
                scheduled_date: "",
                scheduled_time: "",
                notes: ""
              });
            }}
            className="w-full"
          >
            Schedule Another Showing
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="p-4">
      <div className="space-y-6">
        <div className="max-w-2xl mx-auto">
          <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden">
            {/* Header */}
            <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-white">
              <div className="flex items-center gap-3 mb-2">
                <Calendar className="w-8 h-8" />
                <h1 className="text-3xl font-bold">Schedule a Showing</h1>
              </div>
              <p className="text-indigo-100">
                Request to view a property at your convenience
              </p>
            </div>

            {/* Form */}
            <form onSubmit={handleSubmit} className="p-8 space-y-6">
              {/* Property Selection */}
              <div className="space-y-2">
                <Label htmlFor="property_id">Select Property *</Label>
                <Select
                  value={formData.property_id}
                  onValueChange={(value) => setFormData({...formData, property_id: value})}
                  required
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Choose a property..." />
                  </SelectTrigger>
                  <SelectContent>
                    {properties.length > 0 ? (
                      properties.map(property => (
                        <SelectItem key={property.id} value={property.id}>
                          {property.address} - ${(property.price / 1000000).toFixed(2)}M
                        </SelectItem>
                      ))
                    ) : (
                      <SelectItem value="none" disabled>
                        No properties available
                      </SelectItem>
                    )}
                  </SelectContent>
                </Select>
              </div>

              {/* Contact Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="buyer_name">Your Name *</Label>
                  <Input
                    id="buyer_name"
                    value={formData.buyer_name}
                    onChange={(e) => setFormData({...formData, buyer_name: e.target.value})}
                    placeholder="John Smith"
                    required
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="buyer_email">Email *</Label>
                  <Input
                    id="buyer_email"
                    type="email"
                    value={formData.buyer_email}
                    onChange={(e) => setFormData({...formData, buyer_email: e.target.value})}
                    placeholder="john@example.com"
                    required
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="buyer_phone">Phone Number *</Label>
                <Input
                  id="buyer_phone"
                  value={formData.buyer_phone}
                  onChange={(e) => setFormData({...formData, buyer_phone: e.target.value})}
                  placeholder="(555) 123-4567"
                  required
                />
              </div>

              {/* Schedule */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="scheduled_date">Preferred Date *</Label>
                  <Input
                    id="scheduled_date"
                    type="date"
                    value={formData.scheduled_date}
                    onChange={(e) => setFormData({...formData, scheduled_date: e.target.value})}
                    min={new Date().toISOString().split('T')[0]}
                    required
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="scheduled_time">Preferred Time *</Label>
                  <Input
                    id="scheduled_time"
                    type="time"
                    value={formData.scheduled_time}
                    onChange={(e) => setFormData({...formData, scheduled_time: e.target.value})}
                    required
                  />
                </div>
              </div>

              {/* Notes */}
              <div className="space-y-2">
                <Label htmlFor="notes">Additional Notes (Optional)</Label>
                <Textarea
                  id="notes"
                  value={formData.notes}
                  onChange={(e) => setFormData({...formData, notes: e.target.value})}
                  placeholder="Any specific requirements or questions..."
                  rows={4}
                />
              </div>

              {/* Submit Button */}
              <Button
                type="submit"
                disabled={isSubmitting}
                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-lg py-6"
              >
                {isSubmitting ? (
                  <>
                    <Clock className="w-5 h-5 mr-2 animate-spin" />
                    Submitting Request...
                  </>
                ) : (
                  <>
                    <Calendar className="w-5 h-5 mr-2" />
                    Request Showing
                  </>
                )}
              </Button>

              <p className="text-sm text-slate-600 dark:text-slate-400 text-center">
                Your request will be sent to the listing agent who will contact you to confirm the appointment.
              </p>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

import React from 'react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Brain, Sparkles, MessageSquare, CheckCircle, ArrowRight, Target, Lightbulb } from 'lucide-react';

export default function ServiceAIInsights() {
    const navigate = useNavigate();

    const benefits = [
        {
            icon: Brain,
            title: "Predictive Lead Scoring",
            description: "AI analyzes 50+ data points to predict which leads are most likely to convert, helping you prioritize your time effectively."
        },
        {
            icon: MessageSquare,
            title: "Smart Communication Tips",
            description: "Get AI-suggested talking points, email templates, and follow-up strategies personalized for each client's situation."
        },
        {
            icon: Target,
            title: "Market Insights",
            description: "Real-time analysis of market trends, pricing strategies, and neighborhood data to position yourself as the expert."
        },
        {
            icon: Lightbulb,
            title: "Opportunity Detection",
            description: "AI monitors your database and alerts you to opportunities like price drops, life events, and perfect timing for outreach."
        }
    ];

    const features = [
        "Daily AI-generated business insights",
        "Lead behavior analysis and predictions",
        "Optimal follow-up timing recommendations",
        "Client sentiment analysis from communications",
        "Automated market reports and CMAs",
        "Property match scoring for buyers",
        "Social media intelligence from public profiles",
        "Deal risk assessment and alerts"
    ];

    const useCases = [
        {
            title: "Close More Deals",
            description: "AI identifies which leads need immediate attention and suggests the perfect approach for each conversation.",
            impact: "23% increase in conversion rates"
        },
        {
            title: "Save Time",
            description: "Stop guessing and manually researching. Get instant AI insights that would take hours to compile yourself.",
            impact: "12+ hours saved weekly"
        },
        {
            title: "Stay Ahead",
            description: "Be the first to know about market shifts, client needs, and opportunities in your pipeline.",
            impact: "47% faster response time"
        }
    ];

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950">
            {/* Header */}
            <header className="sticky top-0 z-50 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={() => navigate(createPageUrl('Website'))} className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/50">
                                <Brain className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <span className="text-xl font-bold text-slate-900 dark:text-white">RealtyMind</span>
                                <p className="text-xs text-slate-600 dark:text-slate-400">The Mind Behind Every Deal</p>
                            </div>
                        </button>
                        <Button onClick={() => navigate(createPageUrl('Dashboard'))} className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500">
                            Login / Get Started
                        </Button>
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto pb-2">
                        <button onClick={() => navigate(createPageUrl('ServiceLeadManagement'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Lead Management</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAIInsights'))} className="px-4 py-2 rounded-lg text-sm bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-medium whitespace-nowrap">AI Insights</button>
                        <button onClick={() => navigate(createPageUrl('ServiceTransactionPipeline'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Transactions</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAutomatedFollowups'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Follow-ups</button>
                        <button onClick={() => navigate(createPageUrl('ServiceDocumentIntelligence'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Documents</button>
                        <button onClick={() => navigate(createPageUrl('ServiceMarketingAutomation'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Marketing</button>
                    </div>
                </div>
            </header>

            {/* Hero Section */}
            <section className="py-20 px-4">
                <div className="max-w-5xl mx-auto text-center">
                    <div className="inline-flex items-center gap-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-4 py-2 rounded-full text-sm font-medium mb-6">
                        <Sparkles className="w-4 h-4" />
                        AI-Powered Insights
                    </div>
                    <h1 className="text-5xl md:text-6xl font-bold text-slate-900 dark:text-white mb-6">
                        Your Personal AI <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">Real Estate Advisor</span>
                    </h1>
                    <p className="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-3xl mx-auto">
                        Make smarter decisions with AI that analyzes your business 24/7, providing actionable insights that help you close more deals and serve clients better.
                    </p>
                    <Button size="lg" className="bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:from-purple-700 hover:to-pink-700">
                        Experience AI Magic <ArrowRight className="w-5 h-5 ml-2" />
                    </Button>
                </div>
            </section>

            {/* Benefits Section */}
            <section className="py-20 px-4">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-4">
                        AI That Actually Helps You Sell
                    </h2>
                    <p className="text-center text-slate-600 dark:text-slate-400 mb-12 max-w-2xl mx-auto">
                        Not just fancy technology‚Äîreal insights that translate to more commissions in your pocket.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {benefits.map((benefit, idx) => (
                            <Card key={idx} className="border-2 border-slate-200 dark:border-slate-800 hover:border-purple-500 dark:hover:border-purple-500 transition-all">
                                <CardContent className="p-6">
                                    <div className="w-12 h-12 bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 rounded-lg flex items-center justify-center mb-4">
                                        <benefit.icon className="w-6 h-6 text-purple-600 dark:text-purple-400" />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
                                        {benefit.title}
                                    </h3>
                                    <p className="text-slate-600 dark:text-slate-400">
                                        {benefit.description}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            </section>

            {/* Use Cases */}
            <section className="py-20 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-12">
                        Real Results from Real Agents
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {useCases.map((useCase, idx) => (
                            <div key={idx} className="text-center">
                                <div className="bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 rounded-2xl p-8 mb-4">
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-3">
                                        {useCase.title}
                                    </h3>
                                    <p className="text-slate-600 dark:text-slate-400 mb-4">
                                        {useCase.description}
                                    </p>
                                    <div className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                                        {useCase.impact}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* Features List */}
            <section className="py-20 px-4">
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-12">
                        AI Features That Work for You
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {features.map((feature, idx) => (
                            <div key={idx} className="flex items-start gap-3">
                                <CheckCircle className="w-6 h-6 text-purple-500 flex-shrink-0 mt-0.5" />
                                <span className="text-slate-700 dark:text-slate-300">{feature}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* CTA Section */}
            <section className="py-20 px-4 bg-gradient-to-r from-purple-600 to-pink-600">
                <div className="max-w-4xl mx-auto text-center">
                    <h2 className="text-4xl font-bold text-white mb-4">
                        Let AI Be Your Secret Weapon
                    </h2>
                    <p className="text-xl text-white/90 mb-8">
                        Top agents are already using AI to dominate their markets. Don't get left behind.
                    </p>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <Button size="lg" variant="secondary" className="bg-white text-purple-600 hover:bg-slate-100">
                            Start Free Trial
                        </Button>
                        <Button size="lg" variant="outline" className="border-white text-white hover:bg-white/10">
                            See AI in Action
                        </Button>
                    </div>
                </div>
            </section>
        </div>
    );
}
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Send, Clock, Users, CheckCircle, ArrowRight, TrendingUp, Mail, Brain } from 'lucide-react';

export default function ServiceAutomatedFollowups() {
    const navigate = useNavigate();

    const benefits = [
        {
            icon: Clock,
            title: "Never Forget to Follow Up",
            description: "AI automatically schedules and sends follow-ups at the optimal time based on client behavior and engagement patterns."
        },
        {
            icon: Mail,
            title: "Personalized Messages",
            description: "Each follow-up is customized with the client's name, property preferences, and conversation history‚Äînever generic."
        },
        {
            icon: TrendingUp,
            title: "Higher Response Rates",
            description: "AI-optimized timing and messaging increase your response rates by up to 3x compared to manual follow-ups."
        },
        {
            icon: Users,
            title: "Nurture Every Lead",
            description: "Keep hundreds of leads warm simultaneously without lifting a finger. Turn cold leads into hot prospects over time."
        }
    ];

    const features = [
        "AI-powered timing optimization",
        "Personalized email templates",
        "SMS and email sequences",
        "Drip campaigns for long-term nurturing",
        "Trigger-based follow-ups (price drops, new listings)",
        "Open and click tracking",
        "A/B testing for message optimization",
        "Manual override and customization"
    ];

    const stats = [
        { value: "80%", label: "Of Sales Require 5+ Follow-ups" },
        { value: "44%", label: "Of Agents Give Up After 1 Follow-up" },
        { value: "3x", label: "Higher Response Rate with Automation" }
    ];

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950">
            {/* Header */}
            <header className="sticky top-0 z-50 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={() => navigate(createPageUrl('Website'))} className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/50">
                                <Brain className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <span className="text-xl font-bold text-slate-900 dark:text-white">RealtyMind</span>
                                <p className="text-xs text-slate-600 dark:text-slate-400">The Mind Behind Every Deal</p>
                            </div>
                        </button>
                        <Button onClick={() => navigate(createPageUrl('Dashboard'))} className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500">
                            Login / Get Started
                        </Button>
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto pb-2">
                        <button onClick={() => navigate(createPageUrl('ServiceLeadManagement'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Lead Management</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAIInsights'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">AI Insights</button>
                        <button onClick={() => navigate(createPageUrl('ServiceTransactionPipeline'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Transactions</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAutomatedFollowups'))} className="px-4 py-2 rounded-lg text-sm bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-medium whitespace-nowrap">Follow-ups</button>
                        <button onClick={() => navigate(createPageUrl('ServiceDocumentIntelligence'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Documents</button>
                        <button onClick={() => navigate(createPageUrl('ServiceMarketingAutomation'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Marketing</button>
                    </div>
                </div>
            </header>

            {/* Hero Section */}
            <section className="py-20 px-4">
                <div className="max-w-5xl mx-auto text-center">
                    <div className="inline-flex items-center gap-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-4 py-2 rounded-full text-sm font-medium mb-6">
                        <Send className="w-4 h-4" />
                        Automated Follow-ups
                    </div>
                    <h1 className="text-5xl md:text-6xl font-bold text-slate-900 dark:text-white mb-6">
                        Stay Top of Mind <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-600">Without Lifting a Finger</span>
                    </h1>
                    <p className="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-3xl mx-auto">
                        80% of sales require 5 follow-ups, but most agents give up after 1. Let AI handle the persistence while you focus on closing deals.
                    </p>
                    <Button size="lg" className="bg-gradient-to-r from-green-600 to-emerald-600 text-white hover:from-green-700 hover:to-emerald-700">
                        Automate Follow-ups <ArrowRight className="w-5 h-5 ml-2" />
                    </Button>
                </div>
            </section>

            {/* Stats Section */}
            <section className="py-16 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-6xl mx-auto">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {stats.map((stat, idx) => (
                            <div key={idx} className="text-center">
                                <div className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-600 mb-2">
                                    {stat.value}
                                </div>
                                <div className="text-slate-600 dark:text-slate-400 font-medium">
                                    {stat.label}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* Benefits Section */}
            <section className="py-20 px-4">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-4">
                        Follow-up Like a Pro, Automatically
                    </h2>
                    <p className="text-center text-slate-600 dark:text-slate-400 mb-12 max-w-2xl mx-auto">
                        While you sleep, your AI assistant is nurturing leads, sending follow-ups, and keeping your pipeline hot.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {benefits.map((benefit, idx) => (
                            <Card key={idx} className="border-2 border-slate-200 dark:border-slate-800 hover:border-green-500 dark:hover:border-green-500 transition-all">
                                <CardContent className="p-6">
                                    <div className="w-12 h-12 bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 rounded-lg flex items-center justify-center mb-4">
                                        <benefit.icon className="w-6 h-6 text-green-600 dark:text-green-400" />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
                                        {benefit.title}
                                    </h3>
                                    <p className="text-slate-600 dark:text-slate-400">
                                        {benefit.description}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            </section>

            {/* Features List */}
            <section className="py-20 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-12">
                        Powerful Automation Features
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {features.map((feature, idx) => (
                            <div key={idx} className="flex items-start gap-3">
                                <CheckCircle className="w-6 h-6 text-green-500 flex-shrink-0 mt-0.5" />
                                <span className="text-slate-700 dark:text-slate-300">{feature}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* CTA Section */}
            <section className="py-20 px-4 bg-gradient-to-r from-green-600 to-emerald-600">
                <div className="max-w-4xl mx-auto text-center">
                    <h2 className="text-4xl font-bold text-white mb-4">
                        Stop Losing Deals to Lack of Follow-up
                    </h2>
                    <p className="text-xl text-white/90 mb-8">
                        Let AI handle the persistence while you close more deals and make more money.
                    </p>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <Button size="lg" variant="secondary" className="bg-white text-green-600 hover:bg-slate-100">
                            Start Free Trial
                        </Button>
                        <Button size="lg" variant="outline" className="border-white text-white hover:bg-white/10">
                            See It in Action
                        </Button>
                    </div>
                </div>
            </section>
        </div>
    );
}
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { FileText, Search, Shield, Zap, CheckCircle, ArrowRight, Clock, AlertCircle, Brain } from 'lucide-react';

export default function ServiceDocumentIntelligence() {
    const navigate = useNavigate();

    const benefits = [
        {
            icon: Search,
            title: "Instant Document Search",
            description: "Find any contract, disclosure, or addendum in seconds using AI-powered search. No more digging through folders and emails."
        },
        {
            icon: Zap,
            title: "Automatic Summarization",
            description: "AI reads every document and provides plain-English summaries of key terms, deadlines, and important clauses."
        },
        {
            icon: Shield,
            title: "Risk Detection",
            description: "Get alerted to unusual clauses, missing signatures, or potential legal issues before they become problems."
        },
        {
            icon: Clock,
            title: "Smart Organization",
            description: "AI automatically categorizes and tags documents by type, property, and transaction stage. Perfect organization, zero effort."
        }
    ];

    const features = [
        "AI-powered OCR for all document types",
        "Full-text search across all documents",
        "Automatic document categorization",
        "Key clause extraction and highlighting",
        "Missing signature detection",
        "Version control and history",
        "Mobile document scanning",
        "Secure cloud storage with encryption"
    ];

    const painPoints = [
        {
            problem: "Can't find that one document you need",
            solution: "AI indexes every word in every document for instant search",
            icon: Search
        },
        {
            problem: "Missing critical deadlines buried in contracts",
            solution: "AI extracts all dates and creates automatic reminders",
            icon: Clock
        },
        {
            problem: "Unsure if all signatures are collected",
            solution: "Visual checklist shows exactly what's signed and what's pending",
            icon: AlertCircle
        }
    ];

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950">
            {/* Header */}
            <header className="sticky top-0 z-50 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={() => navigate(createPageUrl('Website'))} className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/50">
                                <Brain className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <span className="text-xl font-bold text-slate-900 dark:text-white">RealtyMind</span>
                                <p className="text-xs text-slate-600 dark:text-slate-400">The Mind Behind Every Deal</p>
                            </div>
                        </button>
                        <Button onClick={() => navigate(createPageUrl('Dashboard'))} className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500">
                            Login / Get Started
                        </Button>
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto pb-2">
                        <button onClick={() => navigate(createPageUrl('ServiceLeadManagement'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Lead Management</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAIInsights'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">AI Insights</button>
                        <button onClick={() => navigate(createPageUrl('ServiceTransactionPipeline'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Transactions</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAutomatedFollowups'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Follow-ups</button>
                        <button onClick={() => navigate(createPageUrl('ServiceDocumentIntelligence'))} className="px-4 py-2 rounded-lg text-sm bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-medium whitespace-nowrap">Documents</button>
                        <button onClick={() => navigate(createPageUrl('ServiceMarketingAutomation'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Marketing</button>
                    </div>
                </div>
            </header>

            {/* Hero Section */}
            <section className="py-20 px-4">
                <div className="max-w-5xl mx-auto text-center">
                    <div className="inline-flex items-center gap-2 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-4 py-2 rounded-full text-sm font-medium mb-6">
                        <FileText className="w-4 h-4" />
                        Document Intelligence
                    </div>
                    <h1 className="text-5xl md:text-6xl font-bold text-slate-900 dark:text-white mb-6">
                        AI That <span className="text-transparent bg-clip-text bg-gradient-to-r from-orange-600 to-red-600">Reads Your Documents</span> For You
                    </h1>
                    <p className="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-3xl mx-auto">
                        Stop wasting hours searching for contracts and reviewing documents. Let AI organize, analyze, and extract what you need instantly.
                    </p>
                    <Button size="lg" className="bg-gradient-to-r from-orange-600 to-red-600 text-white hover:from-orange-700 hover:to-red-700">
                        Get Smart Documents <ArrowRight className="w-5 h-5 ml-2" />
                    </Button>
                </div>
            </section>

            {/* Pain Points Section */}
            <section className="py-20 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-4">
                        Document Nightmares? Solved.
                    </h2>
                    <p className="text-center text-slate-600 dark:text-slate-400 mb-12 max-w-2xl mx-auto">
                        The average agent spends 6+ hours per week managing documents. Get that time back.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {painPoints.map((item, idx) => (
                            <Card key={idx} className="border-2 border-slate-200 dark:border-slate-800">
                                <CardContent className="p-6">
                                    <item.icon className="w-8 h-8 text-red-500 mb-4" />
                                    <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
                                        ‚ùå {item.problem}
                                    </h3>
                                    <p className="text-slate-600 dark:text-slate-400">
                                        ‚úÖ {item.solution}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            </section>

            {/* Benefits Section */}
            <section className="py-20 px-4">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-12">
                        Documents That Work As Hard As You Do
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {benefits.map((benefit, idx) => (
                            <Card key={idx} className="border-2 border-slate-200 dark:border-slate-800 hover:border-orange-500 dark:hover:border-orange-500 transition-all">
                                <CardContent className="p-6">
                                    <div className="w-12 h-12 bg-gradient-to-br from-orange-100 to-red-100 dark:from-orange-900/30 dark:to-red-900/30 rounded-lg flex items-center justify-center mb-4">
                                        <benefit.icon className="w-6 h-6 text-orange-600 dark:text-orange-400" />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
                                        {benefit.title}
                                    </h3>
                                    <p className="text-slate-600 dark:text-slate-400">
                                        {benefit.description}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            </section>

            {/* Features List */}
            <section className="py-20 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-12">
                        Everything You Need for Document Management
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {features.map((feature, idx) => (
                            <div key={idx} className="flex items-start gap-3">
                                <CheckCircle className="w-6 h-6 text-orange-500 flex-shrink-0 mt-0.5" />
                                <span className="text-slate-700 dark:text-slate-300">{feature}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* CTA Section */}
            <section className="py-20 px-4 bg-gradient-to-r from-orange-600 to-red-600">
                <div className="max-w-4xl mx-auto text-center">
                    <h2 className="text-4xl font-bold text-white mb-4">
                        Stop Drowning in Paperwork
                    </h2>
                    <p className="text-xl text-white/90 mb-8">
                        Let AI handle your documents so you can focus on what really matters‚Äîselling homes.
                    </p>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <Button size="lg" variant="secondary" className="bg-white text-orange-600 hover:bg-slate-100">
                            Start Free Trial
                        </Button>
                        <Button size="lg" variant="outline" className="border-white text-white hover:bg-white/10">
                            Watch Demo
                        </Button>
                    </div>
                </div>
            </section>
        </div>
    );
}
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Target, TrendingUp, Users, Zap, CheckCircle, ArrowRight, Brain } from 'lucide-react';

export default function ServiceLeadManagement() {
    const navigate = useNavigate();

    const benefits = [
        {
            icon: Target,
            title: "Smart Lead Scoring",
            description: "AI automatically prioritizes your leads based on engagement, behavior, and likelihood to convert, so you focus on hot prospects first."
        },
        {
            icon: TrendingUp,
            title: "Conversion Tracking",
            description: "Track every lead from first contact to closed deal. See what's working and optimize your lead generation strategy."
        },
        {
            icon: Users,
            title: "Unified Dashboard",
            description: "All your leads from Zillow, Realtor.com, social media, and referrals in one place. No more switching between platforms."
        },
        {
            icon: Zap,
            title: "Instant Notifications",
            description: "Get alerted the moment a new lead comes in. Research shows responding within 5 minutes increases conversion by 100x."
        }
    ];

    const features = [
        "AI-powered lead scoring (0-100 scale)",
        "Automatic lead source tracking",
        "Custom lead stages and pipelines",
        "Activity timeline for every lead",
        "Email and SMS integration",
        "Mobile app for on-the-go management",
        "Lead assignment and routing",
        "Advanced filtering and segmentation"
    ];

    const stats = [
        { value: "73%", label: "Increase in Lead Response Rate" },
        { value: "2.5x", label: "More Leads Converted" },
        { value: "45 min", label: "Saved Per Day Per Agent" }
    ];

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950">
            {/* Header */}
            <header className="sticky top-0 z-50 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={() => navigate(createPageUrl('Website'))} className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/50">
                                <Brain className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <span className="text-xl font-bold text-slate-900 dark:text-white">RealtyMind</span>
                                <p className="text-xs text-slate-600 dark:text-slate-400">The Mind Behind Every Deal</p>
                            </div>
                        </button>
                        <Button onClick={() => navigate(createPageUrl('Dashboard'))} className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500">
                            Login / Get Started
                        </Button>
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto pb-2">
                        <button onClick={() => navigate(createPageUrl('ServiceLeadManagement'))} className="px-4 py-2 rounded-lg text-sm bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-medium whitespace-nowrap">Lead Management</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAIInsights'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">AI Insights</button>
                        <button onClick={() => navigate(createPageUrl('ServiceTransactionPipeline'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Transactions</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAutomatedFollowups'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Follow-ups</button>
                        <button onClick={() => navigate(createPageUrl('ServiceDocumentIntelligence'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Documents</button>
                        <button onClick={() => navigate(createPageUrl('ServiceMarketingAutomation'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Marketing</button>
                    </div>
                </div>
            </header>

            {/* Hero Section */}
            <section className="py-20 px-4">
                <div className="max-w-5xl mx-auto text-center">
                    <div className="inline-flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 px-4 py-2 rounded-full text-sm font-medium mb-6">
                        <Target className="w-4 h-4" />
                        Smart Lead Management
                    </div>
                    <h1 className="text-5xl md:text-6xl font-bold text-slate-900 dark:text-white mb-6">
                        Never Miss a <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">Hot Lead</span> Again
                    </h1>
                    <p className="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-3xl mx-auto">
                        RealtyMind's intelligent lead management system helps you capture, prioritize, and convert more leads with AI-powered insights and automation.
                    </p>
                    <Button size="lg" className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:from-indigo-700 hover:to-purple-700">
                        Start Free Trial <ArrowRight className="w-5 h-5 ml-2" />
                    </Button>
                </div>
            </section>

            {/* Stats Section */}
            <section className="py-16 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-6xl mx-auto">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {stats.map((stat, idx) => (
                            <div key={idx} className="text-center">
                                <div className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 mb-2">
                                    {stat.value}
                                </div>
                                <div className="text-slate-600 dark:text-slate-400 font-medium">
                                    {stat.label}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* Benefits Section */}
            <section className="py-20 px-4">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-4">
                        Why Agents Love Our Lead Management
                    </h2>
                    <p className="text-center text-slate-600 dark:text-slate-400 mb-12 max-w-2xl mx-auto">
                        Stop juggling spreadsheets and missing opportunities. Let AI help you work smarter, not harder.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {benefits.map((benefit, idx) => (
                            <Card key={idx} className="border-2 border-slate-200 dark:border-slate-800 hover:border-indigo-500 dark:hover:border-indigo-500 transition-all">
                                <CardContent className="p-6">
                                    <div className="w-12 h-12 bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-lg flex items-center justify-center mb-4">
                                        <benefit.icon className="w-6 h-6 text-indigo-600 dark:text-indigo-400" />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
                                        {benefit.title}
                                    </h3>
                                    <p className="text-slate-600 dark:text-slate-400">
                                        {benefit.description}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            </section>

            {/* Features List */}
            <section className="py-20 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-12">
                        Everything You Need to Manage Leads
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {features.map((feature, idx) => (
                            <div key={idx} className="flex items-start gap-3">
                                <CheckCircle className="w-6 h-6 text-green-500 flex-shrink-0 mt-0.5" />
                                <span className="text-slate-700 dark:text-slate-300">{feature}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* CTA Section */}
            <section className="py-20 px-4 bg-gradient-to-r from-indigo-600 to-purple-600">
                <div className="max-w-4xl mx-auto text-center">
                    <h2 className="text-4xl font-bold text-white mb-4">
                        Ready to Convert More Leads?
                    </h2>
                    <p className="text-xl text-white/90 mb-8">
                        Join thousands of top-performing agents using RealtyMind to grow their business.
                    </p>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <Button size="lg" variant="secondary" className="bg-white text-indigo-600 hover:bg-slate-100">
                            Start Free Trial
                        </Button>
                        <Button size="lg" variant="outline" className="border-white text-white hover:bg-white/10">
                            Schedule Demo
                        </Button>
                    </div>
                </div>
            </section>
        </div>
    );
}
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Megaphone, Mail, Target, CheckCircle, ArrowRight, Sparkles, BarChart, Brain } from 'lucide-react';

export default function ServiceMarketingAutomation() {
    const navigate = useNavigate();

    const benefits = [
        {
            icon: Mail,
            title: "Automated Campaigns",
            description: "Set up drip campaigns, newsletters, and listing alerts that run on autopilot. Stay in touch with hundreds of contacts effortlessly."
        },
        {
            icon: Target,
            title: "Smart Segmentation",
            description: "AI automatically segments your contacts by behavior, preferences, and stage. Send the right message to the right person every time."
        },
        {
            icon: BarChart,
            title: "Performance Analytics",
            description: "See exactly which campaigns drive results. Track opens, clicks, and conversions to optimize your marketing ROI."
        },
        {
            icon: Sparkles,
            title: "AI Content Generation",
            description: "AI writes compelling email copy, property descriptions, and social media posts tailored to your brand voice."
        }
    ];

    const features = [
        "Drag-and-drop email builder",
        "Pre-built campaign templates",
        "A/B testing for subject lines and content",
        "Automated listing alerts for buyers",
        "Social media scheduling and posting",
        "Custom landing pages",
        "Lead magnet creation and hosting",
        "ROI tracking and reporting"
    ];

    const campaignTypes = [
        { name: "Just Listed", description: "Automatically notify your sphere when you list a new property" },
        { name: "Just Sold", description: "Celebrate wins and showcase your success to your network" },
        { name: "Market Updates", description: "Share neighborhood stats and market insights monthly" },
        { name: "Buyer Drips", description: "Nurture buyer leads with property suggestions and tips" },
        { name: "Seller Guides", description: "Educate potential sellers with home prep and staging advice" },
        { name: "Anniversary", description: "Touch base with past clients on their home purchase anniversary" }
    ];

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950">
            {/* Header */}
            <header className="sticky top-0 z-50 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={() => navigate(createPageUrl('Website'))} className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/50">
                                <Brain className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <span className="text-xl font-bold text-slate-900 dark:text-white">RealtyMind</span>
                                <p className="text-xs text-slate-600 dark:text-slate-400">The Mind Behind Every Deal</p>
                            </div>
                        </button>
                        <Button onClick={() => navigate(createPageUrl('Dashboard'))} className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500">
                            Login / Get Started
                        </Button>
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto pb-2">
                        <button onClick={() => navigate(createPageUrl('ServiceLeadManagement'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Lead Management</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAIInsights'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">AI Insights</button>
                        <button onClick={() => navigate(createPageUrl('ServiceTransactionPipeline'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Transactions</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAutomatedFollowups'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Follow-ups</button>
                        <button onClick={() => navigate(createPageUrl('ServiceDocumentIntelligence'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Documents</button>
                        <button onClick={() => navigate(createPageUrl('ServiceMarketingAutomation'))} className="px-4 py-2 rounded-lg text-sm bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-medium whitespace-nowrap">Marketing</button>
                    </div>
                </div>
            </header>

            {/* Hero Section */}
            <section className="py-20 px-4">
                <div className="max-w-5xl mx-auto text-center">
                    <div className="inline-flex items-center gap-2 bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-300 px-4 py-2 rounded-full text-sm font-medium mb-6">
                        <Megaphone className="w-4 h-4" />
                        Marketing Automation
                    </div>
                    <h1 className="text-5xl md:text-6xl font-bold text-slate-900 dark:text-white mb-6">
                        Market Like a <span className="text-transparent bg-clip-text bg-gradient-to-r from-pink-600 to-rose-600">Million-Dollar Agent</span>
                    </h1>
                    <p className="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-3xl mx-auto">
                        Stop spending hours on marketing. RealtyMind's AI-powered marketing engine runs campaigns, nurtures leads, and generates content while you focus on selling.
                    </p>
                    <Button size="lg" className="bg-gradient-to-r from-pink-600 to-rose-600 text-white hover:from-pink-700 hover:to-rose-700">
                        Automate Marketing <ArrowRight className="w-5 h-5 ml-2" />
                    </Button>
                </div>
            </section>

            {/* Benefits Section */}
            <section className="py-20 px-4">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-4">
                        Marketing That Works While You Sleep
                    </h2>
                    <p className="text-center text-slate-600 dark:text-slate-400 mb-12 max-w-2xl mx-auto">
                        Top agents stay top of mind with consistent marketing. Now you can too, without the time commitment.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {benefits.map((benefit, idx) => (
                            <Card key={idx} className="border-2 border-slate-200 dark:border-slate-800 hover:border-pink-500 dark:hover:border-pink-500 transition-all">
                                <CardContent className="p-6">
                                    <div className="w-12 h-12 bg-gradient-to-br from-pink-100 to-rose-100 dark:from-pink-900/30 dark:to-rose-900/30 rounded-lg flex items-center justify-center mb-4">
                                        <benefit.icon className="w-6 h-6 text-pink-600 dark:text-pink-400" />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
                                        {benefit.title}
                                    </h3>
                                    <p className="text-slate-600 dark:text-slate-400">
                                        {benefit.description}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            </section>

            {/* Campaign Types */}
            <section className="py-20 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-4">
                        Pre-Built Campaigns Ready to Go
                    </h2>
                    <p className="text-center text-slate-600 dark:text-slate-400 mb-12 max-w-2xl mx-auto">
                        Launch professional marketing campaigns in minutes with our proven templates.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {campaignTypes.map((campaign, idx) => (
                            <Card key={idx} className="border-2 border-slate-200 dark:border-slate-800">
                                <CardContent className="p-5">
                                    <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
                                        {campaign.name}
                                    </h3>
                                    <p className="text-sm text-slate-600 dark:text-slate-400">
                                        {campaign.description}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            </section>

            {/* Features List */}
            <section className="py-20 px-4">
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-12">
                        Complete Marketing Suite
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {features.map((feature, idx) => (
                            <div key={idx} className="flex items-start gap-3">
                                <CheckCircle className="w-6 h-6 text-pink-500 flex-shrink-0 mt-0.5" />
                                <span className="text-slate-700 dark:text-slate-300">{feature}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* CTA Section */}
            <section className="py-20 px-4 bg-gradient-to-r from-pink-600 to-rose-600">
                <div className="max-w-4xl mx-auto text-center">
                    <h2 className="text-4xl font-bold text-white mb-4">
                        Build Your Brand on Autopilot
                    </h2>
                    <p className="text-xl text-white/90 mb-8">
                        Join successful agents who market consistently without the manual work.
                    </p>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <Button size="lg" variant="secondary" className="bg-white text-pink-600 hover:bg-slate-100">
                            Start Free Trial
                        </Button>
                        <Button size="lg" variant="outline" className="border-white text-white hover:bg-white/10">
                            See Campaigns
                        </Button>
                    </div>
                </div>
            </section>
        </div>
    );
}
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Briefcase, CheckCircle, Clock, FileText, AlertTriangle, ArrowRight, DollarSign, Calendar, Brain } from 'lucide-react';

export default function ServiceTransactionPipeline() {
    const navigate = useNavigate();

    const benefits = [
        {
            icon: CheckCircle,
            title: "Never Miss a Deadline",
            description: "Automated reminders and milestone tracking ensure every inspection, appraisal, and contingency is handled on time."
        },
        {
            icon: FileText,
            title: "Document Management",
            description: "All contracts, disclosures, and addendums organized in one place. No more digging through emails or file cabinets."
        },
        {
            icon: DollarSign,
            title: "Commission Tracking",
            description: "See your projected earnings for every deal. Know exactly what's coming and plan your business finances better."
        },
        {
            icon: Calendar,
            title: "Timeline Visibility",
            description: "Visual pipeline shows exactly where each transaction stands. Share progress with clients to build trust and reduce anxiety."
        }
    ];

    const features = [
        "Customizable transaction stages",
        "Automated task generation for each stage",
        "Document checklists and requirements",
        "Contingency date tracking and alerts",
        "Commission calculator and reporting",
        "Client progress portal access",
        "Email and SMS notifications",
        "Team collaboration and notes"
    ];

    const painPoints = [
        {
            problem: "Missed deadlines cost you deals",
            solution: "Automated reminders 3 days, 1 day, and 1 hour before every deadline",
            icon: Clock
        },
        {
            problem: "Clients constantly asking for updates",
            solution: "Give them 24/7 access to their transaction progress online",
            icon: AlertTriangle
        },
        {
            problem: "Juggling multiple deals is overwhelming",
            solution: "See all your transactions in one visual pipeline dashboard",
            icon: Briefcase
        }
    ];

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950">
            {/* Header */}
            <header className="sticky top-0 z-50 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={() => navigate(createPageUrl('Website'))} className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/50">
                                <Brain className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <span className="text-xl font-bold text-slate-900 dark:text-white">RealtyMind</span>
                                <p className="text-xs text-slate-600 dark:text-slate-400">The Mind Behind Every Deal</p>
                            </div>
                        </button>
                        <Button onClick={() => navigate(createPageUrl('Dashboard'))} className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500">
                            Login / Get Started
                        </Button>
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto pb-2">
                        <button onClick={() => navigate(createPageUrl('ServiceLeadManagement'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Lead Management</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAIInsights'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">AI Insights</button>
                        <button onClick={() => navigate(createPageUrl('ServiceTransactionPipeline'))} className="px-4 py-2 rounded-lg text-sm bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-medium whitespace-nowrap">Transactions</button>
                        <button onClick={() => navigate(createPageUrl('ServiceAutomatedFollowups'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Follow-ups</button>
                        <button onClick={() => navigate(createPageUrl('ServiceDocumentIntelligence'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Documents</button>
                        <button onClick={() => navigate(createPageUrl('ServiceMarketingAutomation'))} className="px-4 py-2 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 whitespace-nowrap">Marketing</button>
                    </div>
                </div>
            </header>

            {/* Hero Section */}
            <section className="py-20 px-4">
                <div className="max-w-5xl mx-auto text-center">
                    <div className="inline-flex items-center gap-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-4 py-2 rounded-full text-sm font-medium mb-6">
                        <Briefcase className="w-4 h-4" />
                        Transaction Pipeline
                    </div>
                    <h1 className="text-5xl md:text-6xl font-bold text-slate-900 dark:text-white mb-6">
                        Close Deals <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-600">On Time, Every Time</span>
                    </h1>
                    <p className="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-3xl mx-auto">
                        Stop stressing about missed deadlines and falling deals. RealtyMind's transaction management keeps every deal on track from contract to close.
                    </p>
                    <Button size="lg" className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white hover:from-blue-700 hover:to-cyan-700">
                        Streamline Transactions <ArrowRight className="w-5 h-5 ml-2" />
                    </Button>
                </div>
            </section>

            {/* Pain Points Section */}
            <section className="py-20 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-4">
                        Transaction Chaos? We've Got You.
                    </h2>
                    <p className="text-center text-slate-600 dark:text-slate-400 mb-12 max-w-2xl mx-auto">
                        Real estate agents lose an average of 2-3 deals per year to missed deadlines. Don't be a statistic.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {painPoints.map((item, idx) => (
                            <Card key={idx} className="border-2 border-slate-200 dark:border-slate-800">
                                <CardContent className="p-6">
                                    <item.icon className="w-8 h-8 text-red-500 mb-4" />
                                    <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
                                        ‚ùå {item.problem}
                                    </h3>
                                    <p className="text-slate-600 dark:text-slate-400">
                                        ‚úÖ {item.solution}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            </section>

            {/* Benefits Section */}
            <section className="py-20 px-4">
                <div className="max-w-6xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-12">
                        Everything You Need to Close Smoothly
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {benefits.map((benefit, idx) => (
                            <Card key={idx} className="border-2 border-slate-200 dark:border-slate-800 hover:border-blue-500 dark:hover:border-blue-500 transition-all">
                                <CardContent className="p-6">
                                    <div className="w-12 h-12 bg-gradient-to-br from-blue-100 to-cyan-100 dark:from-blue-900/30 dark:to-cyan-900/30 rounded-lg flex items-center justify-center mb-4">
                                        <benefit.icon className="w-6 h-6 text-blue-600 dark:text-blue-400" />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
                                        {benefit.title}
                                    </h3>
                                    <p className="text-slate-600 dark:text-slate-400">
                                        {benefit.description}
                                    </p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>
            </section>

            {/* Features List */}
            <section className="py-20 px-4 bg-white dark:bg-slate-900">
                <div className="max-w-4xl mx-auto">
                    <h2 className="text-4xl font-bold text-center text-slate-900 dark:text-white mb-12">
                        Complete Transaction Management
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {features.map((feature, idx) => (
                            <div key={idx} className="flex items-start gap-3">
                                <CheckCircle className="w-6 h-6 text-blue-500 flex-shrink-0 mt-0.5" />
                                <span className="text-slate-700 dark:text-slate-300">{feature}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* CTA Section */}
            <section className="py-20 px-4 bg-gradient-to-r from-blue-600 to-cyan-600">
                <div className="max-w-4xl mx-auto text-center">
                    <h2 className="text-4xl font-bold text-white mb-4">
                        Close More Deals Without the Stress
                    </h2>
                    <p className="text-xl text-white/90 mb-8">
                        Join thousands of agents who never worry about missed deadlines again.
                    </p>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <Button size="lg" variant="secondary" className="bg-white text-blue-600 hover:bg-slate-100">
                            Start Free Trial
                        </Button>
                        <Button size="lg" variant="outline" className="border-white text-white hover:bg-white/10">
                            Watch Demo
                        </Button>
                    </div>
                </div>
            </section>
        </div>
    );
}
import React, { useState } from 'react';
import { User, Bell, Key, DollarSign, CreditCard, MessageSquare, Users, Target, FileText, Palette, TrendingUp, Newspaper, Calendar, Mail, Database, Shield, Upload } from 'lucide-react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';

import ProfileSettings from '../components/settings/ProfileSettings';
import NotificationSettings from '../components/settings/NotificationSettings';
import ApiTokenSettings from '../components/settings/ApiTokenSettings';
import MarketingSettings from '../components/settings/MarketingSettings';
import SubscriptionSettings from '../components/settings/SubscriptionSettings';
import CommunicationSettings from '../components/settings/CommunicationSettings';
import TeamManagement from '../components/settings/TeamManagement';
import UserManagement from '../components/settings/UserManagement';
import LeadSourceManagement from '../components/settings/LeadSourceManagement';
import DocumentTypeManagement from '../components/settings/DocumentTypeManagement';
import AppearanceSettings from '../components/settings/AppearanceSettings';
import RMEISettings from '../components/settings/RMEISettings';
import NewsSentimentSettings from '../components/settings/NewsSentimentSettings';
import HolidaySettings from '../components/settings/HolidaySettings';
import ResendSettings from '../components/settings/ResendSettings';
import EnvironmentVariables from '../components/settings/EnvironmentVariables';
import CalendarIntegration from '../components/settings/CalendarIntegration';
import RolePermissionManagement from '../components/settings/RolePermissionManagement';

const tabs = [
    { type: 'header', label: 'Account Settings' },
    { id: 'profile', label: 'Profile', icon: User, component: ProfileSettings },
    { id: 'appearance', label: 'Appearance', icon: Palette, component: AppearanceSettings },
    { id: 'notifications', label: 'Notifications', icon: Bell, component: NotificationSettings },
    { id: 'calendar_integration', label: 'Calendar Sync', icon: Calendar, component: CalendarIntegration }, // Added tab
    { id: 'holidays', label: 'Calendar Holidays', icon: Calendar, component: HolidaySettings },
    { id: 'communication', label: 'Communication', icon: MessageSquare, component: CommunicationSettings },
    { id: 'resend', label: 'Email (Resend)', icon: Mail, component: ResendSettings },
    { id: 'api_tokens', label: 'API Tokens', icon: Key, component: ApiTokenSettings },
    { id: 'env_vars', label: 'Environment Variables', icon: Database, component: EnvironmentVariables },
    { id: 'csv_import', label: 'CRM Import', icon: Upload, path: 'CSVImport' },
    { id: 'marketing', label: 'Marketing Budget', icon: DollarSign, component: MarketingSettings },
    { id: 'rmei', label: 'Market Index (RMEI)', icon: TrendingUp, component: RMEISettings },
    { id: 'news_sentiment', label: 'News Sentiment', icon: Newspaper, component: NewsSentimentSettings },
    { id: 'subscription', label: 'Subscription', icon: CreditCard, component: SubscriptionSettings },
    { type: 'header', label: 'Brokerage Settings' },
    { id: 'users', label: 'User Management', icon: Users, component: UserManagement },
    { id: 'team', label: 'Team Management', icon: Users, component: TeamManagement },
    { id: 'roles', label: 'Roles & Permissions', icon: Shield, component: RolePermissionManagement },
    { id: 'lead_sources', label: 'Lead Sources', icon: Target, component: LeadSourceManagement },
    { id: 'document_types', label: 'Document Types', icon: FileText, component: DocumentTypeManagement },
];

export default function Settings() {
    const queryClient = useQueryClient();
    const navigate = useNavigate();
    const [activeTab, setActiveTab] = useState('profile');

    const { data: user, isLoading } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me(),
    });

    const updateUserMutation = useMutation({
        mutationFn: async (data) => {
            console.log('üíæ Updating user profile with:', data);
            const result = await base44.auth.updateMe(data);
            console.log('‚úÖ Profile update result:', result);
            return result;
        },
        onSuccess: async () => {
            console.log('üîÑ Invalidating user query cache...');
            await queryClient.invalidateQueries({ queryKey: ['user'] });
            await queryClient.refetchQueries({ queryKey: ['user'] });
            window.dispatchEvent(new CustomEvent('refreshGlobalData'));
            toast.success('Profile updated successfully!');
        },
        onError: (error) => {
            console.error('‚ùå Profile update error:', error);
            toast.error(`Failed to update profile: ${error.message}`);
        },
    });

    return (
        <div className="page-container">
            <header className="mb-8">
                <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Settings</h1>
                <p className="text-slate-500 dark:text-slate-400">Manage your account, team, and brokerage preferences</p>
            </header>
            <div className="flex flex-col lg:flex-row gap-8">
                <aside className="lg:w-1/4">
                    <nav className="flex flex-col gap-1">
                        {tabs.map(tab => {
                            if (tab.type === 'header') {
                                return <p key={tab.label} className="px-3 pt-4 pb-1 text-xs font-semibold text-slate-400 uppercase tracking-wider">{tab.label}</p>;
                            }
                            return (
                                <button
                                    key={tab.id}
                                    onClick={() => {
                                        if (tab.path) {
                                            navigate(createPageUrl(tab.path));
                                        } else {
                                            setActiveTab(tab.id);
                                        }
                                    }}
                                    className={`flex items-center gap-3 p-3 rounded-lg text-sm font-medium transition-colors ${
                                        activeTab === tab.id
                                            ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300'
                                            : 'text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800'
                                    }`}
                                >
                                    <tab.icon className="w-5 h-5" />
                                    <span>{tab.label}</span>
                                </button>
                            );
                        })}
                    </nav>
                </aside>
                <main className="lg:w-3/4">
                    {isLoading ? (
                        <div className="flex items-center justify-center p-12">
                            <div className="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full"></div>
                        </div>
                    ) : (
                        <>
                            {activeTab === 'profile' && (
                                <ProfileSettings 
                                    user={user} 
                                    onUpdate={(data) => updateUserMutation.mutate(data)} 
                                    isUpdating={updateUserMutation.isPending} 
                                />
                            )}
                            {activeTab === 'appearance' && <AppearanceSettings user={user} />}
                            {activeTab === 'notifications' && <NotificationSettings user={user} />}
                            {activeTab === 'calendar_integration' && <CalendarIntegration user={user} />} {/* Added rendering */}
                            {activeTab === 'holidays' && <HolidaySettings />}
                            {activeTab === 'communication' && <CommunicationSettings user={user} />}
                            {activeTab === 'resend' && <ResendSettings user={user} />}
                            {activeTab === 'marketing' && <MarketingSettings user={user} />}
                            {activeTab === 'api_tokens' && <ApiTokenSettings user={user} />}
                            {activeTab === 'env_vars' && <EnvironmentVariables />}
                            {activeTab === 'rmei' && <RMEISettings />}
                            {activeTab === 'news_sentiment' && <NewsSentimentSettings />}
                            {activeTab === 'subscription' && <SubscriptionSettings user={user} />}
                            {activeTab === 'users' && <UserManagement />}
                            {activeTab === 'team' && <TeamManagement />}
                            {activeTab === 'roles' && <RolePermissionManagement />}
                            {activeTab === 'lead_sources' && <LeadSourceManagement />}
                            {activeTab === 'document_types' && <DocumentTypeManagement />}
                        </>
                    )}
                </main>
            </div>
        </div>
    );
}
import React, { useState, useMemo, useEffect } from "react";
import { base44 } from '@/api/base44Client';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Calendar as CalendarIcon, Plus, CheckSquare } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { format, isPast, isFuture, isToday } from "date-fns";
import { useQuery, useQueryClient } from '@tanstack/react-query';

import ShowingModal from "../components/showings/ShowingModal";
import ShowingCard from "../components/showings/ShowingCard";
import { toast } from "sonner";

export default function ShowingsPage() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [selectedShowing, setSelectedShowing] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me(),
  });

  const { data: showings = [], isLoading } = useQuery({
    queryKey: ['showings'],
    queryFn: () => base44.entities.Showing.list('-scheduled_date'),
    initialData: [],
  });

  const { data: properties = [] } = useQuery({
    queryKey: ['properties'],
    queryFn: () => base44.entities.Property.list(),
    initialData: [],
  });

  const { data: users = [] } = useQuery({
    queryKey: ['users'],
    queryFn: () => base44.entities.User.list(),
    initialData: [],
  });

  const { data: buyers = [] } = useQuery({
    queryKey: ['buyers'],
    queryFn: () => base44.entities.Buyer.list(),
    initialData: [],
  });

  const userShowings = useMemo(() => {
    if (!user) return [];

    if (user.role === 'admin') return showings;

    return showings.filter(showing =>
      showing.showing_agent_id === user.id ||
      showing.created_by === user.email
    );
  }, [showings, user]);

  const filteredShowings = useMemo(() => {
    let currentShowings = userShowings;

    currentShowings = currentShowings.filter((showing) => {
      const scheduledDate = new Date(showing.scheduled_date);
      const isPastShowing = isPast(scheduledDate) && !isToday(scheduledDate);
      const isFutureShowing = isFuture(scheduledDate) && !isToday(scheduledDate);
      const isTodayShowing = isToday(scheduledDate);

      if (statusFilter === "upcoming") {
        return (showing.status === 'scheduled' || showing.status === 'confirmed') && (isFutureShowing || isTodayShowing);
      } else if (statusFilter === "past") {
        return (showing.status === 'completed' || showing.status === 'canceled') || (isPastShowing && (showing.status !== 'scheduled' && showing.status !== 'confirmed'));
      } else {
        return true;
      }
    });

    if (searchQuery) {
      const lowerCaseQuery = searchQuery.toLowerCase();
      currentShowings = currentShowings.filter(showing => {
        const property = properties.find(p => p.id === showing.property_id);
        const buyer = buyers.find(b => b.id === showing.buyer_id);
        const agent = users.find(u => u.id === showing.showing_agent_id);

        return (
          property?.address?.toLowerCase().includes(lowerCaseQuery) ||
          property?.name?.toLowerCase().includes(lowerCaseQuery) ||
          buyer?.name?.toLowerCase().includes(lowerCaseQuery) ||
          agent?.full_name?.toLowerCase().includes(lowerCaseQuery) ||
          format(new Date(showing.scheduled_date), 'MMMM d, yyyy h:mm a').toLowerCase().includes(lowerCaseQuery) ||
          showing.status.toLowerCase().includes(lowerCaseQuery)
        );
      });
    }

    return currentShowings;
  }, [userShowings, statusFilter, searchQuery, properties, buyers, users]);

  // Check for initial date from calendar on mount
  useEffect(() => {
    const initialDate = sessionStorage.getItem('newShowingDate');
    if (initialDate) {
      openModal({ scheduled_date: initialDate });
      sessionStorage.removeItem('newShowingDate');
    }
  }, []);

  const handleSaveShowing = async (showingData) => {
      try {
        if (selectedShowing?.id) {
          await base44.entities.Showing.update(selectedShowing.id, showingData);
          toast.success("Showing updated successfully!");
        } else {
          await base44.entities.Showing.create({
            ...showingData,
            showing_agent_id: user.id
          });
          toast.success("Showing scheduled successfully!");
        }
        closeModal();
        queryClient.invalidateQueries(['showings']);
      } catch (error) {
        console.error("Error saving showing:", error);
        toast.error("Failed to save showing. " + (error.message || "Please check your input."));
      }
    };

  const handleStatusChange = async (showingId, newStatus) => {
    try {
      await base44.entities.Showing.update(showingId, {
        status: newStatus,
        ...(newStatus === "completed" && { completed_at: new Date().toISOString() }),
        ...(newStatus === "confirmed" && { confirmed_at: new Date().toISOString() })
      });
      queryClient.invalidateQueries(['showings']);
      toast.success(`Showing status updated to "${newStatus}"!`);
    } catch (error) {
      console.error("Error updating showing status:", error);
      toast.error("Failed to update showing status.");
    }
  };

  const handleDeleteShowing = async (showingId) => {
    if (window.confirm("Are you sure you want to delete this showing? This action cannot be undone.")) {
      try {
        await base44.entities.Showing.delete(showingId);
        toast.success("Showing deleted successfully!");
        queryClient.invalidateQueries(['showings']);
      } catch (error) {
        console.error("Error deleting showing:", error);
        toast.error("Failed to delete showing.");
      }
    }
  };

  const openModal = (showing = null) => {
    setSelectedShowing(showing);
    setIsModalOpen(true);
  };

  const closeModal = () => {
    setSelectedShowing(null);
    setIsModalOpen(false);
    queryClient.invalidateQueries(['showings']);
  };

  return (
    <div className="page-container">
      <div className="p-4">
        <div className="space-y-6">
          <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
              <h1 className="text-3xl font-bold text-slate-900 dark:text-white">
                Property Showings
              </h1>
              <p className="text-slate-500 dark:text-slate-400 mt-1">
                Manage and track your scheduled property viewings.
              </p>
            </div>
            {user && (
              <Button onClick={() => openModal()} className="app-button">
                <Plus className="w-4 h-4 mr-2" />
                Schedule New Showing
              </Button>
            )}
          </div>

          <div className="flex flex-col md:flex-row justify-between items-center gap-4">
            <div className="flex justify-start items-center gap-2">
              <Button
                variant={statusFilter === "upcoming" ? "default" : "outline"}
                onClick={() => setStatusFilter("upcoming")}
                className="h-8"
              >
                <CalendarIcon className="w-4 h-4 mr-2" />
                Upcoming
              </Button>
              <Button
                variant={statusFilter === "past" ? "default" : "outline"}
                onClick={() => setStatusFilter("past")}
                className="h-8"
              >
                <CheckSquare className="w-4 h-4 mr-2" />
                Past
              </Button>
              <Button
                variant={statusFilter === "all" ? "default" : "outline"}
                onClick={() => setStatusFilter("all")}
                className="h-8"
              >
                All
              </Button>
            </div>
            <div className="flex-grow w-full md:w-auto">
                <Input
                    type="text"
                    placeholder="Search showings (property, buyer, agent, date, status)..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full md:max-w-xs"
                />
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {isLoading ? (
              Array.from({ length: 6 }).map((_, i) => (
                <div key={i} className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm animate-pulse">
                  <div className="h-4 bg-slate-200 dark:bg-slate-700 rounded w-3/4 mb-2"></div>
                  <div className="h-3 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mb-4"></div>
                  <div className="h-3 bg-slate-200 dark:bg-slate-700 rounded w-full mb-2"></div>
                  <div className="h-3 bg-slate-200 dark:bg-slate-700 rounded w-full"></div>
                </div>
              ))
            ) : filteredShowings.length > 0 ? (
              filteredShowings.map((showing) => (
                <ShowingCard
                  key={showing.id}
                  showing={showing}
                  property={properties.find((p) => p.id === showing.property_id)}
                  buyer={buyers.find((b) => b.id === showing.buyer_id)}
                  agent={users.find((u) => u.id === showing.showing_agent_id)}
                  onViewShowing={() => openModal(showing)}
                  onEdit={() => openModal(showing)}
                  onDelete={handleDeleteShowing}
                  onStatusChange={handleStatusChange}
                  currentUser={user}
                />
              ))
            ) : (
              <div className="col-span-full app-card p-16 text-center">
                <CalendarIcon className="mx-auto h-12 w-12 text-slate-400" />
                <h3 className="mt-2 text-sm font-medium text-slate-900 dark:text-white">
                  No showings found
                </h3>
                <p className="mt-1 text-sm text-slate-500 dark:text-slate-400">
                  {statusFilter === "upcoming"
                    ? "Get started by scheduling your first showing."
                    : `No ${statusFilter} showings found.`}
                </p>
                {user && (
                  <Button onClick={() => openModal()} className="app-button mt-6">
                    Schedule Showing
                  </Button>
                )}
              </div>
            )}
          </div>

          {isModalOpen && (
            <ShowingModal
              showing={selectedShowing}
              properties={properties.filter(p => p.status === "active")}
              buyers={buyers.filter(b => b.status === "active")}
              agents={users}
              onSave={handleSaveShowing}
              onClose={closeModal}
            />
          )}
        </div>
      </div>
    </div>
  );
}
import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Progress } from '@/components/ui/progress';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import {
    Search, Loader2, Facebook, Linkedin, Instagram, Twitter, Globe,
    TrendingUp, Heart, MapPin, Briefcase, Calendar, Users, Sparkles,
    RefreshCw, AlertCircle, CheckCircle2, ExternalLink, Target, Home,
    DollarSign, FileText, MessageSquare, Eye, MousePointer, Calculator,
    BookOpen, Video, Mail, Share2, ThumbsUp, MessageCircle, TrendingDown,
    Activity, Zap, Bell, Info
} from 'lucide-react';
import { toast } from 'sonner';
import { format } from 'date-fns';

const SocialIcon = ({ platform }) => {
    const icons = {
        facebook: <Facebook className="w-4 h-4" />,
        linkedin: <Linkedin className="w-4 h-4" />,
        instagram: <Instagram className="w-4 h-4" />,
        twitter: <Twitter className="w-4 h-4" />,
        default: <Globe className="w-4 h-4" />
    };
    return icons[platform] || icons.default;
};

const IntentScoreBadge = ({ score, type }) => {
    const getScoreConfig = (score) => {
        if (score >= 80) return { label: 'Hot', color: 'bg-red-500', textColor: 'text-white' };
        if (score >= 60) return { label: 'Warm', color: 'bg-orange-500', textColor: 'text-white' };
        if (score >= 40) return { label: 'Lukewarm', color: 'bg-yellow-500', textColor: 'text-white' };
        if (score >= 20) return { label: 'Cool', color: 'bg-blue-500', textColor: 'text-white' };
        return { label: 'Cold', color: 'bg-slate-400', textColor: 'text-white' };
    };

    const config = getScoreConfig(score);
    
    return (
        <div className="flex items-center gap-2">
            <Badge className={`${config.color} ${config.textColor} flex items-center gap-1`}>
                <Target className="w-3 h-3" />
                {config.label} {type}
            </Badge>
            <span className="text-xs font-semibold text-slate-600 dark:text-slate-400">{score}/100</span>
        </div>
    );
};

const IntentSignalCard = ({ signal, icon: Icon, color }) => {
    return (
        <div className={`flex items-start gap-2 p-2 rounded-lg ${color} border border-opacity-20`}>
            <div className={`p-1.5 rounded-md ${color.includes('blue') ? 'bg-blue-500/20' : 'bg-green-500/20'}`}>
                <Icon className="w-3 h-3" style={{ color: color.includes('blue') ? '#3b82f6' : '#10b981' }} />
            </div>
            <div className="flex-1 min-w-0">
                <p className="text-xs font-bold text-slate-900 dark:text-white truncate">{signal.title}</p>
                <p className="text-[10px] text-slate-600 dark:text-slate-400 line-clamp-1">{signal.description}</p>
            </div>
            <Badge className="bg-amber-500 text-white border-0 text-[10px] px-1.5 py-0">
                +{signal.score}
            </Badge>
        </div>
    );
};

const PersonCard = ({ person, type, onAnalyze, isAnalyzing }) => {
    const navigate = useNavigate();
    const socialProfiles = person.social_media_profiles ? JSON.parse(person.social_media_profiles) : {};
    const intentData = person.intent_data ? JSON.parse(person.intent_data) : null;
    
    const hasSocialProfiles = Object.keys(socialProfiles).length > 0;
    const name = person.name || person.full_name || `${person.first_name || ''} ${person.last_name || ''}`.trim();
    
    const buyerIntentScore = intentData?.buyer_intent_score || 0;
    const sellerIntentScore = intentData?.seller_intent_score || 0;
    const intentSignals = intentData?.signals || [];

    const handleReachOut = () => {
        switch (type) {
            case 'contact':
                navigate(createPageUrl(`ContactDetail?id=${person.id}`));
                break;
            case 'lead':
                navigate(createPageUrl(`LeadDetail?id=${person.id}`));
                break;
            case 'buyer':
                navigate(createPageUrl(`BuyerDetail?id=${person.id}`));
                break;
            case 'team':
                navigate(createPageUrl(`TeamMemberDetail?id=${person.id}`));
                break;
            default:
                toast.error('Unable to navigate to detail page');
        }
    };

    return (
        <div className="group relative h-full">
            <div className={`absolute -inset-0.5 bg-gradient-to-r ${intentData ? 'from-indigo-600 via-purple-600 to-pink-600' : 'from-slate-400 to-slate-500'} rounded-xl opacity-0 group-hover:opacity-75 blur transition-opacity`}></div>
            <div className="relative h-full backdrop-blur-xl bg-white/70 dark:bg-slate-900/70 border border-white/30 dark:border-slate-700/50 rounded-xl shadow-lg hover:shadow-xl transition-all">
                <div className="p-4">
                    <div className="flex items-start gap-3 mb-3">
                        <Avatar className="h-10 w-10 ring-2 ring-white/50">
                            <AvatarFallback className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold">
                                {name.charAt(0)}
                            </AvatarFallback>
                        </Avatar>
                        <div className="flex-1 min-w-0">
                            <h3 className="font-bold text-slate-900 dark:text-white text-sm truncate">{name}</h3>
                            <p className="text-xs text-slate-600 dark:text-slate-400 truncate">{person.email}</p>
                            <div className="flex items-center gap-1.5 mt-1.5">
                                <Badge className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white border-0 text-[10px] px-1.5 py-0.5">
                                    {type}
                                </Badge>
                                {hasSocialProfiles && (
                                    <Badge className="bg-emerald-500/20 text-emerald-700 dark:text-emerald-400 border-0 text-[10px] px-1.5 py-0.5">
                                        <Globe className="w-2.5 h-2.5 mr-0.5" />
                                        Social
                                    </Badge>
                                )}
                            </div>
                        </div>
                    </div>
                    {intentData ? (
                        <div className="space-y-3">
                            <div className="grid grid-cols-2 gap-2">
                                <div className="p-2 rounded-lg bg-blue-500/10 border border-blue-500/20">
                                    <div className="flex items-center justify-between mb-1.5">
                                        <span className="text-[10px] font-bold text-blue-700 dark:text-blue-400 uppercase">Buyer</span>
                                        <Zap className={`w-3.5 h-3.5 ${buyerIntentScore >= 60 ? 'text-red-500' : 'text-blue-500'}`} />
                                    </div>
                                    <div className="h-1.5 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden mb-1.5">
                                        <div className="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full transition-all" style={{ width: `${buyerIntentScore}%` }}></div>
                                    </div>
                                    <p className="text-xs font-bold text-slate-900 dark:text-white">{buyerIntentScore}/100</p>
                                </div>
                                <div className="p-2 rounded-lg bg-green-500/10 border border-green-500/20">
                                    <div className="flex items-center justify-between mb-1.5">
                                        <span className="text-[10px] font-bold text-green-700 dark:text-green-400 uppercase">Seller</span>
                                        <Home className={`w-3.5 h-3.5 ${sellerIntentScore >= 60 ? 'text-red-500' : 'text-green-500'}`} />
                                    </div>
                                    <div className="h-1.5 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden mb-1.5">
                                        <div className="h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full transition-all" style={{ width: `${sellerIntentScore}%` }}></div>
                                    </div>
                                    <p className="text-xs font-bold text-slate-900 dark:text-white">{sellerIntentScore}/100</p>
                                </div>
                            </div>

                            {intentSignals.length > 0 && (
                                <div className="space-y-2">
                                    <p className="text-[10px] font-bold text-slate-700 dark:text-slate-300 uppercase flex items-center gap-1">
                                        <Bell className="w-3 h-3" />
                                        Signals ({intentSignals.length})
                                    </p>
                                    <div className="space-y-1.5 max-h-40 overflow-y-auto">
                                        {intentSignals.slice(0, 3).map((signal, i) => (
                                            <IntentSignalCard 
                                                key={i} 
                                                signal={signal}
                                                icon={signal.category === 'buyer' ? Home : signal.category === 'seller' ? DollarSign : Activity}
                                                color={signal.category === 'buyer' ? 'bg-blue-50 dark:bg-blue-900/20' : 'bg-green-50 dark:bg-green-900/20'}
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {hasSocialProfiles && (
                                <div className="pt-2 border-t border-slate-200/50 dark:border-slate-700/50">
                                    <div className="flex flex-wrap gap-1.5">
                                        {Object.entries(socialProfiles).map(([platform, url]) => (
                                            <a
                                                key={platform}
                                                href={url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="flex items-center gap-1 px-2 py-1 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-700 rounded-lg hover:shadow-md transition-all text-xs"
                                            >
                                                <SocialIcon platform={platform} />
                                                <ExternalLink className="w-2.5 h-2.5" />
                                            </a>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="flex gap-2 pt-3 border-t border-slate-200/50 dark:border-slate-700/50">
                                <Button
                                    onClick={() => onAnalyze(person, type)}
                                    disabled={isAnalyzing}
                                    size="sm"
                                    variant="outline"
                                    className="flex-1 h-8 text-xs rounded-lg"
                                >
                                    {isAnalyzing ? (
                                        <><Loader2 className="w-3 h-3 mr-1 animate-spin" /> Analyzing...</>
                                    ) : (
                                        <><RefreshCw className="w-3 h-3 mr-1" /> Re-analyze</>
                                    )}
                                </Button>
                                {(buyerIntentScore >= 60 || sellerIntentScore >= 60) && (
                                    <Button 
                                        size="sm" 
                                        className="flex-1 h-8 text-xs rounded-lg bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white shadow-md border-0"
                                        onClick={handleReachOut}
                                    >
                                        <MessageSquare className="w-3 h-3 mr-1" />
                                        Reach Out
                                    </Button>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-2">
                            <div className="rounded-lg p-2.5 bg-amber-500/10 border border-amber-500/20 flex items-center gap-2">
                                <AlertCircle className="w-4 h-4 text-amber-500" />
                                <span className="text-xs font-semibold text-amber-700 dark:text-amber-400">No signals yet</span>
                            </div>
                            <Button
                                onClick={() => onAnalyze(person, type)}
                                disabled={isAnalyzing}
                                className="w-full h-9 text-xs rounded-lg font-bold bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white shadow-md border-0"
                            >
                                {isAnalyzing ? (
                                    <><Loader2 className="w-4 h-4 mr-1 animate-spin" /> Analyzing...</>
                                ) : (
                                    <><Search className="w-4 h-4 mr-1" /> Analyze</>
                                )}
                            </Button>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

export default function SocialIntelligence() {
    const queryClient = useQueryClient();
    const navigate = useNavigate();
    const [searchQuery, setSearchQuery] = useState('');
    const [analyzingId, setAnalyzingId] = useState(null);
    const [intentFilter, setIntentFilter] = useState('all');

    const { data: contacts = [] } = useQuery({
        queryKey: ['contacts'],
        queryFn: () => base44.entities.Contact.list(),
    });

    const { data: leads = [] } = useQuery({
        queryKey: ['leads'],
        queryFn: () => base44.entities.Lead.list(),
    });

    const { data: buyers = [] } = useQuery({
        queryKey: ['buyers'],
        queryFn: () => base44.entities.Buyer.list(),
    });

    const { data: teamMembers = [] } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: () => base44.entities.TeamMember.list(),
    });

    const analyzeMutation = useMutation({
        mutationFn: async ({ person, type }) => {
            const name = person.name || person.full_name || `${person.first_name || ''} ${person.last_name || ''}`.trim();
            const email = person.email;
            const phone = person.phone;
            
            const prompt = `
You are an AI real estate intelligence analyst specializing in intent signal detection. Analyze the following person:

Name: ${name}
Email: ${email}
${phone ? `Phone: ${phone}` : ''}
${person.preferred_locations ? `Preferred Locations: ${person.preferred_locations}` : ''}
${person.budget_min || person.budget_max ? `Budget: $${person.budget_min || 0} - $${person.budget_max || 0}` : ''}

Your task is to:
1. Search for their social media profiles and online presence
2. Detect BUYER INTENT SIGNALS such as:
   - Frequent property searches or saved listings
   - Mortgage calculator usage
   - Reading buyer-focused content (first-time buyer guides, mortgage tips)
   - Engagement with property listings on social media
   - Following real estate accounts
   - Life events indicating need for a home (marriage, new job, growing family)
   
3. Detect SELLER INTENT SIGNALS such as:
   - Home value research and CMA requests
   - Market analysis report downloads
   - Reading seller-focused content (staging tips, pricing strategies)
   - Browsing recently sold homes in their area
   - Engagement with selling advice on social media
   - Life events indicating downsizing or relocation
   
4. Provide actionable insights for engagement

Return structured JSON with comprehensive intent analysis.
            `;

            const result = await base44.integrations.Core.InvokeLLM({
                prompt,
                add_context_from_internet: true,
                response_json_schema: {
                    type: "object",
                    properties: {
                        social_profiles: {
                            type: "object",
                            additionalProperties: { type: "string" }
                        },
                        buyer_intent_score: {
                            type: "number",
                            description: "Score from 0-100 indicating strength of buying intent"
                        },
                        seller_intent_score: {
                            type: "number",
                            description: "Score from 0-100 indicating strength of selling intent"
                        },
                        signals: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    title: { type: "string" },
                                    description: { type: "string" },
                                    category: { type: "string", enum: ["buyer", "seller", "general"] },
                                    score: { type: "number" },
                                    timestamp: { type: "string" }
                                }
                            },
                            description: "Array of detected intent signals"
                        },
                        life_events: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    event: { type: "string" },
                                    date: { type: "string" },
                                    details: { type: "string" }
                                }
                            }
                        },
                        interests_hobbies: {
                            type: "array",
                            items: { type: "string" }
                        },
                        engagement_score: { type: "number" },
                        recommended_actions: {
                            type: "array",
                            items: { type: "string" }
                        },
                        family_composition: { type: "string" },
                        professional_interests: {
                            type: "array",
                            items: { type: "string" }
                        }
                    }
                }
            });

            const updateData = {
                social_media_profiles: JSON.stringify(result.social_profiles || {}),
                life_events: JSON.stringify(result.life_events || []),
                interests_hobbies: JSON.stringify(result.interests_hobbies || []),
                engagement_score: result.engagement_score || 0,
                intent_data: JSON.stringify({
                    buyer_intent_score: result.buyer_intent_score || 0,
                    seller_intent_score: result.seller_intent_score || 0,
                    signals: result.signals || [],
                    recommended_actions: result.recommended_actions || []
                }),
                last_social_analysis: new Date().toISOString()
            };

            if (type === 'buyer' && result.family_composition) {
                updateData.family_composition = result.family_composition;
            }

            if ((type === 'team' || type === 'lead') && result.professional_interests) {
                updateData.professional_interests = JSON.stringify(result.professional_interests);
            }

            switch (type) {
                case 'contact':
                    await base44.entities.Contact.update(person.id, updateData);
                    break;
                case 'lead':
                    await base44.entities.Lead.update(person.id, updateData);
                    break;
                case 'buyer':
                    await base44.entities.Buyer.update(person.id, updateData);
                    break;
                case 'team':
                    await base44.entities.TeamMember.update(person.id, updateData);
                    break;
            }

            return { ...result, type, personId: person.id };
        },
        onSuccess: (data) => {
            queryClient.invalidateQueries({ queryKey: [`${data.type === 'contact' ? 'contacts' : data.type === 'team' ? 'teamMembers' : data.type + 's'}`] });
            
            const intentMessage = [];
            if (data.buyer_intent_score >= 60) intentMessage.push(`üî• Hot buyer (${data.buyer_intent_score}/100)`);
            if (data.seller_intent_score >= 60) intentMessage.push(`üè† Hot seller (${data.seller_intent_score}/100)`);
            
            toast.success("Intent signals analyzed!", {
                description: intentMessage.length > 0 ? intentMessage.join(' | ') : `Found ${Object.keys(data.social_profiles || {}).length} social profiles`
            });
        },
        onError: (error) => {
            console.error('Analysis error:', error);
            toast.error("Failed to analyze intent signals");
        },
        onSettled: () => {
            setAnalyzingId(null);
        }
    });

    const handleAnalyze = (person, type) => {
        // Play sound effect
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAo=');
        audio.volume = 0.3;
        audio.play().catch(() => {});
        
        setAnalyzingId(person.id);
        analyzeMutation.mutate({ person, type });
    };

    const bulkAnalyzeMutation = useMutation({
        mutationFn: async (type) => {
            // Play sound effect
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAo=');
            audio.volume = 0.3;
            audio.play().catch(() => {});
            
            let people = [];
            let entityType = '';
            
            switch (type) {
                case 'contacts':
                    people = contacts.filter(c => !c.intent_data);
                    entityType = 'contact';
                    break;
                case 'leads':
                    people = leads.filter(l => !l.intent_data);
                    entityType = 'lead';
                    break;
                case 'buyers':
                    people = buyers.filter(b => !b.intent_data);
                    entityType = 'buyer';
                    break;
                case 'team':
                    people = teamMembers.filter(t => !t.intent_data);
                    entityType = 'team';
                    break;
            }

            if (people.length === 0) {
                toast.info(`All ${type} already have intent signals analyzed.`);
                return { analyzed: 0, total: 0, failed: 0 };
            }

            const toAnalyze = people;
            toast.info(`Starting slow analysis of ${toAnalyze.length} ${type.toLowerCase()}... This will take ${Math.ceil(toAnalyze.length * 8 / 60)} minutes.`, {
                duration: 5000
            });

            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < toAnalyze.length; i++) {
                const person = toAnalyze[i];
                
                if (i % 5 === 0) {
                    toast.info(`Processing ${i + 1} of ${toAnalyze.length}... (${Math.round((i / toAnalyze.length) * 100)}%)`, {
                        duration: 2000
                    });
                }
                
                let retries = 3;
                let delay = 5000;
                let success = false;
                
                while (retries > 0 && !success) {
                    try {
                        setAnalyzingId(person.id);
                        await analyzeMutation.mutateAsync({ person, type: entityType });
                        successCount++;
                        success = true;
                    } catch (error) {
                        const errorMessage = error?.message || String(error);
                        
                        if (errorMessage.includes('Rate limit') || errorMessage.includes('429')) {
                            retries--;
                            if (retries > 0) {
                                console.log(`Rate limited. Waiting ${delay/1000}s before retry ${4-retries}/3...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                delay *= 2;
                            } else {
                                console.error(`Failed after 3 retries:`, error);
                                failCount++;
                            }
                        } else {
                            console.error(`Failed to analyze:`, error);
                            failCount++;
                            retries = 0;
                        }
                    }
                }
                
                if (i < toAnalyze.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 8000));
                }
            }

            return { analyzed: successCount, total: people.length, failed: failCount };
        },
        onSuccess: ({ analyzed, total, failed }) => {
            if (analyzed > 0) {
                toast.success(`Successfully analyzed ${analyzed} of ${total} profile${analyzed > 1 ? 's' : ''}!`, {
                    description: failed > 0 ? `${failed} failed to analyze due to rate limits.` : 'All profiles analyzed successfully.',
                    duration: 5000
                });
            } else {
                toast.error(`Failed to analyze profiles. ${failed} errors occurred.`);
            }
            setAnalyzingId(null);
        },
        onError: (error) => {
            console.error('Bulk analysis error:', error);
            toast.error("Failed to complete bulk analysis.");
            setAnalyzingId(null);
        }
    });

    const filteredData = useMemo(() => {
        const query = searchQuery.toLowerCase();
        
        const filterByIntent = (items) => {
            return items.filter(item => {
                const matchesSearch = 
                    (item.name || item.full_name || `${item.first_name || ''} ${item.last_name || ''}`).toLowerCase().includes(query) || 
                    item.email?.toLowerCase().includes(query);
                
                if (!matchesSearch) return false;
                
                if (intentFilter === 'all') return true;
                
                const intentData = item.intent_data ? JSON.parse(item.intent_data) : null;
                if (!intentData) return false;
                
                if (intentFilter === 'hot_buyers') return intentData.buyer_intent_score >= 60;
                if (intentFilter === 'hot_sellers') return intentData.seller_intent_score >= 60;
                
                return true;
            });
        };
        
        return {
            contacts: filterByIntent(contacts),
            leads: filterByIntent(leads),
            buyers: filterByIntent(buyers),
            teamMembers: filterByIntent(teamMembers)
        };
    }, [contacts, leads, buyers, teamMembers, searchQuery, intentFilter]);

    const stats = useMemo(() => {
        const calculateStats = (items) => {
            let analyzed = 0;
            let hotBuyers = 0;
            let hotSellers = 0;
            
            items.forEach(item => {
                if (item.intent_data) {
                    analyzed++;
                    const intentData = JSON.parse(item.intent_data);
                    if (intentData.buyer_intent_score >= 60) hotBuyers++;
                    if (intentData.seller_intent_score >= 60) hotSellers++;
                }
            });
            
            return { total: items.length, analyzed, hotBuyers, hotSellers };
        };
        
        return {
            contacts: calculateStats(contacts),
            leads: calculateStats(leads),
            buyers: calculateStats(buyers),
            team: calculateStats(teamMembers)
        };
    }, [contacts, leads, buyers, teamMembers]);

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 via-indigo-50/30 to-purple-50/30 dark:from-slate-950 dark:via-indigo-950/50 dark:to-purple-950/50">
            {/* Animated Background Orbs */}
            <div className="fixed inset-0 overflow-hidden pointer-events-none">
                <div className="absolute -top-40 -right-40 w-80 h-80 bg-purple-500/10 rounded-full blur-3xl animate-pulse"></div>
                <div className="absolute top-60 -left-40 w-96 h-96 bg-indigo-500/10 rounded-full blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
            </div>

            <div className="relative space-y-6 p-6 max-w-[1600px] mx-auto">
                {/* Hero Header - Compact */}
                <div className="relative overflow-hidden rounded-2xl bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-0.5">
                    <div className="relative bg-slate-900 dark:bg-slate-950 rounded-2xl p-6">
                        <div className="flex items-center gap-3">
                            <div className="relative">
                                <div className="absolute inset-0 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl blur-lg opacity-75"></div>
                                <div className="relative bg-gradient-to-br from-indigo-500 to-purple-600 p-3 rounded-xl shadow-xl">
                                    <Sparkles className="w-6 h-6 text-white" />
                                </div>
                            </div>
                            <div>
                                <h1 className="text-2xl font-black text-white tracking-tight">
                                    Social Intelligence Hub
                                </h1>
                                <p className="text-indigo-200 text-sm">
                                    AI-powered intent detection ‚Ä¢ Identify ready buyers & sellers
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Info Card - Compact Glass */}
                <div className="relative overflow-hidden rounded-xl backdrop-blur-xl bg-white/40 dark:bg-slate-900/40 border border-white/20 dark:border-slate-700/50 shadow-xl">
                    <div className="p-4">
                        <div className="flex items-start gap-3">
                            <div className="p-2 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg shadow-lg">
                                <Info className="w-5 h-5 text-white" />
                            </div>
                            <div className="flex-1">
                                <h3 className="font-bold text-slate-900 dark:text-white mb-2 text-base">Understanding Intent Signals</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                    <div className="p-2 rounded-lg bg-blue-500/10 border border-blue-500/20">
                                        <div className="flex items-center gap-1.5 mb-1">
                                            <Eye className="w-3.5 h-3.5 text-blue-600" />
                                            <p className="font-bold text-slate-900 dark:text-white">Buyer</p>
                                        </div>
                                        <p className="text-slate-600 dark:text-slate-400">Property searches, mortgages</p>
                                    </div>
                                    <div className="p-2 rounded-lg bg-green-500/10 border border-green-500/20">
                                        <div className="flex items-center gap-1.5 mb-1">
                                            <DollarSign className="w-3.5 h-3.5 text-green-600" />
                                            <p className="font-bold text-slate-900 dark:text-white">Seller</p>
                                        </div>
                                        <p className="text-slate-600 dark:text-slate-400">Value checks, analysis</p>
                                    </div>
                                    <div className="p-2 rounded-lg bg-purple-500/10 border border-purple-500/20">
                                        <div className="flex items-center gap-1.5 mb-1">
                                            <Share2 className="w-3.5 h-3.5 text-purple-600" />
                                            <p className="font-bold text-slate-900 dark:text-white">Social</p>
                                        </div>
                                        <p className="text-slate-600 dark:text-slate-400">Follows, engagement</p>
                                    </div>
                                    <div className="p-2 rounded-lg bg-red-500/10 border border-red-500/20">
                                        <div className="flex items-center gap-1.5 mb-1">
                                            <Heart className="w-3.5 h-3.5 text-red-600" />
                                            <p className="font-bold text-slate-900 dark:text-white">Events</p>
                                        </div>
                                        <p className="text-slate-600 dark:text-slate-400">Life changes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Stats Cards - Compact Glass */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                    {[
                        { label: 'Contacts', data: stats.contacts, icon: Users, gradient: 'from-purple-500 to-indigo-600' },
                        { label: 'Leads', data: stats.leads, icon: TrendingUp, gradient: 'from-blue-500 to-cyan-600' },
                        { label: 'Buyers', data: stats.buyers, icon: Heart, gradient: 'from-rose-500 to-pink-600' },
                        { label: 'Team', data: stats.team, icon: Briefcase, gradient: 'from-green-500 to-emerald-600' }
                    ].map((stat, idx) => (
                        <div key={idx} className="group relative">
                            <div className={`absolute -inset-0.5 bg-gradient-to-r ${stat.gradient} rounded-xl opacity-0 group-hover:opacity-75 blur transition-opacity`}></div>
                            <div className="relative backdrop-blur-xl bg-white/60 dark:bg-slate-900/60 border border-white/20 dark:border-slate-700/50 rounded-xl p-4 shadow-lg hover:shadow-xl transition-all">
                                <div className="flex items-center justify-between mb-2">
                                    <p className="text-xs font-medium text-slate-600 dark:text-slate-400">{stat.label}</p>
                                    <div className={`bg-gradient-to-r ${stat.gradient} p-2 rounded-lg shadow-md`}>
                                        <stat.icon className="w-4 h-4 text-white" />
                                    </div>
                                </div>
                                <p className="text-2xl font-black text-slate-900 dark:text-white mb-1">
                                    {stat.data.analyzed}<span className="text-slate-400 text-lg">/{stat.data.total}</span>
                                </p>
                                <div className="flex items-center gap-1 text-xs font-bold text-amber-600">
                                    <Zap className="w-3 h-3" />
                                    {stat.data.hotBuyers + stat.data.hotSellers} Hot
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                {/* Search & Filters - Compact Glass */}
                <div className="relative overflow-hidden rounded-xl backdrop-blur-xl bg-white/60 dark:bg-slate-900/60 border border-white/20 dark:border-slate-700/50 shadow-lg">
                    <div className="p-4 space-y-4">
                        <div className="flex flex-col sm:flex-row gap-3">
                            <div className="flex-1 relative">
                                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                                <Input
                                    placeholder="Search..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="pl-9 h-9 rounded-lg bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm text-sm"
                                />
                            </div>
                            <div className="flex gap-2">
                                <Button
                                    variant={intentFilter === 'all' ? 'default' : 'outline'}
                                    onClick={() => setIntentFilter('all')}
                                    size="sm"
                                    className="h-9 text-xs"
                                >
                                    All
                                </Button>
                                <Button
                                    variant={intentFilter === 'hot_buyers' ? 'default' : 'outline'}
                                    onClick={() => setIntentFilter('hot_buyers')}
                                    size="sm"
                                    className={`h-9 text-xs ${intentFilter === 'hot_buyers' ? 'bg-blue-600 hover:bg-blue-700 text-white' : ''}`}
                                >
                                    <Target className="w-3 h-3 mr-1" />
                                    Buyers
                                </Button>
                                <Button
                                    variant={intentFilter === 'hot_sellers' ? 'default' : 'outline'}
                                    onClick={() => setIntentFilter('hot_sellers')}
                                    size="sm"
                                    className={`h-9 text-xs ${intentFilter === 'hot_sellers' ? 'bg-green-600 hover:bg-green-700 text-white' : ''}`}
                                >
                                    <Home className="w-3 h-3 mr-1" />
                                    Sellers
                                </Button>
                            </div>
                        </div>
                        
                        <div className="pt-3 border-t border-slate-200/50 dark:border-slate-700/50">
                            <div className="flex items-center gap-2 mb-3">
                                <Zap className="w-4 h-4 text-amber-500" />
                                <p className="text-xs font-bold text-slate-900 dark:text-white">Bulk Analysis</p>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {[
                                    { type: 'contacts', label: 'Contacts', count: contacts.filter(c => !c.intent_data).length },
                                    { type: 'leads', label: 'Leads', count: leads.filter(l => !l.intent_data).length },
                                    { type: 'buyers', label: 'Buyers', count: buyers.filter(b => !b.intent_data).length },
                                    { type: 'team', label: 'Team', count: teamMembers.filter(t => !t.intent_data).length }
                                ].map((item) => (
                                    <Button
                                        key={item.type}
                                        onClick={() => bulkAnalyzeMutation.mutate(item.type)}
                                        disabled={bulkAnalyzeMutation.isLoading}
                                        size="sm"
                                        variant="outline"
                                        className="h-8 text-xs"
                                    >
                                        {bulkAnalyzeMutation.isLoading && bulkAnalyzeMutation.variables === item.type ? (
                                            <><Loader2 className="w-3 h-3 mr-1 animate-spin" /> Analyzing...</>
                                        ) : (
                                            <><Sparkles className="w-3 h-3 mr-1" /> {item.label} ({item.count})</>
                                        )}
                                    </Button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>

                <Tabs defaultValue="contacts" className="w-full">
                    <TabsList className="w-full grid grid-cols-4 p-1 rounded-xl bg-white/60 dark:bg-slate-900/60 backdrop-blur-xl border border-white/20 dark:border-slate-700/50 shadow-lg">
                        {[
                            { value: 'contacts', label: 'Contacts', count: filteredData.contacts.length },
                            { value: 'leads', label: 'Leads', count: filteredData.leads.length },
                            { value: 'buyers', label: 'Buyers', count: filteredData.buyers.length },
                            { value: 'team', label: 'Team', count: filteredData.teamMembers.length }
                        ].map((tab) => (
                            <TabsTrigger 
                                key={tab.value}
                                value={tab.value}
                                className="rounded-lg text-xs data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-500 data-[state=active]:to-purple-600 data-[state=active]:text-white data-[state=active]:shadow-lg font-semibold"
                            >
                                {tab.label} ({tab.count})
                            </TabsTrigger>
                        ))}
                    </TabsList>

                    <TabsContent value="contacts" className="mt-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {filteredData.contacts.map(contact => (
                                <PersonCard
                                    key={contact.id}
                                    person={contact}
                                    type="contact"
                                    onAnalyze={handleAnalyze}
                                    isAnalyzing={analyzingId === contact.id}
                                />
                            ))}
                        </div>
                    </TabsContent>

                    <TabsContent value="leads" className="mt-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {filteredData.leads.map(lead => (
                                <PersonCard
                                    key={lead.id}
                                    person={lead}
                                    type="lead"
                                    onAnalyze={handleAnalyze}
                                    isAnalyzing={analyzingId === lead.id}
                                />
                            ))}
                        </div>
                    </TabsContent>

                    <TabsContent value="buyers" className="mt-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {filteredData.buyers.map(buyer => (
                                <PersonCard
                                    key={buyer.id}
                                    person={buyer}
                                    type="buyer"
                                    onAnalyze={handleAnalyze}
                                    isAnalyzing={analyzingId === buyer.id}
                                />
                            ))}
                        </div>
                    </TabsContent>

                    <TabsContent value="team" className="mt-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {filteredData.teamMembers.map(member => (
                                <PersonCard
                                    key={member.id}
                                    person={member}
                                    type="team"
                                    onAnalyze={handleAnalyze}
                                    isAnalyzing={analyzingId === member.id}
                                />
                            ))}
                        </div>
                    </TabsContent>
                </Tabs>
            </div>
        </div>
    );
}
import React, { useState } from 'react';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { 
    Facebook, Instagram, Linkedin, Twitter, 
    Share2, Send,
    CheckCircle, AlertCircle, Clock
} from 'lucide-react';
import { toast } from 'sonner';

export default function SocialMediaPosting() {
    const queryClient = useQueryClient();
    const [activeTab, setActiveTab] = useState('post');
    const [selectedProperty, setSelectedProperty] = useState('');
    const [postContent, setPostContent] = useState('');
    const [selectedPlatforms, setSelectedPlatforms] = useState([]);
    const [postType, setPostType] = useState('listing');
    const [buyerRequirements, setBuyerRequirements] = useState({
        budget: '',
        bedrooms: '',
        location: '',
        features: ''
    });

    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me()
    });

    const { data: properties = [] } = useQuery({
        queryKey: ['properties'],
        queryFn: () => base44.entities.Property.list()
    });

    const { data: posts = [] } = useQuery({
        queryKey: ['socialPosts'],
        queryFn: async () => {
            // Mock data - replace with actual entity when created
            return [];
        }
    });

    const platforms = [
        { id: 'facebook', name: 'Facebook', icon: Facebook, color: 'bg-blue-600', connected: false },
        { id: 'instagram', name: 'Instagram', icon: Instagram, color: 'bg-pink-600', connected: false },
        { id: 'linkedin', name: 'LinkedIn', icon: Linkedin, color: 'bg-blue-700', connected: false },
        { id: 'twitter', name: 'Twitter/X', icon: Twitter, color: 'bg-slate-800', connected: false }
    ];

    const togglePlatform = (platformId) => {
        setSelectedPlatforms(prev => 
            prev.includes(platformId) 
                ? prev.filter(p => p !== platformId)
                : [...prev, platformId]
        );
    };

    const generateListingPost = () => {
        const property = properties.find(p => p.id === selectedProperty);
        if (!property) return;

        const template = `üè° NEW LISTING ALERT! üè°

${property.address}
üí∞ $${property.price?.toLocaleString()}
üõèÔ∏è ${property.bedrooms} bed | üõÅ ${property.bathrooms} bath | üìê ${property.square_feet} sqft

${property.description || 'Beautiful property waiting for you!'}

üìû DM me for more details or to schedule a showing!
#RealEstate #NewListing #DreamHome #${property.city?.replace(/\s+/g, '')}`;

        setPostContent(template);
    };

    const generateBuyerRequestPost = () => {
        const template = `üîç PROPERTY WANTED FOR MY CLIENT! üîç

My buyer is looking for:
üí∞ Budget: $${buyerRequirements.budget}
üõèÔ∏è Bedrooms: ${buyerRequirements.bedrooms || 'Any'}
üìç Location: ${buyerRequirements.location}
‚ú® Features: ${buyerRequirements.features || 'Open to suggestions'}

Know of any properties that match? Let's connect!

üìû Contact me directly
#RealEstate #BuyerAgent #PropertyWanted #${buyerRequirements.location?.replace(/\s+/g, '')}`;

        setPostContent(template);
    };

    const handlePost = async () => {
        if (!postContent.trim()) {
            toast.error('Please add content to your post');
            return;
        }
        if (selectedPlatforms.length === 0) {
            toast.error('Please select at least one platform');
            return;
        }

        try {
            // In production, this would actually post to social media APIs
            toast.success(`Post will be shared to ${selectedPlatforms.join(', ')}`);
            setPostContent('');
            setSelectedPlatforms([]);
            setSelectedProperty('');
        } catch (error) {
            toast.error('Failed to post: ' + error.message);
        }
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950 p-6">
            <div className="max-w-7xl mx-auto">
                {/* Header */}
                <div className="mb-8">
                    <h1 className="text-4xl font-bold text-slate-900 dark:text-white mb-2">
                        Social Media Posting
                    </h1>
                    <p className="text-slate-600 dark:text-slate-400">
                        Share listings and buyer requests across all your social platforms
                    </p>
                </div>

                {/* Tabs */}
                <div className="flex gap-2 mb-6">
                    <Button
                        variant={activeTab === 'post' ? 'default' : 'outline'}
                        onClick={() => setActiveTab('post')}
                    >
                        <Send className="w-4 h-4 mr-2" />
                        Create Post
                    </Button>
                    <Button
                        variant={activeTab === 'connections' ? 'default' : 'outline'}
                        onClick={() => setActiveTab('connections')}
                    >
                        <Share2 className="w-4 h-4 mr-2" />
                        Connections
                    </Button>
                    <Button
                        variant={activeTab === 'history' ? 'default' : 'outline'}
                        onClick={() => setActiveTab('history')}
                    >
                        <Clock className="w-4 h-4 mr-2" />
                        Post History
                    </Button>
                </div>

                {/* Create Post Tab */}
                {activeTab === 'post' && (
                    <div className="grid lg:grid-cols-3 gap-6">
                        {/* Post Creator */}
                        <div className="lg:col-span-2">
                            <Card>
                                <CardHeader>
                                    <CardTitle>Create Your Post</CardTitle>
                                </CardHeader>
                                <CardContent className="space-y-6">
                                    {/* Post Type Selection */}
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                            Post Type
                                        </label>
                                        <Select value={postType} onValueChange={setPostType}>
                                            <SelectTrigger>
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                <SelectItem value="listing">Property Listing</SelectItem>
                                                <SelectItem value="buyer_request">Buyer Property Request</SelectItem>
                                                <SelectItem value="custom">Custom Post</SelectItem>
                                            </SelectContent>
                                        </Select>
                                    </div>

                                    {/* Listing Selection */}
                                    {postType === 'listing' && (
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                                Select Property
                                            </label>
                                            <Select value={selectedProperty} onValueChange={setSelectedProperty}>
                                                <SelectTrigger>
                                                    <SelectValue placeholder="Choose a property..." />
                                                </SelectTrigger>
                                                <SelectContent>
                                                    {properties.map(property => (
                                                        <SelectItem key={property.id} value={property.id}>
                                                            {property.address} - ${property.price?.toLocaleString()}
                                                        </SelectItem>
                                                    ))}
                                                </SelectContent>
                                            </Select>
                                            <Button
                                                onClick={generateListingPost}
                                                className="mt-2"
                                                variant="outline"
                                                size="sm"
                                                disabled={!selectedProperty}
                                            >
                                                Generate Post Template
                                            </Button>
                                        </div>
                                    )}

                                    {/* Buyer Requirements */}
                                    {postType === 'buyer_request' && (
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                                        Budget
                                                    </label>
                                                    <Input
                                                        type="text"
                                                        placeholder="e.g., 500,000"
                                                        value={buyerRequirements.budget}
                                                        onChange={(e) => setBuyerRequirements({
                                                            ...buyerRequirements,
                                                            budget: e.target.value
                                                        })}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                                        Bedrooms
                                                    </label>
                                                    <Input
                                                        type="text"
                                                        placeholder="e.g., 3+"
                                                        value={buyerRequirements.bedrooms}
                                                        onChange={(e) => setBuyerRequirements({
                                                            ...buyerRequirements,
                                                            bedrooms: e.target.value
                                                        })}
                                                    />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                                    Location
                                                </label>
                                                <Input
                                                    type="text"
                                                    placeholder="e.g., Downtown, North Side"
                                                    value={buyerRequirements.location}
                                                    onChange={(e) => setBuyerRequirements({
                                                        ...buyerRequirements,
                                                        location: e.target.value
                                                    })}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                                    Must-Have Features
                                                </label>
                                                <Input
                                                    type="text"
                                                    placeholder="e.g., pool, garage, backyard"
                                                    value={buyerRequirements.features}
                                                    onChange={(e) => setBuyerRequirements({
                                                        ...buyerRequirements,
                                                        features: e.target.value
                                                    })}
                                                />
                                            </div>
                                            <Button
                                                onClick={generateBuyerRequestPost}
                                                variant="outline"
                                                size="sm"
                                            >
                                                Generate Request Template
                                            </Button>
                                        </div>
                                    )}

                                    {/* Post Content */}
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                            Post Content
                                        </label>
                                        <Textarea
                                            value={postContent}
                                            onChange={(e) => setPostContent(e.target.value)}
                                            placeholder="Write your post here..."
                                            className="h-64 resize-none"
                                        />
                                        <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                            {postContent.length} characters
                                        </div>
                                    </div>

                                    {/* Platform Selection */}
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">
                                            Select Platforms
                                        </label>
                                        <div className="grid grid-cols-2 gap-3">
                                            {platforms.map(platform => {
                                                const Icon = platform.icon;
                                                const isSelected = selectedPlatforms.includes(platform.id);
                                                return (
                                                    <button
                                                        key={platform.id}
                                                        onClick={() => togglePlatform(platform.id)}
                                                        className={`
                                                            flex items-center gap-3 p-4 rounded-lg border-2 transition-all
                                                            ${isSelected 
                                                                ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-950' 
                                                                : 'border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700'
                                                            }
                                                        `}
                                                    >
                                                        <div className={`w-10 h-10 ${platform.color} rounded-lg flex items-center justify-center`}>
                                                            <Icon className="w-5 h-5 text-white" />
                                                        </div>
                                                        <div className="flex-1 text-left">
                                                            <div className="font-medium text-slate-900 dark:text-white">
                                                                {platform.name}
                                                            </div>
                                                            {!platform.connected && (
                                                                <div className="text-xs text-amber-600">
                                                                    Not connected
                                                                </div>
                                                            )}
                                                        </div>
                                                        {isSelected && (
                                                            <CheckCircle className="w-5 h-5 text-indigo-600" />
                                                        )}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* Post Button */}
                                    <Button
                                        onClick={handlePost}
                                        className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                                        size="lg"
                                    >
                                        <Send className="w-5 h-5 mr-2" />
                                        Post to {selectedPlatforms.length || 0} Platform{selectedPlatforms.length !== 1 ? 's' : ''}
                                    </Button>
                                </CardContent>
                            </Card>
                        </div>

                        {/* Preview */}
                        <div>
                            <Card className="sticky top-6">
                                <CardHeader>
                                    <CardTitle className="text-lg">Preview</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    {postContent ? (
                                        <div className="bg-slate-50 dark:bg-slate-900 rounded-lg p-4 border border-slate-200 dark:border-slate-800">
                                            <div className="flex items-center gap-2 mb-3">
                                                <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full" />
                                                <div>
                                                    <div className="font-medium text-slate-900 dark:text-white">
                                                        {user?.full_name || 'Your Name'}
                                                    </div>
                                                    <div className="text-xs text-slate-500">
                                                        Just now
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">
                                                {postContent}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center text-slate-500 dark:text-slate-400 py-8">
                                            Your post preview will appear here
                                        </div>
                                    )}
                                </CardContent>
                            </Card>
                        </div>
                    </div>
                )}

                {/* Connections Tab */}
                {activeTab === 'connections' && (
                    <Card>
                        <CardHeader>
                            <CardTitle>Connected Accounts</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <div className="space-y-4">
                                {platforms.map(platform => {
                                    const Icon = platform.icon;
                                    return (
                                        <div
                                            key={platform.id}
                                            className="flex items-center justify-between p-4 border border-slate-200 dark:border-slate-800 rounded-lg"
                                        >
                                            <div className="flex items-center gap-4">
                                                <div className={`w-12 h-12 ${platform.color} rounded-lg flex items-center justify-center`}>
                                                    <Icon className="w-6 h-6 text-white" />
                                                </div>
                                                <div>
                                                    <div className="font-medium text-slate-900 dark:text-white">
                                                        {platform.name}
                                                    </div>
                                                    {platform.connected ? (
                                                        <Badge variant="success" className="mt-1">
                                                            <CheckCircle className="w-3 h-3 mr-1" />
                                                            Connected
                                                        </Badge>
                                                    ) : (
                                                        <Badge variant="secondary" className="mt-1">
                                                            <AlertCircle className="w-3 h-3 mr-1" />
                                                            Not Connected
                                                        </Badge>
                                                    )}
                                                </div>
                                            </div>
                                            <Button variant="outline">
                                                {platform.connected ? 'Disconnect' : 'Connect'}
                                            </Button>
                                        </div>
                                    );
                                })}
                            </div>
                        </CardContent>
                    </Card>
                )}

                {/* Post History Tab */}
                {activeTab === 'history' && (
                    <Card>
                        <CardHeader>
                            <CardTitle>Recent Posts</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <div className="text-center text-slate-500 dark:text-slate-400 py-12">
                                No posts yet. Create your first social media post!
                            </div>
                        </CardContent>
                    </Card>
                )}
            </div>
        </div>
    );
}

import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import { BrainCircuit, Users, BookOpen, Loader2, Sparkles, Rocket, Send, Trash2 } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ScrollArea } from "@/components/ui/scroll-area";
import ContactCard from '../components/sphere/ContactCard';
import AIInsightsPanel from '../components/sphere/AIInsightsPanel';
import SOICampaignGuide from '../components/sphere/SOICampaignGuide';

const SphereAutopilot = () => {
    const queryClient = useQueryClient();
    const [isGenerating, setIsGenerating] = useState(false); // New state for email autopilot generation

    const { data: contacts = [], isLoading: isLoadingContacts } = useQuery({
        queryKey: ['contacts'],
        queryFn: () => base44.entities.Contact.list(),
    });

    const { data: allMessages = [] } = useQuery({
        queryKey: ['messages'],
        queryFn: () => base44.entities.Message.list(),
    });

    const draftedMessages = useMemo(() => {
        return allMessages.filter(m => m.message_type === 'draft');
    }, [allMessages]);

    const runAnalysisMutation = useMutation({
        mutationFn: async (contactsToAnalyze) => {
            const prompt = `
                You are a 'Relationship Maintenance Genius' AI for a real estate agent. Your goal is to analyze a list of contacts and provide actionable insights to strengthen the agent's sphere of influence.

                Here is the agent's contact list in JSON format:
                ${JSON.stringify(contactsToAnalyze)}

                Your tasks are:
                1.  **Analyze Relationship Health:** For each contact, determine their 'relationship_health' based on 'last_contact_date' and 'notes'. Use this logic:
                    - If 'last_contact_date' is within the last 30 days, health is 'strong'.
                    - If 'last_contact_date' is between 31 and 90 days ago, health is 'cooling'.
                    - If 'last_contact_date' is more than 90 days ago or null, health is 'at_risk'.
                2.  **Identify Actionable Insights:** Scan the 'notes' of each contact to find opportunities. Generate insights for the following:
                    - **Life Events:** Look for mentions of birthdays, anniversaries, new jobs, promotions, engagements, marriages, or new babies. Create a 'life_event_congratulation' insight.
                    - **Referral Opportunities:** Look for phrases like "my friend is looking to buy," "coworker is moving," or "family might sell." Create a 'referral_opportunity' insight.
                    - **Relationship Nurturing:** For any contact with 'at_risk' health, create a 'relationship_maintenance' insight suggesting a simple "check-in."

                You MUST return a JSON object with two keys: 'updated_contacts' and 'new_insights'.
                - 'updated_contacts': An array of objects, each with the contact 'id' and the new 'relationship_health' you determined.
                - 'new_insights': An array of insight objects to be created. Each must have 'insight_type', 'entity_type' ('contact'), 'entity_id' (the contact's id), 'title', 'description', and 'priority'.
            `;

            const responseSchema = {
                type: "object",
                properties: {
                    updated_contacts: {
                        type: "array",
                        items: {
                            type: "object",
                            properties: {
                                id: { type: "string" },
                                relationship_health: { type: "string", enum: ["strong", "cooling", "at_risk"] }
                            },
                            required: ["id", "relationship_health"]
                        }
                    },
                    new_insights: {
                        type: "array",
                        items: {
                            type: "object",
                            properties: {
                                insight_type: { type: "string" },
                                entity_type: { type: "string", "const": "contact" },
                                entity_id: { type: "string" },
                                title: { type: "string" },
                                description: { type: "string" },
                                priority: { type: "string", enum: ["high", "medium", "low"] }
                            },
                            required: ["insight_type", "entity_type", "entity_id", "title", "description", "priority"]
                        }
                    }
                },
                required: ["updated_contacts", "new_insights"]
            };

            return await base44.integrations.Core.InvokeLLM({ prompt, response_json_schema: responseSchema });
        },
        onSuccess: async (data) => {
            if (!data || !data.updated_contacts || !data.new_insights) {
                throw new Error("Invalid response from AI.");
            }

            const { updated_contacts, new_insights } = data;

            // Batch update contacts
            const contactUpdatePromises = updated_contacts.map(c =>
                base44.entities.Contact.update(c.id, {
                    relationship_health: c.relationship_health,
                    last_ai_analysis: new Date().toISOString()
                })
            );

            // Add user_id to insights before creating
            const currentUser = await base44.auth.me();
            const insightsToCreate = new_insights.map(insight => ({...insight, user_id: currentUser.id}));

            // Batch create insights
            const insightCreatePromise = insightsToCreate.length > 0
                ? base44.entities.AIInsight.bulkCreate(insightsToCreate)
                : Promise.resolve();

            await Promise.all([...contactUpdatePromises, insightCreatePromise]);

            toast.success(`Sphere analysis complete! Found ${new_insights.length} new insights.`);
            queryClient.invalidateQueries({ queryKey: ['contacts'] });
            queryClient.invalidateQueries({ queryKey: ['aiInsights'] });
        },
        onError: (error) => {
            console.error("Sphere analysis failed:", error);
            toast.error("AI analysis failed. Please check the console for details.");
        },
    });

    const runAutopilotMutation = useMutation({
        mutationFn: async ({ contactsToProcess, currentUser }) => {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            const dueContacts = contactsToProcess.filter(contact => {
                if (!contact.email) return false; // Only process contacts with an email
                if (!contact.last_contact_date) return true; // Always contact new ones without a last contact date
                const lastContactDate = new Date(contact.last_contact_date);
                return lastContactDate < thirtyDaysAgo;
            });

            if (dueContacts.length === 0) {
                toast.info("All contacts with emails are up to date (last contacted within 30 days). No new emails needed at this time.");
                return { created: 0 };
            }

            const draftsToCreate = [];
            
            for (const contact of dueContacts) {
                const prompt = `
Generate a friendly, professional 'check-in' email for a real estate agent to send to a contact in their sphere of influence.
The goal is to maintain the relationship, not to sell anything directly.

Agent: ${currentUser.full_name}
Contact Name: ${contact.name}
Contact Relationship: ${contact.relationship}
Notes about contact: ${contact.notes || 'No specific notes available.'}

The email should be concise, warm, and ask an open-ended question to encourage a reply.
Output a JSON object with "subject" and "body".`;

                try {
                    const response = await base44.integrations.Core.InvokeLLM({
                        prompt,
                        response_json_schema: {
                            type: "object",
                            properties: {
                                subject: { type: "string" },
                                body: { type: "string" },
                            },
                            required: ["subject", "body"],
                        },
                    });

                    draftsToCreate.push({
                        sender_id: currentUser.id,
                        recipient_email: contact.email,
                        subject: response.subject,
                        content: response.body,
                        message_type: 'draft',
                        thread_id: `contact_${contact.id}`,
                        contact_id: contact.id,
                    });
                } catch (e) {
                    console.error(`Failed to generate email for ${contact.name}`, e);
                    toast.error(`Failed to generate email for ${contact.name}.`);
                }
            }

            if (draftsToCreate.length > 0) {
                return base44.entities.Message.bulkCreate(draftsToCreate);
            }
            return { created: 0 };
        },
        onSuccess: (result) => {
            if ((result?.length || 0) > 0) {
                toast.success(`${result.length} email drafts have been generated! Please review them below.`);
                queryClient.invalidateQueries({ queryKey: ['messages'] });
            } else {
                toast.info("No new email drafts were generated.");
            }
        },
        onError: (error) => {
            console.error("Failed to run Autopilot:", error);
            toast.error("There was an error generating email drafts.");
        },
        onSettled: () => {
            setIsGenerating(false);
        }
    });

    const bulkSendMutation = useMutation({
        mutationFn: async (drafts) => {
            const currentUser = await base44.auth.me();
            if (!currentUser) throw new Error("User not authenticated.");

            const sendPromises = drafts.map(draft => 
                base44.integrations.Core.SendEmail({
                    to: draft.recipient_email,
                    subject: draft.subject,
                    body: draft.content,
                    from_name: currentUser.full_name
                })
            );
          
            await Promise.all(sendPromises);

            const updatePromises = drafts.map(draft =>
                base44.entities.Message.update(draft.id, { message_type: 'email' })
            );

            const contactUpdatePromises = drafts.map(draft => {
                if (draft.contact_id) {
                    return base44.entities.Contact.update(draft.contact_id, { last_contact_date: new Date().toISOString() });
                }
                return Promise.resolve();
            });

            return Promise.all([...updatePromises, ...contactUpdatePromises]);
        },
        onSuccess: () => {
            toast.success("All drafted emails have been sent successfully!");
            queryClient.invalidateQueries({ queryKey: ["messages"] });
            queryClient.invalidateQueries({ queryKey: ["contacts"] });
        },
        onError: (error) => {
            console.error("Bulk email send failed:", error);
            toast.error("Failed to send some emails. Please try again.");
        }
    });

    const bulkDeleteMutation = useMutation({
        mutationFn: async (draftIds) => {
            const deletePromises = draftIds.map(id => base44.entities.Message.delete(id));
            return Promise.all(deletePromises);
        },
        onSuccess: () => {
            toast.success("All drafts have been deleted.");
            queryClient.invalidateQueries({ queryKey: ["messages"] });
        },
        onError: (error) => {
            toast.error("Failed to delete drafts.");
            console.error("Error deleting drafts:", error);
        }
    });

    const handleRunAutopilot = async () => {
        setIsGenerating(true);
        const currentUser = await base44.auth.me();
        if (!currentUser) {
            toast.error("Could not determine current user. Please log in again.");
            setIsGenerating(false);
            return;
        }
        if (contacts.length === 0) {
            toast.info("No contacts found to generate emails for.");
            setIsGenerating(false);
            return;
        }
        runAutopilotMutation.mutate({ contactsToProcess: contacts, currentUser });
    };

    const handleBulkSend = () => {
        if (draftedMessages.length === 0) return;
        bulkSendMutation.mutate(draftedMessages);
    };
    
    const handleBulkDelete = () => {
        if (draftedMessages.length === 0) return;
        if (window.confirm(`Are you sure you want to delete all ${draftedMessages.length} drafts? This cannot be undone.`)) {
            const draftIds = draftedMessages.map(d => d.id);
            bulkDeleteMutation.mutate(draftIds);
        }
    };

    const filteredContacts = useMemo(() => ({
        at_risk: contacts.filter(c => c.relationship_health === 'at_risk'),
        cooling: contacts.filter(c => c.relationship_health === 'cooling'),
        strong: contacts.filter(c => c.relationship_health === 'strong'),
        unknown: contacts.filter(c => c.relationship_health === 'unknown'),
    }), [contacts]);

    return (
        <div className="p-4 sm:p-6 lg:p-8 bg-slate-50 dark:bg-gray-950 min-h-screen">
            <header className="mb-8">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h1 className="text-3xl font-bold tracking-tight text-slate-900 dark:text-white flex items-center gap-3">
                            <BrainCircuit className="w-8 h-8 text-primary" />
                            Sphere Relationship Autopilot
                        </h1>
                        <p className="mt-2 text-lg text-slate-600 dark:text-slate-400">
                            The Relationship Maintenance Genius. Let AI manage your sphere of influence.
                        </p>
                    </div>
                    <Button
                        size="lg"
                        onClick={() => runAnalysisMutation.mutate(contacts)}
                        disabled={runAnalysisMutation.isLoading || isLoadingContacts}
                        className="bg-primary hover:bg-primary/90 text-primary-foreground shadow-lg"
                    >
                        {runAnalysisMutation.isLoading ? (
                            <><Loader2 className="w-5 h-5 mr-2 animate-spin" /> Analyzing...</>
                        ) : (
                            <><Sparkles className="w-5 h-5 mr-2" /> Run AI Analysis</>
                        )}
                    </Button>
                </div>
                 <p className="text-sm text-slate-500 mt-4">
                    **Note on Social Media:** This tool cannot directly interact with social media. It will generate suggestions for you to act upon.
                 </p>
            </header>

            <Tabs defaultValue="dashboard" className="w-full">
                <TabsList className="grid w-full grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                    <TabsTrigger value="dashboard" className="flex items-center gap-2"><Users className="w-4 h-4" /> Sphere Dashboard</TabsTrigger>
                    <TabsTrigger value="strategy" className="flex items-center gap-2"><BookOpen className="w-4 h-4" /> Campaign Strategy</TabsTrigger>
                </TabsList>

                <TabsContent value="dashboard">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-8">
                            <Card>
                                <CardHeader>
                                    <CardTitle className="flex items-center gap-2">
                                        <Rocket className="w-5 h-5 text-indigo-500" />
                                        SOI Autopilot System
                                    </CardTitle>
                                    <CardDescription>Generate personalized email drafts for contacts needing a follow-up.</CardDescription>
                                </CardHeader>
                                <CardContent>
                                    <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                                        Click the button below to have the AI analyze your contacts. It will automatically generate personalized draft emails for everyone you haven't contacted in the last 30 days (and have an email address). You can then review and send them from here.
                                    </p>
                                    <Button 
                                        size="lg" 
                                        className="w-full" 
                                        onClick={handleRunAutopilot}
                                        disabled={isGenerating || isLoadingContacts}
                                    >
                                        {isGenerating ? (
                                            <>
                                                <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                                Generating Drafts...
                                            </>
                                        ) : (
                                            <>
                                                <Sparkles className="w-5 h-5 mr-2" />
                                                Run Autopilot & Generate Drafts
                                            </>
                                        )}
                                    </Button>
                                </CardContent>
                            </Card>
                            {draftedMessages.length > 0 && (
                               <Card>
                                  <CardHeader>
                                      <div className="flex items-center justify-between">
                                          <CardTitle className="flex items-center gap-2">
                                              <Send className="w-5 h-5 text-blue-500" />
                                              Outgoing Mail ({draftedMessages.length})
                                          </CardTitle>
                                           <div className="flex items-center gap-2">
                                              <Button 
                                                  variant="outline" 
                                                  size="sm"
                                                  onClick={handleBulkDelete}
                                                  disabled={bulkDeleteMutation.isLoading || bulkSendMutation.isLoading}
                                              >
                                                  <Trash2 className="w-4 h-4 mr-2" />
                                                  Delete All
                                              </Button>
                                              <Button 
                                                  size="sm"
                                                  onClick={handleBulkSend}
                                                  disabled={bulkSendMutation.isLoading || bulkDeleteMutation.isLoading}
                                              >
                                                  {bulkSendMutation.isLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Send className="w-4 h-4 mr-2" />}
                                                  Send All
                                              </Button>
                                          </div>
                                      </div>
                                      <CardDescription>
                                          Review and send the email drafts generated by the Autopilot.
                                      </CardDescription>
                                  </CardHeader>
                                  <CardContent>
                                      <ScrollArea className="h-[400px] pr-4">
                                          <div className="space-y-4">
                                          {draftedMessages.map(draft => (
                                              <div key={draft.id} className="p-4 border rounded-lg bg-white dark:bg-slate-800">
                                                  <p className="text-sm font-semibold text-slate-900 dark:text-white">To: <span className="font-normal">{draft.recipient_email}</span></p>
                                                  <p className="text-sm font-semibold text-slate-900 dark:text-white mt-1">Subject: <span className="font-normal">{draft.subject}</span></p>
                                                  <hr className="my-2 border-slate-200 dark:border-slate-700"/>
                                                  <p className="text-sm text-slate-600 dark:text-slate-300 whitespace-pre-wrap">{draft.content}</p>
                                              </div>
                                          ))}
                                          </div>
                                      </ScrollArea>
                                  </CardContent>
                               </Card>
                            )}
                            <Card>
                                <CardHeader>
                                    <CardTitle className="flex items-center gap-2">
                                        <Users className="w-5 h-5" />
                                        Your Sphere of Influence
                                    </CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <Tabs defaultValue="at_risk">
                                        <TabsList className="grid w-full grid-cols-4">
                                            <TabsTrigger value="at_risk">At Risk ({filteredContacts.at_risk.length})</TabsTrigger>
                                            <TabsTrigger value="cooling">Cooling ({filteredContacts.cooling.length})</TabsTrigger>
                                            <TabsTrigger value="strong">Strong ({filteredContacts.strong.length})</TabsTrigger>
                                            <TabsTrigger value="unknown">Unknown ({filteredContacts.unknown.length})</TabsTrigger>
                                        </TabsList>
                                        <div className="mt-4">
                                            {isLoadingContacts && (
                                                <div className="flex justify-center p-8"><Loader2 className="w-8 h-8 animate-spin" /></div>
                                            )}
                                            <TabsContent value="at_risk">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {filteredContacts.at_risk.map(contact => <ContactCard key={contact.id} contact={contact} />)}
                                                </div>
                                            </TabsContent>
                                            <TabsContent value="cooling">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {filteredContacts.cooling.map(contact => <ContactCard key={contact.id} contact={contact} />)}
                                                </div>
                                            </TabsContent>
                                            <TabsContent value="strong">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {filteredContacts.strong.map(contact => <ContactCard key={contact.id} contact={contact} />)}
                                                </div>
                                            </TabsContent>
                                             <TabsContent value="unknown">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {filteredContacts.unknown.map(contact => <ContactCard key={contact.id} contact={contact} />)}
                                                </div>
                                            </TabsContent>
                                        </div>
                                    </Tabs>
                                </CardContent>
                            </Card>
                        </div>
                        <div className="lg:col-span-1">
                            <AIInsightsPanel />
                        </div>
                    </div>
                </TabsContent>
                <TabsContent value="strategy">
                    <SOICampaignGuide />
                </TabsContent>
            </Tabs>
        </div>
    );
};

export default SphereAutopilot;

import React from "react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import {
  ArrowLeft,
  Home,
  User,
  MapPin,
  Mail,
  Phone,
  DollarSign,
  Calendar,
  Ruler,
  BedDouble,
  Bath,
  FileText,
  Building2
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

export default function SubdivisionPropertyDetail() {
  const navigate = useNavigate();
  
  // Get property data from URL params
  const urlParams = new URLSearchParams(window.location.search);
  const propertyData = urlParams.get('data');
  
  let property = null;
  try {
    property = propertyData ? JSON.parse(decodeURIComponent(propertyData)) : null;
  } catch (e) {
    console.error('Error parsing property data:', e);
  }

  if (!property) {
    return (
      <div className="p-6">
        <Card>
          <CardContent className="p-12 text-center">
            <p className="text-slate-600">No property data found</p>
            <Button className="mt-4" onClick={() => navigate(createPageUrl("SubdivisionSearch"))}>
              Back to Search
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  const InfoRow = ({ icon: Icon, label, value, highlight }) => (
    <div className="flex items-start gap-3 py-3 border-b border-slate-100 dark:border-slate-800 last:border-0">
      <Icon className="w-5 h-5 text-slate-400 mt-0.5 flex-shrink-0" />
      <div className="flex-1">
        <p className="text-xs text-slate-500 uppercase tracking-wide">{label}</p>
        <p className={`text-sm mt-0.5 ${highlight ? 'font-semibold text-indigo-600' : 'text-slate-900 dark:text-white'}`}>
          {value || 'Not available'}
        </p>
      </div>
    </div>
  );

  // Check if mailing address is same as property
  const normalizedMailing = (property.owner_mailing_address || '').toLowerCase().replace(/\s+/g, ' ').trim();
  const normalizedProp = (property.address || '').toLowerCase().replace(/\s+/g, ' ').trim();
  const isSameAddress = normalizedMailing && normalizedProp && 
    (normalizedMailing === normalizedProp || 
     normalizedMailing.includes(normalizedProp.split(',')[0]) ||
     normalizedProp.includes(normalizedMailing.split(',')[0]));

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <Card>
        <CardContent className="p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => window.history.back()}
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <h1 className="text-xl font-bold text-slate-900 dark:text-white">
                {property.address}
              </h1>
              <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">
                {property.subdivision || 'Property Details'}
              </p>
            </div>
            <Home className="w-8 h-8 text-indigo-600" />
          </div>
        </CardContent>
      </Card>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Owner Information */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-lg">
              <User className="w-5 h-5" />
              Owner Information
            </CardTitle>
          </CardHeader>
          <CardContent>
            <InfoRow 
              icon={User} 
              label="Owner Name" 
              value={property.owner_name || 'Unknown'} 
              highlight={true}
            />
            <InfoRow 
              icon={Mail} 
              label="Mailing Address" 
              value={isSameAddress ? 'Same as property address' : property.owner_mailing_address} 
            />
            <InfoRow 
              icon={Phone} 
              label="Phone" 
              value={property.owner_phone} 
            />
            <InfoRow 
              icon={Mail} 
              label="Email" 
              value={property.owner_email} 
            />
            {property.ownership_length_years && (
              <InfoRow 
                icon={Calendar} 
                label="Ownership Duration" 
                value={`${property.ownership_length_years} years`} 
              />
            )}
          </CardContent>
        </Card>

        {/* Property Information */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-lg">
              <Home className="w-5 h-5" />
              Property Information
            </CardTitle>
          </CardHeader>
          <CardContent>
            <InfoRow 
              icon={MapPin} 
              label="Property Address" 
              value={property.address} 
            />
            <InfoRow 
              icon={FileText} 
              label="Parcel ID (PID)" 
              value={property.parcel_id} 
            />
            <InfoRow 
              icon={Building2} 
              label="Property Type" 
              value={property.property_type} 
            />
            <InfoRow 
              icon={MapPin} 
              label="Subdivision" 
              value={property.subdivision} 
            />
          </CardContent>
        </Card>

        {/* Property Details */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-lg">
              <Ruler className="w-5 h-5" />
              Property Details
            </CardTitle>
          </CardHeader>
          <CardContent>
            <InfoRow 
              icon={Ruler} 
              label="Square Feet" 
              value={property.square_feet ? `${property.square_feet.toLocaleString()} sqft` : null} 
            />
            <InfoRow 
              icon={MapPin} 
              label="Lot Size" 
              value={property.lot_size ? `${property.lot_size} acres` : null} 
            />
            <InfoRow 
              icon={BedDouble} 
              label="Bedrooms" 
              value={property.bedrooms || null} 
            />
            <InfoRow 
              icon={Bath} 
              label="Bathrooms" 
              value={property.bathrooms || null} 
            />
            <InfoRow 
              icon={Calendar} 
              label="Year Built" 
              value={property.year_built || null} 
            />
          </CardContent>
        </Card>

        {/* Valuation */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-lg">
              <DollarSign className="w-5 h-5" />
              Valuation
            </CardTitle>
          </CardHeader>
          <CardContent>
            <InfoRow 
              icon={DollarSign} 
              label="Estimated Value" 
              value={property.estimated_value ? `$${property.estimated_value.toLocaleString()}` : null} 
              highlight={true}
            />
            {property.avm_low > 0 && property.avm_high > 0 && (
              <InfoRow 
                icon={DollarSign} 
                label="Value Range" 
                value={`$${property.avm_low.toLocaleString()} - $${property.avm_high.toLocaleString()}`} 
              />
            )}
            {property.assessed_value && property.assessed_value !== property.estimated_value && (
              <InfoRow 
                icon={DollarSign} 
                label="Assessed Value" 
                value={`$${property.assessed_value.toLocaleString()}`} 
              />
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import { base44 } from "@/api/base44Client";
import { createPageUrl } from "@/utils";
import {
  Search,
  Download,
  Save,
  MapPin,
  Home,
  Mail,
  Phone,
  Loader2,
  CheckCircle2,
  AlertCircle,
  Database,
  ChevronRight,
  User,
  DollarSign,
  Calendar,
  Ruler
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { attomPropertyData } from "@/api/functions";

export default function SubdivisionSearch() {
  const navigate = useNavigate();
  const [searchQuery, setSearchQuery] = useState("");
  const [searchType, setSearchType] = useState("subdivision");
  const [zipCode, setZipCode] = useState("");
  const [locationInfo, setLocationInfo] = useState(null);
  const [isIdentifyingLocation, setIsIdentifyingLocation] = useState(false);
  const [isSearching, setIsSearching] = useState(false);
  const [results, setResults] = useState(null);
  const [selectedProperties, setSelectedProperties] = useState([]);
  const [isSaving, setIsSaving] = useState(false);

  const [subdivisionSuggestions, setSubdivisionSuggestions] = useState([]);

      const handleIdentifyLocation = async () => {
        if (!zipCode || zipCode.length < 5) {
          toast.error("Please enter a valid 5-digit ZIP code");
          return;
        }

        setIsIdentifyingLocation(true);
        setSubdivisionSuggestions([]);
        try {
          const response = await base44.integrations.Core.InvokeLLM({
            prompt: `For ZIP code ${zipCode}, provide:
  1. The city name, state abbreviation, and county name
  2. A list of 10-15 popular subdivisions, neighborhoods, or communities in this ZIP code area

  Search the internet to find real subdivision and neighborhood names that exist in this area.`,
            add_context_from_internet: true,
            response_json_schema: {
              type: "object",
              properties: {
                zip_code: { type: "string" },
                city: { type: "string" },
                state: { type: "string" },
                county: { type: "string" },
                subdivisions: { type: "array", items: { type: "string" } },
                confidence: { type: "string", enum: ["high", "medium", "low"] }
              }
            }
          });

          if (response && response.city && response.state) {
            setLocationInfo({
              city: response.city,
              state: response.state,
              county: response.county || ''
            });
            if (response.subdivisions && response.subdivisions.length > 0) {
              setSubdivisionSuggestions(response.subdivisions);
            }
            toast.success(`Found: ${response.city}, ${response.state}`);
          } else {
            toast.error("Could not identify location");
            setLocationInfo(null);
          }
        } catch (error) {
          toast.error("Failed to identify location");
          setLocationInfo(null);
        }
        setIsIdentifyingLocation(false);
      };

  const handleSearch = async () => {
    if (!searchQuery.trim() || !zipCode || !locationInfo) {
      toast.error("Please fill in all fields");
      return;
    }

    setIsSearching(true);
    setResults(null);
    setSelectedProperties([]);

    try {
      toast.info(`Finding addresses in "${searchQuery}"...`);

      const addressLookup = await base44.integrations.Core.InvokeLLM({
        prompt: `I need real street addresses in the "${searchQuery}" ${searchType} in ${locationInfo.city}, ${locationInfo.state} ${zipCode}.

Search the internet and find 20-50 actual house addresses with street numbers. These should be real addresses that exist in this subdivision/neighborhood.

Return addresses in format: "123 Main Street" (just house number and street name, no city/state/zip).

Examples of good format:
- "1234 Oak Lane"
- "567 Maple Drive"
- "890 Pine Court"`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            addresses: { type: "array", items: { type: "string" } },
            total_estimated_homes: { type: "number" },
            notes: { type: "string" }
          }
        }
      });

      console.log('Address lookup result:', addressLookup);

      if (!addressLookup?.addresses || addressLookup.addresses.length === 0) {
        toast.warning("Could not find addresses in this area. Try a different subdivision name.");
        setResults({ properties: [] });
        setIsSearching(false);
        return;
      }

      toast.info(`Found ${addressLookup.addresses.length} addresses, fetching ATTOM data...`);

      const propertiesWithData = [];
      let processed = 0;

      for (const addr of addressLookup.addresses) {
        try {
          const [ownerResult, avmResult] = await Promise.all([
            attomPropertyData({
              action: 'propertyDetailWithOwner',
              address: addr,
              address2: zipCode
            }).catch((e) => { console.log('Owner fetch error:', e); return null; }),
            attomPropertyData({
              action: 'avm',
              address: addr,
              address2: zipCode
            }).catch((e) => { console.log('AVM fetch error:', e); return null; })
          ]);

          // Log first result for debugging
          if (processed === 0) {
            console.log('Raw ownerResult:', ownerResult);
          }

          const ownerResponse = ownerResult?.data?.data || ownerResult?.data;
          const avmResponse = avmResult?.data?.data || avmResult?.data;
          const detailedProp = ownerResponse?.property?.[0];
          const avmData = avmResponse?.property?.[0]?.avm;
          
          // If no ATTOM data, still add the address with basic info
          if (!detailedProp) {
            propertiesWithData.push({
              parcel_id: '',
              address: `${addr}, ${locationInfo.city}, ${locationInfo.state} ${zipCode}`,
              zip_code: zipCode,
              property_type: 'Unknown',
              square_feet: 0,
              year_built: 0,
              estimated_value: 0,
              avm_low: 0,
              avm_high: 0,
              lot_size: 0,
              bedrooms: 0,
              bathrooms: 0,
              owner_name: '',
              owner_mailing_address: '',
              owner_phone: '',
              owner_email: '',
              subdivision: searchQuery
            });
            processed++;
            continue;
          }

          if (detailedProp) {
            const owner = detailedProp.owner || {};
            const building = detailedProp.building || {};
            const summary = detailedProp.summary || {};
            const propAddress = detailedProp.address || {};
            const assessment = detailedProp.assessment || {};
            const identifier = detailedProp.identifier || {};

            // Try multiple paths for owner name - ATTOM uses different structures
            let ownerName = '';
            if (owner.owner1?.fullName) {
              ownerName = owner.owner1.fullName;
            } else if (owner.owner1?.name) {
              ownerName = owner.owner1.name;
            } else if (owner.owner1?.lastName && owner.owner1?.firstName) {
              ownerName = `${owner.owner1.firstName} ${owner.owner1.lastName}`;
            } else if (owner.owner1?.lastName) {
              ownerName = owner.owner1.lastName;
            } else if (detailedProp.ownerName) {
              ownerName = detailedProp.ownerName;
            } else if (summary.ownerName) {
              ownerName = summary.ownerName;
            } else if (summary.absenteeInd === 'Y' || owner.absenteeOwnerStatus) {
              ownerName = 'Absentee Owner';
            }

            const mailingAddress = owner.mailingAddress?.oneLine || owner.mailingaddressoneline ||
              (owner.mailingAddress?.line1 ? `${owner.mailingAddress.line1}, ${owner.mailingAddress.locality || ''} ${owner.mailingAddress.countrySubd || ''} ${owner.mailingAddress.postal1 || ''}` : '');

            const parcelId = summary.apn || identifier.apn || identifier.attomId || summary.propId || '';

            const estimatedValue = avmData?.amount?.value || avmData?.value ||
              assessment.assessed?.assdttlvalue || assessment.market?.mktttlvalue || summary.estimatedValue || 0;

            propertiesWithData.push({
              parcel_id: typeof parcelId === 'object' ? parcelId.apnOneLine || JSON.stringify(parcelId) : parcelId,
              address: propAddress.oneLine || `${addr}, ${locationInfo.city}, ${locationInfo.state} ${zipCode}`,
              zip_code: propAddress.postal1 || zipCode,
              property_type: summary.proptype || summary.propclass || 'Unknown',
              square_feet: building.size?.livingsize || building.size?.bldgsize || 0,
              year_built: summary.yearbuilt || building.summary?.yearbuilt || 0,
              estimated_value: estimatedValue,
              avm_low: avmData?.amount?.low || 0,
              avm_high: avmData?.amount?.high || 0,
              lot_size: detailedProp.lot?.lotsize2 ? (detailedProp.lot.lotsize2 / 43560).toFixed(2) : 0,
              bedrooms: building.rooms?.beds || 0,
              bathrooms: building.rooms?.bathstotal || 0,
              owner_name: ownerName,
              owner_mailing_address: mailingAddress,
              owner_phone: owner.phone || '',
              owner_email: owner.email || '',
              subdivision: summary.subdivision || searchQuery
            });
          }

          processed++;
          if (processed % 10 === 0) {
            toast.info(`Processed ${processed}/${addressLookup.addresses.length}...`);
          }
          await new Promise(r => setTimeout(r, 200));
        } catch (e) {
          console.log(`Could not fetch data for ${addr}`);
        }
      }

      const uniqueProperties = propertiesWithData.filter((prop, index, self) =>
        index === self.findIndex(p => (p.parcel_id === prop.parcel_id && p.parcel_id !== '') || p.address === prop.address)
      );

      if (uniqueProperties.length > 0) {
        const avgValue = uniqueProperties.reduce((sum, p) => sum + (p.estimated_value || 0), 0) / uniqueProperties.length;
        setResults({
          subdivision_name: searchQuery,
          total_properties: uniqueProperties.length,
          average_home_value: avgValue,
          properties: uniqueProperties,
          search_confidence: uniqueProperties.length >= 20 ? 'high' : uniqueProperties.length >= 10 ? 'medium' : 'low'
        });
        toast.success(`Found ${uniqueProperties.length} properties`);
      } else {
        toast.warning("No properties found");
        setResults({ properties: [] });
      }
    } catch (error) {
      toast.error(`Search failed: ${error.message}`);
      setResults({ properties: [] });
    }

    setIsSearching(false);
  };

  const toggleSelectAll = () => {
    if (results?.properties) {
      setSelectedProperties(
        selectedProperties.length === results.properties.length ? [] : results.properties.map((_, i) => i)
      );
    }
  };

  const toggleSelectProperty = (index) => {
    setSelectedProperties(prev =>
      prev.includes(index) ? prev.filter(i => i !== index) : [...prev, index]
    );
  };

  const handleSaveToContacts = async () => {
    if (selectedProperties.length === 0) {
      toast.error("Please select properties to save");
      return;
    }
    setIsSaving(true);
    let successCount = 0;

    for (const index of selectedProperties) {
      const property = results.properties[index];
      try {
        await base44.entities.Contact.create({
          name: property.owner_name || "Unknown Owner",
          email: property.owner_email || "",
          phone: property.owner_phone || "",
          relationship: "professional",
          notes: `Property: ${property.address}\nPID: ${property.parcel_id || 'N/A'}\nValue: $${(property.estimated_value || 0).toLocaleString()}`,
          tags: `${searchQuery}, Geographic Farming, Homeowner`
        });
        successCount++;
        await new Promise(resolve => setTimeout(resolve, 300));
      } catch (error) {
        console.error("Error saving:", error);
      }
    }

    toast.success(`Saved ${successCount} contacts`);
    setSelectedProperties([]);
    setIsSaving(false);
  };

  const handleDownloadCSV = () => {
    if (!results?.properties?.length) return;
    const props = selectedProperties.length > 0 ? selectedProperties.map(i => results.properties[i]) : results.properties;
    const headers = ['PID', 'Owner Name', 'Mailing Address', 'Phone', 'Email', 'Property Address', 'Type', 'SqFt', 'Year Built', 'Est. Value', 'Beds', 'Baths'];
    const csv = [headers.join(','), ...props.map(p => [
      `"${p.parcel_id || ''}"`, `"${p.owner_name || ''}"`, `"${p.owner_mailing_address || ''}"`,
      `"${p.owner_phone || ''}"`, `"${p.owner_email || ''}"`, `"${p.address || ''}"`,
      `"${p.property_type || ''}"`, p.square_feet || '', p.year_built || '',
      p.estimated_value || '', p.bedrooms || '', p.bathrooms || ''
    ].join(','))].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${searchQuery}_${zipCode}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    toast.success(`Exported ${props.length} properties`);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
      {/* Hero Header */}
      <div className="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 text-white">
        <div className="max-w-7xl mx-auto px-6 py-12">
          <div className="flex items-center gap-4 mb-2">
            <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
              <Database className="w-8 h-8" />
            </div>
            <div>
              <h1 className="text-3xl font-bold">Community Search</h1>
              <p className="text-indigo-100 mt-1">Powered by ATTOM Property Data</p>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-6 -mt-6">
        {/* Search Card */}
        <Card className="shadow-xl border-0 mb-8">
          <CardContent className="p-8">
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
              {/* Search Type */}
              <div className="lg:col-span-3">
                <label className="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 block">Search Type</label>
                <div className="grid grid-cols-2 gap-2">
                  <button
                    onClick={() => setSearchType('subdivision')}
                    className={`p-3 rounded-xl border-2 transition-all flex flex-col items-center gap-1 ${
                      searchType === 'subdivision' 
                        ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' 
                        : 'border-slate-200 dark:border-slate-700 hover:border-slate-300'
                    }`}
                  >
                    <Home className="w-5 h-5" />
                    <span className="text-xs font-medium">Subdivision</span>
                  </button>
                  <button
                    onClick={() => setSearchType('neighborhood')}
                    className={`p-3 rounded-xl border-2 transition-all flex flex-col items-center gap-1 ${
                      searchType === 'neighborhood' 
                        ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' 
                        : 'border-slate-200 dark:border-slate-700 hover:border-slate-300'
                    }`}
                  >
                    <MapPin className="w-5 h-5" />
                    <span className="text-xs font-medium">Neighborhood</span>
                  </button>
                </div>
              </div>

              {/* ZIP Code */}
              <div className="lg:col-span-3">
                <label className="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 block">ZIP Code</label>
                <div className="relative">
                  <Input
                    value={zipCode}
                    onChange={(e) => {
                      const val = e.target.value.replace(/[^0-9]/g, '').slice(0, 5);
                      setZipCode(val);
                      if (val.length < 5) setLocationInfo(null);
                    }}
                    placeholder="Enter ZIP"
                    className="pr-24 h-12 text-lg"
                    maxLength={5}
                    onKeyPress={(e) => e.key === 'Enter' && zipCode.length === 5 && handleIdentifyLocation()}
                  />
                  <Button
                    size="sm"
                    onClick={handleIdentifyLocation}
                    disabled={isIdentifyingLocation || zipCode.length < 5}
                    className="absolute right-1.5 top-1.5 h-9"
                  >
                    {isIdentifyingLocation ? <Loader2 className="w-4 h-4 animate-spin" /> : 'Lookup'}
                  </Button>
                </div>
                {locationInfo && (
                    <div className="mt-2 flex items-center gap-2 text-sm text-green-600 dark:text-green-400">
                      <CheckCircle2 className="w-4 h-4" />
                      {locationInfo.city}, {locationInfo.state}
                    </div>
                  )}
                </div>

                {/* Area Name */}
                <div className="lg:col-span-4">
                  <label className="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 block">
                    {searchType === 'neighborhood' ? 'Neighborhood' : 'Subdivision'} Name
                  </label>
                  <Input
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder={searchType === 'neighborhood' ? 'e.g., Brickell, Lincoln Park' : 'e.g., Oak Valley, Sunset Hills'}
                    className="h-12 text-lg"
                    onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                    disabled={!locationInfo}
                  />
                  {/* Subdivision Suggestions */}
                  {subdivisionSuggestions.length > 0 && (
                    <div className="mt-2 flex flex-wrap gap-2">
                      {subdivisionSuggestions.slice(0, 8).map((sub, idx) => (
                        <button
                          key={idx}
                          onClick={() => setSearchQuery(sub)}
                          className={`px-3 py-1 text-xs rounded-full border transition-all ${
                            searchQuery === sub
                              ? 'bg-indigo-600 text-white border-indigo-600'
                              : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:border-indigo-400 text-slate-700 dark:text-slate-300'
                          }`}
                        >
                          {sub}
                        </button>
                      ))}
                    </div>
                  )}
                </div>

              {/* Search Button */}
              <div className="lg:col-span-2 flex items-end">
                <Button
                  onClick={handleSearch}
                  disabled={isSearching || !searchQuery.trim() || !locationInfo}
                  className="w-full h-12 text-base bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                  size="lg"
                >
                  {isSearching ? (
                    <Loader2 className="w-5 h-5 animate-spin" />
                  ) : (
                    <>
                      <Search className="w-5 h-5 mr-2" />
                      Search
                    </>
                  )}
                </Button>
              </div>
            </div>

            {/* Info Banner */}
            <div className="mt-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-xl flex items-start gap-3">
              <Database className="w-5 h-5 text-indigo-600 dark:text-indigo-400 mt-0.5 flex-shrink-0" />
              <div>
                <p className="text-sm font-medium text-indigo-900 dark:text-indigo-100">ATTOM Property Data</p>
                <p className="text-xs text-indigo-700 dark:text-indigo-300 mt-0.5">
                  Get accurate owner names, mailing addresses, property values, and more from comprehensive tax records.
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Results */}
        {results && (
          <>
            {/* Stats */}
            {results.properties?.length > 0 && (
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <Card className="border-0 shadow-lg">
                  <CardContent className="p-5">
                    <div className="flex items-center gap-3">
                      <div className="p-2.5 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg">
                        <Home className="w-5 h-5 text-indigo-600 dark:text-indigo-400" />
                      </div>
                      <div>
                        <p className="text-2xl font-bold text-slate-900 dark:text-white">{results.total_properties}</p>
                        <p className="text-xs text-slate-500">Properties Found</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
                <Card className="border-0 shadow-lg">
                  <CardContent className="p-5">
                    <div className="flex items-center gap-3">
                      <div className="p-2.5 bg-green-100 dark:bg-green-900/50 rounded-lg">
                        <DollarSign className="w-5 h-5 text-green-600 dark:text-green-400" />
                      </div>
                      <div>
                        <p className="text-2xl font-bold text-slate-900 dark:text-white">
                          ${((results.average_home_value || 0) / 1000).toFixed(0)}K
                        </p>
                        <p className="text-xs text-slate-500">Avg. Value</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
                <Card className="border-0 shadow-lg">
                  <CardContent className="p-5">
                    <div className="flex items-center gap-3">
                      <div className="p-2.5 bg-purple-100 dark:bg-purple-900/50 rounded-lg">
                        <User className="w-5 h-5 text-purple-600 dark:text-purple-400" />
                      </div>
                      <div>
                        <p className="text-2xl font-bold text-slate-900 dark:text-white">
                          {results.properties.filter(p => p.owner_name).length}
                        </p>
                        <p className="text-xs text-slate-500">With Owner Data</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
                <Card className="border-0 shadow-lg">
                  <CardContent className="p-5">
                    <div className="flex items-center gap-3">
                      <div className="p-2.5 bg-amber-100 dark:bg-amber-900/50 rounded-lg">
                        <CheckCircle2 className="w-5 h-5 text-amber-600 dark:text-amber-400" />
                      </div>
                      <div>
                        <p className="text-2xl font-bold text-slate-900 dark:text-white capitalize">
                          {results.search_confidence}
                        </p>
                        <p className="text-xs text-slate-500">Data Quality</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>
            )}

            {/* Actions Bar */}
            {results.properties?.length > 0 && (
              <Card className="border-0 shadow-lg mb-6">
                <CardContent className="p-4">
                  <div className="flex flex-wrap items-center justify-between gap-4">
                    <div className="flex items-center gap-4">
                      <Button variant="outline" size="sm" onClick={toggleSelectAll}>
                        {selectedProperties.length === results.properties.length ? 'Deselect All' : 'Select All'}
                      </Button>
                      <Badge variant="secondary" className="px-3 py-1">
                        {selectedProperties.length} selected
                      </Badge>
                    </div>
                    <div className="flex gap-2">
                      <Button
                        onClick={handleSaveToContacts}
                        disabled={isSaving || selectedProperties.length === 0}
                        className="bg-green-600 hover:bg-green-700"
                      >
                        {isSaving ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
                        Save to Contacts
                      </Button>
                      <Button onClick={handleDownloadCSV} variant="outline">
                        <Download className="w-4 h-4 mr-2" />
                        Export CSV
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}

            {/* Property Cards */}
            {results.properties?.length > 0 && (
              <div className="grid gap-4">
                {results.properties.map((property, index) => {
                  const mailingAddr = property.owner_mailing_address || '';
                  const propAddr = property.address || '';
                  const normalizedMailing = mailingAddr.toLowerCase().replace(/\s+/g, ' ').trim();
                  const normalizedProp = propAddr.toLowerCase().replace(/\s+/g, ' ').trim();
                  const isSameAddress = normalizedMailing && normalizedProp && 
                    (normalizedMailing === normalizedProp || normalizedMailing.includes(normalizedProp.split(',')[0]));

                  return (
                    <Card 
                      key={index}
                      className={`border-0 shadow-lg hover:shadow-xl transition-all cursor-pointer ${
                        selectedProperties.includes(index) ? 'ring-2 ring-indigo-500' : ''
                      }`}
                      onClick={(e) => {
                        if (e.target.type === 'checkbox') return;
                        navigate(createPageUrl('SubdivisionPropertyDetail') + `?data=${encodeURIComponent(JSON.stringify(property))}`);
                      }}
                    >
                      <CardContent className="p-5">
                        <div className="flex items-start gap-4">
                          {/* Checkbox */}
                          <div className="pt-1">
                            <input
                              type="checkbox"
                              checked={selectedProperties.includes(index)}
                              onChange={() => toggleSelectProperty(index)}
                              className="w-5 h-5 rounded border-slate-300"
                            />
                          </div>

                          {/* Main Content */}
                          <div className="flex-1 min-w-0">
                            <div className="flex items-start justify-between gap-4">
                              {/* Left: Owner & Address */}
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                  <User className="w-4 h-4 text-indigo-500 flex-shrink-0" />
                                  <h3 className="font-semibold text-slate-900 dark:text-white truncate text-base">
                                    {property.owner_name && property.owner_name.trim() ? property.owner_name : 'Owner Name Not Available'}
                                  </h3>
                                  {property.owner_name && property.owner_name.trim() && (
                                    <Badge className="bg-green-100 text-green-700 text-xs">Verified</Badge>
                                  )}
                                </div>
                                <p className="text-sm text-slate-600 dark:text-slate-400 flex items-center gap-1.5">
                                  <MapPin className="w-3.5 h-3.5 flex-shrink-0" />
                                  {property.address}
                                </p>
                                
                                {/* Mailing Address */}
                                <div className="mt-2 flex items-center gap-1.5 text-sm">
                                  <Mail className="w-3.5 h-3.5 text-slate-400 flex-shrink-0" />
                                  {!mailingAddr ? (
                                    <span className="text-slate-400 italic">No mailing address</span>
                                  ) : isSameAddress ? (
                                    <span className="text-green-600 dark:text-green-400 font-medium">Same as property</span>
                                  ) : (
                                    <span className="text-slate-600 dark:text-slate-400">{mailingAddr}</span>
                                  )}
                                </div>

                                {/* Contact */}
                                {(property.owner_phone || property.owner_email) && (
                                  <div className="mt-2 flex items-center gap-4 text-sm">
                                    {property.owner_phone && (
                                      <span className="flex items-center gap-1 text-slate-600 dark:text-slate-400">
                                        <Phone className="w-3.5 h-3.5" />
                                        {property.owner_phone}
                                      </span>
                                    )}
                                    {property.owner_email && (
                                      <span className="flex items-center gap-1 text-slate-600 dark:text-slate-400">
                                        <Mail className="w-3.5 h-3.5" />
                                        {property.owner_email}
                                      </span>
                                    )}
                                  </div>
                                )}
                              </div>

                              {/* Right: Property Details */}
                              <div className="flex items-center gap-6 flex-shrink-0">
                                <div className="text-right">
                                  <p className="text-xl font-bold text-green-600 dark:text-green-400">
                                    ${((property.estimated_value || 0) / 1000).toFixed(0)}K
                                  </p>
                                  <p className="text-xs text-slate-500">Est. Value</p>
                                </div>
                                
                                <div className="hidden md:flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400">
                                  {property.square_feet > 0 && (
                                    <div className="flex items-center gap-1">
                                      <Ruler className="w-4 h-4" />
                                      {property.square_feet.toLocaleString()} sqft
                                    </div>
                                  )}
                                  {property.year_built > 0 && (
                                    <div className="flex items-center gap-1">
                                      <Calendar className="w-4 h-4" />
                                      {property.year_built}
                                    </div>
                                  )}
                                  {property.bedrooms > 0 && (
                                    <span>{property.bedrooms} bd / {property.bathrooms} ba</span>
                                  )}
                                </div>

                                <ChevronRight className="w-5 h-5 text-slate-400" />
                              </div>
                            </div>

                            {/* Tags */}
                            <div className="mt-3 flex flex-wrap gap-2">
                              {property.parcel_id && (
                                <Badge variant="outline" className="text-xs">
                                  PID: {property.parcel_id}
                                </Badge>
                              )}
                              {property.property_type && property.property_type !== 'Unknown' && (
                                <Badge variant="secondary" className="text-xs">
                                  {property.property_type}
                                </Badge>
                              )}
                            </div>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  );
                })}
              </div>
            )}

            {/* Empty State */}
            {results.properties?.length === 0 && (
              <Card className="border-0 shadow-lg">
                <CardContent className="p-16 text-center">
                  <AlertCircle className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                  <h3 className="text-xl font-semibold text-slate-900 dark:text-white mb-2">No Properties Found</h3>
                  <p className="text-slate-600 dark:text-slate-400 max-w-md mx-auto">
                    Try checking the spelling, verifying the ZIP code, or searching for a different area.
                  </p>
                </CardContent>
              </Card>
            )}
          </>
        )}
      </div>
    </div>
  );
}
import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent, CardDescription, CardFooter } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import { toast } from 'sonner';
import { Home, Package, ListChecks, Check, ArrowRight, Loader2, FileCheck2, CheckCircle2 } from 'lucide-react';
import { addDays, format } from 'date-fns';
import { Badge } from '@/components/ui/badge';

const StepIndicator = ({ currentStep, stepNumber, title }) => {
    const isActive = currentStep === stepNumber;
    const isCompleted = currentStep > stepNumber;

    return (
        <div className="flex items-center">
            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white ${isCompleted ? 'bg-green-600' : isActive ? 'bg-blue-600' : 'bg-slate-300 dark:bg-slate-600'}`}>
                {isCompleted ? <Check className="w-5 h-5" /> : stepNumber}
            </div>
            <div className="ml-3">
                <h4 className={`font-semibold ${isActive || isCompleted ? 'text-slate-800 dark:text-slate-100' : 'text-slate-500'}`}>{title}</h4>
            </div>
        </div>
    );
};

export default function ApplyTaskPackagePage() {
    const queryClient = useQueryClient();
    
    // Get property ID from URL if coming from PropertyDetail
    const urlParams = new URLSearchParams(window.location.search);
    const urlPropertyId = urlParams.get('propertyId');
    
    const [step, setStep] = useState(urlPropertyId ? 2 : 1);
    const [selectedPropertyId, setSelectedPropertyId] = useState(urlPropertyId || null);
    const [selectedPackageId, setSelectedPackageId] = useState(null);
    const [selectedTasks, setSelectedTasks] = useState(new Set());
    const [processedProperties, setProcessedProperties] = useState([]);

    const { data: currentUser } = useQuery({
        queryKey: ['currentUser'],
        queryFn: () => base44.auth.me(),
    });
    
    const { data: properties = [], isLoading: isLoadingProperties } = useQuery({
        queryKey: ['properties'],
        queryFn: () => base44.entities.Property.list(),
    });

    const { data: packages = [], isLoading: isLoadingPackages } = useQuery({
        queryKey: ['allTaskPackages'],
        queryFn: () => base44.entities.TaskPackage.list(),
    });

    const { data: allTasks = [] } = useQuery({
        queryKey: ['tasks'],
        queryFn: () => base44.entities.Task.list(),
    });

    const appliedPackagesMap = useMemo(() => {
        const packageTypeMap = packages.reduce((map, pkg) => {
            map.set(pkg.name, pkg.package_type);
            return map;
        }, new Map());

        const propertyAppliedPackageTypes = new Map();
        allTasks.forEach(task => {
            if (task.property_id && task.package_name) {
                const packageType = packageTypeMap.get(task.package_name);
                if (packageType) {
                    if (!propertyAppliedPackageTypes.has(task.property_id)) {
                        propertyAppliedPackageTypes.set(task.property_id, new Set());
                    }
                    propertyAppliedPackageTypes.get(task.property_id).add(packageType);
                }
            }
        });
        return propertyAppliedPackageTypes;
    }, [allTasks, packages]);

    const availableProperties = useMemo(() => {
        const processedIds = new Set(processedProperties.map(p => p.id));
        return properties.filter(p => {
            if (processedIds.has(p.id)) return false;
            
            // All active and pending properties are available
            return p.status === 'active' || p.status === 'pending';
        });
    }, [properties, processedProperties]);
    
    const applyTasksMutation = useMutation({
        mutationFn: (tasksToCreate) => base44.entities.Task.bulkCreate(tasksToCreate),
        onSuccess: (createdTasks) => {
            toast.success(`${createdTasks.length} tasks have been successfully applied to the property!`);
            queryClient.invalidateQueries({ queryKey: ['tasks'] }); // Invalidate tasks to update appliedPackagesMap

            const property = properties.find(p => p.id === selectedPropertyId);
            if (property) {
                setProcessedProperties(prev => [
                    { 
                        id: property.id, 
                        address: property.address, 
                        tasksCount: createdTasks.length 
                    }, 
                    ...prev.filter(p => p.id !== property.id)
                ]);
            }

            // Reset state
            setStep(1);
            setSelectedPropertyId(null);
            setSelectedPackageId(null);
            setSelectedTasks(new Set());
        },
        onError: (error) => toast.error(`Failed to apply tasks: ${error.message}`),
    });

    const selectedProperty = useMemo(() => {
        return properties.find(p => p.id === selectedPropertyId);
    }, [selectedPropertyId, properties]);

    const selectedPackage = useMemo(() => {
        return packages.find(p => p.id === selectedPackageId);
    }, [selectedPackageId, packages]);

    const availablePackages = useMemo(() => {
        if (!selectedProperty) return [];
        
        // Show all package types for both active and pending properties
        return packages;
    }, [selectedProperty, packages]);

    const handleSelectPackage = (packageId) => {
        setSelectedPackageId(packageId);
        // Pre-select all tasks in the package
        const pkg = packages.find(p => p.id === packageId);
        if (pkg && pkg.tasks) {
            const allTaskIndices = new Set(pkg.tasks.map((_, index) => index));
            setSelectedTasks(allTaskIndices);
        }
    };

    const handleTaskSelectionChange = (taskIndex) => {
        setSelectedTasks(prev => {
            const newSelected = new Set(prev);
            if (newSelected.has(taskIndex)) {
                newSelected.delete(taskIndex);
            } else {
                newSelected.add(taskIndex);
            }
            return newSelected;
        });
    };

    const handleApplyTasks = () => {
        if (!selectedPropertyId || !selectedPackage || !currentUser) {
            toast.error("Missing required information. Please start over.");
            return;
        }

        const tasksToCreate = Array.from(selectedTasks).map(index => {
            const taskTemplate = selectedPackage.tasks[index];
            const dueDate = addDays(new Date(), taskTemplate.due_date_offset_days || 0);
            return {
                title: taskTemplate.title,
                description: taskTemplate.description || `Task from '${selectedPackage.name}' checklist.`,
                property_id: selectedPropertyId,
                assigned_to: currentUser.id,
                task_type: taskTemplate.task_type || 'general',
                priority: taskTemplate.priority || 'medium',
                status: 'pending',
                due_date: format(dueDate, 'yyyy-MM-dd'),
                package_name: selectedPackage.name,
            };
        });
        
        if (tasksToCreate.length === 0) {
            toast.warning("No tasks selected to apply.");
            return;
        }

        applyTasksMutation.mutate(tasksToCreate);
    };

    return (
        <div className="page-container space-y-8">
            <header>
                <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Apply a Transaction Checklist</h1>
                <p className="text-slate-500 dark:text-slate-400 mt-1">Quickly generate all the tasks needed for a property transaction.</p>
            </header>

            <div className="flex items-center space-x-4 md:space-x-8 border-b pb-4">
                <StepIndicator currentStep={step} stepNumber={1} title="Select Property" />
                <ArrowRight className="w-5 h-5 text-slate-300 dark:text-slate-600" />
                <StepIndicator currentStep={step} stepNumber={2} title="Select Checklist" />
                <ArrowRight className="w-5 h-5 text-slate-300 dark:text-slate-600" />
                <StepIndicator currentStep={step} stepNumber={3} title="Apply Tasks" />
            </div>

            {step === 1 && (
                <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2"><Home className="w-5 h-5 text-blue-600"/>Step 1: Select a Property</CardTitle>
                        <CardDescription>Choose an active or pending property that needs a new checklist.</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <Select onValueChange={setSelectedPropertyId} disabled={isLoadingProperties || availableProperties.length === 0}>
                            <SelectTrigger className="w-full md:w-1/2">
                                <SelectValue placeholder={
                                    isLoadingProperties ? "Loading properties..." : 
                                    availableProperties.length === 0 ? "No properties need a checklist" : 
                                    "Select a property"
                                } />
                            </SelectTrigger>
                            <SelectContent>
                                {availableProperties.map(p => 
                                    <SelectItem key={p.id} value={p.id}>
                                        <div className="flex items-center gap-2">
                                            <span>{p.address}</span>
                                            <Badge variant={p.status === 'pending' ? 'default' : 'outline'} className="capitalize">{p.status}</Badge>
                                        </div>
                                    </SelectItem>
                                )}
                            </SelectContent>
                        </Select>
                    </CardContent>
                    <CardFooter className="flex justify-end">
                        <Button onClick={() => setStep(2)} disabled={!selectedPropertyId}>
                            Next <ArrowRight className="w-4 h-4 ml-2" />
                        </Button>
                    </CardFooter>
                </Card>
            )}
            
            {step === 2 && (
                <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2"><Package className="w-5 h-5 text-blue-600"/>Step 2: Select a Checklist</CardTitle>
                        <CardDescription>
                            {selectedProperty?.status === 'active' && "Choose a Listing checklist to apply."}
                            {selectedProperty?.status === 'pending' && "Choose a Buyer-side checklist to apply."}
                        </CardDescription>
                    </CardHeader>
                    <CardContent className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {isLoadingPackages ? (
                            <p>Loading checklists...</p>
                        ) : availablePackages.map(pkg => (
                            <button key={pkg.id} onClick={() => handleSelectPackage(pkg.id)} className={`p-4 border-2 rounded-lg text-left transition-all hover:shadow-lg hover:-translate-y-1 ${selectedPackageId === pkg.id ? 'border-blue-600 bg-blue-50 dark:bg-blue-900/20' : 'dark:border-slate-700'}`}>
                                <h3 className="font-semibold text-slate-800 dark:text-slate-100">{pkg.name}</h3>
                                <p className="text-sm text-slate-500 mt-1">{pkg.description}</p>
                                <div className="mt-2 text-xs text-slate-400 capitalize flex items-center gap-2">
                                    <FileCheck2 className="w-3 h-3" />
                                    <span>{pkg.package_type}</span>
                                    <span className="font-bold mx-1">‚Ä¢</span>
                                    <span>{pkg.tasks?.length || 0} tasks</span>
                                </div>
                            </button>
                        ))}
                    </CardContent>
                    <CardFooter className="flex justify-between">
                         <Button variant="outline" onClick={() => setStep(1)}>Back</Button>
                        <Button onClick={() => setStep(3)} disabled={!selectedPackageId}>
                            Next <ArrowRight className="w-4 h-4 ml-2" />
                        </Button>
                    </CardFooter>
                </Card>
            )}

            {step === 3 && selectedPackage && (
                 <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2"><ListChecks className="w-5 h-5 text-blue-600"/>Step 3: Review & Apply Tasks</CardTitle>
                        <CardDescription>Uncheck any tasks you don't need for this specific transaction.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-3">
                       <div className="max-h-96 overflow-y-auto space-y-3 p-1">
                            {selectedPackage.tasks.map((task, index) => (
                                <div key={index} className="flex items-center space-x-3 p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50">
                                    <Checkbox 
                                        id={`task-${index}`} 
                                        checked={selectedTasks.has(index)}
                                        onCheckedChange={() => handleTaskSelectionChange(index)}
                                    />
                                    <Label htmlFor={`task-${index}`} className="w-full cursor-pointer">
                                        <p className="font-medium text-slate-800 dark:text-slate-200">{task.title}</p>
                                        <p className="text-sm text-slate-500">Due in {task.due_date_offset_days} days</p>
                                    </Label>
                                </div>
                            ))}
                        </div>
                    </CardContent>
                    <CardFooter className="flex justify-between">
                        <Button variant="outline" onClick={() => setStep(2)}>Back</Button>
                        <Button onClick={handleApplyTasks} disabled={applyTasksMutation.isLoading || selectedTasks.size === 0}>
                            {applyTasksMutation.isLoading ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                    Applying...
                                </>
                            ) : `Apply ${selectedTasks.size} Tasks`}
                        </Button>
                    </CardFooter>
                </Card>
            )}

            {processedProperties.length > 0 && (
                <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                            <CheckCircle2 className="w-5 h-5 text-green-600" />
                            Recently Applied Checklists
                        </CardTitle>
                        <CardDescription>A summary of checklists you've applied in this session.</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <ul className="space-y-3">
                            {processedProperties.map((prop) => (
                                <li key={prop.id} className="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50 border dark:border-slate-700">
                                    <p className="font-medium text-slate-800 dark:text-slate-200">{prop.address}</p>
                                    <Badge variant="secondary">{prop.tasksCount} tasks applied</Badge>
                                </li>
                            ))}
                        </ul>
                    </CardContent>
                </Card>
            )}
        </div>
    );
}
import React, { useState, useEffect, useMemo, useCallback } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { DragDropContext } from "@hello-pangea/dnd";
import { toast } from "sonner";
import { format, isToday, isTomorrow, isPast, isThisWeek, parseISO, differenceInDays } from "date-fns";
import { useLocation, useNavigate } from 'react-router-dom';

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuLabel,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

import {
  Plus,
  Search,
  Filter,
  Calendar,
  User,
  Home,
  CheckCircle2,
  Clock,
  AlertTriangle,
  Flame,
  MoreVertical,
  Trash2,
  CheckSquare,
  X,
  TrendingUp,
  ListTodo,
  LayoutGrid,
  Eye,
  EyeOff,
  SortAsc,
  Download,
  Upload,
  Zap,
  Target,
  RefreshCw,
  Database,
  ChevronDown,
  ListChecks,
  CheckCircle,
  Settings,
  ArrowLeft,
  Loader2,
} from "lucide-react";

import TaskKanbanBoard from "../components/tasks/TaskKanbanBoard";
import TaskModal from "../components/tasks/TaskModal";
import LoadingSpinner from "../components/common/LoadingSpinner";
import { canEditTask, canDeleteTask } from "../components/utils/rolePermissions";
import { useDebounce } from '../components/utils/performanceOptimizations';
import HelpTooltip from "../components/common/HelpTooltip";

export default function Tasks() {
  const location = useLocation();
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  const [showTaskModal, setShowTaskModal] = useState(false);
  const [editingTask, setEditingTask] = useState(null);
  const [viewMode, setViewMode] = useState("kanban");
  const [searchQuery, setSearchQuery] = useState("");
  const [filterStatus, setFilterStatus] = useState("all");
  const [filterPriority, setFilterPriority] = useState("all");
  const [filterProperty, setFilterProperty] = useState("all");
  const [filterAssignee, setFilterAssignee] = useState("all");
  const [filterUrgency, setFilterUrgency] = useState("all");
  const [filterDueDate, setFilterDueDate] = useState("all");
  const [filterCategory, setFilterCategory] = useState("all");
  const [sortBy, setSortBy] = useState("recommended");
  const [selectedTaskIds, setSelectedTaskIds] = useState([]);
  const [showBulkActions, setShowBulkActions] = useState(false);
  const [highlightedTaskId, setHighlightedTaskId] = useState(null);
  const [recentlyMovedTasks, setRecentlyMovedTasks] = useState([]);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [user, setUser] = useState(null);
  const [showContractTasksOnly, setShowContractTasksOnly] = useState(false);

  const debouncedSearchQuery = useDebounce(searchQuery, 300);

  // Load user data on component mount
  useEffect(() => {
      const loadUserData = async () => {
          try {
              const currentUser = await base44.auth.me();
              setUser(currentUser);
          } catch (error) {
              console.error("Error loading user:", error);
          }
      };
      loadUserData();
  }, []);

  // Handle URL parameters for property filtering AND urgency - ENHANCED
  useEffect(() => {
    const urlParams = new URLSearchParams(location.search);
    const propertyIdParam = urlParams.get('property_id');
    const urgencyParam = urlParams.get('urgency');
    const openModalParam = urlParams.get('openModal');
    const dueDateParam = urlParams.get('dueDate');
    
    if (propertyIdParam) {
      console.log('üéØ Setting property filter to:', propertyIdParam);
      setFilterProperty(propertyIdParam);
      setShowContractTasksOnly(true);
      setFilterStatus("all");
      setFilterPriority("all");
      setFilterAssignee("all");
      setFilterDueDate("all");
      setFilterCategory("all");
      setSearchQuery("");
      
      // Set urgency filter if provided
      if (urgencyParam) {
        console.log('‚ö†Ô∏è Setting urgency filter to:', urgencyParam);
        setFilterUrgency(urgencyParam);
      } else {
        setFilterUrgency("all");
      }
    }
    
    // Open new task modal with pre-filled due date from calendar
    if (openModalParam === 'true') {
      // Keep editingTask as null for "New Milestone" title
      setEditingTask(null);
      setShowTaskModal(true);
      // Store the initial date to pre-fill in modal
      if (dueDateParam) {
        sessionStorage.setItem('newTaskInitialDate', dueDateParam);
      }
      // Clear URL params after opening
      navigate(location.pathname, { replace: true });
    }
  }, [location.search, navigate]);

  const tasksQuery = useQuery({
    queryKey: ['tasks'],
    queryFn: () => base44.entities.Task.list("-created_date"),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
    enabled: !!user,
    initialData: [],
  });
  const allTasks = tasksQuery.data || [];
  const tasksLoading = tasksQuery.isLoading;

  // Filter tasks to show only those assigned to current user
  const userTasks = useMemo(() => {
    if (!user) return [];
    
    // Admin sees all tasks, others see only their assigned tasks or tasks they created
    if (user.role === 'admin') return allTasks;
    
    return allTasks.filter(task => 
        task.assigned_to === user.id || 
        task.created_by === user.email
    );
  }, [allTasks, user]);

  // Check if current time is within working hours
  const isWithinWorkingHours = useCallback(() => {
    if (!user || !user.show_tasks_during_working_hours_only) {
        return true;
    }

    const now = new Date();
    const currentDayIndex = now.getDay();
    const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const currentDay = daysOfWeek[currentDayIndex];
    const currentTime = format(now, 'HH:mm');

    let workingDays = [];
    try {
        workingDays = JSON.parse(user.working_days || '["monday","tuesday","wednesday","thursday","friday"]');
    } catch (e) {
        console.error("Error parsing working days:", e);
        workingDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
    }

    if (!workingDays.includes(currentDay)) {
        return false;
    }

    const startTime = user.working_hours_start || '09:00';
    const endTime = user.working_hours_end || '17:00';

    return currentTime >= startTime && currentTime <= endTime;
  }, [user]);

  // Apply working hours filter to user tasks
  const visibleUserTasks = useMemo(() => {
      if (!user) return [];
      if (user.show_tasks_during_working_hours_only && !isWithinWorkingHours()) {
          return [];
      }
      return userTasks;
  }, [userTasks, user, isWithinWorkingHours]);

  const todayPendingTaskIds = useMemo(() => {
    if (!visibleUserTasks || visibleUserTasks.length === 0) return [];
    
    return visibleUserTasks
      .filter(task => {
        if (task.status !== 'pending' && task.status !== 'in_progress') {
          return false;
        }
        if (!task.due_date) {
          return false;
        }
        try {
          if (typeof task.due_date === 'string' && task.due_date.length > 0) {
            const date = parseISO(task.due_date);
            if (isNaN(date.getTime())) return false;
            return isToday(date);
          }
          return false;
        } catch (e) {
          console.error("Invalid date format for task:", task.id, task.due_date);
          return false;
        }
      })
      .map(task => task.id);
  }, [visibleUserTasks]);

  const propertiesQuery = useQuery({
    queryKey: ['properties'],
    queryFn: () => base44.entities.Property.list(),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
    initialData: [],
  });
  const properties = propertiesQuery.data || [];

  const usersQuery = useQuery({
    queryKey: ['users'],
    queryFn: () => base44.entities.User.list(),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
    enabled: !!user,
    initialData: [],
  });
  const systemUsers = usersQuery.data || [];

  const contactsQuery = useQuery({
    queryKey: ['contacts'],
    queryFn: () => base44.entities.Contact.list(),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
    enabled: !!user,
    initialData: [],
  });
  const contacts = contactsQuery.data || [];

  const buyersQuery = useQuery({
    queryKey: ['buyers'],
    queryFn: () => base44.entities.Buyer.list(),
    staleTime: 30 * 1000,
    refetchInterval: 30 * 1000,
    enabled: !!user,
    initialData: [],
  });
  const buyers = buyersQuery.data || [];

  const handleOpenModal = useCallback((task = null) => {
    setEditingTask(task);
    setShowTaskModal(true);
  }, []);

  useEffect(() => {
    if (!tasksQuery.isSuccess || !tasksQuery.data) return;

    const urlParams = new URLSearchParams(location.search);
    const highlightId = urlParams.get('highlight');

    if (highlightId) {
      const taskToOpenModal = tasksQuery.data.find(t => t.id === highlightId);

      if (taskToOpenModal) {
        handleOpenModal(taskToOpenModal);

        const newUrl = new URL(window.location.origin + location.pathname + location.hash);
        newUrl.searchParams.delete('highlight');
        navigate(newUrl.pathname + newUrl.search + newUrl.hash, { replace: true });
      } else {
        setHighlightedTaskId(highlightId);

        setTimeout(() => {
          const taskElement = document.getElementById(`task-${highlightId}`);
          if (taskElement) {
            taskElement.scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });
          }
          const newUrl = new URL(window.location.origin + location.pathname + location.hash);
          newUrl.searchParams.delete('highlight');
          navigate(newUrl.pathname + newUrl.search + newUrl.hash, { replace: true });
        }, 500);

        setTimeout(() => {
          setHighlightedTaskId(null);
        }, 5000);
      }
    }
  }, [location.search, tasksQuery.isSuccess, tasksQuery.data, navigate, handleOpenModal]);

  const handleRefresh = async () => {
    setIsRefreshing(true);
    try {
      await queryClient.invalidateQueries({ queryKey: ["tasks"] });
      await tasksQuery.refetch();
      toast.success("Tasks refreshed successfully!");
    } catch (error) {
      console.error("Error refreshing tasks:", error);
      toast.error("Failed to refresh tasks");
    } finally {
      setIsRefreshing(false);
    }
  };

  const handleTaskClick = (task) => {
    // Follow-up tasks from ActivityLogger - navigate to source
    if (task.task_type === 'follow_up') {
      if (task.buyer_id) {
        navigate(createPageUrl(`BuyerDetail?id=${task.buyer_id}`));
      } else if (task.contact_id) {
        navigate(createPageUrl(`ContactDetail?id=${task.contact_id}`));
      } else if (task.property_id && task.description?.includes('Lead Follow-up')) {
        navigate(createPageUrl(`Leads?openLead=${task.property_id}`));
      } else {
        handleOpenModal(task);
      }
    } else if (task.task_type && task.task_type.startsWith('soi_')) {
        navigate(`/ai-email-assistant?taskId=${task.id}`);
    } else {
        handleOpenModal(task);
    }
  };

  const createTaskMutation = useMutation({
    mutationFn: (taskData) => base44.entities.Task.create(taskData),
    onSuccess: (updatedTask) => {
      queryClient.invalidateQueries({ queryKey: ["tasks"] });
      setShowTaskModal(false);
      setEditingTask(null);
      toast.success("Task created successfully!");
      window.dispatchEvent(new Event('refreshCounts'));
    },
    onError: (error) => {
      console.error("Error creating task:", error);
      toast.error("Failed to create task");
    },
  });

  const updateTaskMutation = useMutation({
    mutationFn: ({ id, taskData }) => base44.entities.Task.update(id, taskData),
    onMutate: async ({ id, taskData }) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ["tasks"] });

      // Snapshot the previous value
      const previousTasks = queryClient.getQueryData(["tasks"]);

      // Optimistically update the cache
      queryClient.setQueryData(["tasks"], (old) => {
        if (!old || !Array.isArray(old)) return [];
        return old.map(task => 
          task && task.id === id ? { ...task, ...taskData } : task
        ).filter(Boolean);
      });

      // Return context with previous value
      return { previousTasks };
    },
    onSuccess: (_, variables) => {
      // Invalidate to refetch from server
      queryClient.invalidateQueries({ queryKey: ["tasks"] });
      setShowTaskModal(false);
      setEditingTask(null);

      setRecentlyMovedTasks(prev => [...prev, variables.id]);
      setTimeout(() => {
        setRecentlyMovedTasks(prev => prev.filter(id => id !== variables.id));
      }, 2000);

      toast.success("Task updated successfully!");
      window.dispatchEvent(new Event('refreshCounts'));
    },
    onError: (error, variables, context) => {
      // Rollback on error
      if (context?.previousTasks && Array.isArray(context.previousTasks)) {
        queryClient.setQueryData(["tasks"], context.previousTasks);
      } else {
        // If rollback data is invalid, force refetch
        queryClient.invalidateQueries({ queryKey: ["tasks"] });
      }
      console.error("Error updating task:", error);
      toast.error("Failed to update task. Refreshing...");
    },
    onSettled: () => {
      // Always refetch after mutation completes (success or error)
      queryClient.invalidateQueries({ queryKey: ["tasks"] });
    },
  });

  const deleteTaskMutation = useMutation({
    mutationFn: (id) => base44.entities.Task.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["tasks"] });
      toast.success("Task deleted successfully!");
      window.dispatchEvent(new Event('refreshCounts'));
    },
    onError: (error) => {
      console.error("Error deleting task:", error);
      toast.error("Failed to delete task");
    },
  });

  const bulkUpdateMutation = useMutation({
    mutationFn: async ({ taskIds, updates }) => {
      const promises = taskIds.map(id => base44.entities.Task.update(id, updates));
      return Promise.all(promises);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["tasks"] });
      setSelectedTaskIds([]);
      setShowBulkActions(false);
      toast.success("Tasks updated successfully!");
      window.dispatchEvent(new Event('refreshCounts'));
    },
    onError: (error) => {
      console.error("Error updating tasks:", error);
      toast.error("Failed to update tasks");
    },
  });

  const handleSaveTask = (taskData) => {
    if (editingTask) {
      updateTaskMutation.mutate({ id: editingTask.id, taskData });
    } else {
      createTaskMutation.mutate(taskData);
    }
  };

  const handleDeleteTask = (taskId) => {
    if (!user || !canDeleteTask(user)) {
      toast.error("You don't have permission to delete tasks");
      return;
    }

    if (window.confirm("Are you sure you want to delete this task?")) {
      deleteTaskMutation.mutate(taskId);
    }
  };

  const handleDragEnd = (result) => {
    // Prevent crash if no destination
    if (!result.destination) {
      console.log('‚ùå Drag cancelled - no destination');
      return;
    }

    const taskId = result.draggableId;
    const newStatus = result.destination.droppableId;
    const sourceStatus = result.source.droppableId;

    // Don't update if status is the same
    if (sourceStatus === newStatus) {
      console.log('‚ÑπÔ∏è Task already in this column');
      return;
    }

    console.log('üéØ Dragging task:', { taskId, from: sourceStatus, to: newStatus });

    try {
      // Find the task - check both allTasks and visibleUserTasks
      const task = allTasks.find(t => t && t.id === taskId) || visibleUserTasks.find(t => t && t.id === taskId);
      
      if (!task) {
        console.error('‚ùå Task not found:', taskId);
        toast.error("Task not found. Refreshing...");
        queryClient.invalidateQueries({ queryKey: ["tasks"] });
        return;
      }

      // Check permissions
      if (!user || !canEditTask(user, task)) {
        toast.error("You don't have permission to move this task");
        queryClient.invalidateQueries({ queryKey: ["tasks"] });
        return;
      }

      const updates = { status: newStatus };

      // Handle completion date
      if (newStatus === 'completed' && !task.completed_date) {
        updates.completed_date = new Date().toISOString();
      } else if (newStatus !== 'completed' && task.completed_date) {
        updates.completed_date = null;
      }

      console.log('üìù Updating task with:', updates);

      // Add to recently moved for animation
      setRecentlyMovedTasks(prev => [...prev, taskId]);
      setTimeout(() => {
        setRecentlyMovedTasks(prev => prev.filter(id => id !== taskId));
      }, 2000);

      // Perform the update
      updateTaskMutation.mutate({ id: taskId, taskData: updates });

    } catch (error) {
      console.error('‚ùå Error in handleDragEnd:', error);
      toast.error("Failed to update task. Refreshing...");
      queryClient.invalidateQueries({ queryKey: ["tasks"] });
    }
  };

  const handleBulkStatusChange = (status) => {
    if (selectedTaskIds.length === 0) return;

    const updates = { status };
    if (status === 'completed') {
      updates.completed_date = new Date().toISOString();
    }

    bulkUpdateMutation.mutate({ taskIds: selectedTaskIds, updates });
  };

  const handleBulkDelete = () => {
    if (selectedTaskIds.length === 0) return;

    if (!user || !canDeleteTask(user)) {
      toast.error("You don't have permission to delete tasks");
      return;
    }

    if (window.confirm(`Are you sure you want to delete ${selectedTaskIds.length} selected task(s)? This action cannot be undone.`)) {
      Promise.all(selectedTaskIds.map(id => base44.entities.Task.delete(id)))
        .then(() => {
          queryClient.invalidateQueries({ queryKey: ["tasks"] });
          setSelectedTaskIds([]);
          setShowBulkActions(false);
          toast.success("Tasks deleted successfully!");
        })
        .catch(error => {
          console.error("Error deleting tasks:", error);
          toast.error("Failed to delete some tasks");
        });
    }
  };

  const handleSelectTask = (taskId, isSelected) => {
    if (isSelected) {
      setSelectedTaskIds(prev => [...prev, taskId]);
    } else {
      setSelectedTaskIds(prev => prev.filter(id => id !== taskId));
    }
  };

  const handleSelectAll = () => {
    const allIds = groupedTasks.map(t => t.id);
    setSelectedTaskIds(allIds);
  };

  const handleDeselectAll = () => {
    setSelectedTaskIds([]);
  };

  const handleStatClick = (filterType) => {
    setSearchQuery("");
    setFilterStatus("all");
    setFilterPriority("all");
    setFilterProperty("all");
    setFilterAssignee("all");
    setFilterUrgency("all");
    setFilterDueDate("all");
    setFilterCategory("all");
    setShowContractTasksOnly(false);

    switch (filterType) {
      case 'total':
        break;
      case 'pending':
        setFilterStatus("pending");
        break;
      case 'in_progress':
        setFilterStatus("in_progress");
        break;
      case 'completed':
        setFilterStatus("completed");
        break;
      case 'overdue':
        setFilterUrgency("overdue");
        break;
      case 'today':
        setFilterDueDate("today");
        break;
      case 'thisWeek':
        setFilterDueDate("thisWeek");
        break;
      default:
        break;
    }
  };

  const getTaskUrgency = (task) => {
    if (!task.due_date || task.status === 'completed' || task.status === 'cancelled') {
      return 'normal';
    }

    try {
      let now = new Date();
      now.setHours(0, 0, 0, 0);

      const dueDate = parseISO(task.due_date);
      if (isNaN(dueDate.getTime())) {
        return 'normal';
      }
      dueDate.setHours(0, 0, 0, 0);

      if (dueDate < now) {
        return 'overdue';
      }

      let threeDaysFromNow = new Date(now);
      threeDaysFromNow.setDate(now.getDate() + 3);

      if (dueDate <= threeDaysFromNow) {
        return 'warning';
      }

      return 'normal';
    } catch (error) {
      console.error(`Error parsing date for task "${task.title}":`, error);
      return 'normal';
    }
  };

  const stats = useMemo(() => {
    const overdueTasks = visibleUserTasks.filter(t => getTaskUrgency(t) === 'overdue');
    
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
    
    const todayTasks = visibleUserTasks.filter(t => {
      if (!t.due_date || t.status === 'completed' || t.status === 'cancelled') return false;
      try {
        const dueDate = new Date(t.due_date);
        if (isNaN(dueDate.getTime())) return false;
        return dueDate >= todayStart && dueDate <= todayEnd;
      } catch (e) {
        return false;
      }
    });

    return {
      total: visibleUserTasks.length,
      pending: visibleUserTasks.filter(t => t.status === 'pending').length,
      in_progress: visibleUserTasks.filter(t => t.status === 'in_progress').length,
      completed: visibleUserTasks.filter(t => t.status === 'completed').length,
      overdue: overdueTasks.length,
      overdueList: overdueTasks,
      overduePending: overdueTasks.filter(t => t.status === 'pending').length,
      overdueInProgress: overdueTasks.filter(t => t.status === 'in_progress').length,
      today: todayTasks.length,
      todayPending: todayTasks.filter(t => t.status === 'pending').length,
      todayInProgress: todayTasks.filter(t => t.status === 'in_progress').length,
      thisWeek: visibleUserTasks.filter(t => {
        if (!t.due_date || t.status === 'completed' || t.status === 'cancelled') return false;
        try {
          const date = parseISO(t.due_date);
          if (isNaN(date.getTime())) return false;
          return isThisWeek(date, { weekStartsOn: 1 });
        } catch (e) {
          return false;
        }
      }).length,
    };
  }, [visibleUserTasks]);

  const groupedTasks = useMemo(() => {
    if (!visibleUserTasks || !Array.isArray(visibleUserTasks)) {
      console.warn('‚ö†Ô∏è visibleUserTasks is not an array:', visibleUserTasks);
      return [];
    }

    console.log('üîç Filtering - Property:', filterProperty, 'Contract Only:', showContractTasksOnly, 'Total tasks:', visibleUserTasks.length);

    let filtered = visibleUserTasks.filter(task => {
      // Safety check
      if (!task || !task.id) return false;

      // PROPERTY FILTER - Must be FIRST and most important
      if (filterProperty !== "all") {
        // Task must match the selected property
        if (task.property_id !== filterProperty) {
          return false;
        }

        // If in contract-only mode, task must have package_name
        if (showContractTasksOnly && !task.package_name) {
          return false;
        }
      }

      // All other filters AFTER property filter
      if (debouncedSearchQuery && !task.title.toLowerCase().includes(debouncedSearchQuery.toLowerCase()) &&
          !(task.description && task.description.toLowerCase().includes(debouncedSearchQuery.toLowerCase()))) {
        return false;
      }

      if (filterStatus !== "all" && task.status !== filterStatus) {
        return false;
      }

      if (filterPriority !== "all" && task.priority !== filterPriority) {
        return false;
      }

      if (filterAssignee !== "all" && task.assigned_to !== filterAssignee) {
        return false;
      }

      if (filterUrgency !== "all") {
        const urgency = getTaskUrgency(task);
        if (urgency !== filterUrgency) {
          return false;
        }
      }

      if (filterDueDate === "today") {
        if (!task.due_date) return false;
        if (task.status === 'completed' || task.status === 'cancelled') return false;
        
        try {
          const now = new Date();
          const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
          const taskDueDate = new Date(task.due_date);
          if (isNaN(taskDueDate.getTime())) return false;
          const isDueToday = taskDueDate >= todayStart && taskDueDate <= todayEnd;
          if (!isDueToday) return false;
        } catch (e) {
          console.error('Error parsing date for today filter:', e, task.due_date);
          return false;
        }
      } else if (filterDueDate === "thisWeek") {
        if (!task.due_date || task.status === 'completed' || task.status === 'cancelled') return false;
        try {
          const taskDate = parseISO(task.due_date);
          if (isNaN(taskDate.getTime())) return false;
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const weekFromNow = new Date(today);
          weekFromNow.setDate(today.getDate() + 7);
          if (taskDate < today || taskDate > weekFromNow) return false;
        } catch (e) {
          console.error('Error parsing date for week filter:', e);
          return false;
        }
      }

      if (filterCategory !== "all") {
        const taskCategory = task.category || 'other';
        if (filterCategory === 'soi-campaign') {
          if (!task.task_type || !task.task_type.startsWith('soi_')) return false;
        } else if (filterCategory === 'contract') {
          if (taskCategory !== 'contract') return false;
        } else if (filterCategory === 'inspection') {
          if (taskCategory !== 'inspection') return false;
        } else if (filterCategory === 'financing') {
          if (taskCategory !== 'financing') return false;
        } else if (filterCategory === 'closing') {
          if (taskCategory !== 'closing') return false;
        } else if (taskCategory !== filterCategory) {
          return false;
        }
      }

      return true;
    });

    filtered.sort((a, b) => {
      if (sortBy === "recommended") {
        const getScore = (task) => {
          const now = new Date();
          now.setHours(0, 0, 0, 0);

          if (task.status === 'completed' || task.status === 'cancelled') {
            return 9999;
          }

          let dueDate = null;
          try {
            dueDate = task.due_date ? parseISO(task.due_date) : null;
            if (dueDate && isNaN(dueDate.getTime())) dueDate = null;
          } catch (e) {
            dueDate = null;
          }
          
          let baseScore = 0;

          const priorityScores = {
            'critical': 0,
            'high': 1,
            'medium': 2,
            'low': 3,
          };
          const taskPriorityRank = priorityScores[task.priority] !== undefined ? priorityScores[task.priority] : 4;

          if (dueDate) {
            try {
              dueDate.setHours(0, 0, 0, 0);
              const daysUntilDue = differenceInDays(dueDate, now);

            if (daysUntilDue < 0) {
              baseScore = -1000 + daysUntilDue;
            } else if (daysUntilDue === 0) {
              baseScore = 0;
            } else if (daysUntilDue > 0 && daysUntilDue <= 3) {
              baseScore = 100 + daysUntilDue;
            } else {
              baseScore = 500 + daysUntilDue;
            }
            } catch (e) {
              baseScore = 2000;
            }
          } else {
            baseScore = 2000;
          }

          return baseScore * 10 + taskPriorityRank;
        };

        return getScore(a) - getScore(b);
      }
      if (sortBy === "due_date") {
        try {
          const dateA = a.due_date ? new Date(a.due_date) : new Date(8640000000000000);
          const dateB = b.due_date ? new Date(b.due_date) : new Date(8640000000000000);
          if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
          return dateA - dateB;
        } catch (e) {
          return 0;
        }
      } else if (sortBy === "priority") {
        const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
        return priorityOrder[a.priority] - priorityOrder[b.priority];
      } else if (sortBy === "created_date") {
        try {
          const dateA = new Date(a.created_date);
          const dateB = new Date(b.created_date);
          if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
          return dateB - dateA;
        } catch (e) {
          return 0;
        }
      }
      return 0;
    });

    console.log('‚úÖ Final filtered tasks count:', filtered.length);
    return filtered;
  }, [visibleUserTasks, debouncedSearchQuery, filterStatus, filterPriority, filterProperty, filterAssignee, filterUrgency, filterDueDate, filterCategory, sortBy, recentlyMovedTasks, buyers, properties, contacts, showContractTasksOnly]);

  const highlightedTaskIds = useMemo(() => {
    const filterHighlights = filterUrgency !== "all"
      ? groupedTasks.filter(t => getTaskUrgency(t) === filterUrgency).map(t => t.id)
      : [];
    const combinedHighlights = new Set([...filterHighlights, ...recentlyMovedTasks]);
    if (highlightedTaskId && !combinedHighlights.has(highlightedTaskId)) {
      combinedHighlights.add(highlightedTaskId);
    }
    return Array.from(combinedHighlights);
  }, [filterUrgency, groupedTasks, recentlyMovedTasks, highlightedTaskId]);

  const completionRate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;

  const showWorkingHoursMessage = user && user.show_tasks_during_working_hours_only && !isWithinWorkingHours();

  if (user === null || tasksLoading) {
    return <LoadingSpinner icon={CheckSquare} title="Loading Tasks..." description="Loading your tasks and action items" />;
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-6">
      <style>{`
          @keyframes red-pulse-glow {
            0% {
              box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6);
            }
            70% {
              box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
            100% {
              box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
          }
          @keyframes indigo-pulse-glow {
            0% {
              box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.6);
            }
            70% {
              box-shadow: 0 0 0 8px rgba(99, 102, 241, 0);
            }
            100% {
              box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
          }
          .today-pending-task-blinking {
            animation: red-pulse-glow 2s infinite;
            border-color: #ef4444 !important;
          }
      `}</style>
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div className="flex items-center gap-3">
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={() => navigate(-1)}
              className="text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
              <ListTodo className="w-6 h-6 text-white" />
            </div>
            <div>
              <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Milestones & Next Actions</h1>
              <p className="text-slate-600 dark:text-slate-400 mt-1">
                Track deal stages and transaction steps
              </p>
            </div>

            {/* Data Source Indicator */}
            <div className="mt-3 flex items-center gap-2 text-xs">
              <Badge variant="outline" className="bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border-blue-300">
                <Database className="w-3 h-3 mr-1" />
                Data Source: base44.entities.Task
              </Badge>
              <Badge variant="outline" className="bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border-green-300">
                <CheckCircle2 className="w-3 h-3 mr-1" />
                {visibleUserTasks.length} Records Loaded
              </Badge>
              {(searchQuery || filterStatus !== "all" || filterPriority !== "all" || filterProperty !== "all" || filterAssignee !== "all" || filterUrgency !== "all" || filterDueDate !== "all" || filterCategory !== "all") && (
                <Badge variant="outline" className="bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 border-purple-300">
                  <Filter className="w-3 h-3 mr-1" />
                  {groupedTasks.length} Filtered
                </Badge>
              )}
            </div>
          </div>
          <div className="flex items-center gap-2">
            <Button
              onClick={handleRefresh}
              variant="outline"
              size="sm"
              className="group"
              disabled={isRefreshing}
            >
              <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
              {isRefreshing ? "Refreshing..." : "Refresh"}
            </Button>
            <Button
              onClick={() => handleOpenModal()}
              className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
            >
              <Plus className="w-5 h-5 mr-2" />
              New Milestone
            </Button>
          </div>
        </div>

        {/* Property Filter Banner - ENHANCED with urgency info */}
        {filterProperty !== "all" && (
          <Card className="bg-gradient-to-r from-purple-500 to-indigo-500 border-2 border-purple-600 shadow-xl">
            <CardContent className="p-4">
              <div className="flex items-center justify-between text-white">
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                    {filterUrgency === "overdue" ? (
                      <AlertTriangle className="w-6 h-6 animate-pulse" />
                    ) : (
                      <Home className="w-6 h-6" />
                    )}
                  </div>
                  <div>
                    <p className="text-lg font-bold">
                      {filterUrgency === "overdue" ? "‚ö†Ô∏è " : "üìç "}
                      {properties.find(p => p.id === filterProperty)?.address || "Selected Property"}
                    </p>
                    <p className="text-sm text-white/90 mt-1">
                      {filterUrgency === "overdue" ? (
                        <>
                          Showing {groupedTasks.length} OVERDUE transaction step{groupedTasks.length !== 1 ? 's' : ''}
                          <span className="mx-2">‚Ä¢</span>
                          <span className="text-xs font-bold">ACTION REQUIRED!</span>
                        </>
                      ) : showContractTasksOnly ? (
                        <>
                          Showing {groupedTasks.length} transaction step{groupedTasks.length !== 1 ? 's' : ''} only
                          <span className="mx-2">‚Ä¢</span>
                          <span className="text-xs">
                            {groupedTasks.filter(t => t.status === 'completed').length} completed
                          </span>
                        </>
                      ) : (
                        `${groupedTasks.length} milestone${groupedTasks.length !== 1 ? 's' : ''} found for this property`
                      )}
                    </p>
                  </div>
                </div>
                <Button
                  variant="outline"
                  className="bg-white/20 hover:bg-white/30 text-white border-white/40"
                  onClick={() => {
                    setFilterProperty("all");
                    setShowContractTasksOnly(false);
                    setFilterUrgency("all");
                  }}
                >
                  <X className="w-4 h-4 mr-2" />
                  Show All Items
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {showWorkingHoursMessage && (
            <Card className="border-amber-200 bg-amber-50 dark:bg-amber-900/20">
                <CardContent className="p-6">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-amber-100 dark:bg-amber-800 rounded-full flex items-center justify-center">
                            <Clock className="w-6 h-6 text-amber-600 dark:text-amber-400" />
                        </div>
                        <div className="flex-1">
                            <h3 className="font-semibold text-amber-900 dark:text-amber-100 mb-1">
                                Outside Working Hours
                            </h3>
                            <p className="text-sm text-amber-700 dark:text-amber-300">
                                Tasks are hidden because you're outside your working hours. 
                                Your working schedule: {user.working_hours_start || '09:00'} - {user.working_hours_end || '17:00'}
                            </p>
                            <p className="text-xs text-amber-600 dark:text-amber-400 mt-2">
                                üí° You can change this setting in Settings ‚Üí Profile ‚Üí Working Hours
                            </p>
                        </div>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => navigate('/settings')}
                            className="border-amber-300 hover:bg-amber-100 dark:border-amber-700 dark:hover:bg-amber-800"
                        >
                            <Settings className="w-4 h-4 mr-2" />
                            Settings
                        </Button>
                    </div>
                </CardContent>
            </Card>
        )}

        {/* Enhanced Overdue Alert Banner */}
        {stats.overdue > 0 && (
          <Card className="bg-gradient-to-r from-red-500 to-orange-500 border-2 border-red-600 shadow-xl animate-pulse">
            <CardContent className="p-4">
              <div className="flex items-center justify-between text-white">
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                    <AlertTriangle className="w-6 h-6" />
                  </div>
                  <div>
                    <p className="text-lg font-bold">‚ö†Ô∏è {stats.overdue} Overdue Milestones Require Attention!</p>
                    <p className="text-sm text-white/90 mt-1">
                      {stats.overduePending > 0 && `${stats.overduePending} in To Do`}
                      {stats.overduePending > 0 && stats.overdueInProgress > 0 && ' ‚Ä¢ '}
                      {stats.overdueInProgress > 0 && `${stats.overdueInProgress} in Progress`}
                    </p>
                  </div>
                </div>
                <Button
                  variant="outline"
                  className="bg-white/20 hover:bg-white/30 text-white border-white/40"
                  onClick={() => {
                    setFilterUrgency("overdue");
                    setSearchQuery("");
                    setFilterStatus("all");
                    setFilterPriority("all");
                    setFilterProperty("all");
                    setFilterAssignee("all");
                    setFilterDueDate("all");
                    setFilterCategory("all");
                    setShowContractTasksOnly(false);
                  }}
                >
                  View Overdue Items
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Today's Tasks Banner */}
        {stats.today > 0 && (
          <Card className="bg-gradient-to-r from-indigo-500 to-purple-500 border-2 border-indigo-600 shadow-xl" style={{animation: 'indigo-pulse-glow 3s infinite'}}>
            <CardContent className="p-4">
              <div className="flex items-center justify-between text-white">
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                    <Flame className="w-6 h-6" />
                  </div>
                  <div>
                    <p className="text-lg font-bold">üî• {stats.today} Next Actions Due Today!</p>
                    <p className="text-sm text-white/90 mt-1">
                      {stats.todayPending > 0 && `${stats.todayPending} in To Do`}
                      {stats.todayPending > 0 && stats.todayInProgress > 0 && ' ‚Ä¢ '}
                      {stats.todayInProgress > 0 && `${stats.todayInProgress} in Progress`}
                    </p>
                  </div>
                </div>
                <Button
                  variant="outline"
                  className="bg-white/20 hover:bg-white/30 text-white border-white/40"
                  onClick={() => {
                    setFilterDueDate("today");
                    setSearchQuery("");
                    setFilterStatus("all");
                    setFilterPriority("all");
                    setFilterProperty("all");
                    setFilterAssignee("all");
                    setFilterUrgency("all");
                    setFilterCategory("all");
                    setShowContractTasksOnly(false);
                  }}
                >
                  View Today's Actions
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Stats Overview */}
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
          <Card
            className={`bg-white dark:bg-slate-800 border-2 cursor-pointer transition-all hover:shadow-lg hover:scale-105 ${
              filterStatus === "all" && filterPriority === "all" && filterUrgency === "all" && filterProperty === "all" && filterAssignee === "all" && filterDueDate === "all" && filterCategory === "all" && !searchQuery
                ? 'border-indigo-500 dark:border-indigo-400 ring-2 ring-indigo-200 dark:ring-indigo-900'
                : 'border-slate-200 dark:border-slate-700'
            }`}
            onClick={() => handleStatClick('total')}
          >
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-slate-500 dark:text-slate-400">Total Milestones</p>
                  <p className="text-2xl font-bold text-slate-900 dark:text-white mt-1">{stats.total}</p>
                </div>
                <Target className="w-8 h-8 text-slate-400" />
              </div>
            </CardContent>
          </Card>

          <Card
            className={`bg-amber-50 dark:bg-amber-900/20 border-2 cursor-pointer transition-all hover:shadow-lg hover:scale-105 ${
              filterStatus === "pending" && filterPriority === "all" && filterUrgency === "all" && filterProperty === "all" && filterAssignee === "all" && filterDueDate === "all" && filterCategory === "all" && !searchQuery
                ? 'border-amber-500 dark:border-amber-400 ring-2 ring-amber-200 dark:ring-amber-900'
                : 'border-amber-200 dark:border-amber-800'
            }`}
            onClick={() => handleStatClick('pending')}
          >
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-amber-700 dark:text-amber-400">Pending</p>
                  <p className="text-2xl font-bold text-amber-900 dark:text-amber-300 mt-1">{stats.pending}</p>
                </div>
                <Clock className="w-8 h-8 text-amber-500" />
              </div>
            </CardContent>
          </Card>

          <Card
            className={`bg-blue-50 dark:bg-blue-900/20 border-2 cursor-pointer transition-all hover:shadow-lg hover:scale-105 ${
              filterStatus === "in_progress" && filterPriority === "all" && filterUrgency === "all" && filterProperty === "all" && filterAssignee === "all" && filterDueDate === "all" && filterCategory === "all" && !searchQuery
                ? 'border-blue-500 dark:border-blue-400 ring-2 ring-blue-200 dark:ring-blue-900'
                : 'border-blue-200 dark:border-blue-800'
            }`}
            onClick={() => handleStatClick('in_progress')}
          >
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-blue-700 dark:text-blue-400">In Progress</p>
                  <p className="text-2xl font-bold text-blue-900 dark:text-blue-300 mt-1">{stats.in_progress}</p>
                </div>
                <TrendingUp className="w-8 h-8 text-blue-500" />
              </div>
            </CardContent>
          </Card>

          <Card
            className={`bg-green-50 dark:bg-green-900/20 border-2 cursor-pointer transition-all hover:shadow-lg hover:scale-105 ${
              filterStatus === "completed" && filterPriority === "all" && filterUrgency === "all" && filterProperty === "all" && filterAssignee === "all" && filterDueDate === "all" && filterCategory === "all" && !searchQuery
                ? 'border-green-500 dark:border-green-400 ring-2 ring-green-200 dark:ring-green-900'
                : 'border-green-200 dark:border-green-800'
            }`}
            onClick={() => handleStatClick('completed')}
          >
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-green-700 dark:text-green-400">Completed</p>
                  <p className="text-2xl font-bold text-green-900 dark:text-green-300 mt-1">{stats.completed}</p>
                </div>
                <CheckCircle2 className="w-8 h-8 text-green-500" />
              </div>
            </CardContent>
          </Card>

          <Card
            className={`bg-red-50 dark:bg-red-900/20 border-2 cursor-pointer transition-all hover:shadow-lg hover:scale-105 ${
              filterUrgency === "overdue" && filterStatus === "all" && filterPriority === "all" && filterProperty === "all" && filterAssignee === "all" && filterDueDate === "all" && filterCategory === "all" && !searchQuery
                ? 'border-red-500 dark:border-red-400 ring-2 ring-red-200 dark:ring-red-900'
                : 'border-red-200 dark:border-red-800'
            } ${stats.overdue > 0 ? 'animate-pulse' : ''}`}
            onClick={() => handleStatClick('overdue')}
          >
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-red-700 dark:text-red-400 flex items-center gap-1">
                    Overdue
                    {stats.overduePending > 0 && (
                      <span className="text-[10px] bg-red-200 dark:bg-red-800 px-1 rounded">
                        {stats.overduePending} pending
                      </span>
                    )}
                  </p>
                  <p className="text-2xl font-bold text-red-900 dark:text-red-300 mt-1">{stats.overdue}</p>
                </div>
                <AlertTriangle className="w-8 h-8 text-red-500" />
              </div>
            </CardContent>
          </Card>

          <Card
            className={`bg-indigo-50 dark:bg-indigo-900/20 border-2 cursor-pointer transition-all hover:shadow-lg hover:scale-105 ${
              filterDueDate === "today" && filterStatus === "all" && filterPriority === "all" && filterProperty === "all" && filterAssignee === "all" && filterUrgency === "all" && filterCategory === "all" && !searchQuery
                ? 'border-indigo-500 dark:border-indigo-400 ring-2 ring-indigo-200 dark:ring-indigo-900'
                : 'border-indigo-200 dark:border-indigo-800'
            }`}
            onClick={() => handleStatClick('today')}
          >
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-indigo-700 dark:text-indigo-400">Today</p>
                  <p className="text-2xl font-bold text-indigo-900 dark:text-indigo-300 mt-1">{stats.today}</p>
                </div>
                <Flame className="w-8 h-8 text-indigo-500" />
              </div>
            </CardContent>
          </Card>

          <Card
            className={`bg-purple-50 dark:bg-purple-900/20 border-2 cursor-pointer transition-all hover:shadow-lg hover:scale-105 ${
              filterDueDate === "thisWeek" && filterStatus === "all" && filterPriority === "all" && filterProperty === "all" && filterAssignee === "all" && filterUrgency === "all" && filterCategory === "all" && !searchQuery
                ? 'border-purple-500 dark:border-purple-400 ring-2 ring-purple-200 dark:ring-purple-900'
                : 'border-purple-200 dark:border-purple-800'
            }`}
            onClick={() => handleStatClick('thisWeek')}
          >
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs font-medium text-purple-700 dark:text-purple-400">This Week</p>
                  <p className="text-2xl font-bold text-purple-900 dark:text-purple-300 mt-1">{stats.thisWeek}</p>
                </div>
                <Calendar className="w-8 h-8 text-purple-500" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Completion Progress */}
        <Card className="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-2 border-green-200 dark:border-green-800">
          <CardContent className="p-4">
            <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-2">
              <Target className="w-5 h-5 text-green-600 dark:text-green-400" />
              <span className="font-semibold text-green-900 dark:text-green-300">Overall Progress</span>
            </div>
            <span className="text-lg font-bold text-green-900 dark:text-green-300">{completionRate}%</span>
            </div>
            <div className="w-full bg-green-200 dark:bg-green-900/40 rounded-full h-3">
            <div
              className="bg-gradient-to-r from-green-500 to-emerald-500 h-3 rounded-full transition-all duration-500"
              style={{ width: `${completionRate}%` }}
            />
            </div>
            <p className="text-xs text-green-700 dark:text-green-400 mt-2">
            {stats.completed} of {stats.total} milestones completed
            </p>
          </CardContent>
        </Card>

        {/* Filters and Search */}
        <Card className="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700">
          <CardContent className="p-4">
            <div className="flex flex-col lg:flex-row gap-4">
              {/* Search */}
              <div className="flex-1">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" />
                  <Input
                    placeholder="Search milestones by title or description..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="pl-10 h-11 border-2"
                  />
                </div>
              </div>

              {/* Filters */}
              <div className="flex flex-wrap gap-2">
                {/* Status Filter */}
                <Select value={filterStatus} onValueChange={setFilterStatus}>
                  <SelectTrigger className="w-[140px] h-11">
                    <SelectValue placeholder="Status" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Status</SelectItem>
                    <SelectItem value="pending">Pending</SelectItem>
                    <SelectItem value="in_progress">In Progress</SelectItem>
                    <SelectItem value="completed">Completed</SelectItem>
                  </SelectContent>
                </Select>

                {/* Priority Filter */}
                <Select value={filterPriority} onValueChange={setFilterPriority}>
                  <SelectTrigger className="w-[140px] h-11">
                    <SelectValue placeholder="Priority" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Priority</SelectItem>
                    <SelectItem value="critical">Critical</SelectItem>
                    <SelectItem value="high">High</SelectItem>
                    <SelectItem value="medium">Medium</SelectItem>
                    <SelectItem value="low">Low</SelectItem>
                  </SelectContent>
                </Select>

                {/* Urgency Filter */}
                <div className="flex items-center gap-1">
                  <Select value={filterUrgency} onValueChange={setFilterUrgency}>
                    <SelectTrigger className="w-[140px] h-11 border-2">
                      <SelectValue placeholder="Urgency" />
                    </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Tasks</SelectItem>
                    <SelectItem value="overdue">
                      <span className="flex items-center gap-2">
                        <AlertTriangle className="w-4 h-4 text-red-500" />
                        Overdue
                      </span>
                    </SelectItem>
                    <SelectItem value="warning">
                      <span className="flex items-center gap-2">
                        <Clock className="w-4 h-4 text-amber-500" />
                        Due Soon
                      </span>
                    </SelectItem>
                    <SelectItem value="normal">
                      <span className="flex items-center gap-2">
                        <CheckCircle2 className="w-4 h-4 text-green-500" />
                        On Track
                      </span>
                    </SelectItem>
                  </SelectContent>
                </Select>
                <HelpTooltip text="Filter milestones by urgency: Overdue (past due date), Due Soon (within 3 days), or On Track" />
              </div>

                {/* Property Filter - ENHANCED WITH IMAGES */}
                <Select 
                  value={filterProperty} 
                  onValueChange={(value) => {
                    setFilterProperty(value);
                    // When manually selecting property, don't force contract-only mode
                    if (value === "all") {
                      setShowContractTasksOnly(false);
                    }
                  }}
                >
                  <SelectTrigger className="w-[200px] h-11 border-2 border-purple-300 dark:border-purple-700">
                    <SelectValue placeholder="All Properties" />
                  </SelectTrigger>
                  <SelectContent className="max-h-[400px]">
                  <SelectItem value="all">
                    <span className="flex items-center gap-2">
                      <Home className="w-4 h-4 text-slate-400" />
                      All Properties
                    </span>
                  </SelectItem>
                    {properties.map(property => (
                      <SelectItem key={property.id} value={property.id}>
                        <div className="flex items-center gap-3 py-1">
                          <div className="w-10 h-10 rounded-lg flex-shrink-0 bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900 dark:to-purple-900 flex items-center justify-center border border-slate-300 dark:border-slate-600 overflow-hidden">
                            {property.primary_photo_url ? (
                              <img 
                                src={property.primary_photo_url} 
                                alt={property.address}
                                className="w-full h-full object-cover"
                                onError={(e) => {
                                  e.target.style.display = 'none';
                                }}
                              />
                            ) : (
                              <Home className="w-5 h-5 text-indigo-500" />
                            )}
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="font-medium text-sm truncate">{property.address}</p>
                            {property.city && (
                              <p className="text-xs text-slate-500 dark:text-slate-400">
                                {property.city}, {property.state}
                              </p>
                            )}
                          </div>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>

                {/* Assignee Filter */}
                <Select value={filterAssignee} onValueChange={setFilterAssignee}>
                  <SelectTrigger className="w-[140px] h-11">
                    <SelectValue placeholder="Assignee" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Users</SelectItem>
                    {systemUsers.map(u => (
                      <SelectItem key={u.id} value={u.id}>
                        {u.full_name || u.email}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>

                {/* Category Filter */}
                <Select value={filterCategory} onValueChange={setFilterCategory}>
                    <SelectTrigger className="w-[160px] h-11">
                        <SelectValue placeholder="Category" />
                    </SelectTrigger>
                    <SelectContent>
                        <SelectItem value="all">All Categories</SelectItem>
                        <SelectItem value="soi-campaign">
                          <span className="flex items-center gap-2">
                            <Zap className="w-4 h-4 text-blue-500" />
                            SOI Campaign
                          </span>
                        </SelectItem>
                        <SelectItem value="contract">
                          <span className="flex items-center gap-2">
                            <ListChecks className="w-4 h-4 text-purple-500" />
                            Contract
                          </span>
                        </SelectItem>
                        <SelectItem value="inspection">
                          <span className="flex items-center gap-2">
                            <Eye className="w-4 h-4 text-amber-500" />
                            Inspection
                          </span>
                        </SelectItem>
                        <SelectItem value="financing">
                          <span className="flex items-center gap-2">
                            <TrendingUp className="w-4 h-4 text-green-500" />
                            Financing
                          </span>
                        </SelectItem>
                        <SelectItem value="closing">
                          <span className="flex items-center gap-2">
                            <CheckCircle className="w-4 h-4 text-red-500" />
                            Closing
                          </span>
                        </SelectItem>
                        <SelectItem value="other">Other</SelectItem>
                    </SelectContent>
                </Select>

                {/* Sort */}
                <div className="flex items-center gap-1">
                  <Select value={sortBy} onValueChange={setSortBy}>
                    <SelectTrigger className="w-[140px] h-11">
                      <SelectValue placeholder="Sort by" />
                    </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="recommended">Recommended</SelectItem>
                    <SelectItem value="due_date">Due Date</SelectItem>
                    <SelectItem value="priority">Priority</SelectItem>
                    <SelectItem value="created_date">Created Date</SelectItem>
                  </SelectContent>
                </Select>
                <HelpTooltip text="Recommended sorting intelligently prioritizes tasks by due date, urgency, and priority" />
              </div>

                {/* Clear Filters */}
                {(searchQuery || filterStatus !== "all" || filterPriority !== "all" ||
                  filterProperty !== "all" || filterAssignee !== "all" || filterUrgency !== "all" || filterDueDate !== "all" || filterCategory !== "all" || showContractTasksOnly) && (
                  <Button
                    variant="outline"
                    onClick={() => {
                      setSearchQuery("");
                      setFilterStatus("all");
                      setFilterPriority("all");
                      setFilterProperty("all");
                      setFilterAssignee("all");
                      setFilterUrgency("all");
                      setFilterDueDate("all");
                      setFilterCategory("all");
                      setShowContractTasksOnly(false);
                    }}
                    className="h-11 bg-red-50 hover:bg-red-100 text-red-600 border-red-200 font-semibold"
                  >
                    <X className="w-4 h-4 mr-2" />
                    Clear All Filters
                  </Button>
                )}
              </div>
            </div>

            {/* Results count and Active Filters Display */}
            <div className="mt-3 flex items-center justify-between flex-wrap gap-3">
              <p className="text-sm text-slate-600 dark:text-slate-400">
                Showing <span className="font-semibold text-indigo-600 dark:text-indigo-400">{groupedTasks.length}</span> of{" "}
                <span className="font-semibold">{visibleUserTasks.length}</span> items
              </p>

              {/* Show active filters */}
              <div className="flex items-center gap-2 flex-wrap">
                {filterStatus !== "all" && (
                  <Badge variant="outline" className="bg-blue-50 text-blue-700 border-blue-300 dark:bg-blue-900/20 dark:text-blue-300 dark:border-blue-700">
                    Status: {filterStatus}
                    <button onClick={() => setFilterStatus("all")} className="ml-1 hover:text-blue-900 dark:hover:text-blue-100">
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {filterPriority !== "all" && (
                  <Badge variant="outline" className="bg-orange-50 text-orange-700 border-orange-300 dark:bg-orange-900/20 dark:text-orange-300 dark:border-orange-700">
                    Priority: {filterPriority}
                    <button onClick={() => setFilterPriority("all")} className="ml-1 hover:text-orange-900 dark:hover:text-orange-100">
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {filterUrgency !== "all" && (
                  <Badge variant="outline" className="bg-red-50 text-red-700 border-red-300 dark:bg-red-900/20 dark:text-red-300 dark:border-red-700">
                    Urgency: {filterUrgency}
                    <button onClick={() => setFilterUrgency("all")} className="ml-1 hover:text-red-900 dark:hover:text-red-100">
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {filterDueDate !== "all" && (
                  <Badge variant="outline" className="bg-purple-50 text-purple-700 border-purple-300 dark:bg-purple-900/20 dark:text-purple-300 dark:border-purple-700">
                    Due: {filterDueDate}
                    <button onClick={() => setFilterDueDate("all")} className="ml-1 hover:text-purple-900 dark:hover:text-purple-100">
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {filterProperty !== "all" && (
                  <Badge variant="outline" className="bg-green-50 text-green-700 border-green-300 dark:bg-green-900/20 dark:text-green-300 dark:border-green-700">
                    Property: {properties.find(p => p.id === filterProperty)?.address || "filtered"}
                    <button onClick={() => {
                      setFilterProperty("all");
                      setShowContractTasksOnly(false);
                    }} className="ml-1 hover:text-green-900 dark:hover:text-green-100">
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {filterAssignee !== "all" && (
                  <Badge variant="outline" className="bg-indigo-50 text-indigo-700 border-indigo-300 dark:bg-indigo-900/20 dark:text-indigo-300 dark:border-indigo-700">
                    Assignee: {systemUsers.find(u => u.id === filterAssignee)?.full_name || "filtered"}
                    <button onClick={() => setFilterAssignee("all")} className="ml-1 hover:text-indigo-900 dark:hover:text-indigo-100">
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {filterCategory !== "all" && (
                  <Badge variant="outline" className="bg-blue-50 text-blue-700 border-blue-300 dark:bg-blue-900/20 dark:text-blue-300 dark:border-blue-700">
                    Category: {filterCategory}
                    <button onClick={() => setFilterCategory("all")} className="ml-1 hover:text-blue-900 dark:hover:text-blue-100">
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {showContractTasksOnly && filterProperty !== "all" && (
                  <Badge variant="outline" className="bg-orange-50 text-orange-700 border-orange-300 dark:bg-orange-900/20 dark:text-orange-300 dark:border-orange-700">
                    Type: Transaction Steps Only
                    <button onClick={() => setShowContractTasksOnly(false)} className="ml-1 hover:text-orange-900 dark:hover:text-orange-100">
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {searchQuery && (
                  <Badge variant="outline" className="bg-slate-50 text-slate-700 border-slate-300 dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600">
                    Search: "{searchQuery}"
                    <button onClick={() => setSearchQuery("")} className="ml-1 hover:text-slate-900 dark:hover:text-slate-100">
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Bulk Actions Bar */}
        {selectedTaskIds.length > 0 && (
          <Card className="bg-indigo-50 dark:bg-indigo-900/20 border-2 border-indigo-300 dark:border-indigo-700">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <CheckSquare className="w-5 h-5 text-indigo-600 dark:text-indigo-400" />
                  <span className="font-semibold text-indigo-900 dark:text-indigo-300">
                    {selectedTaskIds.length} item{selectedTaskIds.length !== 1 ? 's' : ''} selected
                  </span>
                  <HelpTooltip text="Select multiple items to update their status or delete them all at once" />
                </div>
                <div className="flex items-center gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => handleBulkStatusChange('in_progress')}
                  >
                    Start All
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => handleBulkStatusChange('completed')}
                  >
                    Complete All
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={handleBulkDelete}
                    className="text-red-600 hover:text-red-700 hover:border-red-300 dark:text-red-400 dark:hover:text-red-300 dark:border-red-700"
                  >
                    <Trash2 className="w-4 h-4 mr-2" />
                    Delete
                  </Button>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={handleDeselectAll}
                  >
                    <X className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* View Mode Toggle */}
        <div className="flex items-center justify-end gap-2">
        <Button
          variant={viewMode === "kanban" ? "default" : "outline"}
          size="sm"
          onClick={() => setViewMode("kanban")}
        >
          <LayoutGrid className="w-4 h-4 mr-2" />
          Kanban
        </Button>
        <Button
          variant={viewMode === "list" ? "default" : "outline"}
          size="sm"
          onClick={() => setViewMode("list")}
        >
          <ListTodo className="w-4 h-4 mr-2" />
          List View
        </Button>
        <HelpTooltip text="Kanban view allows drag-and-drop to change status. List view shows all milestones in a detailed list." />
        </div>

        {/* Tasks Display */}
        {groupedTasks.length === 0 ? (
          <Card className="border-2 border-dashed border-slate-300 dark:border-slate-700">
            <CardContent className="p-12 text-center">
              <ListTodo className="w-16 h-16 text-slate-300 dark:text-slate-600 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
                No Milestones Found
              </h3>
              <p className="text-slate-600 dark:text-slate-400 mb-4">
                {(searchQuery || filterStatus !== "all" || filterPriority !== "all" || filterProperty !== "all" || filterAssignee !== "all" || filterUrgency !== "all" || filterDueDate !== "all" || filterCategory !== "all")
                  ? 'No milestones match your current filters. Try adjusting or clearing them.'
                  : 'Get started by creating your first milestone'}
              </p>
              <div className="flex items-center justify-center gap-3 flex-wrap">
                {(searchQuery || filterStatus !== "all" || filterPriority !== "all" || filterProperty !== "all" || filterAssignee !== "all" || filterUrgency !== "all" || filterDueDate !== "all" || filterCategory !== "all" || showContractTasksOnly) && (
                  <Button
                    variant="outline"
                    onClick={() => {
                      setSearchQuery("");
                      setFilterStatus("all");
                      setFilterPriority("all");
                      setFilterProperty("all");
                      setFilterAssignee("all");
                      setFilterUrgency("all");
                      setFilterDueDate("all");
                      setFilterCategory("all");
                      setShowContractTasksOnly(false);
                    }}
                    className="bg-red-50 hover:bg-red-100 text-red-600 border-red-200 dark:bg-red-900/20 dark:hover:bg-red-900/40 dark:text-red-400 dark:border-red-700"
                  >
                    <X className="w-5 h-5 mr-2" />
                    Clear All Filters
                  </Button>
                )}
                <Button
                  onClick={() => handleOpenModal()}
                >
                  <Plus className="w-5 h-5 mr-2" />
                  Create Milestone
                </Button>
              </div>
            </CardContent>
          </Card>
        ) : viewMode === "kanban" ? (
          <DragDropContext onDragEnd={handleDragEnd}>
            <TaskKanbanBoard
              tasks={groupedTasks}
              users={systemUsers}
              properties={properties}
              onEditTask={(task) => {
                if (!user || !canEditTask(user, task)) {
                  toast.error("You don't have permission to edit this task");
                  return;
                }
                handleTaskClick(task);
              }}
              onDeleteTask={handleDeleteTask}
              highlightedTaskId={highlightedTaskId}
              highlightedTaskIds={highlightedTaskIds}
              todayPendingTaskIds={todayPendingTaskIds}
              taskFilter={filterUrgency}
              selectedTaskIds={selectedTaskIds}
              onSelectTask={handleSelectTask}
              showBulkActions={selectedTaskIds.length > 0}
              recentlyMovedTasks={recentlyMovedTasks}
            />
          </DragDropContext>
        ) : (
          <div className="space-y-3">
            {/* Select All */}
            <div className="flex items-center gap-2 px-2">
              <Button
                variant="outline"
                size="sm"
                onClick={handleSelectAll}
              >
                Select All
              </Button>
              {selectedTaskIds.length > 0 && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={handleDeselectAll}
                >
                  Deselect All
                </Button>
              )}
            </div>

            {/* Task List */}
            {groupedTasks.map(task => {
              const property = properties.find(p => p.id === task.property_id);
              const assignee = systemUsers.find(u => u.id === task.assigned_to);
              const urgency = getTaskUrgency(task);
              const isSelected = selectedTaskIds.includes(task.id);
              const isHighlighted = highlightedTaskIds.includes(task.id);
              const isTodayPending = todayPendingTaskIds.includes(task.id);

              return (
                <Card
                  key={task.id}
                  id={`task-${task.id}`}
                  className={`transition-all ${
                    isHighlighted ? 'ring-2 ring-indigo-500 ring-offset-2 dark:ring-offset-slate-900' : ''
                  } ${
                    isSelected ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-300 dark:border-indigo-700' : ''
                  } ${
                    isTodayPending ? 'today-pending-task-blinking' : ''
                  }`}
                >
                  <CardContent className="p-4">
                    <div className="flex items-start gap-4">
                      {/* Checkbox */}
                      <input
                        type="checkbox"
                        checked={isSelected}
                        onChange={(e) => handleSelectTask(task.id, e.target.checked)}
                        className="mt-1 w-4 h-4 rounded border-slate-300 dark:bg-slate-700 dark:border-slate-600 dark:checked:bg-indigo-500"
                      />

                      {/* Property Image */}
                      {property?.primary_photo_url && (
                        <img 
                          src={property.primary_photo_url} 
                          alt={property.address}
                          className="w-16 h-16 rounded-lg object-cover border-2 border-slate-300 dark:border-slate-600 flex-shrink-0"
                          onError={(e) => {
                            e.target.style.display = 'none';
                          }}
                        />
                      )}

                      {/* Task Info */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-start justify-between gap-4 mb-2">
                          <div className="flex-1">
                            <h3 className={`font-semibold text-slate-900 dark:text-white ${
                              task.status === 'completed' ? 'line-through text-slate-500 dark:text-slate-500' : ''
                            }`}>
                              {task.title}
                            </h3>
                            {task.description && (
                              <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">
                                {task.description}
                              </p>
                            )}
                          </div>

                          {/* Actions */}
                          <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                              <Button variant="ghost" size="icon">
                                <MoreVertical className="w-4 h-4" />
                              </Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="end">
                              {user && canEditTask(user, task) && (
                                <DropdownMenuItem onClick={() => handleTaskClick(task)}>
                                  Edit
                                </DropdownMenuItem>
                              )}
                              {user && canDeleteTask(user) && (
                                <DropdownMenuItem
                                  onClick={() => handleDeleteTask(task.id)}
                                  className="text-red-600 focus:bg-red-50 dark:focus:bg-red-900"
                                >
                                  Delete
                                </DropdownMenuItem>
                              )}
                            </DropdownMenuContent>
                          </DropdownMenu>
                        </div>

                        {/* Meta Info */}
                        <div className="flex flex-wrap items-center gap-2">
                          {/* Status */}
                          <Badge className={
                            task.status === 'completed' ? 'bg-green-100 text-green-700 dark:bg-green-900/20 dark:text-green-300' :
                            task.status === 'in_progress' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300' :
                            'bg-amber-100 text-amber-700 dark:bg-amber-900/20 dark:text-amber-300'
                          }>
                            {task.status.replace('_', ' ')}
                          </Badge>

                          {/* Priority */}
                          <Badge className={
                            task.priority === 'critical' ? 'bg-red-600 text-white dark:bg-red-700' :
                            task.priority === 'high' ? 'bg-orange-600 text-white dark:bg-orange-700' :
                            task.priority === 'medium' ? 'bg-yellow-600 text-white dark:bg-yellow-700' :
                            'bg-slate-600 text-white dark:bg-slate-700'
                          }>
                            {task.priority}
                          </Badge>

                          {/* Urgency */}
                          {urgency === 'overdue' && (
                            <Badge className="bg-red-100 text-red-700 border border-red-300 dark:bg-red-900/20 dark:text-red-300 dark:border-red-700">
                              <AlertTriangle className="w-3 h-3 mr-1" />
                              Overdue
                            </Badge>
                          )}
                          {urgency === 'warning' && (
                            <Badge className="bg-amber-100 text-amber-700 border border-amber-300 dark:bg-amber-900/20 dark:text-amber-300 dark:border-amber-700">
                              <Clock className="w-3 h-3 mr-1" />
                              Due Soon
                            </Badge>
                          )}

                          {/* Deal Stage Badge */}
                          {task.package_name && (
                            <Badge variant="outline" className="bg-purple-50 text-purple-700 border-purple-300 dark:bg-purple-900/30 dark:text-purple-300">
                              Deal Stage
                            </Badge>
                          )}

                          {/* Due Date */}
                          {task.due_date && (() => {
                            try {
                              const date = new Date(task.due_date);
                              if (isNaN(date.getTime())) return null;
                              return (
                                <span className="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1">
                                  <Calendar className="w-3 h-3" />
                                  {format(date, 'MMM d, yyyy')}
                                </span>
                              );
                            } catch (e) {
                              console.error('Invalid date for task:', task.id, task.due_date);
                              return null;
                            }
                          })()}

                          {/* Property */}
                          <span className="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1">
                            <Home className="w-3 h-3" />
                            {property ? property.address : 'No property assigned'}
                          </span>

                          {/* Assignee */}
                          {assignee && (
                            <span className="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1">
                              <User className="w-3 h-3" />
                              {assignee.full_name || assignee.email}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              );
            })}
          </div>
        )}
      </div>

      {/* Task Modal */}
      {showTaskModal && (
        <TaskModal
          task={editingTask}
          users={systemUsers}
          properties={properties}
          onSave={handleSaveTask}
          onClose={() => {
            setShowTaskModal(false);
            setEditingTask(null);
          }}
        />
      )}
    </div>
  );
}
import React, { useState, useEffect, useRef } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Separator } from '@/components/ui/separator';
import { Textarea } from '@/components/ui/textarea';
import {
  MessageSquare,
  Hash,
  Users,
  Send,
  Paperclip,
  X,
  File,
  Image as ImageIcon,
  Download,
  Loader2
} from 'lucide-react';
import { toast } from 'sonner';
import { format } from 'date-fns';

export default function TeamChat() {
  const queryClient = useQueryClient();
  const [activeChannel, setActiveChannel] = useState(null);
  const [messageContent, setMessageContent] = useState('');
  const [attachments, setAttachments] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [isUploading, setIsUploading] = useState(false);
  const [replyTo, setReplyTo] = useState(null);
  const [showMentions, setShowMentions] = useState(false);
  const messagesEndRef = useRef(null);
  const fileInputRef = useRef(null);

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me()
  });

  const { data: messages = [] } = useQuery({
    queryKey: ['chatMessages', activeChannel?.id],
    queryFn: () => base44.entities.ChatMessage.list('-created_date'),
    refetchInterval: 5000,
    enabled: !!user
  });

  const { data: transactions = [] } = useQuery({
    queryKey: ['transactions'],
    queryFn: () => base44.entities.Transaction.list(),
    enabled: !!user
  });

  const { data: teamMembers = [] } = useQuery({
    queryKey: ['users'],
    queryFn: () => base44.entities.User.list(),
    enabled: !!user
  });

  const { data: properties = [] } = useQuery({
    queryKey: ['properties'],
    queryFn: () => base44.entities.Property.list(),
    enabled: !!user
  });

  const sendMessageMutation = useMutation({
    mutationFn: (messageData) => base44.entities.ChatMessage.create(messageData),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['chatMessages'] });
      setMessageContent('');
      setAttachments([]);
      setReplyTo(null);
      
      // Create notifications for mentions
      if (messageContent.includes('@')) {
        const mentions = extractMentions(messageContent);
        mentions.forEach(userId => {
          base44.entities.Notification.create({
            user_id: userId,
            title: 'You were mentioned',
            message: `${user.full_name} mentioned you in ${activeChannel?.name || 'a chat'}`,
            notification_type: 'message_received',
            related_entity_type: 'chat',
            related_entity_id: activeChannel?.id
          }).catch(console.error);
        });
      }
    },
    onError: (error) => {
      toast.error('Failed to send message: ' + error.message);
    }
  });

  const markAsReadMutation = useMutation({
    mutationFn: ({ id, readBy }) => base44.entities.ChatMessage.update(id, { 
      is_read: true,
      read_by: readBy 
    }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['chatMessages'] });
    }
  });

  useEffect(() => {
    if (transactions.length > 0 && !activeChannel) {
      const firstTransaction = transactions.find(t => t.status !== 'closed' && t.status !== 'cancelled');
      if (firstTransaction) {
        const property = properties.find(p => p.id === firstTransaction.property_id);
        setActiveChannel({
          id: firstTransaction.id,
          name: property?.address || 'Transaction',
          type: 'transaction',
          transaction: firstTransaction
        });
      }
    }
  }, [transactions, properties, activeChannel]);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  useEffect(() => {
    if (activeChannel && messages.length > 0) {
      messages.forEach(msg => {
        if (msg.sender_id !== user?.id && !msg.is_read) {
          const currentReadBy = msg.read_by ? msg.read_by.split(',') : [];
          if (!currentReadBy.includes(user?.id)) {
            markAsReadMutation.mutate({
              id: msg.id,
              readBy: [...currentReadBy, user.id].join(',')
            });
          }
        }
      });
    }
  }, [messages, activeChannel, user]);

  const extractMentions = (text) => {
    const mentionRegex = /@(\w+)/g;
    const mentions = [];
    let match;
    
    while ((match = mentionRegex.exec(text)) !== null) {
      const username = match[1].toLowerCase();
      const mentionedUser = teamMembers.find(m => 
        m.full_name?.toLowerCase().includes(username) || m.email?.toLowerCase().includes(username)
      );
      if (mentionedUser) {
        mentions.push(mentionedUser.id);
      }
    }
    
    return mentions;
  };

  const handleFileUpload = async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    setIsUploading(true);

    try {
      const uploadedFiles = await Promise.all(
        files.map(async (file) => {
          const { file_url } = await base44.integrations.Core.UploadFile({ file });
          return {
            name: file.name,
            url: file_url,
            type: file.type,
            size: file.size
          };
        })
      );

      setAttachments(prev => [...prev, ...uploadedFiles]);
      toast.success(`${files.length} file(s) uploaded`);
    } catch (error) {
      toast.error('Failed to upload files');
      console.error(error);
    } finally {
      setIsUploading(false);
    }
  };

  const handleSendMessage = () => {
    if (!messageContent.trim() && attachments.length === 0) {
      toast.error('Please enter a message or attach a file');
      return;
    }

    const mentions = extractMentions(messageContent);
    
    const messageData = {
      sender_id: user.id,
      content: messageContent,
      channel_type: activeChannel?.type || 'general',
      mentions: mentions.join(','),
      attachments: JSON.stringify(attachments),
      reply_to: replyTo?.id || null
    };

    if (activeChannel?.type === 'transaction') {
      messageData.transaction_id = activeChannel.id;
    } else if (activeChannel?.type === 'direct') {
      messageData.recipient_id = activeChannel.userId;
      messageData.channel_type = 'direct';
    } else if (activeChannel?.type === 'all_team') {
      messageData.channel_type = 'all_team';
      // Notify all team members
      teamMembers.forEach(member => {
        if (member.id !== user.id) {
          base44.entities.Notification.create({
            user_id: member.id,
            title: 'Team-wide message',
            message: `${user.full_name}: ${messageContent.slice(0, 100)}...`,
            notification_type: 'message_received',
            related_entity_type: 'chat',
            related_entity_id: 'all-team'
          }).catch(console.error);
        }
      });
    }

    sendMessageMutation.mutate(messageData);
  };

  const getChannels = () => {
    const channels = [
      {
        id: 'all-team',
        name: 'üì¢ All Team Members',
        type: 'all_team',
        icon: Users,
        unread: 0
      },
      {
        id: 'general',
        name: 'General',
        type: 'general',
        icon: Hash,
        unread: 0
      }
    ];

    // Transaction channels
    transactions
      .filter(t => t.status !== 'closed' && t.status !== 'cancelled')
      .forEach(t => {
        const property = properties.find(p => p.id === t.property_id);
        const transactionMessages = messages.filter(m => m.transaction_id === t.id);
        const unread = transactionMessages.filter(m => 
          m.sender_id !== user?.id && 
          !m.read_by?.split(',').includes(user?.id)
        ).length;

        channels.push({
          id: t.id,
          name: property?.address || `Transaction ${t.id.slice(0, 8)}`,
          type: 'transaction',
          icon: Hash,
          transaction: t,
          unread
        });
      });

    // Direct message channels
    teamMembers
      .filter(m => m.id !== user?.id)
      .forEach(member => {
        const dmMessages = messages.filter(m => 
          (m.sender_id === user?.id && m.recipient_id === member.id) ||
          (m.sender_id === member.id && m.recipient_id === user?.id)
        );
        const unread = dmMessages.filter(m => 
          m.sender_id !== user?.id && 
          !m.read_by?.split(',').includes(user?.id)
        ).length;

        channels.push({
          id: `dm-${member.id}`,
          name: member.full_name || member.email,
          type: 'direct',
          icon: Users,
          userId: member.id,
          user: member,
          unread
        });
      });

    return channels;
  };

  const getFilteredMessages = () => {
    if (!activeChannel) return [];

    let filtered = messages;

    if (activeChannel.type === 'transaction') {
      filtered = messages.filter(m => m.transaction_id === activeChannel.id);
    } else if (activeChannel.type === 'direct') {
      filtered = messages.filter(m => 
        (m.sender_id === user?.id && m.recipient_id === activeChannel.userId) ||
        (m.sender_id === activeChannel.userId && m.recipient_id === user?.id)
      );
    } else if (activeChannel.type === 'all_team') {
      filtered = messages.filter(m => m.channel_type === 'all_team');
    } else if (activeChannel.type === 'general') {
      filtered = messages.filter(m => m.channel_type === 'general' && !m.transaction_id && !m.recipient_id);
    }

    if (searchQuery) {
      filtered = filtered.filter(m => 
        m.content?.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    return filtered.sort((a, b) => new Date(a.created_date) - new Date(b.created_date));
  };

  const renderMessage = (msg) => {
    const sender = teamMembers.find(m => m.id === msg.sender_id);
    const isOwn = msg.sender_id === user?.id;
    const attachmentData = msg.attachments ? JSON.parse(msg.attachments) : [];
    const replyToMsg = msg.reply_to ? messages.find(m => m.id === msg.reply_to) : null;

    return (
      <div key={msg.id} className={`flex gap-3 ${isOwn ? 'flex-row-reverse' : ''} mb-4`}>
        <Avatar className="h-8 w-8 flex-shrink-0">
          <AvatarFallback className="bg-indigo-100 text-indigo-700 text-xs">
            {sender?.full_name?.charAt(0) || '?'}
          </AvatarFallback>
        </Avatar>

        <div className={`flex-1 max-w-[70%] ${isOwn ? 'items-end' : ''}`}>
          <div className={`flex items-center gap-2 mb-1 ${isOwn ? 'flex-row-reverse' : ''}`}>
            <span className="text-sm font-semibold text-slate-900 dark:text-white">
              {sender?.full_name || 'Unknown'}
            </span>
            <span className="text-xs text-slate-500">
              {format(new Date(msg.created_date), 'h:mm a')}
            </span>
          </div>

          {replyToMsg && (
            <div className="mb-2 p-2 bg-slate-100 dark:bg-slate-800 rounded-lg border-l-2 border-indigo-500 text-xs">
              <span className="text-slate-600 dark:text-slate-400">
                Replying to {teamMembers.find(m => m.id === replyToMsg.sender_id)?.full_name}
              </span>
              <p className="text-slate-500 truncate">{replyToMsg.content}</p>
            </div>
          )}

          <div className={`rounded-lg p-3 ${
            isOwn 
              ? 'bg-indigo-600 text-white' 
              : 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700'
          }`}>
            <p className="text-sm whitespace-pre-wrap break-words">{msg.content}</p>

            {attachmentData.length > 0 && (
              <div className="mt-2 space-y-2">
                {attachmentData.map((file, idx) => (
                  <a
                    key={idx}
                    href={file.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className={`flex items-center gap-2 p-2 rounded ${
                      isOwn ? 'bg-indigo-700' : 'bg-slate-100 dark:bg-slate-700'
                    } hover:opacity-80 transition-opacity`}
                  >
                    {file.type?.startsWith('image/') ? (
                      <ImageIcon className="w-4 h-4" />
                    ) : (
                      <File className="w-4 h-4" />
                    )}
                    <span className="text-xs truncate flex-1">{file.name}</span>
                    <Download className="w-3 h-3" />
                  </a>
                ))}
              </div>
            )}
          </div>

          {!isOwn && (
            <button
              onClick={() => setReplyTo(msg)}
              className="text-xs text-indigo-600 hover:text-indigo-800 mt-1"
            >
              Reply
            </button>
          )}
        </div>
      </div>
    );
  };

  const channels = getChannels();
  const filteredMessages = getFilteredMessages();

  return (
    <div className="h-[calc(100vh-120px)] flex gap-4">
      {/* Sidebar - Channels */}
      <Card className="w-80 flex flex-col">
        <CardHeader className="pb-3">
          <CardTitle className="flex items-center gap-2">
            <MessageSquare className="w-5 h-5" />
            Team Chat
          </CardTitle>
        </CardHeader>
        <CardContent className="flex-1 overflow-y-auto p-0">
          <div className="p-3">
            <Input
              placeholder="Search channels..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="mb-3"
            />
          </div>

          <div className="space-y-1 px-2">
            <div className="px-3 py-2 text-xs font-semibold text-slate-500 uppercase">
              Channels
            </div>
            {channels
              .filter(c => c.type !== 'direct')
              .map(channel => (
                <button
                  key={channel.id}
                  onClick={() => setActiveChannel(channel)}
                  className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${
                    activeChannel?.id === channel.id
                      ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300'
                      : 'hover:bg-slate-100 dark:hover:bg-slate-800'
                  }`}
                >
                  {channel.icon && React.createElement(channel.icon, { className: "w-4 h-4" })}
                  <span className="flex-1 text-left text-sm truncate">{channel.name}</span>
                  {channel.unread > 0 && (
                    <Badge className="bg-red-500 text-white text-xs px-1.5 py-0">
                      {channel.unread}
                    </Badge>
                  )}
                </button>
              ))}

            <Separator className="my-2" />

            <div className="px-3 py-2 text-xs font-semibold text-slate-500 uppercase">
              Direct Messages
            </div>
            {channels
              .filter(c => c.type === 'direct')
              .map(channel => (
                <button
                  key={channel.id}
                  onClick={() => setActiveChannel(channel)}
                  className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${
                    activeChannel?.id === channel.id
                      ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300'
                      : 'hover:bg-slate-100 dark:hover:bg-slate-800'
                  }`}
                >
                  <Avatar className="h-6 w-6">
                    <AvatarFallback className="bg-slate-200 text-slate-700 text-xs">
                      {channel.name.charAt(0)}
                    </AvatarFallback>
                  </Avatar>
                  <span className="flex-1 text-left text-sm truncate">{channel.name}</span>
                  {channel.unread > 0 && (
                    <Badge className="bg-red-500 text-white text-xs px-1.5 py-0">
                      {channel.unread}
                    </Badge>
                  )}
                </button>
              ))}
          </div>
        </CardContent>
      </Card>

      {/* Main Chat Area */}
      <Card className="flex-1 flex flex-col">
        {activeChannel ? (
          <>
            {/* Chat Header */}
            <CardHeader className="border-b">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center">
                    {activeChannel.icon && React.createElement(activeChannel.icon, { className: "w-5 h-5 text-indigo-600 dark:text-indigo-400" })}
                  </div>
                  <div>
                    <h3 className="font-semibold text-slate-900 dark:text-white">
                      {activeChannel.name}
                    </h3>
                    <p className="text-xs text-slate-500">
                      {activeChannel.type === 'transaction' && 'Transaction Channel'}
                      {activeChannel.type === 'direct' && 'Direct Message'}
                      {activeChannel.type === 'all_team' && 'Broadcast to All Team Members'}
                      {activeChannel.type === 'general' && 'Team Channel'}
                    </p>
                  </div>
                </div>
              </div>
            </CardHeader>

            {/* Messages */}
            <CardContent className="flex-1 overflow-y-auto p-4 space-y-2">
              {filteredMessages.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-full text-center">
                  <MessageSquare className="w-16 h-16 text-slate-300 mb-4" />
                  <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
                    No messages yet
                  </h3>
                  <p className="text-slate-600 dark:text-slate-400">
                    Start the conversation by sending a message below
                  </p>
                </div>
              ) : (
                <>
                  {filteredMessages.map(renderMessage)}
                  <div ref={messagesEndRef} />
                </>
              )}
            </CardContent>

            {/* Message Input */}
            <div className="border-t p-4">
              {replyTo && (
                <div className="mb-2 p-2 bg-slate-100 dark:bg-slate-800 rounded-lg flex items-center justify-between">
                  <div className="text-xs">
                    <span className="text-slate-600 dark:text-slate-400">Replying to </span>
                    <span className="font-semibold">
                      {teamMembers.find(m => m.id === replyTo.sender_id)?.full_name}
                    </span>
                  </div>
                  <button onClick={() => setReplyTo(null)} className="text-slate-500 hover:text-slate-700">
                    <X className="w-4 h-4" />
                  </button>
                </div>
              )}

              {attachments.length > 0 && (
                <div className="mb-2 flex flex-wrap gap-2">
                  {attachments.map((file, idx) => (
                    <div
                      key={idx}
                      className="flex items-center gap-2 px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm"
                    >
                      <File className="w-4 h-4" />
                      <span className="truncate max-w-[200px]">{file.name}</span>
                      <button
                        onClick={() => setAttachments(prev => prev.filter((_, i) => i !== idx))}
                        className="text-slate-500 hover:text-red-600"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                </div>
              )}

              <div className="flex items-end gap-2">
                <div className="flex-1">
                  <Textarea
                    value={messageContent}
                    onChange={(e) => setMessageContent(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                      }
                    }}
                    placeholder="Type a message... (@mention someone)"
                    className="resize-none"
                    rows={3}
                  />
                </div>

                <div className="flex flex-col gap-2">
                  <input
                    ref={fileInputRef}
                    type="file"
                    multiple
                    onChange={handleFileUpload}
                    className="hidden"
                  />
                  <Button
                    variant="outline"
                    size="icon"
                    onClick={() => fileInputRef.current?.click()}
                    disabled={isUploading}
                  >
                    {isUploading ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <Paperclip className="w-4 h-4" />
                    )}
                  </Button>
                  <Button
                    onClick={handleSendMessage}
                    disabled={!messageContent.trim() && attachments.length === 0}
                    className="bg-indigo-600 hover:bg-indigo-700"
                  >
                    <Send className="w-4 h-4" />
                  </Button>
                </div>
              </div>

              <p className="text-xs text-slate-500 mt-2">
                Press Enter to send ‚Ä¢ Shift + Enter for new line ‚Ä¢ @mention to notify team members
              </p>
            </div>
          </>
        ) : (
          <div className="flex items-center justify-center h-full">
            <div className="text-center">
              <MessageSquare className="w-16 h-16 text-slate-300 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
                Select a channel
              </h3>
              <p className="text-slate-600 dark:text-slate-400">
                Choose a transaction channel or direct message to start chatting
              </p>
            </div>
          </div>
        )}
      </Card>
    </div>
  );
}
import React, { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Users, CheckSquare, BarChart3, MessageSquare } from 'lucide-react';

import SharedTasksPanel from '@/components/collaboration/SharedTasksPanel';
import TeamPerformanceDashboard from '@/components/collaboration/TeamPerformanceDashboard';
import TeamMessagingPanel from '@/components/collaboration/TeamMessagingPanel';

export default function TeamCollaboration() {
    const [activeTab, setActiveTab] = useState('tasks');

    const { data: currentUser } = useQuery({
        queryKey: ['currentUser'],
        queryFn: () => base44.auth.me()
    });

    const { data: teamMembers = [] } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: () => base44.entities.TeamMember.list()
    });

    const { data: users = [] } = useQuery({
        queryKey: ['users'],
        queryFn: () => base44.entities.User.list()
    });

    const { data: tasks = [] } = useQuery({
        queryKey: ['tasks'],
        queryFn: () => base44.entities.Task.list()
    });

    const { data: transactions = [] } = useQuery({
        queryKey: ['transactions'],
        queryFn: () => base44.entities.Transaction.list()
    });

    const { data: leads = [] } = useQuery({
        queryKey: ['leads'],
        queryFn: () => base44.entities.Lead.list()
    });

    const { data: messages = [] } = useQuery({
        queryKey: ['teamMessages'],
        queryFn: () => base44.entities.Message.list(),
        refetchInterval: 5000
    });

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
            <div className="max-w-7xl mx-auto">
                {/* Header */}
                <div className="bg-gradient-to-r from-indigo-600 to-purple-700 rounded-2xl p-6 mb-6 text-white">
                    <div className="flex items-center gap-3 mb-2">
                        <Users className="w-8 h-8" />
                        <h1 className="text-2xl font-bold">Team Collaboration Hub</h1>
                    </div>
                    <p className="text-white/80">Manage tasks, track performance, and communicate with your team</p>
                </div>

                {/* Tabs */}
                <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
                    <TabsList className="bg-white dark:bg-slate-800 p-1 rounded-xl shadow-lg">
                        <TabsTrigger value="tasks" className="flex items-center gap-2 px-6 py-3 rounded-lg data-[state=active]:bg-indigo-600 data-[state=active]:text-white">
                            <CheckSquare className="w-4 h-4" />
                            Shared Tasks
                        </TabsTrigger>
                        <TabsTrigger value="performance" className="flex items-center gap-2 px-6 py-3 rounded-lg data-[state=active]:bg-indigo-600 data-[state=active]:text-white">
                            <BarChart3 className="w-4 h-4" />
                            Team Performance
                        </TabsTrigger>
                        <TabsTrigger value="messaging" className="flex items-center gap-2 px-6 py-3 rounded-lg data-[state=active]:bg-indigo-600 data-[state=active]:text-white">
                            <MessageSquare className="w-4 h-4" />
                            Team Messaging
                        </TabsTrigger>
                    </TabsList>

                    <TabsContent value="tasks">
                        <SharedTasksPanel 
                            tasks={tasks} 
                            users={users} 
                            teamMembers={teamMembers}
                            currentUser={currentUser}
                        />
                    </TabsContent>

                    <TabsContent value="performance">
                        <TeamPerformanceDashboard 
                            teamMembers={teamMembers}
                            users={users}
                            tasks={tasks}
                            transactions={transactions}
                            leads={leads}
                        />
                    </TabsContent>

                    <TabsContent value="messaging">
                        <TeamMessagingPanel 
                            messages={messages}
                            users={users}
                            teamMembers={teamMembers}
                            currentUser={currentUser}
                        />
                    </TabsContent>
                </Tabs>
            </div>
        </div>
    );
}
import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import ReactMarkdown from 'react-markdown';
import { formatDistanceToNow } from 'date-fns';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';

import TeamMemberCard from '../components/team/TeamMemberCard';
import TeamMemberModal from '../components/settings/TeamMemberModal';
import AIAnalysisModal from '../components/team/AIAnalysisModal';
import SharedTasksPanel from '@/components/collaboration/SharedTasksPanel';
import TeamPerformanceDashboard from '@/components/collaboration/TeamPerformanceDashboard';
import TeamMessagingPanel from '@/components/collaboration/TeamMessagingPanel';
import TeamChatPanel from '@/components/collaboration/TeamChatPanel';
import SetGoalModal from '../components/goals/SetGoalModal';
import GoalProgressChart from '../components/goals/GoalProgressChart';

import { 
    Users, Plus, BrainCircuit, DollarSign, Briefcase, Activity, Search, ListFilter, 
    Loader2, AlertTriangle, Target, TrendingUp, TrendingDown, Calendar, Edit, Trash2,
    CheckSquare, BarChart3, MessageSquare, ClipboardList, RefreshCw
} from 'lucide-react';

export default function TeamHub() {
    const queryClient = useQueryClient();
    const [activeTab, setActiveTab] = useState('members');
    
    // Members tab state
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingMember, setEditingMember] = useState(null);
    const [searchQuery, setSearchQuery] = useState('');
    const [sortBy, setSortBy] = useState("revenue_desc");
    const [roleFilter, setRoleFilter] = useState('all');
    const [showAIAnalysis, setShowAIAnalysis] = useState(false);
    const [selectedMemberForAdvice, setSelectedMemberForAdvice] = useState(null);
    
    // Goals tab state
    const [selectedGoal, setSelectedGoal] = useState(null);
    const [showGoalModal, setShowGoalModal] = useState(false);
    const [selectedPeriod, setSelectedPeriod] = useState('monthly');
    const [isSettingOwnGoal, setIsSettingOwnGoal] = useState(false);
    
    // Survey tab state
    const [surveyFormData, setSurveyFormData] = useState({
        tools_used: '',
        tools_advised: '',
        complaints_or_advice: ''
    });
    const [surveyId, setSurveyId] = useState(null);
    
    // Diagnose tab state
    const [analysis, setAnalysis] = useState(null);
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [progress, setProgress] = useState(0);

    const playClickSound = () => {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAo=');
        audio.volume = 0.4;
        audio.play().catch(() => {});
    };

    // Data queries
    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me()
    });

    const { data: teamMembers = [], isLoading: isLoadingMembers } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: async () => {
            try {
                return await base44.entities.TeamMember.list() || [];
            } catch (error) {
                console.error('Error loading team members:', error);
                return [];
            }
        },
    });

    const { data: users = [] } = useQuery({
        queryKey: ['users'],
        queryFn: async () => {
            try {
                return await base44.entities.User.list() || [];
            } catch (error) {
                return [];
            }
        }
    });

    const { data: transactions = [], isLoading: isLoadingTransactions } = useQuery({
        queryKey: ['transactions', user?.id],
        queryFn: async () => {
            try {
                const [listing, selling] = await Promise.all([
                    base44.entities.Transaction.filter({ listing_agent_id: user.id }).catch(() => []),
                    base44.entities.Transaction.filter({ selling_agent_id: user.id }).catch(() => [])
                ]);
                const combined = [...listing, ...selling];
                return Array.from(new Map(combined.map(item => [item.id, item])).values());
            } catch (error) {
                return [];
            }
        },
        enabled: !!user?.id
    });

    const { data: properties = [] } = useQuery({
        queryKey: ['properties', user?.id],
        queryFn: async () => {
            try {
                const [listing, created] = await Promise.all([
                    base44.entities.Property.filter({ listing_agent_id: user.id }).catch(() => []),
                    base44.entities.Property.filter({ created_by: user.email }).catch(() => [])
                ]);
                const combined = [...listing, ...created];
                return Array.from(new Map(combined.map(item => [item.id, item])).values());
            } catch (error) {
                return [];
            }
        },
        enabled: !!user?.id
    });

    const { data: leads = [] } = useQuery({
        queryKey: ['leads', user?.id],
        queryFn: async () => {
            try {
                const [owned, assigned, created] = await Promise.all([
                    base44.entities.Lead.filter({ owner_id: user.id }).catch(() => []),
                    base44.entities.Lead.filter({ assigned_agent_id: user.id }).catch(() => []),
                    base44.entities.Lead.filter({ created_by: user.email }).catch(() => [])
                ]);
                const combined = [...owned, ...assigned, ...created];
                return Array.from(new Map(combined.map(item => [item.id, item])).values());
            } catch (error) {
                return [];
            }
        },
        enabled: !!user?.id
    });

    const { data: leadActivities = [] } = useQuery({
        queryKey: ['leadActivities', user?.id],
        queryFn: async () => {
            try {
                return await base44.entities.LeadActivity.filter({ user_id: user.id }) || [];
            } catch (error) {
                return [];
            }
        },
        enabled: !!user?.id
    });

    const { data: tasks = [] } = useQuery({
        queryKey: ['tasks', user?.id],
        queryFn: () => base44.entities.Task.filter({ assigned_to: user.id }),
        enabled: !!user?.id
    });

    const { data: messages = [] } = useQuery({
        queryKey: ['teamMessages', user?.id],
        queryFn: async () => {
            const [sent, received] = await Promise.all([
                base44.entities.Message.filter({ sender_id: user.id }).catch(() => []),
                base44.entities.Message.filter({ recipient_id: user.id }).catch(() => [])
            ]);
            const combined = [...sent, ...received];
            return Array.from(new Map(combined.map(item => [item.id, item])).values());
        },
        enabled: !!user?.id,
        refetchInterval: 5000
    });

    const { data: goals = [], isLoading: isLoadingGoals } = useQuery({
        queryKey: ['performanceGoals'],
        queryFn: async () => {
            try {
                return await base44.entities.PerformanceGoal.list() || [];
            } catch (error) {
                return [];
            }
        }
    });

    const { data: existingSurvey } = useQuery({
        queryKey: ['teamSurvey', user?.id],
        queryFn: async () => {
            if (!user) return null;
            const surveys = await base44.entities.TeamSurvey.filter({ user_id: user.id });
            const sortedSurveys = (surveys || []).sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
            if (sortedSurveys[0]) {
                setSurveyFormData({
                    tools_used: sortedSurveys[0].tools_used || '',
                    tools_advised: sortedSurveys[0].tools_advised || '',
                    complaints_or_advice: sortedSurveys[0].complaints_or_advice || ''
                });
                setSurveyId(sortedSurveys[0].id);
            }
            return sortedSurveys[0] || null;
        },
        enabled: !!user
    });

    const { data: allSurveyResults = [] } = useQuery({
        queryKey: ['allTeamSurveys'],
        queryFn: () => base44.entities.TeamSurvey.list('-created_date')
    });

    const isLoading = isLoadingMembers || isLoadingTransactions;

    // Performance calculations
    const memberPerformanceData = useMemo(() => {
        if (!teamMembers || teamMembers.length === 0) {
            return { teamStats: { totalRevenue: 0, totalDeals: 0, activeMembers: 0, totalActivities: 0, totalLeads: 0, totalProperties: 0 }, enrichedMembers: [] };
        }

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const enrichedMembers = teamMembers.map(member => {
            const memberTransactions = transactions.filter(t => {
                try {
                    if (t.notes) {
                        const notes = JSON.parse(t.notes);
                        if (notes.listing_team_member_id === member.id || notes.selling_team_member_id === member.id) return true;
                    }
                } catch (e) {}
                if (t.selling_agent_name && t.selling_agent_name === member.full_name) return true;
                return false;
            });

            const memberProperties = properties.filter(p => p.tags && p.tags.includes(`listing_agent:${member.id}`));
            const memberLeads = leads.filter(l => l.notes && l.notes.includes(member.id));

            let revenue = 0;
            memberTransactions.forEach(t => {
                try {
                    if (t.notes) {
                        const notes = JSON.parse(t.notes);
                        if (notes.listing_team_member_id === member.id) revenue += (t.listing_net_commission || 0);
                        if (notes.selling_team_member_id === member.id) revenue += (t.selling_net_commission || 0);
                    } else if (t.selling_agent_name === member.full_name) {
                        revenue += (t.selling_net_commission || 0);
                    }
                } catch (e) {}
            });

            const activities = leadActivities.filter(a => a.description && a.description.toLowerCase().includes(member.full_name.toLowerCase())).length;
            const hasRecentActivity = leadActivities.some(a => a.description && a.description.toLowerCase().includes(member.full_name.toLowerCase()) && new Date(a.created_date) > thirtyDaysAgo);
            const isInactive = !hasRecentActivity && memberTransactions.length === 0;

            return {
                ...member,
                revenue,
                deals: memberTransactions.length,
                properties: memberProperties.length,
                leads: memberLeads.length,
                activities,
                isInactive,
                transactions: memberTransactions,
            };
        });

        const teamStats = {
            totalRevenue: enrichedMembers.reduce((sum, m) => sum + m.revenue, 0),
            totalDeals: enrichedMembers.reduce((sum, m) => sum + m.deals, 0),
            activeMembers: enrichedMembers.filter(m => !m.isInactive).length,
            totalActivities: enrichedMembers.reduce((sum, m) => sum + m.activities, 0),
            totalLeads: enrichedMembers.reduce((sum, m) => sum + m.leads, 0),
            totalProperties: enrichedMembers.reduce((sum, m) => sum + m.properties, 0),
        };

        return { teamStats, enrichedMembers };
    }, [teamMembers, transactions, properties, leads, leadActivities]);

    const { enrichedMembers, teamStats } = memberPerformanceData;

    const filteredMembers = useMemo(() => {
        return enrichedMembers.filter(member => {
            const matchesSearch = !searchQuery || member.full_name?.toLowerCase().includes(searchQuery.toLowerCase()) || member.email?.toLowerCase().includes(searchQuery.toLowerCase());
            const matchesRole = roleFilter === 'all' || member.role === roleFilter;
            return matchesSearch && matchesRole;
        });
    }, [enrichedMembers, searchQuery, roleFilter]);

    const sortedMembers = useMemo(() => {
        const sortableMembers = [...filteredMembers];
        sortableMembers.sort((a, b) => {
            switch (sortBy) {
                case 'name_asc': return (a.full_name || '').localeCompare(b.full_name || '');
                case 'revenue_desc': return (b.revenue || 0) - (a.revenue || 0);
                case 'deals_desc': return (b.deals || 0) - (a.deals || 0);
                case 'activity_desc': return (b.activities || 0) - (a.activities || 0);
                default: return 0;
            }
        });
        return sortableMembers;
    }, [filteredMembers, sortBy]);

    // Goals calculations
    const filteredGoals = useMemo(() => goals.filter(g => g.period_type === selectedPeriod), [goals, selectedPeriod]);
    const goalStats = useMemo(() => {
        const activeGoals = filteredGoals.filter(g => g.status !== 'completed');
        return {
            total: activeGoals.length,
            onTrack: activeGoals.filter(g => g.status === 'on_track' || g.status === 'exceeded').length,
            atRisk: activeGoals.filter(g => g.status === 'at_risk').length,
            behind: activeGoals.filter(g => g.status === 'behind').length
        };
    }, [filteredGoals]);

    // My Goals - check both team member ID and user ID
    const myGoals = useMemo(() => {
        if (!user) return [];
        
        // Try to find matching team member
        const myTeamMember = teamMembers.find(m => m.email === user.email);
        
        // Filter goals that belong to current user (by team member ID, user ID, or created_by email)
        return goals.filter(g => {
            if (myTeamMember && g.agent_id === myTeamMember.id) return true;
            if (g.agent_id === user.id) return true;
            if (g.created_by === user.email && g.agent_name === user.full_name) return true;
            return false;
        });
    }, [goals, teamMembers, user]);

    const currentGoal = useMemo(() => {
        const now = new Date();
        return myGoals.find(g => {
            const end = new Date(g.period_end);
            return end >= now && g.status !== 'completed';
        });
    }, [myGoals]);

    // Mutations
    const saveMemberMutation = useMutation({
        mutationFn: async (memberData) => {
            if (editingMember) {
                return await base44.entities.TeamMember.update(editingMember.id, memberData);
            } else {
                return await base44.entities.TeamMember.create(memberData);
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['teamMembers'] });
            toast.success(`Team member ${editingMember ? 'updated' : 'added'} successfully!`);
            setIsModalOpen(false);
            setEditingMember(null);
        },
        onError: (error) => toast.error(`Failed to save team member: ${error.message}`)
    });

    const deleteMemberMutation = useMutation({
        mutationFn: (id) => base44.entities.TeamMember.delete(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['teamMembers'] });
            toast.success('Team member removed successfully!');
        },
        onError: (error) => toast.error(`Failed to remove team member: ${error.message}`)
    });

    const removeDuplicatesMutation = useMutation({
        mutationFn: async () => {
            const uniqueMap = new Map();
            const duplicatesToDelete = [];

            teamMembers.forEach(member => {
                const email = member.email?.toLowerCase().trim() || '';
                const name = member.full_name?.toLowerCase().trim() || '';
                
                // Create composite key from both email and name
                const key = `${email}|||${name}`;
                
                if (uniqueMap.has(key)) {
                    const existing = uniqueMap.get(key);
                    const existingDate = new Date(existing.created_date || 0);
                    const currentDate = new Date(member.created_date || 0);
                    
                    // Keep the older record (first created)
                    if (currentDate < existingDate) {
                        duplicatesToDelete.push(existing.id);
                        uniqueMap.set(key, member);
                    } else {
                        duplicatesToDelete.push(member.id);
                    }
                } else {
                    // Also check for email-only match or name-only match
                    let isDuplicate = false;
                    
                    for (const [existingKey, existingMember] of uniqueMap.entries()) {
                        const [existingEmail, existingName] = existingKey.split('|||');
                        
                        // Match if either email or full name matches
                        if ((email && existingEmail && email === existingEmail) || 
                            (name && existingName && name === existingName)) {
                            isDuplicate = true;
                            
                            const existingDate = new Date(existingMember.created_date || 0);
                            const currentDate = new Date(member.created_date || 0);
                            
                            if (currentDate < existingDate) {
                                duplicatesToDelete.push(existingMember.id);
                                uniqueMap.delete(existingKey);
                                uniqueMap.set(key, member);
                            } else {
                                duplicatesToDelete.push(member.id);
                            }
                            break;
                        }
                    }
                    
                    if (!isDuplicate) {
                        uniqueMap.set(key, member);
                    }
                }
            });

            if (duplicatesToDelete.length === 0) {
                return { deleted: 0 };
            }

            await Promise.all(duplicatesToDelete.map(id => base44.entities.TeamMember.delete(id)));
            return { deleted: duplicatesToDelete.length };
        },
        onSuccess: ({ deleted }) => {
            queryClient.invalidateQueries({ queryKey: ['teamMembers'] });
            if (deleted > 0) {
                toast.success(`Removed ${deleted} duplicate team member${deleted > 1 ? 's' : ''}!`);
            } else {
                toast.info('No duplicates found!');
            }
        },
        onError: (error) => toast.error(`Failed to remove duplicates: ${error.message}`)
    });

    const deleteGoalMutation = useMutation({
        mutationFn: (id) => base44.entities.PerformanceGoal.delete(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['performanceGoals'] });
            toast.success('Goal deleted successfully');
        },
        onError: (error) => toast.error(`Failed to delete goal: ${error.message}`)
    });

    const surveyMutation = useMutation({
        mutationFn: async (surveyData) => {
            const payload = { ...surveyData, user_id: user.id, user_name: user.full_name };
            if (surveyId) {
                return base44.entities.TeamSurvey.update(surveyId, payload);
            } else {
                return base44.entities.TeamSurvey.create(payload);
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['teamSurvey', user.id] });
            toast.success('Thank you! Your feedback has been submitted successfully.');
        },
        onError: () => toast.error('There was an error submitting your feedback. Please try again.')
    });

    // Handlers
    const handleEdit = (member) => { setEditingMember(member); setIsModalOpen(true); };
    const handleDelete = (member) => { if (confirm(`Are you sure you want to remove ${member.full_name}?`)) deleteMemberMutation.mutate(member.id); };
    const handleGetAIAdvice = (member) => { setSelectedMemberForAdvice(member); setShowAIAnalysis(true); };

    const getStatusColor = (status) => {
        const colors = {
            on_track: 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300',
            exceeded: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300',
            at_risk: 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300',
            behind: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300',
            completed: 'bg-slate-100 text-slate-700 border-slate-200 dark:bg-slate-800/30 dark:text-slate-300'
        };
        return colors[status] || colors.on_track;
    };

    const getProgressPercentage = (current, goal) => {
        if (!goal || goal === 0) return 0;
        return Math.min(Math.round((current / goal) * 100), 100);
    };

    const runAnalysis = async () => {
        setIsAnalyzing(true);
        setAnalysis(null);
        setProgress(0);
        
        playClickSound();

        // Animate progress from 0 to 90%
        const progressInterval = setInterval(() => {
            setProgress(prev => {
                if (prev >= 90) return 90;
                return prev + 2;
            });
        }, 200);
        
        try {
            const performanceData = enrichedMembers.map(m => ({
                name: m.full_name, role: m.role, deals: m.deals, revenue: m.revenue,
                activities: m.activities, properties: m.properties, leads: m.leads,
                conversion_rate: m.leads > 0 ? ((m.deals / m.leads) * 100).toFixed(1) : 0
            }));

            const prompt = `As an expert real estate brokerage consultant, analyze this team's performance:

**TEAM OVERVIEW:**
- Total Team Members: ${teamMembers.length}
- Total Revenue: $${teamStats.totalRevenue.toLocaleString()}
- Total Deals: ${teamStats.totalDeals}

**INDIVIDUAL PERFORMANCE:**
${performanceData.map((a, i) => `${i + 1}. **${a.name}** (${a.role}) - Revenue: $${a.revenue.toLocaleString()}, Deals: ${a.deals}, Activities: ${a.activities}`).join('\n')}

Provide:
### 1. Overall Team Health
### 2. Top Performers
### 3. Agents Needing Support
### 4. Performance Gaps
### 5. Actionable Recommendations (5-7 items)
### 6. Key Metrics to Monitor`;

            const response = await base44.integrations.Core.InvokeLLM({ prompt, add_context_from_internet: false });
            
            clearInterval(progressInterval);
            setProgress(100);
            
            setAnalysis(response);
        } catch (error) {
            clearInterval(progressInterval);
            setAnalysis("**Analysis Failed**\n\nUnable to generate analysis. Please try again.");
        } finally {
            setIsAnalyzing(false);
            setProgress(0);
        }
    };

    if (isLoading) {
        return (
            <div className="page-container flex items-center justify-center min-h-[400px]">
                <div className="text-center">
                    <Loader2 className="w-8 h-8 animate-spin mx-auto mb-4 text-indigo-600" />
                    <p className="text-slate-600">Loading team data...</p>
                </div>
            </div>
        );
    }

    return (
        <div className="page-container space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-indigo-600 to-purple-700 rounded-2xl p-6 text-white">
                <div className="flex items-center gap-3 mb-2">
                    <Users className="w-8 h-8" />
                    <h1 className="text-2xl font-bold">Team Hub</h1>
                </div>
                <p className="text-white/80">Manage members, track goals, collaborate, and analyze team performance</p>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <div className="bg-white/10 rounded-lg p-3">
                        <p className="text-white/70 text-sm">Members</p>
                        <p className="text-2xl font-bold">{teamMembers.length}</p>
                    </div>
                    <div className="bg-white/10 rounded-lg p-3">
                        <p className="text-white/70 text-sm">Revenue</p>
                        <p className="text-2xl font-bold">${(teamStats.totalRevenue / 1000).toFixed(0)}k</p>
                    </div>
                    <div className="bg-white/10 rounded-lg p-3">
                        <p className="text-white/70 text-sm">Deals</p>
                        <p className="text-2xl font-bold">{teamStats.totalDeals}</p>
                    </div>
                    <div className="bg-white/10 rounded-lg p-3">
                        <p className="text-white/70 text-sm">Active Goals</p>
                        <p className="text-2xl font-bold">{goalStats.total}</p>
                    </div>
                </div>
            </div>

            {/* Tabs */}
            <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
                <TabsList className="bg-white dark:bg-slate-800 p-1 rounded-xl shadow-lg flex-wrap h-auto">
                    <TabsTrigger value="members" className="flex items-center gap-2 px-4 py-2 rounded-lg data-[state=active]:bg-indigo-600 data-[state=active]:text-white">
                        <Users className="w-4 h-4" />
                        Members
                    </TabsTrigger>
                    <TabsTrigger value="collaboration" className="flex items-center gap-2 px-4 py-2 rounded-lg data-[state=active]:bg-indigo-600 data-[state=active]:text-white">
                        <MessageSquare className="w-4 h-4" />
                        Collaboration
                    </TabsTrigger>
                    <TabsTrigger value="goals" className="flex items-center gap-2 px-4 py-2 rounded-lg data-[state=active]:bg-indigo-600 data-[state=active]:text-white">
                        <Target className="w-4 h-4" />
                        Goals
                    </TabsTrigger>
                    <TabsTrigger value="mygoals" className="flex items-center gap-2 px-4 py-2 rounded-lg data-[state=active]:bg-indigo-600 data-[state=active]:text-white">
                        <TrendingUp className="w-4 h-4" />
                        My Goals
                    </TabsTrigger>
                    <TabsTrigger value="survey" className="flex items-center gap-2 px-4 py-2 rounded-lg data-[state=active]:bg-indigo-600 data-[state=active]:text-white">
                        <ClipboardList className="w-4 h-4" />
                        Survey
                    </TabsTrigger>
                    <TabsTrigger value="diagnose" className="flex items-center gap-2 px-4 py-2 rounded-lg data-[state=active]:bg-indigo-600 data-[state=active]:text-white">
                        <BrainCircuit className="w-4 h-4" />
                        AI Diagnose
                    </TabsTrigger>
                </TabsList>

                {/* Members Tab */}
                <TabsContent value="members" className="space-y-6">
                    <Card>
                        <CardContent className="p-4">
                            <div className="flex flex-col md:flex-row gap-4 justify-between">
                                <div className="relative flex-grow">
                                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" />
                                    <Input placeholder="Search team members..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="pl-10" />
                                </div>
                                <div className="flex items-center gap-2 flex-wrap">
                                    <Select value={sortBy} onValueChange={setSortBy}>
                                        <SelectTrigger className="w-[140px]"><SelectValue placeholder="Sort by" /></SelectTrigger>
                                        <SelectContent>
                                            <SelectItem value="revenue_desc">Revenue</SelectItem>
                                            <SelectItem value="deals_desc">Deals</SelectItem>
                                            <SelectItem value="activity_desc">Activity</SelectItem>
                                            <SelectItem value="name_asc">Name (A-Z)</SelectItem>
                                        </SelectContent>
                                    </Select>
                                    <Select value={roleFilter} onValueChange={setRoleFilter}>
                                        <SelectTrigger className="w-[140px]"><SelectValue placeholder="Role" /></SelectTrigger>
                                        <SelectContent>
                                            <SelectItem value="all">All Roles</SelectItem>
                                            <SelectItem value="listing_agent">Listing Agent</SelectItem>
                                            <SelectItem value="selling_agent">Selling Agent</SelectItem>
                                            <SelectItem value="broker">Broker</SelectItem>
                                            <SelectItem value="admin">Administrator</SelectItem>
                                        </SelectContent>
                                    </Select>
                                    <Button onClick={() => removeDuplicatesMutation.mutate()} variant="outline" disabled={removeDuplicatesMutation.isLoading}>
                                        {removeDuplicatesMutation.isLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Trash2 className="w-4 h-4 mr-2" />}
                                        Remove Duplicates
                                    </Button>
                                    <Button onClick={() => { setEditingMember(null); setIsModalOpen(true); }}>
                                        <Plus className="w-4 h-4 mr-2" /> Add Member
                                    </Button>
                                </div>
                            </div>
                        </CardContent>
                    </Card>
                    
                    {sortedMembers.length > 0 ? (
                        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                            {sortedMembers.map(member => (
                                <TeamMemberCard key={member.id} member={member} onEdit={() => handleEdit(member)} onDelete={() => handleDelete(member)} onGetAIAdvice={() => handleGetAIAdvice(member)} />
                            ))}
                        </div>
                    ) : (
                        <Card>
                            <CardContent className="p-12 text-center">
                                <Users className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                                <h3 className="text-lg font-semibold mb-2">No team members found</h3>
                                <Button onClick={() => setIsModalOpen(true)}><Plus className="w-4 h-4 mr-2" />Add Your First Team Member</Button>
                            </CardContent>
                        </Card>
                    )}
                </TabsContent>

                {/* Collaboration Tab */}
                <TabsContent value="collaboration">
                    <Tabs defaultValue="chat" className="space-y-4">
                        <TabsList>
                            <TabsTrigger value="chat"><MessageSquare className="w-4 h-4 mr-2" />Team Chat</TabsTrigger>
                            <TabsTrigger value="tasks"><CheckSquare className="w-4 h-4 mr-2" />Shared Tasks</TabsTrigger>
                            <TabsTrigger value="performance"><BarChart3 className="w-4 h-4 mr-2" />Performance</TabsTrigger>
                            <TabsTrigger value="messaging"><MessageSquare className="w-4 h-4 mr-2" />Messaging</TabsTrigger>
                        </TabsList>
                        <TabsContent value="chat"><TeamChatPanel transactions={transactions} properties={properties} teamMembers={users} currentUser={user} /></TabsContent>
                        <TabsContent value="tasks"><SharedTasksPanel tasks={tasks} users={users} teamMembers={teamMembers} currentUser={user} /></TabsContent>
                        <TabsContent value="performance"><TeamPerformanceDashboard teamMembers={teamMembers} users={users} tasks={tasks} transactions={transactions} leads={leads} /></TabsContent>
                        <TabsContent value="messaging"><TeamMessagingPanel messages={messages} users={users} teamMembers={teamMembers} currentUser={user} /></TabsContent>
                    </Tabs>
                </TabsContent>

                {/* Goals Tab */}
                <TabsContent value="goals" className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div className="flex gap-2">
                            {['monthly', 'quarterly', 'annual'].map(period => (
                                <Button key={period} variant={selectedPeriod === period ? 'default' : 'outline'} onClick={() => setSelectedPeriod(period)} size="sm">
                                    <Calendar className="w-4 h-4 mr-2" />{period.charAt(0).toUpperCase() + period.slice(1)}
                                </Button>
                            ))}
                        </div>
                        <Button onClick={() => { setSelectedGoal(null); setShowGoalModal(true); setIsSettingOwnGoal(false); }}><Plus className="w-4 h-4 mr-2" />Set New Goal</Button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <Card><CardContent className="p-6"><div className="flex items-center justify-between"><div><p className="text-sm text-slate-500">Total Goals</p><p className="text-2xl font-bold">{goalStats.total}</p></div><Target className="w-8 h-8 text-indigo-500" /></div></CardContent></Card>
                        <Card><CardContent className="p-6"><div className="flex items-center justify-between"><div><p className="text-sm text-slate-500">On Track</p><p className="text-2xl font-bold text-green-600">{goalStats.onTrack}</p></div><TrendingUp className="w-8 h-8 text-green-500" /></div></CardContent></Card>
                        <Card><CardContent className="p-6"><div className="flex items-center justify-between"><div><p className="text-sm text-slate-500">At Risk</p><p className="text-2xl font-bold text-yellow-600">{goalStats.atRisk}</p></div><AlertTriangle className="w-8 h-8 text-yellow-500" /></div></CardContent></Card>
                        <Card><CardContent className="p-6"><div className="flex items-center justify-between"><div><p className="text-sm text-slate-500">Behind</p><p className="text-2xl font-bold text-red-600">{goalStats.behind}</p></div><TrendingDown className="w-8 h-8 text-red-500" /></div></CardContent></Card>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {filteredGoals.map(goal => (
                            <Card key={goal.id}>
                                <CardHeader>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <CardTitle className="text-xl">{goal.agent_name}</CardTitle>
                                            <p className="text-sm text-slate-500">{new Date(goal.period_start).toLocaleDateString()} - {new Date(goal.period_end).toLocaleDateString()}</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <Badge className={getStatusColor(goal.status)}>{goal.status.replace('_', ' ').toUpperCase()}</Badge>
                                            <Button variant="ghost" size="icon" onClick={() => { setSelectedGoal(goal); setShowGoalModal(true); }}><Edit className="w-4 h-4" /></Button>
                                            <Button variant="ghost" size="icon" onClick={() => deleteGoalMutation.mutate(goal.id)} className="text-red-600"><Trash2 className="w-4 h-4" /></Button>
                                        </div>
                                    </div>
                                </CardHeader>
                                <CardContent className="space-y-4">
                                    {goal.revenue_goal > 0 && (
                                        <div>
                                            <div className="flex justify-between text-sm mb-2"><span className="flex items-center gap-2"><DollarSign className="w-4 h-4 text-green-500" />Revenue</span><span className="font-semibold">${(goal.current_revenue || 0).toLocaleString()} / ${goal.revenue_goal.toLocaleString()}</span></div>
                                            <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2"><div className="bg-green-500 h-2 rounded-full" style={{ width: `${getProgressPercentage(goal.current_revenue, goal.revenue_goal)}%` }} /></div>
                                        </div>
                                    )}
                                    {goal.deals_goal > 0 && (
                                        <div>
                                            <div className="flex justify-between text-sm mb-2"><span className="flex items-center gap-2"><Briefcase className="w-4 h-4 text-blue-500" />Deals</span><span className="font-semibold">{goal.current_deals || 0} / {goal.deals_goal}</span></div>
                                            <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2"><div className="bg-blue-500 h-2 rounded-full" style={{ width: `${getProgressPercentage(goal.current_deals, goal.deals_goal)}%` }} /></div>
                                        </div>
                                    )}
                                </CardContent>
                            </Card>
                        ))}
                    </div>

                    {filteredGoals.length === 0 && (
                        <Card><CardContent className="p-12 text-center"><Target className="w-16 h-16 mx-auto text-slate-300 mb-4" /><h3 className="text-lg font-semibold mb-2">No Goals Set</h3><Button onClick={() => setShowGoalModal(true)}><Plus className="w-4 h-4 mr-2" />Set Your First Goal</Button></CardContent></Card>
                    )}
                </TabsContent>

                {/* My Goals Tab */}
                <TabsContent value="mygoals" className="space-y-6">
                    {myGoals.length === 0 ? (
                        <Card><CardContent className="p-12 text-center">
                            <Target className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                            <h3 className="text-lg font-semibold mb-2">No Goals Assigned Yet</h3>
                            <p className="text-slate-500 mb-4">You don't have any performance goals assigned. You can set your own goals or ask your manager to assign them.</p>
                            <Button onClick={() => { setSelectedGoal(null); setShowGoalModal(true); setIsSettingOwnGoal(true); }}>
                                <Plus className="w-4 h-4 mr-2" />Set My Own Goal
                            </Button>
                        </CardContent></Card>
                    ) : !currentGoal ? (
                        <Card><CardContent className="p-12 text-center">
                            <Target className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                            <h3 className="text-lg font-semibold mb-2">No Active Goals</h3>
                            <p className="text-slate-500 mb-4">Your previous goals have ended. Set new goals to continue tracking your performance.</p>
                            <Button onClick={() => { setSelectedGoal(null); setShowGoalModal(true); setIsSettingOwnGoal(true); }}>
                                <Plus className="w-4 h-4 mr-2" />Set New Goal
                            </Button>
                        </CardContent></Card>
                    ) : (
                        <>
                            <div className="flex justify-between items-center">
                                <div><h2 className="text-2xl font-bold">My Performance Goals</h2><p className="text-slate-500">Track your progress towards your performance targets</p></div>
                                <Badge className={getStatusColor(currentGoal.status)}>{currentGoal.status.replace('_', ' ').toUpperCase()}</Badge>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                {currentGoal.revenue_goal > 0 && (
                                    <Card><CardContent className="p-6"><div className="flex items-center justify-between mb-4"><DollarSign className="w-8 h-8 text-green-500" /><span className="text-2xl font-bold">{getProgressPercentage(currentGoal.current_revenue, currentGoal.revenue_goal)}%</span></div><h3 className="font-semibold mb-2">Revenue</h3><p className="text-sm text-slate-600">${(currentGoal.current_revenue || 0).toLocaleString()} / ${currentGoal.revenue_goal.toLocaleString()}</p><div className="w-full bg-slate-200 rounded-full h-2 mt-2"><div className="bg-green-500 h-2 rounded-full" style={{ width: `${getProgressPercentage(currentGoal.current_revenue, currentGoal.revenue_goal)}%` }} /></div></CardContent></Card>
                                )}
                                {currentGoal.deals_goal > 0 && (
                                    <Card><CardContent className="p-6"><div className="flex items-center justify-between mb-4"><Briefcase className="w-8 h-8 text-blue-500" /><span className="text-2xl font-bold">{getProgressPercentage(currentGoal.current_deals, currentGoal.deals_goal)}%</span></div><h3 className="font-semibold mb-2">Deals Closed</h3><p className="text-sm text-slate-600">{currentGoal.current_deals || 0} / {currentGoal.deals_goal}</p><div className="w-full bg-slate-200 rounded-full h-2 mt-2"><div className="bg-blue-500 h-2 rounded-full" style={{ width: `${getProgressPercentage(currentGoal.current_deals, currentGoal.deals_goal)}%` }} /></div></CardContent></Card>
                                )}
                                {currentGoal.activities_goal > 0 && (
                                    <Card><CardContent className="p-6"><div className="flex items-center justify-between mb-4"><Activity className="w-8 h-8 text-purple-500" /><span className="text-2xl font-bold">{getProgressPercentage(currentGoal.current_activities, currentGoal.activities_goal)}%</span></div><h3 className="font-semibold mb-2">Activities</h3><p className="text-sm text-slate-600">{currentGoal.current_activities || 0} / {currentGoal.activities_goal}</p><div className="w-full bg-slate-200 rounded-full h-2 mt-2"><div className="bg-purple-500 h-2 rounded-full" style={{ width: `${getProgressPercentage(currentGoal.current_activities, currentGoal.activities_goal)}%` }} /></div></CardContent></Card>
                                )}
                                {currentGoal.leads_goal > 0 && (
                                    <Card><CardContent className="p-6"><div className="flex items-center justify-between mb-4"><Users className="w-8 h-8 text-orange-500" /><span className="text-2xl font-bold">{getProgressPercentage(currentGoal.current_leads, currentGoal.leads_goal)}%</span></div><h3 className="font-semibold mb-2">New Leads</h3><p className="text-sm text-slate-600">{currentGoal.current_leads || 0} / {currentGoal.leads_goal}</p><div className="w-full bg-slate-200 rounded-full h-2 mt-2"><div className="bg-orange-500 h-2 rounded-full" style={{ width: `${getProgressPercentage(currentGoal.current_leads, currentGoal.leads_goal)}%` }} /></div></CardContent></Card>
                                )}
                            </div>
                            <GoalProgressChart goal={currentGoal} />

                            {/* Past Goals */}
                            {myGoals.filter(g => g.id !== currentGoal?.id).length > 0 && (
                                <Card className="mt-6">
                                    <CardHeader>
                                        <CardTitle>Past & Upcoming Goals</CardTitle>
                                    </CardHeader>
                                    <CardContent>
                                        <div className="space-y-3">
                                            {myGoals.filter(g => g.id !== currentGoal?.id).map(goal => (
                                                <div key={goal.id} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                                                    <div>
                                                        <p className="font-medium">{goal.period_type.charAt(0).toUpperCase() + goal.period_type.slice(1)} Goal</p>
                                                        <p className="text-sm text-slate-500">{new Date(goal.period_start).toLocaleDateString()} - {new Date(goal.period_end).toLocaleDateString()}</p>
                                                    </div>
                                                    <Badge className={getStatusColor(goal.status)}>{goal.status.replace('_', ' ')}</Badge>
                                                </div>
                                            ))}
                                        </div>
                                    </CardContent>
                                </Card>
                            )}
                            </>
                            )}
                </TabsContent>

                {/* Survey Tab */}
                <TabsContent value="survey" className="space-y-6">
                    <Tabs defaultValue="submit" className="space-y-4">
                        <TabsList>
                            <TabsTrigger value="submit"><ClipboardList className="w-4 h-4 mr-2" />Submit Survey</TabsTrigger>
                            <TabsTrigger value="results"><BarChart3 className="w-4 h-4 mr-2" />View Results ({allSurveyResults.length})</TabsTrigger>
                        </TabsList>

                        <TabsContent value="submit">
                            <Card className="max-w-4xl mx-auto">
                                <CardHeader>
                                    <CardTitle className="text-2xl font-bold">Team Feedback & Insights Survey</CardTitle>
                                    <CardDescription>Your input is valuable for our collective growth. Please share your thoughts openly.</CardDescription>
                                </CardHeader>
                                <form onSubmit={(e) => { e.preventDefault(); surveyMutation.mutate(surveyFormData); }}>
                                    <CardContent className="space-y-6">
                                        <div className="space-y-2">
                                            <Label htmlFor="tools_used" className="text-base font-semibold">What tools, platforms, or methods do you currently use in your workflow?</Label>
                                            <Textarea id="tools_used" value={surveyFormData.tools_used} onChange={(e) => setSurveyFormData(prev => ({ ...prev, tools_used: e.target.value }))} placeholder="Describe your daily go-to's..." rows={5} />
                                        </div>
                                        <div className="space-y-2">
                                            <Label htmlFor="tools_advised" className="text-base font-semibold">What would you advise other team members to use or try?</Label>
                                            <Textarea id="tools_advised" value={surveyFormData.tools_advised} onChange={(e) => setSurveyFormData(prev => ({ ...prev, tools_advised: e.target.value }))} placeholder="Share your best recommendations..." rows={5} />
                                        </div>
                                        <div className="space-y-2">
                                            <Label htmlFor="complaints_or_advice" className="text-base font-semibold">Do you have any general complaints or advice for the group?</Label>
                                            <Textarea id="complaints_or_advice" value={surveyFormData.complaints_or_advice} onChange={(e) => setSurveyFormData(prev => ({ ...prev, complaints_or_advice: e.target.value }))} placeholder="What's on your mind?..." rows={5} />
                                        </div>
                                    </CardContent>
                                    <CardFooter className="flex justify-end">
                                        <Button type="submit" disabled={surveyMutation.isLoading}>
                                            {surveyMutation.isLoading && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                                            {surveyId ? 'Update My Feedback' : 'Submit Feedback'}
                                        </Button>
                                    </CardFooter>
                                </form>
                            </Card>
                        </TabsContent>

                        <TabsContent value="results">
                            {allSurveyResults.length > 0 ? (
                                <div className="grid gap-6 md:grid-cols-1 lg:grid-cols-2 xl:grid-cols-3">
                                    {allSurveyResults.map(survey => (
                                        <Card key={survey.id}>
                                            <CardHeader>
                                                <div className="flex items-center gap-3">
                                                    <Avatar>
                                                        <AvatarFallback>{survey.user_name ? survey.user_name.charAt(0) : 'U'}</AvatarFallback>
                                                    </Avatar>
                                                    <div>
                                                        <CardTitle className="text-lg">{survey.user_name}</CardTitle>
                                                        <CardDescription>Submitted {formatDistanceToNow(new Date(survey.created_date), { addSuffix: true })}</CardDescription>
                                                    </div>
                                                </div>
                                            </CardHeader>
                                            <CardContent className="space-y-4">
                                                <div>
                                                    <h4 className="font-semibold text-sm flex items-center gap-2 mb-2"><CheckSquare className="w-4 h-4 text-indigo-500"/>Current Tools & Methods</h4>
                                                    <p className="text-sm text-slate-600 dark:text-slate-400 p-3 bg-slate-50 dark:bg-slate-800 rounded-md">{survey.tools_used || 'No input provided.'}</p>
                                                </div>
                                                <div>
                                                    <h4 className="font-semibold text-sm flex items-center gap-2 mb-2"><Target className="w-4 h-4 text-indigo-500"/>Recommendations for Team</h4>
                                                    <p className="text-sm text-slate-600 dark:text-slate-400 p-3 bg-slate-50 dark:bg-slate-800 rounded-md">{survey.tools_advised || 'No input provided.'}</p>
                                                </div>
                                                <div>
                                                    <h4 className="font-semibold text-sm flex items-center gap-2 mb-2"><MessageSquare className="w-4 h-4 text-indigo-500"/>General Complaints or Advice</h4>
                                                    <p className="text-sm text-slate-600 dark:text-slate-400 p-3 bg-slate-50 dark:bg-slate-800 rounded-md">{survey.complaints_or_advice || 'No input provided.'}</p>
                                                </div>
                                            </CardContent>
                                        </Card>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-16 border-2 border-dashed rounded-lg">
                                    <MessageSquare className="w-12 h-12 mx-auto text-slate-300 mb-4" />
                                    <h3 className="text-xl font-semibold">No survey results yet</h3>
                                    <p className="text-slate-500 mt-2">Encourage your team to submit feedback to see the results here.</p>
                                </div>
                            )}
                        </TabsContent>
                    </Tabs>
                </TabsContent>

                {/* Diagnose Tab */}
                <TabsContent value="diagnose" className="space-y-6">
                    <Card>
                        <CardHeader>
                            <CardTitle>AI Team Performance Analyst</CardTitle>
                            <CardDescription>Click the button to analyze your team's performance data and receive detailed insights and actionable recommendations.</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <Button onClick={runAnalysis} disabled={isAnalyzing || teamMembers.length === 0}>
                                {isAnalyzing ? (<><Loader2 className="w-4 h-4 mr-2 animate-spin"/>Analyzing...</>) : (<><BrainCircuit className="w-4 h-4 mr-2"/>Run Comprehensive Analysis</>)}
                            </Button>
                            {analysis && <Button variant="ghost" onClick={runAnalysis} disabled={isAnalyzing} className="ml-2"><RefreshCw className="w-4 h-4 mr-2"/>Re-run</Button>}
                            {teamMembers.length === 0 && <p className="text-sm text-amber-600 mt-4">‚ö†Ô∏è No team members found. Please add team members first.</p>}
                        </CardContent>
                    </Card>

                    {isAnalyzing && (
                        <Card className="border-2 border-indigo-200 bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 overflow-hidden relative">
                            <div className="absolute inset-0 bg-gradient-to-r from-indigo-500/5 via-purple-500/5 to-pink-500/5 animate-pulse"></div>
                            <CardContent className="p-12 text-center relative z-10">
                                <div className="relative w-32 h-32 mx-auto mb-8">
                                    <div className="absolute inset-0 border-4 border-indigo-200 rounded-full"></div>
                                    <div className="absolute inset-0 border-4 border-transparent border-t-indigo-600 rounded-full animate-spin"></div>
                                    <div className="absolute inset-3 border-4 border-purple-200 rounded-full"></div>
                                    <div className="absolute inset-3 border-4 border-transparent border-b-purple-600 rounded-full animate-spin" style={{ animationDirection: 'reverse', animationDuration: '1.5s' }}></div>
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <div className="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg animate-pulse">
                                            <BrainCircuit className="w-8 h-8 text-white" />
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <h3 className="text-2xl font-bold text-slate-900">Analyzing Team Performance...</h3>
                                    <p className="text-slate-600 max-w-md mx-auto">
                                        Our AI is analyzing team metrics, individual performance, and generating strategic insights
                                    </p>
                                    
                                    <div className="mt-6 max-w-xs mx-auto">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-semibold text-slate-700">Progress</span>
                                            <span className="text-sm font-bold text-indigo-600">{progress}%</span>
                                        </div>
                                        <div className="h-3 bg-slate-200 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-200 rounded-full"
                                                style={{ width: `${progress}%` }}
                                            ></div>
                                        </div>
                                    </div>

                                    <p className="text-xs text-slate-500 mt-4">This usually takes 10-15 seconds</p>
                                </div>
                            </CardContent>
                        </Card>
                    )}

                    {analysis && (
                        <Card>
                            <CardHeader><CardTitle>Analysis Results</CardTitle></CardHeader>
                            <CardContent className="prose dark:prose-invert max-w-none"><ReactMarkdown>{analysis}</ReactMarkdown></CardContent>
                        </Card>
                    )}
                </TabsContent>
            </Tabs>

            {/* Modals */}
            {isModalOpen && <TeamMemberModal teamMember={editingMember} onSave={(data) => saveMemberMutation.mutate(data)} onClose={() => { setIsModalOpen(false); setEditingMember(null); }} isSaving={saveMemberMutation.isLoading} />}
            {showAIAnalysis && selectedMemberForAdvice && <AIAnalysisModal member={selectedMemberForAdvice} performanceData={selectedMemberForAdvice} onClose={() => { setShowAIAnalysis(false); setSelectedMemberForAdvice(null); }} />}
            {showGoalModal && <SetGoalModal goal={selectedGoal} teamMembers={teamMembers} onClose={() => { setShowGoalModal(false); setSelectedGoal(null); setIsSettingOwnGoal(false); }} forSelf={isSettingOwnGoal} currentUser={user} />}
        </div>
    );
}
import React, { useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { useNavigate, useLocation } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { 
    ArrowLeft, Edit, DollarSign, Briefcase, Activity, Phone, Mail, 
    Star, Building, User, Target, TrendingUp
} from 'lucide-react';
import { Loader2 } from 'lucide-react';

export default function TeamMemberDetail() {
    const navigate = useNavigate();
    const location = useLocation();
    const urlParams = new URLSearchParams(location.search);
    const memberId = urlParams.get('id');

    // Fetch team member
    const { data: member, isLoading: loadingMember } = useQuery({
        queryKey: ['teamMember', memberId],
        queryFn: async () => {
            const members = await base44.entities.TeamMember.list();
            return members.find(m => m.id === memberId);
        },
        enabled: !!memberId,
    });

    // Fetch all data needed for performance calculation
    const { data: users = [] } = useQuery({
        queryKey: ['users'],
        queryFn: async () => {
            try {
                return await base44.entities.User.list() || [];
            } catch (error) {
                console.error('Error loading users:', error);
                return [];
            }
        }
    });

    const { data: transactions = [] } = useQuery({
        queryKey: ['transactions'],
        queryFn: async () => {
            try {
                return await base44.entities.Transaction.list() || [];
            } catch (error) {
                console.error('Error loading transactions:', error);
                return [];
            }
        }
    });

    const { data: properties = [] } = useQuery({
        queryKey: ['properties'],
        queryFn: async () => {
            try {
                return await base44.entities.Property.list() || [];
            } catch (error) {
                console.error('Error loading properties:', error);
                return [];
            }
        }
    });

    const { data: leads = [] } = useQuery({
        queryKey: ['leads'],
        queryFn: async () => {
            try {
                return await base44.entities.Lead.list() || [];
            } catch (error) {
                console.error('Error loading leads:', error);
                return [];
            }
        }
    });

    const { data: leadActivities = [] } = useQuery({
        queryKey: ['leadActivities'],
        queryFn: async () => {
            try {
                return await base44.entities.LeadActivity.list() || [];
            } catch (error) {
                console.error('Error loading activities:', error);
                return [];
            }
        }
    });

    // Calculate enriched performance data (same logic as Team Members page)
    const enrichedMember = useMemo(() => {
        if (!member) return null;

        console.log(`\nüë§ Analyzing ${member.full_name} on detail page...`);
        
        const user = users.find(u => u.email === member.email);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        // METHOD 1 & 2: Check transactions by notes field or agent IDs
        const memberTransactions = transactions.filter(t => {
            try {
                if (t.notes) {
                    const notes = JSON.parse(t.notes);
                    const isListingAgent = notes.listing_team_member_id === member.id;
                    const isSellingAgent = notes.selling_team_member_id === member.id;
                    
                    if (isListingAgent || isSellingAgent) {
                        console.log(`  ‚úÖ Transaction matched via notes: Property ${t.property_id}`);
                        return true;
                    }
                }
            } catch (e) {}
            
            // Fallback: Check if selling_agent_name matches
            if (t.selling_agent_name && t.selling_agent_name === member.full_name) {
                console.log(`  ‚úÖ Transaction matched via selling_agent_name: ${t.selling_agent_name}`);
                return true;
            }
            
            // Fallback: Check agent IDs
            if (t.listing_agent_id === user?.id || t.selling_agent_id === user?.id) {
                console.log(`  ‚úÖ Transaction matched via agent ID`);
                return true;
            }
            
            return false;
        });

        // METHOD 3: Check properties by tags field  
        const memberProperties = properties.filter(p => {
            if (p.tags && p.tags.includes(`listing_agent:${member.id}`)) {
                console.log(`  ‚úÖ Property matched via tags: ${p.address}`);
                return true;
            }
            return false;
        });

        // METHOD 4: Check leads by assigned agent or notes
        const memberLeads = leads.filter(l => {
            if (l.assigned_agent_id === user?.id) {
                console.log(`  ‚úÖ Lead matched via assigned_agent_id: ${l.name}`);
                return true;
            }
            if (l.notes && l.notes.includes(member.id)) {
                console.log(`  ‚úÖ Lead matched via notes: ${l.name}`);
                return true;
            }
            return false;
        });

        // Calculate revenue from transactions
        let revenue = 0;
        memberTransactions.forEach(t => {
            let transactionRevenue = 0;
            try {
                if (t.notes) {
                    const notes = JSON.parse(t.notes);
                    
                    // Add listing side if they're listing agent
                    if (notes.listing_team_member_id === member.id) {
                        transactionRevenue += (t.listing_net_commission || 0);
                        console.log(`    üí∞ Listing commission: $${t.listing_net_commission || 0}`);
                    }
                    
                    // Add selling side if they're selling agent
                    if (notes.selling_team_member_id === member.id) {
                        transactionRevenue += (t.selling_net_commission || 0);
                        console.log(`    üí∞ Selling commission: $${t.selling_net_commission || 0}`);
                    }
                }
            } catch (e) {
                console.error('    ‚ùå Error parsing transaction notes:', e);
            }
            
            // Fallback: Check direct assignments
            if (transactionRevenue === 0) {
                if (t.listing_agent_id === user?.id) {
                    transactionRevenue += (t.listing_net_commission || 0);
                }
                if (t.selling_agent_id === user?.id) {
                    transactionRevenue += (t.selling_net_commission || 0);
                }
            }
            
            // Fallback: Check name match
            if (transactionRevenue === 0 && t.selling_agent_name === member.full_name) {
                transactionRevenue += (t.selling_net_commission || 0);
            }
            
            revenue += transactionRevenue;
        });

        const deals = memberTransactions.length;
        const propertiesCount = memberProperties.length;
        const leadsCount = memberLeads.length;

        // Calculate activity count
        const activities = leadActivities.filter(a => {
            return a.description && a.description.toLowerCase().includes(member.full_name.toLowerCase());
        }).length;

        // Check for recent activity
        const hasRecentActivity = leadActivities.some(a => 
            a.description && 
            a.description.toLowerCase().includes(member.full_name.toLowerCase()) && 
            new Date(a.created_date) > thirtyDaysAgo
        );

        const isInactive = !hasRecentActivity && memberTransactions.length === 0;

        console.log(`  üìä ${member.full_name} Stats:`, {
            deals,
            revenue: `$${revenue.toFixed(0)}`,
            properties: propertiesCount,
            leads: leadsCount,
            activities,
            isInactive
        });

        return {
            ...member,
            revenue,
            deals,
            properties: propertiesCount,
            leads: leadsCount,
            activities,
            isInactive,
            transactions: memberTransactions,
        };
    }, [member, users, transactions, properties, leads, leadActivities]);

    if (loadingMember || !member) {
        return (
            <div className="flex items-center justify-center min-h-[400px]">
                <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
            </div>
        );
    }

    const renderStars = (count) => {
        const starCount = count || 3;
        return (
            <div className="flex gap-0.5">
                {[...Array(5)].map((_, i) => (
                    <Star
                        key={i}
                        className={`w-5 h-5 ${i < starCount ? 'fill-amber-400 text-amber-400' : 'text-slate-300 dark:text-slate-600'}`}
                    />
                ))}
            </div>
        );
    };

    const getRoleColor = () => {
        const colors = {
          broker: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300",
          listing_agent: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
          selling_agent: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",
          admin: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300",
          assistant: "bg-gray-100 text-gray-700 dark:bg-gray-800/30 dark:text-gray-300",
          transaction_coordinator: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
          team_member: "bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300"
        };
        return colors[member.role] || colors.team_member;
    };

    return (
        <div className="page-container space-y-6">
            <div className="flex items-center justify-between">
                <Button variant="outline" onClick={() => navigate(createPageUrl('TeamMembers'))}>
                    <ArrowLeft className="w-4 h-4 mr-2" />
                    Back to Team
                </Button>
                <Button onClick={() => navigate(createPageUrl(`TeamMembers?edit=${member.id}`))}>
                    <Edit className="w-4 h-4 mr-2" />
                    Edit Member
                </Button>
            </div>

            {/* Header Card */}
            <Card>
                <CardContent className="p-8">
                    <div className="flex items-start gap-6">
                        <Avatar className="h-24 w-24 border-4 border-slate-200 dark:border-slate-700">
                            <AvatarImage src={member.profile_photo_url} alt={member.full_name} />
                            <AvatarFallback className="text-4xl font-semibold bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                                {member.full_name?.charAt(0).toUpperCase()}
                            </AvatarFallback>
                        </Avatar>
                        <div className="flex-1">
                            <div className="flex items-start justify-between">
                                <div>
                                    <h1 className="text-3xl font-bold text-slate-900 dark:text-white">
                                        {member.full_name}
                                    </h1>
                                    <div className="mt-2">
                                        {renderStars(member.stars)}
                                    </div>
                                    <div className="flex gap-2 mt-3">
                                        <Badge className={getRoleColor()}>
                                            {member.role?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                        </Badge>
                                        {member.specialization && (
                                            <Badge variant="outline">
                                                {member.specialization.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                            </Badge>
                                        )}
                                    </div>
                                </div>
                            </div>
                            {member.bio && (
                                <p className="mt-4 text-slate-600 dark:text-slate-400">
                                    {member.bio}
                                </p>
                            )}
                        </div>
                    </div>
                </CardContent>
            </Card>

            {/* Performance Stats */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Revenue</p>
                                <p className="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">
                                    ${(enrichedMember?.revenue || 0).toLocaleString('en-US', { maximumFractionDigits: 0 })}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                                <DollarSign className="w-6 h-6 text-green-600 dark:text-green-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Deals</p>
                                <p className="text-2xl font-bold text-blue-600 dark:text-blue-400 mt-1">
                                    {enrichedMember?.deals || 0}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                <Briefcase className="w-6 h-6 text-blue-600 dark:text-blue-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Properties</p>
                                <p className="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1">
                                    {enrichedMember?.properties || 0}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                                <Building className="w-6 h-6 text-purple-600 dark:text-purple-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Activities</p>
                                <p className="text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1">
                                    {enrichedMember?.activities || 0}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                                <Activity className="w-6 h-6 text-orange-600 dark:text-orange-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>
            </div>

            {/* Contact Information */}
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <User className="w-5 h-5" />
                        Contact Information
                    </CardTitle>
                </CardHeader>
                <CardContent className="grid md:grid-cols-2 gap-6">
                    <div>
                        <div className="flex items-center gap-2 text-slate-600 dark:text-slate-400 mb-4">
                            <Mail className="w-4 h-4" />
                            <div>
                                <p className="text-xs text-slate-500 dark:text-slate-400">Email</p>
                                <a href={`mailto:${member.email}`} className="text-sm hover:underline hover:text-indigo-600 dark:hover:text-indigo-400">
                                    {member.email}
                                </a>
                            </div>
                        </div>
                        
                        {member.phone && (
                            <div className="flex items-center gap-2 text-slate-600 dark:text-slate-400 mb-4">
                                <Phone className="w-4 h-4" />
                                <div>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">Phone</p>
                                    <a href={`tel:${member.phone}`} className="text-sm hover:underline hover:text-indigo-600 dark:hover:text-indigo-400">
                                        {member.phone}
                                    </a>
                                </div>
                            </div>
                        )}
                    </div>

                    <div>
                        {member.license_number && (
                            <div className="flex items-center gap-2 text-slate-600 dark:text-slate-400 mb-4">
                                <Target className="w-4 h-4" />
                                <div>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">License Number</p>
                                    <p className="text-sm">{member.license_number}</p>
                                </div>
                            </div>
                        )}

                        {member.office && (
                            <div className="flex items-center gap-2 text-slate-600 dark:text-slate-400 mb-4">
                                <Building className="w-4 h-4" />
                                <div>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">Office</p>
                                    <p className="text-sm">{member.office}</p>
                                </div>
                            </div>
                        )}

                        {member.commission_split && (
                            <div className="flex items-center gap-2 text-slate-600 dark:text-slate-400 mb-4">
                                <TrendingUp className="w-4 h-4" />
                                <div>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">Commission Split</p>
                                    <p className="text-sm">{member.commission_split}%</p>
                                </div>
                            </div>
                        )}
                    </div>
                </CardContent>
            </Card>

            {/* Recent Transactions */}
            {enrichedMember?.transactions && enrichedMember.transactions.length > 0 && (
                <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                            <Briefcase className="w-5 h-5" />
                            Recent Transactions ({enrichedMember.transactions.length})
                        </CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div className="space-y-4">
                            {enrichedMember.transactions.slice(0, 10).map((transaction, idx) => {
                                const property = properties.find(p => p.id === transaction.property_id);
                                let role = 'Unknown';
                                let commission = 0;
                                
                                try {
                                    if (transaction.notes) {
                                        const notes = JSON.parse(transaction.notes);
                                        if (notes.listing_team_member_id === member.id) {
                                            role = 'Listing Agent';
                                            commission = transaction.listing_net_commission || 0;
                                        }
                                        if (notes.selling_team_member_id === member.id) {
                                            role = role === 'Listing Agent' ? 'Both Sides' : 'Selling Agent';
                                            commission += transaction.selling_net_commission || 0;
                                        }
                                    }
                                } catch (e) {}

                                return (
                                    <div key={idx} className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                                        <div className="flex-1">
                                            <p className="font-semibold text-slate-900 dark:text-white">
                                                {property?.address || `Transaction #${transaction.id}`}
                                            </p>
                                            <div className="flex gap-2 mt-1">
                                                <Badge variant="outline" className="text-xs">{role}</Badge>
                                                <Badge variant="outline" className="text-xs">
                                                    {transaction.status}
                                                </Badge>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="font-bold text-green-600 dark:text-green-400">
                                                ${commission.toLocaleString('en-US', { maximumFractionDigits: 0 })}
                                            </p>
                                            <p className="text-xs text-slate-500 dark:text-slate-400">
                                                ${(transaction.contract_price || 0).toLocaleString()}
                                            </p>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </CardContent>
                </Card>
            )}
        </div>
    );
}

import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { toast } from 'sonner';

import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import TeamMemberCard from '../components/team/TeamMemberCard';
import TeamMemberModal from '../components/settings/TeamMemberModal';
import AIAnalysisModal from '../components/team/AIAnalysisModal';

import { Users, Plus, BrainCircuit, DollarSign, Briefcase, Activity, Search, ListFilter, LifeBuoy, AlertTriangle, Loader2 } from 'lucide-react';

export default function TeamMembers() {
    const navigate = useNavigate();
    const queryClient = useQueryClient();
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingMember, setEditingMember] = useState(null);
    const [searchQuery, setSearchQuery] = useState('');
    const [sortBy, setSortBy] = useState("revenue_desc"); // Changed default sort to revenue_desc
    const [roleFilter, setRoleFilter] = useState('all');
    const [showAIAnalysis, setShowAIAnalysis] = useState(false);
    const [selectedMemberForAdvice, setSelectedMemberForAdvice] = useState(null);

    // Fetch all data with better error handling
    const { data: teamMembers = [], isLoading: isLoadingMembers, error: membersError } = useQuery({
        queryKey: ['teamMembers'],
        queryFn: async () => {
            try {
                const members = await base44.entities.TeamMember.list();
                console.log('‚úÖ Loaded team members:', members.length);
                return members || [];
            } catch (error) {
                console.error('‚ùå Error loading team members:', error);
                return [];
            }
        },
    });

    // Removed useQuery for 'users' as it's no longer used for performance calculations
    // Removed useQuery for 'messages' as it's no longer used for performance calculations

    const { data: transactions = [], isLoading: isLoadingTransactions } = useQuery({
        queryKey: ['transactions'],
        queryFn: async () => {
            try {
                return await base44.entities.Transaction.list() || [];
            } catch (error) {
                console.error('Error loading transactions:', error);
                return [];
            }
        },
    });

    const { data: properties = [], isLoading: isLoadingProperties } = useQuery({
        queryKey: ['properties'],
        queryFn: async () => {
            try {
                return await base44.entities.Property.list() || [];
            } catch (error) {
                console.error('Error loading properties:', error);
                return [];
            }
        },
    });

    const { data: leads = [], isLoading: isLoadingLeads } = useQuery({
        queryKey: ['leads'],
        queryFn: async () => {
            try {
                return await base44.entities.Lead.list() || [];
            } catch (error) {
                console.error('Error loading leads:', error);
                return [];
            }
        },
    });

    const { data: leadActivities = [], isLoading: isLoadingActivities } = useQuery({
        queryKey: ['leadActivities'],
        queryFn: async () => {
            try {
                return await base44.entities.LeadActivity.list() || [];
            } catch (error) {
                console.error('Error loading activities:', error);
                return [];
            }
        },
    });

    const isLoading = isLoadingMembers || isLoadingTransactions || 
                      isLoadingActivities || isLoadingProperties || isLoadingLeads;

    // Comprehensive team member performance analysis
    const memberPerformanceData = useMemo(() => {
        console.log('üîÑ Calculating member performance...', {
            teamMembers: teamMembers.length,
            transactions: transactions.length,
            properties: properties.length,
            leads: leads.length
        });

        if (!teamMembers || teamMembers.length === 0) {
            console.log('‚ö†Ô∏è No team members found');
            return {
                teamStats: {
                    totalRevenue: 0,
                    totalDeals: 0,
                    activeMembers: 0,
                    totalActivities: 0,
                    totalLeads: 0, // Keep for UI display
                    totalProperties: 0, // Keep for UI display
                },
                enrichedMembers: []
            };
        }

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const enrichedMembers = teamMembers.map(member => {
            console.log(`\nüë§ Analyzing ${member.full_name}...`);
            
            // METHOD 1 & 2: Check transactions by notes field (where we stored team member IDs) or selling_agent_name
            const memberTransactions = transactions.filter(t => {
                try {
                    if (t.notes) {
                        const notes = JSON.parse(t.notes);
                        const isListingAgent = notes.listing_team_member_id === member.id;
                        const isSellingAgent = notes.selling_team_member_id === member.id;
                        
                        if (isListingAgent || isSellingAgent) {
                            console.log(`  ‚úÖ Transaction matched via notes: Property ${t.property_id}`);
                            return true;
                        }
                    }
                } catch (e) {
                    // Notes not JSON or doesn't exist, continue to next method
                }
                
                // Fallback: Check if selling_agent_name matches
                if (t.selling_agent_name && t.selling_agent_name === member.full_name) {
                    console.log(`  ‚úÖ Transaction matched via selling_agent_name: ${t.selling_agent_name}`);
                    return true;
                }
                
                return false;
            });

            // METHOD 3: Check properties by tags field  
            const memberProperties = properties.filter(p => {
                if (p.tags && p.tags.includes(`listing_agent:${member.id}`)) {
                    console.log(`  ‚úÖ Property matched via tags: ${p.address}`);
                    return true;
                }
                return false;
            });

            // METHOD 4: Check leads by notes field for member ID
            const memberLeads = leads.filter(l => {
                // Assuming notes might contain a string representation of the member ID
                if (l.notes && l.notes.includes(member.id)) {
                    console.log(`  ‚úÖ Lead matched via notes: ${l.name}`);
                    return true;
                }
                return false;
            });

            // Calculate revenue from transactions
            let revenue = 0;
            memberTransactions.forEach(t => {
                let transactionRevenue = 0;
                try {
                    if (t.notes) {
                        const notes = JSON.parse(t.notes);
                        
                        // Add listing side if they're listing agent
                        if (notes.listing_team_member_id === member.id) {
                            transactionRevenue += (t.listing_net_commission || 0);
                            console.log(`    üí∞ Listing commission: $${t.listing_net_commission || 0}`);
                        }
                        
                        // Add selling side if they're selling agent
                        if (notes.selling_team_member_id === member.id) {
                            transactionRevenue += (t.selling_net_commission || 0);
                            console.log(`    üí∞ Selling commission: $${t.selling_net_commission || 0}`);
                        }
                    } else if (t.selling_agent_name === member.full_name) {
                        // Fallback: if name matches selling agent (only selling side in this case)
                        transactionRevenue += (t.selling_net_commission || 0);
                        console.log(`    üí∞ Selling commission (by name): $${t.selling_net_commission || 0}`);
                    }
                } catch (e) {
                    console.error('    ‚ùå Error parsing transaction notes:', e);
                }
                revenue += transactionRevenue;
            });
            

            const deals = memberTransactions.length;
            const propertiesCount = memberProperties.length;
            const leadsCount = memberLeads.length;

            // Calculate activity count by description
            const activities = leadActivities.filter(a => {
                // Check if activity description mentions this team member's full name
                return a.description && a.description.toLowerCase().includes(member.full_name.toLowerCase());
            }).length;

            // Check for recent activity (within 30 days)
            const hasRecentActivity = leadActivities.some(a => 
                a.description && 
                a.description.toLowerCase().includes(member.full_name.toLowerCase()) && 
                new Date(a.created_date) > thirtyDaysAgo
            );

            // Consider inactive if no recent activity found AND no transactions
            const isInactive = !hasRecentActivity && memberTransactions.length === 0;

            console.log(`  üìä ${member.full_name} Stats:`, {
                deals,
                revenue: `$${revenue.toFixed(0)}`,
                properties: propertiesCount,
                leads: leadsCount,
                activities,
                isInactive
            });

            return {
                ...member,
                revenue,
                deals,
                properties: propertiesCount,
                leads: leadsCount,
                activities,
                isInactive,
                transactions: memberTransactions,
            };
        });

        // Calculate team stats
        const teamStats = {
            totalRevenue: enrichedMembers.reduce((sum, m) => sum + m.revenue, 0),
            totalDeals: enrichedMembers.reduce((sum, m) => sum + m.deals, 0),
            activeMembers: enrichedMembers.filter(m => !m.isInactive).length,
            totalActivities: enrichedMembers.reduce((sum, m) => sum + m.activities, 0),
            totalLeads: enrichedMembers.reduce((sum, m) => sum + m.leads, 0), // Sum leads from enriched members
            totalProperties: enrichedMembers.reduce((sum, m) => sum + m.properties, 0), // Sum properties from enriched members
        };

        console.log('\nüìà Team Stats:', teamStats);
        console.log('üë• Total Members Analyzed:', enrichedMembers.length);

        return {
            teamStats,
            enrichedMembers
        };
    }, [teamMembers, transactions, properties, leads, leadActivities]); // Removed users, messages from dependencies

    const enrichedMembers = memberPerformanceData.enrichedMembers; // Changed from memberPerformances
    const teamStats = memberPerformanceData.teamStats;

    const filteredMembers = useMemo(() => {
        if (!enrichedMembers || enrichedMembers.length === 0) {
            return [];
        }

        return enrichedMembers.filter(member => {
            const matchesSearch = !searchQuery || 
                member.full_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                member.email?.toLowerCase().includes(searchQuery.toLowerCase());
            
            const matchesRole = roleFilter === 'all' || member.role === roleFilter;
            
            return matchesSearch && matchesRole;
        });
    }, [enrichedMembers, searchQuery, roleFilter]);

    const sortedMembers = useMemo(() => {
        if (!filteredMembers || filteredMembers.length === 0) {
            return [];
        }

        const sortableMembers = [...filteredMembers];
        sortableMembers.sort((a, b) => {
            switch (sortBy) {
                case 'name_asc': return (a.full_name || '').localeCompare(b.full_name || '');
                case 'revenue_desc': return (b.revenue || 0) - (a.revenue || 0);
                case 'deals_desc': return (b.deals || 0) - (a.deals || 0);
                case 'activity_desc': return (b.activities || 0) - (a.activities || 0);
                // Removed 'rating_desc' as 'overallScore' is no longer calculated
                default: return 0;
            }
        });
        return sortableMembers;
    }, [filteredMembers, sortBy]);

    const saveMutation = useMutation({
        mutationFn: async (memberData) => {
            if (editingMember) {
                return await base44.entities.TeamMember.update(editingMember.id, memberData);
            } else {
                return await base44.entities.TeamMember.create(memberData);
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['teamMembers'] });
            toast.success(`Team member ${editingMember ? 'updated' : 'added'} successfully!`);
            setIsModalOpen(false);
            setEditingMember(null);
        },
        onError: (error) => {
            toast.error(`Failed to save team member: ${error.message}`);
        }
    });

    const deleteMutation = useMutation({
        mutationFn: (id) => base44.entities.TeamMember.delete(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['teamMembers'] });
            toast.success('Team member removed successfully!');
        },
        onError: (error) => {
            toast.error(`Failed to remove team member: ${error.message}`);
        }
    });

    const handleEdit = (member) => {
        setEditingMember(member);
        setIsModalOpen(true);
    };

    const handleDelete = (member) => {
        if (confirm(`Are you sure you want to remove ${member.full_name} from the team? This action cannot be undone.`)) {
            deleteMutation.mutate(member.id);
        }
    };

    const handleGetAIAdvice = (member) => {
        setSelectedMemberForAdvice(member);
        setShowAIAnalysis(true);
    };

    if (isLoading) {
        return (
            <div className="page-container flex items-center justify-center min-h-[400px]">
                <div className="text-center">
                    <Loader2 className="w-8 h-8 animate-spin mx-auto mb-4 text-indigo-600" />
                    <p className="text-slate-600">Loading team data...</p>
                </div>
            </div>
        );
    }

    if (membersError) {
        return (
            <div className="page-container">
                <Card className="border-red-200 bg-red-50">
                    <CardContent className="p-8 text-center">
                        <AlertTriangle className="w-12 h-12 mx-auto text-red-500 mb-4" />
                        <h3 className="text-lg font-semibold text-red-900 mb-2">Error Loading Team Members</h3>
                        <p className="text-red-700 mb-4">{membersError.message}</p>
                        <Button onClick={() => queryClient.invalidateQueries({ queryKey: ['teamMembers'] })}>
                            Try Again
                        </Button>
                    </CardContent>
                </Card>
            </div>
        );
    }

    return (
        <div className="page-container space-y-6">
            <Card>
                <CardHeader>
                    <div className="flex justify-between items-start">
                        <div>
                            <CardTitle className="text-2xl flex items-center gap-3">
                                <Users className="w-7 h-7" />
                                Team Members
                            </CardTitle>
                            <CardDescription>
                                {teamStats.activeMembers} active members ‚Ä¢ {teamStats.totalDeals} deals ‚Ä¢ ${teamStats.totalRevenue.toLocaleString()} revenue
                            </CardDescription>
                        </div>
                        <div className="flex flex-wrap gap-2 justify-end">
                            <Button variant="outline" onClick={() => navigate(createPageUrl('TeamSurvey'))}>
                                <LifeBuoy className="w-4 h-4 mr-2" />
                                Take Survey
                            </Button>
                            <Button variant="outline" onClick={() => navigate(createPageUrl('TeamSurveyResults'))}>
                                <Users className="w-4 h-4 mr-2" />
                                View Survey Results
                            </Button>
                            <Button variant="outline" onClick={() => navigate(createPageUrl('DiagnoseTeam'))}>
                                <BrainCircuit className="w-4 h-4 mr-2"/>Diagnose
                            </Button>
                            <Button onClick={() => { setEditingMember(null); setIsModalOpen(true); }}>
                                <Plus className="w-4 h-4 mr-2" /> Add Team Member
                            </Button>
                        </div>
                    </div>
                </CardHeader>
            </Card>

            {/* Stats Overview */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Team Revenue</p>
                                <p className="text-2xl font-bold text-slate-900 dark:text-white mt-1">
                                    ${(teamStats.totalRevenue).toLocaleString('en-US', { maximumFractionDigits: 0 })}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                                <DollarSign className="w-6 h-6 text-green-600 dark:text-green-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Deals</p>
                                <p className="text-2xl font-bold text-slate-900 dark:text-white mt-1">
                                    {teamStats.totalDeals}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                <Briefcase className="w-6 h-6 text-blue-600 dark:text-blue-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Properties</p>
                                <p className="text-2xl font-bold text-slate-900 dark:text-white mt-1">
                                    {teamStats.totalProperties}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                                <Briefcase className="w-6 h-6 text-purple-600 dark:text-purple-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardContent className="p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Total Leads</p>
                                <p className="text-2xl font-bold text-slate-900 dark:text-white mt-1">
                                    {teamStats.totalLeads}
                                </p>
                            </div>
                            <div className="w-12 h-12 rounded-lg bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                                <Activity className="w-6 h-6 text-orange-600 dark:text-orange-400" />
                            </div>
                        </div>
                    </CardContent>
                </Card>
            </div>

            <Card>
                <CardContent className="p-4">
                    <div className="flex flex-col md:flex-row gap-4 justify-between">
                         <div className="relative flex-grow">
                            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" />
                            <Input
                                placeholder="Search team members..."
                                value={searchQuery}
                                onChange={e => setSearchQuery(e.target.value)}
                                className="pl-10"
                            />
                        </div>
                        <div className="flex items-center gap-2">
                            <ListFilter className="w-5 h-5 text-slate-500" />
                             <Select value={sortBy} onValueChange={setSortBy}>
                                <SelectTrigger className="w-[180px]">
                                    <SelectValue placeholder="Sort by" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="revenue_desc">Revenue</SelectItem> {/* Changed default to Revenue */}
                                    <SelectItem value="deals_desc">Deals</SelectItem>
                                    <SelectItem value="activity_desc">Activity</SelectItem>
                                    <SelectItem value="name_asc">Name (A-Z)</SelectItem>
                                    {/* Removed 'Overall Score' as it's no longer calculated */}
                                </SelectContent>
                            </Select>
                            <Select value={roleFilter} onValueChange={setRoleFilter}>
                                <SelectTrigger className="w-[180px]">
                                    <SelectValue placeholder="Filter by role" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="all">All Roles</SelectItem>
                                    <SelectItem value="listing_agent">Listing Agent</SelectItem>
                                    <SelectItem value="selling_agent">Selling Agent</SelectItem>
                                    <SelectItem value="broker">Broker</SelectItem>
                                    <SelectItem value="admin">Administrator</SelectItem>
                                    <SelectItem value="assistant">Assistant</SelectItem>
                                    <SelectItem value="transaction_coordinator">Transaction Coordinator</SelectItem>
                                    <SelectItem value="team_member">Team Member</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>
                    </div>
                </CardContent>
            </Card>
            
            {/* Team Member Cards */}
            {sortedMembers.length > 0 ? (
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {sortedMembers.map(member => (
                        <TeamMemberCard 
                            key={member.id} 
                            member={member} 
                            onEdit={() => handleEdit(member)}
                            onDelete={() => handleDelete(member)}
                            onGetAIAdvice={() => handleGetAIAdvice(member)}
                        />
                    ))}
                </div>
            ) : (
                 <Card>
                    <CardContent className="p-12 text-center">
                        <Users className="w-16 h-16 mx-auto text-slate-300 dark:text-slate-600 mb-4" />
                        <h3 className="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-2">
                            {teamMembers.length === 0 ? 'No team members yet' : 'No team members found'}
                        </h3>
                        <p className="text-slate-600 dark:text-slate-400 mb-4">
                            {teamMembers.length === 0 
                                ? 'Add your first team member to get started tracking performance.' 
                                : searchQuery || roleFilter !== 'all' 
                                    ? `No results found for "${searchQuery}" with the selected role.` 
                                    : 'No team members match your filters.'}
                        </p>
                        {teamMembers.length === 0 && (
                            <Button onClick={() => setIsModalOpen(true)}>
                                <Plus className="w-4 h-4 mr-2" />
                                Add Your First Team Member
                            </Button>
                        )}
                        {teamMembers.length > 0 && (searchQuery || roleFilter !== 'all') && (
                            <Button variant="outline" onClick={() => { setSearchQuery(''); setRoleFilter('all'); }}>
                                Clear Filters
                            </Button>
                        )}
                    </CardContent>
                </Card>
            )}

            {/* Team Member Modal */}
            {isModalOpen && (
                <TeamMemberModal
                    teamMember={editingMember}
                    onSave={(data) => saveMutation.mutate(data)}
                    onClose={() => { setIsModalOpen(false); setEditingMember(null); }}
                    isSaving={saveMutation.isLoading}
                />
            )}

            {/* AI Analysis Modal */}
            {showAIAnalysis && selectedMemberForAdvice && (
                <AIAnalysisModal
                    member={selectedMemberForAdvice}
                    performanceData={selectedMemberForAdvice}
                    onClose={() => { setShowAIAnalysis(false); setSelectedMemberForAdvice(null); }}
                />
            )}
        </div>
    );
}

import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Loader2 } from 'lucide-react';

export default function TeamSurveyPage() {
    const queryClient = useQueryClient();
    const [formData, setFormData] = useState({
        tools_used: '',
        tools_advised: '',
        complaints_or_advice: ''
    });
    const [surveyId, setSurveyId] = useState(null);

    const { data: user, isLoading: userLoading } = useQuery({
        queryKey: ['currentUser'],
        queryFn: () => base44.auth.me(),
    });

    const { data: existingSurvey, isLoading: surveyLoading } = useQuery({
        queryKey: ['teamSurvey', user?.id],
        queryFn: async () => {
            if (!user) return null;
            const surveys = await base44.entities.TeamSurvey.filter({ user_id: user.id });
            // Sort by most recent in case of multiple submissions
            const sortedSurveys = (surveys || []).sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
            return sortedSurveys[0] || null;
        },
        enabled: !!user,
        onSuccess: (data) => {
            if (data) {
                setFormData({
                    tools_used: data.tools_used || '',
                    tools_advised: data.tools_advised || '',
                    complaints_or_advice: data.complaints_or_advice || ''
                });
                setSurveyId(data.id);
            }
        }
    });

    const surveyMutation = useMutation({
        mutationFn: async (surveyData) => {
            const payload = {
                ...surveyData,
                user_id: user.id,
                user_name: user.full_name
            };
            if (surveyId) {
                return base44.entities.TeamSurvey.update(surveyId, payload);
            } else {
                return base44.entities.TeamSurvey.create(payload);
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['teamSurvey', user.id] });
            toast.success('Thank you! Your feedback has been submitted successfully.');
        },
        onError: () => {
            toast.error('There was an error submitting your feedback. Please try again.');
        }
    });

    const handleSubmit = (e) => {
        e.preventDefault();
        surveyMutation.mutate(formData);
    };

    const handleChange = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
    };

    if (userLoading || surveyLoading) {
        return (
            <div className="flex justify-center items-center h-96">
                <Loader2 className="w-8 h-8 animate-spin text-primary" />
            </div>
        );
    }
    
    return (
        <div className="page-container p-4">
            <Card className="max-w-4xl mx-auto bg-card">
                <CardHeader>
                    <CardTitle className="text-2xl font-bold">Team Feedback &amp; Insights Survey</CardTitle>
                    <CardDescription>
                        Your input is valuable for our collective growth. Please share your thoughts openly. 
                        Your submission will be linked to your profile.
                    </CardDescription>
                </CardHeader>
                <form onSubmit={handleSubmit}>
                    <CardContent className="space-y-6">
                        <div className="space-y-2">
                            <Label htmlFor="tools_used" className="text-base font-semibold">What tools, platforms, or methods do you currently use in your workflow?</Label>
                            <p className="text-sm text-muted-foreground">e.g., Specific CRM features, social media strategies, marketing software, organizational apps, etc.</p>
                            <Textarea
                                id="tools_used"
                                value={formData.tools_used}
                                onChange={(e) => handleChange('tools_used', e.target.value)}
                                placeholder="Describe your daily go-to's..."
                                rows={5}
                                className="bg-background"
                            />
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="tools_advised" className="text-base font-semibold">What would you advise other team members to use or try?</Label>
                            <p className="text-sm text-muted-foreground">This could be a game-changing app, a useful website, or a simple productivity hack.</p>
                            <Textarea
                                id="tools_advised"
                                value={formData.tools_advised}
                                onChange={(e) => handleChange('tools_advised', e.target.value)}
                                placeholder="Share your best recommendations..."
                                rows={5}
                                className="bg-background"
                            />
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="complaints_or_advice" className="text-base font-semibold">Do you have any general complaints or advice for the group?</Label>
                            <p className="text-sm text-muted-foreground">This is your space to voice concerns, suggest improvements, or share wisdom for the benefit of the whole team.</p>
                            <Textarea
                                id="complaints_or_advice"
                                value={formData.complaints_or_advice}
                                onChange={(e) => handleChange('complaints_or_advice', e.target.value)}
                                placeholder="What's on your mind?..."
                                rows={5}
                                className="bg-background"
                            />
                        </div>
                    </CardContent>
                    <CardFooter className="flex justify-end">
                        <Button type="submit" disabled={surveyMutation.isLoading}>
                            {surveyMutation.isLoading && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                            {surveyId ? 'Update My Feedback' : 'Submit Feedback'}
                        </Button>
                    </CardFooter>
                </form>
            </Card>
        </div>
    );
}
import React from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { formatDistanceToNow } from 'date-fns';

import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Loader2, ArrowLeft, MessageSquare, ListChecks, Star } from 'lucide-react';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';

export default function TeamSurveyResultsPage() {
    const navigate = useNavigate();

    const { data: surveyResults, isLoading } = useQuery({
        queryKey: ['allTeamSurveys'],
        queryFn: () => base44.entities.TeamSurvey.list('-created_date')
    });

    if (isLoading) {
        return (
            <div className="flex justify-center items-center h-96">
                <Loader2 className="w-8 h-8 animate-spin text-primary" />
            </div>
        );
    }

    return (
        <div className="page-container p-4 space-y-6">
            <div className="flex items-center gap-4">
                <Button variant="outline" size="icon" onClick={() => navigate(createPageUrl('TeamMembers'))}>
                    <ArrowLeft className="w-4 h-4" />
                </Button>
                <div>
                    <h1 className="text-2xl font-bold">Team Feedback Submissions</h1>
                    <p className="text-slate-500">Review insights and suggestions from your team members.</p>
                </div>
            </div>

            {surveyResults && surveyResults.length > 0 ? (
                <div className="grid gap-6 md:grid-cols-1 lg:grid-cols-2 xl:grid-cols-3">
                    {surveyResults.map(survey => (
                        <Card key={survey.id} className="bg-card">
                            <CardHeader>
                                <div className="flex items-center gap-3">
                                    <Avatar>
                                        <AvatarFallback>{survey.user_name ? survey.user_name.charAt(0) : 'U'}</AvatarFallback>
                                    </Avatar>
                                    <div>
                                        <CardTitle className="text-lg">{survey.user_name}</CardTitle>
                                        <CardDescription>
                                            Submitted {formatDistanceToNow(new Date(survey.created_date), { addSuffix: true })}
                                        </CardDescription>
                                    </div>
                                </div>
                            </CardHeader>
                            <CardContent className="space-y-4">
                                <div>
                                    <h4 className="font-semibold text-sm flex items-center gap-2 mb-2"><ListChecks className="w-4 h-4 text-primary"/>Current Tools & Methods</h4>
                                    <p className="text-sm text-muted-foreground p-3 bg-background rounded-md">{survey.tools_used || 'No input provided.'}</p>
                                </div>
                                <div>
                                    <h4 className="font-semibold text-sm flex items-center gap-2 mb-2"><Star className="w-4 h-4 text-primary"/>Recommendations for Team</h4>
                                    <p className="text-sm text-muted-foreground p-3 bg-background rounded-md">{survey.tools_advised || 'No input provided.'}</p>
                                </div>
                                <div>
                                    <h4 className="font-semibold text-sm flex items-center gap-2 mb-2"><MessageSquare className="w-4 h-4 text-primary"/>General Complaints or Advice</h4>
                                    <p className="text-sm text-muted-foreground p-3 bg-background rounded-md">{survey.complaints_or_advice || 'No input provided.'}</p>
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            ) : (
                <div className="text-center py-16 border-2 border-dashed rounded-lg">
                    <MessageSquare className="w-12 h-12 mx-auto text-slate-300 dark:text-slate-600 mb-4" />
                    <h3 className="text-xl font-semibold">No survey results yet</h3>
                    <p className="text-slate-500 mt-2">Encourage your team to submit feedback to see the results here.</p>
                </div>
            )}
        </div>
    );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate, useSearchParams } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import {
  ArrowLeft,
  Home,
  FileText,
  CheckCircle2,
  Clock,
  Calendar,
  TrendingUp,
  AlertCircle,
  Loader2,
  Download,
  Eye,
  MessageSquare,
  Shield,
  User,
  Building2,
  Mail,
  Phone,
  Users,
  Plus,
  X,
  ChevronDown,
  ChevronUp,
  UserPlus
} from "lucide-react";
import { toast } from "sonner";
import { format } from "date-fns";
import DocumentPreviewModal from "../components/documents/DocumentPreviewModal";
import PropertyMessaging from "../components/properties/PropertyMessaging";

export default function TransactionDetail() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const transactionId = searchParams.get('id');

  const [user, setUser] = useState(null);
  const [transaction, setTransaction] = useState(null);
  const [property, setProperty] = useState(null);
  const [documents, setDocuments] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [agent, setAgent] = useState(null);
  const [allUsers, setAllUsers] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [clientPortalAccess, setClientPortalAccess] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [activeTab, setActiveTab] = useState('overview');
  const [previewDocument, setPreviewDocument] = useState(null);
  
  // Deal Room state
  const [selectedSellerEmails, setSelectedSellerEmails] = useState([]);
  const [selectedBuyerEmails, setSelectedBuyerEmails] = useState([]);
  const [selectedSellerDocuments, setSelectedSellerDocuments] = useState([]);
  const [selectedBuyerDocuments, setSelectedBuyerDocuments] = useState([]);
  const [isCreatingSeller, setIsCreatingSeller] = useState(false);
  const [isCreatingBuyer, setIsCreatingBuyer] = useState(false);
  const [showSharedDocsForSeller, setShowSharedDocsForSeller] = useState(false);
  const [showSharedDocsForBuyer, setShowSharedDocsForBuyer] = useState(false);

  useEffect(() => {
    if (transactionId) {
      loadTransactionDetail();
    }
  }, [transactionId]);

  const loadTransactionDetail = async () => {
    setIsLoading(true);
    setError(null);
    
    try {
      const currentUser = await base44.auth.me();
      setUser(currentUser);

      // Load all supporting data
      const [allTransactions, allProperties, allDocuments, allTasks, userData, teamData, allAccess] = await Promise.all([
        base44.entities.Transaction.list(),
        base44.entities.Property.list(),
        base44.entities.Document.list(),
        base44.entities.Task.list(),
        base44.entities.User.list(),
        base44.entities.TeamMember.list(),
        base44.entities.ClientPortalAccess.list()
      ]);

      setAllUsers(userData);
      setTeamMembers(teamData);

      // Load transaction
      const transactionData = allTransactions.find(t => t.id === transactionId);
      
      if (!transactionData) {
        throw new Error("Transaction not found");
      }

      setTransaction(transactionData);

      // Load property if linked
      if (transactionData.property_id) {
        const propertyData = allProperties.find(p => p.id === transactionData.property_id);
        setProperty(propertyData);

        // Get agent from property
        if (propertyData?.listing_agent_id) {
          const agentData = userData.find(u => u.id === propertyData.listing_agent_id) ||
                            teamData.find(tm => tm.id === propertyData.listing_agent_id);
          setAgent(agentData);
        }
      } else if (transactionData.roles?.listing_agent_id) {
        // Get agent from transaction roles
        const agentData = userData.find(u => u.id === transactionData.roles.listing_agent_id) ||
                          teamData.find(tm => tm.id === transactionData.roles.listing_agent_id);
        setAgent(agentData);
      }

      // Load documents for this transaction
      const transactionDocs = allDocuments.filter(d => 
        d.transaction_id === transactionId || 
        (transactionData.property_id && d.property_id === transactionData.property_id)
      );
      setDocuments(transactionDocs);

      // Load tasks for this transaction's property
      if (transactionData.property_id) {
        const propertyTasks = allTasks.filter(t => t.property_id === transactionData.property_id);
        setTasks(propertyTasks);
      }

      // Load portal access
      const propertyAccess = allAccess.filter(a => 
        (transactionData.property_id && a.property_id === transactionData.property_id) ||
        a.transaction_id === transactionId
      );
      setClientPortalAccess(propertyAccess);

    } catch (error) {
      console.error("Error loading transaction detail:", error);
      setError(error.message);
      toast.error("Failed to load transaction details");
    }
    
    setIsLoading(false);
  };

  const getTransactionProgress = () => {
    if (!transaction) return 0;
    
    const listing = transaction.listing_side_progress || 0;
    const selling = transaction.selling_side_progress || 0;
    
    // Average of both sides
    return Math.round((listing + selling) / 2);
  };

  const getSellers = () => {
    if (!transaction?.sellers_info) return [];
    try {
      const parsed = typeof transaction.sellers_info === 'string' 
        ? JSON.parse(transaction.sellers_info) 
        : transaction.sellers_info;
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  };

  const getBuyers = () => {
    if (!transaction?.buyers_info) return [];
    try {
      const parsed = typeof transaction.buyers_info === 'string' 
        ? JSON.parse(transaction.buyers_info) 
        : transaction.buyers_info;
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  };

  const getSharedDocIds = () => {
    const shared = new Set();
    clientPortalAccess.forEach(access => {
      if (access.document_access) {
        try {
          const docIds = Array.isArray(access.document_access) 
            ? access.document_access 
            : JSON.parse(access.document_access);
          docIds.forEach(id => shared.add(id));
        } catch (e) {}
      }
    });
    return Array.from(shared);
  };

  const hasAccessForEmail = (email, accessType) => {
    if (!email) return false;
    const clientUser = allUsers.find(u => u.email === email);
    if (!clientUser) return false;

    return clientPortalAccess.some(a =>
      a.client_user_id === clientUser.id &&
      a.access_type === accessType &&
      a.is_active
    );
  };

  const handleCreateAccess = async (type) => {
    const recipients = type === 'seller' ? selectedSellerEmails : selectedBuyerEmails;
    const selectedDocs = type === 'seller' ? selectedSellerDocuments : selectedBuyerDocuments;
    const setIsCreating = type === 'seller' ? setIsCreatingSeller : setIsCreatingBuyer;

    if (recipients.length === 0) {
      toast.error("Please select at least one recipient");
      return;
    }

    setIsCreating(true);
    try {
      let successCount = 0;
      let updateCount = 0;

      for (const email of recipients) {
        let clientUser = allUsers.find(u => u.email === email);

        if (!clientUser) {
          toast.info(`User with email ${email} not found. They need to be invited first.`);
          continue;
        }

        const existing = clientPortalAccess.find(a =>
          a.client_user_id === clientUser.id &&
          a.access_type === type &&
          (property ? a.property_id === property.id : a.transaction_id === transactionId)
        );

        if (existing) {
          let existingDocs = [];
          try {
            existingDocs = Array.isArray(existing.document_access) 
              ? existing.document_access 
              : JSON.parse(existing.document_access || '[]');
          } catch (e) {}

          const mergedDocs = [...new Set([...existingDocs, ...selectedDocs])];

          await base44.entities.ClientPortalAccess.update(existing.id, {
            document_access: mergedDocs
          });

          updateCount++;
          continue;
        }

        const accessData = {
          client_user_id: clientUser.id,
          agent_id: user.id,
          access_type: type,
          property_id: property?.id || null,
          transaction_id: transactionId,
          is_active: true,
          document_access: selectedDocs.length > 0 ? selectedDocs : [],
          preferences: {}
        };

        await base44.entities.ClientPortalAccess.create(accessData);
        successCount++;
      }

      if (successCount > 0) {
        toast.success(`Portal access granted to ${successCount} ${type}(s)!`);
      }
      if (updateCount > 0) {
        toast.success(`Updated ${updateCount} ${type}(s) with ${selectedDocs.length} more document(s)!`);
      }

      // Reset
      if (type === 'seller') {
        setSelectedSellerEmails([]);
        setSelectedSellerDocuments([]);
      } else {
        setSelectedBuyerEmails([]);
        setSelectedBuyerDocuments([]);
      }

      await loadTransactionDetail();

    } catch (error) {
      console.error("Error creating portal access:", error);
      toast.error(`Failed to create portal access: ${error.message}`);
    }
    setIsCreating(false);
  };

  const handleRevokeAccess = async (accessId) => {
    if (!confirm("Revoke portal access?")) return;

    try {
      await base44.entities.ClientPortalAccess.delete(accessId);
      toast.success("Portal access revoked");
      await loadTransactionDetail();
    } catch (error) {
      console.error("Error revoking access:", error);
      toast.error("Failed to revoke access");
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100">
        <div className="text-center">
          <Loader2 className="w-16 h-16 mx-auto mb-4 animate-spin text-indigo-600" />
          <p className="text-slate-600">Loading transaction details...</p>
        </div>
      </div>
    );
  }

  if (error || !transaction) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 p-4">
        <Card className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h2 className="text-2xl font-bold mb-2">Error</h2>
            <p className="text-slate-600 mb-6">{error || "Transaction not found"}</p>
            <Button onClick={() => navigate(createPageUrl("Transactions"))}>
              Back to Transactions
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  const progress = getTransactionProgress();
  const completedTasks = tasks.filter(t => t.status === 'completed').length;
  const totalTasks = tasks.length;
  const sellers = getSellers();
  const buyers = getBuyers();
  const sharedDocIds = getSharedDocIds();
  const availableDocs = documents.filter(d => !sharedDocIds.includes(d.id));

  const displayAddress = property?.address || transaction.manual_address || 'Property Address';

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      {/* Header */}
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
        <div className="max-w-7xl mx-auto px-4 py-6">
          <div className="flex items-center gap-4 mb-4">
            <Button 
              variant="ghost" 
              size="icon"
              onClick={() => navigate(createPageUrl("Transactions"))}
              className="text-white hover:bg-white/20"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-1">
                <FileText className="w-5 h-5" />
                <h1 className="text-2xl font-bold">Transaction Details</h1>
              </div>
              <p className="text-white/90 text-sm">{displayAddress}</p>
            </div>
            <Badge className="bg-white/20 text-white border-white/30 px-4 py-2 capitalize">
              {transaction.status}
            </Badge>
          </div>
          
          {/* Quick Stats in Header */}
          <div className="grid grid-cols-3 gap-4">
            <div className="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
              <div className="text-2xl font-bold">${(transaction.contract_price || 0).toLocaleString()}</div>
              <div className="text-xs text-white/80">Contract Price</div>
            </div>
            <div className="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
              <div className="text-2xl font-bold">{completedTasks}/{totalTasks}</div>
              <div className="text-xs text-white/80">Tasks Done</div>
            </div>
            <div className="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
              <div className="text-2xl font-bold">{documents.length}</div>
              <div className="text-xs text-white/80">Documents</div>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
        {/* Tabs */}
        <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
          <TabsList className="grid w-full grid-cols-4 mb-6">
            <TabsTrigger value="overview">Overview</TabsTrigger>
            <TabsTrigger value="tasks">Tasks ({totalTasks})</TabsTrigger>
            <TabsTrigger value="documents">Documents ({documents.length})</TabsTrigger>
            <TabsTrigger value="deal_room">
              <Shield className="w-4 h-4 mr-1" />
              Deal Room
            </TabsTrigger>
          </TabsList>

          {/* Overview Tab */}
          <TabsContent value="overview" className="space-y-6">
            {/* Progress Card */}
            <Card className="shadow-xl border-2 border-indigo-200">
              <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50">
                <CardTitle className="flex items-center gap-2">
                  <TrendingUp className="w-5 h-5 text-indigo-600" />
                  Transaction Progress
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-6 space-y-6">
                <div>
                  <div className="flex justify-between items-center mb-3">
                    <span className="text-sm font-medium">Overall Completion</span>
                    <span className="text-2xl font-bold text-indigo-600">{Math.round(progress)}%</span>
                  </div>
                  <Progress value={progress} className="h-4" />
                  <p className="text-xs text-slate-500 mt-2">{completedTasks} of {totalTasks} tasks completed</p>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div className="text-sm text-blue-700 mb-1 font-medium">Listing Side</div>
                    <div className="text-3xl font-bold text-blue-600">
                      {transaction.listing_side_progress || 0}%
                    </div>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <div className="text-sm text-purple-700 mb-1 font-medium">Selling Side</div>
                    <div className="text-3xl font-bold text-purple-600">
                      {transaction.selling_side_progress || 0}%
                    </div>
                  </div>
                </div>

                {/* Important Dates */}
                {transaction.important_dates && (
                  <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 className="font-semibold mb-3 flex items-center gap-2 text-blue-900">
                      <Calendar className="w-4 h-4" />
                      Key Dates
                    </h4>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                      {transaction.important_dates.closing_date && (
                        <div className="bg-white p-3 rounded border-l-4 border-l-indigo-600">
                          <div className="text-slate-600 text-xs mb-1">üéØ Closing</div>
                          <div className="font-bold text-indigo-600">
                            {format(new Date(transaction.important_dates.closing_date), 'MMM dd, yyyy')}
                          </div>
                        </div>
                      )}
                      {transaction.important_dates.inspection_deadline && (
                        <div className="bg-white p-3 rounded">
                          <div className="text-slate-600 text-xs mb-1">Inspection</div>
                          <div className="font-semibold">
                            {format(new Date(transaction.important_dates.inspection_deadline), 'MMM dd')}
                          </div>
                        </div>
                      )}
                      {transaction.important_dates.financing_deadline && (
                        <div className="bg-white p-3 rounded">
                          <div className="text-slate-600 text-xs mb-1">Financing</div>
                          <div className="font-semibold">
                            {format(new Date(transaction.important_dates.financing_deadline), 'MMM dd')}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Property Card */}
            {property && (
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Home className="w-5 h-5" />
                    Property Information
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div>
                      <h3 className="font-bold text-xl mb-2">{property.address}</h3>
                      <p className="text-slate-600">
                        {property.city}, {property.state} {property.zip_code}
                      </p>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                      {property.bedrooms && (
                        <div className="bg-blue-50 p-3 rounded-lg text-center">
                          <div className="font-bold text-xl">{property.bedrooms}</div>
                          <div className="text-slate-600 text-xs">Bedrooms</div>
                        </div>
                      )}
                      {property.bathrooms && (
                        <div className="bg-purple-50 p-3 rounded-lg text-center">
                          <div className="font-bold text-xl">{property.bathrooms}</div>
                          <div className="text-slate-600 text-xs">Bathrooms</div>
                        </div>
                      )}
                      {property.square_feet && (
                        <div className="bg-green-50 p-3 rounded-lg text-center">
                          <div className="font-bold text-lg">{property.square_feet.toLocaleString()}</div>
                          <div className="text-slate-600 text-xs">Sq Ft</div>
                        </div>
                      )}
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}
          </TabsContent>

          {/* Tasks Tab */}
          <TabsContent value="tasks">
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <span className="flex items-center gap-2">
                    <CheckCircle2 className="w-5 h-5 text-indigo-600" />
                    Transaction Tasks
                  </span>
                  <Badge variant="outline">{completedTasks}/{totalTasks} Complete</Badge>
                </CardTitle>
              </CardHeader>
              <CardContent>
                {tasks.length > 0 ? (
                  <div className="space-y-3">
                    {tasks.map(task => (
                      <div 
                        key={task.id}
                        className="flex items-start gap-3 p-4 bg-slate-50 rounded-lg hover:shadow-md transition-shadow"
                      >
                        <div className={`w-3 h-3 rounded-full mt-2 flex-shrink-0 ${
                          task.status === 'completed' ? 'bg-green-500' :
                          task.priority === 'critical' ? 'bg-red-500' :
                          task.priority === 'high' ? 'bg-orange-500' : 'bg-blue-500'
                        }`}></div>
                        <div className="flex-1">
                          <div className={`font-medium ${task.status === 'completed' ? 'line-through text-slate-500' : ''}`}>
                            {task.title}
                          </div>
                          {task.description && (
                            <div className="text-sm text-slate-600 mt-1">{task.description}</div>
                          )}
                          <div className="flex items-center gap-3 mt-2">
                            {task.due_date && (
                              <div className="text-xs text-slate-500 flex items-center gap-1">
                                <Clock className="w-3 h-3" />
                                Due: {format(new Date(task.due_date), 'MMM dd, yyyy')}
                              </div>
                            )}
                            {task.task_type && (
                              <Badge variant="outline" className="text-xs capitalize">
                                {task.task_type}
                              </Badge>
                            )}
                          </div>
                        </div>
                        <Badge className={
                          task.status === 'completed' ? 'bg-green-100 text-green-800' :
                          task.status === 'in_progress' ? 'bg-blue-100 text-blue-800' :
                          'bg-yellow-100 text-yellow-800'
                        }>
                          {task.status === 'completed' && <CheckCircle2 className="w-3 h-3 mr-1" />}
                          {task.status}
                        </Badge>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12">
                    <CheckCircle2 className="w-12 h-12 mx-auto mb-3 text-slate-300" />
                    <p className="text-slate-600">No tasks for this transaction</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* Documents Tab */}
          <TabsContent value="documents">
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <FileText className="w-5 h-5 text-indigo-600" />
                  Transaction Documents
                </CardTitle>
              </CardHeader>
              <CardContent>
                {documents.length > 0 ? (
                  <div className="space-y-2">
                    {documents.map(doc => (
                      <div 
                        key={doc.id}
                        className="flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors border border-slate-200"
                      >
                        <div className="flex items-center gap-3 flex-1">
                          <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <FileText className="w-5 h-5 text-blue-600" />
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="font-medium truncate">{doc.document_name}</div>
                            {doc.category && (
                              <Badge variant="outline" className="text-xs mt-1 capitalize">
                                {doc.category.replace('_', ' ')}
                              </Badge>
                            )}
                            <div className="text-xs text-slate-400 mt-1">
                              Uploaded {format(new Date(doc.created_date), 'MMM dd, yyyy')}
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <Button 
                            size="sm" 
                            variant="ghost"
                            onClick={() => setPreviewDocument(doc)}
                            className="hover:bg-blue-100"
                          >
                            <Eye className="w-4 h-4" />
                          </Button>
                          <Button 
                            size="sm" 
                            variant="ghost"
                            onClick={async () => {
                              try {
                                if (doc.file_url.startsWith('private://')) {
                                  const { signed_url } = await base44.integrations.Core.CreateFileSignedUrl({
                                    file_uri: doc.file_url,
                                    expires_in: 3600
                                  });
                                  window.open(signed_url, '_blank');
                                } else {
                                  window.open(doc.file_url, '_blank');
                                }
                              } catch (error) {
                                toast.error('Failed to download document');
                              }
                            }}
                            className="hover:bg-green-100"
                          >
                            <Download className="w-4 h-4" />
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12">
                    <FileText className="w-12 h-12 mx-auto mb-3 text-slate-300" />
                    <p className="text-slate-600">No documents for this transaction</p>
                    <p className="text-sm text-slate-500 mt-2">Upload documents through the Documents page</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* Deal Room Tab */}
          <TabsContent value="deal_room" className="space-y-6">
            <Card className="border-2 border-indigo-200">
              <CardContent className="p-6">
                <div className="flex items-start gap-4">
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                    <Shield className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <h3 className="text-lg font-bold text-slate-900 mb-1">Secure Deal Room</h3>
                    <p className="text-sm text-slate-600">
                      Share documents with sellers, buyers, and other parties involved in this transaction
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Seller Portal */}
              <Card>
                <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50">
                  <CardTitle className="flex items-center gap-2">
                    <Users className="w-5 h-5 text-indigo-600" />
                    Share with Sellers
                  </CardTitle>
                </CardHeader>
                <CardContent className="pt-6 space-y-4">
                  {sellers.length > 0 ? (
                    <>
                      <div className="space-y-2">
                        <Label className="text-sm font-semibold">Select Sellers:</Label>
                        {sellers.map((seller, index) => {
                          const hasAccess = hasAccessForEmail(seller.email, 'seller');
                          return (
                            <div
                              key={index}
                              className={`flex items-start gap-3 p-3 rounded-lg border ${
                                hasAccess ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200'
                              }`}
                            >
                              <Checkbox
                                checked={selectedSellerEmails.includes(seller.email)}
                                onCheckedChange={() => {
                                  setSelectedSellerEmails(prev =>
                                    prev.includes(seller.email)
                                      ? prev.filter(e => e !== seller.email)
                                      : [...prev, seller.email]
                                  );
                                }}
                                className="mt-1"
                              />
                              <div className="flex-1">
                                <div className="font-semibold text-sm">
                                  {seller.name}
                                  {hasAccess && <span className="text-xs text-green-600 ml-2">(Has Access)</span>}
                                </div>
                                <div className="text-xs text-slate-600">{seller.email}</div>
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      {availableDocs.length > 0 && (
                        <div className="space-y-2">
                          <Label className="text-sm font-semibold">Select Documents to Share:</Label>
                          <div className="border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2 bg-slate-50">
                            {availableDocs.map(doc => (
                              <div key={doc.id} className="flex items-center gap-2">
                                <Checkbox
                                  checked={selectedSellerDocuments.includes(doc.id)}
                                  onCheckedChange={() => {
                                    setSelectedSellerDocuments(prev =>
                                      prev.includes(doc.id) ? prev.filter(id => id !== doc.id) : [...prev, doc.id]
                                    );
                                  }}
                                />
                                <div className="flex-1 min-w-0">
                                  <span className="text-sm truncate block">{doc.document_name}</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      <Button
                        onClick={() => handleCreateAccess('seller')}
                        disabled={isCreatingSeller || selectedSellerEmails.length === 0}
                        className="w-full bg-gradient-to-r from-indigo-600 to-purple-600"
                      >
                        {isCreatingSeller ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Processing...
                          </>
                        ) : (
                          <>
                            <UserPlus className="w-4 h-4 mr-2" />
                            Grant Seller Access ({selectedSellerEmails.length})
                          </>
                        )}
                      </Button>

                      {clientPortalAccess.filter(a => a.access_type === 'seller').length > 0 && (
                        <div className="mt-4 pt-4 border-t space-y-2">
                          <Label className="text-sm font-semibold">Existing Seller Access:</Label>
                          {clientPortalAccess.filter(a => a.access_type === 'seller').map(access => {
                            const clientUser = allUsers.find(u => u.id === access.client_user_id);
                            return (
                              <div key={access.id} className="flex items-center justify-between p-2 bg-green-50 rounded-lg border border-green-200">
                                <div className="flex items-center gap-2">
                                  <CheckCircle2 className="w-4 h-4 text-green-600" />
                                  <span className="text-sm font-medium">{clientUser?.full_name || clientUser?.email}</span>
                                </div>
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => handleRevokeAccess(access.id)}
                                  className="text-red-600 hover:bg-red-50"
                                >
                                  <X className="w-4 h-4" />
                                </Button>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </>
                  ) : (
                    <div className="text-center py-8">
                      <Users className="w-12 h-12 mx-auto mb-3 text-slate-300" />
                      <p className="text-sm text-slate-500">No sellers added to this transaction</p>
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Buyer Portal */}
              <Card>
                <CardHeader className="bg-gradient-to-r from-emerald-50 to-teal-50">
                  <CardTitle className="flex items-center gap-2">
                    <User className="w-5 h-5 text-emerald-600" />
                    Share with Buyers
                  </CardTitle>
                </CardHeader>
                <CardContent className="pt-6 space-y-4">
                  {buyers.length > 0 ? (
                    <>
                      <div className="space-y-2">
                        <Label className="text-sm font-semibold">Select Buyers:</Label>
                        {buyers.map((buyer, index) => {
                          const hasAccess = hasAccessForEmail(buyer.email, 'buyer');
                          return (
                            <div
                              key={index}
                              className={`flex items-start gap-3 p-3 rounded-lg border ${
                                hasAccess ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200'
                              }`}
                            >
                              <Checkbox
                                checked={selectedBuyerEmails.includes(buyer.email)}
                                onCheckedChange={() => {
                                  setSelectedBuyerEmails(prev =>
                                    prev.includes(buyer.email)
                                      ? prev.filter(e => e !== buyer.email)
                                      : [...prev, buyer.email]
                                  );
                                }}
                                className="mt-1"
                              />
                              <div className="flex-1">
                                <div className="font-semibold text-sm">
                                  {buyer.name}
                                  {hasAccess && <span className="text-xs text-green-600 ml-2">(Has Access)</span>}
                                </div>
                                <div className="text-xs text-slate-600">{buyer.email}</div>
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      {availableDocs.length > 0 && (
                        <div className="space-y-2">
                          <Label className="text-sm font-semibold">Select Documents to Share:</Label>
                          <div className="border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2 bg-slate-50">
                            {availableDocs.map(doc => (
                              <div key={doc.id} className="flex items-center gap-2">
                                <Checkbox
                                  checked={selectedBuyerDocuments.includes(doc.id)}
                                  onCheckedChange={() => {
                                    setSelectedBuyerDocuments(prev =>
                                      prev.includes(doc.id) ? prev.filter(id => id !== doc.id) : [...prev, doc.id]
                                    );
                                  }}
                                />
                                <div className="flex-1 min-w-0">
                                  <span className="text-sm truncate block">{doc.document_name}</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      <Button
                        onClick={() => handleCreateAccess('buyer')}
                        disabled={isCreatingBuyer || selectedBuyerEmails.length === 0}
                        className="w-full bg-gradient-to-r from-emerald-600 to-teal-600"
                      >
                        {isCreatingBuyer ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Processing...
                          </>
                        ) : (
                          <>
                            <UserPlus className="w-4 h-4 mr-2" />
                            Grant Buyer Access ({selectedBuyerEmails.length})
                          </>
                        )}
                      </Button>

                      {clientPortalAccess.filter(a => a.access_type === 'buyer').length > 0 && (
                        <div className="mt-4 pt-4 border-t space-y-2">
                          <Label className="text-sm font-semibold">Existing Buyer Access:</Label>
                          {clientPortalAccess.filter(a => a.access_type === 'buyer').map(access => {
                            const clientUser = allUsers.find(u => u.id === access.client_user_id);
                            return (
                              <div key={access.id} className="flex items-center justify-between p-2 bg-green-50 rounded-lg border border-green-200">
                                <div className="flex items-center gap-2">
                                  <CheckCircle2 className="w-4 h-4 text-green-600" />
                                  <span className="text-sm font-medium">{clientUser?.full_name || clientUser?.email}</span>
                                </div>
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => handleRevokeAccess(access.id)}
                                  className="text-red-600 hover:bg-red-50"
                                >
                                  <X className="w-4 h-4" />
                                </Button>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </>
                  ) : (
                    <div className="text-center py-8">
                      <User className="w-12 h-12 mx-auto mb-3 text-slate-300" />
                      <p className="text-sm text-slate-500">No buyers added to this transaction</p>
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>
          </TabsContent>
        </Tabs>
      </div>

      {previewDocument && (
        <DocumentPreviewModal
          document={previewDocument}
          onClose={() => setPreviewDocument(null)}
        />
      )}
    </div>
  );
}
import React from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import { createPageUrl } from "@/utils";

export default function TransactionEdit() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const transactionId = searchParams.get('id');

  console.log("=== TRANSACTION EDIT PAGE LOADED ===");
  console.log("Transaction ID from URL:", transactionId);

  return (
    <div className="min-h-screen bg-white p-8">
      <div className="max-w-4xl mx-auto">
        <Button
          variant="outline"
          onClick={() => navigate(createPageUrl('Transactions'))}
          className="mb-4"
        >
          <ArrowLeft className="w-4 h-4 mr-2" />
          Back to Transactions
        </Button>

        <div className="bg-blue-100 border-2 border-blue-500 rounded-lg p-8">
          <h1 className="text-3xl font-bold text-blue-900 mb-4">
            Transaction Edit Page - TEST
          </h1>
          
          <div className="space-y-2 text-lg">
            <p className="font-semibold">This is the TransactionEdit page!</p>
            <p>Transaction ID: <span className="text-blue-600">{transactionId || "No ID"}</span></p>
            <p>If you see this, the routing is working!</p>
          </div>

          <div className="mt-6 p-4 bg-yellow-100 rounded">
            <p className="font-semibold text-yellow-900">Debug Info:</p>
            <p className="text-sm">URL: {window.location.href}</p>
            <p className="text-sm">Search Params: {window.location.search}</p>
          </div>
        </div>
      </div>
    </div>
  );
}
import React, { useState, useMemo, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { Link, useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import {
  Plus, Search, Edit, Trash2, Loader2, X,
  DollarSign, Calendar, User, Home, CheckCircle2,
  TrendingUp, Sparkles, CheckSquare, AlertTriangle, ArrowLeft, FileText, Brain
} from "lucide-react";
import { toast } from 'sonner';
import AITaskGenerator from '../components/transactions/AITaskGenerator';

// Contract phases for task generation
const CONTRACT_PHASES = [
  {
    id: "contract_escrow",
    title: "Contract & Escrow Setup",
    weight: 10,
    task_type: "contract",
    tasks: [
      "Upload executed contract to system",
      "Open escrow and verify earnest money deposit",
      "Send contract to title company / attorney",
      "Confirm escrow receipt shared with all parties",
      "Verify key contract dates (inspection, financing, closing)",
      "Add contract summary to property timeline"
    ]
  },
  {
    id: "disclosures",
    title: "Disclosures & Documents",
    weight: 10,
    task_type: "documentation",
    tasks: [
      "Deliver seller's property disclosure (SPDS, condo docs, etc.)",
      "Provide HOA documents and estoppel letter (if applicable)",
      "Upload lead-based paint disclosure (if pre-1978)",
      "Request preliminary title search and commitment",
      "Review and clear any title exceptions"
    ]
  },
  {
    id: "inspections",
    title: "Inspections",
    weight: 15,
    task_type: "inspection",
    tasks: [
      "Schedule home inspection",
      "Grant access for inspector / appraiser",
      "Review inspection report",
      "Negotiate repair requests or credits",
      "Approve inspection addendum (if applicable)",
      "Schedule re-inspection (if needed)"
    ]
  },
  {
    id: "appraisal_financing",
    title: "Appraisal & Financing",
    weight: 15,
    task_type: "financing",
    tasks: [
      "Lender orders appraisal",
      "Appraiser receives access and property details",
      "Appraisal completed ‚Äî confirm value",
      "Handle low appraisal negotiations (if any)",
      "Track loan underwriting progress",
      "Receive loan approval / commitment letter"
    ]
  },
  {
    id: "title_insurance",
    title: "Title, HOA & Insurance",
    weight: 10,
    task_type: "documentation",
    tasks: [
      "Review title report",
      "Resolve title or lien issues",
      "Obtain HOA approval letter (if needed)",
      "Buyer secures homeowner's insurance policy",
      "Provide policy binder to lender and title"
    ]
  },
  {
    id: "repairs",
    title: "Repairs & Pre-Closing Tasks",
    weight: 15,
    task_type: "documentation",
    tasks: [
      "Hire and schedule contractors (if seller agrees to repairs)",
      "Upload invoices or proof of repairs",
      "Provide repair affidavit",
      "Schedule final walkthrough date/time",
      "Confirm utility transfer dates"
    ]
  },
  {
    id: "closing_prep",
    title: "Closing Preparation",
    weight: 15,
    task_type: "closing",
    tasks: [
      "Confirm closing date, time, and location",
      "Review settlement statement (CD / ALTA)",
      "Verify wire instructions for all funds",
      "Ensure all documents are fully signed",
      "Collect warranties, remotes, manuals for buyer",
      "Coordinate final key handoff"
    ]
  },
  {
    id: "closing_day",
    title: "Closing Day",
    weight: 5,
    task_type: "closing",
    tasks: [
      "Attend or confirm remote closing",
      "Verify funds disbursed correctly",
      "Obtain final signed closing package",
      "Update MLS to Closed",
      "Confirm commission disbursement"
    ]
  },
  {
    id: "post_closing",
    title: "Post-Closing",
    weight: 5,
    task_type: "marketing",
    tasks: [
      "Send thank-you message / closing gift",
      "Request testimonial and Google review",
      "Update CRM and transaction archive",
      "Follow up 30 days after closing for feedback/referral"
    ]
  }
];

export default function TransactionsPage() {
  const queryClient = useQueryClient();
  const navigate = useNavigate();
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingTransaction, setEditingTransaction] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [statusFilter, setStatusFilter] = useState("all");
  const [showAITaskGenerator, setShowAITaskGenerator] = useState(false);
  const [selectedTransactionForAI, setSelectedTransactionForAI] = useState(null);

  // Auto-open modal if prefill data exists
  useEffect(() => {
    const prefillData = sessionStorage.getItem('prefillTransaction');
    if (prefillData) {
      setIsModalOpen(true);
      toast.success('Transaction form pre-filled with document data!');
    }
  }, []);

  const { data: currentUser } = useQuery({
    queryKey: ["user"],
    queryFn: () => base44.auth.me(),
    staleTime: Infinity,
    refetchOnMount: false,
    refetchOnWindowFocus: false
  });

  // Fetch data with aggressive caching
  const { data: transactions = [], isLoading: loadingTransactions } = useQuery({
    queryKey: ["transactions"],
    queryFn: () => base44.entities.Transaction.list(),
    staleTime: 10 * 60 * 1000,
    gcTime: 20 * 60 * 1000,
    refetchInterval: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false
  });

  // Try to use cached properties from Layout first
  const { data: cachedProperties } = useQuery({
    queryKey: ['properties', currentUser?.id],
    enabled: false
  });

  const { data: properties = [], isLoading: loadingProperties } = useQuery({
    queryKey: ["properties"],
    queryFn: async () => {
      // Use cached data if available
      if (cachedProperties && cachedProperties.length > 0) {
        return cachedProperties;
      }
      return await base44.entities.Property.list();
    },
    staleTime: 30 * 60 * 1000, // 30 minutes
    gcTime: 60 * 60 * 1000, // 1 hour
    refetchInterval: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false
  });

  const { data: users = [], isLoading: loadingUsers } = useQuery({
    queryKey: ["users"],
    queryFn: () => base44.entities.User.list(),
    staleTime: 30 * 60 * 1000,
    gcTime: 60 * 60 * 1000,
    refetchInterval: false,
    refetchOnMount: false,
    refetchOnWindowFocus: false
  });

  // Fetch tasks to show task counts
  const { data: allTasks = [] } = useQuery({
    queryKey: ["tasks"],
    queryFn: () => base44.entities.Task.list(),
    staleTime: 10 * 60 * 1000,
    gcTime: 20 * 60 * 1000,
    refetchOnMount: false,
    refetchOnWindowFocus: false
  });

  // Fetch all documents for AI task generator
  const { data: allDocuments = [] } = useQuery({
    queryKey: ["documents"],
    queryFn: () => base44.entities.Document.list(),
    staleTime: 10 * 60 * 1000,
    gcTime: 20 * 60 * 1000,
    refetchOnMount: false,
    refetchOnWindowFocus: false
  });

  const { data: teamMembers = [] } = useQuery({
    queryKey: ['teamMembers'],
    queryFn: () => base44.entities.TeamMember.list(),
    staleTime: 30 * 60 * 1000,
    gcTime: 60 * 60 * 1000,
    refetchOnMount: false,
    refetchOnWindowFocus: false
  });

  // Save mutation
  const saveMutation = useMutation({
    mutationFn: (data) => {
      if (editingTransaction) {
        return base44.entities.Transaction.update(editingTransaction.id, data);
      }
      return base44.entities.Transaction.create(data);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(["transactions"]);
      toast.success(editingTransaction ? "Transaction updated!" : "Transaction created!");
      setIsModalOpen(false);
      setEditingTransaction(null);
    },
    onError: (error) => {
      toast.error(`Error: ${error.message}`);
    }
  });

  // Delete mutation
  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Transaction.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(["transactions"]);
      toast.success("Transaction deleted!");
    }
  });

  // Calculate task counts per property - ENHANCED with overdue tracking
  const taskCountsByProperty = useMemo(() => {
    const counts = {};
    const now = new Date();
    now.setHours(0, 0, 0, 0); // Normalize 'now' to start of day for accurate comparison

    allTasks.forEach(task => {
      if (task.property_id && task.package_name) { // Only count contract tasks
        if (!counts[task.property_id]) {
          counts[task.property_id] = { total: 0, remaining: 0, completed: 0, overdue: 0 };
        }
        counts[task.property_id].total++;

        if (task.status === 'completed') {
          counts[task.property_id].completed++;
        } else {
          counts[task.property_id].remaining++;

          // Check if overdue
          if (task.due_date) {
            try {
              const dueDate = new Date(task.due_date);
              dueDate.setHours(0, 0, 0, 0); // Normalize task due date to start of day
              if (dueDate < now) {
                counts[task.property_id].overdue++;
              }
            } catch (e) {
              console.error('Error parsing due date:', e);
            }
          }
        }
      }
    });
    return counts;
  }, [allTasks]);

  // Helper to get property image
  const getPropertyImage = (property) => {
    if (property?.primary_photo_url) {
      return property.primary_photo_url;
    }
    
    // Use Unsplash placeholder based on property type
    const propertyType = property?.property_type || 'single_family';

    const imageMap = {
      'single_family': `https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=400&h=300&fit=crop`,
      'condo': `https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=400&h=300&fit=crop`,
      'townhouse': `https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=400&h=300&fit=crop`,
      'multi_family': `https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400&h=300&fit=crop`,
      'land': `https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=400&h=300&fit=crop`,
      'commercial': `https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=400&h=300&fit=crop`
    };
    
    return imageMap[propertyType] || imageMap['single_family'];
  };

  // Filter transactions
  const filteredTransactions = useMemo(() => {
    return transactions.filter(t => {
      const property = properties.find(p => p.id === t.property_id);
      const address = (property?.address || t.manual_address || "").toLowerCase();
      const matchesSearch = address.includes(searchTerm.toLowerCase());
      const matchesStatus = statusFilter === "all" || t.status === statusFilter;
      return matchesSearch && matchesStatus;
    });
  }, [transactions, properties, searchTerm, statusFilter]);

  const isLoading = loadingTransactions || loadingProperties || loadingUsers;

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-12 h-12 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="page-container space-y-6">
      {/* Header */}
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-8 text-white">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={() => navigate(-1)}
              className="text-white hover:bg-white/20 -ml-2"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div>
              <h1 className="text-3xl font-bold mb-2">Transactions</h1>
              <p className="text-white/80">Manage your deals and commissions</p>
            </div>
          </div>
          <Button
            onClick={() => {
              setEditingTransaction(null);
              setIsModalOpen(true);
            }}
            className="bg-white text-indigo-600 hover:bg-white/90"
            size="lg"
          >
            <Plus className="w-5 h-5 mr-2" />
            New Transaction
          </Button>
        </div>
      </div>

      {/* Filters */}
      <Card>
        <CardContent className="p-4 flex gap-4">
          <div className="relative flex-1">
            <Search className="w-4 h-4 absolute left-3 top-3 text-slate-400" />
            <Input
              placeholder="Search by property..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-10"
            />
          </div>
          <Select value={statusFilter} onValueChange={setStatusFilter}>
            <SelectTrigger className="w-[200px]">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Status</SelectItem>
              <SelectItem value="active">Active</SelectItem>
              <SelectItem value="pending">Pending</SelectItem>
              <SelectItem value="closed">Closed</SelectItem>
              <SelectItem value="cancelled">Cancelled</SelectItem>
            </SelectContent>
          </Select>
        </CardContent>
      </Card>

      {/* Transactions Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredTransactions.map(transaction => {
          const property = properties.find(p => p.id === transaction.property_id);
          const displayAddress = property?.address || transaction.manual_address || "Unknown Property";
          const listingAgent = users.find(u => u.id === transaction.roles?.listing_agent_id);
          const taskInfo = transaction.property_id ? taskCountsByProperty[transaction.property_id] : null;

          const statusColors = {
            active: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
            pending: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
            closed: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
            cancelled: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300'
          };

          return (
            <Card 
              key={transaction.id} 
              className="hover:shadow-lg transition-all overflow-hidden cursor-pointer"
              onClick={() => {
                if (property?.id) {
                  navigate(createPageUrl(`PropertyDetail?id=${property.id}`));
                }
              }}
            >
              {/* Property Image Header - ALWAYS SHOW */}
              <div className="relative h-40 bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900 dark:to-purple-900 overflow-hidden">
                <img
                  src={property ? getPropertyImage(property) : 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop'}
                  alt={displayAddress}
                  className="w-full h-full object-cover"
                  onError={(e) => {
                    e.target.onerror = null;
                    e.target.src = 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop'; // Fallback to a generic house image
                  }}
                />
                <div className="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent" />
                <div className="absolute bottom-3 left-3 right-3">
                  <p className="text-white font-bold text-base drop-shadow-lg line-clamp-2">
                    {displayAddress}
                  </p>
                  {property?.city && (
                    <p className="text-white/90 text-xs mt-1 drop-shadow">
                      {property.city}, {property.state}
                    </p>
                  )}
                </div>
              </div>

              <CardHeader className="pt-4">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 flex-wrap">
                      <Badge className={statusColors[transaction.status]}>
                        {transaction.status}
                      </Badge>

                      {/* Overdue Tasks Badge - RED ALERT */}
                      {taskInfo && taskInfo.overdue > 0 && (
                        <Link
                          to={createPageUrl(`Tasks?property_id=${transaction.property_id}&urgency=overdue`)}
                          className="inline-block"
                        >
                          <Badge
                            className="cursor-pointer bg-red-600 text-white hover:bg-red-700 transition-all shadow-lg animate-pulse border-2 border-red-700"
                          >
                            <AlertTriangle className="w-3 h-3 mr-1" />
                            {taskInfo.overdue} overdue!
                          </Badge>
                        </Link>
                      )}

                      {/* Regular Task Count Badge - SIMPLIFIED with red overdue number */}
                      {taskInfo && taskInfo.total > 0 && (
                        <Link
                          to={createPageUrl(`Tasks?property_id=${transaction.property_id}`)}
                          className="inline-block"
                        >
                          <Badge
                            variant="outline"
                            className={`cursor-pointer hover:shadow-md transition-all ${
                              taskInfo.remaining === 0
                                ? 'bg-green-100 text-green-700 border-green-300 dark:bg-green-900/30 dark:text-green-300 hover:bg-green-200'
                                : taskInfo.remaining <= 3
                                ? 'bg-blue-100 text-blue-700 border-blue-300 dark:bg-blue-900/30 dark:text-blue-300 hover:bg-blue-200'
                                : 'bg-purple-100 text-purple-700 border-purple-300 dark:bg-purple-900/30 dark:text-purple-300 hover:bg-purple-200'
                            }`}
                          >
                            <CheckSquare className="w-3 h-3 mr-1" />
                            {taskInfo.remaining === 0 ? (
                              '‚úì All Done'
                            ) : (
                              <span className="flex items-center gap-1">
                                {taskInfo.remaining} tasks left
                                {taskInfo.overdue > 0 && (
                                  <span className="text-red-600 dark:text-red-400 font-bold ml-1">
                                    {taskInfo.overdue}
                                  </span>
                                )}
                              </span>
                            )}
                          </Badge>
                        </Link>
                      )}
                    </div>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex items-center gap-2 text-sm">
                  <DollarSign className="w-4 h-4 text-green-600" />
                  <span className="font-semibold">
                    ${transaction.contract_price?.toLocaleString() || "0"}
                  </span>
                </div>

                {listingAgent && (
                  <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                    <User className="w-4 h-4" />
                    <span>{listingAgent.full_name || listingAgent.email}</span>
                  </div>
                )}

                {/* Buyer's Agent & Team Information */}
                {(() => {
                  // Parse selling agents info
                  let sellingAgentsData = [];
                  try {
                    if (transaction.selling_agents_info) {
                      const parsed = typeof transaction.selling_agents_info === 'string' 
                        ? JSON.parse(transaction.selling_agents_info) 
                        : transaction.selling_agents_info;
                      sellingAgentsData = Array.isArray(parsed) ? parsed : [];
                    }
                  } catch (e) {
                    console.error('Error parsing selling_agents_info:', e);
                  }

                  // Check if selling agent is a user in the system
                  const sellingAgentUser = users.find(u => u.id === transaction.selling_agent_id);
                  
                  // Check if selling agent is a team member
                  let sellingAgentTeamMember = null;
                  if (!sellingAgentUser && sellingAgentsData.length > 0) {
                    sellingAgentTeamMember = teamMembers.find(tm => 
                      tm.full_name === sellingAgentsData[0]?.name || 
                      tm.email === sellingAgentsData[0]?.email
                    );
                  }

                  const displayName = sellingAgentUser?.full_name || 
                                     sellingAgentsData[0]?.name || 
                                     transaction.selling_agent_name || 
                                     null;
                  
                  const displayOffice = sellingAgentsData[0]?.office ||
                                       sellingAgentUser?.brokerage_name || 
                                       sellingAgentTeamMember?.brokerage || 
                                       transaction.selling_agent_office || 
                                       null;

                  if (!displayName) return null;

                  return (
                    <div className="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 border border-purple-200 dark:border-purple-800">
                      <p className="text-xs font-semibold text-purple-700 dark:text-purple-300 mb-1">
                        Buyer's Agent
                      </p>
                      <div className="flex items-start gap-2">
                        <User className="w-4 h-4 text-purple-600 mt-0.5" />
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-semibold text-purple-900 dark:text-purple-100">
                            {displayName}
                          </p>
                          {displayOffice && (
                            <p className="text-xs text-purple-700 dark:text-purple-300 mt-0.5">
                              {displayOffice}
                            </p>
                          )}
                          {sellingAgentsData.length > 1 && (
                            <p className="text-xs text-purple-600 dark:text-purple-400 mt-1">
                              +{sellingAgentsData.length - 1} team member{sellingAgentsData.length > 2 ? 's' : ''}
                            </p>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })()}
                
                {/* Task Progress Bar */}
                {taskInfo && taskInfo.total > 0 && (
                  <Link
                    to={createPageUrl(`Tasks?property_id=${transaction.property_id}`)}
                    className="block"
                  >
                    <div className="space-y-1 pt-2 border-t cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 -mx-6 px-6 py-3 transition-colors rounded-lg">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-slate-600 dark:text-slate-400 font-medium">Contract Progress</span>
                        <span className="text-slate-700 dark:text-slate-300 font-semibold">
                          {taskInfo.completed}/{taskInfo.total} complete
                        </span>
                      </div>
                      <div className="h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                        <div
                          className="h-full bg-gradient-to-r from-purple-500 to-indigo-500 transition-all duration-300"
                          style={{ width: `${(taskInfo.completed / taskInfo.total) * 100}%` }}
                        />
                      </div>
                      <p className="text-[10px] text-slate-500 dark:text-slate-400 text-center mt-1">
                        Click to view tasks ‚Üí
                      </p>
                    </div>
                  </Link>
                )}

                <div className="flex gap-2 pt-3 border-t">
                  <Button
                    onClick={(e) => {
                      e.stopPropagation();
                      navigate(createPageUrl(`TransactionDetail?id=${transaction.id}`));
                    }}
                    variant="default"
                    size="sm"
                    className="flex-1"
                  >
                    <FileText className="w-4 h-4 mr-1" />
                    View Details
                  </Button>
                  <Button
                    onClick={(e) => {
                      e.stopPropagation();
                      setEditingTransaction(transaction);
                      setIsModalOpen(true);
                    }}
                    variant="outline"
                    size="sm"
                  >
                    <Edit className="w-4 h-4" />
                  </Button>
                  <Button
                    onClick={(e) => {
                      e.stopPropagation();
                      if (confirm("Delete this transaction?")) {
                        deleteMutation.mutate(transaction.id);
                      }
                    }}
                    variant="outline"
                    size="sm"
                    className="text-red-600 hover:text-red-700"
                  >
                    <Trash2 className="w-4 h-4" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          );
        })}
      </div>

      {filteredTransactions.length === 0 && (
        <Card>
          <CardContent className="p-12 text-center">
            <TrendingUp className="w-16 h-16 mx-auto text-slate-300 mb-4" />
            <h3 className="text-lg font-semibold mb-2">No Transactions Found</h3>
            <p className="text-slate-600 mb-4">Start by creating your first transaction</p>
            <Button onClick={() => setIsModalOpen(true)}>
              <Plus className="w-4 h-4 mr-2" />
              Create Transaction
            </Button>
          </CardContent>
        </Card>
      )}

      {/* Transaction Form Modal */}
      {isModalOpen && (
        <TransactionModal
          transaction={editingTransaction}
          properties={properties}
          users={users}
          onSave={(data) => saveMutation.mutate(data)}
          onClose={() => {
            setIsModalOpen(false);
            setEditingTransaction(null);
          }}
        />
      )}

      {/* AI Task Generator Modal */}
      {showAITaskGenerator && selectedTransactionForAI && (
        <AITaskGenerator
          transaction={selectedTransactionForAI}
          property={properties.find(p => p.id === selectedTransactionForAI.property_id)}
          document={allDocuments.find(d => d.transaction_id === selectedTransactionForAI.id)}
          users={users}
          onTasksGenerated={() => {
            queryClient.invalidateQueries(['tasks']);
            queryClient.invalidateQueries(['transactionTasks']);
          }}
          onClose={() => {
            setShowAITaskGenerator(false);
            setSelectedTransactionForAI(null);
          }}
        />
      )}
    </div>
  );
}

// New Simplified Modal Component
function TransactionModal({ transaction, properties, users, onSave, onClose }) {
  const queryClient = useQueryClient();

  // Check for prefilled data from document processing
  const [prefillData] = useState(() => {
    const stored = sessionStorage.getItem('prefillTransaction');
    if (stored) {
      sessionStorage.removeItem('prefillTransaction');
      return JSON.parse(stored);
    }
    return null;
  });

  const [form, setForm] = useState({
    property_id: transaction?.property_id || prefillData?.property_id || "",
    manual_address: transaction?.manual_address || "",
    status: transaction?.status || "pending",
    transaction_type: transaction?.transaction_type || "sale",
    contract_price: transaction?.contract_price || prefillData?.contract_price || "",
    commission_listing: transaction?.commission_listing || prefillData?.commission_listing || 3,
    commission_selling: transaction?.commission_selling || prefillData?.commission_selling || 3,
    agent_split_percentage: transaction?.agent_split_percentage || 50,
    transaction_fee: transaction?.transaction_fee || 0,
    listing_agent_id: transaction?.roles?.listing_agent_id || "",
    title_company: transaction?.title_company || prefillData?.title_company || "",
    escrow_number: transaction?.escrow_number || prefillData?.escrow_number || "",
    offer_date: transaction?.important_dates?.offer_date || prefillData?.important_dates?.offer_date || "",
    acceptance_date: transaction?.important_dates?.acceptance_date || prefillData?.important_dates?.acceptance_date || "",
    inspection_deadline: transaction?.important_dates?.inspection_deadline || prefillData?.important_dates?.inspection_deadline || "",
    inspection_date: transaction?.important_dates?.inspection_date || prefillData?.important_dates?.inspection_date || "",
    appraisal_date: transaction?.important_dates?.appraisal_date || prefillData?.important_dates?.appraisal_date || "",
    financing_deadline: transaction?.important_dates?.financing_deadline || prefillData?.important_dates?.financing_deadline || "",
    mortgage_approval_date: transaction?.important_dates?.mortgage_approval_date || prefillData?.important_dates?.mortgage_approval_date || "",
    title_search_date: transaction?.important_dates?.title_search_date || prefillData?.important_dates?.title_search_date || "",
    final_walkthrough_date: transaction?.important_dates?.final_walkthrough_date || prefillData?.important_dates?.final_walkthrough_date || "",
    closing_date: transaction?.important_dates?.closing_date || prefillData?.important_dates?.closing_date || ""
  });

  // Track whether user is entering property manually or selecting from list
  // IMPORTANT: Lock the source type after creation (cannot be changed when editing)
  const [useManualAddress, setUseManualAddress] = useState(
    !!transaction?.manual_address
  );

  // Task generation state
  const [generateTasks, setGenerateTasks] = useState(false);
  const [isGeneratingTasks, setIsGeneratingTasks] = useState(false);
  const [showExistingTasks, setShowExistingTasks] = useState(false);

  // Fetch team members
  const { data: teamMembers = [] } = useQuery({
    queryKey: ['teamMembers'],
    queryFn: () => base44.entities.TeamMember.list()
  });

  const { data: currentUser } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me()
  });

  // Fetch existing tasks for this transaction's property
  const { data: existingTasks = [], refetch: refetchTasks } = useQuery({
    queryKey: ['transactionTasks', transaction?.property_id],
    queryFn: async () => {
      if (!transaction?.property_id) return [];
      const tasks = await base44.entities.Task.filter({ property_id: transaction.property_id });
      return tasks.filter(t => t.package_name); // Only contract tasks with package_name
    },
    enabled: !!transaction?.property_id
  });

  // Delete task mutation
  const deleteTaskMutation = useMutation({
    mutationFn: (taskId) => base44.entities.Task.delete(taskId),
    onSuccess: () => {
      refetchTasks();
      queryClient.invalidateQueries(['tasks']); // Invalidate general tasks query too
      toast.success("Task deleted!");
    },
    onError: (error) => {
      toast.error(`Error deleting task: ${error.message}`);
    }
  });

  // Initialize sellers from transaction or prefill data
  const [sellers, setSellers] = useState(() => {
    if (transaction?.sellers_info) {
      try {
        const parsed = typeof transaction.sellers_info === 'string'
          ? JSON.parse(transaction.sellers_info)
          : transaction.sellers_info;
        return Array.isArray(parsed) && parsed.length > 0 ? parsed : [{ name: "", email: "", cell_phone: "", home_phone: "" }];
      } catch {
        return [{ name: "", email: "", cell_phone: "", home_phone: "" }];
      }
    }
    if (prefillData?.sellers_info && Array.isArray(prefillData.sellers_info) && prefillData.sellers_info.length > 0) {
      return prefillData.sellers_info;
    }
    return [{ name: "", email: "", cell_phone: "", home_phone: "" }];
  });

  // Initialize buyers from transaction or prefill data
  const [buyers, setBuyers] = useState(() => {
    if (transaction?.buyers_info) {
      try {
        const parsed = typeof transaction.buyers_info === 'string'
          ? JSON.parse(transaction.buyers_info)
          : transaction.buyers_info;
        return Array.isArray(parsed) && parsed.length > 0 ? parsed : [{ name: "", email: "", cell_phone: "", home_phone: "" }];
      } catch {
        return [{ name: "", email: "", cell_phone: "", home_phone: "" }];
      }
    }
    if (prefillData?.buyers_info && Array.isArray(prefillData.buyers_info) && prefillData.buyers_info.length > 0) {
      return prefillData.buyers_info;
    }
    return [{ name: "", email: "", cell_phone: "", home_phone: "" }];
  });

  // Initialize selling agents from transaction or prefill data
  const [sellingAgents, setSellingAgents] = useState(() => {
    // First try selling_agents_info array
    if (transaction?.selling_agents_info) {
      try {
        const parsed = typeof transaction.selling_agents_info === 'string'
          ? JSON.parse(transaction.selling_agents_info)
          : transaction.selling_agents_info;
        if (Array.isArray(parsed) && parsed.length > 0) {
          // Enhance with office/license if missing
          return parsed.map(agent => {
            if (!agent.office || !agent.license) {
              // Try to find matching user
              const matchingUser = users.find(u => 
                u.full_name === agent.name || 
                u.email === agent.email
              );
              // Try to find matching team member
              const matchingTeamMember = teamMembers.find(tm => 
                tm.full_name === agent.name || 
                tm.email === agent.email
              );
              
              return {
                ...agent,
                office: agent.office || matchingUser?.brokerage_name || matchingTeamMember?.brokerage || transaction.selling_agent_office || "",
                license: agent.license || matchingUser?.license_number || ""
              };
            }
            return agent;
          });
        }
      } catch {
        // Continue to next check
      }
    }
    
    // If selling_agent_id exists, find the user and populate
    if (transaction?.selling_agent_id) {
      const sellingUser = users.find(u => u.id === transaction.selling_agent_id);
      if (sellingUser) {
        return [{
          name: sellingUser.full_name || "",
          email: sellingUser.email || "",
          cell_phone: sellingUser.phone || "",
          home_phone: "",
          role: "agent",
          office: sellingUser.brokerage_name || "",
          license: sellingUser.license_number || ""
        }];
      }
    }
    
    // Otherwise check legacy fields (selling_agent_name, etc.)
    if (transaction?.selling_agent_name) {
      return [{
        name: transaction.selling_agent_name,
        email: transaction.selling_agent_email || "",
        cell_phone: transaction.selling_agent_phone || "",
        home_phone: "",
        role: "agent",
        office: transaction.selling_agent_office || "",
        license: ""
      }];
    }
    
    // Try prefill data
    if (prefillData?.selling_agents_info && Array.isArray(prefillData.selling_agents_info) && prefillData.selling_agents_info.length > 0) {
      return prefillData.selling_agents_info;
    }
    
    return [{ name: "", email: "", cell_phone: "", home_phone: "", role: "agent", office: "", license: "" }];
  });

  const [commissions, setCommissions] = useState({
    total: 0,
    listingGross: 0,
    listingNet: 0,
    sellingGross: 0,
    sellingNet: 0
  });

  // Calculate commissions whenever price or rates change
  useEffect(() => {
    const price = parseFloat(form.contract_price) || 0;
    const listingRate = parseFloat(form.commission_listing) || 0;
    const sellingRate = parseFloat(form.commission_selling) || 0;
    const split = parseFloat(form.agent_split_percentage) || 50;
    const transFee = parseFloat(form.transaction_fee) || 0;

    if (price > 0) {
      const total = price * ((listingRate + sellingRate) / 100);
      const listingGross = price * (listingRate / 100);
      const listingNet = (listingGross * (split / 100)) - transFee;
      const sellingGross = price * (sellingRate / 100);
      const sellingNet = (sellingGross * (split / 100)) - transFee;

      setCommissions({
        total: Math.round(total),
        listingGross: Math.round(listingGross),
        listingNet: Math.round(listingNet),
        sellingGross: Math.round(sellingGross),
        sellingNet: Math.round(sellingNet)
      });
    } else {
      setCommissions({
        total: 0,
        listingGross: 0,
        listingNet: 0,
        sellingGross: 0,
        sellingNet: 0
      });
    }
  }, [form.contract_price, form.commission_listing, form.commission_selling, form.agent_split_percentage, form.transaction_fee]);

  const addSeller = () => {
    setSellers([...sellers, { name: "", email: "", cell_phone: "", home_phone: "" }]);
  };

  const removeSeller = (index) => {
    if (sellers.length > 1) {
      setSellers(sellers.filter((_, i) => i !== index));
    }
  };

  const updateSeller = (index, field, value) => {
    const updated = [...sellers];
    updated[index][field] = value;
    setSellers(updated);
  };

  const addBuyer = () => {
    setBuyers([...buyers, { name: "", email: "", cell_phone: "", home_phone: "" }]);
  };

  const removeBuyer = (index) => {
    if (buyers.length > 1) {
      setBuyers(buyers.filter((_, i) => i !== index));
    }
  };

  const updateBuyer = (index, field, value) => {
    const updated = [...buyers];
    updated[index][field] = value;
    setBuyers(updated);
  };

  const addSellingAgent = () => {
    setSellingAgents([...sellingAgents, { name: "", email: "", cell_phone: "", home_phone: "", role: "agent", office: "", license: "" }]);
  };

  const removeSellingAgent = (index) => {
    if (sellingAgents.length > 1) {
      setSellingAgents(sellingAgents.filter((_, i) => i !== index));
    }
  };

  const updateSellingAgent = (index, field, value) => {
    const updated = [...sellingAgents];
    updated[index][field] = value;
    setSellingAgents(updated);
  };

  // Function to auto-fill selling agent from team member or current user
  const fillFromTeamMember = (index, personId, isCurrentUser = false) => {
    let person;

    if (isCurrentUser) {
      person = currentUser;
    } else {
      person = teamMembers.find(m => m.id === personId);
    }

    if (person) {
      const updated = [...sellingAgents];
      updated[index] = {
        name: person.full_name || person.name || "",
        email: person.email || "",
        cell_phone: person.phone || person.cell_phone || "",
        home_phone: person.home_phone || "",
        role: updated[index].role || "agent",
        office: person.brokerage_name || person.brokerage || currentUser?.brokerage_name || "",
        license: person.license_number || ""
      };
      setSellingAgents(updated);
      toast.success(`Added ${person.full_name || person.name || 'team member'}`);
    }
  };

  const generateContractTasks = async (propertyId, assignedTo) => {
    setIsGeneratingTasks(true);
    try {
      const tasksToCreate = [];
      let dayOffset = 0;

      CONTRACT_PHASES.forEach(phase => {
        phase.tasks.forEach((taskTitle, index) => {
          const dueDate = new Date();
          dueDate.setDate(dueDate.getDate() + dayOffset);

          tasksToCreate.push({
            title: taskTitle,
            description: `${phase.title} - Task ${index + 1}`,
            property_id: propertyId,
            assigned_to: assignedTo,
            task_type: phase.task_type,
            priority: phase.weight >= 15 ? "high" : "medium",
            status: "pending",
            due_date: dueDate.toISOString().split('T')[0],
            package_name: phase.id
          });

          if ((index + 1) % 2 === 0) dayOffset++;
        });
        dayOffset += 2;
      });

      await base44.entities.Task.bulkCreate(tasksToCreate);

      toast.success(`‚ú® Generated ${tasksToCreate.length} contract tasks!`);
      refetchTasks(); // Refresh task list
      queryClient.invalidateQueries(['tasks']); // Invalidate general tasks query for card updates
      return true;
    } catch (error) {
      console.error("Error generating tasks:", error);
      toast.error("Failed to generate tasks");
      return false;
    } finally {
      setIsGeneratingTasks(false);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    // Validate: either property_id OR manual_address must be provided
    if (!useManualAddress && !form.property_id) {
      toast.error("Please select a property from the list");
      return;
    }

    if (useManualAddress && !form.manual_address.trim()) {
      toast.error("Please enter the property address");
      return;
    }

    if (!form.contract_price || parseFloat(form.contract_price) <= 0) {
      toast.error("Please enter a valid price");
      return;
    }

    // Prepare data for save
    const data = {
      property_id: useManualAddress ? null : form.property_id,
      manual_address: useManualAddress ? form.manual_address : null,
      status: form.status,
      transaction_type: form.transaction_type,
      contract_price: parseFloat(form.contract_price),
      commission_listing: parseFloat(form.commission_listing),
      commission_selling: parseFloat(form.commission_selling),
      agent_split_percentage: parseFloat(form.agent_split_percentage),
      transaction_fee: parseFloat(form.transaction_fee) || 0,
      commission_total: commissions.total,
      listing_gross_commission: commissions.listingGross,
      listing_net_commission: commissions.listingNet,
      selling_gross_commission: commissions.sellingGross,
      selling_net_commission: commissions.sellingNet,
      title_company: form.title_company || null,
      escrow_number: form.escrow_number || null,
      sellers_info: JSON.stringify(sellers.filter(s => s.name || s.email || s.cell_phone || s.home_phone)),
      buyers_info: JSON.stringify(buyers.filter(b => b.name || b.email || b.cell_phone || b.home_phone)),
      selling_agents_info: JSON.stringify(sellingAgents.filter(a => a.name || a.email || a.cell_phone || a.home_phone)),
      roles: {
        listing_agent_id: form.listing_agent_id || null
      },
      important_dates: {
        offer_date: form.offer_date || null,
        acceptance_date: form.acceptance_date || null,
        inspection_deadline: form.inspection_deadline || null,
        inspection_date: form.inspection_date || null,
        appraisal_date: form.appraisal_date || null,
        financing_deadline: form.financing_deadline || null,
        mortgage_approval_date: form.mortgage_approval_date || null,
        title_search_date: form.title_search_date || null,
        final_walkthrough_date: form.final_walkthrough_date || null,
        closing_date: form.closing_date || null
      }
    };

    console.log("üíæ Saving transaction:", data);
    onSave(data);

    // Generate tasks if requested (works for both NEW and EXISTING transactions)
    if (generateTasks && !useManualAddress && form.property_id) { // Removed form.status === 'pending'
      const propertyId = form.property_id;
      const assignedTo = form.listing_agent_id || properties.find(p => p.id === form.property_id)?.listing_agent_id;

      if (!assignedTo) {
        toast.error("Please assign a listing agent before generating tasks.");
        return;
      }
      generateContractTasks(propertyId, assignedTo); // Call without await to allow modal close
    }
  };

  const totalTasks = CONTRACT_PHASES.reduce((sum, phase) => sum + phase.tasks.length, 0);
  const tasksByPhase = useMemo(() => {
    const grouped = {};
    CONTRACT_PHASES.forEach(phase => {
      grouped[phase.id] = existingTasks.filter(t => t.package_name === phase.id);
    });
    return grouped;
  }, [existingTasks]);

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl max-w-4xl w-full my-8">
        {/* Header */}
        <div className="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 flex items-center justify-between z-10 rounded-t-xl">
          <div>
            <h2 className="text-2xl font-bold">
              {transaction ? "Edit Transaction" : "New Transaction"}
            </h2>
            <p className="text-white/80 text-sm mt-1">
              {transaction ? "Update transaction details" : "Create a new transaction"}
            </p>
          </div>
          <Button onClick={onClose} variant="ghost" size="icon" className="text-white hover:bg-white/20">
            <X className="w-6 h-6" />
          </Button>
        </div>

        <form onSubmit={handleSubmit} className="p-6 space-y-6 max-h-[calc(100vh-200px)] overflow-y-auto">
          {/* Basic Info */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Home className="w-5 h-5" />
                Basic Information
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                {!transaction && (
                  <div className="col-span-2">
                    <Button
                      type="button"
                      onClick={() => {
                        setUseManualAddress(!useManualAddress);
                        if (!useManualAddress) {
                          setForm(prevForm => ({...prevForm, property_id: ""}));
                        } else {
                          setForm(prevForm => ({...prevForm, manual_address: ""}));
                        }
                      }}
                      variant="outline"
                      size="sm"
                      className="mb-3"
                    >
                      {useManualAddress ? "Select from My Properties" : "Enter Manual Address"}
                    </Button>
                  </div>
                )}
                {/* Property Selection or Manual Entry - LOCKED after creation */}
                <div className="space-y-2 col-span-2">
                  <Label>{useManualAddress ? "Property Address *" : "Property *"}</Label>
                  {useManualAddress ? (
                    <Input
                      type="text"
                      value={form.manual_address}
                      onChange={(e) => setForm({...form, manual_address: e.target.value})}
                      placeholder="e.g., 123 Main St, Los Angeles, CA 90001"
                      className="w-full"
                      disabled={!!transaction}
                    />
                  ) : (
                    <Select 
                      value={form.property_id} 
                      onValueChange={(v) => setForm({...form, property_id: v})}
                      disabled={!!transaction}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Select property from my listings" />
                      </SelectTrigger>
                      <SelectContent>
                        {properties.map(p => (
                          <SelectItem key={p.id} value={p.id}>{p.address}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  )}
                  {useManualAddress && !transaction && (
                    <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">
                      üí° Use this for transactions from other offices where the property isn't in your listings
                    </p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label>Status *</Label>
                  <Select value={form.status} onValueChange={(v) => setForm({...form, status: v})}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="active">Active</SelectItem>
                      <SelectItem value="pending">Pending</SelectItem>
                      <SelectItem value="closed">Closed</SelectItem>
                      <SelectItem value="cancelled">Cancelled</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Transaction Type</Label>
                  <Select value={form.transaction_type} onValueChange={(v) => setForm({...form, transaction_type: v})}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="sale">Sale</SelectItem>
                      <SelectItem value="lease">Lease</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2 col-span-2">
                  <Label>Contract Price *</Label>
                  <Input
                    type="number"
                    value={form.contract_price}
                    onChange={(e) => setForm({...form, contract_price: e.target.value})}
                    placeholder="500000"
                  />
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Commission */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <DollarSign className="w-5 h-5 text-green-600" />
                Commission Details
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-4 gap-4">
                <div className="space-y-2">
                  <Label>Listing Commission (%)</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={form.commission_listing}
                    onChange={(e) => setForm({...form, commission_listing: e.target.value})}
                  />
                </div>

                <div className="space-y-2">
                  <Label>Selling Commission (%)</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={form.commission_selling}
                    onChange={(e) => setForm({...form, commission_selling: e.target.value})}
                  />
                </div>

                <div className="space-y-2">
                  <Label>Agent Split (%)</Label>
                  <Input
                    type="number"
                    step="1"
                    value={form.agent_split_percentage}
                    onChange={(e) => setForm({...form, agent_split_percentage: e.target.value})}
                  />
                </div>

                {/* New Transaction Fee Input */}
                <div className="space-y-2">
                  <Label>Transaction Fee ($)</Label>
                  <Input
                    type="number"
                    step="1"
                    value={form.transaction_fee}
                    onChange={(e) => setForm({...form, transaction_fee: e.target.value})}
                    placeholder="e.g., 500"
                  />
                  <p className="text-xs text-slate-500 dark:text-slate-400">
                    Brokerage fee per transaction
                  </p>
                </div>
              </div>

              {commissions.total > 0 && (
                <div className="space-y-3 mt-4">
                  <div className="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 p-4 rounded-lg border-2 border-slate-200 dark:border-slate-700">
                    <p className="text-sm font-semibold text-slate-600 dark:text-slate-400 mb-2">Total Commission</p>
                    <p className="text-3xl font-bold text-slate-900 dark:text-white">
                      ${commissions.total?.toLocaleString() || 0}
                    </p>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border-2 border-blue-200 dark:border-blue-700">
                      <p className="text-xs font-semibold text-blue-700 dark:text-blue-300 mb-1">Listing Side (Gross)</p>
                      <p className="text-2xl font-bold text-blue-600 dark:text-blue-400">
                        ${commissions.listingGross?.toLocaleString() || 0}
                      </p>
                      {form.transaction_fee > 0 && (
                        <p className="text-xs text-blue-600 dark:text-blue-400 mt-1">
                          - ${parseFloat(form.transaction_fee).toLocaleString()} fee
                        </p>
                      )}
                    </div>

                    <div className="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border-2 border-green-200 dark:border-green-800">
                      <p className="text-xs font-semibold text-green-700 dark:text-green-300 mb-1">Your Net Commission</p>
                      <p className="text-2xl font-bold text-green-600 dark:text-green-400">
                        ${commissions.listingNet?.toLocaleString() || 0}
                      </p>
                      <p className="text-xs text-green-600 dark:text-green-400 mt-1">
                        After {form.agent_split_percentage}% split & fees
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Participants - Listing Agent */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <User className="w-5 h-5" />
                Listing Agent
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                <Label>Select Listing Agent</Label>
                <Select value={form.listing_agent_id} onValueChange={(v) => setForm({...form, listing_agent_id: v})}>
                  <SelectTrigger>
                    <SelectValue placeholder="Select agent" />
                  </SelectTrigger>
                  <SelectContent>
                    {users.map(u => (
                      <SelectItem key={u.id} value={u.id}>{u.full_name || u.email}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </CardContent>
          </Card>

          {/* Sellers Information */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <User className="w-5 h-5 text-blue-600" />
                  Sellers Information
                </div>
                <Button type="button" onClick={addSeller} size="sm" variant="outline">
                  <Plus className="w-4 h-4 mr-1" />
                  Add Seller
                </Button>
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {sellers.map((seller, index) => (
                <div key={index} className="grid grid-cols-5 gap-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg relative">
                  <div className="space-y-2">
                    <Label>Name</Label>
                    <Input
                      value={seller.name}
                      onChange={(e) => updateSeller(index, 'name', e.target.value)}
                      placeholder="John Smith"
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Email</Label>
                    <Input
                      type="email"
                      value={seller.email}
                      onChange={(e) => updateSeller(index, 'email', e.target.value)}
                      placeholder="john@example.com"
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Cell Phone</Label>
                    <Input
                      type="text"
                      value={seller.cell_phone}
                      onChange={(e) => updateSeller(index, 'cell_phone', e.target.value)}
                      placeholder="+1 555-123-4567 or +44 20 1234 5678"
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Home Phone</Label>
                    <Input
                      type="text"
                      value={seller.home_phone}
                      onChange={(e) => updateSeller(index, 'home_phone', e.target.value)}
                      placeholder="+1 555-987-6543 or +33 1 23 45 67 89"
                    />
                  </div>

                  <div className="flex items-end">
                    {sellers.length > 1 && (
                      <Button
                        type="button"
                        onClick={() => removeSeller(index)}
                        variant="outline"
                        size="sm"
                        className="text-red-600 hover:text-red-700 w-full"
                      >
                        <Trash2 className="w-4 h-4 mr-1" />
                        Remove
                      </Button>
                    )}
                  </div>
                </div>
              ))}
            </CardContent>
          </Card>

          {/* Buyers Information */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <User className="w-5 h-5 text-green-600" />
                  Buyers Information
                </div>
                <Button type="button" onClick={addBuyer} size="sm" variant="outline">
                  <Plus className="w-4 h-4 mr-1" />
                  Add Buyer
                </Button>
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {buyers.map((buyer, index) => (
                <div key={index} className="grid grid-cols-5 gap-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                  <div className="space-y-2">
                    <Label>Name</Label>
                    <Input
                      value={buyer.name}
                      onChange={(e) => updateBuyer(index, 'name', e.target.value)}
                      placeholder="Jane Doe"
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Email</Label>
                    <Input
                      type="email"
                      value={buyer.email}
                      onChange={(e) => updateBuyer(index, 'email', e.target.value)}
                      placeholder="jane@example.com"
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Cell Phone</Label>
                    <Input
                      type="text"
                      value={buyer.cell_phone}
                      onChange={(e) => updateBuyer(index, 'cell_phone', e.target.value)}
                      placeholder="+1 555-123-4567 or +44 20 1234 5678"
                    />
                  </div>

                  <div className="space-y-2">
                    <Label>Home Phone</Label>
                    <Input
                      type="text"
                      value={buyer.home_phone}
                      onChange={(e) => updateBuyer(index, 'home_phone', e.target.value)}
                      placeholder="+1 555-987-6543 or +33 1 23 45 67 89"
                    />
                  </div>

                  <div className="flex items-end">
                    {buyers.length > 1 && (
                      <Button
                        type="button"
                        onClick={() => removeBuyer(index)}
                        variant="outline"
                        size="sm"
                        className="text-red-600 hover:text-red-700 w-full"
                      >
                        <Trash2 className="w-4 h-4 mr-1" />
                        Remove
                      </Button>
                    )}
                  </div>
                </div>
              ))}
            </CardContent>
          </Card>

          {/* Selling Agents/Assistants Information */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <User className="w-5 h-5 text-purple-600" />
                  Buyer's Agent & Team
                </div>
                <Button type="button" onClick={addSellingAgent} size="sm" variant="outline">
                  <Plus className="w-4 h-4 mr-1" />
                  Add Agent/Assistant
                </Button>
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {sellingAgents.map((agent, index) => (
                <div key={index} className="space-y-3">
                  {/* Quick Add from Team */}
                  <div className="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-200 dark:border-indigo-800">
                    <Label className="text-xs font-semibold text-indigo-900 dark:text-indigo-100 mb-2 block">
                      Quick Add:
                    </Label>
                    <div className="flex gap-2 flex-wrap">
                      <Button
                        type="button"
                        size="sm"
                        variant="outline"
                        onClick={() => fillFromTeamMember(index, null, true)}
                        className="bg-white dark:bg-slate-800"
                      >
                        <User className="w-3 h-3 mr-1" />
                        Add Myself
                      </Button>

                      {teamMembers.filter(m => m.is_active).length > 0 ? (
                        <Select onValueChange={(personId) => fillFromTeamMember(index, personId, false)}>
                          <SelectTrigger className="w-[200px] bg-white dark:bg-slate-800">
                            <SelectValue placeholder="Select team member" />
                          </SelectTrigger>
                          <SelectContent>
                            {teamMembers.filter(m => m.is_active).map(member => (
                              <SelectItem key={member.id} value={member.id}>
                                {member.full_name || member.name}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      ) : (
                        <p className="text-xs text-slate-500 dark:text-slate-400 italic">
                          No team members available
                        </p>
                      )}
                    </div>
                  </div>

                  {/* Manual Entry Fields */}
                  <div className="grid grid-cols-6 gap-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                    <div className="space-y-2">
                      <Label>Name</Label>
                      <Input
                        value={agent.name}
                        onChange={(e) => updateSellingAgent(index, 'name', e.target.value)}
                        placeholder="Agent name"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label>Email</Label>
                      <Input
                        type="email"
                        value={agent.email}
                        onChange={(e) => updateSellingAgent(index, 'email', e.target.value)}
                        placeholder="agent@example.com"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label>Cell Phone</Label>
                      <Input
                        type="text"
                        value={agent.cell_phone}
                        onChange={(e) => updateSellingAgent(index, 'cell_phone', e.target.value)}
                        placeholder="+1 555-123-4567 or +44 20 1234 5678"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label>Home Phone</Label>
                      <Input
                        type="text"
                        value={agent.home_phone}
                        onChange={(e) => updateSellingAgent(index, 'home_phone', e.target.value)}
                        placeholder="+1 555-987-6543 or +33 1 23 45 67 89"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label>Role</Label>
                      <Select
                        value={agent.role}
                        onValueChange={(v) => updateSellingAgent(index, 'role', v)}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="agent">Agent</SelectItem>
                          <SelectItem value="assistant">Assistant</SelectItem>
                          <SelectItem value="broker">Broker</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="flex items-end">
                      {sellingAgents.length > 1 && (
                        <Button
                          type="button"
                          onClick={() => removeSellingAgent(index)}
                          variant="outline"
                          size="sm"
                          className="text-red-600 hover:text-red-700 w-full"
                        >
                          <Trash2 className="w-4 h-4 mr-1" />
                          Remove
                        </Button>
                      )}
                    </div>
                  </div>

                  {/* Brokerage Information */}
                  <div className="col-span-6 grid grid-cols-2 gap-4 pt-3 border-t">
                    <div className="space-y-2">
                      <Label>Brokerage/Office Name</Label>
                      <Input
                        value={agent.office || ""}
                        onChange={(e) => updateSellingAgent(index, 'office', e.target.value)}
                        placeholder="ABC Realty"
                      />
                    </div>
                    <div className="space-y-2">
                      <Label>License #</Label>
                      <Input
                        value={agent.license || ""}
                        onChange={(e) => updateSellingAgent(index, 'license', e.target.value)}
                        placeholder="BK1234567"
                      />
                    </div>
                  </div>
                </div>
              ))}
            </CardContent>
          </Card>

          {/* Contract Tasks Management - Show for transactions with property_id */}
          {!useManualAddress && form.property_id && (
            <Card className="border-2 border-purple-200 dark:border-purple-800">
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Sparkles className="w-5 h-5 text-purple-600" />
                    Contract Task Package
                  </div>
                  {transaction && existingTasks.length > 0 && (
                    <Badge variant="outline" className="bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300">
                      {existingTasks.length} tasks generated
                    </Badge>
                  )}
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                {/* Show notice if not pending status */}
                {form.status !== 'pending' && (
                  <div className="p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
                    <p className="text-xs text-amber-800 dark:text-amber-200">
                      üí° Task generation is typically used for "Pending" transactions. Current status: <strong>{form.status}</strong>
                    </p>
                  </div>
                )}

                {/* Generate Tasks Section (for new or existing without tasks) */}
                {(!transaction || existingTasks.length === 0) && (
                  <div className="p-4 rounded-lg bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-950 dark:to-indigo-950">
                    <div className="flex items-start gap-3">
                      <input
                        type="checkbox"
                        id="generate_tasks"
                        checked={generateTasks}
                        onChange={(e) => setGenerateTasks(e.target.checked)}
                        className="mt-1"
                      />
                      <div className="flex-1">
                        <label htmlFor="generate_tasks" className="flex items-center gap-2 font-semibold text-purple-900 dark:text-purple-100 cursor-pointer">
                          <Sparkles className="w-5 h-5 text-purple-600 dark:text-purple-400" />
                          {transaction ? "Generate Contract Tasks (Forgot to add?)" : "Generate Under Contract Tasks"}
                        </label>
                        <p className="text-sm text-purple-700 dark:text-purple-300 mt-1">
                          Automatically create {totalTasks} comprehensive tasks across 9 phases
                        </p>
                        <div className="mt-2 text-xs text-purple-600 dark:text-purple-400 space-y-0.5">
                          <p>‚úì Contract & Escrow Setup (6 tasks)</p>
                          <p>‚úì Disclosures & Documents (5 tasks)</p>
                          <p>‚úì Inspections (6 tasks)</p>
                          <p>‚úì Appraisal & Financing (6 tasks)</p>
                          <p>‚úì Title, HOA & Insurance (5 tasks)</p>
                          <p>‚úì Repairs & Pre-Closing (5 tasks)</p>
                          <p>‚úì Closing Preparation (6 tasks)</p>
                          <p>‚úì Closing Day (5 tasks)</p>
                          <p>‚úì Post-Closing Follow-up (4 tasks)</p>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Existing Tasks - Show for editing transactions with existing tasks */}
                {transaction && existingTasks.length > 0 && (
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <Label className="text-sm font-semibold">Existing Contract Tasks</Label>
                      <Button
                        type="button"
                        onClick={() => setShowExistingTasks(!showExistingTasks)}
                        variant="outline"
                        size="sm"
                      >
                        {showExistingTasks ? "Hide Tasks" : `View ${existingTasks.length} Tasks`}
                      </Button>
                    </div>

                    {showExistingTasks && (
                      <div className="space-y-4 max-h-[400px] overflow-y-auto p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                        {CONTRACT_PHASES.map(phase => {
                          const phaseTasks = tasksByPhase[phase.id] || [];
                          if (phaseTasks.length === 0) return null;

                          return (
                            <div key={phase.id} className="space-y-2">
                              <h4 className="font-semibold text-sm text-slate-700 dark:text-slate-300 flex items-center gap-2">
                                <span className="w-2 h-2 bg-purple-500 rounded-full"></span>
                                {phase.title} ({phaseTasks.length} tasks)
                              </h4>
                              <div className="space-y-2">
                                {phaseTasks.map(task => (
                                  <div
                                    key={task.id}
                                    className="flex items-start justify-between p-3 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700"
                                  >
                                    <div className="flex-1 min-w-0">
                                      <p className="text-sm font-medium text-slate-900 dark:text-white">
                                        {task.title}
                                      </p>
                                      <div className="flex items-center gap-2 mt-1">
                                        <Badge
                                          variant="outline"
                                          className={
                                            task.status === 'completed'
                                              ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300'
                                              : task.status === 'in_progress'
                                              ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300'
                                              : 'bg-slate-100 text-slate-700 dark:bg-slate-700/30 dark:text-slate-300'
                                          }
                                        >
                                          {task.status}
                                        </Badge>
                                        {task.due_date && (
                                          <span className="text-xs text-slate-500 dark:text-slate-400">
                                            Due: {new Date(task.due_date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                                          </span>
                                        )}
                                      </div>
                                    </div>
                                    <Button
                                      type="button"
                                      onClick={() => {
                                        if (confirm(`Delete task: "${task.title}"?`)) {
                                          deleteTaskMutation.mutate(task.id);
                                        }
                                      }}
                                      variant="ghost"
                                      size="sm"
                                      className="text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20 ml-2"
                                    >
                                      <Trash2 className="w-4 h-4" />
                                    </Button>
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}

                    {/* Generate More Tasks for Existing Transaction */}
                    {showExistingTasks && (
                      <div className="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-200 dark:border-indigo-800">
                        <div className="flex items-start gap-3">
                          <input
                            type="checkbox"
                            id="generate_more_tasks"
                            checked={generateTasks}
                            onChange={(e) => setGenerateTasks(e.target.checked)}
                            className="mt-1"
                          />
                          <div className="flex-1">
                            <label htmlFor="generate_more_tasks" className="font-semibold text-sm text-indigo-900 dark:text-indigo-100 cursor-pointer">
                              Generate Additional Tasks
                            </label>
                            <p className="text-xs text-indigo-700 dark:text-indigo-300 mt-1">
                              Add {totalTasks} new contract tasks to this transaction
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </CardContent>
            </Card>
          )}

          {/* Title & Escrow Information */}
          <Card>
           <CardHeader>
             <CardTitle className="flex items-center gap-2">
               <FileText className="w-5 h-5 text-purple-600" />
               Title & Escrow Information
             </CardTitle>
           </CardHeader>
           <CardContent className="space-y-4">
             <div className="grid grid-cols-2 gap-4">
               <div className="space-y-2">
                 <Label>Title Company</Label>
                 <Input
                   value={form.title_company || ""}
                   onChange={(e) => setForm({...form, title_company: e.target.value})}
                   placeholder="ABC Title Company"
                 />
               </div>
               <div className="space-y-2">
                 <Label>Escrow Number</Label>
                 <Input
                   value={form.escrow_number || ""}
                   onChange={(e) => setForm({...form, escrow_number: e.target.value})}
                   placeholder="ESC-123456"
                 />
               </div>
             </div>
           </CardContent>
          </Card>

          {/* Important Dates - Transaction Timeline */}
          <Card>
           <CardHeader>
             <CardTitle className="flex items-center gap-2">
               <Calendar className="w-5 h-5 text-indigo-600" />
               Transaction Timeline - Important Dates
             </CardTitle>
             <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">
               Track all critical milestones throughout the transaction process
             </p>
           </CardHeader>
           <CardContent className="space-y-6">
              {/* Contract Phase */}
              <div>
                <h4 className="font-semibold text-sm text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                  <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
                  Contract Phase
                </h4>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label className="text-xs">Offer Date</Label>
                    <Input
                      type="date"
                      value={form.offer_date}
                      onChange={(e) => setForm({...form, offer_date: e.target.value})}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label className="text-xs">Acceptance Date</Label>
                    <Input
                      type="date"
                      value={form.acceptance_date}
                      onChange={(e) => setForm({...form, acceptance_date: e.target.value})}
                    />
                  </div>
                </div>
              </div>

              {/* Inspection Phase */}
              <div>
                <h4 className="font-semibold text-sm text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                  <span className="w-2 h-2 bg-amber-500 rounded-full"></span>
                  Inspection Phase
                </h4>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label className="text-xs">Inspection Deadline</Label>
                    <Input
                      type="date"
                      value={form.inspection_deadline}
                      onChange={(e) => setForm({...form, inspection_deadline: e.target.value})}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label className="text-xs">Inspection Date</Label>
                    <Input
                      type="date"
                      value={form.inspection_date}
                      onChange={(e) => setForm({...form, inspection_date: e.target.value})}
                    />
                  </div>
                </div>
              </div>

              {/* Financing Phase */}
              <div>
                <h4 className="font-semibold text-sm text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                  <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                  Financing & Appraisal
                </h4>
                <div className="grid grid-cols-3 gap-4">
                  <div className="space-y-2">
                    <Label className="text-xs">Financing Deadline</Label>
                    <Input
                      type="date"
                      value={form.financing_deadline}
                      onChange={(e) => setForm({...form, financing_deadline: e.target.value})}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label className="text-xs">Mortgage Approval Date</Label>
                    <Input
                      type="date"
                      value={form.mortgage_approval_date}
                      onChange={(e) => setForm({...form, mortgage_approval_date: e.target.value})}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label className="text-xs">Appraisal Date</Label>
                    <Input
                      type="date"
                      value={form.appraisal_date}
                      onChange={(e) => setForm({...form, appraisal_date: e.target.value})}
                    />
                  </div>
                </div>
              </div>

              {/* Closing Phase */}
              <div>
                <h4 className="font-semibold text-sm text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                  <span className="w-2 h-2 bg-purple-500 rounded-full"></span>
                  Closing Phase
                </h4>
                <div className="grid grid-cols-3 gap-4">
                  <div className="space-y-2">
                    <Label className="text-xs">Title Search Date</Label>
                    <Input
                      type="date"
                      value={form.title_search_date}
                      onChange={(e) => setForm({...form, title_search_date: e.target.value})}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label className="text-xs">Final Walkthrough</Label>
                    <Input
                      type="date"
                      value={form.final_walkthrough_date}
                      onChange={(e) => setForm({...form, final_walkthrough_date: e.target.value})}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label className="text-xs font-semibold">Closing Date *</Label>
                    <Input
                      type="date"
                      value={form.closing_date}
                      onChange={(e) => setForm({...form, closing_date: e.target.value})}
                      className="border-2 border-indigo-300 dark:border-indigo-700"
                    />
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </form>

        {/* Actions - Fixed at bottom */}
        <div className="sticky bottom-0 bg-white dark:bg-slate-900 p-6 border-t flex justify-end gap-3 rounded-b-xl">
          <Button type="button" onClick={onClose} variant="outline" disabled={isGeneratingTasks}>
            Cancel
          </Button>
          <Button
            onClick={handleSubmit}
            className="bg-gradient-to-r from-indigo-600 to-purple-600"
            disabled={isGeneratingTasks}
          >
            {isGeneratingTasks ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                Generating Tasks...
              </>
            ) : (
              <>
                <CheckCircle2 className="w-4 h-4 mr-2" />
                {transaction ? "Update Transaction" : "Create Transaction"}
              </>
            )}
          </Button>
        </div>
      </div>
    </div>
  );
}
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { motion } from 'framer-motion';
import {
    Home, Users, Calendar, TrendingUp, MessageSquare, FileText, Camera,
    Sparkles, Brain, Target, DollarSign, BarChart3, Briefcase, Mail,
    Globe, Shield, Zap, Check, X, ArrowRight, Star, Award, Rocket, Clock, Loader2, Sun, Moon
} from 'lucide-react';

export default function Website() {
    const navigate = useNavigate();
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [selectedPlan, setSelectedPlan] = useState('professional');
    const [billingCycle, setBillingCycle] = useState('monthly');
    const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });
    const [showLoginModal, setShowLoginModal] = useState(false);
    const [isLoggingIn, setIsLoggingIn] = useState(false);
    const [isDarkMode, setIsDarkMode] = useState(true);

    useEffect(() => {
        const handleMouseMove = (e) => {
            setMousePosition({ x: e.clientX, y: e.clientY });
        };
        window.addEventListener('mousemove', handleMouseMove);
        return () => window.removeEventListener('mousemove', handleMouseMove);
    }, []);

    const features = [
        { icon: Home, title: 'Property Management', desc: 'Comprehensive tracking for listings, sales, leases with MLS integration' },
        { icon: Users, title: 'Smart Lead Management', desc: 'Workflow-powered lead scoring with predictive analytics and intent tracking', page: 'ServiceLeadManagement' },
        { icon: Calendar, title: 'Smart Calendar', desc: 'Unified calendar with GPS routing, travel time, and voice reminders' },
        { icon: Brain, title: 'Smart Insights & Predictions', desc: '24/7 intelligent assistant with Zillow, Realtor.com, Redfin, tax records access', page: 'ServiceAIInsights' },
        { icon: MessageSquare, title: 'Team Collaboration', desc: 'Real-time chat, internal messaging, and transaction coordination' },
        { icon: TrendingUp, title: 'Advanced Analytics', desc: 'Real-time dashboards, pipeline tracking, and performance metrics' },
        { icon: FileText, title: 'Document Intelligence', desc: 'Workflow document analysis, search, and automated categorization', page: 'ServiceDocumentIntelligence' },
        { icon: Target, title: 'Workflow Automation', desc: 'Custom workflows for listings, buyers, and transaction management' },
        { icon: DollarSign, title: 'Commission Tracking', desc: 'Automatic calculations, split management, and forecasting' },
        { icon: BarChart3, title: 'Market Intelligence', desc: 'Real-time trends, sentiment analysis, and competitive insights' },
        { icon: Globe, title: 'Social Intelligence', desc: 'Monitor buyer intent from Facebook, Instagram, LinkedIn activity' },
        { icon: Mail, title: 'Email Integration', desc: 'Gmail & Outlook sync with AI-powered drafts and templates' },
        { icon: Users, title: 'Sphere of Influence', desc: 'Automated touch-point tracking and referral management' },
        { icon: Briefcase, title: 'Transaction Pipeline', desc: 'End-to-end transaction tracking with milestone automation', page: 'ServiceTransactionPipeline' },
        { icon: Camera, title: 'Photo Management', desc: 'Professional photo approval workflows and galleries' },
        { icon: Target, title: 'Open Houses & Showings', desc: 'Scheduling, attendee tracking, and automated follow-ups' },
        { icon: Users, title: 'Buyer Management', desc: 'Buyer profiles, preferences, intelligent property matching' },
        { icon: FileText, title: 'FSBO Lead Mining', desc: 'Find and track For Sale By Owner opportunities automatically' },
        { icon: DollarSign, title: 'Mortgage Calculator', desc: 'Built-in calculators with current rates and pre-qualification' },
        { icon: TrendingUp, title: 'Net Sheet Generator', desc: 'Professional seller/buyer net sheets in seconds' },
        { icon: Sparkles, title: 'Business Advisor', desc: 'Strategic recommendations based on your data and market conditions' },
        { icon: Shield, title: 'Client Portal', desc: 'Branded portal for clients to view documents and updates' },
        { icon: Mail, title: 'Marketing Automation', desc: 'Email campaigns with templates and performance tracking', page: 'ServiceMarketingAutomation' },
        { icon: Zap, title: 'Automated Follow-ups', desc: 'Workflow-generated emails and SMS to nurture leads automatically', page: 'ServiceAutomatedFollowups' },
    ];

    const technologies = [
        { name: 'Advanced Workflows', desc: 'Intelligent natural language processing' },
        { name: 'Zillow API', desc: 'Real-time property data and valuations' },
        { name: 'Realtor.com Integration', desc: 'MLS data and market insights' },
        { name: 'Redfin Data', desc: 'Comprehensive market analytics' },
        { name: 'Google Maps', desc: 'Location intelligence and routing' },
        { name: 'Real-time Sync', desc: 'Cloud-based collaboration' },
    ];

    const pricingPlans = [
        {
            name: 'Starter',
            tier: 1,
            price: { monthly: 99, annual: 950 },
            description: 'Perfect for new agents getting started',
            features: [
                '‚úì Up to 100 properties',
                '‚úì Up to 250 leads & contacts',
                '‚úì Basic task management',
                '‚úì Calendar & appointments',
                '‚úì Commission tracking',
                '‚úì Basic document storage',
                '‚úì Photo management',
                '‚úì Open houses & showings',
                '‚úì Transaction tracking',
                '‚úì Basic reports',
                '‚úì Mobile app access',
                '‚úì Email support',
            ],
            notIncluded: [
                'Jackie Assistant',
                'Lead scoring',
                'Market intelligence',
                'Email integration',
                'Team collaboration',
                'Workflow automation',
                'Social intelligence',
                'Design studio',
                'Business Advisor'
            ]
        },
        {
            name: 'Professional',
            tier: 2,
            price: { monthly: 199, annual: 1910 },
            description: 'For growing agents and small teams',
            popular: true,
            features: [
                '‚úì Unlimited properties & leads',
                '‚úì Jackie Assistant (Zillow, Realtor.com, Redfin)',
                '‚úì Workflow Lead scoring & insights',
                '‚úì Advanced analytics & dashboards',
                '‚úì Workflow Document intelligence',
                '‚úì Email integration (Gmail/Outlook)',
                '‚úì Market intelligence & news',
                '‚úì FSBO lead mining',
                '‚úì Mortgage calculator',
                '‚úì Net sheet generator',
                '‚úì Client newsletters',
                '‚úì Marketing campaigns',
                '‚úì Property insights',
                '‚úì Daily advice',
                '‚úì Sphere of influence tracking',
                '‚úì Priority support',
            ],
            notIncluded: [
                'Team members',
                'Social intelligence',
                'Workflow automation',
                'Design studio',
                'CSV import',
                'Business Advisor',
                'Location intelligence',
                'Jackie Follow-ups'
            ]
        },
        {
            name: 'Business',
            tier: 3,
            price: { monthly: 349, annual: 3350 },
            description: 'For teams and growing brokerages',
            features: [
                '‚úì Everything in Professional',
                '‚úì Up to 10 team members',
                '‚úì Social intelligence (FB, IG, LinkedIn)',
                '‚úì Buyer intent tracking',
                '‚úì Jackie Follow-ups automation',
                '‚úì Workflow automation & templates',
                '‚úì Design studio (flyers, social posts)',
                '‚úì CSV import/export',
                '‚úì Client portal access',
                '‚úì Location intelligence',
                '‚úì Subdivision search',
                '‚úì Events map',
                '‚úì Team chat & collaboration',
                '‚úì Goals management',
                '‚úì Coaching resources',
                '‚úì Advanced integrations',
                '‚úì Dedicated support',
            ],
            notIncluded: [
                'Unlimited team members',
                'Business Advisor',
                'White label options',
                'API access',
                'Custom workflows'
            ]
        },
        {
            name: 'Enterprise',
            tier: 4,
            price: { monthly: 499, annual: 4790 },
            description: 'For large teams and brokerages',
            features: [
                '‚úì Everything in Business',
                '‚úì Unlimited team members',
                '‚úì Business Advisor',
                '‚úì Team performance analysis',
                '‚úì Custom workflow builder',
                '‚úì White label options',
                '‚úì API access',
                '‚úì Backup & restore',
                '‚úì Role & permission management',
                '‚úì Custom integrations',
                '‚úì Advanced team analytics',
                '‚úì Team proforma tracking',
                '‚úì Performance goals system',
                '‚úì Team surveys & diagnostics',
                '‚úì Dedicated account manager',
                '‚úì 24/7 premium support',
                '‚úì Onboarding & training',
            ],
            notIncluded: []
        }
    ];

    const selectedPlanData = pricingPlans.find(p => p.name.toLowerCase() === selectedPlan);
    const discount = billingCycle === 'annual' ? 20 : 0;
    const calculatedPrice = selectedPlanData ? selectedPlanData.price[billingCycle] : 0;
    const savingsAmount = selectedPlanData && billingCycle === 'annual' 
        ? (selectedPlanData.price.monthly * 12) - selectedPlanData.price.annual 
        : 0;

    const handleGetStarted = () => {
        navigate(createPageUrl('Dashboard'));
    };

    const handleLogin = async (e) => {
        e.preventDefault();
        setIsLoggingIn(true);
        
        try {
            // Base44 handles authentication - just redirect to dashboard
            await new Promise(resolve => setTimeout(resolve, 800));
            navigate(createPageUrl('Dashboard'));
        } catch (error) {
            toast.error('Login failed');
        } finally {
            setIsLoggingIn(false);
        }
    };

    return (
        <div className={`min-h-screen relative transition-colors duration-500 ${isDarkMode ? 'bg-black text-white' : 'bg-slate-50 text-slate-900'}`}>
            {/* Animated Background */}
            <div className="fixed inset-0 z-0">
                <div className={`absolute inset-0 transition-colors duration-500 ${isDarkMode ? 'bg-gradient-to-br from-indigo-950 via-purple-950 to-slate-950' : 'bg-gradient-to-br from-slate-100 via-slate-50 to-indigo-100'}`} />
                <motion.div
                    className="absolute inset-0 opacity-30"
                    style={{
                        background: `radial-gradient(600px circle at ${mousePosition.x}px ${mousePosition.y}px, rgba(99, 102, 241, 0.15), transparent 40%)`
                    }}
                />
                
                {/* Compass Rose Background */}
                <div className="absolute inset-0 flex items-center justify-center opacity-5">
                    <motion.svg
                        width="800"
                        height="800"
                        viewBox="0 0 200 200"
                        className="absolute"
                        animate={{ rotate: 360 }}
                        transition={{ duration: 120, repeat: Infinity, ease: "linear" }}
                    >
                        {/* Compass Circle */}
                        <circle cx="100" cy="100" r="90" fill="none" stroke="currentColor" strokeWidth="0.5" className="text-indigo-300" />
                        <circle cx="100" cy="100" r="80" fill="none" stroke="currentColor" strokeWidth="0.3" className="text-indigo-400" />
                        <circle cx="100" cy="100" r="70" fill="none" stroke="currentColor" strokeWidth="0.3" className="text-indigo-400" />
                        
                        {/* Cardinal Points - North */}
                        <polygon points="100,20 105,60 100,55 95,60" fill="currentColor" className="text-indigo-400" />
                        <text x="100" y="15" textAnchor="middle" className="text-indigo-300 text-xs font-bold fill-current">N</text>
                        
                        {/* East */}
                        <polygon points="180,100 140,95 145,100 140,105" fill="currentColor" className="text-indigo-500" opacity="0.6" />
                        <text x="185" y="105" textAnchor="middle" className="text-indigo-400 text-xs fill-current">E</text>
                        
                        {/* South */}
                        <polygon points="100,180 95,140 100,145 105,140" fill="currentColor" className="text-indigo-500" opacity="0.6" />
                        <text x="100" y="195" textAnchor="middle" className="text-indigo-400 text-xs fill-current">S</text>
                        
                        {/* West */}
                        <polygon points="20,100 60,105 55,100 60,95" fill="currentColor" className="text-indigo-500" opacity="0.6" />
                        <text x="15" y="105" textAnchor="middle" className="text-indigo-400 text-xs fill-current">W</text>
                        
                        {/* Diagonal Lines */}
                        <line x1="35" y1="35" x2="65" y2="65" stroke="currentColor" strokeWidth="0.5" className="text-indigo-400" opacity="0.3" />
                        <line x1="165" y1="35" x2="135" y2="65" stroke="currentColor" strokeWidth="0.5" className="text-indigo-400" opacity="0.3" />
                        <line x1="165" y1="165" x2="135" y2="135" stroke="currentColor" strokeWidth="0.5" className="text-indigo-400" opacity="0.3" />
                        <line x1="35" y1="165" x2="65" y2="135" stroke="currentColor" strokeWidth="0.5" className="text-indigo-400" opacity="0.3" />
                        
                        {/* Center Star */}
                        <circle cx="100" cy="100" r="5" fill="currentColor" className="text-indigo-300" />
                        <polygon points="100,90 102,98 110,98 104,103 106,111 100,106 94,111 96,103 90,98 98,98" fill="currentColor" className="text-indigo-400" />
                    </motion.svg>
                </div>
                
                <div className="absolute inset-0">
                    {[...Array(50)].map((_, i) => (
                        <motion.div
                            key={i}
                            className="absolute w-1 h-1 bg-indigo-400 rounded-full"
                            style={{
                                left: `${Math.random() * 100}%`,
                                top: `${Math.random() * 100}%`,
                            }}
                            animate={{
                                opacity: [0.2, 1, 0.2],
                                scale: [1, 1.5, 1],
                            }}
                            transition={{
                                duration: Math.random() * 3 + 2,
                                repeat: Infinity,
                                delay: Math.random() * 2,
                            }}
                        />
                    ))}
                </div>
            </div>

            {/* Navigation */}
            <nav className={`sticky top-0 z-50 backdrop-blur-2xl border-b shadow-lg transition-colors duration-500 ${isDarkMode ? 'bg-black/60 border-white/10 shadow-black/20' : 'bg-white/60 border-slate-200 shadow-slate-200/20'}`}>
                <div className="max-w-7xl mx-auto px-6 py-4">
                    <div className="flex items-center justify-between mb-4">
                        <motion.div 
                            className="flex items-center gap-3"
                            initial={{ opacity: 0, x: -20 }}
                            animate={{ opacity: 1, x: 0 }}
                            transition={{ duration: 0.5 }}
                        >
                            <div className="relative w-10 h-10">
                                <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl blur-md animate-pulse" />
                                <div className="relative w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/50">
                                    <Brain className="w-6 h-6 text-white" />
                                </div>
                            </div>
                            <div>
                                <h1 className={`text-xl font-bold bg-gradient-to-r bg-clip-text text-transparent ${isDarkMode ? 'from-white to-indigo-200' : 'from-slate-800 to-indigo-700'}`}>RealtyMind</h1>
                                <p className={`text-xs ${isDarkMode ? 'text-indigo-300' : 'text-slate-700'}`}>The Mind Behind Every Deal</p>
                            </div>
                        </motion.div>
                        <motion.div
                            initial={{ opacity: 0, x: 20 }}
                            animate={{ opacity: 1, x: 0 }}
                            transition={{ duration: 0.5 }}
                            className="flex gap-3 items-center"
                        >
                            <Button
                                onClick={() => setIsDarkMode(!isDarkMode)}
                                variant="outline"
                                size="icon"
                                className={`transition-colors ${isDarkMode ? 'border-white/20 bg-white/5 hover:bg-white/10 text-white' : 'border-slate-200 bg-slate-100 hover:bg-slate-200 text-slate-900'}`}
                            >
                                {isDarkMode ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
                            </Button>
                            <Button 
                                onClick={() => setShowLoginModal(true)} 
                                variant="outline"
                                className={`backdrop-blur-xl transition-colors ${isDarkMode ? 'border-white/20 bg-white/5 hover:bg-white/10 text-white' : 'border-slate-200 bg-white hover:bg-slate-50 text-slate-900'}`}
                            >
                                Login
                            </Button>
                            <Button 
                                onClick={handleGetStarted} 
                                className="relative group bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 shadow-lg shadow-indigo-500/50 hover:shadow-indigo-500/80 transition-all"
                            >
                                <span className="relative z-10">Get Started</span>
                                <ArrowRight className="w-4 h-4 ml-2 relative z-10 group-hover:translate-x-1 transition-transform" />
                                <div className="absolute inset-0 bg-gradient-to-r from-white/20 to-white/0 opacity-0 group-hover:opacity-100 transition-opacity rounded-md" />
                            </Button>
                        </motion.div>
                    </div>
                    
                    {/* Services Menu */}
                    <motion.div 
                        className="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-hide"
                        initial={{ opacity: 0, y: -10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.5, delay: 0.2 }}
                    >
                        <button
                            onClick={() => navigate(createPageUrl('HouseWorthEstimator'))}
                            className={`px-4 py-2 rounded-lg text-sm bg-gradient-to-r transition-all whitespace-nowrap border ${isDarkMode ? 'from-green-600/20 to-emerald-600/20 text-green-300 hover:text-white hover:bg-green-600/30 border-green-500/30' : 'from-green-100 to-emerald-100 text-green-700 hover:text-green-900 hover:bg-green-200 border-green-300'}`}
                        >
                            <DollarSign className="w-4 h-4 inline mr-1" />
                            What's My House Worth?
                        </button>
                        <button
                            onClick={() => navigate(createPageUrl('ServiceLeadManagement'))}
                            className={`px-4 py-2 rounded-lg text-sm transition-all whitespace-nowrap ${isDarkMode ? 'text-indigo-200 hover:text-white hover:bg-white/10' : 'text-slate-800 hover:text-slate-900 hover:bg-slate-200/60'}`}
                        >
                            Lead Management
                        </button>
                        <button
                            onClick={() => navigate(createPageUrl('ServiceAIInsights'))}
                            className={`px-4 py-2 rounded-lg text-sm transition-all whitespace-nowrap ${isDarkMode ? 'text-indigo-200 hover:text-white hover:bg-white/10' : 'text-slate-800 hover:text-slate-900 hover:bg-slate-200/60'}`}
                        >
                            Insights
                        </button>
                        <button
                            onClick={() => navigate(createPageUrl('ServiceTransactionPipeline'))}
                            className={`px-4 py-2 rounded-lg text-sm transition-all whitespace-nowrap ${isDarkMode ? 'text-indigo-200 hover:text-white hover:bg-white/10' : 'text-slate-800 hover:text-slate-900 hover:bg-slate-200/60'}`}
                        >
                            Transactions
                        </button>
                        <button
                            onClick={() => navigate(createPageUrl('ServiceAutomatedFollowups'))}
                            className={`px-4 py-2 rounded-lg text-sm transition-all whitespace-nowrap ${isDarkMode ? 'text-indigo-200 hover:text-white hover:bg-white/10' : 'text-slate-800 hover:text-slate-900 hover:bg-slate-200/60'}`}
                        >
                            Follow-ups
                        </button>
                        <button
                            onClick={() => navigate(createPageUrl('ServiceDocumentIntelligence'))}
                            className={`px-4 py-2 rounded-lg text-sm transition-all whitespace-nowrap ${isDarkMode ? 'text-indigo-200 hover:text-white hover:bg-white/10' : 'text-slate-800 hover:text-slate-900 hover:bg-slate-200/60'}`}
                        >
                            Documents
                        </button>
                        <button
                            onClick={() => navigate(createPageUrl('ServiceMarketingAutomation'))}
                            className={`px-4 py-2 rounded-lg text-sm transition-all whitespace-nowrap ${isDarkMode ? 'text-indigo-200 hover:text-white hover:bg-white/10' : 'text-slate-800 hover:text-slate-900 hover:bg-slate-200/60'}`}
                        >
                            Marketing
                        </button>
                        <button
                            onClick={() => document.getElementById('pricing').scrollIntoView({ behavior: 'smooth' })}
                            className={`px-4 py-2 rounded-lg text-sm transition-all whitespace-nowrap ${isDarkMode ? 'text-indigo-200 hover:text-white hover:bg-white/10' : 'text-slate-800 hover:text-slate-900 hover:bg-slate-200/60'}`}
                        >
                            Pricing
                        </button>
                    </motion.div>
                </div>
            </nav>

            {/* Hero Section */}
            <section className="relative z-10 overflow-hidden py-32 px-6">
                <div className="relative max-w-7xl mx-auto text-center">
                    <motion.div
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.8 }}
                    >
                        <Badge className={`mb-6 backdrop-blur-xl shadow-lg ${isDarkMode ? 'bg-white/10 border border-white/20 text-white shadow-indigo-500/20' : 'bg-indigo-100 border border-indigo-300 text-indigo-900 shadow-indigo-200/50'}`}>
                            <Sparkles className="w-3 h-3 mr-1" />
                            The Most Advanced Real Estate Workflow System on the Market
                        </Badge>
                    </motion.div>
                    
                    <motion.h2 
                        className="text-6xl md:text-8xl font-bold mb-6 leading-tight"
                        initial={{ opacity: 0, y: 30 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.8, delay: 0.2 }}
                    >
                        <span className={`bg-gradient-to-r bg-clip-text text-transparent ${isDarkMode ? 'from-white via-indigo-200 to-purple-200' : 'from-slate-900 via-slate-800 to-slate-700'}`}>
                            The Mind Behind
                        </span>
                        <br />
                        <span className={`bg-gradient-to-r bg-clip-text text-transparent ${isDarkMode ? 'from-indigo-400 via-purple-400 to-pink-400' : 'from-indigo-700 via-purple-700 to-pink-700'}`}>
                            Every Real Estate Deal
                        </span>
                    </motion.h2>
                    
                    <motion.p 
                        className={`text-xl mb-12 max-w-3xl mx-auto leading-relaxed ${isDarkMode ? 'text-indigo-100' : 'text-slate-700'}`}
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.8, delay: 0.4 }}
                    >
                        The industry's most comprehensive platform with 24+ advanced features, workflow automation, and social intelligence. 
                        No other CRM offers this level of sophistication‚ÄîRealtyMind gives you powerful capabilities to close more deals faster.
                    </motion.p>
                    
                    <motion.div 
                        className="flex flex-col sm:flex-row gap-4 justify-center items-center mb-8"
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.8, delay: 0.6 }}
                    >
                        <Button 
                            size="lg" 
                            onClick={handleGetStarted} 
                            className="relative group bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-lg px-10 py-6 shadow-2xl shadow-indigo-500/50 hover:shadow-indigo-500/80 transition-all"
                        >
                            <span className="relative z-10">Start Free Trial</span>
                            <Rocket className="w-5 h-5 ml-2 relative z-10 group-hover:translate-y-[-4px] transition-transform" />
                            <div className="absolute inset-0 bg-gradient-to-r from-white/20 to-white/0 opacity-0 group-hover:opacity-100 transition-opacity rounded-md" />
                        </Button>
                        <Button 
                            size="lg" 
                            variant="outline" 
                            onClick={() => document.getElementById('pricing').scrollIntoView({ behavior: 'smooth' })}
                            className="border-white/20 bg-white/5 backdrop-blur-xl hover:bg-white/10 text-white text-lg px-10 py-6"
                        >
                            View Pricing
                        </Button>
                    </motion.div>
                    
                    <motion.p 
                        className={`text-sm ${isDarkMode ? 'text-indigo-300' : 'text-slate-600'}`}
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        transition={{ duration: 0.8, delay: 0.8 }}
                    >
                        ‚ú® 14-day free trial ‚Ä¢ üí≥ No credit card required ‚Ä¢ üöÄ Setup in 5 minutes
                    </motion.p>

                    {/* Floating Elements */}
                    <div className="absolute inset-0 pointer-events-none">
                        <motion.div
                            className="absolute top-20 left-10 w-20 h-20 bg-indigo-500/20 rounded-full blur-2xl"
                            animate={{
                                y: [0, -20, 0],
                                scale: [1, 1.2, 1],
                            }}
                            transition={{ duration: 4, repeat: Infinity }}
                        />
                        <motion.div
                            className="absolute top-40 right-20 w-32 h-32 bg-purple-500/20 rounded-full blur-2xl"
                            animate={{
                                y: [0, 20, 0],
                                scale: [1, 1.3, 1],
                            }}
                            transition={{ duration: 5, repeat: Infinity }}
                        />
                    </div>
                </div>
            </section>

            {/* Benefits Section */}
            <section className={`relative z-10 py-20 px-6 backdrop-blur-sm ${isDarkMode ? 'bg-gradient-to-br from-black/40 to-indigo-950/40' : 'bg-white/60'}`}>
                <div className="max-w-7xl mx-auto">
                    <motion.div 
                        className="text-center mb-16"
                        initial={{ opacity: 0, y: 20 }}
                        whileInView={{ opacity: 1, y: 0 }}
                        viewport={{ once: true }}
                        transition={{ duration: 0.6 }}
                    >
                        <Badge className={`mb-4 backdrop-blur-xl ${isDarkMode ? 'bg-white/10 border border-white/20 text-white' : 'bg-indigo-100 border border-indigo-300 text-indigo-900'}`}>
                            <Star className="w-3 h-3 mr-1" />
                            Benefits
                        </Badge>
                        <h3 className={`text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r bg-clip-text text-transparent ${isDarkMode ? 'from-white to-indigo-200' : 'from-slate-900 to-indigo-800'}`}>
                            Why Top Agents Choose RealtyMind
                        </h3>
                        <p className={`text-lg max-w-3xl mx-auto ${isDarkMode ? 'text-indigo-200' : 'text-slate-700'}`}>
                            Stop juggling multiple tools and spreadsheets. Get everything you need in one powerful platform that actually helps you close more deals.
                        </p>
                    </motion.div>

                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <motion.div
                            initial={{ opacity: 0, y: 20 }}
                            whileInView={{ opacity: 1, y: 0 }}
                            viewport={{ once: true }}
                            transition={{ duration: 0.5 }}
                        >
                            <Card className={`h-full backdrop-blur-xl transition-all duration-300 hover:-translate-y-2 ${isDarkMode ? 'bg-white/5 border border-white/10 hover:bg-white/10 hover:border-indigo-500/50' : 'bg-white border border-slate-200 hover:border-indigo-300 shadow-lg hover:shadow-xl'}`}>
                                <CardHeader>
                                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center mb-4 ${isDarkMode ? 'bg-gradient-to-br from-green-500/20 to-emerald-600/20' : 'bg-gradient-to-br from-green-100 to-emerald-100'}`}>
                                        <TrendingUp className={`w-6 h-6 ${isDarkMode ? 'text-green-400' : 'text-green-700'}`} />
                                    </div>
                                    <CardTitle className={`text-xl ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Close 2.5x More Deals</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className={`mb-4 ${isDarkMode ? 'text-indigo-200' : 'text-slate-700'}`}>
                                       Workflow-powered lead scoring and automated follow-ups ensure you never miss a hot lead. Respond within 5 minutes and convert 100x more leads.
                                    </p>
                                    <Badge className={`${isDarkMode ? 'bg-green-500/20 text-green-300 border-green-500/30' : 'bg-green-100 text-green-800 border-green-300'}`}>
                                        73% increase in response rate
                                    </Badge>
                                </CardContent>
                            </Card>
                        </motion.div>

                        <motion.div
                            initial={{ opacity: 0, y: 20 }}
                            whileInView={{ opacity: 1, y: 0 }}
                            viewport={{ once: true }}
                            transition={{ duration: 0.5, delay: 0.1 }}
                        >
                            <Card className={`h-full backdrop-blur-xl transition-all duration-300 hover:-translate-y-2 ${isDarkMode ? 'bg-white/5 border border-white/10 hover:bg-white/10 hover:border-indigo-500/50' : 'bg-white border border-slate-200 hover:border-indigo-300 shadow-lg hover:shadow-xl'}`}>
                            <CardHeader>
                                <div className={`w-12 h-12 rounded-lg flex items-center justify-center mb-4 ${isDarkMode ? 'bg-gradient-to-br from-blue-500/20 to-indigo-600/20' : 'bg-gradient-to-br from-blue-100 to-indigo-100'}`}>
                                    <Clock className={`w-6 h-6 ${isDarkMode ? 'text-blue-400' : 'text-blue-700'}`} />
                                </div>
                                <CardTitle className={`text-xl ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Save 12+ Hours Weekly</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <p className={`mb-4 ${isDarkMode ? 'text-indigo-200' : 'text-slate-700'}`}>
                                       Workflow automation, document intelligence, and smart task management eliminate repetitive work so you can focus on closing deals.
                                    </p>
                                    <Badge className={`${isDarkMode ? 'bg-blue-500/20 text-blue-300 border-blue-500/30' : 'bg-blue-100 text-blue-800 border-blue-300'}`}>
                                        45 min saved per day per agent
                                    </Badge>
                                </CardContent>
                            </Card>
                        </motion.div>

                        <motion.div
                            initial={{ opacity: 0, y: 20 }}
                            whileInView={{ opacity: 1, y: 0 }}
                            viewport={{ once: true }}
                            transition={{ duration: 0.5, delay: 0.2 }}
                        >
                            <Card className={`h-full backdrop-blur-xl transition-all duration-300 hover:-translate-y-2 ${isDarkMode ? 'bg-white/5 border border-white/10 hover:bg-white/10 hover:border-indigo-500/50' : 'bg-white border border-slate-200 hover:border-indigo-300 shadow-lg hover:shadow-xl'}`}>
                                <CardHeader>
                                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center mb-4 ${isDarkMode ? 'bg-gradient-to-br from-purple-500/20 to-pink-600/20' : 'bg-gradient-to-br from-purple-100 to-pink-100'}`}>
                                        <Brain className={`w-6 h-6 ${isDarkMode ? 'text-purple-400' : 'text-purple-700'}`} />
                                    </div>
                                    <CardTitle className={`text-xl ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Intelligent Workflows</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className={`mb-4 ${isDarkMode ? 'text-indigo-200' : 'text-slate-700'}`}>
                                        Jackie has access to Zillow, Realtor.com, Redfin, and tax records. Get instant property insights, market analysis, and personalized recommendations.
                                    </p>
                                    <Badge className={`${isDarkMode ? 'bg-purple-500/20 text-purple-300 border-purple-500/30' : 'bg-purple-100 text-purple-800 border-purple-300'}`}>
                                        24/7 assistance
                                    </Badge>
                                </CardContent>
                            </Card>
                        </motion.div>

                        <motion.div
                            initial={{ opacity: 0, y: 20 }}
                            whileInView={{ opacity: 1, y: 0 }}
                            viewport={{ once: true }}
                            transition={{ duration: 0.5, delay: 0.3 }}
                        >
                            <Card className={`h-full backdrop-blur-xl transition-all duration-300 hover:-translate-y-2 ${isDarkMode ? 'bg-white/5 border border-white/10 hover:bg-white/10 hover:border-indigo-500/50' : 'bg-white border border-slate-200 hover:border-indigo-300 shadow-lg hover:shadow-xl'}`}>
                                <CardHeader>
                                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center mb-4 ${isDarkMode ? 'bg-gradient-to-br from-amber-500/20 to-orange-600/20' : 'bg-gradient-to-br from-amber-100 to-orange-100'}`}>
                                        <Target className={`w-6 h-6 ${isDarkMode ? 'text-amber-400' : 'text-amber-700'}`} />
                                    </div>
                                    <CardTitle className={`text-xl ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Never Miss a Deal</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className={`mb-4 ${isDarkMode ? 'text-indigo-200' : 'text-slate-700'}`}>
                                        Smart calendar with GPS routing and travel time alerts. Transaction pipeline tracking ensures every deadline is met and no opportunity falls through the cracks.
                                    </p>
                                    <Badge className={`${isDarkMode ? 'bg-amber-500/20 text-amber-300 border-amber-500/30' : 'bg-amber-100 text-amber-800 border-amber-300'}`}>
                                        47% faster response time
                                    </Badge>
                                </CardContent>
                            </Card>
                        </motion.div>

                        <motion.div
                            initial={{ opacity: 0, y: 20 }}
                            whileInView={{ opacity: 1, y: 0 }}
                            viewport={{ once: true }}
                            transition={{ duration: 0.5, delay: 0.4 }}
                        >
                            <Card className={`h-full backdrop-blur-xl transition-all duration-300 hover:-translate-y-2 ${isDarkMode ? 'bg-white/5 border border-white/10 hover:bg-white/10 hover:border-indigo-500/50' : 'bg-white border border-slate-200 hover:border-indigo-300 shadow-lg hover:shadow-xl'}`}>
                                <CardHeader>
                                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center mb-4 ${isDarkMode ? 'bg-gradient-to-br from-rose-500/20 to-red-600/20' : 'bg-gradient-to-br from-rose-100 to-red-100'}`}>
                                        <Users className={`w-6 h-6 ${isDarkMode ? 'text-rose-400' : 'text-rose-700'}`} />
                                    </div>
                                    <CardTitle className={`text-xl ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Know Your Clients Better</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className={`mb-4 ${isDarkMode ? 'text-indigo-200' : 'text-slate-700'}`}>
                                        Social intelligence monitors buyer intent from Facebook, Instagram, and LinkedIn. Detect life events, job changes, and perfect timing for outreach.
                                    </p>
                                    <Badge className={`${isDarkMode ? 'bg-rose-500/20 text-rose-300 border-rose-500/30' : 'bg-rose-100 text-rose-800 border-rose-300'}`}>
                                        Buyer intent tracking
                                    </Badge>
                                </CardContent>
                            </Card>
                        </motion.div>

                        <motion.div
                            initial={{ opacity: 0, y: 20 }}
                            whileInView={{ opacity: 1, y: 0 }}
                            viewport={{ once: true }}
                            transition={{ duration: 0.5, delay: 0.5 }}
                        >
                            <Card className={`h-full backdrop-blur-xl transition-all duration-300 hover:-translate-y-2 ${isDarkMode ? 'bg-white/5 border border-white/10 hover:bg-white/10 hover:border-indigo-500/50' : 'bg-white border border-slate-200 hover:border-indigo-300 shadow-lg hover:shadow-xl'}`}>
                                <CardHeader>
                                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center mb-4 ${isDarkMode ? 'bg-gradient-to-br from-cyan-500/20 to-teal-600/20' : 'bg-gradient-to-br from-cyan-100 to-teal-100'}`}>
                                        <Briefcase className={`w-6 h-6 ${isDarkMode ? 'text-cyan-400' : 'text-cyan-700'}`} />
                                    </div>
                                    <CardTitle className={`text-xl ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>All-in-One Platform</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className={`mb-4 ${isDarkMode ? 'text-indigo-200' : 'text-slate-700'}`}>
                                        Replace 10+ separate tools with one comprehensive system. CRM, transaction management, marketing automation, documents, and team collaboration‚Äîall connected.
                                    </p>
                                    <Badge className={`${isDarkMode ? 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30' : 'bg-cyan-100 text-cyan-800 border-cyan-300'}`}>
                                        24+ integrated features
                                    </Badge>
                                </CardContent>
                            </Card>
                        </motion.div>
                    </div>
                </div>
            </section>

            {/* Features Section */}
            <section className="relative z-10 py-20 px-6">
                <div className="max-w-7xl mx-auto">
                    <motion.div 
                        className="text-center mb-16"
                        initial={{ opacity: 0, y: 20 }}
                        whileInView={{ opacity: 1, y: 0 }}
                        viewport={{ once: true }}
                        transition={{ duration: 0.6 }}
                    >
                        <Badge className={`mb-4 backdrop-blur-xl ${isDarkMode ? 'bg-white/10 border border-white/20 text-white' : 'bg-indigo-100 border border-indigo-300 text-indigo-900'}`}>Features</Badge>
                        <h3 className={`text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r bg-clip-text text-transparent ${isDarkMode ? 'from-white to-indigo-200' : 'from-slate-900 to-indigo-800'}`}>
                            Everything You Need to Dominate Real Estate
                        </h3>
                        <p className={`text-lg max-w-2xl mx-auto ${isDarkMode ? 'text-indigo-200' : 'text-slate-700'}`}>
                            A complete platform designed specifically for real estate professionals who want to work smarter, not harder.
                        </p>
                        <p className={`text-md mt-4 font-semibold ${isDarkMode ? 'text-indigo-300' : 'text-slate-600'}`}>
                            ‚ú® All Features Connected ‚Ä¢ One Complete Transaction Platform ‚Ä¢ A to Z Automation
                        </p>
                    </motion.div>
                    
                    {/* Connection Lines SVG Overlay */}
                    <div className="absolute inset-0 pointer-events-none" style={{ top: '200px' }}>
                        <svg className="w-full h-full opacity-20">
                            {/* Horizontal lines connecting features in rows */}
                            {[0, 1, 2, 3, 4, 5, 6, 7].map((row) => (
                                <motion.line
                                    key={`h-${row}`}
                                    x1="15%"
                                    y1={`${row * 12.5 + 6}%`}
                                    x2="85%"
                                    y2={`${row * 12.5 + 6}%`}
                                    stroke="white"
                                    strokeWidth="1"
                                    strokeDasharray="5,5"
                                    initial={{ pathLength: 0, opacity: 0 }}
                                    whileInView={{ pathLength: 1, opacity: 0.3 }}
                                    viewport={{ once: true }}
                                    transition={{ duration: 1.5, delay: row * 0.2 }}
                                />
                            ))}
                            
                            {/* Vertical lines connecting features in columns */}
                            {[0, 1, 2].map((col) => (
                                <motion.line
                                    key={`v-${col}`}
                                    x1={`${col * 33.33 + 16.67}%`}
                                    y1="5%"
                                    x2={`${col * 33.33 + 16.67}%`}
                                    y2="95%"
                                    stroke="white"
                                    strokeWidth="1"
                                    strokeDasharray="5,5"
                                    initial={{ pathLength: 0, opacity: 0 }}
                                    whileInView={{ pathLength: 1, opacity: 0.3 }}
                                    viewport={{ once: true }}
                                    transition={{ duration: 1.5, delay: col * 0.3 }}
                                />
                            ))}
                            
                            {/* Diagonal connecting lines for flow */}
                            <motion.line
                                x1="20%" y1="10%" x2="80%" y2="90%"
                                stroke="white" strokeWidth="0.5" strokeDasharray="3,3"
                                initial={{ pathLength: 0, opacity: 0 }}
                                whileInView={{ pathLength: 1, opacity: 0.15 }}
                                viewport={{ once: true }}
                                transition={{ duration: 2, delay: 0.5 }}
                            />
                            <motion.line
                                x1="80%" y1="10%" x2="20%" y2="90%"
                                stroke="white" strokeWidth="0.5" strokeDasharray="3,3"
                                initial={{ pathLength: 0, opacity: 0 }}
                                whileInView={{ pathLength: 1, opacity: 0.15 }}
                                viewport={{ once: true }}
                                transition={{ duration: 2, delay: 0.7 }}
                            />
                            
                            {/* Animated data flow particles */}
                            {[...Array(8)].map((_, i) => (
                                <motion.circle
                                    key={`particle-${i}`}
                                    r="2"
                                    fill="white"
                                    initial={{ opacity: 0 }}
                                    animate={{
                                        cx: [`${(i % 3) * 33.33 + 16.67}%`, `${((i + 1) % 3) * 33.33 + 16.67}%`],
                                        cy: [`${(i % 8) * 12.5 + 6}%`, `${((i + 1) % 8) * 12.5 + 6}%`],
                                        opacity: [0, 0.6, 0],
                                    }}
                                    transition={{
                                        duration: 3,
                                        repeat: Infinity,
                                        delay: i * 0.4,
                                        ease: "easeInOut"
                                    }}
                                />
                            ))}
                        </svg>
                    </div>
                    
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 relative z-10">
                        {features.map((feature, idx) => (
                            <motion.div
                                key={idx}
                                initial={{ opacity: 0, y: 20 }}
                                whileInView={{ opacity: 1, y: 0 }}
                                viewport={{ once: true }}
                                transition={{ duration: 0.5, delay: idx * 0.1 }}
                            >
                                <Card 
                                    onClick={() => feature.page && navigate(createPageUrl(feature.page))}
                                    className={`group h-full backdrop-blur-xl transition-all duration-300 hover:-translate-y-2 ${feature.page ? 'cursor-pointer' : ''} ${isDarkMode ? 'bg-white/5 border border-white/10 hover:bg-white/10 hover:border-white/20 hover:shadow-2xl hover:shadow-indigo-500/20' : 'bg-white border border-slate-200 hover:border-indigo-300 shadow-md hover:shadow-xl'}`}
                                >
                                    <CardHeader>
                                        <div className="relative w-12 h-12 mb-4">
                                            <div className={`absolute inset-0 rounded-lg blur-md transition-opacity ${isDarkMode ? 'bg-gradient-to-br from-indigo-500 to-purple-600 opacity-50 group-hover:opacity-100' : 'bg-gradient-to-br from-indigo-300 to-purple-300 opacity-30 group-hover:opacity-60'}`} />
                                            <div className={`relative w-12 h-12 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform ${isDarkMode ? 'bg-gradient-to-br from-indigo-500/20 to-purple-600/20' : 'bg-gradient-to-br from-indigo-100 to-purple-100'}`}>
                                                <feature.icon className={`w-6 h-6 transition-colors ${isDarkMode ? 'text-indigo-300 group-hover:text-indigo-100' : 'text-indigo-700 group-hover:text-indigo-900'}`} />
                                            </div>
                                        </div>
                                        <CardTitle className={`text-lg ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>{feature.title}</CardTitle>
                                    </CardHeader>
                                    <CardContent>
                                        <p className={`${isDarkMode ? 'text-indigo-200' : 'text-slate-700'}`}>{feature.desc}</p>
                                        {feature.page && (
                                            <div className={`mt-4 text-sm font-medium group-hover:translate-x-1 transition-transform inline-flex items-center gap-1 ${isDarkMode ? 'text-indigo-400' : 'text-indigo-700'}`}>
                                                Learn more <ArrowRight className="w-4 h-4" />
                                            </div>
                                        )}
                                    </CardContent>
                                </Card>
                            </motion.div>
                        ))}
                    </div>
                </div>
            </section>

            {/* Technology Section */}
            <section className="relative z-10 py-20 px-6">
                <div className="max-w-7xl mx-auto">
                    <motion.div 
                        className="text-center mb-16"
                        initial={{ opacity: 0, y: 20 }}
                        whileInView={{ opacity: 1, y: 0 }}
                        viewport={{ once: true }}
                        transition={{ duration: 0.6 }}
                    >
                        <Badge className="mb-4 bg-white/10 backdrop-blur-xl border border-white/20 text-white">Technology</Badge>
                        <h3 className="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-white to-indigo-200 bg-clip-text text-transparent">
                            Powered by Industry-Leading Technology
                        </h3>
                        <p className="text-lg text-indigo-200 max-w-2xl mx-auto">
                            We integrate with the best data sources and platforms to give you unmatched insights.
                        </p>
                    </motion.div>
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {technologies.map((tech, idx) => (
                            <motion.div
                                key={idx}
                                initial={{ opacity: 0, scale: 0.9 }}
                                whileInView={{ opacity: 1, scale: 1 }}
                                viewport={{ once: true }}
                                transition={{ duration: 0.5, delay: idx * 0.1 }}
                            >
                                <Card className="bg-white/5 backdrop-blur-xl border border-white/10 hover:bg-white/10 hover:border-white/20 transition-all duration-300">
                                    <CardContent className="p-6">
                                        <div className="flex items-start gap-4">
                                            <div className="relative w-10 h-10 flex-shrink-0">
                                                <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg blur-md" />
                                                <div className="relative w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center">
                                                    <Zap className="w-5 h-5 text-white" />
                                                </div>
                                            </div>
                                            <div>
                                                <h4 className="font-semibold text-white mb-1">{tech.name}</h4>
                                                <p className="text-sm text-indigo-200">{tech.desc}</p>
                                            </div>
                                        </div>
                                    </CardContent>
                                </Card>
                            </motion.div>
                        ))}
                    </div>
                </div>
            </section>

            {/* Pricing Section */}
            <section id="pricing" className="relative z-10 py-20 px-6">
                <div className="max-w-7xl mx-auto">
                    <motion.div 
                        className="text-center mb-12"
                        initial={{ opacity: 0, y: 20 }}
                        whileInView={{ opacity: 1, y: 0 }}
                        viewport={{ once: true }}
                        transition={{ duration: 0.6 }}
                    >
                        <Badge className="mb-4 bg-white/10 backdrop-blur-xl border border-white/20 text-white">Pricing</Badge>
                        <h3 className="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-white to-indigo-200 bg-clip-text text-transparent">
                            Choose Your Plan
                        </h3>
                        <p className="text-lg text-indigo-200 mb-8">
                            Start with a 14-day free trial. No credit card required.
                        </p>
                        
                        {/* Billing Toggle */}
                        <div className="inline-flex items-center gap-3 bg-white/5 backdrop-blur-xl border border-white/10 p-1 rounded-lg">
                            <button
                                onClick={() => setBillingCycle('monthly')}
                                className={`px-6 py-2 rounded-md transition-all ${
                                    billingCycle === 'monthly'
                                        ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg shadow-indigo-500/50 font-semibold'
                                        : 'text-indigo-300 hover:text-white'
                                }`}
                            >
                                Monthly
                            </button>
                            <button
                                onClick={() => setBillingCycle('annual')}
                                className={`px-6 py-2 rounded-md transition-all ${
                                    billingCycle === 'annual'
                                        ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg shadow-indigo-500/50 font-semibold'
                                        : 'text-indigo-300 hover:text-white'
                                }`}
                            >
                                Annual
                                <Badge className="ml-2 bg-green-500 text-white">Save 20%</Badge>
                            </button>
                        </div>
                    </motion.div>

                    <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                        {pricingPlans.map((plan, idx) => (
                            <motion.div
                                key={plan.name}
                                initial={{ opacity: 0, y: 20 }}
                                whileInView={{ opacity: 1, y: 0 }}
                                viewport={{ once: true }}
                                transition={{ duration: 0.5, delay: idx * 0.1 }}
                            >
                                <Card 
                                    className={`relative h-full ${
                                        plan.popular 
                                            ? 'bg-gradient-to-br from-indigo-900/50 to-purple-900/50 backdrop-blur-xl border-2 border-indigo-500 shadow-2xl shadow-indigo-500/50 scale-105' 
                                            : 'bg-white/5 backdrop-blur-xl border border-white/10 hover:bg-white/10 hover:border-white/20'
                                    } transition-all duration-300 hover:-translate-y-2`}
                                >
                                    {plan.popular && (
                                        <div className="absolute -top-4 left-1/2 -translate-x-1/2">
                                            <Badge className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg shadow-indigo-500/50">
                                                <Star className="w-3 h-3 mr-1" />
                                                Most Popular
                                            </Badge>
                                        </div>
                                    )}
                                    <CardHeader>
                                        <CardTitle className="text-2xl text-white">{plan.name}</CardTitle>
                                        <p className="text-sm text-indigo-200">{plan.description}</p>
                                        <div className="mt-4">
                                            <span className="text-4xl font-bold bg-gradient-to-r from-white to-indigo-200 bg-clip-text text-transparent">
                                                ${plan.price[billingCycle]}
                                            </span>
                                            <span className="text-indigo-300">
                                                /{billingCycle === 'monthly' ? 'mo' : 'year'}
                                            </span>
                                            {billingCycle === 'annual' && (
                                                <p className="text-sm text-green-400 mt-1">
                                                    Save ${(plan.price.monthly * 12) - plan.price.annual}/year
                                                </p>
                                            )}
                                        </div>
                                    </CardHeader>
                                    <CardContent>
                                        <Button 
                                            onClick={handleGetStarted}
                                            className={`w-full mb-6 shadow-lg ${
                                                plan.popular
                                                    ? 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 shadow-indigo-500/50'
                                                    : 'bg-white/10 hover:bg-white/20 text-white border border-white/20'
                                            }`}
                                        >
                                            Start Free Trial
                                        </Button>
                                        <ul className="space-y-3">
                                            {plan.features.map((feature, idx) => (
                                                <li key={idx} className="flex items-start gap-2">
                                                    <Check className="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" />
                                                    <span className="text-sm text-indigo-100">{feature}</span>
                                                </li>
                                            ))}
                                            {plan.notIncluded.map((feature, idx) => (
                                                <li key={idx} className="flex items-start gap-2 opacity-40">
                                                    <X className="w-5 h-5 text-indigo-400 flex-shrink-0 mt-0.5" />
                                                    <span className="text-sm text-indigo-300 line-through">{feature}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </CardContent>
                                </Card>
                            </motion.div>
                        ))}
                    </div>

                    {/* Discount Options */}
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95 }}
                        whileInView={{ opacity: 1, scale: 1 }}
                        viewport={{ once: true }}
                        transition={{ duration: 0.5 }}
                    >
                        <Card className="relative overflow-hidden bg-gradient-to-br from-amber-900/50 to-orange-900/50 backdrop-blur-xl border border-amber-500/30">
                            <div className="absolute inset-0 bg-gradient-to-r from-amber-500/10 to-orange-500/10" />
                            <CardContent className="relative p-8 text-center">
                                <Award className="w-12 h-12 text-amber-400 mx-auto mb-4" />
                                <h4 className="text-2xl font-bold text-white mb-2">
                                    Special Launch Offer
                                </h4>
                                <p className="text-amber-100 mb-4">
                                    üéâ Get 20% off annual plans ‚Ä¢ üí∞ 3 months free on Enterprise (annual) ‚Ä¢ üöÄ Early adopter pricing locked in forever
                                </p>
                                <p className="text-sm text-amber-200">
                                    Limited time offer. Terms apply.
                                </p>
                            </CardContent>
                        </Card>
                    </motion.div>
                </div>
            </section>

            {/* CTA Section */}
            <section className="relative z-10 py-20 px-6 overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 opacity-20" />
                <motion.div 
                    className="relative max-w-4xl mx-auto text-center"
                    initial={{ opacity: 0, y: 30 }}
                    whileInView={{ opacity: 1, y: 0 }}
                    viewport={{ once: true }}
                    transition={{ duration: 0.8 }}
                >
                    <h3 className="text-4xl md:text-5xl font-bold mb-6 bg-gradient-to-r from-white to-indigo-200 bg-clip-text text-transparent">
                        Ready to Transform Your Real Estate Business?
                    </h3>
                    <p className="text-xl text-indigo-100 mb-8">
                        Join thousands of top-performing agents who trust RealtyMind to close more deals.
                    </p>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">
                        <Input
                            type="email"
                            placeholder="Enter your email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="max-w-md bg-white/10 backdrop-blur-xl border-white/20 text-white placeholder:text-indigo-300"
                        />
                        <Button 
                            size="lg" 
                            onClick={handleGetStarted}
                            className="relative group bg-white text-indigo-600 hover:bg-white/90 shadow-2xl shadow-white/20"
                        >
                            <span className="relative z-10">Start Free Trial</span>
                            <ArrowRight className="w-5 h-5 ml-2 relative z-10 group-hover:translate-x-1 transition-transform" />
                        </Button>
                    </div>
                    <p className="text-sm text-indigo-200 mt-4">
                        ‚ú® 14-day free trial ‚Ä¢ üí≥ No credit card required ‚Ä¢ üöÄ Setup in 5 minutes
                    </p>
                </motion.div>
            </section>

            {/* Footer */}
            <footer className="relative z-10 bg-black/40 backdrop-blur-xl border-t border-white/10 py-12 px-6">
                <div className="max-w-7xl mx-auto text-center">
                    <div className="flex items-center justify-center gap-3 mb-4">
                        <div className="relative w-8 h-8">
                            <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg blur-md" />
                            <div className="relative w-8 h-8 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center">
                                <Brain className="w-5 h-5 text-white" />
                            </div>
                        </div>
                        <span className="text-xl font-bold bg-gradient-to-r from-white to-indigo-200 bg-clip-text text-transparent">RealtyMind</span>
                    </div>
                    <p className="text-indigo-300 mb-6">The Mind Behind Every Deal</p>
                    <div className="flex items-center justify-center gap-6 text-sm text-indigo-300">
                        <span>¬© 2024 RealtyMind. All rights reserved.</span>
                        <span>‚Ä¢</span>
                        <button className="hover:text-white transition-colors">Privacy Policy</button>
                        <span>‚Ä¢</span>
                        <button className="hover:text-white transition-colors">Terms of Service</button>
                    </div>
                </div>
            </footer>

            {/* Comet-style Login Modal */}
            {showLoginModal && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    {/* Backdrop */}
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="absolute inset-0 bg-black/80 backdrop-blur-2xl"
                        onClick={() => setShowLoginModal(false)}
                    />
                    
                    {/* Modal */}
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9, y: 20 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.9, y: 20 }}
                        transition={{ type: "spring", duration: 0.5 }}
                        className="relative max-w-md w-full"
                    >
                        <Card className="bg-gradient-to-br from-slate-900/95 to-indigo-950/95 backdrop-blur-2xl border border-white/10 shadow-2xl shadow-indigo-500/20">
                            <button
                                onClick={() => setShowLoginModal(false)}
                                className="absolute top-4 right-4 text-white/60 hover:text-white transition-colors"
                            >
                                <X className="w-5 h-5" />
                            </button>

                            <CardHeader className="space-y-4 pt-8">
                                <div className="flex justify-center mb-2">
                                    <div className="relative w-16 h-16">
                                        <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl blur-xl animate-pulse" />
                                        <div className="relative w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/50">
                                            <Brain className="w-9 h-9 text-white" />
                                        </div>
                                    </div>
                                </div>
                                <div className="text-center">
                                    <h2 className="text-2xl font-bold bg-gradient-to-r from-white to-indigo-200 bg-clip-text text-transparent mb-1">
                                        Welcome Back
                                    </h2>
                                    <p className="text-sm text-indigo-300">
                                        Sign in to RealtyMind
                                    </p>
                                </div>
                            </CardHeader>

                            <CardContent className="space-y-4 px-8 pb-8">
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <div className="space-y-2">
                                        <Label className="text-white/90 text-sm">Email</Label>
                                        <Input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            placeholder="you@example.com"
                                            className="bg-white/5 border-white/10 text-white placeholder:text-white/40 focus:border-indigo-500 focus:ring-indigo-500/20 h-11"
                                            required
                                        />
                                    </div>

                                    <div className="space-y-2">
                                        <Label className="text-white/90 text-sm">Password</Label>
                                        <Input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            placeholder="Enter your password"
                                            className="bg-white/5 border-white/10 text-white placeholder:text-white/40 focus:border-indigo-500 focus:ring-indigo-500/20 h-11"
                                            required
                                        />
                                    </div>

                                    <div className="flex items-center justify-between text-sm">
                                        <label className="flex items-center gap-2 text-white/70 cursor-pointer">
                                            <input type="checkbox" className="rounded border-white/20 bg-white/5" />
                                            Remember me
                                        </label>
                                        <button type="button" className="text-indigo-400 hover:text-indigo-300 transition-colors">
                                            Forgot password?
                                        </button>
                                    </div>

                                    <Button
                                        type="submit"
                                        disabled={isLoggingIn}
                                        className="w-full h-12 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-lg shadow-indigo-500/50 hover:shadow-indigo-500/80 transition-all"
                                    >
                                        {isLoggingIn ? (
                                            <>
                                                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                                Signing in...
                                            </>
                                        ) : (
                                            <>
                                                Sign in
                                                <ArrowRight className="w-4 h-4 ml-2" />
                                            </>
                                        )}
                                    </Button>
                                </form>

                                <div className="relative">
                                    <div className="absolute inset-0 flex items-center">
                                        <div className="w-full border-t border-white/10"></div>
                                    </div>
                                    <div className="relative flex justify-center text-xs">
                                        <span className="px-2 bg-slate-900 text-white/60">Or continue with</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <Button
                                        type="button"
                                        variant="outline"
                                        onClick={handleGetStarted}
                                        className="border-white/10 bg-white/5 hover:bg-white/10 text-white h-11"
                                    >
                                        <Globe className="w-4 h-4 mr-2" />
                                        Google
                                    </Button>
                                    <Button
                                        type="button"
                                        variant="outline"
                                        onClick={handleGetStarted}
                                        className="border-white/10 bg-white/5 hover:bg-white/10 text-white h-11"
                                    >
                                        <Mail className="w-4 h-4 mr-2" />
                                        Microsoft
                                    </Button>
                                </div>

                                <div className="text-center pt-4">
                                    <p className="text-sm text-white/60">
                                        Don't have an account?{' '}
                                        <button
                                            onClick={() => {
                                                setShowLoginModal(false);
                                                handleGetStarted();
                                            }}
                                            className="text-indigo-400 hover:text-indigo-300 font-semibold transition-colors"
                                        >
                                            Start free trial
                                        </button>
                                    </p>
                                </div>
                            </CardContent>
                        </Card>
                    </motion.div>
                </div>
            )}
        </div>
    );
}
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Textarea } from '@/components/ui/textarea';
import {
  Home, TrendingUp, Mail, Phone, MapPin, Calendar, DollarSign,
  Sparkles, Brain, Target, ExternalLink, Loader2, RefreshCw,
  User, MessageSquare, CheckCircle2, AlertCircle, BarChart3
} from 'lucide-react';
import { toast } from 'sonner';
import { motion } from 'framer-motion';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

export default function WhatMyHomeWorth() {
  const queryClient = useQueryClient();
  const [selectedRequest, setSelectedRequest] = useState(null);
  const [showAnalysisModal, setShowAnalysisModal] = useState(false);
  const [analyzingId, setAnalyzingId] = useState(null);
  const [filterStatus, setFilterStatus] = useState('all');

  const { data: requests = [], isLoading } = useQuery({
    queryKey: ['homeWorthRequests'],
    queryFn: () => base44.entities.HomeWorthRequest.list('-created_date'),
  });

  const updateStatusMutation = useMutation({
    mutationFn: ({ id, status }) => base44.entities.HomeWorthRequest.update(id, { status }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['homeWorthRequests'] });
      toast.success('Status updated');
    },
  });

  const analyzeLeadMutation = useMutation({
    mutationFn: async (request) => {
      setAnalyzingId(request.id);
      
      // Perform AI analysis with social media lookup
      const analysis = await base44.integrations.Core.InvokeLLM({
        prompt: `Analyze this home valuation lead and determine their motivation and likelihood to sell:

Client Information:
- Name: ${request.name}
- Email: ${request.email}
- Phone: ${request.phone || 'Not provided'}

Property Information:
- Address: ${request.property_address}, ${request.city}, ${request.state}
- Estimated Value: $${request.estimated_value?.toLocaleString() || 'N/A'}
- Value Range: $${request.value_range_low?.toLocaleString()} - $${request.value_range_high?.toLocaleString()}

Task: Search the internet for publicly available information about this person and property to determine:
1. Seller motivation (job change, relocation, downsizing, upgrading, financial stress, etc.)
2. Property ownership details and history
3. Life events that might indicate selling intent (marriage, divorce, retirement, new job, etc.)
4. Social media activity or public records suggesting intent
5. Local market conditions affecting urgency
6. Financial capacity indicators

Provide a comprehensive lead score (0-100) and motivation assessment.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            lead_score: { type: "number" },
            motivation_level: { type: "string", enum: ["low", "medium", "high", "very_high"] },
            motivation_factors: { type: "array", items: { type: "string" } },
            intent_signals: { type: "array", items: { 
              type: "object",
              properties: {
                signal: { type: "string" },
                strength: { type: "string" },
                source: { type: "string" }
              }
            }},
            recommended_actions: { type: "array", items: { type: "string" } },
            best_contact_time: { type: "string" },
            talking_points: { type: "array", items: { type: "string" } },
            urgency_level: { type: "string" },
            estimated_timeline: { type: "string" },
            risk_factors: { type: "array", items: { type: "string" } },
            summary: { type: "string" }
          }
        }
      });

      // Update the request with analysis
      await base44.entities.HomeWorthRequest.update(request.id, {
        lead_score: analysis.lead_score,
        motivation_level: analysis.motivation_level,
        social_analysis: JSON.stringify(analysis),
        intent_signals: JSON.stringify(analysis.intent_signals),
        recommended_actions: JSON.stringify(analysis.recommended_actions),
        last_analyzed: new Date().toISOString()
      });

      return analysis;
    },
    onSuccess: (data, request) => {
      queryClient.invalidateQueries({ queryKey: ['homeWorthRequests'] });
      setSelectedRequest({ ...request, social_analysis: JSON.stringify(data) });
      setShowAnalysisModal(true);
      toast.success('AI analysis complete!');
      setAnalyzingId(null);
    },
    onError: (error) => {
      toast.error('Analysis failed: ' + error.message);
      setAnalyzingId(null);
    }
  });

  const formatDate = (dateStr) => {
    if (!dateStr) return 'N/A';
    return new Date(dateStr).toLocaleDateString();
  };

  const formatCurrency = (value) => {
    if (!value) return 'N/A';
    return `$${value.toLocaleString()}`;
  };

  const getScoreColor = (score) => {
    if (score >= 80) return 'text-green-600 bg-green-100';
    if (score >= 60) return 'text-blue-600 bg-blue-100';
    if (score >= 40) return 'text-yellow-600 bg-yellow-100';
    return 'text-red-600 bg-red-100';
  };

  const getMotivationColor = (level) => {
    const colors = {
      very_high: 'bg-red-100 text-red-800',
      high: 'bg-orange-100 text-orange-800',
      medium: 'bg-yellow-100 text-yellow-800',
      low: 'bg-blue-100 text-blue-800',
      unknown: 'bg-gray-100 text-gray-800'
    };
    return colors[level] || colors.unknown;
  };

  const filteredRequests = filterStatus === 'all' 
    ? requests 
    : requests.filter(r => r.status === filterStatus);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                <Home className="w-8 h-8 text-indigo-600" />
                What's My Home Worth - Lead Analysis
              </h1>
              <p className="text-slate-600 dark:text-slate-400 mt-2">
                AI-powered lead scoring and motivation analysis for home valuation requests
              </p>
            </div>
          </div>

          {/* Filters */}
          <div className="flex gap-4 items-center">
            <Select value={filterStatus} onValueChange={setFilterStatus}>
              <SelectTrigger className="w-48">
                <SelectValue placeholder="Filter by status" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Requests</SelectItem>
                <SelectItem value="new">New</SelectItem>
                <SelectItem value="contacted">Contacted</SelectItem>
                <SelectItem value="qualified">Qualified</SelectItem>
                <SelectItem value="nurturing">Nurturing</SelectItem>
                <SelectItem value="converted">Converted</SelectItem>
                <SelectItem value="lost">Lost</SelectItem>
              </SelectContent>
            </Select>
            <Badge variant="outline" className="text-base">
              {filteredRequests.length} requests
            </Badge>
          </div>
        </div>

        {/* Requests Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
          {filteredRequests.map((request) => {
            const socialAnalysis = request.social_analysis ? JSON.parse(request.social_analysis) : null;

            return (
              <motion.div
                key={request.id}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.3 }}
              >
                <Card className="hover:shadow-xl transition-shadow">
                  <CardHeader>
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <CardTitle className="text-lg flex items-center gap-2">
                          <User className="w-5 h-5 text-indigo-600" />
                          {request.name}
                        </CardTitle>
                        <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">
                          {formatDate(request.created_date)}
                        </p>
                      </div>
                      {request.lead_score > 0 && (
                        <Badge className={`${getScoreColor(request.lead_score)} font-bold`}>
                          {request.lead_score}/100
                        </Badge>
                      )}
                    </div>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {/* Contact Info */}
                    <div className="space-y-2">
                      <div className="flex items-center gap-2 text-sm">
                        <Mail className="w-4 h-4 text-slate-500" />
                        <span className="text-slate-700 dark:text-slate-300">{request.email}</span>
                      </div>
                      {request.phone && (
                        <div className="flex items-center gap-2 text-sm">
                          <Phone className="w-4 h-4 text-slate-500" />
                          <span className="text-slate-700 dark:text-slate-300">{request.phone}</span>
                        </div>
                      )}
                      <div className="flex items-start gap-2 text-sm">
                        <MapPin className="w-4 h-4 text-slate-500 mt-0.5" />
                        <span className="text-slate-700 dark:text-slate-300">
                          {request.property_address}, {request.city}, {request.state}
                        </span>
                      </div>
                    </div>

                    {/* Property Value */}
                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-4 rounded-lg">
                      <p className="text-sm text-green-700 dark:text-green-300 mb-1">Estimated Value</p>
                      <p className="text-2xl font-bold text-green-900 dark:text-green-100">
                        {formatCurrency(request.estimated_value)}
                      </p>
                      {request.value_range_low && request.value_range_high && (
                        <p className="text-xs text-green-600 dark:text-green-400 mt-1">
                          Range: {formatCurrency(request.value_range_low)} - {formatCurrency(request.value_range_high)}
                        </p>
                      )}
                    </div>

                    {/* Motivation Level */}
                    {request.motivation_level && request.motivation_level !== 'unknown' && (
                      <div className="flex items-center gap-2">
                        <Target className="w-4 h-4 text-slate-500" />
                        <Badge className={getMotivationColor(request.motivation_level)}>
                          {request.motivation_level.replace('_', ' ').toUpperCase()} Motivation
                        </Badge>
                      </div>
                    )}

                    {/* Status */}
                    <div>
                      <Select
                        value={request.status}
                        onValueChange={(status) => updateStatusMutation.mutate({ id: request.id, status })}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="new">New</SelectItem>
                          <SelectItem value="contacted">Contacted</SelectItem>
                          <SelectItem value="qualified">Qualified</SelectItem>
                          <SelectItem value="nurturing">Nurturing</SelectItem>
                          <SelectItem value="converted">Converted</SelectItem>
                          <SelectItem value="lost">Lost</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    {/* Actions */}
                    <div className="flex gap-2">
                      <Button
                        onClick={() => analyzeLeadMutation.mutate(request)}
                        disabled={analyzingId === request.id}
                        className="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600"
                        size="sm"
                      >
                        {analyzingId === request.id ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Analyzing...
                          </>
                        ) : (
                          <>
                            <Brain className="w-4 h-4 mr-2" />
                            {request.lead_score > 0 ? 'Re-analyze' : 'Analyze'}
                          </>
                        )}
                      </Button>
                      {socialAnalysis && (
                        <Button
                          onClick={() => {
                            setSelectedRequest(request);
                            setShowAnalysisModal(true);
                          }}
                          variant="outline"
                          size="sm"
                        >
                          <BarChart3 className="w-4 h-4" />
                        </Button>
                      )}
                    </div>
                  </CardContent>
                </Card>
              </motion.div>
            );
          })}
        </div>

        {filteredRequests.length === 0 && (
          <Card className="text-center p-12">
            <Home className="w-16 h-16 text-slate-300 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-slate-700 mb-2">No requests yet</h3>
            <p className="text-slate-500">Home valuation requests will appear here</p>
          </Card>
        )}

        {/* Analysis Modal */}
        {showAnalysisModal && selectedRequest && (() => {
          const analysis = JSON.parse(selectedRequest.social_analysis || '{}');
          return (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <Card className="max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <CardTitle className="text-2xl flex items-center gap-2">
                      <Brain className="w-6 h-6 text-indigo-600" />
                      AI Lead Analysis
                    </CardTitle>
                    <Button variant="ghost" onClick={() => setShowAnalysisModal(false)}>‚úï</Button>
                  </div>
                  <p className="text-slate-600">{selectedRequest.name} - {selectedRequest.property_address}</p>
                </CardHeader>
                <CardContent className="space-y-6">
                  {/* Score Overview */}
                  <div className="grid grid-cols-3 gap-4">
                    <Card className="bg-gradient-to-br from-indigo-50 to-purple-50">
                      <CardContent className="p-4 text-center">
                        <p className="text-sm text-slate-600 mb-1">Lead Score</p>
                        <p className="text-3xl font-bold text-indigo-600">{analysis.lead_score}/100</p>
                      </CardContent>
                    </Card>
                    <Card className="bg-gradient-to-br from-orange-50 to-red-50">
                      <CardContent className="p-4 text-center">
                        <p className="text-sm text-slate-600 mb-1">Motivation</p>
                        <p className="text-xl font-bold text-orange-600 capitalize">{analysis.motivation_level}</p>
                      </CardContent>
                    </Card>
                    <Card className="bg-gradient-to-br from-green-50 to-emerald-50">
                      <CardContent className="p-4 text-center">
                        <p className="text-sm text-slate-600 mb-1">Timeline</p>
                        <p className="text-sm font-semibold text-green-600">{analysis.estimated_timeline || 'Unknown'}</p>
                      </CardContent>
                    </Card>
                  </div>

                  {/* Summary */}
                  <div>
                    <h3 className="font-semibold text-lg mb-2 flex items-center gap-2">
                      <Sparkles className="w-5 h-5 text-yellow-500" />
                      Summary
                    </h3>
                    <p className="text-slate-700 bg-slate-50 p-4 rounded-lg">{analysis.summary}</p>
                  </div>

                  {/* Motivation Factors */}
                  {analysis.motivation_factors?.length > 0 && (
                    <div>
                      <h3 className="font-semibold text-lg mb-2">Motivation Factors</h3>
                      <ul className="space-y-2">
                        {analysis.motivation_factors.map((factor, idx) => (
                          <li key={idx} className="flex items-start gap-2">
                            <CheckCircle2 className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
                            <span className="text-slate-700">{factor}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Intent Signals */}
                  {analysis.intent_signals?.length > 0 && (
                    <div>
                      <h3 className="font-semibold text-lg mb-2">Intent Signals</h3>
                      <div className="space-y-2">
                        {analysis.intent_signals.map((signal, idx) => (
                          <div key={idx} className="bg-blue-50 p-3 rounded-lg">
                            <div className="flex items-center justify-between mb-1">
                              <span className="font-medium text-blue-900">{signal.signal}</span>
                              <Badge className="bg-blue-600 text-white">{signal.strength}</Badge>
                            </div>
                            <p className="text-sm text-blue-700">Source: {signal.source}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Recommended Actions */}
                  {analysis.recommended_actions?.length > 0 && (
                    <div>
                      <h3 className="font-semibold text-lg mb-2 flex items-center gap-2">
                        <Target className="w-5 h-5 text-indigo-600" />
                        Recommended Actions
                      </h3>
                      <ol className="space-y-2">
                        {analysis.recommended_actions.map((action, idx) => (
                          <li key={idx} className="flex items-start gap-3">
                            <span className="flex-shrink-0 w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm font-semibold">
                              {idx + 1}
                            </span>
                            <span className="text-slate-700">{action}</span>
                          </li>
                        ))}
                      </ol>
                    </div>
                  )}

                  {/* Talking Points */}
                  {analysis.talking_points?.length > 0 && (
                    <div>
                      <h3 className="font-semibold text-lg mb-2">Talking Points</h3>
                      <ul className="space-y-2">
                        {analysis.talking_points.map((point, idx) => (
                          <li key={idx} className="flex items-start gap-2">
                            <MessageSquare className="w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5" />
                            <span className="text-slate-700">{point}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Risk Factors */}
                  {analysis.risk_factors?.length > 0 && (
                    <div>
                      <h3 className="font-semibold text-lg mb-2 flex items-center gap-2">
                        <AlertCircle className="w-5 h-5 text-red-600" />
                        Risk Factors
                      </h3>
                      <ul className="space-y-2">
                        {analysis.risk_factors.map((risk, idx) => (
                          <li key={idx} className="flex items-start gap-2 text-red-700 bg-red-50 p-2 rounded">
                            <span>‚Ä¢</span>
                            <span>{risk}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Best Contact Time */}
                  {analysis.best_contact_time && (
                    <div className="bg-green-50 p-4 rounded-lg">
                      <p className="text-sm text-green-700 mb-1">Best Time to Contact</p>
                      <p className="text-lg font-semibold text-green-900">{analysis.best_contact_time}</p>
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>
          );
        })()}
      </div>
    </div>
  );
}
import React, { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { motion } from 'framer-motion';
import {
  Home, Loader2, CheckCircle2, AlertCircle, MapPin,
  User, Mail, Phone, Sparkles, ArrowRight, TrendingDown,
  DollarSign, Calendar, Eye, Camera, Hammer, BarChart3
} from 'lucide-react';
import { toast } from 'sonner';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

export default function WhyDidntItSell() {
  const [step, setStep] = useState(1);
  const [isLoading, setIsLoading] = useState(false);
  
  // Reset all state when component mounts
  useEffect(() => {
    setStep(1);
    setAddress('');
    setListPrice('');
    setDaysOnMarket('');
    setShowings('');
    setOffers('');
    setAdditionalInfo('');
    setOwnerName('');
    setOwnerEmail('');
    setOwnerPhone('');
    setAnalysis(null);
    setMarketComparison(null);
    setSuggestions([]);
    setShowSuggestions(false);
  }, []);
  
  // Property info
  const [address, setAddress] = useState('');
  const [listPrice, setListPrice] = useState('');
  const [daysOnMarket, setDaysOnMarket] = useState('');
  const [showings, setShowings] = useState('');
  const [offers, setOffers] = useState('');
  const [additionalInfo, setAdditionalInfo] = useState('');
  
  // Autocomplete
  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [isSearching, setIsSearching] = useState(false);
  const searchTimeoutRef = React.useRef(null);
  
  // Contact info
  const [ownerName, setOwnerName] = useState('');
  const [ownerEmail, setOwnerEmail] = useState('');
  const [ownerPhone, setOwnerPhone] = useState('');
  
  // Analysis result
  const [analysis, setAnalysis] = useState(null);
  const [marketComparison, setMarketComparison] = useState(null);

  const searchAddress = async (query) => {
    if (!query || query.length < 5) {
      setSuggestions([]);
      setShowSuggestions(false);
      return;
    }

    setIsSearching(true);
    try {
      const response = await base44.integrations.Core.InvokeLLM({
        prompt: `You are an address lookup assistant. The user is typing a property address: "${query}"

Provide 5 complete, valid US property addresses that match or are similar to what the user typed.

For each address, provide SEPARATELY:
- street_address: Just the street number and name
- city: City name
- state: State (2-letter code)
- zip_code: 5-digit ZIP code`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            addresses: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  street_address: { type: "string" },
                  city: { type: "string" },
                  state: { type: "string" },
                  zip_code: { type: "string" }
                }
              }
            }
          }
        }
      });

      if (response?.addresses && response.addresses.length > 0) {
        setSuggestions(response.addresses);
        setShowSuggestions(true);
      } else {
        setSuggestions([]);
      }
    } catch (error) {
      console.error('Address search error:', error);
      setSuggestions([]);
    }
    setIsSearching(false);
  };

  const handleAddressChange = (value) => {
    setAddress(value);
    
    if (searchTimeoutRef.current) {
      clearTimeout(searchTimeoutRef.current);
    }

    if (value.length < 5) {
      setSuggestions([]);
      setShowSuggestions(false);
      return;
    }

    searchTimeoutRef.current = setTimeout(() => {
      searchAddress(value);
    }, 500);
  };

  const selectAddress = (addressObj) => {
    const fullAddress = `${addressObj.street_address}, ${addressObj.city}, ${addressObj.state} ${addressObj.zip_code}`;
    setAddress(fullAddress);
    setSuggestions([]);
    setShowSuggestions(false);
  };

  const handleAnalyze = () => {
    // Validate required fields and show specific messages
    const missingFields = [];
    if (!address || address.trim() === '') missingFields.push('Property Address');
    if (!listPrice || listPrice.trim() === '') missingFields.push('List Price');
    if (!daysOnMarket || daysOnMarket.trim() === '') missingFields.push('Days on Market');
    
    if (missingFields.length > 0) {
      toast.error(`Missing required fields: ${missingFields.join(', ')}`, {
        duration: 4000,
        position: 'top-center'
      });
      return;
    }

    performAnalysis();
  };

  const performAnalysis = async () => {
    setIsLoading(true);

    try {
      // Parse address components
      const addressParts = address.split(',').map(p => p.trim());
      const streetAddress = addressParts[0] || '';
      const cityStateZip = addressParts.slice(1).join(', ');
      const city = cityStateZip.split(',')[0]?.trim() || '';
      const state = cityStateZip.match(/[A-Z]{2}/)?.[0] || '';
      const zip = cityStateZip.match(/\d{5}/)?.[0] || '';

      console.log('Fetching ATTOM data for:', { streetAddress, city, state, zip });

      // Get real property data from ATTOM with fallback
      let avmData = null;
      let propertyInfo = null;
      let comparables = [];

      try {
        const attomResponse = await base44.functions.invoke('attomPropertyData', {
          action: 'comprehensiveReport',
          address: streetAddress,
          city,
          state,
          zip
        });

        console.log('ATTOM Response:', attomResponse);

        const propertyData = attomResponse?.data?.data;
        avmData = propertyData?.avmSnapshot?.property?.[0]?.avm?.amount?.value;
        propertyInfo = propertyData?.expandedProfile?.property?.[0];
      } catch (err) {
        console.warn('ATTOM API failed, continuing with limited data:', err.message);
      }

      // Get sales comparables from ATTOM with fallback
      try {
        const comparablesResponse = await base44.functions.invoke('attomPropertyData', {
          action: 'salesComparablesV2',
          address: streetAddress,
          city,
          state,
          zip,
          radius: 1
        });

        console.log('Comparables Response:', comparablesResponse);
        comparables = comparablesResponse?.data?.data?.property || [];
      } catch (err) {
        console.warn('Comparables API failed, continuing without comparables:', err.message);
      }

      // Calculate market averages from real comparables
      const recentSales = comparables.filter(c => c.sale?.saleTransDate);
      const avgPrice = recentSales.length > 0 
        ? recentSales.reduce((sum, c) => sum + (c.sale?.amount?.saleAmt || 0), 0) / recentSales.length
        : parseFloat(listPrice);
      
      const marketData = {
        avg_price: avgPrice,
        avg_days_on_market: 45,
        avg_showings: 12,
        area: cityStateZip,
        property_type: propertyInfo?.summary?.proptype || 'single_family',
        comparables: recentSales.slice(0, 5)
      };

      setMarketComparison(marketData);

      const comparablesSummary = marketData.comparables?.length > 0 
        ? marketData.comparables.map(c => 
            `- ${c.address?.oneLine}: Sold for $${c.sale?.amount?.saleAmt?.toLocaleString()} on ${c.sale?.saleTransDate}, ${c.building?.size?.bldgSize || 'N/A'} sqft, ${c.building?.rooms?.beds || 'N/A'} bed/${c.building?.rooms?.bathstotal || 'N/A'} bath`
          ).join('\n')
        : 'No recent comparable sales data available';

      console.log('Generating AI analysis...');

      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `You are an expert real estate consultant. Analyze why this property hasn't sold using available market data:

Property Address: ${address}
Property Type: ${marketData.property_type.replace('_', ' ')}
List Price: $${listPrice}
Days on Market: ${daysOnMarket}
Number of Showings: ${showings || 'Not specified'}
Number of Offers: ${offers || 'Not specified'}
Additional Context: ${additionalInfo || 'None provided'}

${marketData.comparables?.length > 0 ? `
REAL MARKET DATA (from recent sales in area):
Average Sold Price: $${marketData.avg_price.toLocaleString()}
Recent Comparable Sales:
${comparablesSummary}
` : 'Limited market data available - using general market knowledge.'}

${avmData ? `AVM Estimated Value: $${avmData.toLocaleString()}` : ''}
${propertyInfo ? `Property Info: ${propertyInfo?.building?.size?.bldgSize || 'N/A'} sqft, ${propertyInfo?.building?.rooms?.beds || 'N/A'} bed, ${propertyInfo?.building?.rooms?.bathstotal || 'N/A'} bath, built ${propertyInfo?.summary?.yearbuilt || 'N/A'}` : ''}

Provide a comprehensive analysis of why this property likely hasn't sold. Consider:
1. Pricing issues (compare to market data if available)
2. Marketing problems (photos, description, exposure)
3. Property condition/presentation concerns
4. Market timing and competition
5. Showing accessibility and feedback

Be direct but constructive. Provide actionable recommendations.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            primary_issue: {
              type: "string",
              enum: ["pricing", "marketing", "condition", "market_timing", "showing_access", "multiple_factors"]
            },
            severity: {
              type: "string",
              enum: ["critical", "moderate", "minor"]
            },
            summary: { type: "string" },
            issues: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  category: { type: "string" },
                  problem: { type: "string" },
                  impact: { type: "string", enum: ["high", "medium", "low"] },
                  solution: { type: "string" }
                }
              }
            },
            pricing_assessment: {
              type: "object",
              properties: {
                is_overpriced: { type: "boolean" },
                suggested_price_adjustment: { type: "string" },
                market_comparison: { type: "string" }
              }
            },
            quick_wins: {
              type: "array",
              items: { type: "string" }
            },
            action_plan: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  step: { type: "string" },
                  priority: { type: "string", enum: ["urgent", "high", "medium"] },
                  estimated_impact: { type: "string" }
                }
              }
            }
          }
        }
      });

      console.log('AI Analysis complete:', result);

      setAnalysis({ ...result, avmValue: avmData, propertyInfo, comparables: marketData.comparables });
      setStep(2);
      toast.success('Analysis complete!');
    } catch (error) {
      console.error('Error analyzing property:', error);
      toast.error('Failed to analyze property: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  const handleSubmitContact = async () => {
    if (!ownerName || !ownerEmail) {
      toast.error('Please provide your name and email');
      return;
    }

    setIsLoading(true);

    try {
      const newLead = await base44.entities.Lead.create({
        name: ownerName,
        email: ownerEmail,
        phone: ownerPhone,
        property_address: address,
        status: 'new',
        lead_source: 'Website - Why Didnt It Sell',
        lead_type: 'seller',
        score: 90,
        notes: `üî• HOT LEAD - Property not selling analysis requested. List price: $${listPrice}, Days on market: ${daysOnMarket}. Primary issue: ${analysis?.primary_issue || 'N/A'}`
      });

      console.log('Created hot lead:', newLead);

      // Force immediate refresh of all lead-related data
      window.dispatchEvent(new CustomEvent('refreshGlobalData'));
      window.dispatchEvent(new CustomEvent('refreshCounts'));

      toast.success('Thank you! We\'ll send you the detailed report.');
      setStep(3);
    } catch (error) {
      console.error('Error saving lead:', error);
      toast.error('Error submitting. Please try again.');
    } finally {
      setIsLoading(false);
    }
  };

  const getSeverityColor = (severity) => {
    if (severity === 'critical') return 'bg-red-500';
    if (severity === 'moderate') return 'bg-yellow-500';
    return 'bg-blue-500';
  };

  const getImpactColor = (impact) => {
    if (impact === 'high') return 'bg-red-100 text-red-800 border-red-300';
    if (impact === 'medium') return 'bg-yellow-100 text-yellow-800 border-yellow-300';
    return 'bg-blue-100 text-blue-800 border-blue-300';
  };

  const getPriorityColor = (priority) => {
    if (priority === 'urgent') return 'bg-red-500';
    if (priority === 'high') return 'bg-orange-500';
    return 'bg-yellow-500';
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-red-950 to-slate-950 text-white py-12 px-6">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <motion.div
          className="text-center mb-12"
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
        >
          <div className="inline-flex items-center gap-3 mb-6">
            <div className="relative w-12 h-12">
              <div className="absolute inset-0 bg-gradient-to-br from-red-500 to-orange-600 rounded-xl blur-md animate-pulse" />
              <div className="relative w-12 h-12 bg-gradient-to-br from-red-600 to-orange-600 rounded-xl flex items-center justify-center shadow-lg">
                <TrendingDown className="w-6 h-6 text-white" />
              </div>
            </div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-white to-red-200 bg-clip-text text-transparent">
              Why Didn't My Property Sell?
            </h1>
          </div>
          <p className="text-lg text-red-200">
            Get expert AI analysis on what's preventing your property from selling and how to fix it
          </p>
        </motion.div>

        {/* Progress Indicator */}
        <div className="mb-12">
          <div className="flex items-center justify-center gap-4">
            <div className={`flex items-center gap-2 ${step >= 1 ? 'text-white' : 'text-red-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                step >= 1 ? 'bg-gradient-to-r from-red-600 to-orange-600' : 'bg-white/10'
              }`}>
                {step > 1 ? <CheckCircle2 className="w-5 h-5" /> : '1'}
              </div>
              <span className="text-sm font-medium">Property Info</span>
            </div>
            <div className="w-12 h-0.5 bg-white/20" />
            <div className={`flex items-center gap-2 ${step >= 2 ? 'text-white' : 'text-red-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                step >= 2 ? 'bg-gradient-to-r from-red-600 to-orange-600' : 'bg-white/10'
              }`}>
                {step > 2 ? <CheckCircle2 className="w-5 h-5" /> : '2'}
              </div>
              <span className="text-sm font-medium">Your Info</span>
            </div>
            <div className="w-12 h-0.5 bg-white/20" />
            <div className={`flex items-center gap-2 ${step >= 3 ? 'text-white' : 'text-red-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                step >= 3 ? 'bg-gradient-to-r from-red-600 to-orange-600' : 'bg-white/10'
              }`}>
                {step >= 3 ? <CheckCircle2 className="w-5 h-5" /> : '3'}
              </div>
              <span className="text-sm font-medium">Results</span>
            </div>
          </div>
        </div>

        {/* Step 1: Property Info */}
        {step === 1 && (
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ duration: 0.5 }}
          >
            <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
              <CardHeader>
                <CardTitle className="text-2xl text-white flex items-center gap-2">
                  <Home className="w-6 h-6 text-red-400" />
                  Tell Us About Your Property
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="relative">
                  <label className="text-sm text-red-200 mb-2 block">Property Address *</label>
                  <div className="relative">
                    <Input
                      type="text"
                      placeholder="Start typing address..."
                      value={address}
                      onChange={(e) => handleAddressChange(e.target.value)}
                      onFocus={() => suggestions.length > 0 && setShowSuggestions(true)}
                      className="bg-white/5 border-white/20 text-white placeholder:text-red-300 text-base pr-10"
                      autoComplete="off"
                    />
                    {isSearching && (
                      <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 animate-spin text-red-400" />
                    )}
                  </div>
                  
                  {showSuggestions && suggestions.length > 0 && (
                    <div 
                      className="absolute z-50 w-full mt-2 bg-slate-900 border border-white/20 rounded-lg shadow-2xl max-h-80 overflow-y-auto"
                      onMouseDown={(e) => e.preventDefault()}
                    >
                      {suggestions.map((addr, idx) => (
                        <button
                          key={idx}
                          type="button"
                          onMouseDown={(e) => {
                            e.preventDefault();
                            selectAddress(addr);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-red-600/30 transition-colors border-b border-white/10 last:border-0 cursor-pointer"
                        >
                          <div className="flex items-start gap-3">
                            <MapPin className="w-5 h-5 text-red-400 mt-0.5 flex-shrink-0" />
                            <div className="flex-1 min-w-0">
                              <p className="text-sm text-white font-medium">{addr.street_address}</p>
                              <p className="text-xs text-red-300 mt-0.5">
                                {addr.city}, {addr.state} {addr.zip_code}
                              </p>
                            </div>
                          </div>
                        </button>
                      ))}
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm text-red-200 mb-2 block">List Price *</label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-red-400" />
                      <Input
                        type="number"
                        placeholder="375000"
                        value={listPrice}
                        onChange={(e) => setListPrice(e.target.value)}
                        className="bg-white/5 border-white/20 text-white placeholder:text-red-300 pl-10"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="text-sm text-red-200 mb-2 block">Days on Market *</label>
                    <div className="relative">
                      <Calendar className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-red-400" />
                      <Input
                        type="number"
                        placeholder="90"
                        value={daysOnMarket}
                        onChange={(e) => setDaysOnMarket(e.target.value)}
                        className="bg-white/5 border-white/20 text-white placeholder:text-red-300 pl-10"
                      />
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm text-red-200 mb-2 block">Number of Showings</label>
                    <div className="relative">
                      <Eye className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-red-400" />
                      <Input
                        type="number"
                        placeholder="15"
                        value={showings}
                        onChange={(e) => setShowings(e.target.value)}
                        className="bg-white/5 border-white/20 text-white placeholder:text-red-300 pl-10"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="text-sm text-red-200 mb-2 block">Number of Offers</label>
                    <div className="relative">
                      <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-red-400" />
                      <Input
                        type="number"
                        placeholder="0"
                        value={offers}
                        onChange={(e) => setOffers(e.target.value)}
                        className="bg-white/5 border-white/20 text-white placeholder:text-red-300 pl-10"
                      />
                    </div>
                  </div>
                </div>

                <div>
                  <label className="text-sm text-red-200 mb-2 block">Additional Information</label>
                  <Textarea
                    placeholder="Any feedback from showings, concerns about the property, or other details..."
                    value={additionalInfo}
                    onChange={(e) => setAdditionalInfo(e.target.value)}
                    className="bg-white/5 border-white/20 text-white placeholder:text-red-300 min-h-24"
                  />
                </div>
                
                <Button
                  onClick={handleAnalyze}
                  disabled={isLoading}
                  className="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 shadow-lg shadow-red-500/50"
                  size="lg"
                >
                  {isLoading ? (
                    <>
                      <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                      Analyzing...
                    </>
                  ) : (
                    <>
                      <Sparkles className="w-5 h-5 mr-2" />
                      Analyze My Property
                    </>
                  )}
                </Button>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Step 2: Analysis + Contact Form */}
        {step === 2 && analysis && (
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ duration: 0.5 }}
            className="space-y-6"
          >
            {/* Analysis Display */}
            <Card className="bg-gradient-to-br from-red-900/40 to-orange-900/40 backdrop-blur-xl border-2 border-red-500/30 shadow-2xl shadow-red-500/20">
              <CardHeader>
                <CardTitle className="text-3xl text-white text-center flex items-center justify-center gap-3">
                  <AlertCircle className="w-8 h-8 text-red-400" />
                  Analysis Results
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Severity Badge */}
                <div className="flex items-center justify-center gap-3">
                  <Badge className={`${getSeverityColor(analysis.severity)} text-white text-lg px-4 py-2`}>
                    {analysis.severity.toUpperCase()} ISSUES DETECTED
                  </Badge>
                  <Badge className="bg-white/20 text-white text-lg px-4 py-2">
                    Primary: {analysis.primary_issue.replace('_', ' ').toUpperCase()}
                  </Badge>
                </div>

                {/* Summary */}
                <div className="p-4 bg-white/10 rounded-lg border border-white/20">
                  <p className="text-white text-center">{analysis.summary}</p>
                </div>

                {/* Issues */}
                {analysis.issues && analysis.issues.length > 0 && (
                  <div className="space-y-3">
                    <h4 className="font-semibold text-lg text-white">Identified Issues:</h4>
                    {analysis.issues.map((issue, idx) => (
                      <div key={idx} className="p-4 bg-white/5 rounded-lg border border-white/10">
                        <div className="flex items-start justify-between mb-2">
                          <h5 className="font-semibold text-white">{issue.category}</h5>
                          <Badge className={`${getImpactColor(issue.impact)} border`}>
                            {issue.impact} impact
                          </Badge>
                        </div>
                        <p className="text-sm text-red-200 mb-2">{issue.problem}</p>
                        <div className="flex items-start gap-2 text-sm">
                          <CheckCircle2 className="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" />
                          <span className="text-green-200">{issue.solution}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Pricing Assessment */}
                {analysis.pricing_assessment && (
                  <div className="p-4 bg-orange-900/30 rounded-lg border border-orange-500/30">
                    <h4 className="font-semibold text-lg text-white mb-2 flex items-center gap-2">
                      <DollarSign className="w-5 h-5 text-orange-400" />
                      Pricing Assessment
                    </h4>
                    <p className="text-orange-200 text-sm mb-2">{analysis.pricing_assessment.market_comparison}</p>
                    {analysis.pricing_assessment.is_overpriced && (
                      <div className="mt-2 p-3 bg-red-900/30 rounded border border-red-500/30">
                        <p className="text-red-200 text-sm font-semibold">
                          ‚ö†Ô∏è Recommendation: {analysis.pricing_assessment.suggested_price_adjustment}
                        </p>
                      </div>
                    )}
                  </div>
                )}

                {/* Quick Wins */}
                {analysis.quick_wins && analysis.quick_wins.length > 0 && (
                  <div className="p-4 bg-green-900/20 rounded-lg border border-green-500/30">
                    <h4 className="font-semibold text-lg text-white mb-3 flex items-center gap-2">
                      <Sparkles className="w-5 h-5 text-green-400" />
                      Quick Wins (Implement Today)
                    </h4>
                    <div className="space-y-2">
                      {analysis.quick_wins.map((win, idx) => (
                        <div key={idx} className="flex items-start gap-2">
                          <CheckCircle2 className="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" />
                          <span className="text-green-200 text-sm">{win}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Comparable Sales */}
            {analysis.comparables && analysis.comparables.length > 0 && (
            <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
            <CardHeader>
              <CardTitle className="text-2xl text-white flex items-center gap-2">
                <Home className="w-6 h-6 text-blue-400" />
                Recent Comparable Sales
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {analysis.comparables.map((comp, idx) => (
                <div key={idx} className="p-4 bg-white/5 rounded-lg border border-white/10">
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex-1">
                      <p className="font-semibold text-white">{comp.address?.oneLine}</p>
                      <p className="text-xs text-blue-300 mt-1">
                        {comp.building?.size?.bldgSize ? `${comp.building.size.bldgSize.toLocaleString()} sqft` : ''} ‚Ä¢ 
                        {comp.building?.rooms?.beds || '?'} bed / {comp.building?.rooms?.bathstotal || '?'} bath
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="text-lg font-bold text-green-400">${comp.sale?.amount?.saleAmt?.toLocaleString()}</p>
                      <p className="text-xs text-green-300">Sold {comp.sale?.saleTransDate}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 text-xs text-slate-300">
                    <Badge className={`${parseFloat(listPrice) > (comp.sale?.amount?.saleAmt || 0) ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`}>
                      {parseFloat(listPrice) > (comp.sale?.amount?.saleAmt || 0) 
                        ? `You're ${(((parseFloat(listPrice) - comp.sale?.amount?.saleAmt) / comp.sale?.amount?.saleAmt) * 100).toFixed(1)}% higher`
                        : `You're ${(((comp.sale?.amount?.saleAmt - parseFloat(listPrice)) / comp.sale?.amount?.saleAmt) * 100).toFixed(1)}% lower`
                      }
                    </Badge>
                  </div>
                </div>
              ))}
            </CardContent>
            </Card>
            )}

            {/* Market Comparison Charts */}
            {marketComparison && (
            <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
            <CardHeader>
              <CardTitle className="text-2xl text-white flex items-center gap-2">
                <BarChart3 className="w-6 h-6 text-blue-400" />
                Market Comparison - {marketComparison.area}
              </CardTitle>
              {analysis.avmValue && (
                <p className="text-sm text-blue-200 mt-2">
                  ATTOM AVM Estimate: ${analysis.avmValue.toLocaleString()} ‚Ä¢ 
                  Your List: ${parseFloat(listPrice).toLocaleString()} ‚Ä¢ 
                  Market Avg: ${Math.round(marketComparison.avg_price).toLocaleString()}
                </p>
              )}
            </CardHeader>
            <CardContent className="space-y-6">
                  {/* Price Comparison */}
                  <div>
                    <h4 className="text-sm font-semibold text-white mb-3">Price Comparison</h4>
                    <ResponsiveContainer width="100%" height={200}>
                      <BarChart data={[
                        { name: 'Your Property', value: parseFloat(listPrice) },
                        { name: 'Market Average', value: marketComparison.avg_price }
                      ]}>
                        <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                        <XAxis dataKey="name" stroke="#fff" />
                        <YAxis stroke="#fff" tickFormatter={(value) => `$${(value/1000).toFixed(0)}k`} />
                        <Tooltip 
                          contentStyle={{ background: 'rgba(15, 23, 42, 0.95)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px' }}
                          formatter={(value) => `$${value.toLocaleString()}`}
                        />
                        <Bar dataKey="value" fill="#3b82f6" />
                      </BarChart>
                    </ResponsiveContainer>
                    <p className="text-xs text-red-200 mt-2 text-center">
                      {parseFloat(listPrice) > marketComparison.avg_price ? 
                        `Your property is ${(((parseFloat(listPrice) - marketComparison.avg_price) / marketComparison.avg_price) * 100).toFixed(1)}% above market average` :
                        `Your property is ${(((marketComparison.avg_price - parseFloat(listPrice)) / marketComparison.avg_price) * 100).toFixed(1)}% below market average`
                      }
                    </p>
                  </div>

                  {/* Days on Market Comparison */}
                  <div>
                    <h4 className="text-sm font-semibold text-white mb-3">Days on Market Comparison</h4>
                    <ResponsiveContainer width="100%" height={200}>
                      <BarChart data={[
                        { name: 'Your Property', value: parseFloat(daysOnMarket) },
                        { name: 'Market Average', value: marketComparison.avg_days_on_market }
                      ]}>
                        <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                        <XAxis dataKey="name" stroke="#fff" />
                        <YAxis stroke="#fff" />
                        <Tooltip 
                          contentStyle={{ background: 'rgba(15, 23, 42, 0.95)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px' }}
                          formatter={(value) => `${value} days`}
                        />
                        <Bar dataKey="value" fill="#f59e0b" />
                      </BarChart>
                    </ResponsiveContainer>
                    <p className="text-xs text-red-200 mt-2 text-center">
                      {parseFloat(daysOnMarket) > marketComparison.avg_days_on_market ? 
                        `${parseFloat(daysOnMarket) - marketComparison.avg_days_on_market} days longer than average` :
                        `Within market average timeframe`
                      }
                    </p>
                  </div>

                  {/* Showings Comparison */}
                  {showings && (
                    <div>
                      <h4 className="text-sm font-semibold text-white mb-3">Showing Activity Comparison</h4>
                      <ResponsiveContainer width="100%" height={200}>
                        <BarChart data={[
                          { name: 'Your Property', value: parseFloat(showings) },
                          { name: 'Market Average', value: marketComparison.avg_showings }
                        ]}>
                          <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                          <XAxis dataKey="name" stroke="#fff" />
                          <YAxis stroke="#fff" />
                          <Tooltip 
                            contentStyle={{ background: 'rgba(15, 23, 42, 0.95)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px' }}
                            formatter={(value) => `${value} showings`}
                          />
                          <Bar dataKey="value" fill="#10b981" />
                        </BarChart>
                      </ResponsiveContainer>
                      <p className="text-xs text-red-200 mt-2 text-center">
                        {parseFloat(showings) < marketComparison.avg_showings ? 
                          `${marketComparison.avg_showings - parseFloat(showings)} fewer showings than average - marketing may need improvement` :
                          `Above average showing activity`
                        }
                      </p>
                    </div>
                  )}
                </CardContent>
              </Card>
            )}

            {/* Contact Form */}
            <Card className="bg-white/10 backdrop-blur-xl border border-white/20">
              <CardHeader>
                <CardTitle className="text-2xl text-white flex items-center gap-2">
                  <User className="w-6 h-6 text-red-400" />
                  Get Your Detailed Action Plan
                </CardTitle>
                <p className="text-sm text-red-200">
                  Enter your info to receive the complete report with step-by-step solutions
                </p>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <label className="text-sm text-red-200 mb-2 block">Full Name *</label>
                  <Input
                    type="text"
                    placeholder="John Doe"
                    value={ownerName}
                    onChange={(e) => setOwnerName(e.target.value)}
                    className="bg-white/5 border-white/20 text-white placeholder:text-red-300"
                  />
                </div>
                <div>
                  <label className="text-sm text-red-200 mb-2 block">Email Address *</label>
                  <Input
                    type="email"
                    placeholder="john@example.com"
                    value={ownerEmail}
                    onChange={(e) => setOwnerEmail(e.target.value)}
                    className="bg-white/5 border-white/20 text-white placeholder:text-red-300"
                  />
                </div>
                <div>
                  <label className="text-sm text-red-200 mb-2 block">Phone Number (Optional)</label>
                  <Input
                    type="tel"
                    placeholder="(555) 123-4567"
                    value={ownerPhone}
                    onChange={(e) => setOwnerPhone(e.target.value)}
                    maxLength={10}
                    className="bg-white/5 border-white/20 text-white placeholder:text-red-300"
                  />
                </div>
                <Button
                  onClick={handleSubmitContact}
                  disabled={isLoading || !ownerName || !ownerEmail}
                  className="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 shadow-lg shadow-green-500/50"
                  size="lg"
                >
                  {isLoading ? (
                    <>
                      <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                      Submitting...
                    </>
                  ) : (
                    <>
                      Get Full Action Plan
                      <ArrowRight className="w-5 h-5 ml-2" />
                    </>
                  )}
                </Button>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Step 3: Thank You */}
        {step === 3 && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.5 }}
          >
            <Card className="bg-gradient-to-br from-green-900/40 to-emerald-900/40 backdrop-blur-xl border-2 border-green-500/30 shadow-2xl">
              <CardContent className="p-12 text-center">
                <div className="w-20 h-20 bg-gradient-to-r from-green-600 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-green-500/50">
                  <CheckCircle2 className="w-10 h-10 text-white" />
                </div>
                <h2 className="text-3xl font-bold text-white mb-4">
                  Thank You, {ownerName}!
                </h2>
                <p className="text-lg text-green-200 mb-6">
                  We've received your request and will send you a comprehensive action plan within 24 hours.
                </p>
                <div className="bg-white/10 rounded-lg p-6 border border-white/20 mb-6">
                  <p className="text-green-100">
                    A real estate expert will review your specific situation and provide personalized recommendations to help your property sell quickly.
                  </p>
                </div>
                <p className="text-sm text-green-300">
                  We'll contact you at {ownerEmail} 
                  {ownerPhone && ` or ${ownerPhone}`} with next steps.
                </p>
                <Button
                  onClick={() => {
                    setStep(1);
                    setAddress('');
                    setListPrice('');
                    setDaysOnMarket('');
                    setShowings('');
                    setOffers('');
                    setAdditionalInfo('');
                    setOwnerName('');
                    setOwnerEmail('');
                    setOwnerPhone('');
                    setAnalysis(null);
                    setMarketComparison(null);
                  }}
                  variant="outline"
                  className="mt-8 border-white/20 text-white hover:bg-white/10"
                >
                  Analyze Another Property
                </Button>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* Back to Website Button */}
        <div className="text-center mt-12">
          <Button
            variant="ghost"
            onClick={() => window.history.back()}
            className="text-red-300 hover:text-white hover:bg-white/10"
          >
            ‚Üê Back to Website
          </Button>
        </div>
      </div>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate, useLocation } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { DragDropContext, Droppable, Draggable } from "@hello-pangea/dnd";
import {
  Workflow,
  Plus,
  ArrowLeft,
  Save,
  Play,
  Pause,
  Trash2,
  Edit,
  Sparkles,
  Calendar,
  MessageSquare,
  CheckSquare,
  Mail,
  Clock,
  AlertCircle,
  ChevronRight,
  GripVertical,
  Settings,
  RefreshCw,
  Target,
  Activity
} from "lucide-react";
import { toast } from "sonner";

const STEP_TYPES = [
  { value: "task", label: "Create Task", icon: CheckSquare, color: "bg-blue-500" },
  { value: "email", label: "Send Email", icon: Mail, color: "bg-green-500" },
  { value: "meeting", label: "Schedule Meeting", icon: Calendar, color: "bg-purple-500" },
  { value: "message", label: "Send Message", icon: MessageSquare, color: "bg-indigo-500" },
  { value: "wait", label: "Wait Period", icon: Clock, color: "bg-amber-500" },
  { value: "condition", label: "Conditional Branch", icon: AlertCircle, color: "bg-red-500" },
  { value: "ai_action", label: "AI Action", icon: Sparkles, color: "bg-pink-500" }
];

const TRIGGER_TYPES = [
  { value: "manual", label: "Manual Start" },
  { value: "lead_created", label: "New Lead Created" },
  { value: "property_listed", label: "Property Listed" },
  { value: "contract_signed", label: "Contract Signed" },
  { value: "meeting_completed", label: "Meeting Completed" },
  { value: "task_completed", label: "Task Completed" },
  { value: "scheduled", label: "Scheduled Time" }
];

const CATEGORIES = [
  { value: "lead_management", label: "Lead Management" },
  { value: "client_onboarding", label: "Client Onboarding" },
  { value: "transaction_management", label: "Transaction Management" },
  { value: "follow_up", label: "Follow-up Sequences" },
  { value: "marketing", label: "Marketing Campaigns" },
  { value: "custom", label: "Custom Workflow" }
];

export default function WorkflowBuilder() {
  const navigate = useNavigate();
  const location = useLocation();
  const workflowId = new URLSearchParams(location.search).get('id');

  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [isGeneratingAI, setIsGeneratingAI] = useState(false);
  const [user, setUser] = useState(null);
  const [learnings, setLearnings] = useState([]);

  // Workflow state
  const [workflow, setWorkflow] = useState({
    name: "",
    description: "",
    trigger_type: "manual",
    trigger_conditions: "{}",
    status: "draft",
    category: "custom",
    steps: [],
    tags: ""
  });

  // UI state
  const [showStepModal, setShowStepModal] = useState(false);
  const [editingStep, setEditingStep] = useState(null);
  const [editingStepIndex, setEditingStepIndex] = useState(null);

  // New step form
  const [newStep, setNewStep] = useState({
    type: "task",
    name: "",
    description: "",
    delay_hours: 0,
    config: {}
  });

  useEffect(() => {
    loadData();
  }, [workflowId]);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const currentUser = await base44.auth.me();
      setUser(currentUser);

      // Load learnings for AI suggestions
      const userLearnings = await base44.entities.JackieLearning.filter({
        user_id: currentUser.id,
        is_active: true
      });
      setLearnings(userLearnings || []);

      // Load existing workflow if editing
      if (workflowId) {
        const existingWorkflow = await base44.entities.WorkflowTemplate.get(workflowId);
        setWorkflow({
          ...existingWorkflow,
          steps: JSON.parse(existingWorkflow.steps || '[]')
        });
      }
    } catch (error) {
      console.error("Error loading data:", error);
      toast.error("Failed to load workflow data");
    }
    setIsLoading(false);
  };

  const handleAISuggestSteps = async () => {
    if (!workflow.name || !workflow.category) {
      toast.error("Please fill in workflow name and category first");
      return;
    }

    setIsGeneratingAI(true);
    try {
      const learningContext = learnings.map(l =>
        `${l.key}: ${l.value} (confidence: ${l.confidence}%)`
      ).join('\n');

      const aiResponse = await base44.integrations.Core.InvokeLLM({
        prompt: `You are an AI workflow designer. Based on this workflow information and learned user patterns, suggest a complete set of workflow steps.

WORKFLOW:
- Name: ${workflow.name}
- Description: ${workflow.description || 'Not provided'}
- Category: ${workflow.category}
- Trigger: ${workflow.trigger_type}

LEARNED USER PATTERNS:
${learningContext || 'No patterns learned yet'}

Design a workflow with 3-7 steps that would be effective for this use case. Consider:
- Timing between steps (delays)
- Task sequencing
- Follow-up patterns
- Best practices for ${workflow.category}

Return a JSON array of steps. Each step should have:
- type: one of [task, email, meeting, message, wait, ai_action]
- name: Clear step name
- description: What this step does
- delay_hours: Hours to wait before this step (0 for immediate)
- config: Object with step-specific config
  - For email: {subject, template}
  - For task: {priority, assigned_to}
  - For meeting: {duration, type}
  - For message: {recipient_type}
  - For wait: {reason}

Example for a "New Lead Follow-up":
[
  {
    "type": "task",
    "name": "Initial Research",
    "description": "Research the lead's background and needs",
    "delay_hours": 0,
    "config": {"priority": "high"}
  },
  {
    "type": "wait",
    "name": "Wait 24 Hours",
    "description": "Give time for initial research",
    "delay_hours": 24,
    "config": {"reason": "Allow time for preparation"}
  },
  {
    "type": "email",
    "name": "Introduction Email",
    "description": "Send personalized introduction",
    "delay_hours": 24,
    "config": {"subject": "Great to connect!", "template": "intro"}
  }
]`,
        response_json_schema: {
          type: "object",
          properties: {
            steps: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  type: { type: "string" },
                  name: { type: "string" },
                  description: { type: "string" },
                  delay_hours: { type: "number" },
                  config: { type: "object" }
                },
                required: ["type", "name", "description", "delay_hours"]
              }
            },
            rationale: {
              type: "string",
              description: "Why these steps were chosen"
            }
          }
        }
      });

      if (aiResponse && aiResponse.steps) {
        setWorkflow(prev => ({
          ...prev,
          steps: aiResponse.steps,
          is_ai_suggested: true
        }));

        toast.success(`‚ú® AI generated ${aiResponse.steps.length} workflow steps!`);

        if (aiResponse.rationale) {
          toast.info(aiResponse.rationale, { duration: 5000 });
        }
      }
    } catch (error) {
      console.error("Error generating AI steps:", error);
      toast.error("Failed to generate workflow steps");
    }
    setIsGeneratingAI(false);
  };

  const handleAddStep = () => {
    setEditingStep(null);
    setEditingStepIndex(null);
    setNewStep({
      type: "task",
      name: "",
      description: "",
      delay_hours: 0,
      config: {}
    });
    setShowStepModal(true);
  };

  const handleEditStep = (step, index) => {
    setEditingStep(step);
    setEditingStepIndex(index);
    setNewStep(step);
    setShowStepModal(true);
  };

  const handleSaveStep = () => {
    if (!newStep.name) {
      toast.error("Please enter a step name");
      return;
    }

    if (editingStepIndex !== null) {
      // Update existing step
      const updatedSteps = [...workflow.steps];
      updatedSteps[editingStepIndex] = newStep;
      setWorkflow(prev => ({ ...prev, steps: updatedSteps }));
      toast.success("Step updated");
    } else {
      // Add new step
      setWorkflow(prev => ({
        ...prev,
        steps: [...prev.steps, newStep]
      }));
      toast.success("Step added");
    }

    setShowStepModal(false);
    setEditingStep(null);
    setEditingStepIndex(null);
  };

  const handleDeleteStep = (index) => {
    if (confirm("Delete this step?")) {
      const updatedSteps = workflow.steps.filter((_, i) => i !== index);
      setWorkflow(prev => ({ ...prev, steps: updatedSteps }));
      toast.success("Step deleted");
    }
  };

  const handleDragEnd = (result) => {
    if (!result.destination) return;

    const items = Array.from(workflow.steps);
    const [reorderedItem] = items.splice(result.source.index, 1);
    items.splice(result.destination.index, 0, reorderedItem);

    setWorkflow(prev => ({ ...prev, steps: items }));
  };

  const handleSaveWorkflow = async () => {
    if (!workflow.name) {
      toast.error("Please enter a workflow name");
      return;
    }

    if (workflow.steps.length === 0) {
      toast.error("Please add at least one step");
      return;
    }

    setIsSaving(true);
    try {
      const workflowData = {
        ...workflow,
        steps: JSON.stringify(workflow.steps),
        created_by: user.id
      };

      if (workflowId) {
        await base44.entities.WorkflowTemplate.update(workflowId, workflowData);
        toast.success("Workflow updated successfully!");
      } else {
        const created = await base44.entities.WorkflowTemplate.create(workflowData);
        toast.success("Workflow created successfully!");
        navigate(createPageUrl(`WorkflowBuilder?id=${created.id}`));
      }
    } catch (error) {
      console.error("Error saving workflow:", error);
      toast.error("Failed to save workflow");
    }
    setIsSaving(false);
  };

  const handleActivateWorkflow = async () => {
    if (!workflowId) {
      toast.error("Please save the workflow first");
      return;
    }

    try {
      await base44.entities.WorkflowTemplate.update(workflowId, {
        status: workflow.status === 'active' ? 'paused' : 'active'
      });

      setWorkflow(prev => ({
        ...prev,
        status: workflow.status === 'active' ? 'paused' : 'active'
      }));

      toast.success(
        workflow.status === 'active'
          ? "Workflow paused"
          : "Workflow activated! It will run automatically based on triggers."
      );
    } catch (error) {
      console.error("Error activating workflow:", error);
      toast.error("Failed to update workflow status");
    }
  };

  const getStepIcon = (type) => {
    const stepType = STEP_TYPES.find(s => s.value === type);
    return stepType ? stepType.icon : Target;
  };

  const getStepColor = (type) => {
    const stepType = STEP_TYPES.find(s => s.value === type);
    return stepType ? stepType.color : "bg-gray-500";
  };

  if (isLoading) {
    return (
      <div className="page-container">
        <div className="flex items-center justify-center min-h-[400px]">
          <RefreshCw className="w-8 h-8 animate-spin text-indigo-600" />
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Header */}
        <Card className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => navigate(createPageUrl("Workflows"))}
                  className="text-white hover:bg-white/20"
                >
                  <ArrowLeft className="w-5 h-5" />
                </Button>
                <div>
                  <h1 className="text-2xl font-bold mb-1">
                    {workflowId ? "Edit Workflow" : "Create New Workflow"}
                  </h1>
                  <p className="text-white/90 text-sm">
                    Design automated sequences with AI assistance
                  </p>
                </div>
              </div>
              <div className="flex gap-2">
                {workflowId && (
                  <Button
                    onClick={handleActivateWorkflow}
                    className={`${
                      workflow.status === 'active'
                        ? 'bg-amber-500 hover:bg-amber-600'
                        : 'bg-green-500 hover:bg-green-600'
                    } text-white`}
                  >
                    {workflow.status === 'active' ? (
                      <>
                        <Pause className="w-4 h-4 mr-2" />
                        Pause
                      </>
                    ) : (
                      <>
                        <Play className="w-4 h-4 mr-2" />
                        Activate
                      </>
                    )}
                  </Button>
                )}
                <Button
                  onClick={handleSaveWorkflow}
                  disabled={isSaving}
                  className="bg-white text-indigo-600 hover:bg-white/90"
                >
                  {isSaving ? (
                    <>
                      <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                      Saving...
                    </>
                  ) : (
                    <>
                      <Save className="w-4 h-4 mr-2" />
                      Save Workflow
                    </>
                  )}
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left: Workflow Settings */}
          <div className="lg:col-span-1 space-y-6">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Settings className="w-5 h-5" />
                  Workflow Settings
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <Label>Workflow Name *</Label>
                  <Input
                    value={workflow.name}
                    onChange={(e) => setWorkflow(prev => ({ ...prev, name: e.target.value }))}
                    placeholder="e.g., New Lead Follow-up Sequence"
                  />
                </div>

                <div>
                  <Label>Description</Label>
                  <Textarea
                    value={workflow.description}
                    onChange={(e) => setWorkflow(prev => ({ ...prev, description: e.target.value }))}
                    placeholder="What does this workflow do?"
                    rows={3}
                  />
                </div>

                <div>
                  <Label>Category</Label>
                  <Select
                    value={workflow.category}
                    onValueChange={(value) => setWorkflow(prev => ({ ...prev, category: value }))}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {CATEGORIES.map(cat => (
                        <SelectItem key={cat.value} value={cat.value}>
                          {cat.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label>Trigger</Label>
                  <Select
                    value={workflow.trigger_type}
                    onValueChange={(value) => setWorkflow(prev => ({ ...prev, trigger_type: value }))}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {TRIGGER_TYPES.map(trigger => (
                        <SelectItem key={trigger.value} value={trigger.value}>
                          {trigger.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label>Tags (comma-separated)</Label>
                  <Input
                    value={workflow.tags}
                    onChange={(e) => setWorkflow(prev => ({ ...prev, tags: e.target.value }))}
                    placeholder="automation, follow-up, sales"
                  />
                </div>

                <div className="pt-4 border-t">
                  <Button
                    onClick={handleAISuggestSteps}
                    disabled={isGeneratingAI}
                    className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700"
                  >
                    {isGeneratingAI ? (
                      <>
                        <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                        Generating...
                      </>
                    ) : (
                      <>
                        <Sparkles className="w-4 h-4 mr-2" />
                        AI Suggest Steps
                      </>
                    )}
                  </Button>
                  <p className="text-xs text-slate-500 mt-2 text-center">
                    Let Jackie AI design this workflow based on best practices
                  </p>
                </div>
              </CardContent>
            </Card>

            {/* Status Info */}
            {workflowId && (
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Activity className="w-5 h-5" />
                    Status
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <span className="text-sm text-slate-600">Current Status:</span>
                      <Badge className={
                        workflow.status === 'active' ? 'bg-green-500' :
                        workflow.status === 'draft' ? 'bg-gray-500' :
                        workflow.status === 'paused' ? 'bg-amber-500' :
                        'bg-slate-500'
                      }>
                        {workflow.status}
                      </Badge>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm text-slate-600">Total Steps:</span>
                      <span className="font-semibold">{workflow.steps.length}</span>
                    </div>
                    {workflow.is_ai_suggested && (
                      <div className="flex items-center gap-2 p-2 bg-purple-50 rounded-lg">
                        <Sparkles className="w-4 h-4 text-purple-600" />
                        <span className="text-xs text-purple-700">AI-Generated</span>
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            )}
          </div>

          {/* Right: Workflow Steps */}
          <div className="lg:col-span-2">
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <CardTitle className="flex items-center gap-2">
                    <Workflow className="w-5 h-5" />
                    Workflow Steps ({workflow.steps.length})
                  </CardTitle>
                  <Button
                    onClick={handleAddStep}
                    size="sm"
                    className="bg-indigo-600 hover:bg-indigo-700"
                  >
                    <Plus className="w-4 h-4 mr-2" />
                    Add Step
                  </Button>
                </div>
              </CardHeader>
              <CardContent>
                {workflow.steps.length === 0 ? (
                  <div className="text-center py-12">
                    <Workflow className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                    <h3 className="text-lg font-semibold text-slate-900 mb-2">
                      No Steps Yet
                    </h3>
                    <p className="text-slate-600 mb-6">
                      Add steps manually or let AI suggest a complete workflow
                    </p>
                    <div className="flex justify-center gap-3">
                      <Button
                        onClick={handleAddStep}
                        variant="outline"
                      >
                        <Plus className="w-4 h-4 mr-2" />
                        Add Step
                      </Button>
                      <Button
                        onClick={handleAISuggestSteps}
                        disabled={isGeneratingAI}
                        className="bg-purple-600 hover:bg-purple-700"
                      >
                        <Sparkles className="w-4 h-4 mr-2" />
                        AI Suggest
                      </Button>
                    </div>
                  </div>
                ) : (
                  <DragDropContext onDragEnd={handleDragEnd}>
                    <Droppable droppableId="workflow-steps">
                      {(provided) => (
                        <div
                          {...provided.droppableProps}
                          ref={provided.innerRef}
                          className="space-y-3"
                        >
                          {workflow.steps.map((step, index) => {
                            const Icon = getStepIcon(step.type);
                            const colorClass = getStepColor(step.type);

                            return (
                              <Draggable
                                key={index}
                                draggableId={`step-${index}`}
                                index={index}
                              >
                                {(provided, snapshot) => (
                                  <div
                                    ref={provided.innerRef}
                                    {...provided.draggableProps}
                                    className={`border-2 rounded-lg p-4 bg-white ${
                                      snapshot.isDragging ? 'shadow-2xl' : 'shadow-sm'
                                    }`}
                                  >
                                    <div className="flex items-start gap-3">
                                      <div
                                        {...provided.dragHandleProps}
                                        className="mt-1 cursor-grab active:cursor-grabbing"
                                      >
                                        <GripVertical className="w-5 h-5 text-slate-400" />
                                      </div>

                                      <div className="flex items-center gap-2 min-w-[40px]">
                                        <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-sm font-semibold text-slate-700">
                                          {index + 1}
                                        </div>
                                      </div>

                                      <div className={`p-2 rounded-lg ${colorClass}`}>
                                        <Icon className="w-5 h-5 text-white" />
                                      </div>

                                      <div className="flex-1">
                                        <h4 className="font-semibold text-slate-900">
                                          {step.name}
                                        </h4>
                                        <p className="text-sm text-slate-600 mt-1">
                                          {step.description}
                                        </p>
                                        <div className="flex items-center gap-3 mt-2">
                                          <Badge variant="outline" className="capitalize">
                                            {step.type.replace('_', ' ')}
                                          </Badge>
                                          {step.delay_hours > 0 && (
                                            <Badge variant="outline">
                                              <Clock className="w-3 h-3 mr-1" />
                                              Wait {step.delay_hours}h
                                            </Badge>
                                          )}
                                        </div>
                                      </div>

                                      <div className="flex gap-1">
                                        <Button
                                          size="icon"
                                          variant="ghost"
                                          onClick={() => handleEditStep(step, index)}
                                        >
                                          <Edit className="w-4 h-4" />
                                        </Button>
                                        <Button
                                          size="icon"
                                          variant="ghost"
                                          onClick={() => handleDeleteStep(index)}
                                          className="text-red-600 hover:text-red-700 hover:bg-red-50"
                                        >
                                          <Trash2 className="w-4 h-4" />
                                        </Button>
                                      </div>
                                    </div>

                                    {index < workflow.steps.length - 1 && (
                                      <div className="flex justify-center my-2">
                                        <ChevronRight className="w-5 h-5 text-slate-300 rotate-90" />
                                      </div>
                                    )}
                                  </div>
                                )}
                              </Draggable>
                            );
                          })}
                          {provided.placeholder}
                        </div>
                      )}
                    </Droppable>
                  </DragDropContext>
                )}
              </CardContent>
            </Card>
          </div>
        </div>

        {/* Step Modal */}
        <Dialog open={showStepModal} onOpenChange={setShowStepModal}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>
                {editingStep ? "Edit Step" : "Add New Step"}
              </DialogTitle>
            </DialogHeader>

            <div className="space-y-4">
              <div>
                <Label>Step Type</Label>
                <Select
                  value={newStep.type}
                  onValueChange={(value) => setNewStep(prev => ({ ...prev, type: value }))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {STEP_TYPES.map(type => {
                      const Icon = type.icon;
                      return (
                        <SelectItem key={type.value} value={type.value}>
                          <div className="flex items-center gap-2">
                            <Icon className="w-4 h-4" />
                            {type.label}
                          </div>
                        </SelectItem>
                      );
                    })}
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label>Step Name *</Label>
                <Input
                  value={newStep.name}
                  onChange={(e) => setNewStep(prev => ({ ...prev, name: e.target.value }))}
                  placeholder="e.g., Send Welcome Email"
                />
              </div>

              <div>
                <Label>Description</Label>
                <Textarea
                  value={newStep.description}
                  onChange={(e) => setNewStep(prev => ({ ...prev, description: e.target.value }))}
                  placeholder="What does this step do?"
                  rows={3}
                />
              </div>

              <div>
                <Label>Delay (hours)</Label>
                <Input
                  type="number"
                  min="0"
                  value={newStep.delay_hours}
                  onChange={(e) => setNewStep(prev => ({ ...prev, delay_hours: parseInt(e.target.value) || 0 }))}
                  placeholder="0"
                />
                <p className="text-xs text-slate-500 mt-1">
                  How many hours to wait before executing this step (0 = immediate)
                </p>
              </div>

              {/* Step-specific config based on type */}
              {newStep.type === 'email' && (
                <div className="space-y-3 p-4 bg-slate-50 rounded-lg">
                  <h4 className="font-semibold text-sm">Email Configuration</h4>
                  <Input
                    placeholder="Email Subject"
                    value={newStep.config.subject || ''}
                    onChange={(e) => setNewStep(prev => ({
                      ...prev,
                      config: { ...prev.config, subject: e.target.value }
                    }))}
                  />
                  <Textarea
                    placeholder="Email Template/Body"
                    value={newStep.config.template || ''}
                    onChange={(e) => setNewStep(prev => ({
                      ...prev,
                      config: { ...prev.config, template: e.target.value }
                    }))}
                    rows={4}
                  />
                </div>
              )}

              {newStep.type === 'task' && (
                <div className="space-y-3 p-4 bg-slate-50 rounded-lg">
                  <h4 className="font-semibold text-sm">Task Configuration</h4>
                  <Select
                    value={newStep.config.priority || 'medium'}
                    onValueChange={(value) => setNewStep(prev => ({
                      ...prev,
                      config: { ...prev.config, priority: value }
                    }))}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Priority" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="low">Low Priority</SelectItem>
                      <SelectItem value="medium">Medium Priority</SelectItem>
                      <SelectItem value="high">High Priority</SelectItem>
                      <SelectItem value="critical">Critical</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              )}
            </div>

            <DialogFooter>
              <Button
                variant="outline"
                onClick={() => setShowStepModal(false)}
              >
                Cancel
              </Button>
              <Button
                onClick={handleSaveStep}
                className="bg-indigo-600 hover:bg-indigo-700"
              >
                {editingStep ? "Update Step" : "Add Step"}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  );
}
import React, { useState, useMemo } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Workflow,
  Plus,
  Play,
  Pause,
  Trash2,
  Edit,
  Clock,
  Zap,
  Copy,
  Filter,
  FileText,
  CheckSquare,
  Sparkles,
  Loader2
} from "lucide-react";
import { toast } from "sonner";
import WorkflowTemplateBuilder from "../components/workflows/WorkflowTemplateBuilder";

export default function WorkflowsPage() {
  const queryClient = useQueryClient();
  const [searchQuery, setSearchQuery] = useState("");
  const [statusFilter, setStatusFilter] = useState("all");
  const [categoryFilter, setCategoryFilter] = useState("all");
  const [showModal, setShowModal] = useState(false);
  const [editingWorkflow, setEditingWorkflow] = useState(null);

  const { data: user } = useQuery({
    queryKey: ["user"],
    queryFn: () => base44.auth.me()
  });

  const { data: workflows = [], isLoading } = useQuery({
    queryKey: ["workflowTemplates"],
    queryFn: () => base44.entities.WorkflowTemplate.list(),
    enabled: !!user
  });

  const { data: executions = [] } = useQuery({
    queryKey: ["workflowExecutions"],
    queryFn: () => base44.entities.WorkflowExecution.list(),
    enabled: !!user
  });

  const saveWorkflowMutation = useMutation({
    mutationFn: async (workflowData) => {
      if (editingWorkflow?.id) {
        return await base44.entities.WorkflowTemplate.update(editingWorkflow.id, workflowData);
      } else {
        return await base44.entities.WorkflowTemplate.create({
          ...workflowData,
          created_by: user.id,
          execution_count: 0,
          success_rate: 0
        });
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["workflowTemplates"] });
      setShowModal(false);
      setEditingWorkflow(null);
      toast.success(editingWorkflow ? "Workflow updated!" : "Workflow created!");
    },
    onError: (error) => {
      toast.error("Failed to save workflow: " + error.message);
    }
  });

  const deleteWorkflowMutation = useMutation({
    mutationFn: (id) => base44.entities.WorkflowTemplate.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["workflowTemplates"] });
      toast.success("Workflow deleted!");
    }
  });

  const toggleWorkflowMutation = useMutation({
    mutationFn: ({ id, newStatus }) => base44.entities.WorkflowTemplate.update(id, { status: newStatus }),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ["workflowTemplates"] });
      toast.success(`Workflow ${variables.newStatus === "active" ? "activated" : "paused"}!`);
    }
  });

  const duplicateWorkflowMutation = useMutation({
    mutationFn: async (workflow) => {
      return await base44.entities.WorkflowTemplate.create({
        ...workflow,
        id: undefined,
        name: `${workflow.name} (Copy)`,
        status: 'draft',
        execution_count: 0,
        created_by: user.id
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["workflowTemplates"] });
      toast.success("Workflow duplicated!");
    }
  });

  const filteredWorkflows = useMemo(() => {
    return workflows.filter(w => {
      const matchesSearch = w.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                           w.description?.toLowerCase().includes(searchQuery.toLowerCase());
      const matchesStatus = statusFilter === "all" || w.status === statusFilter;
      const matchesCategory = categoryFilter === "all" || w.category === categoryFilter;
      return matchesSearch && matchesStatus && matchesCategory;
    });
  }, [workflows, searchQuery, statusFilter, categoryFilter]);

  const stats = useMemo(() => {
    return {
      total: workflows.length,
      active: workflows.filter(w => w.status === "active").length,
      draft: workflows.filter(w => w.status === "draft").length,
      totalExecutions: workflows.reduce((sum, w) => sum + (w.execution_count || 0), 0),
      recentExecutions: executions.filter(e => {
        const createdDate = new Date(e.created_date);
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        return createdDate > weekAgo;
      }).length
    };
  }, [workflows, executions]);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-12 h-12 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center shadow-lg">
                <Workflow className="w-6 h-6 text-white" />
              </div>
              Transaction Workflows
            </h1>
            <p className="text-slate-600 dark:text-slate-400 mt-1">
              Automate document generation, tasks, and communications
            </p>
          </div>

          <Button
            onClick={() => {
              setEditingWorkflow(null);
              setShowModal(true);
            }}
            className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700"
          >
            <Plus className="w-5 h-5 mr-2" />
            Create Workflow
          </Button>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
          <Card className="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950 dark:to-indigo-950 border-2">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-blue-700 dark:text-blue-300">Total</p>
                  <p className="text-3xl font-bold text-blue-900 dark:text-blue-100 mt-2">{stats.total}</p>
                </div>
                <Workflow className="w-12 h-12 text-blue-400" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-950 dark:to-emerald-950 border-2">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-green-700 dark:text-green-300">Active</p>
                  <p className="text-3xl font-bold text-green-900 dark:text-green-100 mt-2">{stats.active}</p>
                </div>
                <Play className="w-12 h-12 text-green-400" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950 dark:to-orange-950 border-2">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-amber-700 dark:text-amber-300">Draft</p>
                  <p className="text-3xl font-bold text-amber-900 dark:text-amber-100 mt-2">{stats.draft}</p>
                </div>
                <FileText className="w-12 h-12 text-amber-400" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950 dark:to-pink-950 border-2">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-purple-700 dark:text-purple-300">Total Runs</p>
                  <p className="text-3xl font-bold text-purple-900 dark:text-purple-100 mt-2">{stats.totalExecutions}</p>
                </div>
                <Zap className="w-12 h-12 text-purple-400" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-950 dark:to-blue-950 border-2">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-cyan-700 dark:text-cyan-300">This Week</p>
                  <p className="text-3xl font-bold text-cyan-900 dark:text-cyan-100 mt-2">{stats.recentExecutions}</p>
                </div>
                <Clock className="w-12 h-12 text-cyan-400" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Filters */}
        <Card>
          <CardContent className="p-4 flex gap-4 flex-wrap">
            <div className="relative flex-1 min-w-[200px]">
              <Input
                placeholder="Search workflows..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-10"
              />
              <Filter className="w-4 h-4 absolute left-3 top-3 text-slate-400" />
            </div>
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger className="w-[150px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Status</SelectItem>
                <SelectItem value="active">Active</SelectItem>
                <SelectItem value="draft">Draft</SelectItem>
                <SelectItem value="paused">Paused</SelectItem>
              </SelectContent>
            </Select>
            <Select value={categoryFilter} onValueChange={setCategoryFilter}>
              <SelectTrigger className="w-[200px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Categories</SelectItem>
                <SelectItem value="transaction_management">Transaction Management</SelectItem>
                <SelectItem value="lead_management">Lead Management</SelectItem>
                <SelectItem value="client_onboarding">Client Onboarding</SelectItem>
                <SelectItem value="follow_up">Follow-up</SelectItem>
                <SelectItem value="marketing">Marketing</SelectItem>
              </SelectContent>
            </Select>
          </CardContent>
        </Card>

        {/* Workflows List */}
        {filteredWorkflows.length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <Workflow className="w-16 h-16 mx-auto text-slate-300 mb-4" />
              <h3 className="text-lg font-semibold mb-2">No Workflows Found</h3>
              <p className="text-slate-600 dark:text-slate-400 mb-4">
                {searchQuery || statusFilter !== "all" || categoryFilter !== "all"
                  ? "Try adjusting your filters" 
                  : "Get started by creating your first automated workflow"}
              </p>
              <Button onClick={() => setShowModal(true)} className="bg-gradient-to-r from-purple-600 to-pink-600">
                <Plus className="w-4 h-4 mr-2" />
                Create Workflow
              </Button>
            </CardContent>
          </Card>
        ) : (
          <div className="grid grid-cols-1 gap-4">
            {filteredWorkflows.map(workflow => {
              const steps = workflow.steps ? JSON.parse(workflow.steps) : [];
              
              return (
                <Card key={workflow.id} className="hover:shadow-lg transition-all border-2">
                  <CardContent className="p-6">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex items-start gap-4 flex-1">
                        <div className="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center flex-shrink-0 shadow-md">
                          <Workflow className="w-6 h-6 text-white" />
                        </div>
                        
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1 flex-wrap">
                            <h3 className="text-lg font-semibold text-slate-900 dark:text-white">
                              {workflow.name}
                            </h3>
                            <Badge className={
                              workflow.status === "active" ? "bg-green-100 text-green-700 border-green-300" : 
                              workflow.status === "draft" ? "bg-slate-100 text-slate-700 border-slate-300" :
                              "bg-amber-100 text-amber-700 border-amber-300"
                            }>
                              {workflow.status}
                            </Badge>
                            <Badge variant="outline" className="text-xs">
                              {workflow.category?.replace('_', ' ')}
                            </Badge>
                            {workflow.is_ai_suggested && (
                              <Badge className="bg-purple-100 text-purple-700 border-purple-300">
                                <Sparkles className="w-3 h-3 mr-1" />
                                AI Suggested
                              </Badge>
                            )}
                          </div>
                          
                          <p className="text-sm text-slate-600 dark:text-slate-400 mb-3">
                            {workflow.description}
                          </p>
                          
                          <div className="flex items-center gap-4 text-xs text-slate-500 dark:text-slate-400 flex-wrap">
                            <div className="flex items-center gap-1">
                              <CheckSquare className="w-3 h-3" />
                              <span>{steps.length} steps</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <Play className="w-3 h-3" />
                              <span>{workflow.execution_count || 0} runs</span>
                            </div>
                            {workflow.success_rate > 0 && (
                              <div className="flex items-center gap-1">
                                <Zap className="w-3 h-3" />
                                <span>{workflow.success_rate}% success</span>
                              </div>
                            )}
                            {workflow.trigger_type !== 'manual' && (
                              <div className="flex items-center gap-1">
                                <Clock className="w-3 h-3" />
                                <span>Trigger: {workflow.trigger_type.replace('_', ' ')}</span>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>

                      <div className="flex items-center gap-2 flex-shrink-0">
                        {workflow.status !== 'archived' && (
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => toggleWorkflowMutation.mutate({
                              id: workflow.id,
                              newStatus: workflow.status === "active" ? "paused" : "active"
                            })}
                            className={workflow.status === "active" ? "text-amber-600" : "text-green-600"}
                          >
                            {workflow.status === "active" ? (
                              <Pause className="w-4 h-4" />
                            ) : (
                              <Play className="w-4 h-4" />
                            )}
                          </Button>
                        )}
                        
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => duplicateWorkflowMutation.mutate(workflow)}
                        >
                          <Copy className="w-4 h-4" />
                        </Button>
                        
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            setEditingWorkflow(workflow);
                            setShowModal(true);
                          }}
                        >
                          <Edit className="w-4 h-4" />
                        </Button>
                        
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (confirm("Delete this workflow?")) {
                              deleteWorkflowMutation.mutate(workflow.id);
                            }
                          }}
                          className="text-red-600 hover:text-red-700"
                        >
                          <Trash2 className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              );
            })}
          </div>
        )}
      </div>

      {/* Workflow Modal */}
      {showModal && (
        <Dialog open={true} onOpenChange={() => {
          setShowModal(false);
          setEditingWorkflow(null);
        }}>
          <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle>
                {editingWorkflow ? "Edit Workflow" : "Create New Workflow"}
              </DialogTitle>
            </DialogHeader>
            <WorkflowTemplateBuilder
              template={editingWorkflow}
              onSave={(data) => saveWorkflowMutation.mutate(data)}
              onCancel={() => {
                setShowModal(false);
                setEditingWorkflow(null);
              }}
            />
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
}

import React, { useState, useEffect, useRef } from "react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { base44 } from "@/api/base44Client";
import {
  Building2,
  TrendingUp,
  Plus,
  Target,
  Calendar,
  Sparkles,
  Home,
  Database,
  AlertCircle,
  DollarSign,
  Clock,
  AlertTriangle,
  Flame,
  RefreshCw,
  Timer,
  CheckCircle2,
  BarChart3,
  Activity,
  Zap,
  Users,
  ArrowRight,
  CheckSquare,
  Lightbulb,
  MessageSquare,
  FileText,
  Camera,
  BedDouble,
  Bath,
  Square,
  Award
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  AreaChart,
  Area,
  PieChart,
  Pie,
  Cell,
  XAxis,
  YAxis,
  CartesianGrid, // Added CartesianGrid
  Tooltip,
  ResponsiveContainer,
  Legend // Added Radar
} from "recharts";
import { Progress } from "@/components/ui/progress";
import PersonalizedInsights from "../components/dashboard/PersonalizedInsights";
import MarketingBanner from "../components/common/MarketingBanner";
import AgentProfileSetup from "../components/settings/AgentProfileSetup";

// Helper functions
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

const retryWithBackoff = async (fn, maxRetries = 2, baseDelay = 1000) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i < maxRetries - 1) {
        const delayTime = baseDelay * Math.pow(2, i);
        await delay(delayTime);
      } else {
        console.error("Max retries reached:", error.message);
        return [];
      }
    }
  }
  return [];
};

const getGreeting = () => {
  const hour = new Date().getHours();
  
  if (hour >= 5 && hour < 12) {
    return "Good Morning";
  } else if (hour >= 12 && hour < 17) {
    return "Good Afternoon";
  } else if (hour >= 17 && hour < 21) {
    return "Good Evening";
  } else {
    return "Good Night";
  }
};

const CHART_COLORS = {
  primary: '#6366f1',
  success: '#10b981',
  warning: '#f59e0b',
  danger: '#ef4444',
  info: '#3b82f6',
  purple: '#8b5cf6',
  pink: '#ec4899',
  cyan: '#06b6d4'
};

export default function Dashboard() {
  const [currentUser, setCurrentUser] = useState(null);
  const [stats, setStats] = useState({
    properties: 0,
    buyers: 0,
    leads: 0,
    tasks: 0,
    transactions: 0,
    openHouses: 0
  });
  const [recentProperties, setRecentProperties] = useState([]);
  const [urgentTasks, setUrgentTasks] = useState([]);
  const [hotLeads, setHotLeads] = useState([]);
  const [upcomingEvents, setUpcomingEvents] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [properties, setProperties] = useState([]);
  const [leads, setLeads] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [todayTasks, setTodayTasks] = useState(0);
  const [intelligence, setIntelligence] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [needsInit, setNeedsInit] = useState(false);
  const [loadError, setLoadError] = useState(null);
  const [buyers, setBuyers] = useState([]);
  const [dailyQuote, setDailyQuote] = useState(null);
  const [unreadTipsCount, setUnreadTipsCount] = useState(0);
  const [currentTime, setCurrentTime] = useState(new Date());
  const [nextMeeting, setNextMeeting] = useState(null);
  const [showProfileSetup, setShowProfileSetup] = useState(false);
  const [recentActivity, setRecentActivity] = useState([]);
  const [performanceData, setPerformanceData] = useState([]);
  const [pipelineData, setPipelineData] = useState([]);

  const navigate = useNavigate();
  const loadingRef = useRef(false);

  const calculateTodayTasks = (tasksList) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayEnd = new Date(today);
    todayEnd.setHours(23, 59, 59, 999);

    return tasksList.filter(t => {
      if (t.status === 'completed' || !t.due_date) return false;
      const dueDate = new Date(t.due_date);
      return dueDate >= today && dueDate <= todayEnd;
    }).length;
  };

  useEffect(() => {
    loadDashboardData();
  }, []);

  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 60000);

    return () => clearInterval(timer);
  }, []);

  const loadDailyQuote = async () => {
    try {
      const response = await base44.integrations.Core.InvokeLLM({
        prompt: `Generate an inspiring, motivational quote specifically for real estate agents. The quote should be:
- Positive and uplifting
- Related to success, growth, perseverance, or opportunity in real estate
- Professional and actionable
- Short (1-2 sentences max)

Return only the quote text, no attribution needed.`,
        add_context_from_internet: false
      });

      return response;
    } catch (error) {
      console.error("Error loading daily quote:", error);
      return "Success in real estate comes from consistent action, genuine relationships, and unwavering commitment to your clients' dreams.";
    }
  };

  const generatePerformanceData = (transactions, properties, leads) => {
    const last6Months = [];
    const now = new Date();
    
    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthName = date.toLocaleString('default', { month: 'short' });
      
      const monthTransactions = transactions.filter(t => {
        const tDate = new Date(t.created_date);
        return tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear();
      });
      
      const monthLeads = leads.filter(l => {
        const lDate = new Date(l.created_date);
        return lDate.getMonth() === date.getMonth() && lDate.getFullYear() === date.getFullYear();
      });

      const closedDeals = monthTransactions.filter(t => t.status === 'closed').length;
      const revenue = monthTransactions
        .filter(t => t.status === 'closed')
        .reduce((sum, t) => sum + (t.listing_net_commission || 0) + (t.selling_net_commission || 0), 0);

      last6Months.push({
        month: monthName,
        deals: closedDeals,
        revenue: Math.round(revenue / 1000),
        leads: monthLeads.length,
        conversions: monthLeads.filter(l => l.status === 'converted').length
      });
    }
    
    return last6Months;
  };

  const generatePipelineData = (transactions) => {
    const statusCounts = {
      active: transactions.filter(t => t.status === 'active').length,
      pending: transactions.filter(t => t.status === 'pending').length,
      closed: transactions.filter(t => t.status === 'closed').length,
      cancelled: transactions.filter(t => t.status === 'cancelled').length
    };

    return [
      { name: 'Active', value: statusCounts.active, color: CHART_COLORS.info },
      { name: 'Pending', value: statusCounts.pending, color: CHART_COLORS.warning },
      { name: 'Closed', value: statusCounts.closed, color: CHART_COLORS.success },
      { name: 'Cancelled', value: statusCounts.cancelled, color: CHART_COLORS.danger }
    ].filter(item => item.value > 0);
  };

  const generateRecentActivity = (properties, leads, tasks, transactions) => {
    const activity = [];
    
    // Recent properties
    properties.slice(0, 3).forEach(p => {
      activity.push({
        type: 'property',
        icon: Building2,
        color: 'text-blue-600',
        bg: 'bg-blue-50',
        title: 'New listing added',
        description: p.address,
        time: new Date(p.created_date),
        link: createPageUrl(`PropertyDetail?id=${p.id}`)
      });
    });

    // Recent leads
    leads.filter(l => l.status === 'new').slice(0, 2).forEach(l => {
      activity.push({
        type: 'lead',
        icon: Target,
        color: 'text-orange-600',
        bg: 'bg-orange-50',
        title: 'New lead received',
        description: l.name,
        time: new Date(l.created_date),
        link: createPageUrl(`LeadDetail?id=${l.id}`)
      });
    });

    // Completed tasks
    tasks.filter(t => t.status === 'completed').slice(0, 2).forEach(t => {
      activity.push({
        type: 'task',
        icon: CheckCircle2,
        color: 'text-green-600',
        bg: 'bg-green-50',
        title: 'Task completed',
        description: t.title,
        time: t.completed_date ? new Date(t.completed_date) : new Date(t.updated_date),
        link: createPageUrl('Tasks')
      });
    });

    // Closed deals
    transactions.filter(t => t.status === 'closed').slice(0, 2).forEach(t => {
      activity.push({
        type: 'transaction',
        icon: DollarSign,
        color: 'text-emerald-600',
        bg: 'bg-emerald-50',
        title: 'Deal closed',
        description: `$${(t.contract_price || 0).toLocaleString()}`,
        time: new Date(t.updated_date),
        link: createPageUrl('Transactions')
      });
    });

    return activity.sort((a, b) => b.time - a.time).slice(0, 8);
  };

  const loadDashboardData = async () => {
    if (loadingRef.current) return;
    
    loadingRef.current = true;
    setIsLoading(true);
    setLoadError(null);

    try {
      const userResult = await base44.auth.me();
      setCurrentUser(userResult);

      const quote = await loadDailyQuote();
      setDailyQuote(quote);

      try {
        const tipsData = await base44.entities.RealtorTip.list("-created_date");
        const unreadCount = (tipsData || []).filter(t => !t.is_read).length;
        setUnreadTipsCount(unreadCount);
      } catch (error) {
        console.error("Error loading tips count:", error);
        setUnreadTipsCount(0);
      }

      await delay(800);
      const propertiesData = await retryWithBackoff(() => base44.entities.Property.list("-updated_date"));
      setProperties(propertiesData);

      await delay(800);
      const tasksData = await retryWithBackoff(() => base44.entities.Task.list("-due_date"));
      setTasks(tasksData);
      setTodayTasks(calculateTodayTasks(tasksData));

      await delay(800);
      const leadsData = await retryWithBackoff(() => base44.entities.Lead.list("-updated_date"));
      setLeads(leadsData);

      await delay(1000);
      const buyersData = await retryWithBackoff(() => base44.entities.Buyer.list());
      setBuyers(buyersData);

      await delay(1000);
      const transactionsData = await retryWithBackoff(() => base44.entities.Transaction.list("-updated_date"));
      setTransactions(transactionsData);

      await delay(1500);
      const openHousesData = await retryWithBackoff(() => base44.entities.OpenHouse.list("-date"));

      setStats({
        properties: propertiesData.length,
        buyers: buyersData.length,
        leads: leadsData.length,
        tasks: tasksData.filter(t => t.status !== 'completed').length,
        transactions: transactionsData.length,
        openHouses: openHousesData.filter(oh => oh.status === 'scheduled' || oh.status === 'approved').length
      });

      setRecentProperties(propertiesData.slice(0, 4));

      const threeDaysFromNow = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000);
      const urgent = tasksData.filter(t => {
        if (t.status === 'completed' || !t.due_date) return false;
        return new Date(t.due_date) <= threeDaysFromNow;
      }).slice(0, 4);
      setUrgentTasks(urgent);

      const hot = leadsData.filter(l =>
        (l.score >= 70 || l.status === 'qualified') &&
        l.status !== 'converted' && l.status !== 'lost'
      ).slice(0, 4);
      setHotLeads(hot);

      const events = [];
      openHousesData.forEach(oh => {
        if (oh.status === 'scheduled' || oh.status === 'approved') {
          const property = propertiesData.find(p => p.id === oh.property_id);
          events.push({
            type: 'open_house',
            date: oh.date,
            time: oh.start_time,
            title: `Open House: ${property?.address || 'Property'}`,
            id: oh.id
          });
        }
      });
      events.sort((a, b) => new Date(a.date) - new Date(b.date));
      setUpcomingEvents(events.slice(0, 4));

      const intel = calculateIntelligence(
        propertiesData, 
        leadsData, 
        transactionsData, 
        tasksData, 
        buyersData
      );
      setIntelligence(intel);

      findNextMeeting(tasksData, openHousesData);

      // Generate chart data
      const perfData = generatePerformanceData(transactionsData, propertiesData, leadsData);
      setPerformanceData(perfData);

      const pipeData = generatePipelineData(transactionsData);
      setPipelineData(pipeData);

      const activityData = generateRecentActivity(propertiesData, leadsData, tasksData, transactionsData);
      setRecentActivity(activityData);

      if (propertiesData.length === 0 && buyersData.length === 0 && leadsData.length === 0) {
        setNeedsInit(true);
      }
    } catch (error) {
      console.error("Error loading dashboard:", error);
      setLoadError("Unable to load dashboard. Please refresh the page.");
    } finally {
      setIsLoading(false);
      loadingRef.current = false;
    }
  };

  const findNextMeeting = (tasksData, openHousesData) => {
    const now = new Date();
    const upcoming = [];

    tasksData.forEach(task => {
      if (task.due_date && task.status !== 'completed') {
        const taskDate = new Date(task.due_date);
        if (!task.time) {
          taskDate.setHours(23, 59, 59, 999);
        }
        if (taskDate >= now) {
          upcoming.push({
            type: 'task',
            title: task.title,
            date: taskDate,
            data: task
          });
        }
      }
    });

    openHousesData.forEach(oh => {
      if (oh.date && oh.start_time && (oh.status === 'scheduled' || oh.status === 'approved' || oh.status === 'published')) {
        const [hours, minutes] = oh.start_time.split(':');
        const eventDate = new Date(oh.date);
        eventDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        
        if (eventDate >= now) {
          upcoming.push({
            type: 'open_house',
            title: `Open House: ${oh.property?.address || 'Property'}`,
            date: eventDate,
            time: oh.start_time,
            data: oh
          });
        }
      }
    });

    upcoming.sort((a, b) => a.date - b.date);
    
    if (upcoming.length > 0) {
      setNextMeeting(upcoming[0]);
    } else {
      setNextMeeting(null);
    }
  };

  const getCountdown = () => {
    if (!nextMeeting) return null;

    const now = currentTime;
    const diff = nextMeeting.date - now;

    if (diff < 0) {
      return null;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

    if (days > 0) {
      return `${days}d ${hours}h ${minutes}m`;
    } else if (hours > 0) {
      return `${hours}h ${minutes}m`;
    } else {
      return `${minutes}m`;
    }
  };

  const calculateIntelligence = (properties, leads, transactions, tasks, buyers) => {
    const now = new Date();
    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    const sixtyDaysAgo = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000);

    const pendingDeals = transactions.filter(t => t.status === 'pending' || t.status === 'active');
    const dealsAtRisk = pendingDeals.filter(t => {
      const daysSinceUpdate = (now - new Date(t.updated_date || t.created_date)) / (1000 * 60 * 60 * 24);
      return daysSinceUpdate > 7;
    });

    const activeLeads = leads.filter(l => l.status !== 'converted' && l.status !== 'lost');
    const staleLeads = activeLeads.filter(l => {
      const daysSinceContact = l.last_contact 
        ? (now - new Date(l.last_contact)) / (1000 * 60 * 60 * 24)
        : 999;
      return daysSinceContact > 14;
    });

    const hotLeadsWithUrgency = activeLeads
      .filter(l => l.score >= 70 && l.timeline === 'immediate')
      .map(l => ({
        ...l,
        urgencyScore: l.score + (l.timeline === 'immediate' ? 20 : 0)
      }))
      .sort((a, b) => b.urgencyScore - a.urgencyScore);

    const activeProperties = properties.filter(p => p.status === 'active');
    const overpriced = activeProperties.filter(p => p.days_on_market > 60);
    const hotProperties = activeProperties.filter(p => p.days_on_market < 30 && p.days_on_market > 0);
    
    const priceReductionCandidates = activeProperties.filter(p => {
      const dom = p.days_on_market || 0;
      return dom > 45 && dom < 90;
    });

    const closedLast30Days = transactions.filter(t => 
      t.status === 'closed' && new Date(t.updated_date || t.created_date) >= thirtyDaysAgo
    );
    const closedLast60Days = transactions.filter(t => 
      t.status === 'closed' && new Date(t.updated_date || t.created_date) >= sixtyDaysAgo
    );

    const revenueLast30 = closedLast30Days.reduce((sum, t) => sum + (t.listing_net_commission || 0), 0);
    const revenuePrevious30 = (closedLast60Days.filter(t => new Date(t.updated_date || t.created_date) < thirtyDaysAgo).reduce((sum, t) => sum + (t.listing_net_commission || 0), 0));

    const revenueGrowth = revenuePrevious30 > 0 
      ? ((revenueLast30 - revenuePrevious30) / revenuePrevious30 * 100).toFixed(1)
      : 0;

    const leadsLast30 = leads.filter(l => new Date(l.created_date) >= thirtyDaysAgo);
    const convertedLast30 = leadsLast30.filter(l => l.status === 'converted');
    const conversionRate = leadsLast30.length > 0 
      ? (convertedLast30.length / leadsLast30.length * 100).toFixed(1)
      : 0;

    const closedWithDates = closedLast30Days.filter(t => t.created_date);
    const avgTimeToClose = closedWithDates.length > 0
      ? Math.round(closedWithDates.reduce((sum, t) => {
          const days = (new Date(t.updated_date) - new Date(t.created_date)) / (1000 * 60 * 60 * 24);
          return sum + days;
        }, 0) / closedWithDates.length)
      : 0;

    const pipelineHealth = Math.min(100, Math.max(0, Math.round(
      (pendingDeals.length * 20) +
      (activeLeads.length * 10) +
      (activeProperties.length * 10) -
      (dealsAtRisk.length * 15) -
      (staleLeads.length * 10)
    )));

    const avgDealValue = closedLast30Days.length > 0
      ? closedLast30Days.reduce((sum, t) => sum + (t.listing_net_commission || 0), 0) / closedLast30Days.length
      : 0;
    
    const predictedClosings = Math.round(pendingDeals.length * 0.6);
    const predictedRevenue = predictedClosings * avgDealValue;

    const tasksCompleted30 = tasks.filter(t => 
      t.status === 'completed' && 
      t.completed_date && 
      new Date(t.completed_date) >= thirtyDaysAgo
    ).length;

    const activityScore = Math.min(100, tasksCompleted30 * 3);

    const opportunities = [];
    
    if (dealsAtRisk.length > 0) {
      opportunities.push({
        type: 'critical',
        title: `${dealsAtRisk.length} Deal${dealsAtRisk.length > 1 ? 's' : ''} Need Immediate Attention`,
        message: `No updates in 7+ days. Risk of losing ${dealsAtRisk.length} transaction${dealsAtRisk.length > 1 ? 's' : ''}`,
        action: 'Contact Clients Now',
        link: 'Transactions',
        priority: 'critical',
        impact: 'high',
        estimatedValue: dealsAtRisk.reduce((sum, t) => sum + (t.commission_total || 0), 0)
      });
    }

    if (hotLeadsWithUrgency.length > 0) {
      opportunities.push({
        type: 'success',
        title: `${hotLeadsWithUrgency.length} Hot Lead${hotLeadsWithUrgency.length > 1 ? 's' : ''} Ready to Convert`,
        message: `High-score leads with immediate timeline. Act fast to secure deals`,
        action: 'Contact Hot Leads',
        link: 'Leads',
        priority: 'high',
        impact: 'high',
        estimatedValue: hotLeadsWithUrgency.length * avgDealValue
      });
    }

    if (priceReductionCandidates.length > 0) {
      opportunities.push({
        type: 'warning',
        title: `${priceReductionCandidates.length} Propert${priceReductionCandidates.length > 1 ? 'ies' : 'y'} Need Price Strategy`,
        message: `45-90 DOM - optimal time for price reduction to generate interest`,
        action: 'Review Pricing',
        link: 'Properties',
        priority: 'high',
        impact: 'high'
      });
    }

    if (staleLeads.length > 0) {
      opportunities.push({
        type: 'warning',
        title: `${staleLeads.length} Lead${staleLeads.length > 1 ? 's' : ''} Going Cold`,
        message: `No contact in 14+ days - re-engage before losing them`,
        action: 'Send Follow-up',
        link: 'Leads',
        priority: 'medium',
        impact: 'medium'
      });
    }

    if (overpriced.length > 0) {
      opportunities.push({
        type: 'alert',
        title: `${overpriced.length} Propert${overpriced.length > 1 ? 'ies' : 'y'} Overpriced`,
        message: `Over 60 days on market - significant price adjustment needed`,
        action: 'Adjust Pricing',
        link: 'Properties',
        priority: 'medium',
        impact: 'high'
      });
    }

    if (hotProperties.length > 0) {
      opportunities.push({
        type: 'success',
        title: `${hotProperties.length} Propert${hotProperties.length > 1 ? 'ies' : 'y'} Selling Fast`,
        message: `Under 30 DOM - leverage momentum for similar listings`,
        action: 'Analyze Success',
        link: 'Properties',
        priority: 'low',
        impact: 'medium'
      });
    }

    const neighborhoodStats = {};
    transactions.filter(t => t.status === 'closed').forEach(t => {
      const property = properties.find(p => p.id === t.property_id);
      if (property && property.city) {
        if (!neighborhoodStats[property.city]) {
          neighborhoodStats[property.city] = { count: 0, revenue: 0, avgDays: 0, avgPrice: 0 };
        }
        neighborhoodStats[property.city].count++;
        neighborhoodStats[property.city].revenue += t.listing_net_commission || 0;
        neighborhoodStats[property.city].avgDays += property.days_on_market || 0;
        neighborhoodStats[property.city].avgPrice += property.price || 0;
      }
    });

    const topNeighborhoods = Object.entries(neighborhoodStats)
      .map(([city, stats]) => ({
        city,
        deals: stats.count,
        revenue: stats.revenue,
        avgDays: stats.count > 0 ? Math.round(stats.avgDays / stats.count) : 0,
        avgPrice: stats.count > 0 ? Math.round(stats.avgPrice / stats.count) : 0,
        velocity: stats.count / (stats.avgDays || 1)
      }))
      .sort((a, b) => b.revenue - a.revenue)
      .slice(0, 3);

    const leadSourcePerformance = {};
    leads.forEach(l => {
      const source = l.lead_source || 'unknown';
      if (!leadSourcePerformance[source]) {
        leadSourcePerformance[source] = { total: 0, converted: 0, avgScore: 0, revenue: 0 };
      }
      leadSourcePerformance[source].total++;
      if (l.status === 'converted') {
        leadSourcePerformance[source].converted++;
        const leadTransaction = transactions.find(t => 
          t.status === 'closed' && t.buyer_id === l.converted_to_buyer_id
        );
        if (leadTransaction) {
          leadSourcePerformance[source].revenue += leadTransaction.listing_net_commission || 0;
        }
      }
      leadSourcePerformance[source].avgScore += l.score || 0;
    });

    const bestSource = Object.entries(leadSourcePerformance)
      .map(([source, stats]) => ({
        source,
        conversionRate: stats.total > 0 ? (stats.converted / stats.total * 100).toFixed(1) : 0,
        avgScore: stats.total > 0 ? Math.round(stats.avgScore / stats.total) : 0,
        total: stats.total,
        revenue: stats.revenue,
        roi: stats.total > 0 ? (stats.revenue / stats.total) : 0
      }))
      .sort((a, b) => parseFloat(b.conversionRate) - parseFloat(a.conversionRate))[0];

    const qualifiedBuyers = buyers.filter(b => b.pre_approved && b.status === 'active');
    const matchedBuyers = buyers.filter(b => {
      const matchingProps = activeProperties.filter(p => {
        const inBudget = (!b.budget_max || p.price <= b.budget_max) && 
                        (!b.budget_min || p.price >= b.budget_min);
        const rightBeds = !b.min_bedrooms || p.bedrooms >= b.min_bedrooms;
        return inBudget && rightBeds;
      });
      return matchingProps.length > 0;
    });

    const recentSales = closedLast30Days.length;
    const previousSales = closedLast60Days.length - closedLast30Days.length;
    const marketMomentum = previousSales > 0 
      ? ((recentSales - previousSales) / previousSales * 100).toFixed(1)
      : 0;

    return {
      dealsAtRisk: dealsAtRisk.length,
      staleLeads: staleLeads.length,
      overpriced: overpriced.length,
      priceReductionCandidates: priceReductionCandidates.length,
      hotProperties: hotProperties.length,
      hotLeads: hotLeadsWithUrgency.length,
      revenueGrowth: parseFloat(revenueGrowth),
      conversionRate: parseFloat(conversionRate),
      convertedLeadsCount: convertedLast30.length,
      avgTimeToClose,
      pipelineHealth,
      predictedRevenue,
      predictedClosings,
      revenueLast30,
      topNeighborhoods,
      activityScore,
      opportunities: opportunities.sort((a, b) => {
        const priorityOrder = { 'critical': 3, 'high': 2, 'medium': 1, 'low': 0 };
        return priorityOrder[b.priority] - priorityOrder[a.priority];
      }).slice(0, 5),
      bestSource,
      closedLast30: closedLast30Days.length,
      qualifiedBuyers: qualifiedBuyers.length,
      matchedBuyers: matchedBuyers.length,
      marketMomentum: parseFloat(marketMomentum),
      avgDealValue,
      pendingValue: pendingDeals.reduce((sum, t) => sum + (t.commission_total || 0), 0)
    };
  };

  const calculateMetrics = () => {
    const closedTransactions = transactions.filter(t => t.status === 'closed');
    const pendingTransactions = transactions.filter(t => t.status === 'pending' || t.status === 'active');
    const activeProperties = properties.filter(p => p.status === 'active' || p.status === 'pending');

    const totalRevenue = closedTransactions.reduce((sum, t) => sum + (t.listing_net_commission || 0), 0);
    const pendingRevenue = pendingTransactions.reduce((sum, t) => sum + (t.listing_net_commission || 0), 0);
    const potentialPipeline = activeProperties.reduce((sum, p) => sum + (p.estimated_commission || 0), 0);

    return {
      totalRevenue,
      closedDeals: closedTransactions.length,
      totalPipeline: pendingRevenue + potentialPipeline,
      pendingDeals: pendingTransactions.length
    };
  };

  const metrics = calculateMetrics();

  if (isLoading) {
    return (
      <div className="page-container">
        <div className="space-y-3 p-4">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            {Array(6).fill(0).map((_, i) => (
              <div key={i} className="app-card h-20 shimmer"></div>
            ))}
          </div>
          <div className="app-card p-4 text-center">
            <RefreshCw className="w-6 h-6 mx-auto mb-2 animate-spin text-indigo-600" />
            <p className="text-sm text-slate-600 dark:text-slate-400">Loading your dashboard...</p>
          </div>
        </div>
      </div>
    );
  }

  if (loadError) {
    return (
      <div className="page-container">
        <div className="flex items-center justify-center p-8">
          <Card className="max-w-md w-full">
            <CardContent className="p-6 text-center">
              <AlertCircle className="w-10 h-10 mx-auto mb-3 text-red-500" />
              <h3 className="font-semibold mb-2 text-slate-900 dark:text-white">Unable to Load Dashboard</h3>
              <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">{loadError}</p>
              <Button onClick={() => window.location.reload()}>
                <RefreshCw className="w-4 h-4 mr-2" />
                Refresh Page
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  if (needsInit) {
    return (
      <div className="page-container">
        <div className="flex items-center justify-center p-8">
          <Card className="max-w-md w-full">
            <CardContent className="p-6 text-center">
              <Database className="w-10 h-10 mx-auto mb-3 text-amber-500" />
              <h3 className="font-semibold mb-2">No Data Found</h3>
              <p className="text-sm text-slate-600 mb-4">Initialize with demo data to get started</p>
              <Button onClick={() => navigate(createPageUrl("InitializeComprehensiveDemo"))}>
                <Database className="w-4 h-4 mr-2" />
                Initialize Demo
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="space-y-6">
        {/* Hero Header Section */}
        <div className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 p-8 text-white shadow-2xl">
          <div className="absolute inset-0 bg-black/10"></div>
          <div className="relative z-10">
            <div className="flex items-start justify-between mb-6">
              <div className="flex-1">
                <h1 className="text-4xl font-bold mb-3 flex items-center gap-3">
                  {getGreeting()}, {currentUser?.full_name?.split(' ')[0] || 'Agent'}! 
                  <span className="text-3xl">üëã</span>
                </h1>
                
                <div className="flex items-center gap-6 flex-wrap mb-4">
                  {/* Date and Time */}
                  <div className="text-white/90 text-lg font-medium flex items-center gap-3">
                    <Calendar className="w-5 h-5" />
                    <span>
                      {currentTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                    </span>
                    <span className="text-2xl">‚Ä¢</span>
                    <Clock className="w-5 h-5" />
                    <span className="text-xl font-semibold">
                      {currentTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}
                    </span>
                  </div>
                </div>

                {/* Meeting Countdown */}
                {nextMeeting && getCountdown() && (
                  <div className="inline-flex items-center gap-3 bg-red-500/90 backdrop-blur-sm border border-red-300 rounded-xl px-4 py-2 animate-pulse">
                    <Timer className="w-5 h-5 text-white" />
                    <div className="flex items-center gap-2">
                      <span className="text-white font-semibold text-sm">Next:</span>
                      <span className="text-white text-sm">{nextMeeting.title}</span>
                      <span className="text-white text-lg font-bold tracking-wide">
                        {getCountdown()}
                      </span>
                    </div>
                  </div>
                )}
              </div>
              
              {/* Quick Actions in Header */}
              <div className="flex gap-2">
                <Button
                  onClick={() => navigate(createPageUrl("PropertyAdd"))}
                  size="lg"
                  className="bg-white/20 hover:bg-white/30 backdrop-blur-sm border border-white/30 text-white font-semibold shadow-lg"
                >
                  <Plus className="w-5 h-5 mr-2" />
                  Add Property
                </Button>
                <Button
                  onClick={() => navigate(createPageUrl("RealtorTips"))}
                  size="lg"
                  className="bg-amber-500/90 hover:bg-amber-600 backdrop-blur-sm border border-amber-300 text-white font-semibold shadow-lg relative"
                >
                  <Lightbulb className="w-5 h-5 mr-2" />
                  Daily Tips
                  {unreadTipsCount > 0 && (
                    <span className="ml-2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pulse">
                      {unreadTipsCount}
                    </span>
                  )}
                </Button>
              </div>
            </div>

            {/* Key Stats in Header */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <button
                onClick={() => navigate(createPageUrl("Properties"))}
                className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 hover:bg-white/20 transition-all text-left"
              >
                <div className="text-white/80 text-xs font-medium mb-1">Active Listings</div>
                <div className="text-3xl font-bold">{stats.properties}</div>
              </button>
              <button
                onClick={() => navigate(createPageUrl("Leads"))}
                className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 hover:bg-white/20 transition-all text-left"
              >
                <div className="text-white/80 text-xs font-medium mb-1">Active Leads</div>
                <div className="text-3xl font-bold">{stats.leads}</div>
              </button>
              <button
                onClick={() => navigate(createPageUrl("Analytics"))}
                className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 hover:bg-white/20 transition-all text-left"
              >
                <div className="text-white/80 text-xs font-medium mb-1">Revenue (30d)</div>
                <div className="text-3xl font-bold">${(intelligence?.revenueLast30 / 1000).toFixed(0)}K</div>
              </button>
              <button
                onClick={() => navigate(createPageUrl("Transactions"))}
                className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 hover:bg-white/20 transition-all text-left"
              >
                <div className="text-white/80 text-xs font-medium mb-1">Pipeline Value</div>
                <div className="text-3xl font-bold">${(metrics.totalPipeline / 1000).toFixed(0)}K</div>
              </button>
            </div>
          </div>
        </div>

        {/* Marketing Banner */}
        {currentUser && !currentUser.profile_completed && (
          <MarketingBanner user={currentUser} />
        )}

        {/* Agent Profile Setup */}
        {currentUser && !currentUser.profile_completed && (
          <Card className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div className="flex-1">
                  <h3 className="text-xl font-bold mb-2 flex items-center gap-2">
                    <Sparkles className="w-6 h-6" />
                    Customize Your Dashboard
                  </h3>
                  <p className="text-white/90 mb-4">
                    Tell us what type of agent you are to get personalized recommendations, insights, and dashboard layout.
                  </p>
                  <Button
                    onClick={() => setShowProfileSetup(!showProfileSetup)}
                    size="lg"
                    className="bg-white text-indigo-600 hover:bg-white/90 font-semibold"
                  >
                    {showProfileSetup ? 'Hide Setup' : 'Set Up My Profile'}
                  </Button>
                </div>
                <div className="hidden md:block">
                  <Target className="w-24 h-24 text-white/20" />
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {showProfileSetup && currentUser && !currentUser.profile_completed && (
          <AgentProfileSetup 
            user={currentUser}
            onComplete={() => {
              setShowProfileSetup(false);
              loadDashboardData();
            }}
          />
        )}

        {/* Quick Edit Profile */}
        {currentUser && currentUser.profile_completed && (
          <Card className="bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 border-2 border-indigo-200 dark:border-indigo-800">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center">
                    <Target className="w-5 h-5 text-indigo-600 dark:text-indigo-400" />
                  </div>
                  <div>
                    <p className="font-semibold text-slate-900 dark:text-white">
                      {currentUser.agent_profile_type?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'Agent Profile'}
                    </p>
                    <p className="text-xs text-slate-600 dark:text-slate-400">
                      Dashboard customized for your business
                    </p>
                  </div>
                </div>
                <Button
                  onClick={() => setShowProfileSetup(!showProfileSetup)}
                  variant="outline"
                  size="sm"
                >
                  {showProfileSetup ? 'Hide' : 'Change Profile'}
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {showProfileSetup && currentUser && currentUser.profile_completed && (
          <AgentProfileSetup 
            user={currentUser}
            onComplete={() => {
              setShowProfileSetup(false);
              loadDashboardData();
            }}
          />
        )}

        {/* Daily Quote */}
        {dailyQuote && (
          <Card className="bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border-amber-200 dark:border-amber-800">
            <CardContent className="p-4">
              <div className="flex items-start gap-3">
                <Sparkles className="w-6 h-6 text-amber-600 flex-shrink-0 mt-1" />
                <div>
                  <p className="text-xs font-semibold text-amber-900 dark:text-amber-400 mb-1">üí° Daily Inspiration</p>
                  <p className="text-sm text-amber-800 dark:text-amber-300 italic">"{dailyQuote}"</p>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Personalized Insights */}
        {currentUser && currentUser.profile_completed && (
          <PersonalizedInsights 
            user={currentUser}
            stats={stats}
            intelligence={intelligence}
          />
        )}

        {/* Critical Opportunities */}
        {intelligence && intelligence.opportunities.length > 0 && (
          <Card className="border-l-4 border-l-red-500 shadow-lg">
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="flex items-center gap-2">
                  <AlertTriangle className="w-6 h-6 text-red-600" />
                  Action Required
                </CardTitle>
                <Badge className="bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300">
                  {intelligence.opportunities.length} Items
                </Badge>
              </div>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {intelligence.opportunities.map((opp, idx) => (
                  <div
                    key={idx}
                    onClick={() => navigate(createPageUrl(opp.link))}
                    className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg cursor-pointer hover:shadow-md transition-all border-l-4 border-l-red-500"
                  >
                    <div className="flex items-start justify-between mb-2">
                      <h4 className="font-semibold text-sm flex-1">{opp.title}</h4>
                      <Badge variant="outline" className="border-red-500 text-red-700 dark:border-red-400 dark:text-red-400">
                        {opp.priority}
                      </Badge>
                    </div>
                    <p className="text-xs text-slate-600 dark:text-slate-400 mb-3">{opp.message}</p>
                    <div className="flex items-center justify-between">
                      <Button size="sm" variant="outline" className="text-xs">
                        {opp.action} ‚Üí
                      </Button>
                      {opp.estimatedValue > 0 && (
                        <span className="text-xs font-bold text-green-600">
                          ${(opp.estimatedValue / 1000).toFixed(1)}K value
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        )}

        {/* Performance Charts Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Revenue & Deals Chart */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingUp className="w-5 h-5 text-green-600" />
                Performance Trends (6 Months)
              </CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={performanceData}>
                  <defs>
                    <linearGradient id="colorRevenue" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor={CHART_COLORS.success} stopOpacity={0.8}/>
                      <stop offset="95%" stopColor={CHART_COLORS.success} stopOpacity={0}/>
                    </linearGradient>
                    <linearGradient id="colorDeals" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor={CHART_COLORS.primary} stopOpacity={0.8}/>
                      <stop offset="95%" stopColor={CHART_COLORS.primary} stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                  <XAxis dataKey="month" stroke="#64748b" />
                  <YAxis stroke="#64748b" />
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#fff', border: '1px solid #e5e7eb', borderRadius: '8px' }}
                    formatter={(value, name) => {
                      if (name === 'revenue') return [`$${value}K`, 'Revenue'];
                      if (name === 'deals') return [value, 'Closed Deals'];
                      return [value, name];
                    }}
                  />
                  <Legend />
                  <Area type="monotone" dataKey="revenue" stroke={CHART_COLORS.success} fillOpacity={1} fill="url(#colorRevenue)" name="Revenue ($K)" />
                  <Area type="monotone" dataKey="deals" stroke={CHART_COLORS.primary} fillOpacity={1} fill="url(#colorDeals)" name="Closed Deals" />
                </AreaChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          {/* Pipeline Distribution */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <BarChart3 className="w-5 h-5 text-indigo-600" />
                Transaction Pipeline
              </CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={pipelineData}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
                    outerRadius={100}
                    fill="#8884d8"
                    dataKey="value"
                  >
                    {pipelineData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#fff', border: '1px solid #e5e7eb', borderRadius: '8px' }}
                  />
                  <Legend />
                </PieChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>

        {/* Main Content Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column - Activity Feed (2/3 width) */}
          <div className="lg:col-span-2 space-y-6">
            {/* Today's Focus */}
            <Card className="border-l-4 border-l-blue-500 shadow-lg">
              <CardHeader className="pb-3">
                <div className="flex items-center justify-between">
                  <CardTitle className="flex items-center gap-2">
                    <CheckSquare className="w-5 h-5 text-blue-600" />
                    Today's Focus
                  </CardTitle>
                  <Badge className="bg-blue-600 text-white">{todayTasks} tasks</Badge>
                </div>
              </CardHeader>
              <CardContent>
                {urgentTasks.length > 0 ? (
                  <div className="space-y-2">
                    {urgentTasks.map((task) => (
                      <div 
                        key={task.id}
                        onClick={() => navigate(createPageUrl("Tasks"))}
                        className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg cursor-pointer hover:shadow-md transition-all"
                      >
                        <div className="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0">
                          <Clock className="w-5 h-5 text-blue-600 dark:text-blue-400" />
                        </div>
                        <div className="flex-1">
                          <p className="font-medium text-sm text-slate-900 dark:text-white">{task.title}</p>
                          <p className="text-xs text-slate-500 dark:text-slate-400">
                            {task.due_date ? `Due: ${new Date(task.due_date).toLocaleDateString()}` : 'No due date'}
                          </p>
                        </div>
                        <ArrowRight className="w-5 h-5 text-slate-400" />
                      </div>
                    ))}
                    <Button 
                      onClick={() => navigate(createPageUrl("Tasks"))}
                      variant="outline"
                      className="w-full mt-2"
                    >
                      View All Tasks
                    </Button>
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <CheckCircle2 className="w-16 h-16 mx-auto mb-3 text-green-500" />
                    <p className="font-medium">All caught up for today!</p>
                    <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">Great job staying on top of your tasks</p>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Hot Leads */}
            <Card className="border-l-4 border-l-orange-500 shadow-lg">
              <CardHeader className="pb-3">
                <div className="flex items-center justify-between">
                  <CardTitle className="flex items-center gap-2">
                    <Flame className="w-5 h-5 text-orange-600" />
                    Hot Leads
                  </CardTitle>
                  <Badge className="bg-orange-600 text-white">{hotLeads.length}</Badge>
                </div>
              </CardHeader>
              <CardContent>
                {hotLeads.length > 0 ? (
                  <div className="space-y-2">
                    {hotLeads.map((lead) => (
                      <div 
                        key={lead.id}
                        onClick={() => navigate(createPageUrl(`LeadDetail?id=${lead.id}`))}
                        className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg cursor-pointer hover:shadow-md transition-all"
                      >
                        <div className="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900 flex items-center justify-center flex-shrink-0">
                          <Target className="w-5 h-5 text-orange-600 dark:text-orange-400" />
                        </div>
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            <p className="font-medium text-sm text-slate-900 dark:text-white">{lead.name}</p>
                            <Badge className="bg-orange-600 text-white text-xs">{lead.score}</Badge>
                          </div>
                          <p className="text-xs text-slate-500 dark:text-slate-400">
                            {lead.timeline || 'N/A'} ‚Ä¢ {lead.status}
                          </p>
                        </div>
                        <ArrowRight className="w-5 h-5 text-slate-400" />
                      </div>
                    ))}
                    <Button 
                      onClick={() => navigate(createPageUrl("Leads"))}
                      variant="outline"
                      className="w-full mt-2"
                    >
                      View All Leads
                    </Button>
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <Target className="w-16 h-16 mx-auto mb-3 text-slate-300" />
                    <p className="text-sm text-slate-600 dark:text-slate-400">No hot leads at the moment</p>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Recent Activity */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Activity className="w-5 h-5 text-purple-600" />
                  Recent Activity
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {recentActivity.map((activity, idx) => {
                    const Icon = activity.icon;
                    return (
                      <div
                        key={idx}
                        onClick={() => navigate(activity.link)}
                        className="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer transition-all"
                      >
                        <div className={`w-10 h-10 rounded-full ${activity.bg} flex items-center justify-center flex-shrink-0`}>
                          <Icon className={`w-5 h-5 ${activity.color}`} />
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="font-medium text-sm text-slate-900 dark:text-white">{activity.title}</p>
                          <p className="text-xs text-slate-500 dark:text-slate-400 truncate">{activity.description}</p>
                          <p className="text-xs text-slate-400 dark:text-slate-500 mt-1">
                            {activity.time.toLocaleString('en-US', { 
                              month: 'short', 
                              day: 'numeric', 
                              hour: 'numeric', 
                              minute: '2-digit' 
                            })}
                          </p>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Right Column - Quick Access & Events (1/3 width) */}
          <div className="space-y-6">
            {/* Quick Access */}
            <Card className="border-l-4 border-l-purple-500 shadow-lg">
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2">
                  <Zap className="w-5 h-5 text-purple-600" />
                  Quick Access
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-2">
                  <Button
                    onClick={() => navigate(createPageUrl("Leads"))}
                    variant="outline"
                    className="h-20 flex flex-col items-center justify-center gap-2"
                  >
                    <Target className="w-6 h-6 text-orange-600" />
                    <span className="text-xs font-medium">Leads</span>
                  </Button>
                  <Button
                    onClick={() => navigate(createPageUrl("Buyers"))}
                    variant="outline"
                    className="h-20 flex flex-col items-center justify-center gap-2"
                  >
                    <Users className="w-6 h-6 text-blue-600" />
                    <span className="text-xs font-medium">Buyers</span>
                  </Button>
                  <Button
                    onClick={() => navigate(createPageUrl("Tasks"))}
                    variant="outline"
                    className="h-20 flex flex-col items-center justify-center gap-2"
                  >
                    <CheckSquare className="w-6 h-6 text-green-600" />
                    <span className="text-xs font-medium">Tasks</span>
                  </Button>
                  <Button
                    onClick={() => navigate(createPageUrl("Messages"))}
                    variant="outline"
                    className="h-20 flex flex-col items-center justify-center gap-2"
                  >
                    <MessageSquare className="w-6 h-6 text-indigo-600" />
                    <span className="text-xs font-medium">Messages</span>
                  </Button>
                  <Button
                    onClick={() => navigate(createPageUrl("Documents"))}
                    variant="outline"
                    className="h-20 flex flex-col items-center justify-center gap-2"
                  >
                    <FileText className="w-6 h-6 text-slate-600" />
                    <span className="text-xs font-medium">Documents</span>
                  </Button>
                  <Button
                    onClick={() => navigate(createPageUrl("Photos"))}
                    variant="outline"
                    className="h-20 flex flex-col items-center justify-center gap-2"
                  >
                    <Camera className="w-6 h-6 text-purple-600" />
                    <span className="text-xs font-medium">Photos</span>
                  </Button>
                  <Button
                    onClick={() => navigate(createPageUrl("Analytics"))}
                    variant="outline"
                    className="h-20 flex flex-col items-center justify-center gap-2"
                  >
                    <BarChart3 className="w-6 h-6 text-cyan-600" />
                    <span className="text-xs font-medium">Analytics</span>
                  </Button>
                  <Button
                    onClick={() => navigate(createPageUrl("PropertyAdvisor"))}
                    variant="outline"
                    className="h-20 flex flex-col items-center justify-center gap-2"
                  >
                    <Sparkles className="w-6 h-6 text-pink-600" />
                    <span className="text-xs font-medium">AI Advisor</span>
                  </Button>
                </div>
              </CardContent>
            </Card>

            {/* Upcoming Events */}
            <Card className="border-l-4 border-l-green-500 shadow-lg">
              <CardHeader className="pb-3">
                <div className="flex items-center justify-between">
                  <CardTitle className="flex items-center gap-2">
                    <Calendar className="w-5 h-5 text-green-600" />
                    Upcoming Events
                  </CardTitle>
                  <Badge className="bg-green-600 text-white">{upcomingEvents.length}</Badge>
                </div>
              </CardHeader>
              <CardContent>
                {upcomingEvents.length > 0 ? (
                  <div className="space-y-2">
                    {upcomingEvents.map((event, idx) => (
                      <div 
                        key={idx}
                        onClick={() => navigate(createPageUrl("Calendar"))}
                        className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg cursor-pointer hover:shadow-md transition-all"
                      >
                        <div className="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center flex-shrink-0">
                          <Calendar className="w-5 h-5 text-green-600 dark:text-green-400" />
                        </div>
                        <div className="flex-1">
                          <p className="font-medium text-sm text-slate-900 dark:text-white">{event.title}</p>
                          <p className="text-xs text-slate-500 dark:text-slate-400">
                            {event.date ? new Date(event.date).toLocaleDateString() : ''} {event.time || ''}
                          </p>
                        </div>
                        <ArrowRight className="w-5 h-5 text-slate-400" />
                      </div>
                    ))}
                    <Button 
                      onClick={() => navigate(createPageUrl("Calendar"))}
                      variant="outline"
                      className="w-full mt-2"
                    >
                      View Calendar
                    </Button>
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <Calendar className="w-16 h-16 mx-auto mb-3 text-slate-300" />
                    <p className="text-sm text-slate-600 dark:text-slate-400">No upcoming events</p>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Performance Metrics */}
            {intelligence && (
              <Card className="shadow-lg">
                <CardHeader className="pb-3">
                  <CardTitle className="flex items-center gap-2">
                    <Award className="w-5 h-5 text-amber-600" />
                    Key Metrics
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Pipeline Health</span>
                        <span className="text-lg font-bold text-blue-600">{intelligence.pipelineHealth}%</span>
                      </div>
                      <Progress value={intelligence.pipelineHealth} className="h-2" />
                    </div>

                    <div className="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                      <div className="flex items-center justify-between">
                        <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Revenue Growth</span>
                        <span className={`text-lg font-bold ${intelligence.revenueGrowth >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                          {intelligence.revenueGrowth >= 0 ? '+' : ''}{intelligence.revenueGrowth}%
                        </span>
                      </div>
                      <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">vs last 30 days</p>
                    </div>

                    <div className="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                      <div className="flex items-center justify-between">
                        <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Conversion Rate</span>
                        <span className="text-lg font-bold text-purple-600">{intelligence.conversionRate}%</span>
                      </div>
                      <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{intelligence.convertedLeadsCount} leads converted</p>
                    </div>

                    <div className="p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                      <div className="flex items-center justify-between">
                        <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Avg Days to Close</span>
                        <span className="text-lg font-bold text-amber-600">{intelligence.avgTimeToClose}</span>
                      </div>
                      <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{intelligence.closedLast30} deals closed</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}
          </div>
        </div>

        {/* Recent Properties */}
        <Card className="shadow-lg">
          <CardHeader className="pb-3">
            <div className="flex items-center justify-between">
              <CardTitle className="flex items-center gap-2">
                <Building2 className="w-6 h-6 text-indigo-600" />
                Recent Properties
              </CardTitle>
              <Button
                onClick={() => navigate(createPageUrl("Properties"))}
                variant="ghost"
                size="sm"
                className="text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1"
              >
                View All <ArrowRight className="w-4 h-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              {recentProperties.map((property) => (
                <div
                  key={property.id}
                  onClick={() => navigate(createPageUrl(`PropertyDetail?id=${property.id}`))}
                  className="border rounded-xl overflow-hidden cursor-pointer hover:shadow-lg transition-all bg-white dark:bg-slate-800"
                >
                  {property.primary_photo_url ? (
                    <div className="relative h-40">
                      <img
                        src={property.primary_photo_url}
                        alt={property.address}
                        className="w-full h-full object-cover"
                      />
                      <div className="absolute top-2 right-2 bg-white dark:bg-slate-800 px-2 py-1 rounded text-xs font-bold">
                        ${(property.price / 1000000).toFixed(2)}M
                      </div>
                    </div>
                  ) : (
                    <div className="h-40 bg-slate-100 dark:bg-slate-700 flex items-center justify-center">
                      <Home className="w-12 h-12 text-slate-300" />
                    </div>
                  )}
                  <div className="p-3">
                    <p className="font-semibold text-sm truncate text-slate-900 dark:text-white">{property.address}</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{property.city}, {property.state}</p>
                    <div className="flex gap-2 text-xs text-slate-600 dark:text-slate-400 mt-2">
                      {property.bedrooms && (
                        <span className="flex items-center gap-1">
                          <BedDouble className="w-3 h-3" />
                          {property.bedrooms}
                        </span>
                      )}
                      {property.bathrooms && (
                        <span className="flex items-center gap-1">
                          <Bath className="w-3 h-3" />
                          {property.bathrooms}
                        </span>
                      )}
                      {property.square_feet && (
                        <span className="flex items-center gap-1">
                          <Square className="w-3 h-3" />
                          {(property.square_feet / 1000).toFixed(1)}K
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { 
    Users, Plus, TrendingUp, Star, MessageCircle, ThumbsUp, 
    Sparkles, Search, Filter, Award, BookOpen, Lightbulb,
    Target, Zap, Heart, Trophy, HelpCircle, Loader2
} from 'lucide-react';
import { toast } from 'sonner';
import { formatDistanceToNow } from 'date-fns';

import CreatePostModal from '../components/agentclub/CreatePostModal';
import PostCard from '../components/agentclub/PostCard';
import LoadingSpinner from '../components/common/LoadingSpinner';

const CATEGORIES = [
    { value: 'all', label: 'All Posts', icon: Users },
    { value: 'success_story', label: 'Success Stories', icon: Trophy },
    { value: 'tip_trick', label: 'Tips & Tricks', icon: Lightbulb },
    { value: 'market_insight', label: 'Market Insights', icon: TrendingUp },
    { value: 'question', label: 'Questions', icon: HelpCircle },
    { value: 'strategy', label: 'Strategies', icon: Target },
    { value: 'tool_recommendation', label: 'Tool Recommendations', icon: Zap },
    { value: 'celebration', label: 'Celebrations', icon: Heart },
];

export default function AgentClub() {
    const queryClient = useQueryClient();
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedCategory, setSelectedCategory] = useState('all');
    const [searchQuery, setSearchQuery] = useState('');
    const [sortBy, setSortBy] = useState('recent'); // 'recent', 'popular', 'trending'

    const { data: user } = useQuery({
        queryKey: ['user'],
        queryFn: () => base44.auth.me()
    });

    const { data: posts = [], isLoading } = useQuery({
        queryKey: ['agentPosts'],
        queryFn: async () => {
            return await base44.entities.AgentPost.list('-created_date', 100);
        },
        staleTime: 60000, // 1 minute
    });

    const { data: comments = [] } = useQuery({
        queryKey: ['agentComments'],
        queryFn: () => base44.entities.AgentComment.list(),
        staleTime: 60000,
    });

    const { data: reactions = [] } = useQuery({
        queryKey: ['agentReactions'],
        queryFn: () => base44.entities.AgentReaction.list(),
        staleTime: 60000,
    });

    const { data: users = [] } = useQuery({
        queryKey: ['users'],
        queryFn: () => base44.entities.User.list(),
        staleTime: 300000, // 5 minutes
    });

    const createPostMutation = useMutation({
        mutationFn: (postData) => base44.entities.AgentPost.create(postData),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['agentPosts'] });
            toast.success('Post shared with the community!');
            setShowCreateModal(false);
        },
        onError: (error) => {
            toast.error(`Failed to create post: ${error.message}`);
        }
    });

    const toggleReactionMutation = useMutation({
        mutationFn: async ({ postId, reactionType }) => {
            // Check if user already reacted
            const existingReaction = reactions.find(
                r => r.user_id === user.id && r.post_id === postId && r.reaction_type === reactionType
            );

            if (existingReaction) {
                // Unlike
                await base44.entities.AgentReaction.delete(existingReaction.id);
                
                // Update post likes count
                const post = posts.find(p => p.id === postId);
                if (post) {
                    await base44.entities.AgentPost.update(postId, {
                        likes_count: Math.max(0, (post.likes_count || 0) - 1)
                    });
                }
                
                return { action: 'removed' };
            } else {
                // Like
                await base44.entities.AgentReaction.create({
                    user_id: user.id,
                    post_id: postId,
                    reaction_type: reactionType
                });

                // Update post likes count
                const post = posts.find(p => p.id === postId);
                if (post) {
                    await base44.entities.AgentPost.update(postId, {
                        likes_count: (post.likes_count || 0) + 1
                    });
                }

                return { action: 'added' };
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['agentPosts'] });
            queryClient.invalidateQueries({ queryKey: ['agentReactions'] });
        }
    });

    const filteredPosts = posts
        .filter(post => {
            const matchesCategory = selectedCategory === 'all' || post.category === selectedCategory;
            const matchesSearch = !searchQuery || 
                post.content?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                post.tags?.toLowerCase().includes(searchQuery.toLowerCase());
            return matchesCategory && matchesSearch;
        })
        .sort((a, b) => {
            if (sortBy === 'recent') {
                return new Date(b.created_date) - new Date(a.created_date);
            }
            if (sortBy === 'popular') {
                return (b.likes_count || 0) - (a.likes_count || 0);
            }
            if (sortBy === 'trending') {
                const aScore = (a.likes_count || 0) + (a.comments_count || 0) * 2;
                const bScore = (b.likes_count || 0) + (b.comments_count || 0) * 2;
                return bScore - aScore;
            }
            return 0;
        });

    const pinnedPosts = filteredPosts.filter(p => p.is_pinned);
    const regularPosts = filteredPosts.filter(p => !p.is_pinned);

    if (isLoading) {
        return <LoadingSpinner icon={Users} title="Loading Agent Club..." description="Connecting with agents across the platform" />;
    }

    return (
        <div className="space-y-6">
            {/* Hero Header */}
            <div 
                className="rounded-2xl p-8 text-white relative overflow-hidden"
                style={{ background: 'linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%)' }}
            >
                <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4xIj48cGF0aCBkPSJNMzYgMzRoLTJ2LTRoMnY0em0wLTZ2LTRoLTJ2NGgyem0tNiA2di00aC00djRoNHptMC02di00aC00djRoNHptLTYgNnYtNGgtNHY0aDR6bTAtNnYtNGgtNHY0aDR6Ii8+PC9nPjwvZz48L3N2Zz4=')] opacity-20"></div>
                <div className="relative z-10">
                    <div className="flex items-center justify-between">
                        <div>
                            <div className="flex items-center gap-3 mb-2">
                                <div className="w-14 h-14 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center">
                                    <Users className="w-7 h-7 text-white" />
                                </div>
                                <div>
                                    <h1 className="text-3xl font-bold">Agent Club</h1>
                                    <p className="text-white/90 text-sm">Connect, share, and learn from agents worldwide</p>
                                </div>
                            </div>
                        </div>
                        <Button 
                            onClick={() => setShowCreateModal(true)}
                            className="bg-white hover:bg-white/90"
                            style={{ color: 'var(--theme-primary)' }}
                        >
                            <Plus className="w-4 h-4 mr-2" />
                            Share a Post
                        </Button>
                    </div>

                    {/* Quick Stats */}
                    <div className="grid grid-cols-4 gap-4 mt-6">
                        <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <div className="text-2xl font-bold">{posts.length}</div>
                            <div className="text-xs text-white/80">Total Posts</div>
                        </div>
                        <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <div className="text-2xl font-bold">{users.length}</div>
                            <div className="text-xs text-white/80">Active Agents</div>
                        </div>
                        <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <div className="text-2xl font-bold">{comments.length}</div>
                            <div className="text-xs text-white/80">Discussions</div>
                        </div>
                        <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <div className="text-2xl font-bold">{reactions.length}</div>
                            <div className="text-xs text-white/80">Reactions</div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Filters */}
            <Card className="p-4">
                <div className="flex flex-col lg:flex-row gap-4">
                    <div className="relative flex-1">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4" />
                        <Input
                            placeholder="Search posts, tags, topics..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="pl-10"
                        />
                    </div>
                    <select
                        value={sortBy}
                        onChange={(e) => setSortBy(e.target.value)}
                        className="px-4 py-2 border rounded-lg text-sm bg-white dark:bg-slate-800 dark:border-slate-700"
                    >
                        <option value="recent">Most Recent</option>
                        <option value="popular">Most Popular</option>
                        <option value="trending">Trending</option>
                    </select>
                </div>
            </Card>

            {/* Category Pills */}
            <div className="flex gap-2 overflow-x-auto pb-2">
                {CATEGORIES.map(cat => {
                    const Icon = cat.icon;
                    const isActive = selectedCategory === cat.value;
                    return (
                        <Button
                            key={cat.value}
                            variant={isActive ? 'default' : 'outline'}
                            size="sm"
                            onClick={() => setSelectedCategory(cat.value)}
                            className={`flex-shrink-0 ${isActive ? '' : ''}`}
                            style={isActive ? { background: 'var(--theme-primary)' } : {}}
                        >
                            <Icon className="w-4 h-4 mr-2" />
                            {cat.label}
                        </Button>
                    );
                })}
            </div>

            {/* Posts Feed */}
            <div className="space-y-4">
                {/* Pinned Posts */}
                {pinnedPosts.length > 0 && (
                    <div className="space-y-4">
                        <div className="flex items-center gap-2 text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <Star className="w-4 h-4 text-amber-500" />
                            Pinned Posts
                        </div>
                        {pinnedPosts.map(post => (
                            <PostCard
                                key={post.id}
                                post={post}
                                author={users.find(u => u.id === post.author_id)}
                                currentUser={user}
                                comments={comments.filter(c => c.post_id === post.id)}
                                reactions={reactions}
                                users={users}
                                onToggleReaction={(postId, type) => toggleReactionMutation.mutate({ postId, reactionType: type })}
                            />
                        ))}
                    </div>
                )}

                {/* Regular Posts */}
                {regularPosts.length === 0 ? (
                    <Card className="p-12 text-center">
                        <Users className="w-16 h-16 text-slate-300 mx-auto mb-4" />
                        <h3 className="text-xl font-semibold mb-2">No Posts Yet</h3>
                        <p className="text-slate-600 dark:text-slate-400 mb-6">
                            Be the first to share your knowledge with the community!
                        </p>
                        <Button onClick={() => setShowCreateModal(true)} className="bg-gradient-to-r from-indigo-600 to-purple-600">
                            <Plus className="w-4 h-4 mr-2" />
                            Create First Post
                        </Button>
                    </Card>
                ) : (
                    regularPosts.map(post => (
                        <PostCard
                            key={post.id}
                            post={post}
                            author={users.find(u => u.id === post.author_id)}
                            currentUser={user}
                            comments={comments.filter(c => c.post_id === post.id)}
                            reactions={reactions}
                            users={users}
                            onToggleReaction={(postId, type) => toggleReactionMutation.mutate({ postId, reactionType: type })}
                        />
                    ))
                )}
            </div>

            {showCreateModal && (
                <CreatePostModal
                    user={user}
                    onClose={() => setShowCreateModal(false)}
                    onSubmit={(postData) => createPostMutation.mutate(postData)}
                    isSubmitting={createPostMutation.isPending}
                />
            )}
        </div>
    );
}
import React, { useState } from "react";
import { searchNARAgent } from "@/api/functions";
import { base44 } from "@/api/base44Client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Search,
  User,
  Mail,
  Phone,
  Building2,
  MapPin,
  Award,
  Globe,
  Briefcase,
  CheckCircle2,
  XCircle,
  Loader2,
  Shield,
  Star,
  Clock,
  UserPlus,
  AlertCircle,
} from "lucide-react";
import { toast } from "sonner";

export default function AgentSearch() {
  const [searchType, setSearchType] = useState("name");
  const [searchValue, setSearchValue] = useState("");
  const [searching, setSearching] = useState(false);
  const [searchResults, setSearchResults] = useState([]);
  const [selectedAgent, setSelectedAgent] = useState(null);
  const [showDetailsModal, setShowDetailsModal] = useState(false);
  const [hasSearched, setHasSearched] = useState(false);

  const handleSearch = async (e) => {
    e.preventDefault();

    if (!searchValue.trim()) {
      toast.error("Please enter a search value");
      return;
    }

    setSearching(true);
    setHasSearched(true);
    
    try {
      const response = await searchNARAgent({
        searchType,
        searchValue: searchValue.trim()
      });

      if (response.data.error) {
        toast.error(response.data.error);
        setSearchResults([]);
      } else {
        setSearchResults(response.data.agents || []);
        
        if (response.data.agents && response.data.agents.length > 0) {
          toast.success(`Found ${response.data.agents.length} agent${response.data.agents.length !== 1 ? 's' : ''}`);
        } else {
          toast.info("No agents found matching your search criteria");
        }
      }
    } catch (error) {
      console.error("Search error:", error);
      
      if (error.response?.data?.error) {
        toast.error(error.response.data.error);
      } else {
        toast.error("Failed to search agents. Please check your NAR API configuration.");
      }
      
      setSearchResults([]);
    } finally {
      setSearching(false);
    }
  };

  const handleViewDetails = (agent) => {
    setSelectedAgent(agent);
    setShowDetailsModal(true);
  };

  const handleAddToContacts = async (agent) => {
    try {
      await base44.entities.Contact.create({
        name: agent.full_name,
        email: agent.email,
        phone: agent.phone,
        relationship: 'professional',
        notes: `NAR ID: ${agent.nar_id || 'N/A'}\nBrokerage: ${agent.brokerage || 'N/A'}\nLicense: ${agent.license_number || 'N/A'}`,
        profile_photo_url: agent.profile_photo_url
      });

      toast.success(`${agent.full_name} added to your contacts!`);
    } catch (error) {
      console.error("Error adding to contacts:", error);
      toast.error("Failed to add agent to contacts");
    }
  };

  const getLicenseStatusBadge = (status) => {
    if (!status) return null;
    
    const statusLower = status.toLowerCase();
    
    if (statusLower.includes('active') || statusLower.includes('current')) {
      return (
        <Badge className="bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300 border-green-300">
          <CheckCircle2 className="w-3 h-3 mr-1" />
          Active License
        </Badge>
      );
    }
    
    if (statusLower.includes('inactive') || statusLower.includes('expired')) {
      return (
        <Badge className="bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300 border-red-300">
          <XCircle className="w-3 h-3 mr-1" />
          {status}
        </Badge>
      );
    }
    
    return (
      <Badge variant="outline" className="bg-slate-100 dark:bg-slate-800">
        {status}
      </Badge>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 p-6">
      <div className="max-w-6xl mx-auto space-y-6">
        {/* Header */}
        <div className="text-center mb-8">
          <div className="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl">
            <Search className="w-10 h-10 text-white" />
          </div>
          <h1 className="text-4xl font-bold text-slate-900 dark:text-white mb-2">
            NAR Agent Search
          </h1>
          <p className="text-slate-600 dark:text-slate-400">
            Search for licensed real estate agents by name, email, or NAR ID
          </p>
        </div>

        {/* Search Form */}
        <Card className="shadow-lg border-2 border-slate-200 dark:border-slate-700">
          <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
            <CardTitle className="flex items-center gap-2">
              <Search className="w-5 h-5 text-indigo-600" />
              Search Agent
            </CardTitle>
          </CardHeader>
          <CardContent className="pt-6">
            <form onSubmit={handleSearch} className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="searchType">Search By</Label>
                  <Select value={searchType} onValueChange={setSearchType}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="name">
                        <div className="flex items-center gap-2">
                          <User className="w-4 h-4" />
                          Agent Name
                        </div>
                      </SelectItem>
                      <SelectItem value="email">
                        <div className="flex items-center gap-2">
                          <Mail className="w-4 h-4" />
                          Email Address
                        </div>
                      </SelectItem>
                      <SelectItem value="nar_id">
                        <div className="flex items-center gap-2">
                          <Shield className="w-4 h-4" />
                          NAR ID
                        </div>
                      </SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="md:col-span-2 space-y-2">
                  <Label htmlFor="searchValue">
                    {searchType === 'name' && 'Agent Name'}
                    {searchType === 'email' && 'Email Address'}
                    {searchType === 'nar_id' && 'NAR Member ID'}
                  </Label>
                  <div className="flex gap-2">
                    <Input
                      id="searchValue"
                      value={searchValue}
                      onChange={(e) => setSearchValue(e.target.value)}
                      placeholder={
                        searchType === 'name' ? 'e.g., John Smith' :
                        searchType === 'email' ? 'e.g., agent@realty.com' :
                        'e.g., 123456789'
                      }
                      className="flex-1"
                      disabled={searching}
                    />
                    <Button
                      type="submit"
                      disabled={searching || !searchValue.trim()}
                      className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 px-6"
                    >
                      {searching ? (
                        <>
                          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                          Searching...
                        </>
                      ) : (
                        <>
                          <Search className="w-4 h-4 mr-2" />
                          Search
                        </>
                      )}
                    </Button>
                  </div>
                </div>
              </div>

              <div className="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                <div className="flex items-start gap-2">
                  <AlertCircle className="w-4 h-4 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                  <div className="text-xs text-blue-900 dark:text-blue-100">
                    <p className="font-semibold mb-1">NAR API Key Required</p>
                    <p className="text-blue-800 dark:text-blue-200">
                      Make sure you've added your NAR_API_KEY in Dashboard ‚Üí Settings ‚Üí Environment Variables. 
                      If you don't have a NAR API key, you can obtain one from the NAR developer portal or use a third-party real estate data provider.
                    </p>
                  </div>
                </div>
              </div>
            </form>
          </CardContent>
        </Card>

        {/* Search Results */}
        {hasSearched && (
          <Card className="shadow-lg border-2 border-slate-200 dark:border-slate-700">
            <CardHeader className="bg-gradient-to-r from-slate-50 to-indigo-50 dark:from-slate-800 dark:to-indigo-900/20">
              <CardTitle className="flex items-center justify-between">
                <span className="flex items-center gap-2">
                  <User className="w-5 h-5 text-indigo-600" />
                  Search Results
                </span>
                {searchResults.length > 0 && (
                  <Badge className="bg-indigo-600 text-white">
                    {searchResults.length} Found
                  </Badge>
                )}
              </CardTitle>
            </CardHeader>
            <CardContent className="pt-6">
              {searchResults.length === 0 ? (
                <div className="text-center py-12">
                  <User className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                  <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
                    No agents found
                  </h3>
                  <p className="text-slate-600 dark:text-slate-400">
                    Try adjusting your search criteria or search type
                  </p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {searchResults.map((agent, index) => (
                    <Card key={index} className="hover:shadow-lg transition-all border-2 border-slate-200 dark:border-slate-700">
                      <CardContent className="p-6">
                        <div className="flex items-start gap-4">
                          {agent.profile_photo_url ? (
                            <img
                              src={agent.profile_photo_url}
                              alt={agent.full_name}
                              className="w-16 h-16 rounded-full object-cover border-2 border-indigo-200"
                            />
                          ) : (
                            <div className="w-16 h-16 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900/30 dark:to-purple-900/30 flex items-center justify-center">
                              <User className="w-8 h-8 text-indigo-600 dark:text-indigo-400" />
                            </div>
                          )}

                          <div className="flex-1 min-w-0">
                            <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
                              {agent.full_name}
                            </h3>

                            {/* License Status */}
                            <div className="mb-3">
                              {getLicenseStatusBadge(agent.license_status)}
                            </div>

                            {/* Contact Info */}
                            <div className="space-y-2 mb-4">
                              {agent.email && (
                                <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                                  <Mail className="w-4 h-4 flex-shrink-0" />
                                  <span className="truncate">{agent.email}</span>
                                </div>
                              )}
                              {agent.phone && (
                                <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                                  <Phone className="w-4 h-4 flex-shrink-0" />
                                  <span>{agent.phone}</span>
                                </div>
                              )}
                              {agent.brokerage && (
                                <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                                  <Building2 className="w-4 h-4 flex-shrink-0" />
                                  <span className="truncate">{agent.brokerage}</span>
                                </div>
                              )}
                              {agent.license_number && (
                                <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                                  <Shield className="w-4 h-4 flex-shrink-0" />
                                  <span>License: {agent.license_number}</span>
                                </div>
                              )}
                            </div>

                            {/* Additional Info Badges */}
                            <div className="flex flex-wrap gap-2 mb-4">
                              {agent.nar_id && (
                                <Badge variant="outline" className="text-xs">
                                  NAR: {agent.nar_id}
                                </Badge>
                              )}
                              {agent.specialization && (
                                <Badge variant="outline" className="text-xs bg-purple-50 text-purple-700 dark:bg-purple-900/30">
                                  <Award className="w-3 h-3 mr-1" />
                                  {agent.specialization}
                                </Badge>
                              )}
                              {agent.years_experience && (
                                <Badge variant="outline" className="text-xs bg-blue-50 text-blue-700 dark:bg-blue-900/30">
                                  <Clock className="w-3 h-3 mr-1" />
                                  {agent.years_experience} years
                                </Badge>
                              )}
                            </div>

                            {/* Actions */}
                            <div className="flex gap-2">
                              <Button
                                size="sm"
                                onClick={() => handleViewDetails(agent)}
                                className="flex-1 bg-indigo-600 hover:bg-indigo-700"
                              >
                                View Details
                              </Button>
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={() => handleAddToContacts(agent)}
                              >
                                <UserPlus className="w-4 h-4 mr-1" />
                                Add to Contacts
                              </Button>
                            </div>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {/* Info Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Card className="border-2 border-blue-200 dark:border-blue-800">
            <CardContent className="p-6">
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                  <Shield className="w-5 h-5 text-blue-600" />
                </div>
                <div>
                  <h3 className="font-semibold text-slate-900 dark:text-white mb-1">
                    Verify Credentials
                  </h3>
                  <p className="text-sm text-slate-600 dark:text-slate-400">
                    Check license status and NAR membership for any agent
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="border-2 border-purple-200 dark:border-purple-800">
            <CardContent className="p-6">
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                  <Building2 className="w-5 h-5 text-purple-600" />
                </div>
                <div>
                  <h3 className="font-semibold text-slate-900 dark:text-white mb-1">
                    Find Brokerages
                  </h3>
                  <p className="text-sm text-slate-600 dark:text-slate-400">
                    Discover agent affiliations and office locations
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="border-2 border-green-200 dark:border-green-800">
            <CardContent className="p-6">
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                  <UserPlus className="w-5 h-5 text-green-600" />
                </div>
                <div>
                  <h3 className="font-semibold text-slate-900 dark:text-white mb-1">
                    Build Network
                  </h3>
                  <p className="text-sm text-slate-600 dark:text-slate-400">
                    Add verified agents directly to your contacts
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>

      {/* Agent Details Modal */}
      {showDetailsModal && selectedAgent && (
        <Dialog open={showDetailsModal} onOpenChange={setShowDetailsModal}>
          <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-3">
                {selectedAgent.profile_photo_url ? (
                  <img
                    src={selectedAgent.profile_photo_url}
                    alt={selectedAgent.full_name}
                    className="w-12 h-12 rounded-full object-cover border-2 border-indigo-200"
                  />
                ) : (
                  <div className="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center">
                    <User className="w-6 h-6 text-indigo-600" />
                  </div>
                )}
                <div>
                  <h2 className="text-xl font-bold">{selectedAgent.full_name}</h2>
                  <p className="text-sm text-slate-500 font-normal">NAR Agent Profile</p>
                </div>
              </DialogTitle>
            </DialogHeader>

            <div className="space-y-6 py-4">
              {/* License Information */}
              <div>
                <h3 className="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                  <Shield className="w-5 h-5 text-indigo-600" />
                  License Information
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {selectedAgent.license_number && (
                    <div className="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                      <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">License Number</p>
                      <p className="font-semibold text-slate-900 dark:text-white">{selectedAgent.license_number}</p>
                    </div>
                  )}
                  {selectedAgent.license_status && (
                    <div className="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                      <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">Status</p>
                      <div className="mt-1">{getLicenseStatusBadge(selectedAgent.license_status)}</div>
                    </div>
                  )}
                  {selectedAgent.nar_id && (
                    <div className="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                      <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">NAR Member ID</p>
                      <p className="font-semibold text-slate-900 dark:text-white">{selectedAgent.nar_id}</p>
                    </div>
                  )}
                  {selectedAgent.years_experience && (
                    <div className="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                      <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">Experience</p>
                      <p className="font-semibold text-slate-900 dark:text-white">{selectedAgent.years_experience} years</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Contact Information */}
              <div>
                <h3 className="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                  <Mail className="w-5 h-5 text-indigo-600" />
                  Contact Information
                </h3>
                <div className="space-y-3">
                  {selectedAgent.email && (
                    <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                      <Mail className="w-5 h-5 text-slate-500" />
                      <div>
                        <p className="text-xs text-slate-500 dark:text-slate-400">Email</p>
                        <p className="font-semibold text-slate-900 dark:text-white">{selectedAgent.email}</p>
                      </div>
                    </div>
                  )}
                  {selectedAgent.phone && (
                    <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                      <Phone className="w-5 h-5 text-slate-500" />
                      <div>
                        <p className="text-xs text-slate-500 dark:text-slate-400">Phone</p>
                        <p className="font-semibold text-slate-900 dark:text-white">{selectedAgent.phone}</p>
                      </div>
                    </div>
                  )}
                  {selectedAgent.website && (
                    <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                      <Globe className="w-5 h-5 text-slate-500" />
                      <div>
                        <p className="text-xs text-slate-500 dark:text-slate-400">Website</p>
                        <a 
                          href={selectedAgent.website} 
                          target="_blank" 
                          rel="noopener noreferrer"
                          className="font-semibold text-indigo-600 hover:text-indigo-700"
                        >
                          {selectedAgent.website}
                        </a>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Brokerage Information */}
              {(selectedAgent.brokerage || selectedAgent.office_address) && (
                <div>
                  <h3 className="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                    <Building2 className="w-5 h-5 text-indigo-600" />
                    Brokerage Information
                  </h3>
                  <div className="space-y-3">
                    {selectedAgent.brokerage && (
                      <div className="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                        <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">Company</p>
                        <p className="font-semibold text-slate-900 dark:text-white">{selectedAgent.brokerage}</p>
                      </div>
                    )}
                    {selectedAgent.office_address && (
                      <div className="flex items-start gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                        <MapPin className="w-5 h-5 text-slate-500 flex-shrink-0 mt-0.5" />
                        <div>
                          <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">Office Address</p>
                          <p className="text-sm text-slate-900 dark:text-white">{selectedAgent.office_address}</p>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Bio */}
              {selectedAgent.bio && (
                <div>
                  <h3 className="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                    <Briefcase className="w-5 h-5 text-indigo-600" />
                    Professional Bio
                  </h3>
                  <div className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                    <p className="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">
                      {selectedAgent.bio}
                    </p>
                  </div>
                </div>
              )}

              {/* Certifications */}
              {selectedAgent.certifications && selectedAgent.certifications.length > 0 && (
                <div>
                  <h3 className="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                    <Award className="w-5 h-5 text-indigo-600" />
                    Certifications & Designations
                  </h3>
                  <div className="flex flex-wrap gap-2">
                    {selectedAgent.certifications.map((cert, idx) => (
                      <Badge key={idx} className="bg-gradient-to-r from-amber-500 to-orange-500 text-white">
                        <Star className="w-3 h-3 mr-1" />
                        {cert}
                      </Badge>
                    ))}
                  </div>
                </div>
              )}

              {/* Action Buttons */}
              <div className="flex gap-3 pt-4 border-t">
                <Button
                  onClick={() => handleAddToContacts(selectedAgent)}
                  className="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                >
                  <UserPlus className="w-4 h-4 mr-2" />
                  Add to Contacts
                </Button>
                <Button
                  variant="outline"
                  onClick={() => setShowDetailsModal(false)}
                >
                  Close
                </Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { Buyer } from "@/api/entities";
import { Property } from "@/api/entities";
import { InvokeLLM } from "@/api/integrations";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { 
  ArrowLeft, 
  Sparkles, 
  Heart,
  Home,
  Loader2,
  DollarSign,
  MapPin
} from "lucide-react";
import { toast } from "sonner";

export default function AIBuyerPropertyMatcher() {
  const navigate = useNavigate();
  const [buyers, setBuyers] = useState([]);
  const [properties, setProperties] = useState([]);
  const [matches, setMatches] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isMatching, setIsMatching] = useState(false);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [buyerData, propertyData] = await Promise.all([
        Buyer.list(),
        Property.list()
      ]);
      
      const activeBuyers = buyerData.filter(b => b.status === 'active');
      const activeProperties = propertyData.filter(p => p.status === 'active');
      
      setBuyers(activeBuyers);
      setProperties(activeProperties);
    } catch (error) {
      console.error("Error loading data:", error);
    }
    setIsLoading(false);
  };

  const matchBuyersWithProperties = async () => {
    setIsMatching(true);
    const allMatches = [];

    try {
      for (const buyer of buyers) {
        const buyerMatches = await findMatchesForBuyer(buyer);
        allMatches.push({
          buyer,
          matches: buyerMatches
        });
      }

      setMatches(allMatches);
      toast.success(`Matched ${allMatches.length} buyers with properties!`);
    } catch (error) {
      console.error("Error matching:", error);
      toast.error("Failed to complete matching");
    }
    setIsMatching(false);
  };

  const findMatchesForBuyer = async (buyer) => {
    try {
      // Filter properties that fit basic criteria
      const eligibleProperties = properties.filter(p => {
        const priceMatch = p.price >= (buyer.budget_min || 0) && p.price <= (buyer.budget_max || Infinity);
        const bedroomMatch = !buyer.min_bedrooms || p.bedrooms >= buyer.min_bedrooms;
        const bathroomMatch = !buyer.min_bathrooms || p.bathrooms >= buyer.min_bathrooms;
        const sqftMatch = !buyer.min_square_feet || p.square_feet >= buyer.min_square_feet;
        const typeMatch = !buyer.property_type_preference || 
                         buyer.property_type_preference === 'any' || 
                         p.property_type === buyer.property_type_preference;
        
        return priceMatch && bedroomMatch && bathroomMatch && sqftMatch && typeMatch;
      });

      if (eligibleProperties.length === 0) return [];

      // Use AI to score and rank matches
      const prompt = `You are a real estate matching expert. Score how well each property matches this buyer's preferences.

Buyer Profile:
- Name: ${buyer.first_name} ${buyer.last_name}
- Budget: $${buyer.budget_min?.toLocaleString()} - $${buyer.budget_max?.toLocaleString()}
- Preferred Locations: ${buyer.preferred_locations || 'Any'}
- Property Type: ${buyer.property_type_preference}
- Min Bedrooms: ${buyer.min_bedrooms || 'Any'}
- Min Bathrooms: ${buyer.min_bathrooms || 'Any'}
- Min Square Feet: ${buyer.min_square_feet || 'Any'}
- Must-Have Features: ${buyer.must_have_features || 'None specified'}
- Nice-to-Have Features: ${buyer.nice_to_have_features || 'None specified'}
- Timeline: ${buyer.timeline}

Properties to Score (provide match score 0-100 and reasoning for each):
${eligibleProperties.slice(0, 10).map((p, idx) => `
${idx + 1}. ${p.address}, ${p.city}
   - Price: $${p.price?.toLocaleString()}
   - Type: ${p.property_type}
   - Beds/Baths: ${p.bedrooms}/${p.bathrooms}
   - Sq Ft: ${p.square_feet}
   - Features: ${p.features || 'Standard'}
`).join('\n')}

For each property, return:
- property_index: number (1-${eligibleProperties.slice(0, 10).length})
- match_score: number (0-100)
- why_good_match: string (2-3 specific reasons)
- potential_concerns: string (any dealbreakers or concerns)
- recommendation: "excellent"|"good"|"fair"|"not_recommended"

Return as array of match objects.`;

      const response = await InvokeLLM({
        prompt,
        add_context_from_internet: false,
        response_json_schema: {
          type: "object",
          properties: {
            matches: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  property_index: { type: "number" },
                  match_score: { type: "number" },
                  why_good_match: { type: "string" },
                  potential_concerns: { type: "string" },
                  recommendation: { type: "string", enum: ["excellent", "good", "fair", "not_recommended"] }
                }
              }
            }
          }
        }
      });

      // Map scores back to properties
      const scoredMatches = response.matches
        .map(match => ({
          property: eligibleProperties[match.property_index - 1],
          ...match
        }))
        .filter(m => m.property && m.match_score >= 60) // Only show good matches
        .sort((a, b) => b.match_score - a.match_score)
        .slice(0, 5); // Top 5 matches

      return scoredMatches;
    } catch (error) {
      console.error("Error finding matches for buyer:", error);
      return [];
    }
  };

  const getRecommendationColor = (recommendation) => {
    const colors = {
      excellent: "bg-green-100 text-green-700 border-green-300",
      good: "bg-blue-100 text-blue-700 border-blue-300",
      fair: "bg-yellow-100 text-yellow-700 border-yellow-300",
      not_recommended: "bg-slate-100 text-slate-700 border-slate-300"
    };
    return colors[recommendation] || colors.fair;
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="p-4">
      <div className="space-y-6">
        {/* Header */}
        <div className="app-card p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(createPageUrl("Buyers"))}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <Heart className="w-6 h-6 text-pink-600" />
                <h1 className="app-title text-2xl">AI Buyer-Property Matcher</h1>
              </div>
              <p className="app-subtitle">
                {buyers.length} active buyers ‚Ä¢ {properties.length} active properties
              </p>
            </div>
            <Button 
              onClick={matchBuyersWithProperties}
              disabled={isMatching || buyers.length === 0 || properties.length === 0}
              className="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700"
            >
              {isMatching ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Matching...
                </>
              ) : (
                <>
                  <Sparkles className="w-4 h-4 mr-2" />
                  Match All Buyers
                </>
              )}
            </Button>
          </div>
        </div>

        {/* Matches */}
        <div className="space-y-6">
          {matches.length > 0 ? (
            matches.map(({ buyer, matches: buyerMatches }) => (
              <Card key={buyer.id}>
                <CardHeader className="bg-gradient-to-r from-slate-50 to-slate-100">
                  <div className="flex items-center justify-between">
                    <div>
                      <CardTitle className="text-xl">{buyer.first_name} {buyer.last_name}</CardTitle>
                      <div className="flex items-center gap-4 mt-2 text-sm text-slate-600">
                        <span className="flex items-center gap-1">
                          <DollarSign className="w-4 h-4" />
                          ${(buyer.budget_min / 1000000).toFixed(1)}M - ${(buyer.budget_max / 1000000).toFixed(1)}M
                        </span>
                        <span className="flex items-center gap-1">
                          <MapPin className="w-4 h-4" />
                          {buyer.preferred_locations || 'Any location'}
                        </span>
                        <span className="flex items-center gap-1">
                          <Home className="w-4 h-4" />
                          {buyer.min_bedrooms || 'Any'} beds
                        </span>
                      </div>
                    </div>
                    <Badge className="bg-indigo-100 text-indigo-700 text-lg px-4 py-2">
                      {buyerMatches.length} Matches
                    </Badge>
                  </div>
                </CardHeader>
                <CardContent className="p-6">
                  {buyerMatches.length > 0 ? (
                    <div className="space-y-4">
                      {buyerMatches.map((match, idx) => (
                        <div 
                          key={idx}
                          className="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                          onClick={() => navigate(createPageUrl(`PropertyDetail?id=${match.property.id}`))}
                        >
                          <div className="flex items-start justify-between mb-3">
                            <div className="flex-1">
                              <div className="flex items-center gap-3 mb-2">
                                <h4 className="font-bold text-lg text-slate-900">
                                  {match.property.address}
                                </h4>
                                <Badge className={getRecommendationColor(match.recommendation)}>
                                  {match.recommendation.replace('_', ' ').toUpperCase()}
                                </Badge>
                              </div>
                              <p className="text-sm text-slate-600">
                                {match.property.city}, {match.property.state}
                              </p>
                            </div>
                            <div className="text-right">
                              <div className="text-2xl font-bold text-indigo-600 mb-1">
                                {match.match_score}%
                              </div>
                              <div className="text-xs text-slate-500">Match Score</div>
                            </div>
                          </div>

                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 text-sm">
                            <div>
                              <span className="text-slate-500">Price:</span>
                              <div className="font-semibold">${(match.property.price / 1000000).toFixed(2)}M</div>
                            </div>
                            <div>
                              <span className="text-slate-500">Type:</span>
                              <div className="font-semibold">{match.property.property_type?.replace('_', ' ')}</div>
                            </div>
                            <div>
                              <span className="text-slate-500">Beds/Baths:</span>
                              <div className="font-semibold">{match.property.bedrooms}/{match.property.bathrooms}</div>
                            </div>
                            <div>
                              <span className="text-slate-500">Sq Ft:</span>
                              <div className="font-semibold">{match.property.square_feet?.toLocaleString()}</div>
                            </div>
                          </div>

                          <div className="space-y-2">
                            <div className="bg-green-50 border border-green-200 rounded p-3">
                              <div className="font-semibold text-green-900 text-sm mb-1">
                                Why It's a Great Match:
                              </div>
                              <p className="text-sm text-green-800">{match.why_good_match}</p>
                            </div>

                            {match.potential_concerns && (
                              <div className="bg-amber-50 border border-amber-200 rounded p-3">
                                <div className="font-semibold text-amber-900 text-sm mb-1">
                                  Potential Concerns:
                                </div>
                                <p className="text-sm text-amber-800">{match.potential_concerns}</p>
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-center py-8 text-slate-500">
                      No matching properties found for this buyer's criteria.
                    </p>
                  )}
                </CardContent>
              </Card>
            ))
          ) : (
            <Card>
              <CardContent className="p-12 text-center">
                <Heart className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                <h3 className="text-xl font-semibold text-slate-900 mb-2">No Matches Yet</h3>
                <p className="text-slate-500 mb-6">
                  Click "Match All Buyers" to find perfect property matches using AI
                </p>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
}


import React, { useState, useEffect } from "react";
import { Document } from "@/api/entities";
import { Transaction } from "@/api/entities";
import { Property } from "@/api/entities";
import { InvokeLLM } from "@/api/integrations";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { 
  ArrowLeft, 
  Sparkles, 
  FileText,
  Loader2,
  AlertTriangle,
  CheckCircle2,
  Clock,
  Search
} from "lucide-react";
import { toast } from "sonner";

export default function AIDocumentIntelligence() {
  const navigate = useNavigate();
  const [documents, setDocuments] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [properties, setProperties] = useState([]);
  const [analyzedDocs, setAnalyzedDocs] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [docData, transData, propData] = await Promise.all([
        Document.list("-created_date"),
        Transaction.list(),
        Property.list()
      ]);
      
      setDocuments(docData);
      setTransactions(transData);
      setProperties(propData);
    } catch (error) {
      console.error("Error loading data:", error);
    }
    setIsLoading(false);
  };

  const analyzeDocuments = async () => {
    setIsAnalyzing(true);
    const analyzed = [];

    try {
      for (const doc of documents.slice(0, 10)) { // Limit to 10 for demo
        const analysis = await analyzeDocument(doc);
        analyzed.push({ ...doc, ...analysis });
      }

      setAnalyzedDocs(analyzed);
      toast.success(`Analyzed ${analyzed.length} documents!`);
    } catch (error) {
      console.error("Error analyzing documents:", error);
      toast.error("Failed to analyze some documents");
    }
    setIsAnalyzing(false);
  };

  const analyzeDocument = async (doc) => {
    try {
      const transaction = transactions.find(t => t.id === doc.transaction_id);
      const property = properties.find(p => p.id === doc.property_id);

      const prompt = `Analyze this real estate document and extract key information.

Document Details:
- Name: ${doc.document_name}
- Type: ${doc.document_type}
- Status: ${doc.status}
- Requires Signature: ${doc.requires_signature ? 'Yes' : 'No'}
- Signed By: ${doc.signed_by || 'Not signed'}

${transaction ? `Transaction: ${transaction.transaction_type} - ${transaction.status}` : ''}
${property ? `Property: ${property.address}, ${property.city}` : ''}

Based on the document type and context, provide:

1. **Missing Information** - What critical information might be missing?
2. **Action Items** - What needs to be done with this document?
3. **Deadlines** - Are there any implied or explicit deadlines?
4. **Risk Assessment** - Any potential issues or red flags?
5. **Priority** - How urgent is this document? (critical/high/medium/low)
6. **Next Steps** - Specific next steps to move forward

Return as JSON with these keys:
- missing_info: array of strings
- action_items: array of strings
- deadlines: array of {description: string, date: string|null, urgency: string}
- risks: array of strings
- priority: "critical"|"high"|"medium"|"low"
- next_steps: array of strings
- summary: string (2-sentence summary)`;

      const response = await InvokeLLM({
        prompt,
        add_context_from_internet: false,
        response_json_schema: {
          type: "object",
          properties: {
            missing_info: { type: "array", items: { type: "string" } },
            action_items: { type: "array", items: { type: "string" } },
            deadlines: { 
              type: "array", 
              items: { 
                type: "object",
                properties: {
                  description: { type: "string" },
                  date: { type: "string" },
                  urgency: { type: "string" }
                }
              } 
            },
            risks: { type: "array", items: { type: "string" } },
            priority: { type: "string", enum: ["critical", "high", "medium", "low"] },
            next_steps: { type: "array", items: { type: "string" } },
            summary: { type: "string" }
          }
        }
      });

      return response;
    } catch (error) {
      console.error("Error analyzing document:", error);
      return {
        priority: "medium",
        summary: "Error during analysis"
      };
    }
  };

  const getPriorityColor = (priority) => {
    const colors = {
      critical: "bg-red-100 text-red-700 border-red-300",
      high: "bg-orange-100 text-orange-700 border-orange-300",
      medium: "bg-yellow-100 text-yellow-700 border-yellow-300",
      low: "bg-blue-100 text-blue-700 border-blue-300"
    };
    return colors[priority] || colors.medium;
  };

  const getPriorityIcon = (priority) => {
    if (priority === 'critical' || priority === 'high') return <AlertTriangle className="w-4 h-4" />;
    if (priority === 'medium') return <Clock className="w-4 h-4" />;
    return <CheckCircle2 className="w-4 h-4" />;
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="p-4">
      <div className="space-y-6">
      {/* Header */}
      <div className="app-card p-6">
        <div className="flex items-center gap-4">
          <Button
            variant="ghost"
            size="icon"
            onClick={() => navigate(createPageUrl("Documents"))}
            className="rounded-full"
          >
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-2">
              <Search className="w-6 h-6 text-indigo-600" />
              <h1 className="app-title text-2xl">AI Document Intelligence</h1>
            </div>
            <p className="app-subtitle">{documents.length} documents ready for analysis</p>
          </div>
          <Button 
            onClick={analyzeDocuments}
            disabled={isAnalyzing || documents.length === 0}
            className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
          >
            {isAnalyzing ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                Analyzing...
              </>
            ) : (
              <>
                <Sparkles className="w-4 h-4 mr-2" />
                Analyze Documents
              </>
            )}
          </Button>
        </div>
      </div>

      {/* Stats */}
      {analyzedDocs.length > 0 && (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-slate-600">Critical Priority</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-red-600">
                {analyzedDocs.filter(d => d.priority === 'critical').length}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-slate-600">High Priority</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-orange-600">
                {analyzedDocs.filter(d => d.priority === 'high').length}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-slate-600">Action Items</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-indigo-600">
                {analyzedDocs.reduce((sum, d) => sum + (d.action_items?.length || 0), 0)}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-slate-600">Deadlines</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-purple-600">
                {analyzedDocs.reduce((sum, d) => sum + (d.deadlines?.length || 0), 0)}
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Analyzed Documents */}
      <div className="space-y-4">
        {analyzedDocs.length > 0 ? (
          analyzedDocs
            .sort((a, b) => {
              const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
              return priorityOrder[a.priority] - priorityOrder[b.priority];
            })
            .map(doc => {
              const transaction = transactions.find(t => t.id === doc.transaction_id);
              const property = properties.find(p => p.id === doc.property_id);

              return (
                <Card key={doc.id} className="hover:shadow-lg transition-shadow">
                  <CardContent className="p-6">
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-2">
                          <FileText className="w-5 h-5 text-slate-600" />
                          <h3 className="text-xl font-bold text-slate-900">{doc.document_name}</h3>
                          <Badge className={`${getPriorityColor(doc.priority)} flex items-center gap-1`}>
                            {getPriorityIcon(doc.priority)}
                            {doc.priority.toUpperCase()}
                          </Badge>
                        </div>
                        <p className="text-sm text-slate-600 mb-2">{doc.summary}</p>
                        {property && (
                          <p className="text-xs text-slate-500">
                            Property: {property.address}, {property.city}
                          </p>
                        )}
                        {transaction && (
                          <p className="text-xs text-slate-500">
                            Transaction: {transaction.transaction_type} - {transaction.status}
                          </p>
                        )}
                      </div>
                    </div>

                    {/* Action Items */}
                    {doc.action_items && doc.action_items.length > 0 && (
                      <div className="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div className="font-semibold text-blue-900 text-sm mb-2 flex items-center gap-2">
                          <CheckCircle2 className="w-4 h-4" />
                          Action Items ({doc.action_items.length})
                        </div>
                        <ul className="list-disc list-inside text-sm text-blue-800 space-y-1">
                          {doc.action_items.map((item, idx) => (
                            <li key={idx}>{item}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* Deadlines */}
                    {doc.deadlines && doc.deadlines.length > 0 && (
                      <div className="mb-4 bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <div className="font-semibold text-purple-900 text-sm mb-2 flex items-center gap-2">
                          <Clock className="w-4 h-4" />
                          Deadlines ({doc.deadlines.length})
                        </div>
                        <div className="space-y-2">
                          {doc.deadlines.map((deadline, idx) => (
                            <div key={idx} className="text-sm text-purple-800">
                              <span className="font-medium">{deadline.description}</span>
                              {deadline.date && <span className="ml-2 text-purple-600">- {deadline.date}</span>}
                              {deadline.urgency && (
                                <Badge className="ml-2 text-xs">{deadline.urgency}</Badge>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Risks */}
                    {doc.risks && doc.risks.length > 0 && (
                      <div className="mb-4 bg-red-50 border border-red-200 rounded-lg p-3">
                        <div className="font-semibold text-red-900 text-sm mb-2 flex items-center gap-2">
                          <AlertTriangle className="w-4 h-4" />
                          Risks & Concerns ({doc.risks.length})
                        </div>
                        <ul className="list-disc list-inside text-sm text-red-800 space-y-1">
                          {doc.risks.map((risk, idx) => (
                            <li key={idx}>{risk}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* Missing Info */}
                    {doc.missing_info && doc.missing_info.length > 0 && (
                      <div className="mb-4 bg-amber-50 border border-amber-200 rounded-lg p-3">
                        <div className="font-semibold text-amber-900 text-sm mb-2 flex items-center gap-2">
                          <AlertTriangle className="w-4 h-4" />
                          Missing Information ({doc.missing_info.length})
                        </div>
                        <ul className="list-disc list-inside text-sm text-amber-800 space-y-1">
                          {doc.missing_info.map((info, idx) => (
                            <li key={idx}>{info}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* Next Steps */}
                    {doc.next_steps && doc.next_steps.length > 0 && (
                      <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                        <div className="font-semibold text-green-900 text-sm mb-2 flex items-center gap-2">
                          <Sparkles className="w-4 h-4" />
                          Recommended Next Steps
                        </div>
                        <ol className="list-decimal list-inside text-sm text-green-800 space-y-1">
                          {doc.next_steps.map((step, idx) => (
                            <li key={idx}>{step}</li>
                          ))}
                        </ol>
                      </div>
                    )}
                  </CardContent>
                </Card>
              );
            })
        ) : (
          <Card>
            <CardContent className="p-12 text-center">
              <Search className="w-16 h-16 mx-auto mb-4 text-slate-300" />
              <h3 className="text-xl font-semibold text-slate-900 mb-2">No Analysis Yet</h3>
              <p className="text-slate-500 mb-6">
                Click "Analyze Documents" to extract key information and insights
              </p>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
    </div>
  );
}


import React, { useState, useEffect, useMemo } from "react";
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { useNavigate, useLocation } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { ArrowLeft, Sparkles, Mail, Send, Loader2, Copy } from "lucide-react";
import { toast } from "sonner";

export default function AIEmailAssistant() {
  const navigate = useNavigate();
  const location = useLocation();
  const queryClient = useQueryClient(); // Initialize useQueryClient

  const [leads, setLeads] = useState([]);
  const [contacts, setContacts] = useState([]);
  const [properties, setProperties] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isSending, setIsSending] = useState(false);

  const [selectedRecipient, setSelectedRecipient] = useState("");
  const [recipientType, setRecipientType] = useState("lead");
  const [selectedProperty, setSelectedProperty] = useState("");
  const [emailType, setEmailType] = useState("follow_up");
  const [tone, setTone] = useState("professional");
  const [context, setContext] = useState("");
  const [generatedSubject, setGeneratedSubject] = useState("");
  const [generatedBody, setGeneratedBody] = useState("");

  const taskId = useMemo(() => {
      const params = new URLSearchParams(location.search);
      return params.get('taskId');
  }, [location.search]);

  const { data: taskFromUrl, isLoading: isLoadingTask } = useQuery({
      queryKey: ['task', taskId],
      queryFn: () => base44.entities.Task.get(taskId),
      enabled: !!taskId,
  });

  useEffect(() => {
    loadData();
  }, []);

  useEffect(() => {
    if (taskFromUrl && contacts.length > 0 && leads.length > 0) {
        if (taskFromUrl.contact_id) {
            setRecipientType("contact");
            setSelectedRecipient(taskFromUrl.contact_id);
        } else if (taskFromUrl.lead_id) {
            setRecipientType("lead");
            setSelectedRecipient(taskFromUrl.lead_id);
        }
        
        if (taskFromUrl.task_type) {
            const soiTypeMap = {
                'soi_newsletter': 'market_update',
                'soi_home_anniversary': 'thank_you',
                'soi_check_in': 'check_in',
            };
            if (soiTypeMap[taskFromUrl.task_type]) {
                setEmailType(soiTypeMap[taskFromUrl.task_type]);
            }
        }
        if (taskFromUrl.property_id) {
            setSelectedProperty(taskFromUrl.property_id);
        }
        // Automatically trigger generation if recipient is set
        if (taskFromUrl.contact_id || taskFromUrl.lead_id) {
            generateEmail({ prefilledTask: taskFromUrl });
        }
    }
  }, [taskFromUrl, contacts, leads]);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [user, leadData, propertyData, contactData] = await Promise.all([
        base44.auth.me(),
        base44.entities.Lead.list(),
        base44.entities.Property.list(),
        base44.entities.Contact.list(),
      ]);
      
      setCurrentUser(user);
      setLeads(leadData.filter(l => l.status !== 'lost' && l.status !== 'converted'));
      setProperties(propertyData.filter(p => p.status === 'active'));
      setContacts(contactData);
    } catch (error) {
      console.error("Error loading data:", error);
      toast.error("Failed to load initial data.");
    }
    setIsLoading(false);
  };

  const allRecipients = useMemo(() => {
      return [
          ...leads.map(l => ({ id: l.id, name: l.name, type: 'lead', email: l.email, info: l })),
          ...contacts.map(c => ({ id: c.id, name: c.full_name || c.name, type: 'contact', email: c.email, info: c })),
      ]
  }, [leads, contacts]);

  const generateEmail = async ({ prefilledTask } = {}) => {
    const task = prefilledTask || taskFromUrl;
    
    let recipient, recipientIsContact;

    if (task) {
        if (task.contact_id) {
            recipient = contacts.find(c => c.id === task.contact_id);
            recipientIsContact = true;
        } else if (task.lead_id) {
            recipient = leads.find(l => l.id === task.lead_id);
            recipientIsContact = false;
        }
    } else {
        const foundRecipient = allRecipients.find(r => r.id === selectedRecipient);
        recipient = foundRecipient?.info;
        recipientIsContact = foundRecipient?.type === 'contact';
    }

    if (!recipient) {
      toast.error("Please select a recipient");
      return;
    }
    
    const currentSelectedProperty = task?.property_id || selectedProperty;
    const property = properties.find(p => p.id === currentSelectedProperty);

    setIsGenerating(true);
    try {
      const emailTypeDescriptions = {
        follow_up: "following up after initial contact",
        property_recommendation: "recommending a specific property",
        open_house_invitation: "inviting to an open house",
        price_reduction: "announcing a price reduction",
        market_update: "providing market update and insights",
        check_in: "checking in on their home search",
        thank_you: "thanking them for their time",
        response: "responding to their inquiry"
      };

      const toneDescriptions = {
        professional: "professional and courteous",
        friendly: "warm, friendly, and personable",
        enthusiastic: "excited and enthusiastic",
        sophisticated: "refined and sophisticated",
        urgent: "creating a sense of urgency",
        casual: "casual and conversational"
      };

      let prompt;

      if (recipientIsContact) {
        prompt = `Generate a compelling real estate email for this scenario:

Email Type: ${emailTypeDescriptions[emailType]}
Tone: ${toneDescriptions[tone]}

Contact Information:
- Name: ${recipient.full_name || recipient.name}
- Relationship: ${recipient.relationship || 'Not specified'}
- Last Contact: ${recipient.last_contact_date ? new Date(recipient.last_contact_date).toLocaleDateString() : 'Never'}
- Notes: ${recipient.notes || 'No notes available.'}

${property ? `Property Details:
- Address: ${property.address}, ${property.city}
- Price: $${property.price?.toLocaleString()}
- Type: ${property.property_type?.replace('_', ' ')}
- Beds/Baths: ${property.bedrooms}/${property.bathrooms}
- Features: ${property.features || 'Standard features'}` : ''}

${context ? `Additional Context: ${context}` : ''}

Agent: ${currentUser?.full_name || 'Real Estate Agent'}

Create a personalized email that:
1. Addresses the contact by name
2. References their relationship or relevant notes (if available)
3. ${property ? 'Highlights why this property might be of interest to them' : 'Provides value and nurtures the relationship'}
4. Includes a clear call-to-action
5. Maintains the specified tone
6. Is concise yet impactful (2-4 paragraphs)
7. Professional email signature

Return as JSON with:
- subject: email subject line (compelling and specific)
- body: email body content (HTML formatted with proper paragraphs and spacing)`;
      } else {
        prompt = `Generate a compelling real estate email for this scenario:

Email Type: ${emailTypeDescriptions[emailType]}
Tone: ${toneDescriptions[tone]}

Lead Information:
- Name: ${recipient.name}
- Interest: ${recipient.interest_type}
- Budget: $${recipient.budget_min?.toLocaleString()} - $${recipient.budget_max?.toLocaleString()}
- Timeline: ${recipient.timeline}
- Preferred Areas: ${recipient.preferred_areas || 'Not specified'}
- Status: ${recipient.status}

${property ? `Property Details:
- Address: ${property.address}, ${property.city}
- Price: $${property.price?.toLocaleString()}
- Type: ${property.property_type?.replace('_', ' ')}
- Beds/Baths: ${property.bedrooms}/${property.bathrooms}
- Features: ${property.features || 'Standard features'}` : ''}

${context ? `Additional Context: ${context}` : ''}

Agent: ${currentUser?.full_name || 'Real Estate Agent'}

Create a personalized email that:
1. Addresses the lead by name
2. References their specific needs and preferences
3. ${property ? 'Highlights why this property is perfect for them' : 'Provides value and moves the relationship forward'}
4. Includes a clear call-to-action
5. Maintains the specified tone
6. Is concise yet impactful (2-4 paragraphs)
7. Professional email signature

Return as JSON with:
- subject: email subject line (compelling and specific)
- body: email body content (HTML formatted with proper paragraphs and spacing)`;
      }

      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        add_context_from_internet: false,
        response_json_schema: {
          type: "object",
          properties: {
            subject: { type: "string" },
            body: { type: "string" }
          }
        }
      });

      setGeneratedSubject(response.subject);
      setGeneratedBody(response.body);
      toast.success("Email generated successfully!");
    } catch (error) {
      console.error("Error generating email:", error);
      toast.error("Failed to generate email");
    }
    setIsGenerating(false);
  };

  const sendEmail = async () => {
    const currentRecipient = allRecipients.find(r => r.id === selectedRecipient);
    
    if (!currentRecipient || !generatedSubject || !generatedBody) {
      toast.error("Missing required information or generated email content");
      return;
    }

    setIsSending(true);
    try {
      await base44.integrations.Core.SendEmail({
        to: currentRecipient.email,
        subject: generatedSubject,
        body: generatedBody,
        from_name: currentUser?.full_name || 'PropertySync CRM'
      });

      const updatePayload = { last_contact: new Date().toISOString() };
      if (currentRecipient.type === 'lead') {
          updatePayload.email_opens = (currentRecipient.info.email_opens || 0) + 1;
          await base44.entities.Lead.update(currentRecipient.id, updatePayload);
      } else {
          await base44.entities.Contact.update(currentRecipient.id, { last_contact_date: new Date().toISOString() });
      }

      if (taskId) {
          await base44.entities.Task.update(taskId, { status: 'completed', completed_date: new Date().toISOString() });
          queryClient.invalidateQueries({ queryKey: ['tasks'] });
          queryClient.invalidateQueries({ queryKey: ['soiTasks'] });
      }

      toast.success(`Email sent to ${currentRecipient.name}!`);
      
      // Clear form
      setGeneratedSubject("");
      setGeneratedBody("");
      setContext("");
      if (!taskId) {
        setSelectedRecipient("");
        setEmailType("follow_up");
        setRecipientType("lead");
      }
      setSelectedProperty("");
      setTone("professional");
    } catch (error) {
      console.error("Error sending email:", error);
      toast.error("Failed to send email");
    }
    setIsSending(false);
  };

  const copyToClipboard = () => {
    const emailText = `Subject: ${generatedSubject}\n\n${generatedBody}`;
    navigator.clipboard.writeText(emailText);
    toast.success("Email copied to clipboard!");
  };

  if (isLoading || (taskId && isLoadingTask)) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="p-4 sm:p-6 lg:p-8">
      <div className="space-y-6 max-w-7xl mx-auto">
        {/* Header */}
        <div className="app-card p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(createPageUrl("Dashboard"))}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <Mail className="w-6 h-6 text-indigo-600" />
                <h1 className="app-title text-2xl">AI Email Assistant</h1>
              </div>
              <p className="app-subtitle">Generate personalized emails with AI</p>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Controls */}
          <div className="lg:col-span-1 space-y-4">
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Email Configuration</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                 <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">
                    Recipient Type
                  </label>
                  <Select value={recipientType} onValueChange={setRecipientType} disabled={!!taskId}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="lead">Lead</SelectItem>
                      <SelectItem value="contact">Contact (SOI)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                
                <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">
                    Recipient *
                  </label>
                  <Select value={selectedRecipient} onValueChange={setSelectedRecipient} disabled={!!taskId}>
                    <SelectTrigger>
                      <SelectValue placeholder="Select a recipient" />
                    </SelectTrigger>
                    <SelectContent>
                      {allRecipients
                        .filter(rec => rec.type === recipientType)
                        .map(rec => (
                          <SelectItem key={rec.id} value={rec.id}>
                            {rec.name}
                          </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">
                    Email Type
                  </label>
                  <Select value={emailType} onValueChange={setEmailType} disabled={!!taskId}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="follow_up">Follow Up</SelectItem>
                      <SelectItem value="property_recommendation">Property Recommendation</SelectItem>
                      <SelectItem value="open_house_invitation">Open House Invitation</SelectItem>
                      <SelectItem value="price_reduction">Price Reduction Alert</SelectItem>
                      <SelectItem value="market_update">Market Update</SelectItem>
                      <SelectItem value="check_in">Check-In</SelectItem>
                      <SelectItem value="thank_you">Thank You</SelectItem>
                      <SelectItem value="response">Response to Inquiry</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">
                    Related Property (Optional)
                  </label>
                  <Select value={selectedProperty} onValueChange={setSelectedProperty} disabled={!!taskId}>
                    <SelectTrigger>
                      <SelectValue placeholder="None" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value={null}>None</SelectItem>
                      {properties.map(prop => (
                        <SelectItem key={prop.id} value={prop.id}>
                          {prop.address} - ${(prop.price / 1000000).toFixed(1)}M
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">
                    Tone
                  </label>
                  <Select value={tone} onValueChange={setTone}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="professional">Professional</SelectItem>
                      <SelectItem value="friendly">Friendly</SelectItem>
                      <SelectItem value="enthusiastic">Enthusiastic</SelectItem>
                      <SelectItem value="sophisticated">Sophisticated</SelectItem>
                      <SelectItem value="urgent">Urgent</SelectItem>
                      <SelectItem value="casual">Casual</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">
                    Additional Context (Optional)
                  </label>
                  <Textarea
                    value={context}
                    onChange={(e) => setContext(e.target.value)}
                    placeholder="E.g., 'They mentioned they need to move by June' or 'Prefer properties with a pool'"
                    rows={3}
                  />
                </div>

                <Button 
                  onClick={() => generateEmail()}
                  disabled={isGenerating || !selectedRecipient}
                  className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                >
                  {isGenerating ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Generating...
                    </>
                  ) : (
                    <>
                      <Sparkles className="w-4 h-4 mr-2" />
                      Generate Email
                    </>
                  )}
                </Button>

                {generatedBody && (
                  <div className="space-y-2">
                    <Button 
                      onClick={copyToClipboard}
                      variant="outline"
                      className="w-full"
                    >
                      <Copy className="w-4 h-4 mr-2" />
                      Copy to Clipboard
                    </Button>
                    <Button 
                      onClick={sendEmail}
                      disabled={isSending}
                      className="w-full bg-green-600 hover:bg-green-700 text-white"
                    >
                      {isSending ? (
                        <>
                          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                          Sending...
                        </>
                      ) : (
                        <>
                          <Send className="w-4 h-4 mr-2" />
                          Send Email
                        </>
                      )}
                    </Button>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>

          {/* Generated Email Preview */}
          <div className="lg:col-span-2 space-y-4">
            {generatedSubject && (
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg">Subject Line</CardTitle>
                </CardHeader>
                <CardContent>
                  <Input
                    value={generatedSubject}
                    onChange={(e) => setGeneratedSubject(e.target.value)}
                    className="text-base font-semibold"
                  />
                </CardContent>
              </Card>
            )}

            <Card className="flex-1">
              <CardHeader>
                <CardTitle className="text-lg">Email Body</CardTitle>
              </CardHeader>
              <CardContent>
                <Textarea
                  value={generatedBody}
                  onChange={(e) => setGeneratedBody(e.target.value)}
                  placeholder="Click 'Generate Email' to create AI-powered personalized email..."
                  className="min-h-[500px] text-base leading-relaxed font-sans"
                />
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import LoadingSpinner from "../components/common/LoadingSpinner";
import {
  Brain,
  TrendingUp,
  Target,
  MessageSquare,
  DollarSign,
  AlertTriangle,
  CheckCircle2,
  Clock,
  ArrowRight,
  Sparkles,
  RefreshCw,
  Eye,
  ThumbsUp,
  X
} from "lucide-react";
import { toast } from "sonner";

export default function AIInsights() {
  const navigate = useNavigate();
  const [insights, setInsights] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [filter, setFilter] = useState("all");
  const [isGenerating, setIsGenerating] = useState(false);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const currentUser = await base44.auth.me();
      setUser(currentUser);

      if (currentUser?.id) {
          const insightsData = await base44.entities.AIInsight.filter({
            user_id: currentUser.id
          }, "-created_date");
          setInsights(insightsData || []);
      } else {
          setInsights([]);
      }
    } catch (error) {
      console.error("Error loading insights:", error);
    }
    setIsLoading(false);
  };

  const generateNewInsights = async () => {
    setIsGenerating(true);
    try {
      if (!user) {
        console.error("User not loaded, cannot generate insights.");
        toast.error("Could not verify user. Please try again.");
        setIsGenerating(false);
        return;
      }

      // Generate insights sequentially to avoid database timeouts
      toast.info("Generating market predictions...");
      await generateMarketPredictions();
      
      toast.info("Generating follow-up suggestions...");
      await generateFollowUpSuggestions();
      
      toast.info("Analyzing task priorities...");
      await generateTaskPrioritization();
      
      toast.info("Analyzing message sentiment...");
      await generateSentimentAnalysis();
      
      toast.success("New insights have been generated!");
      await loadData(); // Reload all insights at the end
    } catch (error) {
      console.error("Error generating insights:", error);
      toast.error("An error occurred while generating insights. The operation may have partially completed.");
    }
    setIsGenerating(false);
  };

  const generateMarketPredictions = async () => {
    try {
      // Optimized: Aggressively reduce limits and add time filter to query
      const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString();
      const [properties, transactions] = await Promise.all([
        base44.entities.Property.filter({ status: 'active' }, '-created_date', 50),
        base44.entities.Transaction.filter(
          { status: 'closed', updated_date: { '$gte': ninetyDaysAgo } }, 
          '-updated_date', 
          50
        )
      ]);

      const activeProperties = properties; // Already filtered
      const recentSales = transactions; // Already filtered by status and date

      const avgSalePrice = recentSales.length > 0 
        ? recentSales.reduce((sum, t) => sum + (t.contract_price || 0), 0) / recentSales.length
        : 0;

      const avgDOM = activeProperties.length > 0
        ? activeProperties.reduce((sum, p) => sum + (p.days_on_market || 0), 0) / activeProperties.length
        : 0;

      const prompt = `Analyze this real estate market data and provide 3 actionable predictions:

Active Listings: ${activeProperties.length}
Recent Sales (90 days): ${recentSales.length}
Average Sale Price: $${Math.round(avgSalePrice).toLocaleString()}
Average Days on Market: ${Math.round(avgDOM)}

Provide a JSON response with an array of 3 predictions. Each prediction should have:
1. title: Clear, specific title (e.g., "Market Heating Up - List Now")
2. description: Detailed explanation (2-3 sentences)
3. confidence: Confidence score (60-95)
4. action_items: Array of 2-3 specific action steps`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            predictions: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  title: { type: "string" },
                  description: { type: "string" },
                  confidence: { type: "number", minimum: 60, maximum: 95 },
                  action_items: { type: "array", items: { type: "string" } }
                },
                required: ["title", "description", "confidence", "action_items"]
              }
            }
          },
          required: ["predictions"]
        }
      });

      // Validate response
      if (!response || !response.predictions || !Array.isArray(response.predictions)) {
        console.error("Invalid AI response for market predictions:", response);
        return;
      }

      // Save predictions as insights
      for (const pred of response.predictions) {
        if (!pred.title || !pred.description) {
          console.error("Skipping invalid prediction due to missing title or description:", pred);
          continue;
        }

        await base44.entities.AIInsight.create({
          insight_type: "market_prediction",
          entity_type: "general",
          title: pred.title,
          description: pred.description,
          confidence_score: pred.confidence || 75,
          action_items: pred.action_items || [],
          priority: pred.confidence > 80 ? "high" : "medium",
          user_id: user.id
        });
      }
    } catch (error) {
      console.error("Error generating market predictions:", error);
      // Don't throw, allow other insights to generate
    }
  };

  const generateFollowUpSuggestions = async () => {
    try {
        // Optimized: Aggressively reduce limits for leads and activities
        const [leads, leadActivities] = await Promise.all([
            base44.entities.Lead.filter({ status: { '$nin': ['converted', 'lost'] } }, '-created_date', 30), // Reduced from 50 to 30
            base44.entities.LeadActivity.list('-created_date', 100) // Reduced from 250 to 100
        ]);

        const lastContactMap = new Map();
        for (const activity of leadActivities) {
            // Assuming activities are ordered by created_date descending,
            // so the first one we encounter for a lead is its most recent activity.
            if (!lastContactMap.has(activity.lead_id)) {
                lastContactMap.set(activity.lead_id, new Date(activity.created_date));
            }
        }

      const activeLeads = leads; // Already filtered

      for (const lead of activeLeads.slice(0, 3)) { // Further reduce processing to top 3
        const lastContactDate = lastContactMap.get(lead.id);
        const daysSinceContact = lastContactDate 
          ? (Date.now() - lastContactDate.getTime()) / (1000 * 60 * 60 * 24)
          : 999;

        if (daysSinceContact > 7) {
          try {
            const prompt = `Generate a personalized follow-up strategy for this lead:

Name: ${lead.name}
Status: ${lead.status}
Score: ${lead.score || 'N/A'}
Interest: ${lead.interest_type || 'N/A'}
Days Since Last Contact: ${Math.floor(daysSinceContact)}
Budget: $${lead.budget_min || 0}-$${lead.budget_max || 0}

Provide a JSON response with:
1. title: A clear, actionable title (e.g., "Follow up with John - High Priority Buyer")
2. approach: Detailed strategy description (2-3 sentences)
3. message_suggestions: Array of 2-3 specific message templates
4. timing: Best time to reach out (e.g., "Tomorrow morning" or "This afternoon")
5. priority: Either "high", "medium", or "low"`;

            const response = await base44.integrations.Core.InvokeLLM({
              prompt,
              response_json_schema: {
                type: "object",
                properties: {
                  title: { type: "string" },
                  approach: { type: "string" },
                  message_suggestions: { type: "array", items: { type: "string" } },
                  timing: { type: "string" },
                  priority: { type: "string", enum: ["high", "medium", "low"] }
                },
                required: ["title", "approach", "message_suggestions", "timing", "priority"]
              }
            });

            // Validate response has required fields
            if (!response || !response.title || !response.approach) {
              console.error("Invalid AI response for lead:", lead.id, response);
              continue; // Continue with next lead instead of failing completely
            }

            await base44.entities.AIInsight.create({
              insight_type: "follow_up_suggestion",
              entity_type: "lead",
              entity_id: lead.id,
              title: response.title,
              description: response.approach,
              action_items: response.message_suggestions || [],
              priority: response.priority || "medium",
              confidence_score: lead.score || 50,
              user_id: user.id
            });
          } catch (leadError) {
            console.error(`Error processing lead ${lead.id}:`, leadError);
            // Continue with next lead instead of failing completely
            continue;
          }
        }
      }
    } catch (error) {
      console.error("Error generating follow-up suggestions:", error);
      // Don't throw, allow other insights to generate
    }
  };

  const generateTaskPrioritization = async () => {
    try {
      // Optimized: Aggressively reduce limit for pending tasks
      const pendingTasks = await base44.entities.Task.filter({ status: { '$ne': 'completed' } }, '-created_date', 50); // Reduced from 100 to 50
      
      if (pendingTasks.length === 0) {
        console.log("No pending tasks to prioritize");
        return;
      }

      const prompt = `Analyze these ${pendingTasks.length} pending tasks and suggest smart prioritization:

Tasks by Priority:
- Critical: ${pendingTasks.filter(t => t.priority === 'critical').length}
- High: ${pendingTasks.filter(t => t.priority === 'high').length}
- Medium: ${pendingTasks.filter(t => t.priority === 'medium').length}
- Low: ${pendingTasks.filter(t => t.priority === 'low').length}

Overdue Tasks: ${pendingTasks.filter(t => t.due_date && new Date(t.due_date) < new Date()).length}

Provide a JSON response with:
1. title: Clear title for the prioritization insight
2. recommendations: Detailed prioritization strategy (2-3 sentences)
3. today_tasks: Array of 2-4 specific task recommendations for today
4. defer_tasks: Array of 1-2 tasks that can be postponed`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        response_json_schema: {
          type: "object",
          properties: {
            title: { type: "string" },
            recommendations: { type: "string" },
            today_tasks: { type: "array", items: { type: "string" } },
            defer_tasks: { type: "array", items: { type: "string" } }
          },
          required: ["title", "recommendations", "today_tasks"]
        }
      });

      // Validate response
      if (!response || !response.title || !response.recommendations) {
        console.error("Invalid AI response for task prioritization:", response);
        return;
      }

      await base44.entities.AIInsight.create({
        insight_type: "task_priority",
        entity_type: "general",
        title: response.title,
        description: response.recommendations,
        action_items: response.today_tasks || [],
        priority: "high",
        confidence_score: 85,
        user_id: user.id
      });
    } catch (error) {
      console.error("Error generating task prioritization:", error);
      // Don't throw, allow other insights to generate
    }
  };

  const generateSentimentAnalysis = async () => {
    try {
      // Optimized: Aggressively reduce limit for messages
      const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
      const recentMessages = await base44.entities.Message.filter(
        { created_date: { '$gte': sevenDaysAgo.toISOString() } },
        '-created_date',
        30 // Reduced from 50 to 30
      );

      if (recentMessages.length === 0) {
        console.log("No recent messages to analyze");
        return;
      }

      const prompt = `Analyze the sentiment and communication patterns in these recent messages:

Total Messages (7 days): ${recentMessages.length}

Sample messages:
${recentMessages.slice(0, 5).map(m => `- "${m.content?.substring(0, 100) || 'No content'}..."`).join('\n')}

Provide a JSON response with:
1. sentiment: Overall sentiment as "Positive", "Neutral", or "Negative"
2. score: Communication quality score (0-100)
3. insights: Detailed analysis paragraph (2-3 sentences)
4. improvements: Array of 2-3 specific actionable improvements`;

      const response = await base44.integrations.Core.InvokeLLM({
        prompt,
        response_json_schema: {
          type: "object",
          properties: {
            sentiment: { type: "string", enum: ["Positive", "Neutral", "Negative"] },
            score: { type: "number", minimum: 0, maximum: 100 },
            insights: { type: "string" },
            improvements: { type: "array", items: { type: "string" } }
          },
          required: ["sentiment", "score", "insights", "improvements"]
        }
      });

      // Validate response
      if (!response || !response.sentiment || !response.insights) {
        console.error("Invalid AI response for sentiment analysis:", response);
        return;
      }

      await base44.entities.AIInsight.create({
        insight_type: "sentiment_analysis",
        entity_type: "general",
        title: `Communication Sentiment: ${response.sentiment}`,
        description: response.insights,
        confidence_score: response.score || 70,
        action_items: response.improvements || [],
        priority: response.sentiment === 'Negative' ? "high" : "medium",
        user_id: user.id
      });
    } catch (error) {
      console.error("Error generating sentiment analysis:", error);
      // Don't throw, allow other insights to generate
    }
  };

  const handleInsightAction = async (insight, action) => {
    try {
      if (action === 'viewed') {
        await base44.entities.AIInsight.update(insight.id, { status: 'viewed' });
      } else if (action === 'acted_on') {
        await base44.entities.AIInsight.update(insight.id, { status: 'acted_on' });
      } else if (action === 'dismissed') {
        await base44.entities.AIInsight.update(insight.id, { status: 'dismissed' });
      }
      await loadData();
    } catch (error) {
      console.error("Error updating insight:", error);
    }
  };

  const getInsightIcon = (type) => {
    switch (type) {
      case 'market_prediction': return TrendingUp;
      case 'follow_up_suggestion': return Target;
      case 'task_priority': return CheckCircle2;
      case 'sentiment_analysis': return MessageSquare;
      case 'pricing_recommendation': return DollarSign;
      default: return Brain;
    }
  };

  const getPriorityColor = (priority) => {
    switch (priority) {
      case 'critical': return 'bg-red-100 text-red-700 border-red-300';
      case 'high': return 'bg-orange-100 text-orange-700 border-orange-300';
      case 'medium': return 'bg-yellow-100 text-yellow-700 border-yellow-300';
      case 'low': return 'bg-blue-100 text-blue-700 border-blue-300';
      default: return 'bg-gray-100 text-gray-700 border-gray-300';
    }
  };

  const filteredInsights = filter === 'all' 
    ? insights 
    : insights.filter(i => i.insight_type === filter);

  const newInsights = insights.filter(i => i.status === 'new').length;

  if (isLoading) {
    return <LoadingSpinner icon={Brain} title="Loading AI Insights..." description="Loading AI-powered recommendations" />;
  }

  return (
    <div className="page-container">
      <div className="space-y-4">
        {/* Header */}
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
                  <Brain className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h1 className="text-2xl font-bold text-slate-900 dark:text-white">AI Insights</h1>
                  <p className="text-sm text-slate-600 dark:text-slate-400">
                    AI-powered recommendations and predictions
                  </p>
                </div>
                {newInsights > 0 && (
                  <Badge className="bg-red-500 text-white">
                    {newInsights} New
                  </Badge>
                )}
              </div>
              <Button
                onClick={generateNewInsights}
                disabled={isGenerating}
                className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white"
              >
                {isGenerating ? (
                  <>
                    <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-4 h-4 mr-2" />
                    Generate New Insights
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Stats */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <Card>
            <CardContent className="p-4 text-center">
              <TrendingUp className="w-8 h-8 mx-auto mb-2 text-blue-600" />
              <p className="text-2xl font-bold">
                {insights.filter(i => i.insight_type === 'market_prediction').length}
              </p>
              <p className="text-xs text-slate-600">Market Predictions</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <Target className="w-8 h-8 mx-auto mb-2 text-orange-600" />
              <p className="text-2xl font-bold">
                {insights.filter(i => i.insight_type === 'follow_up_suggestion').length}
              </p>
              <p className="text-xs text-slate-600">Follow-up Suggestions</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <CheckCircle2 className="w-8 h-8 mx-auto mb-2 text-green-600" />
              <p className="text-2xl font-bold">
                {insights.filter(i => i.insight_type === 'task_priority').length}
              </p>
              <p className="text-xs text-slate-600">Task Priorities</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <MessageSquare className="w-8 h-8 mx-auto mb-2 text-purple-600" />
              <p className="text-2xl font-bold">
                {insights.filter(i => i.insight_type === 'sentiment_analysis').length}
              </p>
              <p className="text-xs text-slate-600">Sentiment Analysis</p>
            </CardContent>
          </Card>
        </div>

        {/* Filters */}
        <Card>
          <CardContent className="p-4">
            <div className="flex gap-2 flex-wrap">
              <Button
                variant={filter === 'all' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setFilter('all')}
              >
                All Insights
              </Button>
              <Button
                variant={filter === 'market_prediction' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setFilter('market_prediction')}
              >
                Market Predictions
              </Button>
              <Button
                variant={filter === 'follow_up_suggestion' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setFilter('follow_up_suggestion')}
              >
                Follow-ups
              </Button>
              <Button
                variant={filter === 'task_priority' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setFilter('task_priority')}
              >
                Task Priority
              </Button>
              <Button
                variant={filter === 'sentiment_analysis' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setFilter('sentiment_analysis')}
              >
                Sentiment
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Insights List */}
        <div className="space-y-4">
          {filteredInsights.length > 0 ? (
            filteredInsights.map((insight) => {
              const Icon = getInsightIcon(insight.insight_type);
              return (
                <Card key={insight.id} className={`border-l-4 ${
                  insight.status === 'new' ? 'border-l-indigo-500 bg-indigo-50/50' : 'border-l-slate-300'
                }`}>
                  <CardContent className="p-6">
                    <div className="flex items-start gap-4">
                      <div className={`w-12 h-12 rounded-lg flex items-center justify-center ${getPriorityColor(insight.priority)}`}>
                        <Icon className="w-6 h-6" />
                      </div>
                      
                      <div className="flex-1">
                        <div className="flex items-start justify-between mb-2">
                          <div>
                            <h3 className="font-semibold text-lg text-slate-900 dark:text-white">
                              {insight.title}
                            </h3>
                            <div className="flex items-center gap-2 mt-1">
                              <Badge variant="outline" className={getPriorityColor(insight.priority)}>
                                {insight.priority}
                              </Badge>
                              <Badge variant="outline">
                                {insight.confidence_score}% confidence
                              </Badge>
                              {insight.status === 'new' && (
                                <Badge className="bg-indigo-600 text-white">New</Badge>
                              )}
                            </div>
                          </div>
                        </div>

                        <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                          {insight.description}
                        </p>

                        {insight.action_items && insight.action_items.length > 0 && (
                          <div className="mb-4">
                            <p className="text-xs font-semibold text-slate-700 dark:text-slate-300 mb-2">
                              Recommended Actions:
                            </p>
                            <ul className="space-y-1">
                              {insight.action_items.map((action, idx) => (
                                <li key={idx} className="text-sm text-slate-600 dark:text-slate-400 flex items-start gap-2">
                                  <ArrowRight className="w-4 h-4 mt-0.5 flex-shrink-0 text-indigo-600" />
                                  {action}
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}

                        {insight.confidence_score && (
                          <div className="mb-4">
                            <div className="flex items-center justify-between text-xs mb-1">
                              <span className="text-slate-600">AI Confidence</span>
                              <span className="font-semibold">{insight.confidence_score}%</span>
                            </div>
                            <Progress value={insight.confidence_score} className="h-2" />
                          </div>
                        )}

                        <div className="flex gap-2">
                          {insight.status === 'new' && (
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => handleInsightAction(insight, 'viewed')}
                            >
                              <Eye className="w-4 h-4 mr-1" />
                              Mark as Viewed
                            </Button>
                          )}
                          {insight.status !== 'acted_on' && (
                            <Button
                              size="sm"
                              onClick={() => handleInsightAction(insight, 'acted_on')}
                              className="bg-green-600 text-white hover:bg-green-700"
                            >
                              <ThumbsUp className="w-4 h-4 mr-1" />
                              Acted On
                            </Button>
                          )}
                          <Button
                            size="sm"
                            variant="ghost"
                            onClick={() => handleInsightAction(insight, 'dismissed')}
                          >
                            <X className="w-4 h-4 mr-1" />
                            Dismiss
                          </Button>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              );
            })
          ) : (
            <Card>
              <CardContent className="p-12 text-center">
                <Brain className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                <h3 className="text-lg font-semibold mb-2">No Insights Yet</h3>
                <p className="text-slate-600 mb-4">
                  Click "Generate New Insights" to get AI-powered recommendations
                </p>
                <Button
                  onClick={generateNewInsights}
                  disabled={isGenerating}
                  className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white"
                >
                  <Sparkles className="w-4 h-4 mr-2" />
                  Generate Insights
                </Button>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
}
import React, { useState, useMemo } from 'react';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { useNavigate } from 'react-router-dom';
import { format, differenceInDays, addDays } from 'date-fns';
import { toast } from 'sonner';

import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Brain,
  Mail,
  Calendar,
  TrendingUp,
  Users,
  Sparkles,
  Clock,
  AlertCircle,
  Loader2,
  Zap
} from 'lucide-react';

import LeadNurturingQueue from '../components/nurturing/LeadNurturingQueue';
import LeadEngagementAnalysis from '../components/nurturing/LeadEngagementAnalysis';
import AutomatedTaskScheduler from '../components/nurturing/AutomatedTaskScheduler';

export default function AILeadNurturing() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState('queue');
  const [isGenerating, setIsGenerating] = useState(false);

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me(),
  });

  const { data: leads = [], isLoading: leadsLoading } = useQuery({
    queryKey: ['leads'],
    queryFn: () => base44.entities.Lead.list('-created_date'),
    enabled: !!user,
  });

  const { data: properties = [] } = useQuery({
    queryKey: ['properties'],
    queryFn: () => base44.entities.Property.list(),
    enabled: !!user,
  });

  const { data: tasks = [] } = useQuery({
    queryKey: ['tasks'],
    queryFn: () => base44.entities.Task.list('-created_date'),
    enabled: !!user,
  });

  const { data: communications = [] } = useQuery({
    queryKey: ['communications'],
    queryFn: () => base44.entities.CommunicationLog.list('-created_date'),
    enabled: !!user,
  });

  const { data: messages = [] } = useQuery({
    queryKey: ['messages'],
    queryFn: () => base44.entities.Message.list('-created_date'),
    enabled: !!user,
  });

  // Analyze leads and calculate nurturing metrics
  const nurturingData = useMemo(() => {
    if (!leads.length) return { needsAttention: [], hotLeads: [], coldLeads: [], stats: {} };

    const now = new Date();
    
    const analyzedLeads = leads.map(lead => {
      const leadComms = communications.filter(c => c.lead_id === lead.id);
      const leadTasks = tasks.filter(t => t.lead_id === lead.id);
      const leadMessages = messages.filter(m => m.lead_id === lead.id);
      
      const lastContact = leadComms.length > 0 
        ? new Date(Math.max(...leadComms.map(c => new Date(c.created_date))))
        : new Date(lead.created_date);
      
      const daysSinceContact = differenceInDays(now, lastContact);
      const totalInteractions = leadComms.length + leadMessages.length;
      
      // Calculate engagement score (0-100)
      let engagementScore = lead.score || 50;
      if (daysSinceContact > 14) engagementScore -= 20;
      else if (daysSinceContact > 7) engagementScore -= 10;
      if (totalInteractions > 5) engagementScore += 15;
      else if (totalInteractions > 2) engagementScore += 5;
      engagementScore = Math.max(0, Math.min(100, engagementScore));

      // Predict conversion likelihood
      let conversionLikelihood = 'medium';
      if (engagementScore >= 70 && daysSinceContact <= 3) conversionLikelihood = 'high';
      else if (engagementScore < 40 || daysSinceContact > 14) conversionLikelihood = 'low';

      // Determine next best action
      let nextBestAction = 'send_email';
      let actionReason = 'Regular follow-up needed';
      
      if (daysSinceContact > 7) {
        nextBestAction = 'call';
        actionReason = 'No contact in over a week - personal touch needed';
      } else if (lead.lead_type === 'buyer' && lead.status === 'qualified') {
        nextBestAction = 'schedule_showing';
        actionReason = 'Qualified buyer ready for property viewings';
      } else if (totalInteractions === 0) {
        nextBestAction = 'introduction_email';
        actionReason = 'New lead needs introduction';
      } else if (engagementScore >= 70) {
        nextBestAction = 'call';
        actionReason = 'High engagement - ready for direct contact';
      }

      return {
        ...lead,
        daysSinceContact,
        totalInteractions,
        engagementScore,
        conversionLikelihood,
        nextBestAction,
        actionReason,
        lastContactDate: lastContact,
        pendingTasks: leadTasks.filter(t => t.status !== 'completed').length
      };
    });

    const needsAttention = analyzedLeads.filter(l => 
      l.daysSinceContact > 5 && 
      l.status !== 'closed' && 
      l.status !== 'lost'
    ).sort((a, b) => b.daysSinceContact - a.daysSinceContact);

    const hotLeads = analyzedLeads.filter(l => 
      l.conversionLikelihood === 'high' && 
      l.status !== 'closed'
    ).sort((a, b) => b.engagementScore - a.engagementScore);

    const coldLeads = analyzedLeads.filter(l => 
      l.conversionLikelihood === 'low' && 
      l.status !== 'closed' && 
      l.status !== 'lost'
    );

    return {
      analyzedLeads,
      needsAttention,
      hotLeads,
      coldLeads,
      stats: {
        total: leads.length,
        needsAttention: needsAttention.length,
        hot: hotLeads.length,
        cold: coldLeads.length,
        avgEngagement: Math.round(analyzedLeads.reduce((sum, l) => sum + l.engagementScore, 0) / analyzedLeads.length || 0)
      }
    };
  }, [leads, communications, tasks, messages]);

  // Generate AI follow-up emails for leads needing attention
  const generateFollowUps = async () => {
    if (nurturingData.needsAttention.length === 0) {
      toast.info('No leads currently need follow-up');
      return;
    }

    setIsGenerating(true);
    try {
      const leadsToProcess = nurturingData.needsAttention.slice(0, 5); // Process top 5
      
      for (const lead of leadsToProcess) {
        const prompt = `Generate a personalized follow-up email for a real estate lead.

Lead Information:
- Name: ${lead.name}
- Email: ${lead.email}
- Lead Type: ${lead.lead_type || 'unknown'}
- Status: ${lead.status}
- Days Since Last Contact: ${lead.daysSinceContact}
- Property Interest: ${lead.property_address || 'Not specified'}
- Notes: ${lead.notes || 'None'}
- Lead Source: ${lead.lead_source || 'Unknown'}

Generate a warm, professional follow-up email that:
1. References their specific situation/interest
2. Provides value (market update, new listing, etc.)
3. Includes a clear call to action
4. Feels personal, not templated

Return JSON with: subject, body, suggested_send_time (morning/afternoon/evening)`;

        const response = await base44.integrations.Core.InvokeLLM({
          prompt,
          response_json_schema: {
            type: "object",
            properties: {
              subject: { type: "string" },
              body: { type: "string" },
              suggested_send_time: { type: "string" }
            }
          }
        });

        // Save as draft message
        await base44.entities.Message.create({
          lead_id: lead.id,
          recipient_email: lead.email,
          recipient_name: lead.name,
          subject: response.subject,
          content: response.body,
          message_type: 'draft',
          sender_id: user.id
        });
      }

      queryClient.invalidateQueries({ queryKey: ['messages'] });
      toast.success(`Generated ${leadsToProcess.length} follow-up drafts`);
    } catch (error) {
      console.error('Error generating follow-ups:', error);
      toast.error('Failed to generate follow-ups');
    }
    setIsGenerating(false);
  };

  // Auto-schedule tasks for leads
  const scheduleAutomatedTasks = async () => {
    setIsGenerating(true);
    try {
      const leadsNeedingTasks = nurturingData.analyzedLeads.filter(l => 
        l.pendingTasks === 0 && 
        l.status !== 'closed' && 
        l.status !== 'lost'
      ).slice(0, 10);

      for (const lead of leadsNeedingTasks) {
        const taskType = lead.nextBestAction === 'call' ? 'follow_up' : 
                        lead.nextBestAction === 'schedule_showing' ? 'inspection' : 'general';
        
        const dueDate = addDays(new Date(), lead.conversionLikelihood === 'high' ? 1 : 3);

        await base44.entities.Task.create({
          title: `Follow up with ${lead.name}`,
          description: lead.actionReason,
          lead_id: lead.id,
          assigned_to: user.id,
          task_type: taskType,
          priority: lead.conversionLikelihood === 'high' ? 'high' : 'medium',
          status: 'pending',
          due_date: format(dueDate, 'yyyy-MM-dd')
        });
      }

      queryClient.invalidateQueries({ queryKey: ['tasks'] });
      toast.success(`Scheduled ${leadsNeedingTasks.length} follow-up tasks`);
    } catch (error) {
      console.error('Error scheduling tasks:', error);
      toast.error('Failed to schedule tasks');
    }
    setIsGenerating(false);
  };

  if (leadsLoading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
            <Brain className="w-7 h-7 text-indigo-600" />
            AI Lead Nurturing
          </h1>
          <p className="text-slate-500 dark:text-slate-400 mt-1">
            Automatically nurture leads with personalized follow-ups and smart scheduling
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            onClick={generateFollowUps}
            disabled={isGenerating}
            className="bg-indigo-600 hover:bg-indigo-700"
          >
            {isGenerating ? (
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            ) : (
              <Sparkles className="w-4 h-4 mr-2" />
            )}
            Generate Follow-ups
          </Button>
          <Button
            onClick={scheduleAutomatedTasks}
            disabled={isGenerating}
            variant="outline"
          >
            <Calendar className="w-4 h-4 mr-2" />
            Auto-Schedule Tasks
          </Button>
        </div>
      </div>

      {/* Stats Overview */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <Card className="bg-white dark:bg-slate-900">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-blue-100 dark:bg-blue-900/30">
                <Users className="w-5 h-5 text-blue-600" />
              </div>
              <div>
                <p className="text-2xl font-bold text-slate-900 dark:text-white">{nurturingData.stats.total}</p>
                <p className="text-xs text-slate-500">Total Leads</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white dark:bg-slate-900">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-red-100 dark:bg-red-900/30">
                <AlertCircle className="w-5 h-5 text-red-600" />
              </div>
              <div>
                <p className="text-2xl font-bold text-red-600">{nurturingData.stats.needsAttention}</p>
                <p className="text-xs text-slate-500">Needs Attention</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white dark:bg-slate-900">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-orange-100 dark:bg-orange-900/30">
                <Zap className="w-5 h-5 text-orange-600" />
              </div>
              <div>
                <p className="text-2xl font-bold text-orange-600">{nurturingData.stats.hot}</p>
                <p className="text-xs text-slate-500">Hot Leads</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white dark:bg-slate-900">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-slate-100 dark:bg-slate-800">
                <Clock className="w-5 h-5 text-slate-600" />
              </div>
              <div>
                <p className="text-2xl font-bold text-slate-600">{nurturingData.stats.cold}</p>
                <p className="text-xs text-slate-500">Cold Leads</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white dark:bg-slate-900">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-green-100 dark:bg-green-900/30">
                <TrendingUp className="w-5 h-5 text-green-600" />
              </div>
              <div>
                <p className="text-2xl font-bold text-green-600">{nurturingData.stats.avgEngagement}%</p>
                <p className="text-xs text-slate-500">Avg Engagement</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Main Content Tabs */}
      <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-4">
        <TabsList className="bg-white dark:bg-slate-900 border">
          <TabsTrigger value="queue" className="flex items-center gap-2">
            <Mail className="w-4 h-4" />
            Follow-up Queue
          </TabsTrigger>
          <TabsTrigger value="engagement" className="flex items-center gap-2">
            <TrendingUp className="w-4 h-4" />
            Engagement Analysis
          </TabsTrigger>
          <TabsTrigger value="tasks" className="flex items-center gap-2">
            <Calendar className="w-4 h-4" />
            Automated Tasks
          </TabsTrigger>
        </TabsList>

        <TabsContent value="queue">
          <LeadNurturingQueue 
            leads={nurturingData.needsAttention}
            hotLeads={nurturingData.hotLeads}
            messages={messages}
            user={user}
            onRefresh={() => queryClient.invalidateQueries()}
          />
        </TabsContent>

        <TabsContent value="engagement">
          <LeadEngagementAnalysis 
            leads={nurturingData.analyzedLeads}
            communications={communications}
          />
        </TabsContent>

        <TabsContent value="tasks">
          <AutomatedTaskScheduler 
            leads={nurturingData.analyzedLeads}
            tasks={tasks}
            user={user}
            onRefresh={() => queryClient.invalidateQueries({ queryKey: ['tasks'] })}
          />
        </TabsContent>
      </Tabs>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { Lead } from "@/api/entities";
import { User } from "@/api/entities";
import { InvokeLLM } from "@/api/integrations";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { 
  ArrowLeft, 
  Sparkles, 
  Target,
  Loader2,
  CheckCircle2,
  AlertCircle,
  Clock,
  Mail,
  Phone,
  Calendar
} from "lucide-react";
import { toast } from "sonner";

export default function AILeadScoring() {
  const navigate = useNavigate();
  const [leads, setLeads] = useState([]);
  const [scoredLeads, setScoredLeads] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isScoring, setIsScoring] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [user, leadData] = await Promise.all([
        User.me(),
        Lead.list("-created_date")
      ]);
      
      setCurrentUser(user);
      // Filter leads that need scoring or re-scoring
      const activeLeads = leadData.filter(l => 
        l.status !== 'converted' && l.status !== 'lost'
      );
      setLeads(activeLeads);
    } catch (error) {
      console.error("Error loading leads:", error);
    }
    setIsLoading(false);
  };

  const scoreAllLeads = async () => {
    setIsScoring(true);
    const scored = [];

    try {
      for (const lead of leads) {
        const analysis = await scoreLead(lead);
        scored.push({ ...lead, ...analysis });
        
        // Update the lead in the database
        await Lead.update(lead.id, {
          score: analysis.score,
          notes: (lead.notes || '') + `\n\n[AI Analysis ${new Date().toLocaleDateString()}]:\n${analysis.reasoning}`
        });
      }

      setScoredLeads(scored);
      toast.success(`Successfully scored ${scored.length} leads!`);
      await loadData();
    } catch (error) {
      console.error("Error scoring leads:", error);
      toast.error("Failed to score some leads");
    }
    setIsScoring(false);
  };

  const scoreLead = async (lead) => {
    try {
      const prompt = `Analyze this real estate lead and provide a comprehensive scoring and next action recommendation.

Lead Details:
- Name: ${lead.name}
- Email: ${lead.email}
- Phone: ${lead.phone || 'Not provided'}
- Source: ${lead.lead_source}
- Interest: ${lead.interest_type}
- Budget: $${lead.budget_min?.toLocaleString()} - $${lead.budget_max?.toLocaleString()}
- Status: ${lead.status}
- Timeline: ${lead.timeline}
- Preferred Areas: ${lead.preferred_areas || 'Not specified'}
- Current Score: ${lead.score || 0}
- Website Visits: ${lead.website_visits || 0}
- Email Opens: ${lead.email_opens || 0}
- Property Views: ${lead.property_views || 0}
- Days Since Last Contact: ${lead.last_contact ? Math.floor((Date.now() - new Date(lead.last_contact).getTime()) / (1000 * 60 * 60 * 24)) : 'Never contacted'}
- Notes: ${lead.notes || 'No notes'}

Provide a comprehensive analysis with:
1. Overall lead quality score (0-100)
2. Likelihood to convert in next 30/60/90 days
3. Key strengths and concerns
4. Recommended next action
5. Optimal contact timing
6. Suggested talking points

Return as JSON with these exact keys:
- score: number (0-100)
- conversion_likelihood_30: number (0-100)
- conversion_likelihood_60: number (0-100)
- conversion_likelihood_90: number (0-100)
- priority: "hot"|"warm"|"cold"
- strengths: array of strings
- concerns: array of strings
- next_action: string (specific action to take)
- contact_timing: string (best time/day to contact)
- talking_points: array of strings
- reasoning: string (brief explanation of scoring)`;

      const response = await InvokeLLM({
        prompt,
        add_context_from_internet: false,
        response_json_schema: {
          type: "object",
          properties: {
            score: { type: "number" },
            conversion_likelihood_30: { type: "number" },
            conversion_likelihood_60: { type: "number" },
            conversion_likelihood_90: { type: "number" },
            priority: { type: "string", enum: ["hot", "warm", "cold"] },
            strengths: { type: "array", items: { type: "string" } },
            concerns: { type: "array", items: { type: "string" } },
            next_action: { type: "string" },
            contact_timing: { type: "string" },
            talking_points: { type: "array", items: { type: "string" } },
            reasoning: { type: "string" }
          }
        }
      });

      return response;
    } catch (error) {
      console.error("Error scoring lead:", error);
      return {
        score: lead.score || 50,
        priority: "warm",
        reasoning: "Error during scoring"
      };
    }
  };

  const getPriorityColor = (priority) => {
    const colors = {
      hot: "bg-red-100 text-red-700 border-red-300",
      warm: "bg-yellow-100 text-yellow-700 border-yellow-300",
      cold: "bg-blue-100 text-blue-700 border-blue-300"
    };
    return colors[priority] || colors.warm;
  };

  const getPriorityIcon = (priority) => {
    if (priority === 'hot') return <AlertCircle className="w-4 h-4" />;
    if (priority === 'warm') return <Clock className="w-4 h-4" />;
    return <CheckCircle2 className="w-4 h-4" />;
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="p-4">
      <div className="space-y-6">
        {/* Header */}
        <div className="app-card p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(createPageUrl("Leads"))}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <Sparkles className="w-6 h-6 text-indigo-600" />
                <h1 className="app-title text-2xl">AI Lead Scoring & Intelligence</h1>
              </div>
              <p className="app-subtitle">{leads.length} active leads ready for analysis</p>
            </div>
            <Button 
              onClick={scoreAllLeads}
              disabled={isScoring || leads.length === 0}
              className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
            >
              {isScoring ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Scoring...
                </>
              ) : (
                <>
                  <Sparkles className="w-4 h-4 mr-2" />
                  Score All Leads
                </>
              )}
            </Button>
          </div>
        </div>

        {/* Stats Cards */}
        {scoredLeads.length > 0 && (
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-sm font-medium text-slate-600">Hot Leads</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-red-600">
                  {scoredLeads.filter(l => l.priority === 'hot').length}
                </div>
                <p className="text-xs text-slate-500 mt-1">High priority contacts</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-sm font-medium text-slate-600">Warm Leads</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-yellow-600">
                  {scoredLeads.filter(l => l.priority === 'warm').length}
                </div>
                <p className="text-xs text-slate-500 mt-1">Medium priority</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-sm font-medium text-slate-600">Avg Score</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-indigo-600">
                  {Math.round(scoredLeads.reduce((sum, l) => sum + l.score, 0) / scoredLeads.length)}
                </div>
                <p className="text-xs text-slate-500 mt-1">Out of 100</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-sm font-medium text-slate-600">30-Day Conversion</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-green-600">
                  {Math.round(scoredLeads.reduce((sum, l) => sum + (l.conversion_likelihood_30 || 0), 0) / scoredLeads.length)}%
                </div>
                <p className="text-xs text-slate-500 mt-1">Predicted rate</p>
              </CardContent>
            </Card>
          </div>
        )}

        {/* Scored Leads List */}
        <div className="space-y-4">
          {scoredLeads.length > 0 ? (
            scoredLeads
              .sort((a, b) => b.score - a.score)
              .map(lead => (
                <Card key={lead.id} className="hover:shadow-lg transition-shadow">
                  <CardContent className="p-6">
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-2">
                          <h3 className="text-xl font-bold text-slate-900">{lead.name}</h3>
                          <Badge className={`${getPriorityColor(lead.priority)} flex items-center gap-1`}>
                            {getPriorityIcon(lead.priority)}
                            {lead.priority.toUpperCase()}
                          </Badge>
                          <Badge variant="outline" className="font-bold">
                            Score: {lead.score}/100
                          </Badge>
                        </div>
                        <div className="flex items-center gap-4 text-sm text-slate-600">
                          {lead.email && (
                            <span className="flex items-center gap-1">
                              <Mail className="w-4 h-4" />
                              {lead.email}
                            </span>
                          )}
                          {lead.phone && (
                            <span className="flex items-center gap-1">
                              <Phone className="w-4 h-4" />
                              {lead.phone}
                            </span>
                          )}
                        </div>
                      </div>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => navigate(createPageUrl(`LeadDetail?id=${lead.id}`))}
                      >
                        View Details
                      </Button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                      <div className="bg-slate-50 p-3 rounded-lg">
                        <div className="text-xs text-slate-500 mb-1">30-Day Conversion</div>
                        <div className="text-2xl font-bold text-indigo-600">{lead.conversion_likelihood_30}%</div>
                      </div>
                      <div className="bg-slate-50 p-3 rounded-lg">
                        <div className="text-xs text-slate-500 mb-1">60-Day Conversion</div>
                        <div className="text-2xl font-bold text-purple-600">{lead.conversion_likelihood_60}%</div>
                      </div>
                      <div className="bg-slate-50 p-3 rounded-lg">
                        <div className="text-xs text-slate-500 mb-1">90-Day Conversion</div>
                        <div className="text-2xl font-bold text-pink-600">{lead.conversion_likelihood_90}%</div>
                      </div>
                    </div>

                    <div className="space-y-3">
                      <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                        <div className="flex items-center gap-2 mb-2">
                          <CheckCircle2 className="w-4 h-4 text-green-600" />
                          <span className="font-semibold text-green-900">Strengths</span>
                        </div>
                        <ul className="list-disc list-inside text-sm text-green-800 space-y-1">
                          {lead.strengths?.map((strength, idx) => (
                            <li key={idx}>{strength}</li>
                          ))}
                        </ul>
                      </div>

                      {lead.concerns && lead.concerns.length > 0 && (
                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                          <div className="flex items-center gap-2 mb-2">
                            <AlertCircle className="w-4 h-4 text-amber-600" />
                            <span className="font-semibold text-amber-900">Concerns</span>
                          </div>
                          <ul className="list-disc list-inside text-sm text-amber-800 space-y-1">
                            {lead.concerns.map((concern, idx) => (
                              <li key={idx}>{concern}</li>
                            ))}
                          </ul>
                        </div>
                      )}

                      <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                        <div className="flex items-center gap-2 mb-2">
                          <Target className="w-4 h-4 text-indigo-600" />
                          <span className="font-semibold text-indigo-900">Next Action</span>
                        </div>
                        <p className="text-sm text-indigo-800 font-medium">{lead.next_action}</p>
                        <div className="flex items-center gap-2 mt-2 text-xs text-indigo-700">
                          <Calendar className="w-3 h-3" />
                          Best time: {lead.contact_timing}
                        </div>
                      </div>

                      {lead.talking_points && lead.talking_points.length > 0 && (
                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                          <div className="flex items-center gap-2 mb-2">
                            <Sparkles className="w-4 h-4 text-purple-600" />
                            <span className="font-semibold text-purple-900">Talking Points</span>
                          </div>
                          <ul className="list-disc list-inside text-sm text-purple-800 space-y-1">
                            {lead.talking_points.map((point, idx) => (
                              <li key={idx}>{point}</li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              ))
          ) : (
            <Card>
              <CardContent className="p-12 text-center">
                <Target className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                <h3 className="text-xl font-semibold text-slate-900 mb-2">No Scored Leads Yet</h3>
                <p className="text-slate-500 mb-6">
                  Click "Score All Leads" to analyze your leads with AI
                </p>
                <Button 
                  onClick={scoreAllLeads}
                  disabled={isScoring || leads.length === 0}
                  className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                >
                  <Sparkles className="w-4 h-4 mr-2" />
                  Score {leads.length} Leads
                </Button>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
}


import React, { useState, useEffect } from "react";
import { Property } from "@/api/entities";
import { InvokeLLM } from "@/api/integrations";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { ArrowLeft, Sparkles, Copy, Loader2, Check } from "lucide-react";
import { toast } from "sonner";

export default function AIPropertyDescriptionGenerator() {
  const navigate = useNavigate();
  const urlParams = new URLSearchParams(window.location.search);
  const propertyId = urlParams.get('id');
  
  const [property, setProperty] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [generatedDescription, setGeneratedDescription] = useState("");
  const [style, setStyle] = useState("professional");
  const [length, setLength] = useState("medium");
  const [tone, setTone] = useState("enthusiastic");

  useEffect(() => {
    if (propertyId) {
      loadProperty();
    } else {
      setIsLoading(false);
    }
  }, [propertyId]);

  const loadProperty = async () => {
    setIsLoading(true);
    try {
      const properties = await Property.list();
      const prop = properties.find(p => p.id === propertyId);
      if (prop) {
        setProperty(prop);
        if (prop.description) {
          setGeneratedDescription(prop.description);
        }
      }
    } catch (error) {
      console.error("Error loading property:", error);
      toast.error("Failed to load property");
    }
    setIsLoading(false);
  };

  const generateDescription = async () => {
    if (!property) {
      toast.error("Please select a property first");
      return;
    }
    
    setIsGenerating(true);
    try {
      const lengthGuide = {
        short: "2-3 sentences, concise and punchy",
        medium: "2 paragraphs, balanced detail",
        long: "3-4 paragraphs, comprehensive and detailed"
      };

      const prompt = `Generate a compelling real estate listing description for this property:

Property Details:
- Address: ${property.address}, ${property.city}, ${property.state}
- Price: $${property.price?.toLocaleString()}
- Type: ${property.property_type?.replace('_', ' ')}
- Bedrooms: ${property.bedrooms || 'N/A'}
- Bathrooms: ${property.bathrooms || 'N/A'}
- Square Feet: ${property.square_feet?.toLocaleString() || 'N/A'}
- Year Built: ${property.year_built || 'N/A'}
- Lot Size: ${property.lot_size || 'N/A'} acres
- Features: ${property.features || 'Standard features'}

Style: ${style}
Length: ${lengthGuide[length]}
Tone: ${tone}

Create a description that:
1. Highlights key selling points and unique features
2. Appeals to the target buyer demographic
3. Uses vivid, engaging language
4. Includes a strong call-to-action
5. Is SEO-friendly and includes relevant keywords
6. Paints a lifestyle picture, not just lists features

Return ONLY the description text, no additional formatting or labels.`;

      const response = await InvokeLLM({
        prompt,
        add_context_from_internet: true
      });

      setGeneratedDescription(response);
      toast.success("Description generated successfully!");
    } catch (error) {
      console.error("Error generating description:", error);
      toast.error("Failed to generate description. Please try again.");
    }
    setIsGenerating(false);
  };

  const saveDescription = async () => {
    if (!property || !generatedDescription) {
      toast.error("No description to save");
      return;
    }
    
    setIsSaving(true);
    try {
      await Property.update(property.id, {
        description: generatedDescription
      });
      toast.success("Description saved to property!");
      setTimeout(() => {
        navigate(createPageUrl(`PropertyDetail?id=${property.id}`));
      }, 1000);
    } catch (error) {
      console.error("Error saving description:", error);
      toast.error("Failed to save description");
    }
    setIsSaving(false);
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(generatedDescription);
    toast.success("Copied to clipboard!");
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  if (!propertyId || !property) {
    return (
      <div className="space-y-6">
        <div className="app-card p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(createPageUrl("Properties"))}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <Sparkles className="w-6 h-6 text-indigo-600" />
                <h1 className="app-title text-2xl">AI Description Generator</h1>
              </div>
              <p className="app-subtitle">Generate compelling property descriptions with AI</p>
            </div>
          </div>
        </div>

        <div className="app-card p-12 text-center">
          <Sparkles className="w-16 h-16 mx-auto mb-4 text-slate-300" />
          <h2 className="text-2xl font-bold mb-4">No Property Selected</h2>
          <p className="text-slate-500 mb-6">
            Please select a property from the Properties page to generate a description.
          </p>
          <Button onClick={() => navigate(createPageUrl("Properties"))} className="app-button">
            <ArrowLeft className="w-4 h-4 mr-2" />
            Go to Properties
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="p-4">
      <div className="space-y-6">
        {/* Header */}
        <div className="app-card p-6">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => navigate(createPageUrl(`PropertyDetail?id=${property.id}`))}
              className="rounded-full"
            >
              <ArrowLeft className="w-5 h-5" />
            </Button>
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <Sparkles className="w-6 h-6 text-indigo-600" />
                <h1 className="app-title text-2xl">AI Description Generator</h1>
              </div>
              <p className="app-subtitle">{property.address}, {property.city}</p>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Controls */}
          <div className="lg:col-span-1 space-y-4">
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Generation Options</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">Style</label>
                  <Select value={style} onValueChange={setStyle}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="professional">Professional</SelectItem>
                      <SelectItem value="luxury">Luxury</SelectItem>
                      <SelectItem value="family_friendly">Family Friendly</SelectItem>
                      <SelectItem value="investment">Investment Focused</SelectItem>
                      <SelectItem value="modern">Modern & Hip</SelectItem>
                      <SelectItem value="traditional">Traditional</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">Length</label>
                  <Select value={length} onValueChange={setLength}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="short">Short (2-3 sentences)</SelectItem>
                      <SelectItem value="medium">Medium (2 paragraphs)</SelectItem>
                      <SelectItem value="long">Long (3-4 paragraphs)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">Tone</label>
                  <Select value={tone} onValueChange={setTone}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="enthusiastic">Enthusiastic</SelectItem>
                      <SelectItem value="sophisticated">Sophisticated</SelectItem>
                      <SelectItem value="warm">Warm & Inviting</SelectItem>
                      <SelectItem value="bold">Bold & Confident</SelectItem>
                      <SelectItem value="factual">Factual & Direct</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <Button 
                  onClick={generateDescription} 
                  disabled={isGenerating}
                  className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
                >
                  {isGenerating ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Generating...
                    </>
                  ) : (
                    <>
                      <Sparkles className="w-4 h-4 mr-2" />
                      Generate Description
                    </>
                  )}
                </Button>

                {generatedDescription && (
                  <div className="space-y-2">
                    <Button 
                      onClick={copyToClipboard} 
                      variant="outline"
                      className="w-full"
                    >
                      <Copy className="w-4 h-4 mr-2" />
                      Copy to Clipboard
                    </Button>
                    <Button 
                      onClick={saveDescription}
                      disabled={isSaving}
                      className="w-full bg-green-600 hover:bg-green-700 text-white"
                    >
                      {isSaving ? (
                        <>
                          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                          Saving...
                        </>
                      ) : (
                        <>
                          <Check className="w-4 h-4 mr-2" />
                          Save to Property
                        </>
                      )}
                    </Button>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Property Info */}
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Property Summary</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2 text-sm">
                <div><strong>Price:</strong> ${property.price?.toLocaleString()}</div>
                <div><strong>Type:</strong> {property.property_type?.replace('_', ' ')}</div>
                <div><strong>Beds/Baths:</strong> {property.bedrooms}/{property.bathrooms}</div>
                <div><strong>Sq Ft:</strong> {property.square_feet?.toLocaleString()}</div>
                {property.features && (
                  <div><strong>Features:</strong> {property.features}</div>
                )}
              </CardContent>
            </Card>
          </div>

          {/* Generated Description */}
          <div className="lg:col-span-2">
            <Card className="h-full">
              <CardHeader>
                <CardTitle className="text-lg">Generated Description</CardTitle>
              </CardHeader>
              <CardContent>
                <Textarea
                  value={generatedDescription}
                  onChange={(e) => setGeneratedDescription(e.target.value)}
                  placeholder="Click 'Generate Description' to create AI-powered listing description..."
                  className="min-h-[500px] text-base leading-relaxed"
                />
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}
