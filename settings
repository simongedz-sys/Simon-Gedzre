import React, { useState, useEffect } from "react";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from "recharts";
import { TrendingUp, RefreshCw, Loader2, Activity, Database } from "lucide-react";
import { toast } from "sonner";
import { format, startOfMonth, subMonths } from "date-fns";

const normalize = (value, min, max) => {
  return Math.max(0, Math.min(100, ((value - min) / (max - min)) * 100));
};

const getEmotionLabel = (value) => {
  if (value < 26) return "Fear / Freeze";
  if (value < 46) return "Caution";
  if (value < 56) return "Neutral";
  if (value < 76) return "Optimism";
  return "Euphoria";
};

export default function RMEISettings() {
  const queryClient = useQueryClient();
  const [isCalculating, setIsCalculating] = useState(false);
  const [isBackfilling, setIsBackfilling] = useState(false);
  const [autoUpdate, setAutoUpdate] = useState(
    localStorage.getItem('rmei_auto_update') === 'true'
  );

  const { data: rmeiHistory = [], isLoading } = useQuery({
    queryKey: ['rmeiHistory'],
    queryFn: async () => {
      try {
        return await base44.entities.RMEIRecord.list('-date');
      } catch {
        return [];
      }
    },
  });

  // Generate historical data for past 12 months
  const backfillHistoricalData = async () => {
    setIsBackfilling(true);
    
    try {
      toast.info("Generating 12 months of historical data...");
      
      const records = [];
      const today = new Date();
      
      // Generate data for past 12 months (one record per month)
      for (let i = 11; i >= 0; i--) {
        const monthDate = subMonths(startOfMonth(today), i);
        const dateStr = format(monthDate, 'yyyy-MM-dd');
        
        // Check if record already exists for this month
        const existingMonth = rmeiHistory.find(r => {
          const recordMonth = format(new Date(r.date), 'yyyy-MM');
          const targetMonth = format(monthDate, 'yyyy-MM');
          return recordMonth === targetMonth;
        });
        
        if (!existingMonth) {
          // Generate realistic values with trends
          // Base value around 65-70 with variation
          const baseValue = 67;
          const variation = Math.sin(i / 2) * 10; // Create wave pattern
          const randomNoise = Math.random() * 8 - 4; // ±4 random
          const value = Math.round(Math.max(40, Math.min(85, baseValue + variation + randomNoise)));
          
          records.push({
            date: dateStr,
            value: value,
            emotion_label: getEmotionLabel(value),
            mortgage_rate: 6.5 + (Math.random() * 1.5 - 0.75),
            price_growth: Math.random() * 2 - 0.5,
            inventory_change: Math.random() * 10 - 5,
            sentiment_score: value - 10 + (Math.random() * 20 - 10),
            raw_data: JSON.stringify({
              generated: true,
              month: format(monthDate, 'MMM yyyy')
            })
          });
        }
      }
      
      if (records.length > 0) {
        // Insert all records
        await base44.entities.RMEIRecord.bulkCreate(records);
        
        toast.success(`Generated ${records.length} months of historical data`);
        queryClient.invalidateQueries({ queryKey: ['rmeiHistory'] });
      } else {
        toast.info("Historical data already exists for all months");
      }
      
    } catch (error) {
      console.error("Backfill error:", error);
      toast.error("Failed to generate historical data");
    } finally {
      setIsBackfilling(false);
    }
  };

  const calculateRMEI = async (isAuto = false) => {
    setIsCalculating(true);
    const today = new Date().toISOString().split('T')[0];

    try {
      // Check if already calculated today
      const existingToday = rmeiHistory.find(r => r.date === today);
      if (existingToday) {
        if (!isAuto) {
          toast.info("RMEI already calculated for today");
        }
        setIsCalculating(false);
        return existingToday;
      }

      if (!isAuto) {
        toast.info("Fetching live market data...");
      }

      // Fetch mortgage rates
      const mortgageData = await base44.integrations.Core.InvokeLLM({
        prompt: `What is the current average 30-year fixed mortgage rate in the United States? 
Look up the latest data from reliable sources like Freddie Mac, Fannie Mae, or major financial news.
Respond with JSON containing only the rate as a number.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            rate: { type: "number", description: "30-year mortgage rate percentage" }
          },
          required: ["rate"]
        }
      });

      // Fetch housing market data
      const housingData = await base44.integrations.Core.InvokeLLM({
        prompt: `Analyze the current US housing market based on latest data:
1. What is the month-over-month median home price growth percentage? (Look for recent Case-Shiller, NAR, or Zillow data)
2. What is the year-over-year housing inventory change percentage? (Check NAR existing home sales data)
Provide realistic numbers based on current market conditions.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            price_growth: { type: "number", description: "Monthly price growth %" },
            inventory_change: { type: "number", description: "YoY inventory change %" }
          },
          required: ["price_growth", "inventory_change"]
        }
      });

      // Analyze market sentiment from recent news
      const sentimentData = await base44.integrations.Core.InvokeLLM({
        prompt: `Analyze US real estate market sentiment from news in the past 7 days.

Search for recent articles about:
- Housing market trends
- Home sales data
- Buyer/seller confidence
- Real estate market forecasts
- Mortgage rate impacts

Rate overall sentiment 0-100:
- 0-25: Very bearish (crash fears, declining sales, rising inventory)
- 26-50: Cautious/negative (slowing market, affordability concerns)
- 51-75: Neutral to positive (stable market, moderate growth)
- 76-100: Very bullish (hot market, bidding wars, strong demand)

Consider headlines, expert opinions, and market data reports.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            sentiment: { type: "number", description: "Sentiment score 0-100" },
            summary: { type: "string", description: "Brief 1-sentence market summary" }
          },
          required: ["sentiment", "summary"]
        }
      });

      const mortgageRate = mortgageData.rate || 7.0;
      const priceGrowth = housingData.price_growth || 0;
      const inventoryChange = housingData.inventory_change || 0;
      const sentimentScore = sentimentData.sentiment || 50;

      // Calculate RMEI scores
      const rateScore = 100 - normalize(mortgageRate, 5, 8);
      const priceScore = normalize(priceGrowth, -2, 3);
      const inventoryScore = 100 - normalize(inventoryChange, -10, 10);
      const sentimentScoreFinal = sentimentScore;

      const rmeiValue = Math.round(
        rateScore * 0.3 +
        priceScore * 0.3 +
        inventoryScore * 0.2 +
        sentimentScoreFinal * 0.2
      );

      const emotionLabel = getEmotionLabel(rmeiValue);

      // Save to database
      const record = await base44.entities.RMEIRecord.create({
        date: today,
        value: rmeiValue,
        emotion_label: emotionLabel,
        mortgage_rate: mortgageRate,
        price_growth: priceGrowth,
        inventory_change: inventoryChange,
        sentiment_score: sentimentScore,
        raw_data: JSON.stringify({
          rateScore,
          priceScore,
          inventoryScore,
          sentimentScoreFinal,
          summary: sentimentData.summary
        })
      });

      queryClient.invalidateQueries({ queryKey: ['rmeiHistory'] });
      
      if (!isAuto) {
        toast.success(`RMEI calculated: ${rmeiValue} (${emotionLabel})`);
      }

      return record;

    } catch (error) {
      console.error("RMEI calculation error:", error);
      if (!isAuto) {
        toast.error("Failed to calculate RMEI");
      }
    } finally {
      setIsCalculating(false);
    }
  };

  // Auto-update on mount if enabled
  useEffect(() => {
    if (autoUpdate) {
      calculateRMEI(true);
    }
  }, []);

  const toggleAutoUpdate = (checked) => {
    setAutoUpdate(checked);
    localStorage.setItem('rmei_auto_update', checked.toString());
    if (checked) {
      toast.success("Auto-update enabled");
      calculateRMEI(true);
    } else {
      toast.info("Auto-update disabled");
    }
  };

  // Aggregate data by month for the past 12 months
  const chartData = React.useMemo(() => {
    if (rmeiHistory.length === 0) return [];

    const monthlyData = {};
    
    rmeiHistory.forEach(record => {
      try {
        const date = new Date(record.date);
        const monthKey = format(date, 'yyyy-MM');
        const monthLabel = format(date, 'MMM yyyy');
        
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = {
            monthKey,
            monthLabel,
            values: [],
            date: date
          };
        }
        
        monthlyData[monthKey].values.push(record.value);
      } catch (e) {
        console.error("Error processing record:", e);
      }
    });

    const monthlyAverages = Object.values(monthlyData)
      .map(month => ({
        date: format(month.date, 'MMM yyyy'),
        value: Math.round(month.values.reduce((a, b) => a + b, 0) / month.values.length),
        sortDate: month.date
      }))
      .sort((a, b) => a.sortDate - b.sortDate)
      .slice(-12);

    return monthlyAverages;
  }, [rmeiHistory]);

  const latestRecord = rmeiHistory[0];

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="w-8 h-8 animate-spin text-purple-500" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <TrendingUp className="w-5 h-5 text-purple-500" />
            Real Estate Market Emotion Index (RMEI)
          </CardTitle>
          <CardDescription>
            Track market sentiment combining mortgage rates, price growth, inventory levels, and news sentiment.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Current Status */}
          {latestRecord && (
            <div className="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600 dark:text-slate-400 mb-1">Current Index</p>
                  <div className="flex items-center gap-3">
                    <p className="text-5xl font-bold text-purple-600">{latestRecord.value}</p>
                    <div>
                      <Badge className="bg-purple-600 text-white">
                        {latestRecord.emotion_label}
                      </Badge>
                      <p className="text-xs text-slate-500 mt-1">
                        Last updated: {format(new Date(latestRecord.date), 'MMM d, yyyy')}
                      </p>
                    </div>
                  </div>
                </div>
                
                <div className="text-right">
                  <p className="text-sm text-slate-600 dark:text-slate-400 mb-2">
                    {chartData.length} months of data
                  </p>
                  <div className="flex items-center gap-2">
                    <Label htmlFor="auto-update" className="text-sm cursor-pointer">
                      Auto-update
                    </Label>
                    <Switch
                      id="auto-update"
                      checked={autoUpdate}
                      onCheckedChange={toggleAutoUpdate}
                    />
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Action Buttons */}
          <div className="flex gap-3 flex-wrap">
            <Button
              onClick={() => calculateRMEI(false)}
              disabled={isCalculating}
              className="bg-purple-600 hover:bg-purple-700"
            >
              {isCalculating ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Calculating...
                </>
              ) : (
                <>
                  <RefreshCw className="w-4 h-4 mr-2" />
                  Calculate Today's RMEI
                </>
              )}
            </Button>

            {chartData.length < 12 && (
              <Button
                onClick={backfillHistoricalData}
                disabled={isBackfilling}
                variant="outline"
              >
                {isBackfilling ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Database className="w-4 h-4 mr-2" />
                    Generate 12-Month History
                  </>
                )}
              </Button>
            )}
          </div>

          {/* Historical Chart */}
          {chartData.length > 0 && (
            <div>
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <Activity className="w-5 h-5 text-purple-500" />
                12-Month Historical Trend
              </h3>
              <div className="bg-white dark:bg-slate-800 rounded-lg p-4 border">
                <ResponsiveContainer width="100%" height={300}>
                  <LineChart data={chartData}>
                    <XAxis 
                      dataKey="date" 
                      stroke="#888" 
                      tick={{ fontSize: 12 }}
                      angle={-45}
                      textAnchor="end"
                      height={80}
                    />
                    <YAxis 
                      domain={[0, 100]} 
                      stroke="#888" 
                      tick={{ fontSize: 12 }}
                    />
                    <Tooltip 
                      contentStyle={{ 
                        background: 'rgba(255,255,255,0.95)',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px'
                      }}
                      formatter={(value) => [`${value}`, "RMEI"]}
                    />
                    <Line 
                      type="monotone" 
                      dataKey="value" 
                      stroke="#9333ea" 
                      strokeWidth={3} 
                      dot={{ r: 4, fill: '#9333ea' }}
                      activeDot={{ r: 6 }}
                    />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>
          )}

          {/* Methodology */}
          <div className="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4">
            <h4 className="font-semibold text-sm mb-2">How RMEI is Calculated</h4>
            <div className="space-y-1 text-sm text-slate-600 dark:text-slate-400">
              <p>• <strong>30%</strong> - Mortgage Rates (lower rates = more optimism)</p>
              <p>• <strong>30%</strong> - Price Growth (positive growth = more optimism)</p>
              <p>• <strong>20%</strong> - Inventory Levels (lower inventory = more greed)</p>
              <p>• <strong>20%</strong> - News Sentiment (AI analysis of market news)</p>
            </div>
            <div className="mt-3 grid grid-cols-5 gap-2 text-xs">
              <div className="text-center">
                <div className="w-full h-2 bg-red-500 rounded mb-1"></div>
                <p className="font-semibold">0-25</p>
                <p className="text-slate-500">Fear</p>
              </div>
              <div className="text-center">
                <div className="w-full h-2 bg-orange-500 rounded mb-1"></div>
                <p className="font-semibold">26-45</p>
                <p className="text-slate-500">Caution</p>
              </div>
              <div className="text-center">
                <div className="w-full h-2 bg-yellow-500 rounded mb-1"></div>
                <p className="font-semibold">46-55</p>
                <p className="text-slate-500">Neutral</p>
              </div>
              <div className="text-center">
                <div className="w-full h-2 bg-green-500 rounded mb-1"></div>
                <p className="font-semibold">56-75</p>
                <p className="text-slate-500">Optimism</p>
              </div>
              <div className="text-center">
                <div className="w-full h-2 bg-cyan-500 rounded mb-1"></div>
                <p className="font-semibold">76-100</p>
                <p className="text-slate-500">Euphoria</p>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import { Shield, Plus, Edit, Trash2, Lock } from 'lucide-react';
import { toast } from 'sonner';
import { PERMISSION_CATEGORIES } from '@/components/utils/rolePermissions';

export default function RolePermissionManagement() {
  const queryClient = useQueryClient();
  const [editingRole, setEditingRole] = useState(null);
  const [showRoleModal, setShowRoleModal] = useState(false);

  const { data: roles = [], isLoading } = useQuery({
    queryKey: ['roleDefinitions'],
    queryFn: () => base44.entities.RoleDefinition.list(),
  });

  const { data: users = [] } = useQuery({
    queryKey: ['allUsers'],
    queryFn: () => base44.entities.User.list(),
  });

  const createRoleMutation = useMutation({
    mutationFn: (roleData) => base44.entities.RoleDefinition.create(roleData),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['roleDefinitions'] });
      toast.success('Role created successfully');
      setShowRoleModal(false);
      setEditingRole(null);
    },
    onError: (error) => toast.error(`Failed to create role: ${error.message}`),
  });

  const updateRoleMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.RoleDefinition.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['roleDefinitions'] });
      toast.success('Role updated successfully');
      setShowRoleModal(false);
      setEditingRole(null);
    },
    onError: (error) => toast.error(`Failed to update role: ${error.message}`),
  });

  const deleteRoleMutation = useMutation({
    mutationFn: (id) => base44.entities.RoleDefinition.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['roleDefinitions'] });
      toast.success('Role deleted successfully');
    },
    onError: (error) => toast.error(`Failed to delete role: ${error.message}`),
  });

  const handleOpenModal = (role = null) => {
    setEditingRole(role);
    setShowRoleModal(true);
  };

  const handleDeleteRole = async (role) => {
    if (role.is_system_role) {
      toast.error('Cannot delete system roles');
      return;
    }

    const usersWithRole = users.filter(u => u.role === role.role_name);
    if (usersWithRole.length > 0) {
      toast.error(`Cannot delete role: ${usersWithRole.length} users are assigned this role`);
      return;
    }

    if (confirm(`Are you sure you want to delete the role "${role.display_name}"?`)) {
      deleteRoleMutation.mutate(role.id);
    }
  };

  const getUserCountByRole = (roleName) => {
    return users.filter(u => u.role === roleName).length;
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Role & Permission Management</h2>
          <p className="text-slate-600 dark:text-slate-400 mt-1">
            Configure user roles and their permissions across the platform
          </p>
        </div>
        <Button onClick={() => handleOpenModal()} className="gap-2">
          <Plus className="w-4 h-4" />
          Create Role
        </Button>
      </div>

      {isLoading ? (
        <div className="text-center py-12">Loading roles...</div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {roles.map((role) => {
            const userCount = getUserCountByRole(role.role_name);
            const permissions = JSON.parse(role.permissions || '[]');

            return (
              <Card key={role.id} className="relative">
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <CardTitle className="flex items-center gap-2">
                        <Shield className="w-5 h-5 text-indigo-600" />
                        {role.display_name}
                        {role.is_system_role && (
                          <Badge variant="secondary" className="text-xs">
                            <Lock className="w-3 h-3 mr-1" />
                            System
                          </Badge>
                        )}
                      </CardTitle>
                      <CardDescription className="mt-2">
                        {role.description || 'No description'}
                      </CardDescription>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 mt-3">
                    <Badge variant="outline">{userCount} users</Badge>
                    <Badge variant="outline">{permissions.length} permissions</Badge>
                    <Badge variant="outline" className="capitalize">
                      Priority: {role.priority || 0}
                    </Badge>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div>
                      <p className="text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">
                        Key Permissions:
                      </p>
                      <div className="flex flex-wrap gap-1">
                        {permissions.slice(0, 6).map((perm) => (
                          <Badge key={perm} variant="secondary" className="text-xs">
                            {perm.replace(/_/g, ' ')}
                          </Badge>
                        ))}
                        {permissions.length > 6 && (
                          <Badge variant="secondary" className="text-xs">
                            +{permissions.length - 6} more
                          </Badge>
                        )}
                      </div>
                    </div>

                    <div className="flex gap-2 pt-3 border-t">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleOpenModal(role)}
                        className="flex-1"
                      >
                        <Edit className="w-3 h-3 mr-1" />
                        Edit
                      </Button>
                      {!role.is_system_role && (
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleDeleteRole(role)}
                          className="text-red-600 hover:text-red-700"
                        >
                          <Trash2 className="w-3 h-3" />
                        </Button>
                      )}
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>
      )}

      {showRoleModal && (
        <RoleModal
          role={editingRole}
          onClose={() => {
            setShowRoleModal(false);
            setEditingRole(null);
          }}
          onSave={(data) => {
            if (editingRole) {
              updateRoleMutation.mutate({ id: editingRole.id, data });
            } else {
              createRoleMutation.mutate(data);
            }
          }}
        />
      )}
    </div>
  );
}

function RoleModal({ role, onClose, onSave }) {
  const [formData, setFormData] = useState({
    role_name: role?.role_name || '',
    display_name: role?.display_name || '',
    description: role?.description || '',
    priority: role?.priority || 0,
    is_active: role?.is_active ?? true,
    permissions: JSON.parse(role?.permissions || '[]'),
  });

  const handlePermissionToggle = (permission) => {
    setFormData((prev) => ({
      ...prev,
      permissions: prev.permissions.includes(permission)
        ? prev.permissions.filter((p) => p !== permission)
        : [...prev.permissions, permission],
    }));
  };

  const handleSelectAll = (category) => {
    const categoryPerms = PERMISSION_CATEGORIES[category];
    const allSelected = categoryPerms.every((p) => formData.permissions.includes(p));

    if (allSelected) {
      setFormData((prev) => ({
        ...prev,
        permissions: prev.permissions.filter((p) => !categoryPerms.includes(p)),
      }));
    } else {
      setFormData((prev) => ({
        ...prev,
        permissions: [...new Set([...prev.permissions, ...categoryPerms])],
      }));
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();

    if (!formData.role_name || !formData.display_name) {
      toast.error('Please fill in all required fields');
      return;
    }

    onSave({
      ...formData,
      permissions: JSON.stringify(formData.permissions),
    });
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            {role ? `Edit Role: ${role.display_name}` : 'Create New Role'}
          </DialogTitle>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="role_name">Role Name (System ID) *</Label>
              <Input
                id="role_name"
                value={formData.role_name}
                onChange={(e) =>
                  setFormData({ ...formData, role_name: e.target.value.toLowerCase().replace(/\s+/g, '_') })
                }
                placeholder="e.g., senior_agent"
                disabled={role?.is_system_role}
                required
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="display_name">Display Name *</Label>
              <Input
                id="display_name"
                value={formData.display_name}
                onChange={(e) => setFormData({ ...formData, display_name: e.target.value })}
                placeholder="e.g., Senior Agent"
                required
              />
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="description">Description</Label>
            <Textarea
              id="description"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              placeholder="Describe what this role can do..."
              rows={2}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="priority">Priority Level</Label>
              <Input
                id="priority"
                type="number"
                value={formData.priority}
                onChange={(e) => setFormData({ ...formData, priority: parseInt(e.target.value) || 0 })}
                min="0"
                max="100"
              />
              <p className="text-xs text-slate-500">Higher priority = more privileges</p>
            </div>

            <div className="space-y-2">
              <Label>Status</Label>
              <div className="flex items-center gap-2 h-10">
                <Checkbox
                  id="is_active"
                  checked={formData.is_active}
                  onCheckedChange={(checked) => setFormData({ ...formData, is_active: checked })}
                />
                <Label htmlFor="is_active" className="cursor-pointer">
                  Active Role
                </Label>
              </div>
            </div>
          </div>

          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <Label className="text-lg font-semibold">Permissions</Label>
              <Badge variant="secondary">{formData.permissions.length} selected</Badge>
            </div>

            <div className="space-y-4 border rounded-lg p-4 max-h-96 overflow-y-auto">
              {Object.entries(PERMISSION_CATEGORIES).map(([category, permissions]) => {
                const allSelected = permissions.every((p) => formData.permissions.includes(p));
                const someSelected = permissions.some((p) => formData.permissions.includes(p));

                return (
                  <div key={category} className="space-y-2">
                    <div className="flex items-center justify-between pb-2 border-b">
                      <Label className="font-semibold capitalize">{category.replace(/_/g, ' ')}</Label>
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => handleSelectAll(category)}
                      >
                        {allSelected ? 'Deselect All' : 'Select All'}
                      </Button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 pl-4">
                      {permissions.map((permission) => (
                        <div key={permission} className="flex items-center gap-2">
                          <Checkbox
                            id={permission}
                            checked={formData.permissions.includes(permission)}
                            onCheckedChange={() => handlePermissionToggle(permission)}
                            disabled={role?.is_system_role}
                          />
                          <Label
                            htmlFor={permission}
                            className="text-sm cursor-pointer"
                          >
                            {permission.replace(/_/g, ' ')}
                          </Label>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          <div className="flex justify-end gap-3 pt-4 border-t">
            <Button type="button" variant="outline" onClick={onClose}>
              Cancel
            </Button>
            <Button type="submit" disabled={role?.is_system_role}>
              {role ? 'Update Role' : 'Create Role'}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState, useEffect } from 'react';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import { Download, Trash2, Clock, CheckCircle } from 'lucide-react';

export default function SavedImportConfigurations({ onUseConfig }) {
    const [savedConfigs, setSavedConfigs] = useState([]);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        loadConfigurations();
    }, []);

    const loadConfigurations = async () => {
        setIsLoading(true);
        try {
            const user = await base44.auth.me();
            const configs = user.import_configurations ? JSON.parse(user.import_configurations) : [];
            setSavedConfigs(configs);
        } catch (error) {
            console.error('Error loading configurations:', error);
        } finally {
            setIsLoading(false);
        }
    };

    const handleDelete = async (index) => {
        if (!window.confirm('Delete this import configuration?')) return;

        try {
            const user = await base44.auth.me();
            const configs = user.import_configurations ? JSON.parse(user.import_configurations) : [];
            configs.splice(index, 1);
            await base44.auth.updateMe({ import_configurations: JSON.stringify(configs) });
            setSavedConfigs(configs);
            toast.success('Configuration deleted');
        } catch (error) {
            toast.error('Failed to delete configuration');
        }
    };

    const handleUse = (config) => {
        onUseConfig?.(config);
        toast.success(`Using configuration: ${config.name}`);
    };

    if (isLoading) {
        return (
            <Card className="p-4">
                <div className="animate-pulse space-y-3">
                    <div className="h-4 bg-slate-200 rounded w-1/4"></div>
                    <div className="h-20 bg-slate-200 rounded"></div>
                </div>
            </Card>
        );
    }

    if (savedConfigs.length === 0) {
        return (
            <Card className="p-6 text-center">
                <Clock className="w-8 h-8 text-slate-400 mx-auto mb-3" />
                <p className="text-slate-600 dark:text-slate-400 text-sm">
                    No saved import configurations yet. Complete an import to save your configuration.
                </p>
            </Card>
        );
    }

    return (
        <Card className="p-4">
            <h3 className="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <CheckCircle className="w-5 h-5" style={{ color: 'var(--theme-primary)' }} />
                Saved Import Configurations ({savedConfigs.length})
            </h3>
            <div className="space-y-3">
                {savedConfigs.map((config, index) => (
                    <div
                        key={index}
                        className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600 transition-colors"
                    >
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                                <h4 className="font-medium text-slate-900 dark:text-white">{config.name}</h4>
                                <Badge variant="outline" className="text-xs">
                                    {config.crmType || config.importType}
                                </Badge>
                            </div>
                            <p className="text-xs text-slate-500">
                                Entity: {config.entityType} • Fields mapped: {Object.keys(config.fieldMappings?.mappings || {}).length}
                            </p>
                            {config.lastUsed && (
                                <p className="text-xs text-slate-400 mt-1">
                                    Last used: {new Date(config.lastUsed).toLocaleDateString()}
                                </p>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            <Button
                                size="sm"
                                variant="outline"
                                onClick={() => handleUse(config)}
                                className="gap-1"
                            >
                                <Download className="w-3 h-3" />
                                Use
                            </Button>
                            <Button
                                size="sm"
                                variant="ghost"
                                onClick={() => handleDelete(index)}
                                className="text-red-600 hover:text-red-700 hover:bg-red-50"
                            >
                                <Trash2 className="w-3 h-3" />
                            </Button>
                        </div>
                    </div>
                ))}
            </div>
        </Card>
    );
}

// Helper function to save a new import configuration
export async function saveImportConfiguration(config) {
    try {
        const user = await base44.auth.me();
        const configs = user.import_configurations ? JSON.parse(user.import_configurations) : [];
        
        // Add new config
        configs.push({
            ...config,
            createdAt: new Date().toISOString(),
            lastUsed: new Date().toISOString()
        });

        await base44.auth.updateMe({ import_configurations: JSON.stringify(configs) });
        toast.success('Import configuration saved for future use!');
        return true;
    } catch (error) {
        console.error('Error saving configuration:', error);
        toast.error('Failed to save configuration');
        return false;
    }
}

// Helper function to update last used timestamp
export async function updateLastUsed(configName) {
    try {
        const user = await base44.auth.me();
        const configs = user.import_configurations ? JSON.parse(user.import_configurations) : [];
        
        const configIndex = configs.findIndex(c => c.name === configName);
        if (configIndex !== -1) {
            configs[configIndex].lastUsed = new Date().toISOString();
            await base44.auth.updateMe({ import_configurations: JSON.stringify(configs) });
        }
    } catch (error) {
        console.error('Error updating last used:', error);
    }
}
import React, { useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";

export default function ServiceProviderModal({ serviceProvider, onSave, onClose }) {
  const [formData, setFormData] = useState(serviceProvider || {
    company_name: "",
    provider_type: "title_company",
    contact_name: "",
    email: "",
    phone: "",
    address: "",
    website: "",
    services_offered: "",
    pricing_notes: "",
    rating: 0,
    notes: "",
    is_preferred: false,
    is_active: true
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave({
      ...formData,
      rating: parseFloat(formData.rating) || 0
    });
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            {serviceProvider ? "Edit Service Provider" : "Add New Service Provider"}
          </DialogTitle>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="company_name">Company Name *</Label>
              <Input
                id="company_name"
                value={formData.company_name}
                onChange={(e) => setFormData({...formData, company_name: e.target.value})}
                placeholder="ABC Title Company"
                required
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="provider_type">Type *</Label>
              <Select
                value={formData.provider_type}
                onValueChange={(value) => setFormData({...formData, provider_type: value})}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="title_company">Title Company</SelectItem>
                  <SelectItem value="inspection_company">Inspection Company</SelectItem>
                  <SelectItem value="photographer">Photographer</SelectItem>
                  <SelectItem value="staging_company">Staging Company</SelectItem>
                  <SelectItem value="mortgage_lender">Mortgage Lender</SelectItem>
                  <SelectItem value="attorney">Attorney</SelectItem>
                  <SelectItem value="insurance_agent">Insurance Agent</SelectItem>
                  <SelectItem value="contractor">Contractor</SelectItem>
                  <SelectItem value="other">Other</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label htmlFor="contact_name">Contact Person</Label>
              <Input
                id="contact_name"
                value={formData.contact_name}
                onChange={(e) => setFormData({...formData, contact_name: e.target.value})}
                placeholder="Jane Smith"
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                value={formData.email}
                onChange={(e) => setFormData({...formData, email: e.target.value})}
                placeholder="contact@company.com"
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="phone">Phone</Label>
              <Input
                id="phone"
                value={formData.phone}
                onChange={(e) => setFormData({...formData, phone: e.target.value})}
                placeholder="(555) 123-4567"
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="website">Website</Label>
              <Input
                id="website"
                type="url"
                value={formData.website}
                onChange={(e) => setFormData({...formData, website: e.target.value})}
                placeholder="https://www.company.com"
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="rating">Rating (0-5)</Label>
              <Input
                id="rating"
                type="number"
                min="0"
                max="5"
                step="0.5"
                value={formData.rating}
                onChange={(e) => setFormData({...formData, rating: e.target.value})}
                placeholder="4.5"
              />
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="address">Address</Label>
            <Input
              id="address"
              value={formData.address}
              onChange={(e) => setFormData({...formData, address: e.target.value})}
              placeholder="123 Main St, City, State 12345"
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="services_offered">Services Offered</Label>
            <Textarea
              id="services_offered"
              value={formData.services_offered}
              onChange={(e) => setFormData({...formData, services_offered: e.target.value})}
              placeholder="Description of services..."
              rows={2}
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="pricing_notes">Pricing Notes</Label>
            <Textarea
              id="pricing_notes"
              value={formData.pricing_notes}
              onChange={(e) => setFormData({...formData, pricing_notes: e.target.value})}
              placeholder="Pricing information..."
              rows={2}
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="notes">Notes</Label>
            <Textarea
              id="notes"
              value={formData.notes}
              onChange={(e) => setFormData({...formData, notes: e.target.value})}
              placeholder="Additional notes..."
              rows={2}
            />
          </div>

          <div className="space-y-3">
            <div className="flex items-center space-x-2">
              <Checkbox
                id="is_preferred"
                checked={formData.is_preferred}
                onCheckedChange={(checked) => setFormData({...formData, is_preferred: checked})}
              />
              <Label htmlFor="is_preferred" className="text-sm font-medium">
                Preferred Vendor
              </Label>
            </div>

            <div className="flex items-center space-x-2">
              <Checkbox
                id="is_active"
                checked={formData.is_active}
                onCheckedChange={(checked) => setFormData({...formData, is_active: checked})}
              />
              <Label htmlFor="is_active" className="text-sm font-medium">
                Active
              </Label>
            </div>
          </div>

          <div className="flex justify-end gap-3 pt-4 border-t">
            <Button type="button" variant="outline" onClick={onClose}>
              Cancel
            </Button>
            <Button type="submit" className="app-button">
              {serviceProvider ? "Update" : "Create"}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}
// Smart Field Mapping Configuration
// Automatically maps common field name variations to entity fields

export const FIELD_NAME_PATTERNS = {
    // Contact/Person Fields
    name: [
        'name', 'full name', 'fullname', 'contact name', 'person name'
    ],
    first_name: [
        'first name', 'firstname', 'fname', 'first', 'given name'
    ],
    last_name: [
        'last name', 'lastname', 'lname', 'last', 'surname', 'family name'
    ],
    email: [
        'email', 'email address', 'emailaddress', 'e-mail', 'mail',
        'contact email', 'primary email'
    ],
    phone: [
        'phone', 'phone number', 'phonenumber', 'telephone', 'tel'
    ],
    home_phone: [
        'home phone', 'phone home', 'home telephone', 'home number'
    ],
    cell_phone: [
        'cell phone', 'mobile', 'mobile phone', 'cell', 'cellular'
    ],
    
    // Address Fields
    property_address: [
        'address', 'full address', 'fulladdress', 'street address',
        'address - street', 'property address', 'mailing street',
        'mailing address', 'street', 'address1'
    ],
    city: [
        'city', 'address - city', 'mailing city', 'property city', 'town'
    ],
    state: [
        'state', 'st', 'state name', 'address - state', 'mailing state',
        'property state', 'province'
    ],
    zip_code: [
        'zip', 'zip code', 'zipcode', 'postal code', 'postalcode',
        'address - zip', 'mailing zip', 'postcode'
    ],
    
    // Demographics
    date_of_birth: [
        'date of birth', 'dob', 'birthday', 'birth date', 'birthdate'
    ],
    age: [
        'age', 'years old'
    ],
    gender: [
        'gender', 'sex'
    ],
    marital_status: [
        'marital status', 'married', 'marriage status'
    ],
    language: [
        'language', 'primary language', 'spoken language'
    ],
    
    // Financial
    income: [
        'income', 'annual income', 'salary', 'household income'
    ],
    net_worth: [
        'net worth', 'wealth', 'total assets'
    ],
    credit_rating: [
        'credit rating', 'credit score', 'new credit range'
    ],
    
    // Property Info
    home_value: [
        'home value', 'property value', 'current home value', 'house value'
    ],
    mortgage_amount: [
        'mortgage amount', 'mortgage', 'first mortgage amount', 'loan amount'
    ],
    year_built: [
        'year built', 'yearbuilt', 'effective year built', 'construction year'
    ],
    dwelling_type: [
        'dwelling type', 'property type', 'home type', 'residence type'
    ],
    absentee_owner: [
        'absentee owner', 'absentee owner status', 'non-resident owner'
    ],
    
    // Compliance
    dnc_home: [
        'dnc home', 'do not call home', 'home dnc'
    ],
    dnc_cell: [
        'dnc cell', 'do not call cell', 'cell dnc', 'mobile dnc'
    ],
    
    // Property-specific Fields
    bedrooms: [
        'bedrooms', 'beds', 'bedroom', 'property bedrooms', 'bed'
    ],
    bathrooms: [
        'bathrooms', 'baths', 'bathroom', 'property bathrooms', 'bath'
    ],
    square_feet: [
        'square feet', 'sqft', 'sq ft', 'square footage', 'squarefeet',
        'property size', 'lot size'
    ],
    year_built: [
        'year built', 'yearbuilt', 'effective year built', 'built year',
        'construction year'
    ],
    price: [
        'price', 'sale price', 'saleprice', 'sale amount', 'value',
        'home value', 'current home value', 'property value'
    ],
    
    // Additional Contact Fields
    notes: [
        'notes', 'note', 'description', 'comments', 'comment', 'details'
    ],
    tags: [
        'tags', 'tag', 'categories', 'labels'
    ],
    lead_source: [
        'lead source', 'leadsource', 'source', 'origin', 'referral source'
    ],
    industry: [
        'industry', 'occupation', 'profession', 'job title', 'title',
        'company', 'employer'
    ],
    relationship: [
        'relationship', 'relationship type', 'contact type', 'type'
    ]
};

// Custom field mapping for demographic and lifestyle data
export const CUSTOM_FIELD_CATEGORIES = {
    demographics: [
        'age', 'date of birth', 'dob', 'birthday', 'gender', 'marital status',
        'race', 'hispanic', 'language', 'family position', 'family',
        'presence of elderly parent', 'young adult in household',
        'veteran in household', 'working woman'
    ],
    financial: [
        'income', 'net worth', 'wealth rating', 'credit rating',
        'new credit range', 'equity flag', 'mortgage amount',
        'first mortgage amount', 'second mortage amount', 'tax amount',
        'residential properties owned', 'investment type', 'investments'
    ],
    property_details: [
        'dwelling type', 'stories number', 'number of units',
        'subdivision name', 'length of residence', 'absentee owner status',
        'foreclosure', 'refi flag', 'sale date'
    ],
    lifestyle: [
        'baseball', 'basketball', 'boat', 'fishing', 'football', 'golf',
        'gardening', 'health living', 'hobby cooking', 'hobby photography',
        'home decor', 'luxury life', 'reading interior decorating',
        'scuba diving', 'snow skiing', 'soccer', 'travel',
        'collector fine arts'
    ],
    compliance: [
        'dnc home', 'dnc cell', 'federal cell dnc', 'federal dnc',
        'state cell dnc', 'state dnc'
    ]
};

/**
 * Intelligently maps source fields to target entity fields
 */
export function autoMapFields(sourceFields, targetFields) {
    const mappings = {};
    const customFieldMappings = {};
    const sourceFieldsLower = sourceFields.map(f => ({
        original: f,
        lower: f.toLowerCase().trim(),
        normalized: f.toLowerCase().replace(/[^a-z0-9]/g, '')
    }));

    // First pass: Map to standard entity fields
    targetFields.forEach(targetField => {
        const patterns = FIELD_NAME_PATTERNS[targetField.key] || [];
        
        for (const sourceField of sourceFieldsLower) {
            // Check exact matches first
            if (patterns.some(pattern => 
                sourceField.lower === pattern || 
                sourceField.normalized === pattern.replace(/[^a-z0-9]/g, '')
            )) {
                mappings[targetField.key] = sourceField.original;
                break;
            }
            
            // Check partial matches
            if (!mappings[targetField.key] && patterns.some(pattern => 
                sourceField.lower.includes(pattern) || 
                pattern.includes(sourceField.lower)
            )) {
                mappings[targetField.key] = sourceField.original;
                break;
            }
        }
    });

    // Second pass: Map remaining fields to custom fields
    const mappedSourceFields = Object.values(mappings);
    const unmappedFields = sourceFields.filter(sf => !mappedSourceFields.includes(sf));

    unmappedFields.forEach(sourceField => {
        const lowerField = sourceField.toLowerCase().trim();
        let category = 'other';
        
        // Determine category
        for (const [cat, keywords] of Object.entries(CUSTOM_FIELD_CATEGORIES)) {
            if (keywords.some(kw => lowerField.includes(kw) || kw.includes(lowerField))) {
                category = cat;
                break;
            }
        }

        // Create custom field mapping
        const cleanName = sourceField
            .replace(/^custom:\s*/i, '')
            .replace(/^address\s*-\s*/i, '')
            .trim();

        customFieldMappings[sourceField] = {
            name: cleanName,
            key: `custom_${cleanName.toLowerCase().replace(/[^a-z0-9]/g, '_')}`,
            category: category,
            sourceField: sourceField
        };
    });

    return {
        mappings,
        customFieldMappings,
        confidence: calculateMappingConfidence(mappings, targetFields)
    };
}

/**
 * Calculate confidence score for auto-mapping
 */
function calculateMappingConfidence(mappings, targetFields) {
    const requiredFields = targetFields.filter(f => f.required);
    const mappedRequired = requiredFields.filter(f => mappings[f.key]).length;
    const totalMapped = Object.keys(mappings).length;
    
    const requiredScore = requiredFields.length > 0 
        ? (mappedRequired / requiredFields.length) * 0.7 
        : 0.7;
    
    const totalScore = targetFields.length > 0 
        ? (totalMapped / targetFields.length) * 0.3 
        : 0.3;
    
    return Math.round((requiredScore + totalScore) * 100);
}

/**
 * Get suggestions for unmapped fields
 */
export function getSuggestionsForField(sourceField, targetFields, existingMappings) {
    const suggestions = [];
    const lowerSource = sourceField.toLowerCase();
    
    targetFields.forEach(targetField => {
        if (existingMappings[targetField.key]) return; // Already mapped
        
        const patterns = FIELD_NAME_PATTERNS[targetField.key] || [];
        let score = 0;
        
        // Calculate similarity score
        patterns.forEach(pattern => {
            if (lowerSource === pattern) score += 100;
            else if (lowerSource.includes(pattern)) score += 80;
            else if (pattern.includes(lowerSource)) score += 60;
            else {
                // Levenshtein distance for fuzzy matching
                const distance = levenshteinDistance(lowerSource, pattern);
                if (distance < 5) score += Math.max(0, 40 - (distance * 8));
            }
        });
        
        if (score > 0) {
            suggestions.push({
                targetField: targetField.key,
                label: targetField.label,
                score: score,
                required: targetField.required
            });
        }
    });
    
    return suggestions.sort((a, b) => b.score - a.score).slice(0, 3);
}

/**
 * Simple Levenshtein distance for fuzzy string matching
 */
function levenshteinDistance(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    return matrix[str2.length][str1.length];
}

/**
 * Format field name for display
 */
export function formatFieldName(fieldName) {
    return fieldName
        .replace(/^custom:\s*/i, '')
        .replace(/^address\s*-\s*/i, '')
        .replace(/^property\s*/i, '')
        .trim()
        .split(/\s+/)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Crown, CreditCard, Users, Copy, Check, Gift } from "lucide-react";
import SubscriptionUpgradeModal from "./SubscriptionUpgradeModal";
import PaymentMethodModal from "./PaymentMethodModal";
import { Skeleton } from "@/components/ui/skeleton";

export default function SubscriptionSettings() {
    const [subscription, setSubscription] = useState(null);
    const [paymentHistory, setPaymentHistory] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [showUpgradeModal, setShowUpgradeModal] = useState(false);
    const [showPaymentModal, setShowPaymentModal] = useState(false);
    const [user, setUser] = useState(null);
    const [referrals, setReferrals] = useState([]);
    const [referralCode, setReferralCode] = useState('');
    const [copiedCode, setCopiedCode] = useState(false);
    const [currentPlanDetails, setCurrentPlanDetails] = useState(null);

    useEffect(() => {
        loadInitialData();
    }, []);

    const loadInitialData = async () => {
        setIsLoading(true);
        try {
            const currentUser = await base44.auth.me();
            setUser(currentUser);

            const [allSubscriptions, payments, userReferrals, allPlans] = await Promise.all([
                base44.entities.Subscription.list().catch(() => []),
                base44.entities.PaymentRecord.list('-payment_date').catch(() => []),
                base44.entities.Referral.filter({ referrer_user_id: currentUser.id }).catch(() => []),
                base44.entities.SubscriptionPlan.list().catch(() => [])
            ]);

            // Get only the user's active subscription
            const userActiveSubscriptions = allSubscriptions.filter(s => 
                s.user_id === currentUser.id && s.status === 'active'
            );

            if (userActiveSubscriptions.length > 0) {
                const currentSub = userActiveSubscriptions[0];
                setSubscription(currentSub);
                
                // Find matching plan details by tier_level (most reliable)
                let planDetails = allPlans.find(p => p.tier_level === currentSub.tier_level);
                
                // Fallback: try matching by name
                if (!planDetails) {
                    planDetails = allPlans.find(p => 
                        p.name.toLowerCase() === currentSub.name?.toLowerCase() ||
                        p.name.toLowerCase() === currentSub.plan_type?.toLowerCase()
                    );
                }
                
                setCurrentPlanDetails(planDetails);
            }
            setPaymentHistory(payments.filter(p => p.user_id === currentUser.id));
            setReferrals(userReferrals);
            
            // Generate referral code (using user ID)
            const code = `REALTY${currentUser.id.substring(0, 8).toUpperCase()}`;
            setReferralCode(code);
        } catch (error) {
            toast.error("Failed to load subscription data.");
        } finally {
            setIsLoading(false);
        }
    };

    const calculateReferralDiscount = () => {
        if (!subscription) return 0;
        
        const activeReferrals = referrals.filter(r => r.status === 'active').length;
        const discountPerReferral = 10;
        const totalDiscount = activeReferrals * discountPerReferral;
        const maxDiscount = subscription.price * 0.5;
        
        return Math.min(totalDiscount, maxDiscount);
    };

    const copyReferralLink = () => {
        const link = `${window.location.origin}?ref=${referralCode}`;
        navigator.clipboard.writeText(link);
        setCopiedCode(true);
        toast.success("Referral link copied!");
        setTimeout(() => setCopiedCode(false), 2000);
    };
    
    if (isLoading) {
        return (
            <div className="space-y-8">
                <Card>
                    <CardHeader><Skeleton className="h-6 w-2/3" /></CardHeader>
                    <CardContent className="space-y-4">
                        <Skeleton className="h-4 w-full" />
                        <Skeleton className="h-10 w-full" />
                    </CardContent>
                </Card>
                <Card>
                    <CardHeader><Skeleton className="h-6 w-1/2" /></CardHeader>
                    <CardContent className="space-y-3">
                        <Skeleton className="h-8 w-full" />
                        <Skeleton className="h-8 w-full" />
                        <Skeleton className="h-10 w-full mt-2" />
                    </CardContent>
                </Card>
            </div>
        )
    }

    const referralDiscount = calculateReferralDiscount();
    const activeReferralsCount = referrals.filter(r => r.status === 'active').length;
    const finalPrice = subscription ? Math.max(subscription.price - referralDiscount, 0) : 0;

    return (
        <div className="space-y-8">
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center justify-between">
                        <div className="flex items-center gap-2"><Crown className="w-5 h-5 text-purple-600" /> Your Plan</div>
                        {subscription && (
                            <div className="flex items-center gap-3">
                                {referralDiscount > 0 && (
                                    <div className="text-right">
                                        <div className="text-sm font-semibold text-purple-600 mb-1">
                                            {currentPlanDetails?.name || subscription.name || subscription.plan_type}
                                        </div>
                                        <div className="text-sm line-through text-slate-400">${subscription.price}</div>
                                        <div className="text-lg font-bold text-green-600">${finalPrice}/mo</div>
                                    </div>
                                )}
                                {referralDiscount === 0 && (
                                    <span className="text-lg font-bold text-purple-600">{currentPlanDetails?.name || subscription.name || subscription.plan_type}</span>
                                )}
                            </div>
                        )}
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    {subscription ? (
                        <>
                            {referralDiscount > 0 && (
                                <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                                    <div className="flex items-center gap-2 text-green-700 dark:text-green-400 mb-2">
                                        <Crown className="w-4 h-4" />
                                        <span className="font-semibold">Referral Discount Active</span>
                                    </div>
                                    <p className="text-sm text-green-600 dark:text-green-300">
                                        You're saving ${referralDiscount}/month from {activeReferralsCount} active referral{activeReferralsCount !== 1 ? 's' : ''}!
                                        {referralDiscount >= subscription.price * 0.5 && ' (Maximum 50% discount reached)'}
                                    </p>
                                </div>
                            )}
                            <p className="text-sm text-slate-500">
                                Your {currentPlanDetails?.name || subscription.name || subscription.plan_type} plan (Tier {subscription.tier_level}) is currently {subscription.status}.
                                {subscription.status === 'active' && subscription.end_date && ` It will renew on ${new Date(subscription.end_date).toLocaleDateString()}.`}
                                {subscription.status === 'trial' && subscription.trial_end_date && ` Your trial ends on ${new Date(subscription.trial_end_date).toLocaleDateString()}.`}
                            </p>
                            <div className="flex flex-col sm:flex-row gap-2">
                                 <Button className="w-full" onClick={() => setShowUpgradeModal(true)}>Upgrade Plan</Button>
                                 <Button variant="outline" className="w-full">Cancel Plan</Button>
                            </div>
                        </>
                    ) : (
                        <>
                            <div className="text-center py-6 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg">
                                <Crown className="w-10 h-10 text-slate-400 mx-auto mb-3" />
                                <p className="text-lg font-semibold text-slate-700 dark:text-slate-300">No Active Subscription</p>
                                <p className="text-sm text-slate-500 dark:text-slate-400 mt-1 mb-4">Choose a plan to unlock all features</p>
                                <Button onClick={() => setShowUpgradeModal(true)}>View Plans & Subscribe</Button>
                            </div>
                        </>
                    )}
                </CardContent>
            </Card>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Gift className="w-5 h-5 text-green-600" />
                        Refer Friends & Save
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    <p className="text-sm text-slate-600 dark:text-slate-400">
                        Get <strong className="text-green-600">$10/month off</strong> for every active user you refer, up to 50% of your subscription cost!
                    </p>
                    
                    <div className="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 border border-slate-200 dark:border-slate-700">
                        <label className="text-xs font-medium text-slate-600 dark:text-slate-400 mb-2 block">Your Referral Link</label>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={`${window.location.origin}?ref=${referralCode}`}
                                readOnly
                                className="flex-1 px-3 py-2 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-md text-sm"
                            />
                            <Button onClick={copyReferralLink} size="sm" variant="outline">
                                {copiedCode ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                            </Button>
                        </div>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                            Code: <strong>{referralCode}</strong>
                        </p>
                    </div>

                    {referrals.length > 0 && (
                        <div>
                            <h4 className="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                                <Users className="w-4 h-4" />
                                Your Referrals ({activeReferralsCount} Active)
                            </h4>
                            <div className="space-y-2 max-h-48 overflow-y-auto">
                                {referrals.map(referral => (
                                    <div key={referral.id} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700">
                                        <div>
                                            <p className="text-sm font-medium text-slate-900 dark:text-white">
                                                {referral.referred_user_name || referral.referred_email}
                                            </p>
                                            <p className="text-xs text-slate-500 dark:text-slate-400">
                                                {referral.activation_date ? `Active since ${new Date(referral.activation_date).toLocaleDateString()}` : 'Pending activation'}
                                            </p>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {referral.status === 'active' && (
                                                <>
                                                    <span className="text-xs font-semibold text-green-600 dark:text-green-400">-$10/mo</span>
                                                    <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                                </>
                                            )}
                                            {referral.status === 'pending' && (
                                                <span className="text-xs text-amber-600 dark:text-amber-400">Pending</span>
                                            )}
                                            {referral.status === 'inactive' && (
                                                <span className="text-xs text-slate-400">Inactive</span>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {referrals.length === 0 && (
                        <div className="text-center py-6 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg">
                            <Users className="w-8 h-8 text-slate-400 mx-auto mb-2" />
                            <p className="text-sm text-slate-600 dark:text-slate-400">No referrals yet</p>
                            <p className="text-xs text-slate-500 dark:text-slate-500 mt-1">Share your link to start saving!</p>
                        </div>
                    )}
                </CardContent>
            </Card>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2"><CreditCard className="w-5 h-5 text-blue-600" />Payment History</CardTitle>
                </CardHeader>
                <CardContent>
                    {paymentHistory.length > 0 ? (
                        <ul className="space-y-3">
                            {paymentHistory.slice(0, 3).map(payment => (
                                <li key={payment.id} className="flex justify-between items-center text-sm">
                                    <div>
                                        <p className="font-medium">{payment.description || `Payment for ${subscription?.plan_type} plan`}</p>
                                        <p className="text-xs text-slate-500">{new Date(payment.payment_date).toLocaleDateString()}</p>
                                    </div>
                                    <div className="font-semibold text-slate-800 dark:text-slate-200">
                                        ${payment.amount.toFixed(2)}
                                    </div>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p className="text-sm text-slate-500">No payment history found.</p>
                    )}
                     <Button variant="outline" size="sm" className="w-full mt-4" onClick={() => setShowPaymentModal(true)}>
                        Update Payment Method
                    </Button>
                </CardContent>
            </Card>

            {showUpgradeModal && <SubscriptionUpgradeModal onClose={() => setShowUpgradeModal(false)} />}
            {showPaymentModal && <PaymentMethodModal onClose={() => setShowPaymentModal(false)} />}
        </div>
    );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Badge } from "@/components/ui/badge";
import { CheckCircle2, Crown } from "lucide-react";
import { toast } from "sonner";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { clearSubscriptionCache } from '../utils/subscriptionLimits';

export default function SubscriptionUpgradeModal({ currentPlan, onUpgrade, onClose }) {
  const queryClient = useQueryClient();
  const [selectedPlan, setSelectedPlan] = useState(currentPlan);
  const [billingCycle, setBillingCycle] = useState('monthly');
  const [isProcessing, setIsProcessing] = useState(false);
  const [currentUserPlan, setCurrentUserPlan] = useState(null);

  const { data: subscriptionPlans = [], isLoading } = useQuery({
    queryKey: ['subscriptionPlans'],
    queryFn: () => base44.entities.SubscriptionPlan.list(),
  });

  // Load current user's subscription
  useEffect(() => {
    const loadCurrentPlan = async () => {
      try {
        const user = await base44.auth.me();
        const subs = await base44.entities.Subscription.filter({ user_id: user.id });
        if (subs.length > 0) {
          setCurrentUserPlan(subs[0]);
        }
      } catch (error) {
        console.error("Error loading current plan:", error);
      }
    };
    loadCurrentPlan();
  }, []);

  const handleUpgrade = async () => {
    if (selectedPlan === currentPlan) {
      toast.error("Please select a different plan");
      return;
    }

    setIsProcessing(true);
    try {
      const user = await base44.auth.me();
      const allSubs = await base44.entities.Subscription.list();
      const subs = allSubs.filter(s => s.user_id === user.id && s.status === 'active');
      const planDetails = subscriptionPlans.find(p => p.id === selectedPlan);
      
      if (!planDetails) {
        toast.error("Plan not found");
        return;
      }

      const price = billingCycle === 'monthly' 
        ? planDetails.price 
        : planDetails.price * 10; // 20% discount for annual

      const subscriptionData = {
        user_id: user.id,
        plan_type: planDetails.name.toLowerCase(),
        name: planDetails.name,
        tier_level: planDetails.tier_level,
        status: 'active',
        billing_cycle: billingCycle,
        price: price,
        features: planDetails.features,
        limits: planDetails.limits,
        start_date: new Date().toISOString().split('T')[0],
        end_date: new Date(Date.now() + (billingCycle === 'monthly' ? 30 : 365) * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
      };

      let subscriptionId;
      
      if (subs.length > 0) {
        // Update first active subscription
        await base44.entities.Subscription.update(subs[0].id, subscriptionData);
        subscriptionId = subs[0].id;
        
        // Deactivate any other duplicate subscriptions
        for (let i = 1; i < subs.length; i++) {
          await base44.entities.Subscription.update(subs[i].id, { status: 'cancelled' });
        }
      } else {
        // Create new subscription
        const newSub = await base44.entities.Subscription.create(subscriptionData);
        subscriptionId = newSub.id;
      }

      // Create payment record
      await base44.entities.PaymentRecord.create({
        user_id: user.id,
        subscription_id: subscriptionId,
        amount: price,
        payment_date: new Date().toISOString(),
        payment_method: 'credit_card',
        status: 'completed',
        description: `${planDetails.name} Plan - ${billingCycle}`
      });

      // Clear subscription cache and invalidate queries
      clearSubscriptionCache();
      queryClient.invalidateQueries({ queryKey: ['subscriptionFeatures'] });
      queryClient.invalidateQueries({ queryKey: ['user'] });
      queryClient.invalidateQueries({ queryKey: ['dashboardData'] });
      
      toast.success("Plan upgraded successfully! Refreshing...");
      if (onUpgrade) onUpgrade();
      onClose();
      
      // Force page reload to ensure all caches are cleared
      setTimeout(() => {
        window.location.reload();
      }, 500);
    } catch (error) {
      console.error("Error upgrading plan:", error);
      toast.error("Failed to upgrade plan");
    }
    setIsProcessing(false);
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Crown className="w-6 h-6 text-amber-500" />
            Upgrade Your Plan
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-6">
          {/* Billing Cycle Toggle */}
          <div className="flex justify-center gap-4">
            <Button
              variant={billingCycle === 'monthly' ? 'default' : 'outline'}
              onClick={() => setBillingCycle('monthly')}
            >
              Monthly
            </Button>
            <Button
              variant={billingCycle === 'annual' ? 'default' : 'outline'}
              onClick={() => setBillingCycle('annual')}
              className="relative"
            >
              Annual
              <Badge className="absolute -top-2 -right-2 bg-green-600">Save 20%</Badge>
            </Button>
          </div>

          {isLoading ? (
            <div className="flex justify-center py-12">
              <div className="animate-spin w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full"></div>
            </div>
          ) : (
            <RadioGroup value={selectedPlan} onValueChange={setSelectedPlan}>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {subscriptionPlans
                  .sort((a, b) => a.tier_level - b.tier_level)
                  .map((plan) => {
                    const features = JSON.parse(plan.features || '[]');
                    const annualPrice = Math.round(plan.price * 10);
                    const isCurrentPlan = currentUserPlan && (
                      plan.id === currentUserPlan.plan_type || 
                      plan.name.toLowerCase() === currentUserPlan.plan_type?.toLowerCase() ||
                      plan.tier_level === currentUserPlan.tier_level
                    );
                    
                    return (
                      <div
                        key={plan.id}
                        className={`relative p-6 border-2 rounded-lg cursor-pointer transition-all ${
                          isCurrentPlan
                            ? 'border-green-500 bg-green-50/50 dark:bg-green-900/20'
                            : selectedPlan === plan.id
                              ? 'border-indigo-500 bg-indigo-50/50 dark:bg-indigo-900/20'
                              : 'border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600'
                        }`}
                        onClick={() => setSelectedPlan(plan.id)}
                      >
                        <RadioGroupItem value={plan.id} id={plan.id} className="absolute top-4 right-4" />
                        
                        {isCurrentPlan && (
                          <Badge className="mb-3 bg-gradient-to-r from-green-500 to-emerald-500">
                            <CheckCircle2 className="w-3 h-3 mr-1" /> Current Plan
                          </Badge>
                        )}
                        
                        {!isCurrentPlan && plan.tier_level === 3 && (
                          <Badge className="mb-3 bg-gradient-to-r from-amber-500 to-orange-500">
                            ⭐ Most Popular
                          </Badge>
                        )}
                        
                        {!isCurrentPlan && plan.tier_level === 4 && (
                          <Badge className="mb-3 bg-gradient-to-r from-purple-500 to-pink-500">
                            <Crown className="w-3 h-3 mr-1" /> Enterprise
                          </Badge>
                        )}
                        
                        <h3 className="text-xl font-bold mb-1">{plan.name}</h3>
                        <p className="text-xs text-slate-600 dark:text-slate-400 mb-4">{plan.description}</p>
                        
                        <div className="mb-4">
                          <span className="text-3xl font-bold">
                            ${billingCycle === 'monthly' ? plan.price : annualPrice}
                          </span>
                          <span className="text-slate-600 dark:text-slate-400">
                            /{billingCycle === 'monthly' ? 'mo' : 'yr'}
                          </span>
                        </div>
                        
                        <ul className="space-y-2 max-h-48 overflow-y-auto">
                          {features.slice(0, 6).map((feature, idx) => (
                            <li key={idx} className="flex items-start gap-2 text-xs">
                              <CheckCircle2 className="w-3 h-3 text-green-600 flex-shrink-0 mt-0.5" />
                              <span>{feature}</span>
                            </li>
                          ))}
                          {features.length > 6 && (
                            <li className="text-xs text-slate-500 dark:text-slate-400 italic">
                              +{features.length - 6} more features...
                            </li>
                          )}
                        </ul>
                      </div>
                    );
                  })}
              </div>
            </RadioGroup>
          )}

          <div className="flex justify-end gap-3 pt-4 border-t">
            <Button variant="outline" onClick={onClose} disabled={isProcessing}>
              Cancel
            </Button>
            <Button
              onClick={handleUpgrade}
              disabled={isProcessing || selectedPlan === currentPlan}
              className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"
            >
              {isProcessing ? "Processing..." : "Upgrade Plan"}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState, useEffect } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Trash2, Plus, GripVertical } from 'lucide-react';
import { DragDropContext, Droppable, Draggable } from "@hello-pangea/dnd";
import { toast } from 'sonner';

const priorityOptions = ["critical", "high", "medium", "low"];
const taskTypeOptions = ["contract", "inspection", "financing", "marketing", "documentation", "closing", "general"];

export default function TaskPackageConfigModal({ isOpen, onClose, packageData }) {
    const queryClient = useQueryClient();
    const [name, setName] = useState('');
    const [description, setDescription] = useState('');
    const [packageType, setPackageType] = useState('listing');
    const [tasks, setTasks] = useState([]);
    
    useEffect(() => {
        if (packageData) {
            setName(packageData.name || '');
            setDescription(packageData.description || '');
            setPackageType(packageData.package_type || 'listing');
            setTasks(packageData.tasks || []);
        } else {
            // Reset to default for new package
            setName('');
            setDescription('');
            setPackageType('listing');
            setTasks([{ title: '', description: '', task_type: 'general', priority: 'medium', due_date_offset_days: 0 }]);
        }
    }, [packageData, isOpen]);

    const mutation = useMutation({
        mutationFn: (newPackageData) => {
            if (packageData && packageData.id) {
                return base44.entities.TaskPackage.update(packageData.id, newPackageData);
            }
            return base44.entities.TaskPackage.create(newPackageData);
        },
        onSuccess: () => {
            toast.success(`Task Package ${packageData ? 'updated' : 'created'} successfully!`);
            queryClient.invalidateQueries(['taskPackages']);
            onClose();
        },
        onError: (error) => {
            toast.error(`Failed to save package: ${error.message}`);
        }
    });

    const handleTaskChange = (index, field, value) => {
        const newTasks = [...tasks];
        newTasks[index][field] = value;
        setTasks(newTasks);
    };

    const handleAddTask = () => {
        setTasks([...tasks, { title: '', description: '', task_type: 'general', priority: 'medium', due_date_offset_days: 0 }]);
    };

    const handleRemoveTask = (index) => {
        if (tasks.length > 1) {
            const newTasks = tasks.filter((_, i) => i !== index);
            setTasks(newTasks);
        } else {
            toast.info("A package must have at least one task.");
        }
    };

    const handleDragEnd = (result) => {
        if (!result.destination) return;
        const items = Array.from(tasks);
        const [reorderedItem] = items.splice(result.source.index, 1);
        items.splice(result.destination.index, 0, reorderedItem);
        setTasks(items);
    };

    const handleSubmit = () => {
        if (!name || !packageType) {
            toast.error("Package name and type are required.");
            return;
        }
        if (tasks.some(t => !t.title)) {
            toast.error("All tasks must have a title.");
            return;
        }

        mutation.mutate({ name, description, package_type: packageType, tasks });
    };

    return (
        <Dialog open={isOpen} onOpenChange={onClose}>
            <DialogContent className="max-w-4xl max-h-[90vh] flex flex-col">
                <DialogHeader>
                    <DialogTitle>{packageData ? 'Edit' : 'Create'} Task Package</DialogTitle>
                    <DialogDescription>
                        Design an automated checklist of tasks for your transactions.
                    </DialogDescription>
                </DialogHeader>
                
                <div className="flex-grow overflow-y-auto pr-4 space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <Label htmlFor="name">Package Name</Label>
                            <Input id="name" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g., Luxury Listing Checklist" />
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="packageType">Package For</Label>
                            <Select value={packageType} onValueChange={setPackageType}>
                                <SelectTrigger>
                                    <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="listing">Listing Side</SelectItem>
                                    <SelectItem value="buyer">Buyer Side</SelectItem>
                                    <SelectItem value="universal">Universal</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="description">Description</Label>
                        <Textarea id="description" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="e.g., For listings over $1M that require special marketing tasks." />
                    </div>

                    <div className="space-y-4">
                        <Label className="text-lg font-semibold">Tasks</Label>
                        <DragDropContext onDragEnd={handleDragEnd}>
                            <Droppable droppableId="tasks">
                                {(provided) => (
                                    <div {...provided.droppableProps} ref={provided.innerRef} className="space-y-3">
                                        {tasks.map((task, index) => (
                                            <Draggable key={index} draggableId={`task-${index}`} index={index}>
                                                {(provided) => (
                                                    <div ref={provided.innerRef} {...provided.draggableProps} className="p-4 border rounded-lg bg-slate-50 dark:bg-slate-800 flex gap-4 items-start">
                                                        <div {...provided.dragHandleProps} className="pt-3 cursor-grab">
                                                            <GripVertical className="w-5 h-5 text-slate-400" />
                                                        </div>
                                                        <div className="flex-grow space-y-4">
                                                            <Input placeholder="Task Title (e.g., 'Order Photos')" value={task.title} onChange={(e) => handleTaskChange(index, 'title', e.target.value)} />
                                                            <Textarea placeholder="Task Description (optional)" value={task.description} onChange={(e) => handleTaskChange(index, 'description', e.target.value)} rows={2} />
                                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                                <Select value={task.task_type} onValueChange={(v) => handleTaskChange(index, 'task_type', v)}>
                                                                    <SelectTrigger><SelectValue placeholder="Type" /></SelectTrigger>
                                                                    <SelectContent>{taskTypeOptions.map(o => <SelectItem key={o} value={o}>{o}</SelectItem>)}</SelectContent>
                                                                </Select>
                                                                <Select value={task.priority} onValueChange={(v) => handleTaskChange(index, 'priority', v)}>
                                                                    <SelectTrigger><SelectValue placeholder="Priority" /></SelectTrigger>
                                                                    <SelectContent>{priorityOptions.map(o => <SelectItem key={o} value={o}>{o}</SelectItem>)}</SelectContent>
                                                                </Select>
                                                                <Input type="number" placeholder="Due After (Days)" value={task.due_date_offset_days} onChange={(e) => handleTaskChange(index, 'due_date_offset_days', parseInt(e.target.value) || 0)} />
                                                            </div>
                                                        </div>
                                                        <Button variant="ghost" size="icon" onClick={() => handleRemoveTask(index)}>
                                                            <Trash2 className="w-4 h-4 text-red-500" />
                                                        </Button>
                                                    </div>
                                                )}
                                            </Draggable>
                                        ))}
                                        {provided.placeholder}
                                    </div>
                                )}
                            </Droppable>
                        </DragDropContext>
                        <Button variant="outline" onClick={handleAddTask}>
                            <Plus className="w-4 h-4 mr-2" /> Add Task
                        </Button>
                    </div>
                </div>

                <DialogFooter className="mt-auto pt-4 border-t">
                    <Button variant="outline" onClick={onClose}>Cancel</Button>
                    <Button onClick={handleSubmit} disabled={mutation.isLoading}>
                        {mutation.isLoading ? 'Saving...' : (packageData ? 'Update Package' : 'Create Package')}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}
import React, { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Plus, Trash2, Loader2 } from 'lucide-react';

const PACKAGE_TYPES = ["listing", "buyer", "universal"];
const TASK_TYPES = ["contract", "inspection", "financing", "marketing", "documentation", "closing", "general"];
const PRIORITIES = ["critical", "high", "medium", "low"];

export default function TaskPackageModal({ taskPackage, onSave, onClose, isSaving }) {
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    package_type: 'listing',
    tasks: []
  });

  useEffect(() => {
    if (taskPackage) {
      setFormData({
        name: taskPackage.name || '',
        description: taskPackage.description || '',
        package_type: taskPackage.package_type || 'listing',
        tasks: taskPackage.tasks || []
      });
    }
  }, [taskPackage]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSelectChange = (name, value) => {
    setFormData(prev => ({ ...prev, [name]: value }));
  };
  
  const handleTaskChange = (index, field, value) => {
      const newTasks = [...formData.tasks];
      newTasks[index][field] = value;
      setFormData(prev => ({ ...prev, tasks: newTasks }));
  };

  const addTask = () => {
      setFormData(prev => ({
          ...prev,
          tasks: [...prev.tasks, { title: '', description: '', task_type: 'general', priority: 'medium', due_date_offset_days: 0 }]
      }));
  };

  const removeTask = (index) => {
      const newTasks = formData.tasks.filter((_, i) => i !== index);
      setFormData(prev => ({ ...prev, tasks: newTasks }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData);
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-2xl">
        <DialogHeader>
          <DialogTitle>{taskPackage ? 'Edit Checklist' : 'Create New Checklist'}</DialogTitle>
          <DialogDescription>
            {taskPackage ? 'Update the details for this checklist.' : 'Create a new reusable checklist template.'}
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4 py-4 max-h-[70vh] overflow-y-auto pr-4">
          <div className="space-y-2">
            <Label htmlFor="name">Checklist Name</Label>
            <Input id="name" name="name" value={formData.name} onChange={handleChange} required />
          </div>
          <div className="space-y-2">
            <Label htmlFor="description">Description</Label>
            <Textarea id="description" name="description" value={formData.description} onChange={handleChange} />
          </div>
          <div className="space-y-2">
            <Label htmlFor="package_type">Checklist Type</Label>
            <Select name="package_type" value={formData.package_type} onValueChange={(value) => handleSelectChange('package_type', value)}>
              <SelectTrigger>
                <SelectValue placeholder="Select a type" />
              </SelectTrigger>
              <SelectContent>
                {PACKAGE_TYPES.map(type => (
                  <SelectItem key={type} value={type}>{type.charAt(0).toUpperCase() + type.slice(1)}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          
          <div className="space-y-4 pt-4 border-t">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-medium">Tasks</h3>
                <Button type="button" variant="outline" size="sm" onClick={addTask}><Plus className="w-4 h-4 mr-2" /> Add Task</Button>
              </div>
              {formData.tasks.map((task, index) => (
                  <div key={index} className="p-4 border rounded-lg space-y-3 relative">
                      <Button type="button" variant="ghost" size="icon" className="absolute top-2 right-2" onClick={() => removeTask(index)}><Trash2 className="w-4 h-4 text-red-500" /></Button>
                      <div className="space-y-2">
                          <Label>Title</Label>
                          <Input value={task.title} onChange={e => handleTaskChange(index, 'title', e.target.value)} placeholder="e.g., 'Order yard sign'" required/>
                      </div>
                      <div className="space-y-2">
                          <Label>Due Date Offset (Days)</Label>
                          <Input type="number" value={task.due_date_offset_days} onChange={e => handleTaskChange(index, 'due_date_offset_days', parseInt(e.target.value) || 0)} placeholder="Days from transaction start"/>
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-2">
                              <Label>Type</Label>
                              <Select value={task.task_type} onValueChange={value => handleTaskChange(index, 'task_type', value)}>
                                  <SelectTrigger><SelectValue/></SelectTrigger>
                                  <SelectContent>{TASK_TYPES.map(t => <SelectItem key={t} value={t}>{t.charAt(0).toUpperCase() + t.slice(1)}</SelectItem>)}</SelectContent>
                              </Select>
                          </div>
                          <div className="space-y-2">
                              <Label>Priority</Label>
                              <Select value={task.priority} onValueChange={value => handleTaskChange(index, 'priority', value)}>
                                  <SelectTrigger><SelectValue/></SelectTrigger>
                                  <SelectContent>{PRIORITIES.map(p => <SelectItem key={p} value={p}>{p.charAt(0).toUpperCase() + p.slice(1)}</SelectItem>)}</SelectContent>
                              </Select>
                          </div>
                      </div>
                  </div>
              ))}
          </div>

          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose}>Cancel</Button>
            <Button type="submit" disabled={isSaving}>
              {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              {isSaving ? 'Saving...' : 'Save Checklist'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";

export default function TaskTemplateModal({ template, onSave, onClose }) {
  const [formData, setFormData] = useState(template || {
    name: "",
    description: "",
    category: "general",
    transaction_type: "sale",
    tasks: [],
    is_active: true
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData);
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>
            {template ? "Edit Task Template" : "Create New Task Template"}
          </DialogTitle>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="name">Template Name *</Label>
            <Input
              id="name"
              value={formData.name}
              onChange={(e) => setFormData({...formData, name: e.target.value})}
              placeholder="Standard Transaction Checklist"
              required
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="category">Category *</Label>
              <Select
                value={formData.category}
                onValueChange={(value) => setFormData({...formData, category: value})}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="listing">Listing</SelectItem>
                  <SelectItem value="contract">Contract</SelectItem>
                  <SelectItem value="inspection">Inspection</SelectItem>
                  <SelectItem value="financing">Financing</SelectItem>
                  <SelectItem value="closing">Closing</SelectItem>
                  <SelectItem value="marketing">Marketing</SelectItem>
                  <SelectItem value="general">General</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label htmlFor="transaction_type">Transaction Type</Label>
              <Select
                value={formData.transaction_type}
                onValueChange={(value) => setFormData({...formData, transaction_type: value})}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="sale">Sale</SelectItem>
                  <SelectItem value="lease">Lease</SelectItem>
                  <SelectItem value="both">Both</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="description">Description</Label>
            <Textarea
              id="description"
              value={formData.description}
              onChange={(e) => setFormData({...formData, description: e.target.value})}
              placeholder="Describe what this template is for..."
              rows={3}
            />
          </div>

          <div className="flex items-center space-x-2">
            <Checkbox
              id="is_active"
              checked={formData.is_active}
              onCheckedChange={(checked) => setFormData({...formData, is_active: checked})}
            />
            <Label htmlFor="is_active" className="text-sm font-medium">
              Active
            </Label>
          </div>

          <div className="flex justify-end gap-3 pt-4 border-t">
            <Button type="button" variant="outline" onClick={onClose}>
              Cancel
            </Button>
            <Button type="submit" className="app-button">
              {template ? "Update" : "Create"}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState } from "react";
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from "@/api/base44Client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Users, Plus, Search, Edit, Trash2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import TeamMemberModal from "./TeamMemberModal";
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Skeleton } from "@/components/ui/skeleton";

export default function TeamManagement() {
  const queryClient = useQueryClient();
  const [searchTerm, setSearchTerm] = useState("");
  const [showModal, setShowModal] = useState(false);
  const [editingMember, setEditingMember] = useState(null);

  const { data: teamData, isLoading } = useQuery({
    queryKey: ['allTeamMembersForManagement'],
    queryFn: async () => {
      const [members, transactions] = await Promise.all([
        base44.entities.TeamMember.list('-created_date').catch(() => []),
        base44.entities.Transaction.list().catch(() => []),
      ]);
      return { members: members || [], transactions: transactions || [] };
    }
  });

  const { members = [], transactions = [] } = teamData || {};

  const calculatePerformanceMetrics = (memberId, memberEmail) => {
    const memberTransactions = transactions.filter(t => 
        t.listing_agent_id === memberId || 
        t.selling_agent_id === memberId ||
        (t.selling_agent_email && memberEmail && t.selling_agent_email.toLowerCase() === memberEmail.toLowerCase())
    );
    const closedDeals = memberTransactions.filter(t => t.status === 'closed');
    const totalRevenue = closedDeals.reduce((sum, t) => {
      let revenue = 0;
      if (t.listing_agent_id === memberId) revenue += t.listing_net_commission || 0;
      if (t.selling_agent_id === memberId || (t.selling_agent_email && memberEmail && t.selling_agent_email.toLowerCase() === memberEmail.toLowerCase())) revenue += t.selling_net_commission || 0;
      return sum + revenue;
    }, 0);
    return { deals: closedDeals.length, revenue: totalRevenue };
  };

  const filteredMembers = (members || []).filter(member =>
    member.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    member.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    member.role?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const saveMutation = useMutation({
    mutationFn: (memberData) => editingMember ? base44.entities.TeamMember.update(editingMember.id, memberData) : base44.entities.TeamMember.create(memberData),
    onSuccess: () => {
      toast.success(`Team member ${editingMember ? 'updated' : 'added'} successfully!`);
      queryClient.invalidateQueries({ queryKey: ['allTeamMembersForManagement'] });
      setShowModal(false);
      setEditingMember(null);
    },
    onError: (error) => toast.error(`Failed to save team member: ${error.message}`),
  });

  const deleteMutation = useMutation({
    mutationFn: (memberId) => base44.entities.TeamMember.delete(memberId),
    onSuccess: () => {
      toast.success("Team member removed successfully!");
      queryClient.invalidateQueries({ queryKey: ['allTeamMembersForManagement'] });
    },
    onError: (error) => toast.error(`Failed to remove team member: ${error.message}`),
  });
  
  const handleEdit = (member) => {
    setEditingMember(member);
    setShowModal(true);
  };

  const handleDelete = (memberId) => {
    if (window.confirm("Are you sure you want to remove this team member? This will not delete their user account but will remove them from your team statistics.")) {
      deleteMutation.mutate(memberId);
    }
  };
  
  const getRoleColor = (role) => {
    const colors = {
      broker: "bg-purple-100 text-purple-700 border-purple-200",
      listing_agent: "bg-blue-100 text-blue-700 border-blue-200",
      selling_agent: "bg-green-100 text-green-700 border-green-200",
      admin: "bg-red-100 text-red-700 border-red-200",
      assistant: "bg-gray-100 text-gray-700 border-gray-200",
      transaction_coordinator: "bg-amber-100 text-amber-700 border-amber-200",
      team_member: "bg-indigo-100 text-indigo-700 border-indigo-200"
    };
    return colors[role] || colors.team_member;
  };
  
  const SkeletonLoader = () => (
    <div className="divide-y divide-slate-200 dark:divide-slate-700">
      {[...Array(3)].map((_, i) => (
        <div key={i} className="flex items-center justify-between py-4">
          <div className="flex items-center gap-4">
            <Skeleton className="h-12 w-12 rounded-full" />
            <div className="space-y-2">
              <Skeleton className="h-4 w-32" />
              <Skeleton className="h-3 w-48" />
              <Skeleton className="h-5 w-24" />
            </div>
          </div>
          <div className="hidden md:flex items-center gap-8">
            <div className="text-center space-y-2">
                <Skeleton className="h-6 w-8 mx-auto" />
                <Skeleton className="h-3 w-20" />
            </div>
            <div className="text-center space-y-2">
                <Skeleton className="h-6 w-12 mx-auto" />
                <Skeleton className="h-3 w-16" />
            </div>
          </div>
          <div className="flex items-center gap-2">
            <Skeleton className="h-9 w-9" />
            <Skeleton className="h-9 w-9" />
          </div>
        </div>
      ))}
    </div>
  );

  return (
    <div className="space-y-6">
      <Card>
          <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle>Team Management</CardTitle>
                  <CardDescription>Add, edit, and track performance of all team members.</CardDescription>
                </div>
                <Button onClick={() => { setEditingMember(null); setShowModal(true); }}>
                  <Plus className="w-4 h-4 mr-2" />
                  Add Team Member
                </Button>
              </div>
          </CardHeader>
          <CardContent>
            <div className="relative mb-4">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" />
              <Input
                type="text"
                placeholder="Search by name, email, or role..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10 w-full"
              />
            </div>
            {isLoading ? (
              <SkeletonLoader />
            ) : filteredMembers.length > 0 ? (
              <div className="divide-y divide-slate-200 dark:divide-slate-700">
                {filteredMembers.map((member) => {
                  const { deals, revenue } = calculatePerformanceMetrics(member.id, member.email);
                  return (
                    <div key={member.id} className="flex items-center justify-between py-4">
                      <div className="flex items-center gap-4">
                        <Avatar className="h-12 w-12"><AvatarImage src={member.profile_photo_url} alt={member.full_name} /><AvatarFallback>{member.full_name?.charAt(0) || '?'}</AvatarFallback></Avatar>
                        <div>
                          <p className="font-semibold text-slate-900 dark:text-white">{member.full_name}</p>
                          <p className="text-sm text-slate-500">{member.email}</p>
                          <Badge variant="outline" className={`mt-1 text-xs ${getRoleColor(member.role)}`}>{member.role?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</Badge>
                        </div>
                      </div>
                      <div className="hidden md:flex items-center gap-8">
                        <div className="text-center"><p className="font-bold text-lg text-blue-600">{deals}</p><p className="text-xs text-slate-500">Deals Closed</p></div>
                        <div className="text-center"><p className="font-bold text-lg text-green-600">${(revenue / 1000).toFixed(1)}k</p><p className="text-xs text-slate-500">Revenue</p></div>
                      </div>
                      <div className="flex items-center gap-2">
                        <Button variant="outline" size="icon" onClick={() => handleEdit(member)}><Edit className="w-4 h-4" /></Button>
                        <Button variant="destructive" size="icon" onClick={() => handleDelete(member.id)}><Trash2 className="w-4 h-4" /></Button>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-center py-16"><Users className="w-16 h-16 mx-auto text-slate-300 mb-4" /><h3 className="text-xl font-semibold">No team members found</h3><p className="text-slate-500 mt-2">{searchTerm ? `No results for "${searchTerm}".` : "Add your first team member to get started."}</p></div>
            )}
          </CardContent>
        </Card>

      {showModal && (
        <TeamMemberModal
          teamMember={editingMember}
          onSave={(data) => saveMutation.mutate(data)}
          onClose={() => { setShowModal(false); setEditingMember(null); }}
          isSaving={saveMutation.isLoading}
        />
      )}
    </div>
  );
}
import React, { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Loader2 } from 'lucide-react';

const ROLES = ["listing_agent", "selling_agent", "broker", "admin", "assistant", "transaction_coordinator", "team_member"];
const SPECIALIZATIONS = ["residential", "commercial", "luxury", "investment", "first_time_buyers", "rentals"];

export default function TeamMemberModal({ teamMember, onSave, onClose, isSaving }) {
  const [formData, setFormData] = useState({
    full_name: '',
    email: '',
    phone: '',
    role: 'team_member',
    license_number: '',
    specialization: 'residential',
    commission_split: 50,
    profile_photo_url: ''
  });

  useEffect(() => {
    if (teamMember) {
      setFormData({
        full_name: teamMember.full_name || '',
        email: teamMember.email || '',
        phone: teamMember.phone || '',
        role: teamMember.role || 'team_member',
        license_number: teamMember.license_number || '',
        specialization: teamMember.specialization || 'residential',
        commission_split: teamMember.commission_split || 50,
        profile_photo_url: teamMember.profile_photo_url || ''
      });
    }
  }, [teamMember]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSelectChange = (name, value) => {
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData);
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>{teamMember ? 'Edit Team Member' : 'Add Team Member'}</DialogTitle>
          <DialogDescription>
            {teamMember ? 'Update the details for this team member.' : 'Add a new member to your team.'}
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="full_name">Full Name</Label>
            <Input id="full_name" name="full_name" value={formData.full_name} onChange={handleChange} required />
          </div>
          <div className="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input id="email" name="email" type="email" value={formData.email} onChange={handleChange} required />
          </div>
          <div className="space-y-2">
            <Label htmlFor="phone">Phone</Label>
            <Input id="phone" name="phone" value={formData.phone} onChange={handleChange} />
          </div>
          <div className="space-y-2">
            <Label htmlFor="role">Role</Label>
            <Select name="role" value={formData.role} onValueChange={(value) => handleSelectChange('role', value)}>
              <SelectTrigger>
                <SelectValue placeholder="Select a role" />
              </SelectTrigger>
              <SelectContent>
                {ROLES.map(role => (
                  <SelectItem key={role} value={role}>{role.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div className="space-y-2">
            <Label htmlFor="license_number">License Number</Label>
            <Input id="license_number" name="license_number" value={formData.license_number} onChange={handleChange} />
          </div>
          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose}>Cancel</Button>
            <Button type="submit" disabled={isSaving}>
              {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              {isSaving ? 'Saving...' : 'Save'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState } from "react";
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from "@/api/base44Client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Users, Search, Edit, Mail } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Skeleton } from "@/components/ui/skeleton";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription
} from '@/components/ui/dialog';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue
} from '@/components/ui/select';

function EditUserModal({ user, onSave, onClose, isSaving }) {
  const [formData, setFormData] = useState({
    full_name: user?.full_name || '',
    role: user?.role || 'user'
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(user.id, formData);
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>Edit User</DialogTitle>
          <DialogDescription>
            Update user information and role
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="full_name">Full Name</Label>
            <Input 
              id="full_name" 
              value={formData.full_name} 
              onChange={(e) => setFormData(prev => ({ ...prev, full_name: e.target.value }))}
              required 
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="email">Email (Read-Only)</Label>
            <Input id="email" value={user.email} disabled />
          </div>
          <div className="space-y-2">
            <Label htmlFor="role">Role</Label>
            <Select 
              value={formData.role} 
              onValueChange={(value) => setFormData(prev => ({ ...prev, role: value }))}
            >
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="user">User</SelectItem>
                <SelectItem value="admin">Admin</SelectItem>
                <SelectItem value="client">Client</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose}>Cancel</Button>
            <Button type="submit" disabled={isSaving}>
              {isSaving ? 'Saving...' : 'Save Changes'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}

export default function UserManagement() {
  const queryClient = useQueryClient();
  const [searchTerm, setSearchTerm] = useState("");
  const [showEditModal, setShowEditModal] = useState(false);
  const [editingUser, setEditingUser] = useState(null);

  const { data: users = [], isLoading } = useQuery({
    queryKey: ['allUsers'],
    queryFn: () => base44.entities.User.list()
  });

  const updateUserMutation = useMutation({
    mutationFn: ({ userId, data }) => base44.functions.invoke('updateUserProfile', { 
      userId, 
      full_name: data.full_name, 
      role: data.role 
    }),
    onSuccess: () => {
      toast.success('User updated successfully!');
      queryClient.invalidateQueries({ queryKey: ['allUsers'] });
      queryClient.invalidateQueries({ queryKey: ['user'] });
      setShowEditModal(false);
      setEditingUser(null);
    },
    onError: (error) => toast.error(`Failed to update user: ${error.message}`)
  });

  const inviteUserMutation = useMutation({
    mutationFn: ({ email, role }) => base44.users.inviteUser(email, role),
    onSuccess: () => {
      toast.success('User invited successfully!');
      queryClient.invalidateQueries({ queryKey: ['allUsers'] });
    },
    onError: (error) => toast.error(`Failed to invite user: ${error.message}`)
  });

  const filteredUsers = users.filter(user =>
    user.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    user.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    user.role?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleEdit = (user) => {
    setEditingUser(user);
    setShowEditModal(true);
  };

  const handleSave = (userId, data) => {
    updateUserMutation.mutate({ userId, data });
  };

  const getRoleColor = (role) => {
    const colors = {
      admin: "bg-red-100 text-red-700 border-red-200 dark:bg-red-900/20 dark:text-red-400",
      user: "bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/20 dark:text-blue-400",
      client: "bg-green-100 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-400"
    };
    return colors[role] || colors.user;
  };

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>User Management</CardTitle>
              <CardDescription>Manage all registered users and their roles</CardDescription>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <div className="relative mb-4">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" />
            <Input
              type="text"
              placeholder="Search by name, email, or role..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-10 w-full"
            />
          </div>
          {isLoading ? (
            <div className="space-y-4">
              {[...Array(3)].map((_, i) => (
                <div key={i} className="flex items-center justify-between py-4">
                  <div className="flex items-center gap-4">
                    <Skeleton className="h-12 w-12 rounded-full" />
                    <div className="space-y-2">
                      <Skeleton className="h-4 w-32" />
                      <Skeleton className="h-3 w-48" />
                    </div>
                  </div>
                  <Skeleton className="h-9 w-9" />
                </div>
              ))}
            </div>
          ) : filteredUsers.length > 0 ? (
            <div className="divide-y divide-slate-200 dark:divide-slate-700">
              {filteredUsers.map((user) => (
                <div key={user.id} className="flex items-center justify-between py-4">
                  <div className="flex items-center gap-4">
                    <Avatar className="h-12 w-12">
                      <AvatarImage src={user.profile_photo_url} alt={user.full_name} />
                      <AvatarFallback>{user.full_name?.charAt(0) || user.email?.charAt(0) || '?'}</AvatarFallback>
                    </Avatar>
                    <div>
                      <p className="font-semibold text-slate-900 dark:text-white">{user.full_name || 'No name set'}</p>
                      <p className="text-sm text-slate-500 dark:text-slate-400">{user.email}</p>
                      <Badge variant="outline" className={`mt-1 text-xs ${getRoleColor(user.role)}`}>
                        {user.role?.toUpperCase()}
                      </Badge>
                    </div>
                  </div>
                  <Button variant="outline" size="icon" onClick={() => handleEdit(user)}>
                    <Edit className="w-4 h-4" />
                  </Button>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-16">
              <Users className="w-16 h-16 mx-auto text-slate-300 mb-4" />
              <h3 className="text-xl font-semibold">No users found</h3>
              <p className="text-slate-500 mt-2">
                {searchTerm ? `No results for "${searchTerm}".` : "No registered users yet."}
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {showEditModal && editingUser && (
        <EditUserModal
          user={editingUser}
          onSave={handleSave}
          onClose={() => {
            setShowEditModal(false);
            setEditingUser(null);
          }}
          isSaving={updateUserMutation.isPending}
        />
      )}
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useMutation, useQueryClient } from "@tanstack/react-query"; // Added useMutation and useQueryClient
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { toast } from "sonner";
import { Sparkles, Target, TrendingUp, Users, Home, Briefcase, CheckCircle2 } from "lucide-react"; // Retained existing lucide icons; Bot removed as it's unused.
// MarketingBanner was not present in the outline's imports, but was in the original file.
// To preserve existing functionality, it's kept if it was used in the actual component.
// However, in the context of this specific component, MarketingBanner is not rendered, so it's safe to remove its import if not used elsewhere.
// Assuming it's not rendered within AgentProfileSetup's direct return, removing it to align with minimal necessary imports.

export default function AgentProfileSetup({ user, onComplete, onClose }) {
  const queryClient = useQueryClient(); // Initialize useQueryClient

  // Retain original profile state structure as the outline suggested a different structure
  // that would require a complete rewrite of the UI and goal management logic,
  // which contradicts "preserving all other features, elements and functionality".
  const [profile, setProfile] = useState({
    agent_profile_type: user?.agent_profile_type || "",
    // New Agent Fields
    mentorship_interest: user?.mentorship_interest || false,
    primary_focus: user?.primary_focus || '',
    // Listing Agent Fields
    listing_goals: [],
    primary_marketing_strategy: user?.primary_marketing_strategy || '',
    // Buyer Agent Fields
    buyer_goals: [],
    ideal_buyer_profile: user?.ideal_buyer_profile || '',
    // Dual Agent Fields
    biggest_challenge: user?.biggest_challenge || '',
    // Advanced Agent Fields
    advanced_goals: [],
    team_status: user?.team_status || '',
  });

  // isSaving state replaced by updateProfileMutation.isPending
  // applyingType state was unused, removed.

  useEffect(() => {
    // Attempt to parse stringified goal arrays from user object
    const parseGoals = (goalString) => {
        try { 
            if (typeof goalString === 'string') {
                return JSON.parse(goalString); 
            }
            return goalString || []; // If already an array or null/undefined, return as is or empty array
        } catch { return []; }
    };
    if (user) {
      setProfile(prev => ({
        ...prev,
        agent_profile_type: user.agent_profile_type || '',
        mentorship_interest: user.mentorship_interest || false,
        primary_focus: user.primary_focus || '',
        primary_marketing_strategy: user.primary_marketing_strategy || '',
        ideal_buyer_profile: user.ideal_buyer_profile || '',
        biggest_challenge: user.biggest_challenge || '',
        team_status: user.team_status || '',
        // business_goals is a shared field for different types of goals, parse it for all relevant goal arrays
        listing_goals: parseGoals(user.business_goals), 
        buyer_goals: parseGoals(user.business_goals),
        advanced_goals: parseGoals(user.business_goals)
      }));
    }
  }, [user]);

  const handleSelectType = (agentType) => {
    setProfile(prev => ({ ...prev, agent_profile_type: agentType }));
  };

  // Replace original handleSave with useMutation hook
  const updateProfileMutation = useMutation({
    mutationFn: async (profileData) => { // profileData is the current state of 'profile'
      if (!profileData.agent_profile_type) {
        throw new Error("Agent type not selected."); // Should ideally be caught before mutation
      }

      let business_goals = [];
      switch (profileData.agent_profile_type) {
        case 'listing_specialist': business_goals = profileData.listing_goals; break;
        case 'buyer_specialist': business_goals = profileData.buyer_goals; break;
        case 'advanced_agent': business_goals = profileData.advanced_goals; break;
        default: business_goals = [];
      }
      
      const dataToSave = {
          ...profileData,
          business_goals: JSON.stringify(business_goals), // Stringify the collected goals
          profile_completed: true,
      };

      return await base44.auth.updateMe(dataToSave);
    },
    onSuccess: () => {
      // Defensive check for queryClient before invalidating queries
      if (queryClient) {
        try {
          queryClient.invalidateQueries({ queryKey: ['user'] });
        } catch (err) {
          console.error('Error invalidating user query:', err);
        }
      }
      toast.success("Profile saved! Your dashboard and tools are now customized.");
      if (onComplete) onComplete();
    },
    onError: (error) => {
      console.error("Error saving profile:", error);
      toast.error("Failed to save profile: " + (error.message || "Unknown error"));
    },
  });

  const handleSubmit = () => {
    if (!profile.agent_profile_type) {
      toast.error("Please select your agent type");
      return;
    }
    // Trigger the mutation with the current profile state
    updateProfileMutation.mutate(profile);
  };
  
  const toggleGoal = (goal, goalType) => {
    setProfile(prev => {
      const currentGoals = prev[goalType] || [];
      const newGoals = currentGoals.includes(goal)
        ? currentGoals.filter(g => g !== goal)
        : [...currentGoals, goal];
      return { ...prev, [goalType]: newGoals };
    });
  };

  const profileTypes = [
    { id: 'new_agent', name: 'New Agent', icon: Sparkles, color: '#3b82f6', description: 'Guidance and daily tasks for getting started.' },
    { id: 'listing_specialist', name: 'Listing Specialist', icon: Home, color: '#10b981', description: 'Tools and insights for sellers and listings.' },
    { id: 'buyer_specialist', name: 'Buyer Agent', icon: Users, color: '#f59e0b', description: 'Focus on managing buyers and showings.' },
    { id: 'dual_agent', name: 'Full Service Agent', icon: Briefcase, color: '#8b5cf6', description: 'Balanced toolkit for buyers and sellers.' },
    { id: 'advanced_agent', name: 'Advanced Agent', icon: TrendingUp, color: '#ec4899', description: 'Data-driven tools for scaling your business.' }
  ];

  const renderDetailedQuestions = () => {
    switch (profile.agent_profile_type) {
      case 'new_agent':
        return (
          <div className="space-y-4">
            <div>
              <label className="text-sm font-semibold mb-2 block">What is your primary focus right now?</label>
              <Select value={profile.primary_focus} onValueChange={(v) => setProfile(p => ({...p, primary_focus: v}))}>
                <SelectTrigger><SelectValue placeholder="Select your focus..." /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="get_first_client">Getting my first client</SelectItem>
                  <SelectItem value="close_first_deal">Closing my first deal</SelectItem>
                  <SelectItem value="build_soi">Building my Sphere of Influence</SelectItem>
                  <SelectItem value="learn_market">Learning the local market</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="flex items-center gap-2 pt-2">
              <Checkbox id="mentorship" checked={profile.mentorship_interest} onCheckedChange={(c) => setProfile(p => ({...p, mentorship_interest: c}))} />
              <label htmlFor="mentorship" className="text-sm">I'm interested in finding a mentor.</label>
            </div>
          </div>
        );
      case 'listing_specialist':
        return (
          <div className="space-y-4">
            <div>
                <label className="text-sm font-semibold mb-2 block">What are your top goals?</label>
                <div className="grid grid-cols-2 gap-2">
                    {[{id: 'increase_listing_volume', label: 'More Listings'}, {id: 'improve_list_sale_ratio', label: 'Better Prices'}, {id: 'dominate_farm_area', label: 'Dominate Farm Area'}, {id: 'build_personal_brand', label: 'Build My Brand'}].map(goal => (
                        <div key={goal.id} className="flex items-center gap-2"><Checkbox checked={profile.listing_goals.includes(goal.id)} onCheckedChange={() => toggleGoal(goal.id, 'listing_goals')} /><label className="text-sm">{goal.label}</label></div>
                    ))}
                </div>
            </div>
            <div>
              <label className="text-sm font-semibold mb-2 block">What's your primary marketing strategy?</label>
              <Select value={profile.primary_marketing_strategy} onValueChange={(v) => setProfile(p => ({...p, primary_marketing_strategy: v}))}>
                <SelectTrigger><SelectValue placeholder="Select a strategy..." /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="social_media">Social Media</SelectItem>
                  <SelectItem value="direct_mail">Direct Mail</SelectItem>
                  <SelectItem value="open_houses">Open Houses</SelectItem>
                  <SelectItem value="online_ads">Online Ads</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        );
      case 'buyer_specialist':
        return (
          <div className="space-y-4">
              <div>
                <label className="text-sm font-semibold mb-2 block">What are your top goals?</label>
                <div className="grid grid-cols-2 gap-2">
                    {[{id: 'increase_buyer_conversion', label: 'Higher Conversion'}, {id: 'reduce_search_time', label: 'Faster Closings'}, {id: 'get_buyer_referrals', label: 'More Referrals'}, {id: 'work_with_luxury_buyers', label: 'Luxury Buyers'}].map(goal => (
                        <div key={goal.id} className="flex items-center gap-2"><Checkbox checked={profile.buyer_goals.includes(goal.id)} onCheckedChange={() => toggleGoal(goal.id, 'buyer_goals')} /><label className="text-sm">{goal.label}</label></div>
                    ))}
                </div>
            </div>
            <div>
              <label className="text-sm font-semibold mb-2 block">Who is your ideal buyer?</label>
              <Select value={profile.ideal_buyer_profile} onValueChange={(v) => setProfile(p => ({...p, ideal_buyer_profile: v}))}>
                <SelectTrigger><SelectValue placeholder="Select a profile..." /></SelectTrigger>
                <SelectContent>
                  <SelectItem value="first_time">First-Time Homebuyers</SelectItem>
                  <SelectItem value="investors">Investors</SelectItem>
                  <SelectItem value="relocation">Relocation Clients</SelectItem>
                  <SelectItem value="luxury">Luxury Market</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        );
       case 'dual_agent':
         return (
           <div className="space-y-4">
             <div>
               <label className="text-sm font-semibold mb-2 block">What's your biggest challenge?</label>
               <Select value={profile.biggest_challenge} onValueChange={(v) => setProfile(p => ({...p, biggest_challenge: v}))}>
                 <SelectTrigger><SelectValue placeholder="Select a challenge..." /></SelectTrigger>
                 <SelectContent>
                   <SelectItem value="time_management">Balancing everything</SelectItem>
                   <SelectItem value="lead_generation">Consistent lead flow</SelectItem>
                   <SelectItem value="client_follow_up">Systematic follow-up</SelectItem>
                 </SelectContent>
               </Select>
             </div>
           </div>
         );
      case 'advanced_agent':
        return (
            <div className="space-y-4">
                <div>
                    <label className="text-sm font-semibold mb-2 block">What are your top goals?</label>
                    <div className="grid grid-cols-2 gap-2">
                        {[{id: 'build_grow_team', label: 'Build/Grow Team'}, {id: 'increase_gci', label: 'Increase GCI'}, {id: 'focus_luxury', label: 'Focus on Luxury'}, {id: 'develop_passive_income', label: 'Passive Income'}].map(goal => (
                            <div key={goal.id} className="flex items-center gap-2"><Checkbox checked={profile.advanced_goals.includes(goal.id)} onCheckedChange={() => toggleGoal(goal.id, 'advanced_goals')} /><label className="text-sm">{goal.label}</label></div>
                        ))}
                    </div>
                </div>
                <div>
                    <label className="text-sm font-semibold mb-2 block">What's your team status?</label>
                    <Select value={profile.team_status} onValueChange={(v) => setProfile(p => ({...p, team_status: v}))}>
                        <SelectTrigger><SelectValue placeholder="Select status..." /></SelectTrigger>
                        <SelectContent>
                            <SelectItem value="solo">Solo Agent</SelectItem>
                            <SelectItem value="building">Looking to Build</SelectItem>
                            <SelectItem value="small_team">Small Team (2-5)</SelectItem>
                            <SelectItem value="large_team">Large Team (5+)</SelectItem>
                        </SelectContent>
                    </Select>
                </div>
            </div>
        );
      default:
        return <p className="text-sm text-center text-slate-500 py-8">Select an agent type to see personalized options.</p>;
    }
  };

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <Card className="w-full max-w-4xl max-h-[90vh] flex flex-col">
            <CardHeader className="flex flex-row items-start justify-between">
                <div>
                    <CardTitle className="flex items-center gap-2">
                        <Target className="w-5 h-5" />
                        Customize Your Experience
                    </CardTitle>
                    <p className="text-sm text-slate-600 dark:text-slate-400">
                        Select your agent profile to get a dashboard and tools tailored to your needs.
                    </p>
                </div>
                <Button variant="ghost" size="icon" onClick={onClose}>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </Button>
            </CardHeader>
            <CardContent className="flex-1 overflow-y-auto pr-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <label className="text-base font-semibold mb-4 block">1. Select Your Agent Profile</label>
                  <div className="space-y-3">
                    {profileTypes.map(type => {
                        const Icon = type.icon;
                        const isSelected = profile.agent_profile_type === type.id;
                        return (
                            <div
                                key={type.id}
                                onClick={() => handleSelectType(type.id)}
                                className={`p-4 rounded-lg border-2 transition-all cursor-pointer flex items-start gap-4 ${
                                isSelected 
                                    ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20' 
                                    : 'border-slate-200 dark:border-slate-700 hover:border-indigo-400'
                                }`}
                            >
                                <div style={{ background: isSelected ? type.color : '#e2e8f0' }} className="p-2 rounded-lg transition-colors">
                                    <Icon className={`w-5 h-5 ${isSelected ? 'text-white' : 'text-slate-600'}`} />
                                </div>
                                <div className="flex-1">
                                  <div className="flex justify-between items-center">
                                    <h4 className="font-semibold text-sm">{type.name}</h4>
                                    {isSelected && <CheckCircle2 className="w-5 h-5 text-green-600" />}
                                  </div>
                                  <p className="text-xs text-slate-600 dark:text-slate-400">{type.description}</p>
                                </div>
                            </div>
                        );
                    })}
                  </div>
                </div>

                <div>
                    <label className="text-base font-semibold mb-4 block">2. Fine-Tune Your Setup (Optional)</label>
                    <Card className="bg-slate-50 dark:bg-slate-800/50">
                        <CardContent className="p-6">
                            {renderDetailedQuestions()}
                        </CardContent>
                    </Card>
                    <div className="mt-6 flex justify-end">
                      {/* Use mutation's isPending state for disabled prop */}
                      <Button onClick={handleSubmit} disabled={updateProfileMutation.isPending || !profile.agent_profile_type}>
                        {updateProfileMutation.isPending ? 'Saving...' : 'Save and Customize'}
                      </Button>
                    </div>
                </div>
              </div>
            </CardContent>
        </Card>
    </div>
  );
}

import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Key, Save, Power, ShieldCheck } from "lucide-react";
import { Skeleton } from "@/components/ui/skeleton";

export default function ApiTokenSettings() {
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    const [apiToken, setApiToken] = useState("");

    useEffect(() => {
        loadInitialData();
    }, []);

    const loadInitialData = async () => {
        setIsLoading(true);
        try {
            const currentUser = await base44.auth.me();
            if (currentUser) {
                setApiToken(currentUser.homesage_api_token || "");
            }
        } catch (error) {
            toast.error("Failed to load API token.");
        } finally {
            setIsLoading(false);
        }
    };

    const handleSave = async () => {
        setIsSaving(true);
        try {
            await base44.auth.updateMe({ homesage_api_token: apiToken });
            toast.success("API Token updated successfully!");
        } catch (error) {
            toast.error("Failed to update API token.");
        } finally {
            setIsSaving(false);
        }
    };

    const generateNewToken = () => {
        const newToken = 'hs_token_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
        setApiToken(newToken);
        toast.info("New token generated. Remember to save your settings.");
    };

    if (isLoading) {
        return (
             <Card>
                <CardHeader>
                    <Skeleton className="h-6 w-1/2" />
                    <Skeleton className="h-4 w-3/4" />
                </CardHeader>
                <CardContent className="space-y-4">
                   <Skeleton className="h-12 w-full" />
                   <Skeleton className="h-10 w-48" />
                </CardContent>
            </Card>
        )
    }

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Key className="w-5 h-5 text-green-600" />
                        HomeSage AI API Token
                    </CardTitle>
                    <CardDescription>Use this token to access the Property Analysis API and other developer tools.</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div className="flex items-center gap-2 p-3 border rounded-lg bg-slate-50 dark:bg-slate-800">
                        <ShieldCheck className="w-5 h-5 text-green-600"/>
                        <Input 
                            value={apiToken} 
                            readOnly
                            className="font-mono flex-1 border-0 bg-transparent shadow-none focus-visible:ring-0"
                            placeholder="No token generated"
                        />
                    </div>
                     <Button variant="outline" onClick={generateNewToken}>
                        <Power className="w-4 h-4 mr-2" />
                        Generate New Token
                    </Button>
                </CardContent>
            </Card>
            <div className="flex justify-end">
                <Button onClick={handleSave} disabled={isSaving}>
                    <Save className="w-4 h-4 mr-2" />
                    {isSaving ? "Saving..." : "Save Changes"}
                </Button>
            </div>
        </div>
    );
}

import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Label } from '@/components/ui/label';
import { Check, Palette, Sparkles, Shield, Heart, Crown, Leaf, Star, Loader2, Save } from 'lucide-react';
import { useQueryClient, useMutation } from '@tanstack/react-query';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { base44 } from '@/api/base44Client';

export default function AppearanceSettings({ user }) {
  const queryClient = useQueryClient();
  const [selectedTheme, setSelectedTheme] = useState(user?.theme_preference || 'default');
  const [dashboardLayout, setDashboardLayout] = useState(user?.dashboard_layout || 'advanced');
  const [dataVisualization, setDataVisualization] = useState(user?.data_visualization || 'charts');
  const [sharpCorners, setSharpCorners] = useState(user?.sharp_corners || false);

  // Sync with user data when it changes
  useEffect(() => {
    if (user?.theme_preference) {
      setSelectedTheme(user.theme_preference);
    }
    if (user?.sharp_corners !== undefined) {
      setSharpCorners(user.sharp_corners);
    }
  }, [user]);

  const themes = [
    {
      key: 'default',
      name: 'Default',
      description: 'Clean and modern blue theme',
      icon: Palette,
      colors: {
        primary: '#4F46E5',
        secondary: '#7C3AED',
        accent: '#06B6D4',
        neutral: '#64748B'
      }
    },
    {
      key: 'aesthetic',
      name: 'Aesthetic Neutrals',
      description: 'Sophisticated warm neutrals and earth tones',
      icon: Sparkles,
      colors: {
        primary: '#373D3B',
        secondary: '#A08F88',
        accent: '#C1B8B1',
        neutral: '#EFEBEC'
      }
    },
    {
      key: 'masculine',
      name: 'Masculine',
      description: 'Bold and professional dark theme',
      icon: Shield,
      colors: {
        primary: '#1E293B',
        secondary: '#334155',
        accent: '#0EA5E9',
        neutral: '#475569'
      }
    },
    {
      key: 'feminine',
      name: 'Feminine',
      description: 'Soft and elegant pink theme',
      icon: Heart,
      colors: {
        primary: '#EC4899',
        secondary: '#F472B6',
        accent: '#A78BFA',
        neutral: '#F3E8FF'
      }
    },
    {
      key: 'royal',
      name: 'Royal',
      description: 'Luxurious purple and gold theme',
      icon: Crown,
      colors: {
        primary: '#7C3AED',
        secondary: '#A855F7',
        accent: '#FBBF24',
        neutral: '#DDD6FE'
      }
    },
    {
      key: 'emerald',
      name: 'Emerald',
      description: 'Fresh and vibrant green theme',
      icon: Leaf,
      colors: {
        primary: '#059669',
        secondary: '#10B981',
        accent: '#34D399',
        neutral: '#D1FAE5'
      }
    },
    {
      key: 'gold',
      name: 'Gold',
      description: 'Warm and prestigious gold theme',
      icon: Star,
      colors: {
        primary: '#D97706',
        secondary: '#F59E0B',
        accent: '#FBBF24',
        neutral: '#FEF3C7'
      }
    }
  ];

  const updateSettings = useMutation({
    mutationFn: async (updates) => {
      console.log('Saving appearance settings:', updates);
      return await base44.auth.updateMe(updates);
    },
    onSuccess: (data) => {
      console.log('Settings saved successfully:', data);
      if (queryClient) {
        queryClient.invalidateQueries({ queryKey: ['user'] });
      }
      toast.success('Appearance settings updated!');
      
      // Immediately apply theme
      const theme = themes.find(t => t.key === selectedTheme);
      if (theme) {
        const root = document.documentElement;
        root.style.setProperty('--theme-primary', theme.colors.primary);
        root.style.setProperty('--theme-secondary', theme.colors.secondary);
        root.style.setProperty('--theme-accent', theme.colors.accent);
        root.style.setProperty('--theme-neutral', theme.colors.neutral);
        
        // Apply sharp corners setting
        if (sharpCorners) {
          root.classList.add('sharp-corners');
        } else {
          root.classList.remove('sharp-corners');
        }
        
        // Notify layout to update
        window.dispatchEvent(new CustomEvent('colorThemeChange', { 
          detail: { colorTheme: selectedTheme } 
        }));
        
        // Also save to localStorage as backup
        localStorage.setItem('colorTheme', selectedTheme);
        localStorage.setItem('sharpCorners', sharpCorners);
      }
    },
    onError: (error) => {
      console.error('Failed to save settings:', error);
      toast.error('Failed to update settings');
    },
  });

  const handleSave = () => {
    console.log('Saving settings with theme:', selectedTheme, 'sharp corners:', sharpCorners);
    updateSettings.mutate({
      theme_preference: selectedTheme,
      dashboard_layout: dashboardLayout,
      data_visualization: dataVisualization,
      sharp_corners: sharpCorners,
    });
  };

  // Apply theme and corners preview immediately when selected (before saving)
  useEffect(() => {
    const theme = themes.find(t => t.key === selectedTheme);
    if (theme) {
      const root = document.documentElement;
      root.style.setProperty('--theme-primary', theme.colors.primary);
      root.style.setProperty('--theme-secondary', theme.colors.secondary);
      root.style.setProperty('--theme-accent', theme.colors.accent);
      root.style.setProperty('--theme-neutral', theme.colors.neutral);
      
      // Apply sharp corners
      if (sharpCorners) {
        root.classList.add('sharp-corners');
      } else {
        root.classList.remove('sharp-corners');
      }
    }
  }, [selectedTheme, sharpCorners]);

  return (
    <div className="space-y-6">
      {/* Theme Selection */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Palette className="w-5 h-5" />
            Color Theme
          </CardTitle>
          {/* <CardDescription>
            Choose a color theme that matches your brand and personal style.
          </CardDescription> */}
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {themes.map((theme) => {
              const Icon = theme.icon;
              return (
                <button
                  key={theme.key}
                  type="button"
                  onClick={() => {
                    console.log('Theme clicked:', theme.key);
                    setSelectedTheme(theme.key);
                  }}
                  className={cn(
                    "relative p-4 rounded-xl border-2 transition-all duration-200 text-left hover:scale-102 cursor-pointer",
                    selectedTheme === theme.key
                      ? "border-primary shadow-lg scale-105 ring-2 ring-primary ring-offset-2"
                      : "border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600 hover:shadow-md"
                  )}
                >
                  {selectedTheme === theme.key && (
                    <div className="absolute -top-2 -right-2 w-6 h-6 bg-primary rounded-full flex items-center justify-center shadow-lg z-10">
                      <Check className="w-4 h-4 text-white" />
                    </div>
                  )}

                  <div className="flex items-center gap-3 mb-3">
                    <Icon className="w-5 h-5" style={{ color: theme.colors.primary }} />
                    <span className="font-semibold text-slate-900 dark:text-white">
                      {theme.name}
                    </span>
                  </div>

                  <p className="text-xs text-slate-600 dark:text-slate-400 mb-3">
                    {theme.description}
                  </p>

                  <div className="flex gap-2">
                    {Object.values(theme.colors).map((color, idx) => (
                      <div
                        key={idx}
                        className="h-8 w-full rounded-md shadow-sm border border-slate-200 dark:border-slate-700"
                        style={{ backgroundColor: color }}
                      />
                    ))}
                  </div>
                </button>
              );
            })}
          </div>
        </CardContent>
      </Card>

      {/* Corner Style Setting */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Sparkles className="w-5 h-5" />
            Corner Style
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <p className="text-sm text-slate-600 dark:text-slate-400">
            Choose between rounded or sharp corners for all UI elements
          </p>
          
          <div className="grid grid-cols-2 gap-4">
            <button
              type="button"
              onClick={() => setSharpCorners(false)}
              className={cn(
                "relative p-4 border-2 transition-all duration-200 text-left rounded-xl hover:scale-102 cursor-pointer",
                !sharpCorners
                  ? "border-primary shadow-lg scale-105 ring-2 ring-primary ring-offset-2"
                  : "border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600 hover:shadow-md"
              )}
            >
              {!sharpCorners && (
                <div className="absolute -top-2 -right-2 w-6 h-6 bg-primary rounded-full flex items-center justify-center shadow-lg z-10">
                  <Check className="w-4 h-4 text-white" />
                </div>
              )}
              <div className="space-y-2">
                <div className="w-full h-16 bg-gradient-to-br from-primary/20 to-secondary/20 rounded-xl border-2 border-primary/30"></div>
                <p className="font-semibold text-slate-900 dark:text-white mt-3">Rounded Corners</p>
                <p className="text-xs text-slate-600 dark:text-slate-400">Soft, modern look with rounded edges</p>
              </div>
            </button>

            <button
              type="button"
              onClick={() => setSharpCorners(true)}
              className={cn(
                "relative p-4 border-2 transition-all duration-200 text-left rounded-xl hover:scale-102 cursor-pointer",
                sharpCorners
                  ? "border-primary shadow-lg scale-105 ring-2 ring-primary ring-offset-2"
                  : "border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600 hover:shadow-md"
              )}
            >
              {sharpCorners && (
                <div className="absolute -top-2 -right-2 w-6 h-6 bg-primary rounded-full flex items-center justify-center shadow-lg z-10">
                  <Check className="w-4 h-4 text-white" />
                </div>
              )}
              <div className="space-y-2">
                <div className="w-full h-16 bg-gradient-to-br from-primary/20 to-secondary/20 border-2 border-primary/30"></div> {/* Removed rounded-xl */}
                <p className="font-semibold text-slate-900 dark:text-white mt-3">Sharp Corners</p>
                <p className="text-xs text-slate-600 dark:text-slate-400">Clean, professional look with square edges</p>
              </div>
            </button>
          </div>
        </CardContent>
      </Card>

      {/* Dashboard Layout */}
      <Card>
        <CardHeader>
          <CardTitle>Dashboard Layout</CardTitle>
          <CardDescription>
            Choose your preferred layout for the dashboard.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <RadioGroup
            value={dashboardLayout}
            onValueChange={setDashboardLayout}
            className="grid grid-cols-1 md:grid-cols-2 gap-4"
          >
            <Label
              htmlFor="layout-advanced"
              className={cn(
                "flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground cursor-pointer",
                dashboardLayout === 'advanced' && 'border-primary'
              )}
            >
              <div className="space-y-2">
                <div className="flex items-center justify-center w-full h-20 bg-slate-200 dark:bg-slate-700 rounded-md">
                  <div className="w-1/4 h-full bg-slate-300 dark:bg-slate-600 rounded-l-md"></div>
                  <div className="flex-1 p-2 space-y-1">
                    <div className="w-full h-3 bg-slate-300 dark:bg-slate-600 rounded-sm"></div>
                    <div className="w-4/5 h-3 bg-slate-300 dark:bg-slate-600 rounded-sm"></div>
                    <div className="w-full h-3 bg-slate-300 dark:bg-slate-600 rounded-sm"></div>
                  </div>
                </div>
                <span className="block w-full text-center font-normal">Advanced</span>
              </div>
              <RadioGroupItem value="advanced" id="layout-advanced" className="sr-only" />
            </Label>
            <Label
              htmlFor="layout-basic"
              className={cn(
                "flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground cursor-pointer",
                dashboardLayout === 'basic' && 'border-primary'
              )}
            >
              <div className="space-y-2">
                <div className="flex items-center justify-center w-full h-20 bg-slate-200 dark:bg-slate-700 rounded-md p-2">
                  <div className="w-full h-full bg-slate-300 dark:bg-slate-600 rounded-md flex flex-col justify-around p-1">
                    <div className="w-full h-4 bg-slate-400 dark:bg-slate-500 rounded-sm"></div>
                    <div className="w-4/5 h-4 bg-slate-400 dark:bg-slate-500 rounded-sm"></div>
                  </div>
                </div>
                <span className="block w-full text-center font-normal">Basic</span>
              </div>
              <RadioGroupItem value="basic" id="layout-basic" className="sr-only" />
            </Label>
          </RadioGroup>
        </CardContent>
      </Card>

      {/* Data Visualization */}
      <Card>
        <CardHeader>
          <CardTitle>Data Visualization</CardTitle>
          <CardDescription>
            Select how data is primarily displayed in your reports.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <RadioGroup
            value={dataVisualization}
            onValueChange={setDataVisualization}
            className="grid grid-cols-1 md:grid-cols-2 gap-4"
          >
            <Label
              htmlFor="vis-charts"
              className={cn(
                "flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground cursor-pointer",
                dataVisualization === 'charts' && 'border-primary'
              )}
            >
              <div className="space-y-2">
                <div className="flex items-center justify-center w-full h-20 bg-slate-200 dark:bg-slate-700 rounded-md p-2">
                  <div className="w-1/3 h-full bg-slate-300 dark:bg-slate-600 rounded-md mr-1"></div>
                  <div className="w-1/3 h-2/3 bg-slate-300 dark:bg-slate-600 rounded-md mr-1"></div>
                  <div className="w-1/3 h-1/2 bg-slate-300 dark:bg-slate-600 rounded-md"></div>
                </div>
                <span className="block w-full text-center font-normal">Charts</span>
              </div>
              <RadioGroupItem value="charts" id="vis-charts" className="sr-only" />
            </Label>
            <Label
              htmlFor="vis-tables"
              className={cn(
                "flex flex-col items-center justify-between rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground cursor-pointer",
                dataVisualization === 'tables' && 'border-primary'
              )}
            >
              <div className="space-y-2">
                <div className="flex items-center justify-center w-full h-20 bg-slate-200 dark:bg-slate-700 rounded-md p-2">
                  <div className="w-full h-full bg-slate-300 dark:bg-slate-600 rounded-md flex flex-col p-1">
                    <div className="w-full h-4 bg-slate-400 dark:bg-slate-500 rounded-sm mb-1"></div>
                    <div className="w-full h-4 bg-slate-300 dark:bg-slate-600 rounded-sm mb-1"></div>
                    <div className="w-full h-4 bg-slate-400 dark:bg-slate-500 rounded-sm"></div>
                  </div>
                </div>
                <span className="block w-full text-center font-normal">Tables</span>
              </div>
              <RadioGroupItem value="tables" id="vis-tables" className="sr-only" />
            </Label>
          </RadioGroup>
        </CardContent>
      </Card>

      {/* Save Button */}
      <div className="flex justify-end">
        <Button 
          onClick={handleSave} 
          disabled={updateSettings.isLoading}
          className="min-w-[120px]"
        >
          {updateSettings.isLoading ? (
            <>
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              Saving...
            </>
          ) : (
            <>
              <Save className="w-4 h-4 mr-2" />
              Save Changes
            </>
          )}
        </Button>
      </div>
    </div>
  );
}

import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Calendar,
  Clock,
  Settings as SettingsIcon,
  CheckCircle2,
  X,
  Loader2,
  Shield
} from "lucide-react";
import { toast } from "sonner";
import { googleCalendarOAuth } from "@/api/functions";
import { outlookCalendarOAuth } from "@/api/functions";

export default function CalendarIntegration({ user }) {
  const queryClient = useQueryClient();
  const [workingHoursStart, setWorkingHoursStart] = useState(user?.working_hours_start || '09:00');
  const [workingHoursEnd, setWorkingHoursEnd] = useState(user?.working_hours_end || '17:00');
  const [bufferMinutes, setBufferMinutes] = useState(user?.meeting_buffer_minutes || 15);
  const [defaultDuration, setDefaultDuration] = useState(user?.default_meeting_duration || 60);
  const [connecting, setConnecting] = useState(null);

  const updateUserMutation = useMutation({
    mutationFn: (data) => base44.auth.updateMe(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['user'] });
      toast.success('Calendar settings updated!');
    },
    onError: (error) => {
      toast.error('Failed to update: ' + error.message);
    }
  });

  const handleConnectGoogleCalendar = async () => {
    setConnecting('google');
    try {
      const result = await googleCalendarOAuth({ action: 'authorize' });
      
      if (result.data.success && result.data.auth_url) {
        // Open OAuth window
        const width = 600;
        const height = 700;
        const left = window.screenX + (window.outerWidth - width) / 2;
        const top = window.screenY + (window.outerHeight - height) / 2;
        
        const popup = window.open(
          result.data.auth_url,
          'Google Calendar OAuth',
          `width=${width},height=${height},left=${left},top=${top}`
        );

        // Listen for OAuth callback
        const checkPopup = setInterval(async () => {
          try {
            if (popup.closed) {
              clearInterval(checkPopup);
              setConnecting(null);
              
              // Refresh user data to check if connection succeeded
              await queryClient.invalidateQueries({ queryKey: ['user'] });
              
              // Check if user now has Google token
              const updatedUser = await base44.auth.me();
              if (updatedUser.google_calendar_token) {
                toast.success('Google Calendar connected successfully! 🎉');
              } else {
                toast.info('Calendar connection was cancelled');
              }
            }
          } catch (error) {
            // Ignore cross-origin errors
          }
        }, 500);
      }
    } catch (error) {
      console.error('Error connecting Google Calendar:', error);
      toast.error('Failed to connect: ' + error.message);
      setConnecting(null);
    }
  };

  const handleConnectOutlookCalendar = async () => {
    setConnecting('outlook');
    try {
      const result = await outlookCalendarOAuth({ action: 'authorize' });
      
      if (result.data.success && result.data.auth_url) {
        // Open OAuth window
        const width = 600;
        const height = 700;
        const left = window.screenX + (window.outerWidth - width) / 2;
        const top = window.screenY + (window.outerHeight - height) / 2;
        
        const popup = window.open(
          result.data.auth_url,
          'Outlook Calendar OAuth',
          `width=${width},height=${height},left=${left},top=${top}`
        );

        // Listen for OAuth callback
        const checkPopup = setInterval(async () => {
          try {
            if (popup.closed) {
              clearInterval(checkPopup);
              setConnecting(null);
              
              // Refresh user data
              await queryClient.invalidateQueries({ queryKey: ['user'] });
              
              const updatedUser = await base44.auth.me();
              if (updatedUser.outlook_calendar_token) {
                toast.success('Outlook Calendar connected successfully! 🎉');
              } else {
                toast.info('Calendar connection was cancelled');
              }
            }
          } catch (error) {
            // Ignore cross-origin errors
          }
        }, 500);
      }
    } catch (error) {
      console.error('Error connecting Outlook Calendar:', error);
      toast.error('Failed to connect: ' + error.message);
      setConnecting(null);
    }
  };

  const handleDisconnectCalendar = () => {
    updateUserMutation.mutate({
      google_calendar_token: null,
      google_calendar_refresh_token: null,
      google_calendar_token_expiry: null,
      outlook_calendar_token: null,
      outlook_calendar_refresh_token: null,
      outlook_calendar_token_expiry: null,
      preferred_calendar_provider: 'none'
    });
  };

  const handleSaveWorkingHours = () => {
    updateUserMutation.mutate({
      working_hours_start: workingHoursStart,
      working_hours_end: workingHoursEnd,
      meeting_buffer_minutes: bufferMinutes,
      default_meeting_duration: defaultDuration,
      working_days: JSON.stringify(['mon', 'tue', 'wed', 'thu', 'fri'])
    });
  };

  const isConnected = user?.preferred_calendar_provider && user.preferred_calendar_provider !== 'none';
  const connectedProvider = user?.preferred_calendar_provider;

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Calendar className="w-5 h-5 text-indigo-600" />
            Calendar Integration
          </CardTitle>
          <CardDescription>
            Connect your calendar to enable automatic availability checking and meeting invites
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Connection Status */}
          <div className={`p-4 rounded-lg border-2 ${
            isConnected 
              ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800'
              : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700'
          }`}>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                {isConnected ? (
                  <CheckCircle2 className="w-6 h-6 text-green-600" />
                ) : (
                  <Calendar className="w-6 h-6 text-slate-400" />
                )}
                <div>
                  <p className="font-semibold">
                    {isConnected ? (
                      <>
                        Connected to {connectedProvider === 'google' ? '📅 Google Calendar' : '📆 Outlook Calendar'}
                      </>
                    ) : (
                      'No calendar connected'
                    )}
                  </p>
                  <p className="text-sm text-slate-600 dark:text-slate-400">
                    {isConnected ? 'Availability sync enabled' : 'Connect to enable smart scheduling'}
                  </p>
                </div>
              </div>
              {isConnected && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleDisconnectCalendar}
                  className="text-red-600 hover:text-red-700"
                >
                  <X className="w-4 h-4 mr-1" />
                  Disconnect
                </Button>
              )}
            </div>
          </div>

          {/* Connect Buttons */}
          {!isConnected && (
            <>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Button
                  onClick={handleConnectGoogleCalendar}
                  disabled={connecting === 'google'}
                  className="h-24 bg-gradient-to-br from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white"
                >
                  {connecting === 'google' ? (
                    <div className="flex items-center gap-2">
                      <Loader2 className="w-5 h-5 animate-spin" />
                      <span>Connecting...</span>
                    </div>
                  ) : (
                    <div className="text-center">
                      <div className="text-3xl mb-2">📅</div>
                      <div className="font-semibold">Connect Google Calendar</div>
                      <div className="text-xs opacity-90">Secure OAuth authentication</div>
                    </div>
                  )}
                </Button>

                <Button
                  onClick={handleConnectOutlookCalendar}
                  disabled={connecting === 'outlook'}
                  className="h-24 bg-gradient-to-br from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white"
                >
                  {connecting === 'outlook' ? (
                    <div className="flex items-center gap-2">
                      <Loader2 className="w-5 h-5 animate-spin" />
                      <span>Connecting...</span>
                    </div>
                  ) : (
                    <div className="text-center">
                      <div className="text-3xl mb-2">📆</div>
                      <div className="font-semibold">Connect Outlook Calendar</div>
                      <div className="text-xs opacity-90">Microsoft 365 integration</div>
                    </div>
                  )}
                </Button>
              </div>

              {/* Security Notice */}
              <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                <div className="flex items-start gap-3">
                  <Shield className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                  <div className="text-sm text-blue-900 dark:text-blue-100">
                    <p className="font-semibold mb-1">Secure OAuth Connection</p>
                    <p className="text-blue-800 dark:text-blue-200">
                      We use industry-standard OAuth 2.0 authentication. Your calendar credentials are never stored - only secure access tokens are saved.
                    </p>
                  </div>
                </div>
              </div>
            </>
          )}

          {/* Features Preview */}
          {isConnected && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t">
              <Card className="border-2 border-green-200 dark:border-green-800">
                <CardHeader>
                  <CardTitle className="text-base flex items-center gap-2 text-green-700 dark:text-green-400">
                    <CheckCircle2 className="w-4 h-4" />
                    Active Features
                  </CardTitle>
                </CardHeader>
                <CardContent className="text-sm space-y-2">
                  <p className="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                    ✓ Real-time availability checking
                  </p>
                  <p className="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                    ✓ Automatic calendar invite sending
                  </p>
                  <p className="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                    ✓ Double-booking prevention
                  </p>
                  <p className="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                    ✓ Cross-device synchronization
                  </p>
                </CardContent>
              </Card>

              <Card className="border-2 border-indigo-200 dark:border-indigo-800">
                <CardHeader>
                  <CardTitle className="text-base flex items-center gap-2 text-indigo-700 dark:text-indigo-400">
                    <Calendar className="w-4 h-4" />
                    How It Works
                  </CardTitle>
                </CardHeader>
                <CardContent className="text-sm space-y-2 text-slate-600 dark:text-slate-400">
                  <p>1. Schedule meetings from emails or messages</p>
                  <p>2. System checks your calendar for conflicts</p>
                  <p>3. Shows only available time slots</p>
                  <p>4. Sends professional calendar invites</p>
                </CardContent>
              </Card>
            </div>
          )}

          {/* Working Hours Configuration */}
          <div className="space-y-4 pt-4 border-t">
            <h3 className="font-semibold flex items-center gap-2">
              <Clock className="w-4 h-4 text-indigo-600" />
              Working Hours & Preferences
            </h3>
            <p className="text-sm text-slate-600 dark:text-slate-400">
              Configure your availability for meeting scheduling
            </p>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Start Time</Label>
                <Input
                  type="time"
                  value={workingHoursStart}
                  onChange={(e) => setWorkingHoursStart(e.target.value)}
                />
              </div>
              <div className="space-y-2">
                <Label>End Time</Label>
                <Input
                  type="time"
                  value={workingHoursEnd}
                  onChange={(e) => setWorkingHoursEnd(e.target.value)}
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Buffer Between Meetings</Label>
                <Select
                  value={bufferMinutes.toString()}
                  onValueChange={(value) => setBufferMinutes(parseInt(value))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="0">No buffer</SelectItem>
                    <SelectItem value="15">15 minutes</SelectItem>
                    <SelectItem value="30">30 minutes</SelectItem>
                    <SelectItem value="45">45 minutes</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label>Default Meeting Duration</Label>
                <Select
                  value={defaultDuration.toString()}
                  onValueChange={(value) => setDefaultDuration(parseInt(value))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="30">30 minutes</SelectItem>
                    <SelectItem value="60">1 hour</SelectItem>
                    <SelectItem value="90">1.5 hours</SelectItem>
                    <SelectItem value="120">2 hours</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <Button
              onClick={handleSaveWorkingHours}
              className="w-full bg-indigo-600 hover:bg-indigo-700"
            >
              <SettingsIcon className="w-4 h-4 mr-2" />
              Save Working Hours
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Mail, Save, Info, Loader2 } from "lucide-react";
import { Skeleton } from "@/components/ui/skeleton";

const DEFAULT_SETTINGS = {
    times: [15, 30, 45, 60],
    email_template: `Hi {client_name},\n\nThis is a quick update regarding our scheduled appointment for "{appointment_title}". I am running a bit behind and now expect to arrive approximately {delay_time} minutes later than planned.\n\nMy sincere apologies for any inconvenience this may cause. I look forward to seeing you shortly.\n\nBest regards,\n{your_name}`,
    sms_template: `Hi {client_name}, quick update on our appointment for "{appointment_title}". I'm running about {delay_time} minutes late. My apologies for the delay. See you soon! - {your_name}`
};

export default function CommunicationSettings() {
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    const [settings, setSettings] = useState(DEFAULT_SETTINGS);

    useEffect(() => {
        loadSettings();
    }, []);

    const loadSettings = async () => {
        setIsLoading(true);
        try {
            const currentUser = await base44.auth.me();
            if (currentUser && currentUser.late_notification_settings) {
                try {
                    const savedSettings = JSON.parse(currentUser.late_notification_settings);
                    setSettings({ ...DEFAULT_SETTINGS, ...savedSettings });
                } catch (e) {
                    console.error("Failed to parse late_notification_settings, using defaults.", e);
                    setSettings(DEFAULT_SETTINGS);
                }
            } else {
                setSettings(DEFAULT_SETTINGS);
            }
        } catch (error) {
            toast.error("Failed to load communication settings.");
            setSettings(DEFAULT_SETTINGS);
        } finally {
            setIsLoading(false);
        }
    };

    const handleSave = async () => {
        setIsSaving(true);
        try {
            await base44.auth.updateMe({
                late_notification_settings: JSON.stringify(settings),
            });
            toast.success("Communication settings updated!");
        } catch (error) {
            toast.error("Failed to update settings.");
        } finally {
            setIsSaving(false);
        }
    };
    
    const handleTimesChange = (e) => {
        const timesArray = e.target.value.split(',').map(t => parseInt(t.trim())).filter(t => !isNaN(t) && t > 0);
        setSettings(prev => ({ ...prev, times: timesArray }));
    };

    const availablePlaceholders = ['{client_name}', '{your_name}', '{appointment_title}', '{delay_time}'];

    if (isLoading) {
        return (
             <Card>
                <CardHeader>
                    <Skeleton className="h-6 w-1/2" />
                    <Skeleton className="h-4 w-3/4" />
                </CardHeader>
                <CardContent className="space-y-6">
                    <Skeleton className="h-10 w-full" />
                    <Skeleton className="h-32 w-full" />
                    <Skeleton className="h-32 w-full" />
                </CardContent>
            </Card>
        );
    }

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Mail className="w-5 h-5 text-indigo-600" />
                        Running Late Notification Templates
                    </CardTitle>
                    <CardDescription>
                        Customize the messages sent to clients when you are running late for an appointment.
                    </CardDescription>
                </CardHeader>
                <CardContent className="space-y-6">
                    <div className="space-y-2">
                        <Label htmlFor="delay_times">Available Delay Times (in minutes)</Label>
                        <Input
                            id="delay_times"
                            value={(settings.times || []).join(', ')}
                            onChange={handleTimesChange}
                            placeholder="e.g., 15, 30, 45, 60"
                        />
                         <p className="text-xs text-slate-500">Enter comma-separated numbers for the delay options.</p>
                    </div>

                    <div className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
                        <div className="flex items-start gap-2 mb-2">
                            <Info className="w-4 h-4 text-slate-500 mt-1 flex-shrink-0" />
                            <p className="text-xs text-slate-600 dark:text-slate-400">
                                Use these placeholders in your templates. They will be automatically replaced with the correct information.
                            </p>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {availablePlaceholders.map(tag => (
                                <button
                                    key={tag}
                                    onClick={() => {
                                        navigator.clipboard.writeText(tag);
                                        toast.success(`Copied "${tag}" to clipboard.`);
                                    }}
                                    className="px-2 py-1 bg-slate-200 dark:bg-slate-700 text-xs rounded-md hover:bg-slate-300 dark:hover:bg-slate-600"
                                >
                                    {tag}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="email_template">Email Template</Label>
                        <Textarea
                            id="email_template"
                            value={settings.email_template || ''}
                            onChange={(e) => setSettings(prev => ({ ...prev, email_template: e.target.value }))}
                            className="h-48 font-mono text-sm"
                            placeholder="Enter the email content here..."
                        />
                    </div>

                    <div className="space-y-2 opacity-50">
                        <Label htmlFor="sms_template">SMS Template (Coming Soon)</Label>
                        <Textarea
                            id="sms_template"
                            value={settings.sms_template || ''}
                            onChange={(e) => setSettings(prev => ({ ...prev, sms_template: e.target.value }))}
                            className="h-24 font-mono text-sm"
                            placeholder="Enter the SMS content here..."
                            disabled
                        />
                        <p className="text-xs text-slate-500">SMS functionality is not yet available but you can prepare your template.</p>
                    </div>
                </CardContent>
            </Card>

            <div className="flex justify-end">
                <Button onClick={handleSave} disabled={isSaving}>
                    {isSaving ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
                    {isSaving ? "Saving..." : "Save Changes"}
                </Button>
            </div>
        </div>
    );
}
import React, { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { toast } from 'sonner';
import { base44 } from '@/api/base44Client';
import { Loader2, CheckCircle, AlertCircle, Download, X, ArrowRight } from 'lucide-react';
import FieldMappingModal from './FieldMappingModal';

const CRM_API_CONFIGS = {
    // Real Estate CRMs
    followupboss: {
        fields: [
            { key: 'api_key', label: 'API Key', type: 'password', required: true, help: 'Find in Settings > Integrations' }
        ],
        docs: 'https://api.followupboss.com/docs',
        exportPath: 'Export contacts and leads to CSV from your Follow Up Boss dashboard'
    },
    liondesk: {
        fields: [
            { key: 'api_key', label: 'API Key', type: 'password', required: true }
        ],
        exportPath: 'Settings > Export Data'
    },
    wiseagent: {
        fields: [
            { key: 'username', label: 'Username', type: 'text', required: true },
            { key: 'password', label: 'Password', type: 'password', required: true }
        ],
        exportPath: 'Settings > Data Management > Export'
    },
    kvcore: {
        fields: [
            { key: 'api_key', label: 'API Key', type: 'password', required: true }
        ],
        exportPath: 'Admin > Integrations'
    },
    boomtown: {
        fields: [
            { key: 'api_key', label: 'API Key', type: 'password', required: true }
        ],
        exportPath: 'Contact your BoomTown rep for API access'
    },
    contactually: {
        fields: [
            { key: 'api_key', label: 'API Key', type: 'password', required: true }
        ],
        exportPath: 'Settings > Integrations & API'
    },
    topproducer: {
        fields: [
            { key: 'username', label: 'Username', type: 'text', required: true },
            { key: 'password', label: 'Password', type: 'password', required: true }
        ],
        exportPath: 'File > Export'
    },
    realvolve: {
        fields: [
            { key: 'api_key', label: 'API Key', type: 'password', required: true }
        ],
        exportPath: 'Settings > API Access'
    },
    propertybase: {
        fields: [
            { key: 'username', label: 'Salesforce Username', type: 'text', required: true },
            { key: 'password', label: 'Salesforce Password', type: 'password', required: true },
            { key: 'security_token', label: 'Security Token', type: 'password', required: true }
        ],
        exportPath: 'Uses Salesforce API - get credentials from Setup > Security'
    },
    // General CRMs
    salesforce: {
        fields: [
            { key: 'username', label: 'Username', type: 'text', required: true },
            { key: 'password', label: 'Password', type: 'password', required: true },
            { key: 'security_token', label: 'Security Token', type: 'password', required: true }
        ],
        docs: 'https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/',
        exportPath: 'Setup > Data > Data Export'
    },
    hubspot: {
        fields: [
            { key: 'api_key', label: 'Private App Token', type: 'password', required: true, help: 'Settings > Integrations > Private Apps' }
        ],
        docs: 'https://developers.hubspot.com/docs/api/overview',
        exportPath: 'Settings > Data Management > Export'
    },
    zoho: {
        fields: [
            { key: 'client_id', label: 'Client ID', type: 'text', required: true },
            { key: 'client_secret', label: 'Client Secret', type: 'password', required: true },
            { key: 'refresh_token', label: 'Refresh Token', type: 'password', required: true }
        ],
        docs: 'https://www.zoho.com/crm/developer/docs/api/v2/',
        exportPath: 'Setup > Data Administration > Export'
    },
    pipedrive: {
        fields: [
            { key: 'api_token', label: 'API Token', type: 'password', required: true, help: 'Personal Preferences > API' }
        ],
        docs: 'https://developers.pipedrive.com/docs/api/v1',
        exportPath: 'Settings > Export Data'
    },
    monday: {
        fields: [
            { key: 'api_token', label: 'API Token', type: 'password', required: true }
        ],
        docs: 'https://developer.monday.com/api-reference/docs',
        exportPath: 'Admin > API'
    }
};

export default function CRMConnectionModal({ crm, onClose, onImportComplete }) {
    const [credentials, setCredentials] = useState({});
    const [isConnecting, setIsConnecting] = useState(false);
    const [isImporting, setIsImporting] = useState(false);
    const [connectionStatus, setConnectionStatus] = useState(null); // 'success', 'error', null
    const [importType, setImportType] = useState('contacts');
    const [importCount, setImportCount] = useState(0);
    const [savedConnection, setSavedConnection] = useState(null);
    const [showFieldMapping, setShowFieldMapping] = useState(false);
    const [sampleData, setSampleData] = useState(null);
    const [fieldMappings, setFieldMappings] = useState(null);

    const config = CRM_API_CONFIGS[crm.id] || {};
    const fields = config.fields || [];

    // Load saved connection on mount
    useEffect(() => {
        const loadConnection = async () => {
            try {
                const user = await base44.auth.me();
                const savedConnections = user.crm_connections ? JSON.parse(user.crm_connections) : {};
                if (savedConnections[crm.id]) {
                    setSavedConnection(savedConnections[crm.id]);
                    setCredentials(savedConnections[crm.id]);
                    setConnectionStatus('success');
                }
            } catch (error) {
                console.error('Error loading connection:', error);
            }
        };
        loadConnection();
    }, [crm.id]);

    const handleCredentialChange = (key, value) => {
        setCredentials(prev => ({ ...prev, [key]: value }));
    };

    const handleTestConnection = async () => {
        setIsConnecting(true);
        setConnectionStatus(null);

        try {
            // Validate all required fields
            const missingFields = fields.filter(f => f.required && !credentials[f.key]);
            if (missingFields.length > 0) {
                toast.error(`Please fill in: ${missingFields.map(f => f.label).join(', ')}`);
                setIsConnecting(false);
                return;
            }

            toast.info('Testing connection...');
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Save credentials
            const user = await base44.auth.me();
            const savedConnections = user.crm_connections ? JSON.parse(user.crm_connections) : {};
            savedConnections[crm.id] = credentials;
            await base44.auth.updateMe({ crm_connections: JSON.stringify(savedConnections) });
            
            setSavedConnection(credentials);
            setConnectionStatus('success');
            toast.success('Connected! Credentials saved. Ready to import.');
        } catch (error) {
            setConnectionStatus('error');
            toast.error(`Connection failed: ${error.message}`);
        } finally {
            setIsConnecting(false);
        }
    };

    const handleDisconnect = async () => {
        try {
            const user = await base44.auth.me();
            const savedConnections = user.crm_connections ? JSON.parse(user.crm_connections) : {};
            delete savedConnections[crm.id];
            await base44.auth.updateMe({ crm_connections: JSON.stringify(savedConnections) });
            
            setSavedConnection(null);
            setCredentials({});
            setConnectionStatus(null);
            toast.success('Disconnected from ' + crm.name);
        } catch (error) {
            toast.error('Failed to disconnect');
        }
    };

    const handleConfigureMapping = async () => {
        setIsImporting(true);
        try {
            toast.info('Fetching sample data from CRM...');
            
            const { data: response } = await base44.functions.invoke('importFromCRM', {
                crmType: crm.id,
                credentials: credentials,
                importType: importType,
                previewOnly: true,
                limit: 1
            });

            if (response?.success && response?.sample) {
                setSampleData(response.sample);
                setShowFieldMapping(true);
            } else {
                throw new Error('Could not fetch sample data');
            }
        } catch (error) {
            toast.error('Failed to fetch sample data');
        } finally {
            setIsImporting(false);
        }
    };

    const handleImport = async () => {
        if (connectionStatus !== 'success') {
            toast.error('Please test the connection first');
            return;
        }

        setIsImporting(true);

        try {
            toast.info('Connecting to CRM and fetching data...');
            
            const { data: response } = await base44.functions.invoke('importFromCRM', {
                crmType: crm.id,
                credentials: credentials,
                importType: importType,
                fieldMappings: fieldMappings
            });

            console.log('Import response:', response);

            if (response?.success) {
                setImportCount(response.imported);
                toast.success(`Successfully imported ${response.imported} ${importType}!`);
                
                // Trigger global data refresh
                window.dispatchEvent(new CustomEvent('refreshGlobalData'));
                
                // Close modal and navigate
                setTimeout(() => {
                    onImportComplete?.();
                    onClose();
                }, 1500);
            } else {
                throw new Error(response?.error || 'Import failed - please check your credentials');
            }

        } catch (error) {
            console.error('Import error:', error);
            const errorMsg = error.response?.data?.error || error.message || 'Please check your credentials and try again';
            toast.error(`Import failed: ${errorMsg}`);
        } finally {
            setIsImporting(false);
        }
    };

    return (
        <Dialog open={true} onOpenChange={onClose}>
            <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-lg bg-gradient-to-br ${crm.color} flex items-center justify-center`}>
                            <crm.icon className="w-5 h-5 text-white" />
                        </div>
                        Connect to {crm.name}
                    </DialogTitle>
                </DialogHeader>

                <div className="space-y-6">
                    {/* Connection Status */}
                    {savedConnection && (
                        <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                            <div className="flex items-start justify-between">
                                <div className="flex items-center gap-3">
                                    <CheckCircle className="w-5 h-5 text-green-600" />
                                    <div>
                                        <h4 className="font-semibold text-green-900 dark:text-green-100">Connected to {crm.name}</h4>
                                        <p className="text-sm text-green-700 dark:text-green-300">Ready to import data directly</p>
                                    </div>
                                </div>
                                <Button
                                    size="sm"
                                    variant="ghost"
                                    onClick={handleDisconnect}
                                    className="text-red-600 hover:text-red-700 hover:bg-red-50"
                                >
                                    <X className="w-4 h-4 mr-1" />
                                    Disconnect
                                </Button>
                            </div>
                        </div>
                    )}

                    {/* Connection Instructions */}
                    {!savedConnection && (
                        <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                            <h4 className="font-semibold text-blue-900 dark:text-blue-100 mb-2">How to Connect</h4>
                            <ol className="text-sm text-blue-800 dark:text-blue-200 space-y-1 list-decimal list-inside">
                                <li>Enter your {crm.name} API credentials below</li>
                                <li>Click "Connect & Save" to verify access</li>
                                <li>Choose what to import and click "Start Import"</li>
                                <li>All your data will be imported automatically!</li>
                            </ol>
                            {config.exportPath && (
                                <p className="text-xs text-blue-700 dark:text-blue-300 mt-2">
                                    🔑 Credentials Location: {config.exportPath}
                                </p>
                            )}
                        </div>
                    )}

                    {/* API Credentials Form */}
                    {!savedConnection && (
                        <div className="space-y-4">
                            <h4 className="font-semibold text-slate-900 dark:text-white">API Credentials</h4>
                            {fields.map(field => (
                                <div key={field.key} className="space-y-2">
                                    <Label htmlFor={field.key}>
                                        {field.label}
                                        {field.required && <span className="text-red-500 ml-1">*</span>}
                                    </Label>
                                    <Input
                                        id={field.key}
                                        type={field.type}
                                        value={credentials[field.key] || ''}
                                        onChange={(e) => handleCredentialChange(field.key, e.target.value)}
                                        placeholder={field.help || `Enter your ${field.label}`}
                                    />
                                    {field.help && (
                                        <p className="text-xs text-slate-500 dark:text-slate-400">{field.help}</p>
                                    )}
                                </div>
                            ))}

                            {fields.length === 0 && (
                                <div className="text-center py-4 text-slate-600 dark:text-slate-400">
                                    <p className="mb-2">Direct API integration coming soon for {crm.name}!</p>
                                    <p className="text-sm">For now, please export your data as CSV from {crm.name}.</p>
                                </div>
                            )}

                            {fields.length > 0 && (
                                <Button
                                    onClick={handleTestConnection}
                                    disabled={isConnecting}
                                    className="w-full"
                                    style={{ background: 'var(--theme-primary)' }}
                                >
                                    {isConnecting ? (
                                        <>
                                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                            Connecting...
                                        </>
                                    ) : (
                                        <>
                                            <CheckCircle className="w-4 h-4 mr-2" />
                                            Connect & Save
                                        </>
                                    )}
                                </Button>
                            )}
                        </div>
                    )}

                    {/* Import Options (shown after successful connection) */}
                    {connectionStatus === 'success' && (
                        <div className="space-y-4 pt-4 border-t">
                            <h4 className="font-semibold text-slate-900 dark:text-white">Import Data</h4>
                            <div className="space-y-3">
                                <Label>What would you like to import?</Label>
                                <Select value={importType} onValueChange={setImportType}>
                                    <SelectTrigger>
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="contacts">Contacts</SelectItem>
                                        <SelectItem value="leads">Leads</SelectItem>
                                        <SelectItem value="properties">Properties/Listings</SelectItem>
                                        <SelectItem value="deals">Deals/Transactions</SelectItem>
                                        <SelectItem value="all">Everything</SelectItem>
                                    </SelectContent>
                                </Select>

                                <div className="space-y-3">
                                    <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
                                        <p className="text-sm text-green-900 dark:text-green-100 mb-2">
                                            <strong>Ready to Import!</strong>
                                        </p>
                                        <p className="text-sm text-green-800 dark:text-green-200">
                                            Configure custom field mappings or start import with auto-mapping.
                                        </p>
                                        {importCount > 0 && (
                                            <p className="text-sm text-green-700 dark:text-green-300 mt-2 font-semibold">
                                                ✓ Successfully imported {importCount} records!
                                            </p>
                                        )}
                                    </div>

                                    <Button
                                        onClick={handleConfigureMapping}
                                        disabled={isImporting}
                                        variant="outline"
                                        className="w-full gap-2"
                                    >
                                        <ArrowRight className="w-4 h-4" />
                                        Configure Field Mapping
                                    </Button>
                                    
                                    {fieldMappings && (
                                        <div className="text-xs text-green-600 dark:text-green-400 text-center">
                                            ✓ Custom mapping configured
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Documentation Link */}
                    {config.docs && (
                        <div className="text-center">
                            <a
                                href={config.docs}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-sm text-blue-600 dark:text-blue-400 hover:underline"
                            >
                                View {crm.name} API Documentation →
                            </a>
                        </div>
                    )}

                    {/* Actions */}
                    <div className="flex justify-end gap-3 pt-4 border-t">
                        <Button variant="outline" onClick={onClose}>
                            {connectionStatus === 'success' ? 'Done' : 'Cancel'}
                        </Button>
                        {connectionStatus === 'success' && importCount === 0 && (
                            <Button
                                onClick={handleImport}
                                disabled={isImporting}
                                className="gap-2"
                                style={{ background: 'var(--theme-primary)' }}
                            >
                                {isImporting ? (
                                    <>
                                        <Loader2 className="w-4 h-4 animate-spin" />
                                        Importing...
                                    </>
                                ) : (
                                    <>
                                        <Download className="w-4 h-4" />
                                        Start Import
                                    </>
                                )}
                            </Button>
                        )}
                    </div>
                </div>
                </DialogContent>

                {/* Field Mapping Modal */}
                {showFieldMapping && sampleData && (
                <FieldMappingModal
                   crm={crm}
                   sampleData={sampleData}
                   entityType={importType === 'contacts' ? 'Contact' : importType === 'leads' ? 'Lead' : importType === 'properties' ? 'Property' : 'Contact'}
                   onSave={(mappingConfig) => {
                       setFieldMappings(mappingConfig);
                       setShowFieldMapping(false);
                       toast.success('Field mapping configured!');
                   }}
                   onClose={() => setShowFieldMapping(false)}
                />
                )}
                </Dialog>
                );
                }
import React, { useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Upload, FileText, AlertCircle } from "lucide-react";
import { toast } from "sonner";

export default function CSVImportModal({ type, onImport, onClose }) {
  const [file, setFile] = useState(null);
  const [preview, setPreview] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);

  const getFieldsForType = (type) => {
    if (type === 'team_members') {
      return ['full_name', 'email', 'phone', 'role', 'license_number', 'specialization', 'office', 'commission_split'];
    }
    if (type === 'service_providers') {
      return ['company_name', 'provider_type', 'contact_name', 'email', 'phone', 'address', 'website', 'services_offered', 'pricing_notes', 'rating'];
    }
    return [];
  };

  const handleFileChange = (e) => {
    const selectedFile = e.target.files[0];
    if (!selectedFile) return;

    if (!selectedFile.name.endsWith('.csv')) {
      toast.error("Please select a CSV file");
      return;
    }

    setFile(selectedFile);
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const text = event.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          toast.error("CSV file must have at least a header row and one data row");
          return;
        }

        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const data = lines.slice(1, 6).map(line => {
          const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
          const obj = {};
          headers.forEach((header, i) => {
            obj[header] = values[i] || '';
          });
          return obj;
        });

        setPreview(data);
        toast.success(`Preview loaded: ${lines.length - 1} rows found`);
      } catch (error) {
        console.error("Error parsing CSV:", error);
        toast.error("Error parsing CSV file");
      }
    };
    
    reader.readAsText(selectedFile);
  };

  const handleImport = () => {
    if (!file || preview.length === 0) {
      toast.error("Please select a valid CSV file first");
      return;
    }

    setIsProcessing(true);
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const text = event.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        const data = lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
          const obj = {};
          headers.forEach((header, i) => {
            let value = values[i] || '';
            
            // Type conversions
            if (type === 'team_members') {
              if (header === 'commission_split') value = parseFloat(value) || 50;
              if (header === 'is_active') value = value.toLowerCase() === 'true';
            }
            if (type === 'service_providers') {
              if (header === 'rating') value = parseFloat(value) || 0;
              if (header === 'is_active') value = value.toLowerCase() === 'true';
              if (header === 'is_preferred') value = value.toLowerCase() === 'true';
            }
            
            obj[header] = value;
          });
          return obj;
        });

        onImport(data, type);
      } catch (error) {
        console.error("Error importing CSV:", error);
        toast.error("Error importing CSV file");
      }
      setIsProcessing(false);
    };
    
    reader.readAsText(file);
  };

  const downloadTemplate = () => {
    const fields = getFieldsForType(type);
    const csvContent = fields.join(',') + '\n';
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${type}_template.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    toast.success("Template downloaded");
  };

  const typeLabels = {
    'team_members': 'Team Members',
    'service_providers': 'Service Providers'
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Import {typeLabels[type]} from CSV</DialogTitle>
        </DialogHeader>

        <div className="space-y-6">
          {/* Instructions */}
          <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <div className="flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
              <div className="text-sm text-blue-900 dark:text-blue-100">
                <p className="font-semibold mb-2">CSV Import Instructions:</p>
                <ul className="list-disc list-inside space-y-1 text-blue-800 dark:text-blue-200">
                  <li>Download the template below to see the required format</li>
                  <li>Fill in your data using the same column headers</li>
                  <li>Save as CSV and upload</li>
                  <li>Preview shows first 5 rows before importing</li>
                </ul>
              </div>
            </div>
          </div>

          {/* Download Template */}
          <div>
            <Button onClick={downloadTemplate} variant="outline" className="w-full">
              <FileText className="w-4 h-4 mr-2" />
              Download CSV Template
            </Button>
          </div>

          {/* File Upload */}
          <div className="space-y-2">
            <Label>Upload CSV File</Label>
            <div className="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg p-8 text-center">
              <input
                type="file"
                accept=".csv"
                onChange={handleFileChange}
                className="hidden"
                id="csv-upload"
              />
              <label htmlFor="csv-upload" className="cursor-pointer">
                <Upload className="w-12 h-12 mx-auto mb-3 text-slate-400" />
                <p className="text-sm text-slate-600 dark:text-slate-300 mb-1">
                  {file ? file.name : "Click to upload CSV file"}
                </p>
                <p className="text-xs text-slate-500 dark:text-slate-400">
                  CSV files only
                </p>
              </label>
            </div>
          </div>

          {/* Preview */}
          {preview.length > 0 && (
            <div className="space-y-2">
              <Label>Preview (First 5 rows)</Label>
              <div className="border border-slate-200 dark:border-slate-700 rounded-lg overflow-auto max-h-64">
                <table className="w-full text-xs">
                  <thead className="bg-slate-50 dark:bg-slate-800">
                    <tr>
                      {Object.keys(preview[0]).map((header) => (
                        <th key={header} className="px-3 py-2 text-left font-semibold text-slate-700 dark:text-slate-300">
                          {header}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {preview.map((row, i) => (
                      <tr key={i} className="border-t border-slate-200 dark:border-slate-700">
                        {Object.values(row).map((value, j) => (
                          <td key={j} className="px-3 py-2 text-slate-600 dark:text-slate-300">
                            {value}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Actions */}
          <div className="flex justify-end gap-3 pt-4 border-t">
            <Button type="button" variant="outline" onClick={onClose}>
              Cancel
            </Button>
            <Button 
              onClick={handleImport} 
              disabled={!file || preview.length === 0 || isProcessing}
              className="app-button"
            >
              {isProcessing ? "Importing..." : "Import Data"}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Plus, Edit, Trash2, FileText } from 'lucide-react';
import { toast } from 'sonner';
import DocumentTypeModal from './DocumentTypeModal';
import { Skeleton } from "@/components/ui/skeleton";

export default function DocumentTypeManagement() {
    const queryClient = useQueryClient();
    const [showModal, setShowModal] = useState(false);
    const [editingType, setEditingType] = useState(null);

    const { data: types = [], isLoading } = useQuery({
        queryKey: ['allDocumentTypes'],
        queryFn: () => base44.entities.DocumentType.list().catch(() => []),
    });

    const saveMutation = useMutation({
        mutationFn: (typeData) => editingType
            ? base44.entities.DocumentType.update(editingType.id, typeData)
            : base44.entities.DocumentType.create(typeData),
        onSuccess: () => {
            toast.success(`Document type ${editingType ? 'updated' : 'created'} successfully!`);
            queryClient.invalidateQueries({ queryKey: ['allDocumentTypes'] });
            setShowModal(false);
            setEditingType(null);
        },
        onError: (error) => toast.error(`Failed to save document type: ${error.message}`),
    });

    const deleteMutation = useMutation({
        mutationFn: (id) => base44.entities.DocumentType.delete(id),
        onSuccess: () => {
            toast.success("Document type deleted successfully!");
            queryClient.invalidateQueries({ queryKey: ['allDocumentTypes'] });
        },
        onError: (error) => toast.error(`Failed to delete document type: ${error.message}`),
    });

    const handleEdit = (type) => {
        setEditingType(type);
        setShowModal(true);
    };

    const handleDelete = (id) => {
        if (window.confirm("Are you sure you want to delete this document type?")) {
            deleteMutation.mutate(id);
        }
    };

    const SkeletonLoader = () => (
      <div className="space-y-4">
        {[...Array(2)].map((_, i) => (
          <div key={i} className="p-4 border rounded-lg flex items-center justify-between">
            <div className="space-y-2">
                <Skeleton className="h-5 w-36" />
                <Skeleton className="h-4 w-24" />
            </div>
            <div className="flex items-center gap-2">
                <Skeleton className="h-9 w-9" />
                <Skeleton className="h-9 w-9" />
            </div>
          </div>
        ))}
      </div>
    );
    
    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <div className="flex items-center justify-between">
                        <div>
                            <CardTitle>Document Types</CardTitle>
                            <CardDescription>Organize your documents by creating custom types.</CardDescription>
                        </div>
                        <Button onClick={() => { setEditingType(null); setShowModal(true); }}>
                            <Plus className="w-4 h-4 mr-2" />
                            New Document Type
                        </Button>
                    </div>
                </CardHeader>
                <CardContent>
                    {isLoading && <SkeletonLoader />}
                    {!isLoading && types.length === 0 && (
                         <div className="text-center py-16">
                           <FileText className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                           <h3 className="text-xl font-semibold">No Document Types Found</h3>
                           <p className="text-slate-500 mt-2">Click "New Document Type" to add your first one.</p>
                        </div>
                    )}
                    {!isLoading && types.length > 0 && (
                      <div className="space-y-4">
                          {types.map(type => (
                              <div key={type.id} className="p-4 border rounded-lg flex items-center justify-between">
                                  <div>
                                      <p className="font-semibold">{type.name}</p>
                                      <p className="text-sm text-slate-500 capitalize">{type.category?.replace('_', ' ')}</p>
                                  </div>
                                  <div className="flex items-center gap-2">
                                      <Button variant="outline" size="icon" onClick={() => handleEdit(type)}><Edit className="w-4 h-4" /></Button>
                                      <Button variant="destructive" size="icon" onClick={() => handleDelete(type.id)}><Trash2 className="w-4 h-4" /></Button>
                                  </div>
                              </div>
                          ))}
                      </div>
                    )}
                </CardContent>
            </Card>

            {showModal && (
                <DocumentTypeModal
                    documentType={editingType}
                    onSave={(data) => saveMutation.mutate(data)}
                    onClose={() => {
                        setShowModal(false);
                        setEditingType(null);
                    }}
                    isSaving={saveMutation.isLoading}
                />
            )}
        </div>
    );
}
import React, { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Loader2 } from 'lucide-react';
import { Checkbox } from '@/components/ui/checkbox';

const CATEGORIES = ["contract", "disclosure", "inspection", "appraisal", "title", "closing", "marketing", "financial", "legal", "other"];

export default function DocumentTypeModal({ documentType, onSave, onClose, isSaving }) {
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    category: 'other',
    required_for_transaction: false,
    is_active: true
  });

  useEffect(() => {
    if (documentType) {
      setFormData({
        name: documentType.name || '',
        description: documentType.description || '',
        category: documentType.category || 'other',
        required_for_transaction: documentType.required_for_transaction || false,
        is_active: documentType.is_active ?? true,
      });
    }
  }, [documentType]);

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
  };

  const handleSelectChange = (name, value) => {
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData);
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>{documentType ? 'Edit Document Type' : 'Create Document Type'}</DialogTitle>
          <DialogDescription>
            Define custom types to organize your transaction documents.
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="name">Type Name</Label>
            <Input id="name" name="name" value={formData.name} onChange={handleChange} placeholder="e.g., 'Listing Agreement'" required />
          </div>
          <div className="space-y-2">
            <Label htmlFor="category">Category</Label>
            <Select name="category" value={formData.category} onValueChange={(value) => handleSelectChange('category', value)}>
              <SelectTrigger>
                <SelectValue placeholder="Select a category" />
              </SelectTrigger>
              <SelectContent>
                {CATEGORIES.map(cat => (
                  <SelectItem key={cat} value={cat}>{cat.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div className="flex items-center space-x-2">
            <Checkbox id="required_for_transaction" name="required_for_transaction" checked={formData.required_for_transaction} onCheckedChange={(checked) => handleSelectChange('required_for_transaction', checked)}/>
            <Label htmlFor="required_for_transaction">Required for Transaction Completion</Label>
          </div>
           <div className="flex items-center space-x-2">
            <Checkbox id="is_active" name="is_active" checked={formData.is_active} onCheckedChange={(checked) => handleSelectChange('is_active', checked)}/>
            <Label htmlFor="is_active">Active</Label>
          </div>
          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose}>Cancel</Button>
            <Button type="submit" disabled={isSaving}>
              {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              {isSaving ? 'Saving...' : 'Save'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import {
  Key,
  Plus,
  Trash2,
  Eye,
  EyeOff,
  Copy,
  AlertTriangle,
  Shield,
  Database,
  CheckCircle2,
} from "lucide-react";
import { toast } from "sonner";

export default function EnvironmentVariables() {
  const [secrets, setSecrets] = useState([
    { name: 'NAR_API_KEY', value: '', isVisible: false, isExisting: false },
    { name: 'RESEND_API_KEY', value: '••••••••••••', isVisible: false, isExisting: true },
  ]);
  const [newSecretName, setNewSecretName] = useState('');
  const [newSecretValue, setNewSecretValue] = useState('');

  const toggleVisibility = (index) => {
    setSecrets(prev => prev.map((secret, i) => 
      i === index ? { ...secret, isVisible: !secret.isVisible } : secret
    ));
  };

  const handleCopy = (value) => {
    if (value && value !== '••••••••••••') {
      navigator.clipboard.writeText(value);
      toast.success("Copied to clipboard!");
    } else {
      toast.error("Cannot copy masked value");
    }
  };

  const handleAddSecret = () => {
    if (!newSecretName.trim() || !newSecretValue.trim()) {
      toast.error("Please enter both secret name and value");
      return;
    }

    setSecrets(prev => [...prev, {
      name: newSecretName.trim(),
      value: newSecretValue.trim(),
      isVisible: false,
      isExisting: false
    }]);

    setNewSecretName('');
    setNewSecretValue('');
    toast.success(`Secret "${newSecretName}" added! (Note: This is a demo - secrets are managed in the Base44 dashboard)`);
  };

  const handleDeleteSecret = (index) => {
    const secret = secrets[index];
    if (secret.isExisting) {
      toast.error("Cannot delete existing secrets from here. Please use the Base44 dashboard.");
      return;
    }

    if (window.confirm(`Delete secret "${secret.name}"?`)) {
      setSecrets(prev => prev.filter((_, i) => i !== index));
      toast.success("Secret deleted");
    }
  };

  const handleSaveSecrets = () => {
    toast.info("⚠️ Important: Environment variables must be set in the Base44 Dashboard", {
      description: "Go to Dashboard → Settings → Environment Variables to manage your secrets securely.",
      duration: 5000
    });
  };

  return (
    <div className="space-y-6">
      <Card className="border-2 border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20">
        <CardContent className="p-6">
          <div className="flex items-start gap-3">
            <AlertTriangle className="w-6 h-6 text-amber-600 dark:text-amber-400 flex-shrink-0 mt-1" />
            <div>
              <h3 className="font-semibold text-amber-900 dark:text-amber-100 mb-2">
                Environment Variables Management
              </h3>
              <p className="text-sm text-amber-800 dark:text-amber-200 mb-3">
                For security reasons, environment variables (secrets) must be managed through the <strong>Base44 Dashboard</strong>, 
                not from within your app.
              </p>
              <div className="bg-white dark:bg-amber-950/50 p-4 rounded-lg border border-amber-200 dark:border-amber-800">
                <p className="text-sm font-semibold text-amber-900 dark:text-amber-100 mb-2">
                  📍 How to Add/Edit Environment Variables:
                </p>
                <ol className="text-sm text-amber-800 dark:text-amber-200 space-y-1 list-decimal list-inside">
                  <li>Go to the <strong>Base44 Dashboard</strong> (outside this app)</li>
                  <li>Navigate to <strong>Settings → Environment Variables</strong></li>
                  <li>Add your secrets (e.g., <code className="bg-amber-100 dark:bg-amber-900 px-1 rounded">NAR_API_KEY</code>)</li>
                  <li>Save and restart your app if needed</li>
                </ol>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
          <CardTitle className="flex items-center gap-2">
            <Key className="w-5 h-5 text-indigo-600" />
            Current Environment Variables
          </CardTitle>
        </CardHeader>
        <CardContent className="pt-6">
          <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
            View your configured environment variables. Values are masked for security.
          </p>

          {/* Existing Secrets */}
          <div className="space-y-3 mb-6">
            {secrets.map((secret, index) => (
              <div
                key={index}
                className="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700"
              >
                <Shield className="w-5 h-5 text-indigo-600 flex-shrink-0" />
                
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <p className="font-semibold text-slate-900 dark:text-white text-sm">
                      {secret.name}
                    </p>
                    {secret.isExisting && (
                      <Badge variant="outline" className="text-xs bg-green-50 text-green-700 dark:bg-green-900/30">
                        <CheckCircle2 className="w-3 h-3 mr-1" />
                        Active
                      </Badge>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    <code className="text-xs font-mono text-slate-600 dark:text-slate-400 bg-slate-100 dark:bg-slate-900 px-2 py-1 rounded">
                      {secret.isVisible ? secret.value : '••••••••••••••••'}
                    </code>
                  </div>
                </div>

                <div className="flex items-center gap-1">
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => toggleVisibility(index)}
                    disabled={secret.isExisting}
                    className="h-8 w-8"
                  >
                    {secret.isVisible ? (
                      <EyeOff className="w-4 h-4" />
                    ) : (
                      <Eye className="w-4 h-4" />
                    )}
                  </Button>
                  
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => handleCopy(secret.value)}
                    disabled={secret.isExisting}
                    className="h-8 w-8"
                  >
                    <Copy className="w-4 h-4" />
                  </Button>
                  
                  {!secret.isExisting && (
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => handleDeleteSecret(index)}
                      className="h-8 w-8 text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20"
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* Add New Secret (Demo) */}
          <div className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-4">
            <h4 className="font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
              <Plus className="w-4 h-4" />
              Add New Secret (Demo Only)
            </h4>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
              <div className="space-y-2">
                <Label htmlFor="secretName" className="text-xs">Secret Name</Label>
                <Input
                  id="secretName"
                  placeholder="e.g., STRIPE_API_KEY"
                  value={newSecretName}
                  onChange={(e) => setNewSecretName(e.target.value)}
                  className="font-mono text-sm"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="secretValue" className="text-xs">Secret Value</Label>
                <Input
                  id="secretValue"
                  type="password"
                  placeholder="Enter secret value..."
                  value={newSecretValue}
                  onChange={(e) => setNewSecretValue(e.target.value)}
                  className="font-mono text-sm"
                />
              </div>
            </div>
            <Button
              onClick={handleAddSecret}
              size="sm"
              variant="outline"
              className="w-full"
            >
              <Plus className="w-4 h-4 mr-2" />
              Add Secret (Demo)
            </Button>
            <p className="text-xs text-slate-500 dark:text-slate-400 mt-2 text-center">
              This is for demonstration only. Real secrets must be added via Base44 Dashboard.
            </p>
          </div>
        </CardContent>
      </Card>

      {/* Required Secrets Guide */}
      <Card className="border-2 border-blue-200 dark:border-blue-800">
        <CardHeader className="bg-blue-50 dark:bg-blue-900/20">
          <CardTitle className="flex items-center gap-2 text-lg">
            <Database className="w-5 h-5 text-blue-600" />
            Required Secrets for RealtyMind Features
          </CardTitle>
        </CardHeader>
        <CardContent className="pt-6">
          <div className="space-y-4">
            <div className="flex items-start gap-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                <Key className="w-4 h-4 text-white" />
              </div>
              <div className="flex-1">
                <p className="font-semibold text-slate-900 dark:text-white text-sm mb-1">NAR_API_KEY</p>
                <p className="text-xs text-slate-600 dark:text-slate-400">
                  Required for NAR Agent Search feature. Get from NAR developer portal.
                </p>
              </div>
              <Badge variant="outline" className="text-xs">
                {secrets.find(s => s.name === 'NAR_API_KEY')?.value ? 'Set' : 'Not Set'}
              </Badge>
            </div>

            <div className="flex items-start gap-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
              <div className="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
                <Key className="w-4 h-4 text-white" />
              </div>
              <div className="flex-1">
                <p className="font-semibold text-slate-900 dark:text-white text-sm mb-1">RESEND_API_KEY</p>
                <p className="text-xs text-slate-600 dark:text-slate-400">
                  Required for email integration via Resend. Currently active.
                </p>
              </div>
              <Badge className="text-xs bg-green-600 text-white">
                <CheckCircle2 className="w-3 h-3 mr-1" />
                Active
              </Badge>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
import React, { useState, useEffect, useMemo } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { toast } from 'sonner';
import { base44 } from '@/api/base44Client';
import { Loader2, Sparkles, Save, ArrowRight, CheckCircle, AlertCircle, Plus, Zap, X } from 'lucide-react';
import { autoMapFields } from './SmartFieldMapper';

// Entity field configurations
const ENTITY_FIELD_CONFIGS = {
    Contact: [
        { key: 'name', label: 'Name', required: true, type: 'string' },
        { key: 'email', label: 'Email', required: false, type: 'email' },
        { key: 'phone', label: 'Phone', required: false, type: 'string' },
        { key: 'relationship', label: 'Relationship', required: false, type: 'string' },
        { key: 'property_address', label: 'Property Address', required: false, type: 'string' },
        { key: 'notes', label: 'Notes', required: false, type: 'text' },
        { key: 'tags', label: 'Tags', required: false, type: 'string' },
        { key: 'lead_source', label: 'Lead Source', required: false, type: 'string' },
        { key: 'industry', label: 'Industry', required: false, type: 'string' },
    ],
    Lead: [
        { key: 'name', label: 'Name', required: true, type: 'string' },
        { key: 'email', label: 'Email', required: true, type: 'email' },
        { key: 'phone', label: 'Phone', required: false, type: 'string' },
        { key: 'status', label: 'Status', required: false, type: 'string' },
        { key: 'lead_source', label: 'Lead Source', required: false, type: 'string' },
        { key: 'score', label: 'Score', required: false, type: 'number' },
        { key: 'notes', label: 'Notes', required: false, type: 'text' },
    ],
    Property: [
        { key: 'address', label: 'Address', required: true, type: 'string' },
        { key: 'city', label: 'City', required: false, type: 'string' },
        { key: 'state', label: 'State', required: false, type: 'string' },
        { key: 'zip_code', label: 'Zip Code', required: false, type: 'string' },
        { key: 'price', label: 'Price', required: true, type: 'number' },
        { key: 'bedrooms', label: 'Bedrooms', required: false, type: 'number' },
        { key: 'bathrooms', label: 'Bathrooms', required: false, type: 'number' },
        { key: 'square_feet', label: 'Square Feet', required: false, type: 'number' },
    ],
    Buyer: [
        { key: 'first_name', label: 'First Name', required: true, type: 'string' },
        { key: 'last_name', label: 'Last Name', required: true, type: 'string' },
        { key: 'email', label: 'Email', required: true, type: 'email' },
        { key: 'phone', label: 'Phone', required: false, type: 'string' },
        { key: 'budget_min', label: 'Min Budget', required: false, type: 'number' },
        { key: 'budget_max', label: 'Max Budget', required: false, type: 'number' },
    ]
};

// Metadata fields to skip
const SKIP_FIELDS = ['id', 'Id', 'created_date', 'updated_date', 'attributes', 'CreatedDate', 'LastModifiedDate'];

export default function FieldMappingModal({ crm, sampleData = {}, entityType = 'Contact', onSave, onClose }) {
    const [mappings, setMappings] = useState({});
    const [customFieldMappings, setCustomFieldMappings] = useState({});
    const [savedMappings, setSavedMappings] = useState([]);
    const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false);
    const [isSaving, setIsSaving] = useState(false);
    const [mappingName, setMappingName] = useState('');
    const [showSaveDialog, setShowSaveDialog] = useState(false);
    const [showCustomFieldDialog, setShowCustomFieldDialog] = useState(false);
    const [customFieldSource, setCustomFieldSource] = useState('');
    const [newCustomFieldName, setNewCustomFieldName] = useState('');

    const targetFields = ENTITY_FIELD_CONFIGS[entityType] || [];
    const sourceFields = useMemo(() => 
        Object.keys(sampleData).filter(f => !SKIP_FIELDS.includes(f)), 
        [sampleData]
    );

    // Load saved mappings
    useEffect(() => {
        loadSavedMappings();
    }, [crm.id, entityType]);

    // Auto-map ALL fields on first load
    useEffect(() => {
        if (sourceFields.length === 0 || Object.keys(mappings).length > 0) return;

        const autoMapped = autoMapFields(sourceFields, targetFields);
        setMappings(autoMapped.mappings);
        
        // Auto-create custom fields for ALL unmapped fields
        const newCustomFieldMappings = { ...autoMapped.customFieldMappings };
        const mappedSources = Object.values(autoMapped.mappings);
        
        sourceFields.forEach(sourceField => {
            if (!mappedSources.includes(sourceField) && !newCustomFieldMappings[sourceField]) {
                const cleanName = sourceField
                    .replace(/^custom:\s*/i, '')
                    .replace(/^address\s*-\s*/i, '')
                    .replace(/^owner\s*\d+\s*/i, '')
                    .replace(/_/g, ' ')
                    .trim();
                
                newCustomFieldMappings[sourceField] = {
                    name: cleanName.replace(/\b\w/g, l => l.toUpperCase()),
                    key: `custom_${cleanName.toLowerCase().replace(/[^a-z0-9]/g, '_')}`
                };
            }
        });
        
        setCustomFieldMappings(newCustomFieldMappings);
        
        const standardMapped = Object.keys(autoMapped.mappings).length;
        const customMapped = Object.keys(newCustomFieldMappings).length;
        
        toast.success(`✅ Auto-mapped ${standardMapped} standard + ${customMapped} custom fields. All ${sourceFields.length} fields ready!`, {
            duration: 6000
        });
    }, [sourceFields.length]);

    const loadSavedMappings = async () => {
        try {
            const user = await base44.auth.me();
            const saved = user.field_mappings ? JSON.parse(user.field_mappings) : {};
            const key = `${crm.id}_${entityType}`;
            setSavedMappings(saved[key] || []);
        } catch (error) {
            console.error('Error loading mappings:', error);
        }
    };

    const generateAISuggestions = async () => {
        setIsLoadingSuggestions(true);
        try {
            const prompt = `Map CRM fields to our system. Source fields from ${crm.name}:
${sourceFields.map(f => `- ${f} (sample: ${JSON.stringify(sampleData[f]).substring(0, 50)})`).join('\n')}

Target fields for ${entityType}:
${targetFields.map(f => `- ${f.key} (${f.label}, ${f.type}, required: ${f.required})`).join('\n')}

Return JSON: { "source_field": "target_field" }. Only include clear matches.`;

            const response = await base44.integrations.Core.InvokeLLM({
                prompt,
                response_json_schema: {
                    type: 'object',
                    additionalProperties: { type: 'string' }
                }
            });

            setMappings(response || {});
            toast.success('AI mapping suggestions applied!');
        } catch (error) {
            console.error('AI suggestion error:', error);
            toast.error('Failed to generate suggestions');
        } finally {
            setIsLoadingSuggestions(false);
        }
    };

    const handleMappingChange = (targetField, sourceField) => {
        if (sourceField === 'none') {
            const newMappings = { ...mappings };
            delete newMappings[targetField];
            setMappings(newMappings);
        } else if (sourceField === 'create_custom') {
            setCustomFieldSource(targetField);
            setShowCustomFieldDialog(true);
        } else {
            setMappings(prev => ({ ...prev, [targetField]: sourceField }));
        }
    };

    const handleAddCustomField = () => {
        if (!newCustomFieldName.trim()) {
            toast.error('Please enter a custom field name');
            return;
        }
        
        const customKey = `custom_${newCustomFieldName.toLowerCase().replace(/\s+/g, '_')}`;
        setCustomFieldMappings(prev => ({
            ...prev,
            [customFieldSource]: {
                name: newCustomFieldName,
                key: customKey
            }
        }));
        
        toast.success(`Custom field "${newCustomFieldName}" created!`);
        setShowCustomFieldDialog(false);
        setNewCustomFieldName('');
        setCustomFieldSource('');
    };

    const handleSaveMapping = async () => {
        if (!mappingName.trim()) {
            toast.error('Please enter a name for this mapping');
            return;
        }

        setIsSaving(true);
        try {
            const user = await base44.auth.me();
            const saved = user.field_mappings ? JSON.parse(user.field_mappings) : {};
            const key = `${crm.id}_${entityType}`;
            
            if (!saved[key]) saved[key] = [];
            
            saved[key].push({
                name: mappingName,
                mappings,
                customFieldMappings,
                created: new Date().toISOString()
            });

            await base44.auth.updateMe({ field_mappings: JSON.stringify(saved) });
            
            toast.success('Mapping saved!');
            setShowSaveDialog(false);
            setMappingName('');
            loadSavedMappings();
        } catch (error) {
            toast.error('Failed to save mapping');
        } finally {
            setIsSaving(false);
        }
    };

    const loadSavedMapping = (savedMapping) => {
        setMappings(savedMapping.mappings);
        if (savedMapping.customFieldMappings) {
            setCustomFieldMappings(savedMapping.customFieldMappings);
        }
        toast.success(`Loaded "${savedMapping.name}"`);
    };

    const inverseMappings = useMemo(() => {
        const inverse = {};
        Object.entries(mappings).forEach(([target, source]) => {
            if (source) inverse[source] = target;
        });
        return inverse;
    }, [mappings]);

    const requiredFieldsMapped = useMemo(() => 
        targetFields.filter(f => f.required).every(f => mappings[f.key]),
        [targetFields, mappings]
    );

    const totalMapped = Object.values(mappings).filter(Boolean).length;
    const totalCustom = Object.keys(customFieldMappings).length;

    return (
        <Dialog open={true} onOpenChange={onClose}>
            <DialogContent className="max-w-5xl max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-3">
                        <ArrowRight className="w-5 h-5" />
                        Field Mapping: {crm.name} → {entityType}
                    </DialogTitle>
                </DialogHeader>

                <div className="space-y-6">
                    {/* Actions Bar */}
                    <div className="flex items-center justify-between gap-3 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                        <div className="flex items-center gap-3 flex-wrap">
                            <Button
                                onClick={() => {
                                    const autoMapped = autoMapFields(sourceFields, targetFields);
                                    setMappings(autoMapped.mappings);
                                    setCustomFieldMappings(autoMapped.customFieldMappings);
                                    toast.success(`Auto-mapped ${Object.keys(autoMapped.mappings).length} fields!`);
                                }}
                                variant="outline"
                                size="sm"
                            >
                                <Zap className="w-4 h-4 mr-2" />
                                Smart Auto-Map
                            </Button>

                            <Button
                                onClick={generateAISuggestions}
                                disabled={isLoadingSuggestions}
                                variant="outline"
                                size="sm"
                            >
                                {isLoadingSuggestions ? (
                                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                ) : (
                                    <Sparkles className="w-4 h-4 mr-2" />
                                )}
                                AI Suggest
                            </Button>

                            {savedMappings.length > 0 && (
                                <Select onValueChange={(idx) => loadSavedMapping(savedMappings[idx])}>
                                    <SelectTrigger className="w-48 h-9">
                                        <SelectValue placeholder="Load saved..." />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {savedMappings.map((sm, idx) => (
                                            <SelectItem key={idx} value={idx}>
                                                {sm.name}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            )}
                        </div>

                        <Button
                            onClick={() => setShowSaveDialog(true)}
                            variant="outline"
                            size="sm"
                        >
                            <Save className="w-4 h-4 mr-2" />
                            Save
                        </Button>
                    </div>

                    {/* Status Bar */}
                    <div className="flex items-center gap-4 flex-wrap">
                        <Badge variant={requiredFieldsMapped ? "default" : "destructive"} className="gap-1">
                            {requiredFieldsMapped ? (
                                <CheckCircle className="w-3 h-3" />
                            ) : (
                                <AlertCircle className="w-3 h-3" />
                            )}
                            {requiredFieldsMapped ? 'All required fields mapped' : 'Missing required fields'}
                        </Badge>
                        <span className="text-sm text-slate-600 dark:text-slate-400">
                            {totalMapped} standard • {totalCustom} custom • {sourceFields.length} total
                        </span>
                    </div>

                    {/* Field Mapping List */}
                    <Card className="p-4">
                        <h4 className="font-semibold text-slate-900 dark:text-white mb-4">
                            Map All Fields ({sourceFields.length} found)
                        </h4>
                        <div className="space-y-2 max-h-[500px] overflow-y-auto">
                            {sourceFields.map(sourceField => {
                                const mappedTarget = inverseMappings[sourceField];
                                const isCustom = customFieldMappings[sourceField];
                                
                                return (
                                    <div 
                                        key={sourceField} 
                                        className={`p-3 rounded-lg border transition-colors ${
                                            isCustom
                                                ? 'bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800'
                                                : mappedTarget 
                                                ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' 
                                                : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700'
                                        }`}
                                    >
                                        <div className="flex items-start justify-between gap-4">
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <p className="text-sm font-semibold text-slate-900 dark:text-white truncate">
                                                        {sourceField}
                                                    </p>
                                                    {(mappedTarget || isCustom) && (
                                                        <Badge variant="default" className={`text-xs ${isCustom ? 'bg-purple-600' : 'bg-green-600'}`}>
                                                            ✓ {isCustom ? 'Custom' : 'Mapped'}
                                                        </Badge>
                                                    )}
                                                </div>
                                                <p className="text-xs text-slate-500 truncate">
                                                    {String(sampleData[sourceField] || 'N/A').substring(0, 60)}
                                                </p>
                                                {isCustom && (
                                                    <p className="text-xs text-purple-700 dark:text-purple-300 font-medium mt-1">
                                                        → Custom: {isCustom.name}
                                                    </p>
                                                )}
                                                {mappedTarget && (
                                                    <p className="text-xs text-green-700 dark:text-green-300 font-medium mt-1">
                                                        → {targetFields.find(f => f.key === mappedTarget)?.label}
                                                    </p>
                                                )}
                                            </div>

                                            <div className="flex-shrink-0">
                                                {isCustom ? (
                                                    <Button
                                                        size="sm"
                                                        variant="ghost"
                                                        onClick={() => {
                                                            const newCustom = { ...customFieldMappings };
                                                            delete newCustom[sourceField];
                                                            setCustomFieldMappings(newCustom);
                                                        }}
                                                    >
                                                        <X className="w-3 h-3" />
                                                    </Button>
                                                ) : (
                                                    <Select
                                                        value={mappedTarget || 'none'}
                                                        onValueChange={(targetField) => {
                                                            if (targetField === 'none') {
                                                                const newMappings = { ...mappings };
                                                                Object.keys(newMappings).forEach(key => {
                                                                    if (newMappings[key] === sourceField) {
                                                                        delete newMappings[key];
                                                                    }
                                                                });
                                                                setMappings(newMappings);
                                                            } else if (targetField === 'create_custom') {
                                                                setCustomFieldSource(sourceField);
                                                                setShowCustomFieldDialog(true);
                                                            } else {
                                                                handleMappingChange(targetField, sourceField);
                                                            }
                                                        }}
                                                    >
                                                        <SelectTrigger className={`w-[180px] h-8 ${mappedTarget ? 'border-green-500' : ''}`}>
                                                            <SelectValue placeholder="Map to..." />
                                                        </SelectTrigger>
                                                        <SelectContent className="max-h-[400px]">
                                                            <SelectItem value="none">
                                                                <span className="text-slate-400">Skip field</span>
                                                            </SelectItem>
                                                            <SelectItem value="create_custom">
                                                                <span className="text-purple-600 font-medium">✨ Custom Field</span>
                                                            </SelectItem>

                                                            {targetFields.filter(f => f.required).length > 0 && (
                                                                <>
                                                                    <div className="px-2 py-1.5 text-xs font-semibold text-slate-500 bg-slate-50 dark:bg-slate-900">
                                                                        Required
                                                                    </div>
                                                                    {targetFields.filter(f => f.required).map(field => (
                                                                        <SelectItem 
                                                                            key={field.key} 
                                                                            value={field.key}
                                                                            disabled={mappings[field.key] && mappings[field.key] !== sourceField}
                                                                        >
                                                                            {field.label} {mappings[field.key] && mappings[field.key] !== sourceField && '(used)'}
                                                                        </SelectItem>
                                                                    ))}
                                                                </>
                                                            )}

                                                            <div className="px-2 py-1.5 text-xs font-semibold text-slate-500 bg-slate-50 dark:bg-slate-900">
                                                                Optional
                                                            </div>
                                                            {targetFields.filter(f => !f.required).map(field => (
                                                                <SelectItem 
                                                                    key={field.key} 
                                                                    value={field.key}
                                                                    disabled={mappings[field.key] && mappings[field.key] !== sourceField}
                                                                >
                                                                    {field.label} {mappings[field.key] && mappings[field.key] !== sourceField && '(used)'}
                                                                </SelectItem>
                                                            ))}
                                                        </SelectContent>
                                                    </Select>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <p className="text-xs text-slate-500 mt-4">
                            💡 Unmapped fields are stored in custom_fields and displayed on contact cards
                        </p>
                    </Card>

                    {/* Footer Actions */}
                    <div className="flex justify-end gap-3 pt-4 border-t">
                        <Button variant="outline" onClick={onClose}>
                            Cancel
                        </Button>
                        <Button
                            onClick={() => onSave({ mappings, customFieldMappings })}
                            disabled={!requiredFieldsMapped}
                        >
                            <CheckCircle className="w-4 h-4 mr-2" />
                            Apply Mapping
                        </Button>
                    </div>
                </div>

                {/* Save Mapping Dialog */}
                {showSaveDialog && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <Card className="p-6 max-w-md w-full mx-4">
                            <h3 className="font-semibold text-lg mb-4">Save Mapping Configuration</h3>
                            <div className="space-y-4">
                                <div>
                                    <Label>Mapping Name</Label>
                                    <Input
                                        value={mappingName}
                                        onChange={(e) => setMappingName(e.target.value)}
                                        placeholder="e.g., Standard Contact Import"
                                        className="mt-1"
                                    />
                                </div>
                                <div className="flex justify-end gap-3">
                                    <Button variant="outline" onClick={() => setShowSaveDialog(false)}>
                                        Cancel
                                    </Button>
                                    <Button onClick={handleSaveMapping} disabled={isSaving}>
                                        {isSaving ? (
                                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                        ) : (
                                            <Save className="w-4 h-4 mr-2" />
                                        )}
                                        Save
                                    </Button>
                                </div>
                            </div>
                        </Card>
                    </div>
                )}

                {/* Create Custom Field Dialog */}
                {showCustomFieldDialog && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <Card className="p-6 max-w-md w-full mx-4">
                            <h3 className="font-semibold text-lg mb-4">Create Custom Field</h3>
                            <div className="space-y-4">
                                <div>
                                    <Label>Source Field</Label>
                                    <Input
                                        value={customFieldSource}
                                        disabled
                                        className="mt-1 bg-slate-100 dark:bg-slate-800"
                                    />
                                </div>
                                <div>
                                    <Label>Custom Field Name</Label>
                                    <Input
                                        value={newCustomFieldName}
                                        onChange={(e) => setNewCustomFieldName(e.target.value)}
                                        placeholder="e.g., Anniversary Date"
                                        className="mt-1"
                                        autoFocus
                                    />
                                    <p className="text-xs text-slate-500 mt-1">
                                        Stored in custom_fields and displayed on contact cards
                                    </p>
                                </div>
                                <div className="flex justify-end gap-3">
                                    <Button variant="outline" onClick={() => setShowCustomFieldDialog(false)}>
                                        Cancel
                                    </Button>
                                    <Button onClick={handleAddCustomField}>
                                        <Plus className="w-4 h-4 mr-2" />
                                        Create Field
                                    </Button>
                                </div>
                            </div>
                        </Card>
                    </div>
                )}
            </DialogContent>
        </Dialog>
    );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { Save, Calendar, Sparkles, Loader2 } from "lucide-react";
import { Skeleton } from "@/components/ui/skeleton";

export default function HolidaySettings() {
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    const [preferences, setPreferences] = useState({
        show_federal: true,
        show_religious: [],
        show_cultural: false
    });

    useEffect(() => {
        loadPreferences();
    }, []);

    const loadPreferences = async () => {
        setIsLoading(true);
        try {
            const user = await base44.auth.me();
            if (user.holiday_preferences) {
                try {
                    const prefs = JSON.parse(user.holiday_preferences);
                    setPreferences(prefs);
                } catch (e) {
                    console.error("Failed to parse holiday preferences:", e);
                }
            }
        } catch (error) {
            toast.error("Failed to load holiday settings.");
        } finally {
            setIsLoading(false);
        }
    };

    const handleSave = async () => {
        setIsSaving(true);
        try {
            await base44.auth.updateMe({
                holiday_preferences: JSON.stringify(preferences)
            });
            toast.success("Holiday settings updated!");
        } catch (error) {
            toast.error("Failed to update holiday settings.");
        } finally {
            setIsSaving(false);
        }
    };

    const toggleReligion = (religion) => {
        const updated = preferences.show_religious.includes(religion)
            ? preferences.show_religious.filter(r => r !== religion)
            : [...preferences.show_religious, religion];
        setPreferences({ ...preferences, show_religious: updated });
    };

    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <Skeleton className="h-6 w-1/2" />
                    <Skeleton className="h-4 w-3/4" />
                </CardHeader>
                <CardContent className="space-y-4">
                    <Skeleton className="h-12 w-full" />
                    <Skeleton className="h-12 w-full" />
                    <Skeleton className="h-12 w-full" />
                </CardContent>
            </Card>
        );
    }

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Calendar className="w-5 h-5 text-purple-600" />
                        Calendar Holidays Display
                    </CardTitle>
                    <CardDescription>Choose which holidays appear on your calendar</CardDescription>
                </CardHeader>
                <CardContent className="space-y-6">
                    <h4 className="font-semibold text-slate-700 dark:text-slate-300">US Federal Holidays</h4>
                    <div className="space-y-3">
                        <div className="flex items-center justify-between p-4 border rounded-lg bg-slate-50 dark:bg-slate-800">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                                    🇺🇸
                                </div>
                                <div>
                                    <Label className="font-semibold cursor-pointer">US Federal Holidays</Label>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">
                                        New Year's, MLK Day, Presidents Day, Memorial Day, Independence Day, Labor Day, Columbus Day, Veterans Day, Thanksgiving, Christmas
                                    </p>
                                </div>
                            </div>
                            <Checkbox
                                checked={preferences.show_federal}
                                onCheckedChange={(checked) => setPreferences({ ...preferences, show_federal: checked })}
                            />
                        </div>
                    </div>

                    {/* Religious Holidays */}
                    <div className="space-y-3">
                        <h4 className="font-semibold text-slate-700 dark:text-slate-300">Religious Holidays</h4>
                        
                        <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-red-100 dark:bg-red-900 rounded-lg">✝️</div>
                                <div>
                                    <Label className="font-semibold cursor-pointer">Christian Holidays</Label>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">
                                        Easter, Good Friday, Christmas Eve, etc.
                                    </p>
                                </div>
                            </div>
                            <Checkbox
                                checked={preferences.show_religious.includes('christian')}
                                onCheckedChange={() => toggleReligion('christian')}
                            />
                        </div>

                        <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">✡️</div>
                                <div>
                                    <Label className="font-semibold cursor-pointer">Jewish Holidays</Label>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">
                                        Rosh Hashanah, Yom Kippur, Hanukkah, Passover, etc.
                                    </p>
                                </div>
                            </div>
                            <Checkbox
                                checked={preferences.show_religious.includes('jewish')}
                                onCheckedChange={() => toggleReligion('jewish')}
                            />
                        </div>

                        <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-green-100 dark:bg-green-900 rounded-lg">☪️</div>
                                <div>
                                    <Label className="font-semibold cursor-pointer">Muslim Holidays</Label>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">
                                        Ramadan, Eid al-Fitr, Eid al-Adha, etc.
                                    </p>
                                </div>
                            </div>
                            <Checkbox
                                checked={preferences.show_religious.includes('muslim')}
                                onCheckedChange={() => toggleReligion('muslim')}
                            />
                        </div>

                        <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-orange-100 dark:bg-orange-900 rounded-lg">🕉️</div>
                                <div>
                                    <Label className="font-semibold cursor-pointer">Hindu Holidays</Label>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">
                                        Diwali, Holi, Navaratri, etc.
                                    </p>
                                </div>
                            </div>
                            <Checkbox
                                checked={preferences.show_religious.includes('hindu')}
                                onCheckedChange={() => toggleReligion('hindu')}
                            />
                        </div>

                        <div className="flex items-center justify-between p-4 border rounded-lg">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-yellow-100 dark:bg-yellow-900 rounded-lg">☸️</div>
                                <div>
                                    <Label className="font-semibold cursor-pointer">Buddhist Holidays</Label>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">
                                        Vesak, Bodhi Day, Nirvana Day, etc.
                                    </p>
                                </div>
                            </div>
                            <Checkbox
                                checked={preferences.show_religious.includes('buddhist')}
                                onCheckedChange={() => toggleReligion('buddhist')}
                            />
                        </div>
                    </div>

                    {/* Cultural Observances */}
                    <div className="space-y-3">
                        <h4 className="font-semibold text-slate-700 dark:text-slate-300">Cultural Observances</h4>
                        <div className="flex items-center justify-between p-4 border rounded-lg bg-slate-50 dark:bg-slate-800">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-purple-100 dark:bg-purple-900 rounded-lg">
                                    <Sparkles className="w-5 h-5 text-purple-600" />
                                </div>
                                <div>
                                    <Label className="font-semibold cursor-pointer">Cultural Observances</Label>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">
                                        St. Patrick's Day, Cinco de Mayo, Halloween, etc.
                                    </p>
                                </div>
                            </div>
                            <Checkbox
                                checked={preferences.show_cultural}
                                onCheckedChange={(checked) => setPreferences({ ...preferences, show_cultural: checked })}
                            />
                        </div>
                    </div>

                    <div className="pt-4 border-t">
                        <p className="text-xs text-slate-500 dark:text-slate-400">
                            💡 Holidays will appear as colored banners on your calendar. Federal holidays with "businesses closed" will be highlighted prominently to help you plan your schedule.
                        </p>
                    </div>
                </CardContent>
            </Card>

            <div className="flex justify-end">
                <Button onClick={handleSave} disabled={isSaving}>
                    {isSaving ? (
                        <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Saving...
                        </>
                    ) : (
                        <>
                            <Save className="w-4 h-4 mr-2" />
                            Save Holiday Settings
                        </>
                    )}
                </Button>
            </div>
        </div>
    );
}
import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Plus, Edit, Trash2, Share2, Globe, Users } from 'lucide-react';
import { toast } from 'sonner';
import LeadSourceModal from './LeadSourceModal';
import { Skeleton } from "@/components/ui/skeleton";

export default function LeadSourceManagement() {
    const queryClient = useQueryClient();
    const [showModal, setShowModal] = useState(false);
    const [editingSource, setEditingSource] = useState(null);

    const { data: sources = [], isLoading } = useQuery({
        queryKey: ['allLeadSources'],
        queryFn: () => base44.entities.LeadSource.list().catch(() => []),
    });

    const saveMutation = useMutation({
        mutationFn: (sourceData) => editingSource 
            ? base44.entities.LeadSource.update(editingSource.id, sourceData) 
            : base44.entities.LeadSource.create(sourceData),
        onSuccess: () => {
            toast.success(`Lead source ${editingSource ? 'updated' : 'created'} successfully!`);
            queryClient.invalidateQueries({ queryKey: ['allLeadSources'] });
            setShowModal(false);
            setEditingSource(null);
        },
        onError: (error) => toast.error(`Failed to save lead source: ${error.message}`),
    });

    const deleteMutation = useMutation({
        mutationFn: (id) => base44.entities.LeadSource.delete(id),
        onSuccess: () => {
            toast.success("Lead source deleted successfully!");
            queryClient.invalidateQueries({ queryKey: ['allLeadSources'] });
        },
        onError: (error) => toast.error(`Failed to delete lead source: ${error.message}`),
    });

    const handleEdit = (source) => {
        setEditingSource(source);
        setShowModal(true);
    };

    const handleDelete = (id) => {
        if (window.confirm("Are you sure you want to delete this lead source?")) {
            deleteMutation.mutate(id);
        }
    };
    
    const sourceTypeIcons = { website: Globe, referral: Users, social_media: Share2, default: Share2 };

    const SkeletonLoader = () => (
      <div className="space-y-4">
        {[...Array(2)].map((_, i) => (
          <div key={i} className="p-4 border rounded-lg flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Skeleton className="w-5 h-5 rounded-full" />
              <div className="space-y-2">
                  <Skeleton className="h-5 w-32" />
                  <Skeleton className="h-4 w-24" />
              </div>
            </div>
            <div className="flex items-center gap-2">
                <Skeleton className="h-9 w-9" />
                <Skeleton className="h-9 w-9" />
            </div>
          </div>
        ))}
      </div>
    );

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <div className="flex items-center justify-between">
                        <div>
                            <CardTitle>Lead Sources</CardTitle>
                            <CardDescription>Manage where your leads originate from.</CardDescription>
                        </div>
                        <Button onClick={() => { setEditingSource(null); setShowModal(true); }}>
                            <Plus className="w-4 h-4 mr-2" />
                            New Lead Source
                        </Button>
                    </div>
                </CardHeader>
                <CardContent>
                    {isLoading && <SkeletonLoader />}
                    {!isLoading && sources.length === 0 && (
                        <div className="text-center py-16">
                           <Share2 className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                           <h3 className="text-xl font-semibold">No Lead Sources Found</h3>
                           <p className="text-slate-500 mt-2">Click "New Lead Source" to add your first one.</p>
                        </div>
                    )}
                    {!isLoading && sources.length > 0 && (
                      <div className="space-y-4">
                          {sources.map(source => {
                              const Icon = sourceTypeIcons[source.source_type] || sourceTypeIcons.default;
                              return (
                                  <div key={source.id} className="p-4 border rounded-lg flex items-center justify-between">
                                      <div className="flex items-center gap-3">
                                          <Icon className="w-5 h-5 text-slate-500" />
                                          <div>
                                              <p className="font-semibold">{source.name}</p>
                                              <p className="text-sm text-slate-500 capitalize">{source.source_type?.replace('_', ' ')}</p>
                                          </div>
                                      </div>
                                      <div className="flex items-center gap-2">
                                          <Button variant="outline" size="icon" onClick={() => handleEdit(source)}><Edit className="w-4 h-4" /></Button>
                                          <Button variant="destructive" size="icon" onClick={() => handleDelete(source.id)}><Trash2 className="w-4 h-4" /></Button>
                                      </div>
                                  </div>
                              );
                          })}
                      </div>
                    )}
                </CardContent>
            </Card>

            {showModal && (
                <LeadSourceModal
                    leadSource={editingSource}
                    onSave={(data) => saveMutation.mutate(data)}
                    onClose={() => {
                        setShowModal(false);
                        setEditingSource(null);
                    }}
                    isSaving={saveMutation.isLoading}
                />
            )}
        </div>
    );
}
import React, { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Loader2 } from 'lucide-react';
import { Checkbox } from '@/components/ui/checkbox';

const SOURCE_TYPES = ["website", "referral", "social_media", "open_house", "cold_call", "advertising", "walk_in", "other"];

export default function LeadSourceModal({ leadSource, onSave, onClose, isSaving }) {
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    source_type: 'other',
    tracking_url: '',
    cost_per_lead: 0,
    is_active: true
  });

  useEffect(() => {
    if (leadSource) {
      setFormData({
        name: leadSource.name || '',
        description: leadSource.description || '',
        source_type: leadSource.source_type || 'other',
        tracking_url: leadSource.tracking_url || '',
        cost_per_lead: leadSource.cost_per_lead || 0,
        is_active: leadSource.is_active ?? true
      });
    }
  }, [leadSource]);

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
  };
  
  const handleNumberChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: parseFloat(value) || 0 }));
  };

  const handleSelectChange = (name, value) => {
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData);
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>{leadSource ? 'Edit Lead Source' : 'Create Lead Source'}</DialogTitle>
          <DialogDescription>
            Track where your leads come from to better analyze your marketing efforts.
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="name">Source Name</Label>
            <Input id="name" name="name" value={formData.name} onChange={handleChange} placeholder="e.g., 'Zillow Premier Agent'" required />
          </div>
          <div className="space-y-2">
            <Label htmlFor="source_type">Source Type</Label>
            <Select name="source_type" value={formData.source_type} onValueChange={(value) => handleSelectChange('source_type', value)}>
              <SelectTrigger>
                <SelectValue placeholder="Select a type" />
              </SelectTrigger>
              <SelectContent>
                {SOURCE_TYPES.map(type => (
                  <SelectItem key={type} value={type}>{type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div className="flex items-center space-x-2">
              <Checkbox id="is_active" name="is_active" checked={formData.is_active} onCheckedChange={(checked) => handleSelectChange('is_active', checked)} />
              <Label htmlFor="is_active">Active</Label>
          </div>
          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose}>Cancel</Button>
            <Button type="submit" disabled={isSaving}>
              {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              {isSaving ? 'Saving...' : 'Save'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { Slider } from "@/components/ui/slider";
import { Input } from "@/components/ui/input";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { DollarSign, Save, Facebook, Instagram, Linkedin, Megaphone, Mail, Edit, ArrowUpRight } from "lucide-react";
import { Skeleton } from "@/components/ui/skeleton";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";

const marketingChannels = [
    { id: 'facebook', label: 'Facebook', icon: Facebook },
    { id: 'instagram', label: 'Instagram', icon: Instagram },
    { id: 'linkedin', label: 'LinkedIn', icon: Linkedin },
    { id: 'google_ads', label: 'Google Ads', icon: Megaphone },
    { id: 'email', label: 'Email Marketing', icon: Mail },
    { id: 'direct_mail', label: 'Direct Mail', icon: Mail },
];

export default function MarketingSettings() {
    const navigate = useNavigate();
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    
    // User object state
    const [user, setUser] = useState(null);

    // Marketing State
    const [commissionAllocation, setCommissionAllocation] = useState(10);
    const [preferredChannels, setPreferredChannels] = useState([]);
    
    // Manual Adjustment Modal State
    const [showAdjustModal, setShowAdjustModal] = useState(false);
    const [newBudgetValue, setNewBudgetValue] = useState("");

    useEffect(() => {
        loadInitialData();
    }, []);

    const loadInitialData = async () => {
        setIsLoading(true);
        try {
            const currentUser = await base44.auth.me();
            if (currentUser) {
                setUser(currentUser);
                setCommissionAllocation(currentUser.marketing_commission_allocation ?? 10);
                setPreferredChannels(JSON.parse(currentUser.preferred_marketing_channels || '[]'));
                setNewBudgetValue(currentUser.marketing_budget_balance || 0);
            }
        } catch (error) {
            toast.error("Failed to load marketing settings.");
        } finally {
            setIsLoading(false);
        }
    };

    const handleSave = async () => {
        setIsSaving(true);
        try {
            await base44.auth.updateMe({
                marketing_commission_allocation: commissionAllocation,
                preferred_marketing_channels: JSON.stringify(preferredChannels),
            });
            toast.success("Marketing settings updated!");
        } catch (error) {
            toast.error("Failed to update marketing settings.");
        } finally {
            setIsSaving(false);
        }
    };

    const handleBudgetAdjustment = async () => {
        const amount = parseFloat(newBudgetValue);
        if (isNaN(amount) || amount < 0) {
            toast.error("Please enter a valid, non-negative budget amount.");
            return;
        }

        setIsSaving(true);
        try {
            const updatedUser = await base44.auth.updateMe({ marketing_budget_balance: amount });
            setUser(updatedUser);
            toast.success("Marketing budget successfully adjusted!");
            setShowAdjustModal(false);
        } catch (error) {
            toast.error("Failed to adjust marketing budget.");
        } finally {
            setIsSaving(false);
        }
    };

     const handleChannelChange = (channelId) => {
        setPreferredChannels(prev => 
            prev.includes(channelId) 
                ? prev.filter(id => id !== channelId)
                : [...prev, channelId]
        );
    };

     if (isLoading) {
        return (
             <Card>
                <CardHeader>
                    <Skeleton className="h-6 w-1/2" />
                    <Skeleton className="h-4 w-3/4" />
                </CardHeader>
                <CardContent className="space-y-6">
                   <div className="space-y-2">
                       <Skeleton className="h-4 w-1/3" />
                       <Skeleton className="h-10 w-full" />
                   </div>
                    <div className="space-y-2">
                       <Skeleton className="h-4 w-1/3" />
                       <Skeleton className="h-24 w-full" />
                   </div>
                </CardContent>
            </Card>
        )
    }

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                        <div>
                            <CardTitle className="flex items-center gap-2">
                                <DollarSign className="w-5 h-5 text-teal-600" />
                                Marketing & Budgeting
                            </CardTitle>
                            <CardDescription>Manage your automated marketing budget allocation and preferred channels.</CardDescription>
                        </div>
                        <Button variant="outline" onClick={() => navigate(createPageUrl('MarketingCampaigns'))}>
                            View Campaigns
                            <ArrowUpRight className="w-4 h-4 ml-2" />
                        </Button>
                    </div>
                </CardHeader>
                <CardContent className="space-y-8">
                    <div>
                        <Label>Default Commission Allocation for Future Deals</Label>
                        <div className="flex items-center gap-4 mt-2">
                            <Slider
                                value={[commissionAllocation]}
                                onValueChange={(value) => setCommissionAllocation(value[0])}
                                max={50}
                                step={1}
                                className="flex-1"
                            />
                            <div className="font-bold text-lg text-teal-600 w-16 text-center">
                                {commissionAllocation}%
                            </div>
                        </div>
                        <p className="text-xs text-slate-500 mt-2">This sets the default percentage suggested for reinvestment when you close a deal.</p>
                    </div>

                    <div className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
                        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                            <div>
                                <Label className="font-semibold">Current Available Budget</Label>
                                <p className="text-2xl font-bold text-slate-800 dark:text-slate-100 mt-1">
                                    {(user?.marketing_budget_balance || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}
                                </p>
                                <p className="text-xs text-slate-500 dark:text-slate-400">This balance increases from closed deals and decreases when you run campaigns.</p>
                            </div>
                            <Button variant="outline" onClick={() => {
                                setNewBudgetValue(user?.marketing_budget_balance || 0);
                                setShowAdjustModal(true);
                            }}>
                                <Edit className="w-4 h-4 mr-2" />
                                Adjust Budget
                            </Button>
                        </div>
                    </div>

                    <div>
                        <Label>Preferred Marketing Channels</Label>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mt-2">
                            {marketingChannels.map((channel) => (
                                <div key={channel.id} className="flex items-center gap-2 p-3 border rounded-lg">
                                    <Checkbox
                                        id={`channel-${channel.id}`}
                                        checked={preferredChannels.includes(channel.id)}
                                        onCheckedChange={() => handleChannelChange(channel.id)}
                                    />
                                    <Label htmlFor={`channel-${channel.id}`} className="flex items-center gap-2 cursor-pointer">
                                        <channel.icon className="w-4 h-4"/>
                                        {channel.label}
                                    </Label>
                                </div>
                            ))}
                        </div>
                         <p className="text-xs text-slate-500 mt-2">Select the channels you use most. This helps the AI provide better recommendations.</p>
                    </div>
                </CardContent>
            </Card>
            <div className="flex justify-end">
                <Button onClick={handleSave} disabled={isSaving}>
                    <Save className="w-4 h-4 mr-2" />
                    {isSaving ? "Saving..." : "Save Settings"}
                </Button>
            </div>

            {/* Manual Budget Adjustment Modal */}
            <Dialog open={showAdjustModal} onOpenChange={setShowAdjustModal}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>Manually Adjust Marketing Budget</DialogTitle>
                    </DialogHeader>
                    <div className="space-y-4 py-4">
                        <div className="space-y-2">
                        <Label htmlFor="new-budget-value">Set New Available Budget</Label>
                        <div className="relative">
                            <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                            <Input
                            id="new-budget-value"
                            type="number"
                            placeholder="e.g., 5000"
                            value={newBudgetValue}
                            onChange={(e) => setNewBudgetValue(e.target.value)}
                            className="pl-8"
                            />
                        </div>
                        </div>
                        <p className="text-sm text-slate-500">
                            Enter the new total amount you want for your available marketing budget. This will override the current balance.
                        </p>
                    </div>
                    <DialogFooter>
                        <Button variant="outline" onClick={() => setShowAdjustModal(false)}>Cancel</Button>
                        <Button onClick={handleBudgetAdjustment} disabled={isSaving}>
                           {isSaving ? "Updating..." : "Update Budget"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>

        </div>
    );
}
import React, { useState, useEffect } from "react";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from "recharts";
import { Newspaper, RefreshCw, Loader2, TrendingUp, Calendar, Zap, Database } from "lucide-react";
import { toast } from "sonner";
import { format, startOfMonth, subMonths } from "date-fns";

const getEmotionLabel = (value) => {
  if (value < 21) return "Fear / Freeze";
  if (value < 41) return "Caution";
  if (value < 61) return "Neutral";
  if (value < 81) return "Optimism";
  return "Euphoria";
};

const getEmotionColor = (value) => {
  if (value < 21) return "bg-red-500";
  if (value < 41) return "bg-orange-500";
  if (value < 61) return "bg-yellow-500";
  if (value < 81) return "bg-green-500";
  return "bg-blue-500";
};

export default function NewsSentimentSettings() {
  const queryClient = useQueryClient();
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [isBackfilling, setIsBackfilling] = useState(false);
  const [autoUpdate, setAutoUpdate] = useState(
    localStorage.getItem('news_sentiment_auto_update') === 'true'
  );

  const { data: newsArticles = [], isLoading } = useQuery({
    queryKey: ['newsArticles'],
    queryFn: async () => {
      try {
        return await base44.entities.NewsArticle.list('-publish_date');
      } catch {
        return [];
      }
    },
  });

  // Auto-calculate on mount if enabled and no articles from today
  useEffect(() => {
    if (autoUpdate && newsArticles.length > 0) {
      const today = format(new Date(), 'yyyy-MM-dd');
      const hasToday = newsArticles.some(a => {
        try {
          return format(new Date(a.publish_date), 'yyyy-MM-dd') === today;
        } catch {
          return false;
        }
      });

      if (!hasToday) {
        analyzeNewsSentiment(true);
      }
    }
  }, [autoUpdate]);

  const handleAutoUpdateToggle = (checked) => {
    setAutoUpdate(checked);
    localStorage.setItem('news_sentiment_auto_update', checked.toString());
    toast.success(checked ? "Auto-update enabled" : "Auto-update disabled");
  };

  // Generate 12 months of historical news data
  const backfillHistoricalNews = async () => {
    setIsBackfilling(true);
    
    try {
      toast.info("Generating 12 months of historical news data...");
      
      const allArticles = [];
      const today = new Date();
      
      // Generate data for past 12 months (5-10 articles per month)
      for (let i = 11; i >= 0; i--) {
        const monthDate = subMonths(startOfMonth(today), i);
        const dateStr = format(monthDate, 'yyyy-MM-dd');
        
        // Check if articles already exist for this month
        const existingMonth = newsArticles.filter(a => {
          try {
            const articleMonth = format(new Date(a.publish_date), 'yyyy-MM');
            const targetMonth = format(monthDate, 'yyyy-MM');
            return articleMonth === targetMonth;
          } catch {
            return false;
          }
        });
        
        if (existingMonth.length === 0) {
          // Generate 5-10 articles for this month with realistic sentiment
          const numArticles = 5 + Math.floor(Math.random() * 6); // 5-10 articles
          
          for (let j = 0; j < numArticles; j++) {
            // Generate realistic sentiment with trend (improving over time)
            const baseSentiment = 55;
            const trend = i * 1.5; // Gradual improvement
            const randomVariation = (Math.random() - 0.5) * 15;
            const sentiment = Math.round(Math.max(30, Math.min(90, baseSentiment + trend + randomVariation)));
            
            const sampleTitles = [
              { title: "Housing Market Shows Strong Growth", sentiment: 75 },
              { title: "Mortgage Rates Continue to Fluctuate", sentiment: 55 },
              { title: "Luxury Home Sales Hit Record Levels", sentiment: 80 },
              { title: "First-Time Buyers Face Affordability Challenges", sentiment: 45 },
              { title: "Commercial Real Estate Demand Increases", sentiment: 70 },
              { title: "NAR Reports Steady Market Conditions", sentiment: 65 },
              { title: "New Construction Permits Rise Nationwide", sentiment: 72 },
              { title: "Interest Rates Impact Buyer Decisions", sentiment: 50 },
              { title: "Real Estate Tech Innovation Accelerates", sentiment: 78 },
              { title: "Market Inventory Levels Stabilize", sentiment: 60 },
            ];
            
            const sample = sampleTitles[Math.floor(Math.random() * sampleTitles.length)];
            const sources = ["HousingWire", "Inman", "The Real Deal", "Realtor.com", "NAR"];
            
            allArticles.push({
              title: sample.title,
              content: `${sample.title}. This is a sample news article generated for historical data visualization.`,
              summary: sample.title,
              source: sources[Math.floor(Math.random() * sources.length)],
              category: "market_trends",
              relevance_score: sentiment,
              publish_date: dateStr,
              is_trending: false,
              is_featured: false,
              tags: "market analysis, real estate news"
            });
          }
        }
      }
      
      if (allArticles.length > 0) {
        // Bulk create all articles
        await base44.entities.NewsArticle.bulkCreate(allArticles);
        
        toast.success(`✅ Generated ${allArticles.length} historical news articles!`);
        queryClient.invalidateQueries({ queryKey: ['newsArticles'] });
      } else {
        toast.info("Historical news data already exists for all 12 months");
      }
      
    } catch (error) {
      console.error("Backfill error:", error);
      toast.error("Failed to generate historical news data");
    } finally {
      setIsBackfilling(false);
    }
  };

  const analyzeNewsSentiment = async (isAuto = false) => {
    setIsAnalyzing(true);

    try {
      if (!isAuto) {
        toast.info("Fetching latest real estate news...");
      }

      // Fetch and analyze latest news headlines
      const newsData = await base44.integrations.Core.InvokeLLM({
        prompt: `Find the 10 most recent real estate news headlines from the past 3 days from major industry sources like:
- Inman
- HousingWire
- The Real Deal
- Realtor.com
- NAR (National Association of Realtors)
- Zillow Research
- Redfin News

For each headline, provide:
1. The headline text
2. The source
3. A sentiment score (0-100) where:
   - 0-25: Very negative (market crash, declining sales, foreclosures)
   - 26-50: Somewhat negative (caution, concerns, slowdown)
   - 51-75: Neutral to positive (stable, moderate growth)
   - 76-100: Very positive (hot market, record sales, strong demand)

Return as JSON array.`,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            articles: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  title: { type: "string" },
                  source: { type: "string" },
                  sentiment_score: { type: "number" },
                  summary: { type: "string" }
                },
                required: ["title", "source", "sentiment_score"]
              }
            }
          },
          required: ["articles"]
        }
      });

      if (!newsData.articles || newsData.articles.length === 0) {
        toast.error("No news articles found");
        setIsAnalyzing(false);
        return;
      }

      // Calculate average sentiment
      const avgSentiment = Math.round(
        newsData.articles.reduce((sum, a) => sum + a.sentiment_score, 0) / newsData.articles.length
      );

      // Create news article records
      const today = new Date().toISOString();
      const articlesToCreate = newsData.articles.map(article => ({
        title: article.title,
        content: article.summary || article.title,
        summary: article.summary || article.title.substring(0, 200),
        source: article.source,
        category: "market_trends",
        relevance_score: article.sentiment_score,
        publish_date: today,
        is_trending: false,
        is_featured: false,
      }));

      // Bulk create articles
      await base44.entities.NewsArticle.bulkCreate(articlesToCreate);

      toast.success(`✅ Analyzed ${newsData.articles.length} articles. Average sentiment: ${avgSentiment}`);
      queryClient.invalidateQueries({ queryKey: ['newsArticles'] });

    } catch (error) {
      console.error("Analysis error:", error);
      toast.error("Failed to analyze news sentiment");
    } finally {
      setIsAnalyzing(false);
    }
  };

  // Calculate sentiment history (last 12 months, grouped by month)
  const sentimentHistory = React.useMemo(() => {
    if (newsArticles.length === 0) return [];

    // Group records by month
    const monthlyData = {};
    
    newsArticles.forEach(article => {
      try {
        const date = new Date(article.publish_date);
        const monthKey = format(date, 'yyyy-MM'); // e.g., "2024-12"
        const monthLabel = format(date, 'MMM yyyy'); // e.g., "Dec 2024"
        
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = {
            monthKey,
            monthLabel,
            values: [],
            date: date
          };
        }
        
        monthlyData[monthKey].values.push(article.relevance_score || 50);
      } catch (e) {
        console.error("Error processing article:", e);
      }
    });

    // Calculate average for each month and get last 12 months
    const monthlyAverages = Object.values(monthlyData)
      .map(month => ({
        date: format(month.date, 'MMM yyyy'),
        value: Math.round(month.values.reduce((a, b) => a + b, 0) / month.values.length),
        count: month.values.length,
        sortDate: month.date
      }))
      .sort((a, b) => a.sortDate - b.sortDate) // Sort by date ascending
      .slice(-12); // Get last 12 months

    return monthlyAverages;
  }, [newsArticles]);

  // Latest sentiment (current month)
  const latestSentiment = React.useMemo(() => {
    if (newsArticles.length === 0) return null;
    
    const currentMonth = format(new Date(), 'yyyy-MM');
    const monthArticles = newsArticles.filter(a => {
      try {
        return format(new Date(a.publish_date), 'yyyy-MM') === currentMonth;
      } catch {
        return false;
      }
    });

    if (monthArticles.length === 0) return null;

    const avgScore = monthArticles.reduce((sum, a) => sum + (a.relevance_score || 50), 0) / monthArticles.length;
    return {
      value: Math.round(avgScore),
      emotion: getEmotionLabel(avgScore),
      count: monthArticles.length
    };
  }, [newsArticles]);

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle className="flex items-center gap-2">
                <Newspaper className="w-5 h-5 text-blue-500" />
                News Sentiment Analysis
              </CardTitle>
              <CardDescription className="mt-2">
                Analyze real estate news headlines to gauge market sentiment
              </CardDescription>
            </div>
            <Button
              onClick={() => analyzeNewsSentiment(false)}
              disabled={isAnalyzing}
              className="bg-blue-600 hover:bg-blue-700"
            >
              {isAnalyzing ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Analyzing...
                </>
              ) : (
                <>
                  <RefreshCw className="w-4 h-4 mr-2" />
                  Analyze Now
                </>
              )}
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Auto Update Toggle */}
          <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
            <div className="flex items-center gap-3">
              <Zap className="w-5 h-5 text-blue-500" />
              <div>
                <Label className="font-semibold">Auto-Update on Dashboard Visit</Label>
                <p className="text-xs text-muted-foreground mt-1">
                  Automatically fetch and analyze news when you visit the dashboard
                </p>
              </div>
            </div>
            <Switch
              checked={autoUpdate}
              onCheckedChange={handleAutoUpdateToggle}
            />
          </div>

          {/* Latest Sentiment */}
          {latestSentiment && (
            <div className="p-6 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-muted-foreground mb-1">This Month's Sentiment</p>
                  <div className="flex items-center gap-3">
                    <div className="text-4xl font-bold text-blue-600">
                      {latestSentiment.value}
                    </div>
                    <div>
                      <Badge className={`${getEmotionColor(latestSentiment.value)} text-white`}>
                        {latestSentiment.emotion}
                      </Badge>
                      <p className="text-xs text-muted-foreground mt-1">
                        Based on {latestSentiment.count} articles
                      </p>
                    </div>
                  </div>
                </div>
                <TrendingUp className="w-12 h-12 text-blue-500 opacity-20" />
              </div>
            </div>
          )}

          {/* Action Buttons */}
          {sentimentHistory.length < 12 && (
            <div className="flex gap-3">
              <Button
                onClick={backfillHistoricalNews}
                disabled={isBackfilling}
                variant="outline"
              >
                {isBackfilling ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Database className="w-4 h-4 mr-2" />
                    Generate 12-Month History
                  </>
                )}
              </Button>
            </div>
          )}

          {/* Sentiment History Chart */}
          {sentimentHistory.length > 0 && (
            <div>
              <div className="flex items-center gap-2 mb-4">
                <Calendar className="w-4 h-4 text-muted-foreground" />
                <h3 className="font-semibold">12-Month Sentiment Trend</h3>
              </div>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={sentimentHistory}>
                  <XAxis 
                    dataKey="date" 
                    tick={{ fontSize: 11 }}
                    stroke="hsl(var(--muted-foreground))"
                    angle={-45}
                    textAnchor="end"
                    height={80}
                  />
                  <YAxis 
                    domain={[0, 100]}
                    tick={{ fontSize: 11 }}
                    stroke="hsl(var(--muted-foreground))"
                  />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'hsl(var(--card))',
                      border: '1px solid hsl(var(--border))',
                      borderRadius: '8px',
                      fontSize: '12px'
                    }}
                    formatter={(value, name, props) => [
                      `${value} (${props.payload.count} articles)`,
                      'Sentiment'
                    ]}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="value" 
                    stroke="#3b82f6" 
                    strokeWidth={2}
                    dot={{ fill: '#3b82f6', r: 3 }}
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>
          )}

          {/* Info */}
          <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <h4 className="font-semibold text-sm mb-2">How It Works</h4>
            <ul className="text-xs text-muted-foreground space-y-1">
              <li>• Fetches latest headlines from major real estate news sources</li>
              <li>• Analyzes sentiment of each headline (0-100 scale)</li>
              <li>• Calculates average sentiment across all articles per month</li>
              <li>• Updates your dashboard widget with current market emotion</li>
              <li>• Stores articles in your News section for reference</li>
              <li>• Shows 12-month historical trend to track sentiment changes</li>
            </ul>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator"; // New import
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { Bell, Save, Volume2, Loader2, Clock, Info } from "lucide-react"; // New icons: Loader2, Clock, Info
import { Skeleton } from "@/components/ui/skeleton";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import { useMutation, useQueryClient } from "@tanstack/react-query"; // New imports

export default function NotificationSettings({ user }) {
    const queryClient = useQueryClient();

    // Initialize states from user prop or sensible defaults
    const [notificationPrefs, setNotificationPrefs] = useState(() => {
        try {
            return user?.notification_preferences
                ? JSON.parse(user.notification_preferences)
                : {
                    notify_1_day: true,
                    notify_3_days: true,
                    notify_5_days: false,
                };
        } catch (e) {
            console.error("Failed to parse notification_preferences, using defaults.", e);
            return {
                notify_1_day: true,
                notify_3_days: true,
                notify_5_days: false,
            };
        }
    });

    const [alarmEnabled, setAlarmEnabled] = useState(user?.alarm_enabled !== false);
    const [alarmSound, setAlarmSound] = useState(user?.alarm_sound || 'beep');
    const [recurringEventShowBefore, setRecurringEventShowBefore] = useState(
        user?.recurring_event_show_before_minutes || 60
    );

    const updateSettingsMutation = useMutation({
        mutationFn: async (settings) => {
            return await base44.auth.updateMe(settings);
        },
        onSuccess: () => {
            toast.success("Notification settings updated!");
            queryClient.invalidateQueries(["currentUser"]); // Invalidate user data to reflect changes
        },
        onError: (error) => {
            console.error("Save error:", error);
            toast.error("Failed to update notification settings.");
        },
    });

    const handleSave = async () => {
        try {
            await updateSettingsMutation.mutateAsync({
                notification_preferences: JSON.stringify(notificationPrefs),
                alarm_enabled: alarmEnabled,
                alarm_sound: alarmSound,
                recurring_event_show_before_minutes: recurringEventShowBefore,
            });
        } catch (error) {
            // Error handled by mutation's onError
        }
    };

    // If user prop is not yet loaded, render skeleton
    if (!user) {
        return (
            <Card>
                <CardHeader>
                    <Skeleton className="h-6 w-1/2" />
                    <Skeleton className="h-4 w-3/4" />
                </CardHeader>
                <CardContent className="space-y-6">
                    <div className="space-y-4">
                        <Skeleton className="h-12 w-full" />
                        <Skeleton className="h-12 w-full" />
                        <Skeleton className="h-12 w-full" />
                    </div>
                    <div className="border-t pt-6">
                        <Skeleton className="h-6 w-1/3 mb-4" />
                        <div className="space-y-4">
                            <Skeleton className="h-12 w-full" />
                            <Skeleton className="h-12 w-full" />
                            <Skeleton className="h-20 w-full" />
                        </div>
                    </div>
                </CardContent>
            </Card>
        );
    }

    return (
        <div className="space-y-6">
            <div>
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Bell className="w-5 h-5 text-amber-600" />
                    Task Notifications
                </h3>
                <p className="text-sm text-muted-foreground mb-4">Choose when you get reminded about upcoming task deadlines.</p>

                <div className="space-y-4">
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                        <Label htmlFor="notify_1_day" className="cursor-pointer">Notify 1 day before due</Label>
                        <Checkbox
                            id="notify_1_day"
                            checked={notificationPrefs.notify_1_day}
                            onCheckedChange={(checked) => setNotificationPrefs({ ...notificationPrefs, notify_1_day: checked })}
                        />
                    </div>
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                        <Label htmlFor="notify_3_days" className="cursor-pointer">Notify 3 days before due</Label>
                        <Checkbox
                            id="notify_3_days"
                            checked={notificationPrefs.notify_3_days}
                            onCheckedChange={(checked) => setNotificationPrefs({ ...notificationPrefs, notify_3_days: checked })}
                        />
                    </div>
                    <div className="flex items-center justify-between p-3 border rounded-lg">
                        <Label htmlFor="notify_5_days" className="cursor-pointer">Notify 5 days before due</Label>
                        <Checkbox
                            id="notify_5_days"
                            checked={notificationPrefs.notify_5_days}
                            onCheckedChange={(checked) => setNotificationPrefs({ ...notificationPrefs, notify_5_days: checked })}
                        />
                    </div>
                </div>

                <Separator className="my-6" />

                {/* New Recurring Event Display section */}
                <div>
                    <h4 className="font-medium mb-3 flex items-center gap-2">
                        <Clock className="w-4 h-4" />
                        Recurring Event Display
                    </h4>
                    <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                        Control when recurring events (like "Take kids to school") appear in your notifications
                    </p>

                    <div className="space-y-4">
                        <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-900 rounded-lg">
                            <div className="flex-1">
                                <Label htmlFor="recurring-timing" className="font-medium">
                                    Show recurring events
                                </Label>
                                <p className="text-xs text-slate-500 mt-1">
                                    Minutes before event time to display notification
                                </p>
                            </div>
                            <Select
                                value={recurringEventShowBefore.toString()}
                                onValueChange={(value) => setRecurringEventShowBefore(parseInt(value))}
                            >
                                <SelectTrigger className="w-40">
                                    <SelectValue placeholder="Select time" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="15">15 minutes before</SelectItem>
                                    <SelectItem value="30">30 minutes before</SelectItem>
                                    <SelectItem value="45">45 minutes before</SelectItem>
                                    <SelectItem value="60">1 hour before</SelectItem>
                                    <SelectItem value="90">1.5 hours before</SelectItem>
                                    <SelectItem value="120">2 hours before</SelectItem>
                                    <SelectItem value="180">3 hours before</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>

                        <div className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                            <div className="flex gap-2">
                                <Info className="w-4 h-4 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                                <div className="text-xs text-blue-900 dark:text-blue-100">
                                    <p className="font-medium mb-1">Why this matters:</p>
                                    <p>Recurring events like daily tasks won't clutter your notifications all day. They'll only appear when you actually need to prepare for them.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <Separator className="my-6" />

                {/* Alarm Settings */}
                <div>
                    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Bell className="w-5 h-5" />
                        Meeting Alarm Settings
                    </h3>

                    <div className="space-y-4">
                        {/* Enable/Disable Alarm */}
                        <div className="flex items-center justify-between">
                            <div>
                                <label className="font-medium text-sm">Enable Meeting Alarms</label>
                                <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                    Play an escalating alarm when it's time to leave for meetings
                                </p>
                            </div>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={alarmEnabled}
                                    onChange={(e) => setAlarmEnabled(e.target.checked)}
                                    className="sr-only peer"
                                />
                                <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                            </label>
                        </div>

                        {/* Alarm Sound Selection */}
                        {alarmEnabled && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium mb-2">Alarm Sound</label>
                                    <Select
                                        value={alarmSound}
                                        onValueChange={(value) => setAlarmSound(value)}
                                    >
                                        <SelectTrigger>
                                            <SelectValue placeholder="Select alarm sound" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            <SelectItem value="beep">
                                                <div className="flex items-center gap-2">
                                                    <Volume2 className="w-4 h-4" />
                                                    <span>Beep (Classic)</span>
                                                </div>
                                            </SelectItem>
                                            <SelectItem value="chime">
                                                <div className="flex items-center gap-2">
                                                    <Volume2 className="w-4 h-4" />
                                                    <span>Chime (Gentle)</span>
                                                </div>
                                            </SelectItem>
                                            <SelectItem value="bell">
                                                <div className="flex items-center gap-2">
                                                    <Volume2 className="w-4 h-4" />
                                                    <span>Bell (Clear)</span>
                                                </div>
                                            </SelectItem>
                                            <SelectItem value="alert">
                                                <div className="flex items-center gap-2">
                                                    <Volume2 className="w-4 h-4" />
                                                    <span>Alert (Attention)</span>
                                                </div>
                                            </SelectItem>
                                            <SelectItem value="urgent">
                                                <div className="flex items-center gap-2">
                                                    <Volume2 className="w-4 h-4" />
                                                    <span>Urgent (Loud)</span>
                                                </div>
                                            </SelectItem>
                                        </SelectContent>
                                    </Select>
                                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                        The alarm starts quietly and gradually increases in volume
                                    </p>
                                </div>

                                <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                                    <p className="text-sm text-blue-800 dark:text-blue-300 flex items-start gap-2">
                                        <Bell className="w-4 h-4 mt-0.5 shrink-0" />
                                        <span>
                                            The alarm will play when you need to leave for a meeting. It starts at low volume and gradually gets louder. You can mute it directly from the meeting banner.
                                        </span>
                                    </p>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            </div>

            <div className="flex justify-end gap-3">
                <Button
                    onClick={handleSave}
                    disabled={updateSettingsMutation.isLoading}
                >
                    {updateSettingsMutation.isLoading ? (
                        <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Saving...
                        </>
                    ) : (
                        <>
                            <Save className="w-4 h-4 mr-2" />
                            Save Notification Settings
                        </>
                    )}
                </Button>
            </div>
        </div>
    );
}

import React, { useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { CreditCard } from "lucide-react";
import { toast } from "sonner";

export default function PaymentMethodModal({ onSave, onClose }) {
  const [cardForm, setCardForm] = useState({
    cardNumber: '',
    expiryDate: '',
    cvv: '',
    nameOnCard: ''
  });
  const [isSaving, setIsSaving] = useState(false);

  const handleSave = async () => {
    if (!cardForm.cardNumber || !cardForm.expiryDate || !cardForm.cvv || !cardForm.nameOnCard) {
      toast.error("Please fill in all fields");
      return;
    }

    setIsSaving(true);
    try {
      // In a real app, this would integrate with Stripe/PayPal
      // For now, just simulate success
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      toast.success("Payment method updated");
      onSave();
      onClose();
    } catch (error) {
      console.error("Error updating payment method:", error);
      toast.error("Failed to update payment method");
    }
    setIsSaving(false);
  };

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <CreditCard className="w-5 h-5" />
            Update Payment Method
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <Label htmlFor="cardNumber">Card Number</Label>
            <Input
              id="cardNumber"
              placeholder="1234 5678 9012 3456"
              value={cardForm.cardNumber}
              onChange={(e) => setCardForm({...cardForm, cardNumber: e.target.value})}
              maxLength={19}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label htmlFor="expiryDate">Expiry Date</Label>
              <Input
                id="expiryDate"
                placeholder="MM/YY"
                value={cardForm.expiryDate}
                onChange={(e) => setCardForm({...cardForm, expiryDate: e.target.value})}
                maxLength={5}
              />
            </div>
            <div>
              <Label htmlFor="cvv">CVV</Label>
              <Input
                id="cvv"
                placeholder="123"
                type="password"
                value={cardForm.cvv}
                onChange={(e) => setCardForm({...cardForm, cvv: e.target.value})}
                maxLength={4}
              />
            </div>
          </div>

          <div>
            <Label htmlFor="nameOnCard">Name on Card</Label>
            <Input
              id="nameOnCard"
              placeholder="John Doe"
              value={cardForm.nameOnCard}
              onChange={(e) => setCardForm({...cardForm, nameOnCard: e.target.value})}
            />
          </div>

          <div className="flex justify-end gap-3 pt-4 border-t">
            <Button variant="outline" onClick={onClose} disabled={isSaving}>
              Cancel
            </Button>
            <Button onClick={handleSave} disabled={isSaving}>
              {isSaving ? "Saving..." : "Save Payment Method"}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
import React, { useState, useEffect } from 'react';
import { useForm, Controller } from 'react-hook-form';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Checkbox } from '@/components/ui/checkbox';
import { toast } from 'sonner';
import { base44 } from '@/api/base44Client';
import { Loader2, MapPin, Clock, Briefcase, Building, Star, Upload, X, Camera } from 'lucide-react';

const DAYS_OF_WEEK = [
    { value: 'monday', label: 'Monday' },
    { value: 'tuesday', label: 'Tuesday' },
    { value: 'wednesday', label: 'Wednesday' },
    { value: 'thursday', label: 'Thursday' },
    { value: 'friday', label: 'Friday' },
    { value: 'saturday', label: 'Saturday' },
    { value: 'sunday', label: 'Sunday' }
];

export default function ProfileSettings({ user, onUpdate, isUpdating }) {
    const [workingDays, setWorkingDays] = useState([]);
    const [uploadingPhoto, setUploadingPhoto] = useState(false);
    const [photoUrl, setPhotoUrl] = useState(user?.profile_photo_url || '');

    const { control, handleSubmit, reset, watch, formState: { errors } } = useForm({
        mode: 'onChange',
        defaultValues: {
            full_name: user?.full_name || '',
            email: user?.email || '',
            phone: user?.phone || '',
            office: user?.office || '',
            license_number: user?.license_number || '',
            company_office_address: user?.company_office_address || '',
            company_office_city: user?.company_office_city || '',
            company_office_state: user?.company_office_state || '',
            company_office_zip: user?.company_office_zip || '',
            office_lat: user?.office_lat || '',
            office_lng: user?.office_lng || '',
            private_office_address: user?.private_office_address || '',
            private_office_city: user?.private_office_city || '',
            private_office_state: user?.private_office_state || '',
            private_office_zip: user?.private_office_zip || '',
            private_office_lat: user?.private_office_lat || '',
            private_office_lng: user?.private_office_lng || '',
            working_hours_start: user?.working_hours_start || '09:00',
            working_hours_end: user?.working_hours_end || '17:00',
            show_tasks_during_working_hours_only: user?.show_tasks_during_working_hours_only || false,
            default_office_location: user?.default_office_location || 'company'
        }
    });

    useEffect(() => {
        reset({
            full_name: user?.full_name || '',
            email: user?.email || '',
            phone: user?.phone || '',
            office: user?.office || '',
            license_number: user?.license_number || '',
            company_office_address: user?.company_office_address || '',
            company_office_city: user?.company_office_city || '',
            company_office_state: user?.company_office_state || '',
            company_office_zip: user?.company_office_zip || '',
            office_lat: user?.office_lat || '',
            office_lng: user?.office_lng || '',
            private_office_address: user?.private_office_address || '',
            private_office_city: user?.private_office_city || '',
            private_office_state: user?.private_office_state || '',
            private_office_zip: user?.private_office_zip || '',
            private_office_lat: user?.private_office_lat || '',
            private_office_lng: user?.private_office_lng || '',
            working_hours_start: user?.working_hours_start || '09:00',
            working_hours_end: user?.working_hours_end || '17:00',
            show_tasks_during_working_hours_only: user?.show_tasks_during_working_hours_only || false,
            default_office_location: user?.default_office_location || 'company'
        });

        setPhotoUrl(user?.profile_photo_url || '');

        // Parse working days
        try {
            const days = JSON.parse(user?.working_days || '["monday","tuesday","wednesday","thursday","friday"]');
            setWorkingDays(days);
        } catch (e) {
            setWorkingDays(['monday', 'tuesday', 'wednesday', 'thursday', 'friday']);
        }
    }, [user, reset]);

    const handleDayToggle = (day) => {
        setWorkingDays(prev => {
            if (prev.includes(day)) {
                return prev.filter(d => d !== day);
            } else {
                return [...prev, day];
            }
        });
    };

    const handlePhotoUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        setUploadingPhoto(true);
        try {
            const { file_url } = await base44.integrations.Core.UploadFile({ file });
            setPhotoUrl(file_url);
            
            await base44.auth.updateMe({ profile_photo_url: file_url });
            
            toast.success('Profile photo uploaded successfully!');
        } catch (error) {
            console.error('Error uploading photo:', error);
            toast.error('Failed to upload photo');
        } finally {
            setUploadingPhoto(false);
        }
    };

    const handleRemovePhoto = async () => {
        try {
            setPhotoUrl('');
            await base44.auth.updateMe({ profile_photo_url: null });
            toast.success('Profile photo removed');
        } catch (error) {
            console.error('Error removing photo:', error);
            toast.error('Failed to remove photo');
        }
    };

    const onSubmit = (data) => {
        console.log('📝 Form submitted with data:', data);
        console.log('📝 Form errors:', errors);
        
        const updateData = { 
            ...data,
            working_days: JSON.stringify(workingDays)
        };
        
        // Parse numeric fields
        if (updateData.office_lat) updateData.office_lat = parseFloat(updateData.office_lat);
        if (updateData.office_lng) updateData.office_lng = parseFloat(updateData.office_lng);
        if (updateData.private_office_lat) updateData.private_office_lat = parseFloat(updateData.private_office_lat);
        if (updateData.private_office_lng) updateData.private_office_lng = parseFloat(updateData.private_office_lng);
        
        console.log('📤 Calling onUpdate with:', updateData);
        onUpdate(updateData);
    };
    
    const onError = (errors) => {
        console.error('❌ Form validation errors:', errors);
        toast.error('Please fix validation errors before saving');
    };

    const showTasksOnly = watch('show_tasks_during_working_hours_only');

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <CardTitle>My Profile</CardTitle>
                    <CardDescription>Update your personal and professional information.</CardDescription>
                </CardHeader>
                <CardContent>
                    <form onSubmit={handleSubmit(onSubmit, onError)} className="space-y-6">
                        {/* Profile Photo Upload */}
                        <div className="flex flex-col items-center gap-4 pb-6 border-b">
                            <div className="relative">
                                <div className="w-32 h-32 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white text-4xl font-bold overflow-hidden">
                                    {photoUrl ? (
                                        <img src={photoUrl} alt="Profile" className="w-full h-full object-cover" />
                                    ) : (
                                        user?.full_name?.charAt(0) || 'A'
                                    )}
                                </div>
                                {photoUrl && (
                                    <button
                                        type="button"
                                        onClick={handleRemovePhoto}
                                        className="absolute -top-2 -right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg transition-colors"
                                    >
                                        <X className="w-4 h-4" />
                                    </button>
                                )}
                            </div>
                            <div className="text-center">
                                <Label htmlFor="photo-upload" className="cursor-pointer">
                                    <div className="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                                        {uploadingPhoto ? (
                                            <>
                                                <Loader2 className="w-4 h-4 animate-spin" />
                                                <span>Uploading...</span>
                                            </>
                                        ) : (
                                            <>
                                                <Camera className="w-4 h-4" />
                                                <span>{photoUrl ? 'Change Photo' : 'Upload Photo'}</span>
                                            </>
                                        )}
                                    </div>
                                </Label>
                                <input
                                    id="photo-upload"
                                    type="file"
                                    accept="image/*"
                                    onChange={handlePhotoUpload}
                                    className="hidden"
                                    disabled={uploadingPhoto}
                                />
                                <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                                    JPG, PNG or GIF • Max 5MB
                                </p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <Label htmlFor="full_name">Full Name</Label>
                                <Controller
                                    name="full_name"
                                    control={control}
                                    render={({ field }) => <Input id="full_name" {...field} />}
                                />
                            </div>
                            <div className="space-y-2">
                                <Label htmlFor="email">Email Address</Label>
                                <Controller
                                    name="email"
                                    control={control}
                                    render={({ field }) => <Input id="email" type="email" {...field} disabled />}
                                />
                            </div>
                            <div className="space-y-2">
                                <Label htmlFor="phone">Phone Number</Label>
                                <Controller
                                    name="phone"
                                    control={control}
                                    rules={{
                                        pattern: {
                                            value: /^\d{10}$/,
                                            message: 'Phone number must be exactly 10 digits'
                                        }
                                    }}
                                    render={({ field, fieldState }) => (
                                        <div>
                                            <Input 
                                                id="phone" 
                                                {...field} 
                                                placeholder="1234567890"
                                                maxLength={10}
                                                onChange={(e) => {
                                                    const value = e.target.value.replace(/\D/g, '');
                                                    field.onChange(value);
                                                }}
                                            />
                                            {fieldState.error && (
                                                <p className="text-xs text-red-600 mt-1">{fieldState.error.message}</p>
                                            )}
                                        </div>
                                    )}
                                />
                            </div>
                            <div className="space-y-2">
                                <Label htmlFor="office">Office/Brokerage</Label>
                                <Controller
                                    name="office"
                                    control={control}
                                    render={({ field }) => <Input id="office" {...field} />}
                                />
                            </div>
                            <div className="space-y-2">
                                <Label htmlFor="license_number">License Number</Label>
                                <Controller
                                    name="license_number"
                                    control={control}
                                    render={({ field }) => <Input id="license_number" {...field} />}
                                />
                            </div>
                        </div>

                        {/* Company Office Location */}
                        <div className="space-y-4 rounded-lg border bg-slate-50 dark:bg-slate-800/30 p-4">
                            <div className="flex items-center gap-2">
                                <Building className="w-5 h-5 text-indigo-600" />
                                <h4 className="font-semibold text-slate-800 dark:text-slate-200">Company Office Location</h4>
                            </div>
                            
                            <div className="space-y-2">
                                <Label htmlFor="company_office_address">Street Address</Label>
                                <Controller
                                    name="company_office_address"
                                    control={control}
                                    render={({ field }) => <Input id="company_office_address" placeholder="123 Main St" {...field} />}
                                />
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="space-y-2">
                                    <Label htmlFor="company_office_city">City</Label>
                                    <Controller
                                        name="company_office_city"
                                        control={control}
                                        render={({ field }) => <Input id="company_office_city" placeholder="e.g., Miami" {...field} />}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="company_office_state">State</Label>
                                    <Controller
                                        name="company_office_state"
                                        control={control}
                                        render={({ field }) => <Input id="company_office_state" placeholder="e.g., FL" {...field} />}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="company_office_zip">ZIP Code</Label>
                                    <Controller
                                        name="company_office_zip"
                                        control={control}
                                        render={({ field }) => <Input id="company_office_zip" placeholder="e.g., 33139" {...field} />}
                                    />
                                </div>
                            </div>

                            <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between">
                                <div>
                                    <h5 className="font-semibold text-sm text-slate-700 dark:text-slate-300">Precise Office Coordinates</h5>
                                    <p className="text-sm text-slate-500 dark:text-slate-400">
                                        For 100% accurate map data and travel calculations
                                    </p>
                                </div>
                                <a href="https://www.google.com/maps" target="_blank" rel="noopener noreferrer" className="mt-2 sm:mt-0">
                                    <Button type="button" variant="outline" size="sm" className="gap-2">
                                        <MapPin className="w-4 h-4" />
                                        Find on Google Maps
                                    </Button>
                                </a>
                            </div>
                            
                            <p className="text-xs text-slate-500 dark:text-slate-400">
                                On Google Maps, right-click your location and click the coordinates to copy them.
                            </p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <Label htmlFor="office_lat">Office Latitude</Label>
                                    <Controller
                                        name="office_lat"
                                        control={control}
                                        render={({ field }) => <Input id="office_lat" {...field} placeholder="e.g., 40.7128" />}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="office_lng">Office Longitude</Label>
                                    <Controller
                                        name="office_lng"
                                        control={control}
                                        render={({ field }) => <Input id="office_lng" {...field} placeholder="e.g., -74.0060" />}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Private Office Location */}
                        <div className="space-y-4 rounded-lg border bg-amber-50 dark:bg-amber-900/20 p-4">
                            <div className="flex items-center gap-2">
                                <Briefcase className="w-5 h-5 text-amber-600" />
                                <h4 className="font-semibold text-slate-800 dark:text-slate-200">Private Office Space (Optional)</h4>
                            </div>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                If you work from a different location (home office, satellite office, etc.)
                            </p>
                            
                            <div className="space-y-2">
                                <Label htmlFor="private_office_address">Street Address</Label>
                                <Controller
                                    name="private_office_address"
                                    control={control}
                                    render={({ field }) => <Input id="private_office_address" placeholder="e.g., 456 Home St" {...field} />}
                                />
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="space-y-2">
                                    <Label htmlFor="private_office_city">City</Label>
                                    <Controller
                                        name="private_office_city"
                                        control={control}
                                        render={({ field }) => <Input id="private_office_city" placeholder="e.g., Miami" {...field} />}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="private_office_state">State</Label>
                                    <Controller
                                        name="private_office_state"
                                        control={control}
                                        render={({ field }) => <Input id="private_office_state" placeholder="e.g., FL" {...field} />}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="private_office_zip">ZIP Code</Label>
                                    <Controller
                                        name="private_office_zip"
                                        control={control}
                                        render={({ field }) => <Input id="private_office_zip" placeholder="e.g., 33139" {...field} />}
                                    />
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <Label htmlFor="private_office_lat">Private Office Latitude</Label>
                                    <Controller
                                        name="private_office_lat"
                                        control={control}
                                        render={({ field }) => <Input id="private_office_lat" {...field} placeholder="e.g., 40.7128" />}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="private_office_lng">Private Office Longitude</Label>
                                    <Controller
                                        name="private_office_lng"
                                        control={control}
                                        render={({ field }) => <Input id="private_office_lng" {...field} placeholder="e.g., -74.0060" />}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Default Office Location Selection */}
                        {(watch('company_office_address') || watch('private_office_address')) && (
                            <div className="space-y-4 rounded-lg border bg-purple-50 dark:bg-purple-900/20 p-4">
                                <div className="flex items-center gap-2">
                                    <Star className="w-5 h-5 text-purple-600" />
                                    <h4 className="font-semibold text-slate-800 dark:text-slate-200">Default Office Location</h4>
                                </div>
                                <p className="text-sm text-slate-600 dark:text-slate-400">
                                    Choose which office location to use for travel time calculations and map displays
                                </p>
                                
                                <Controller
                                    name="default_office_location"
                                    control={control}
                                    render={({ field }) => (
                                        <div className="flex flex-col sm:flex-row gap-3">
                                            {watch('company_office_address') && (
                                                <Button
                                                    type="button"
                                                    variant={field.value === 'company' ? 'default' : 'outline'}
                                                    className={`flex-1 justify-start gap-2 ${field.value === 'company' ? 'bg-purple-600 hover:bg-purple-700' : ''}`}
                                                    onClick={() => field.onChange('company')}
                                                >
                                                    <Building className="w-4 h-4" />
                                                    <div className="text-left">
                                                        <div className="font-medium">Company Office</div>
                                                        <div className="text-xs opacity-80 truncate max-w-[200px]">{watch('company_office_address')}</div>
                                                    </div>
                                                    {field.value === 'company' && <Star className="w-4 h-4 ml-auto fill-current" />}
                                                </Button>
                                            )}
                                            {watch('private_office_address') && (
                                                <Button
                                                    type="button"
                                                    variant={field.value === 'private' ? 'default' : 'outline'}
                                                    className={`flex-1 justify-start gap-2 ${field.value === 'private' ? 'bg-purple-600 hover:bg-purple-700' : ''}`}
                                                    onClick={() => field.onChange('private')}
                                                >
                                                    <Briefcase className="w-4 h-4" />
                                                    <div className="text-left">
                                                        <div className="font-medium">Private Office</div>
                                                        <div className="text-xs opacity-80 truncate max-w-[200px]">{watch('private_office_address')}</div>
                                                    </div>
                                                    {field.value === 'private' && <Star className="w-4 h-4 ml-auto fill-current" />}
                                                </Button>
                                            )}
                                        </div>
                                    )}
                                />
                                
                                <p className="text-xs text-purple-700 dark:text-purple-300 bg-purple-100 dark:bg-purple-900/40 p-2 rounded">
                                    ⭐ The default location will be used for calculating travel time to appointments, showings, and open houses.
                                </p>
                            </div>
                        )}

                        {/* Working Hours */}
                        <div className="space-y-4 rounded-lg border bg-green-50 dark:bg-green-900/20 p-4">
                            <div className="flex items-center gap-2">
                                <Clock className="w-5 h-5 text-green-600" />
                                <h4 className="font-semibold text-slate-800 dark:text-slate-200">Working Hours</h4>
                            </div>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                Set your typical working hours for better task scheduling
                            </p>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <Label htmlFor="working_hours_start">Start Time</Label>
                                    <Controller
                                        name="working_hours_start"
                                        control={control}
                                        render={({ field }) => (
                                            <Input 
                                                id="working_hours_start" 
                                                type="time" 
                                                {...field} 
                                            />
                                        )}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="working_hours_end">End Time</Label>
                                    <Controller
                                        name="working_hours_end"
                                        control={control}
                                        render={({ field }) => (
                                            <Input 
                                                id="working_hours_end" 
                                                type="time" 
                                                {...field} 
                                            />
                                        )}
                                    />
                                </div>
                            </div>

                            <div className="space-y-3">
                                <Label>Working Days</Label>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {DAYS_OF_WEEK.map(day => (
                                        <div key={day.value} className="flex items-center space-x-2">
                                            <Checkbox
                                                id={day.value}
                                                checked={workingDays.includes(day.value)}
                                                onCheckedChange={() => handleDayToggle(day.value)}
                                            />
                                            <Label 
                                                htmlFor={day.value}
                                                className="cursor-pointer font-normal"
                                            >
                                                {day.label}
                                            </Label>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="pt-4 border-t border-green-200 dark:border-green-800">
                                <div className="flex items-start space-x-2">
                                    <Controller
                                        name="show_tasks_during_working_hours_only"
                                        control={control}
                                        render={({ field }) => (
                                            <Checkbox
                                                id="show_tasks_during_working_hours_only"
                                                checked={field.value}
                                                onCheckedChange={field.onChange}
                                            />
                                        )}
                                    />
                                    <div className="space-y-1">
                                        <Label 
                                            htmlFor="show_tasks_during_working_hours_only"
                                            className="cursor-pointer font-semibold"
                                        >
                                            Show tasks only during working hours
                                        </Label>
                                        <p className="text-xs text-slate-500 dark:text-slate-400">
                                            When enabled, tasks will only appear in your task list during your working hours on working days. 
                                            This helps maintain work-life balance.
                                        </p>
                                        {showTasksOnly && (
                                            <div className="mt-2 p-2 bg-green-100 dark:bg-green-900/30 rounded text-xs text-green-800 dark:text-green-200">
                                                ✅ Tasks will only show during: {watch('working_hours_start')} - {watch('working_hours_end')} on {workingDays.join(', ')}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end">
                            <Button type="submit" disabled={isUpdating}>
                                {isUpdating && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                Save Profile
                            </Button>
                        </div>
                    </form>
                </CardContent>
            </Card>
        </div>
    );
}

import React, { useState, useEffect } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import { Mail, Send, Key, CheckCircle2, AlertCircle, ExternalLink, Eye, EyeOff, Loader2, Copy, Check, Bug } from 'lucide-react';
import { toast } from 'sonner';

export default function ResendSettings({ user }) {
    const queryClient = useQueryClient();
    const [apiKey, setApiKey] = useState('');
    const [fromEmail, setFromEmail] = useState('');
    const [fromName, setFromName] = useState('');
    const [testEmail, setTestEmail] = useState('');
    const [showApiKey, setShowApiKey] = useState(false);
    const [isTesting, setIsTesting] = useState(false);
    const [copiedExample, setCopiedExample] = useState(false);
    const [debugInfo, setDebugInfo] = useState(null);

    // Initialize from user data
    useEffect(() => {
        if (user) {
            console.log('📝 Loading user settings');
            setApiKey(user.resend_api_key || '');
            setFromEmail(user.resend_from_email || '');
            setFromName(user.resend_from_name || user.full_name || '');
            setTestEmail(user.email || '');
        }
    }, [user]);

    const updateMutation = useMutation({
        mutationFn: async (data) => {
            console.log('🔄 Saving Resend settings...');
            const result = await base44.auth.updateMe(data);
            console.log('✅ Save successful!');
            return result;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['user'] });
            toast.success('✅ Resend settings saved successfully!', {
                description: 'Please reload this page (F5) before sending test emails',
                duration: 5000
            });
        },
        onError: (error) => {
            console.error('❌ Save error:', error.message);
            toast.error(`Failed to save settings: ${error.message}`);
        },
    });

    const handleSave = () => {
        console.log('🖱️ SAVE BUTTON CLICKED!');

        // Validate
        if (!apiKey || apiKey.trim() === '') {
            console.error('❌ API Key is empty');
            toast.error('API Key is required');
            return;
        }

        if (!apiKey.startsWith('re_')) {
            console.error('❌ API Key invalid format');
            toast.error('Invalid API key - must start with "re_"');
            return;
        }

        if (!fromEmail || fromEmail.trim() === '') {
            console.error('❌ From Email is empty');
            toast.error('From Email is required');
            return;
        }

        if (!fromEmail.includes('@')) {
            console.error('❌ From Email invalid format');
            toast.error('Invalid email address');
            return;
        }

        // Check if using unverified domain
        if (fromEmail && !fromEmail.includes('onboarding@resend.dev')) {
            const domain = fromEmail.split('@')[1];
            if (domain === 'gmail.com' || domain === 'yahoo.com' || domain === 'outlook.com' || domain === 'hotmail.com') {
                toast.warning('⚠️ Gmail/Yahoo/Outlook domains need verification in Resend. Use "onboarding@resend.dev" for testing.', {
                    duration: 8000
                });
            }
        }

        const dataToSave = {
            resend_api_key: apiKey.trim(),
            resend_from_email: fromEmail.trim(),
            resend_from_name: fromName.trim() || user?.full_name || 'RealtyMind'
        };

        console.log('📤 Saving settings...');
        updateMutation.mutate(dataToSave);
    };

    const handleTestEmail = async () => {
        if (!testEmail || !testEmail.includes('@')) {
            toast.error('Please enter a valid email address');
            return;
        }

        if (!user?.resend_api_key) {
            toast.error('No API key found. Please save your settings and reload the page.');
            return;
        }

        if (!user?.resend_from_email) {
            toast.error('No From Email found. Please save your settings and reload the page.');
            return;
        }

        setIsTesting(true);
        setDebugInfo(null);
        
        console.log('🧪 TEST EMAIL STARTING');
        console.log('📋 Sending to:', testEmail);
        console.log('📋 From:', user.resend_from_email);
        
        try {
            const payload = {
                to: testEmail,
                subject: '✅ RealtyMind Email Test',
                html: `<h1>Test Email</h1><p>If you see this, your Resend integration works!</p><p>From: ${user.resend_from_name} &lt;${user.resend_from_email}&gt;</p>`,
                text: `Test Email\n\nIf you see this, your Resend integration works!\n\nFrom: ${user.resend_from_name} <${user.resend_from_email}>`
            };

            console.log('📤 Sending test email...');
            
            const response = await base44.functions.invoke('sendEmail', payload);

            console.log('📬 Response received');
            console.log('📬 Response status:', response?.status);

            const data = response?.data;

            if (data?.success) {
                console.log('✅ Email sent successfully!');
                console.log('Message ID:', data.messageId);
                
                setDebugInfo({ 
                    success: true, 
                    messageId: data.messageId,
                    from: data.from,
                    to: Array.isArray(data.to) ? data.to : [data.to]
                });
                toast.success(`✅ Email sent to ${testEmail}!`, { 
                    duration: 5000,
                    description: `Message ID: ${data.messageId}`
                });
            } else {
                console.error('❌ Email sending failed');
                console.error('Error:', data?.error || 'Unknown error');
                console.error('Details:', data?.details || 'No details');
                console.error('Status Code:', data?.statusCode || 'No status');
                
                // Safely extract error information
                const errorMsg = data?.error || 'Unknown error';
                const errorDetails = data?.details || '';
                const errorHint = data?.hint || '';
                const statusCode = data?.statusCode || response?.status || 0;
                
                // Special handling for 403 domain verification error
                let displayError = String(errorMsg);
                let displayHint = String(errorHint);

                if (statusCode === 403 || response?.status === 403) {
                    if (errorDetails && (String(errorDetails).includes('domain') || String(errorDetails).includes('verified'))) {
                        displayError = '🚫 Domain Not Verified';
                        displayHint = `${errorDetails}\n\n✅ SOLUTION:\n1. Change From Email to "onboarding@resend.dev"\n2. Click Save Settings\n3. Reload page (F5)\n4. Try test email again\n\nOR verify your domain at https://resend.com/domains`;
                    } else {
                        displayError = '🚫 Access Forbidden';
                        displayHint = 'Your API key may not have permission. Try using "onboarding@resend.dev" as From Email.';
                    }
                } else if (statusCode === 400 || response?.status === 400) {
                    if (errorDetails && String(errorDetails).toLowerCase().includes('from')) {
                        displayError = '❌ Invalid From Email';
                        displayHint = `Problem: ${errorDetails}\n\n✅ FIX: Make sure From Email is exactly "onboarding@resend.dev" (no extra spaces)`;
                    } else {
                        displayError = '❌ Bad Request to Resend';
                        displayHint = errorDetails || 'Check that all email addresses are valid and From Email is "onboarding@resend.dev"';
                    }
                }
                
                setDebugInfo({
                    success: false,
                    error: String(errorMsg),
                    details: String(errorDetails),
                    hint: displayHint,
                    statusCode: statusCode,
                    payload: data?.payload || null,
                    rawResponse: JSON.stringify(data, null, 2)
                });

                toast.error(displayError, {
                    description: displayHint,
                    duration: 15000
                });
            }
        } catch (error) {
            console.error('💥 Exception caught');
            console.error('💥 Error type:', typeof error);
            console.error('💥 Error message:', error?.message);
            
            // Safely extract error information
            let errorMessage = 'Unknown error';
            let errorDetails = '';
            
            try {
                errorMessage = error?.message || String(error);
            } catch (e) {
                errorMessage = 'Error parsing error message';
            }
            
            try {
                if (error.response?.data) {
                    errorDetails = JSON.stringify(error.response.data, null, 2);
                }
            } catch (e) {
                errorDetails = 'Could not parse response data';
            }
            
            setDebugInfo({
                success: false,
                error: errorMessage,
                rawError: String(error),
                responseData: errorDetails,
                responseStatus: error.response?.status || 0
            });

            toast.error('❌ Network or system error', {
                description: errorMessage,
                duration: 8000
            });
        } finally {
            setIsTesting(false);
            console.log('🏁 Test email process completed');
        }
    };

    const handleCopyExample = () => {
        const code = `import { base44 } from '@/api/base44Client';

await base44.functions.invoke('sendEmail', {
  to: 'client@example.com',
  subject: 'Appointment Confirmed',
  html: \`
    <h2>Hi John!</h2>
    <p>Your appointment is confirmed for tomorrow at 2pm.</p>
  \`
});`;
        
        navigator.clipboard.writeText(code);
        setCopiedExample(true);
        toast.success('Code copied to clipboard!');
        setTimeout(() => setCopiedExample(false), 2000);
    };

    const hasUnsavedChanges = 
        apiKey !== (user?.resend_api_key || '') ||
        fromEmail !== (user?.resend_from_email || '') ||
        fromName !== (user?.resend_from_name || user?.full_name || '');

    const isConfigured = user?.resend_api_key && user?.resend_from_email;
    const apiKeyValid = apiKey.startsWith('re_') || apiKey === '';
    const fromEmailValid = fromEmail.includes('@') || fromEmail === '';
    
    const canSave = apiKey.trim() !== '' && fromEmail.trim() !== '' && apiKeyValid && fromEmailValid;

    // Check if using unverified domain
    const isUsingUnverifiedDomain = fromEmail && fromEmail !== 'onboarding@resend.dev' && !fromEmail.includes('resend.dev');
    const fromDomain = fromEmail ? fromEmail.split('@')[1] : '';
    const isCommonDomain = ['gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com', 'icloud.com'].includes(fromDomain);

    return (
        <div className="space-y-6">
            {/* CRITICAL WARNING - Domain Verification */}
            {isUsingUnverifiedDomain && isCommonDomain && (
                <Alert className="border-red-300 bg-red-50 dark:bg-red-900/30 shadow-lg">
                    <AlertCircle className="h-5 w-5 text-red-600" />
                    <AlertDescription>
                        <p className="font-bold text-red-900 dark:text-red-100 text-lg mb-2">🚫 CANNOT SEND FROM {fromDomain.toUpperCase()}</p>
                        <p className="text-red-800 dark:text-red-200 mb-3">
                            {fromDomain} requires domain verification in Resend. For testing, you MUST use the Resend test domain.
                        </p>
                        <div className="bg-green-100 dark:bg-green-900/50 p-3 rounded border-2 border-green-400">
                            <p className="font-bold text-green-900 dark:text-green-100 mb-2">✅ SOLUTION:</p>
                            <ol className="text-sm text-green-800 dark:text-green-200 space-y-1 list-decimal list-inside">
                                <li>Click the <strong>"Use Test Email"</strong> button below</li>
                                <li>Click <strong>"Save Settings"</strong></li>
                                <li><strong>Reload page</strong> (F5)</li>
                                <li>Send test email</li>
                            </ol>
                        </div>
                    </AlertDescription>
                </Alert>
            )}

            {/* Current Configuration Display */}
            <Card className="border-blue-200 bg-blue-50 dark:bg-blue-900/20">
                <CardHeader>
                    <CardTitle className="text-lg flex items-center gap-2">
                        <Bug className="w-5 h-5 text-blue-600" />
                        Current Configuration
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-2 text-sm">
                    <div className="flex items-center gap-2">
                        <span className="font-semibold text-slate-700 dark:text-slate-300">API Key:</span>
                        <code className="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">
                            {user?.resend_api_key ? `${user.resend_api_key.substring(0, 10)}...` : '❌ Not Set'}
                        </code>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className="font-semibold text-slate-700 dark:text-slate-300">From Email:</span>
                        <code className="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">
                            {user?.resend_from_email || '❌ Not Set'}
                        </code>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className="font-semibold text-slate-700 dark:text-slate-300">From Name:</span>
                        <code className="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">
                            {user?.resend_from_name || user?.full_name || '❌ Not Set'}
                        </code>
                    </div>
                    {hasUnsavedChanges && (
                        <Alert className="mt-3 border-amber-300 bg-amber-100 dark:bg-amber-900/30">
                            <AlertCircle className="h-4 w-4 text-amber-700" />
                            <AlertDescription className="text-amber-900 dark:text-amber-100 font-semibold">
                                ⚠️ You have unsaved changes! Click "Save Settings" below.
                            </AlertDescription>
                        </Alert>
                    )}
                </CardContent>
            </Card>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                            <Mail className="w-5 h-5 text-white" />
                        </div>
                        Resend Email Integration
                    </CardTitle>
                    <CardDescription>
                        Configure Resend to send emails from your app
                    </CardDescription>
                </CardHeader>
                <CardContent className="space-y-6">
                    {/* Status Badge */}
                    <div className="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                        <div className="flex-1">
                            <p className="text-sm font-medium text-slate-700 dark:text-slate-300">Integration Status</p>
                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                {isConfigured ? 'Ready to send emails' : 'Configuration required'}
                            </p>
                        </div>
                        <Badge variant={isConfigured ? "default" : "secondary"} className={isConfigured ? "bg-green-500" : ""}>
                            {isConfigured ? (
                                <>
                                    <CheckCircle2 className="w-3 h-3 mr-1" />
                                    Active
                                </>
                            ) : (
                                <>
                                    <AlertCircle className="w-3 h-3 mr-1" />
                                    Not Configured
                                </>
                            )}
                        </Badge>
                    </div>

                    {/* Get Started Guide */}
                    <Alert className="border-blue-200 bg-blue-50 dark:bg-blue-900/20">
                        <AlertCircle className="h-4 w-4 text-blue-600" />
                        <AlertDescription>
                            <p className="font-semibold mb-3 text-blue-900 dark:text-blue-100">🚀 Quick Setup:</p>
                            <ol className="list-decimal list-inside space-y-2 text-sm text-blue-800 dark:text-blue-200">
                                <li>
                                    Get API key from{' '}
                                    <a href="https://resend.com/api-keys" target="_blank" rel="noopener noreferrer" className="font-semibold underline inline-flex items-center gap-1">
                                        resend.com/api-keys <ExternalLink className="w-3 h-3" />
                                    </a>
                                </li>
                                <li>Paste it below, click <strong>"✅ Use Test Email"</strong>, then <strong>"Save Settings"</strong></li>
                                <li><strong>Reload page</strong> (F5), then send test email!</li>
                            </ol>
                        </AlertDescription>
                    </Alert>

                    {/* API Key */}
                    <div className="space-y-2">
                        <Label htmlFor="resend_api_key" className="flex items-center gap-2">
                            <Key className="w-4 h-4" />
                            Resend API Key *
                        </Label>
                        <div className="relative">
                            <Input
                                id="resend_api_key"
                                type={showApiKey ? "text" : "password"}
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                placeholder="re_xxxxxxxxxxxx"
                                className={`pr-10 ${apiKey && !apiKey.startsWith('re_') ? 'border-red-500' : ''}`}
                            />
                            <Button
                                type="button"
                                variant="ghost"
                                size="sm"
                                className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
                                onClick={() => setShowApiKey(!showApiKey)}
                            >
                                {showApiKey ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                            </Button>
                        </div>
                        {apiKey && !apiKey.startsWith('re_') && (
                            <p className="text-xs text-red-600 flex items-center gap-1">
                                <AlertCircle className="w-3 h-3" />
                                API key should start with "re_"
                            </p>
                        )}
                    </div>

                    {/* From Email */}
                    <div className="space-y-2">
                        <Label htmlFor="resend_from_email">
                            From Email Address *
                        </Label>
                        <div className="flex gap-2">
                            <Input
                                id="resend_from_email"
                                type="email"
                                value={fromEmail}
                                onChange={(e) => setFromEmail(e.target.value)}
                                placeholder="onboarding@resend.dev"
                                className={`${fromEmail && !fromEmail.includes('@') ? 'border-red-500' : ''} ${isUsingUnverifiedDomain && isCommonDomain ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : ''}`}
                            />
                            <Button
                                type="button"
                                variant="outline"
                                onClick={() => {
                                    setFromEmail('onboarding@resend.dev');
                                    toast.success('✅ From Email set to onboarding@resend.dev', {
                                        description: 'Perfect! This domain works without verification.',
                                        duration: 4000
                                    });
                                }}
                                className="whitespace-nowrap bg-green-50 hover:bg-green-100 border-green-300 text-green-700 font-semibold"
                            >
                                ✅ Use Test Email
                            </Button>
                        </div>
                        <Alert className="border-green-200 bg-green-50 dark:bg-green-900/20">
                            <CheckCircle2 className="w-4 h-4 text-green-600" />
                            <AlertDescription className="text-green-800 dark:text-green-200">
                                <p className="font-semibold mb-1">✅ For Testing (NO verification needed):</p>
                                <p className="text-sm mb-2">Use <code className="bg-green-100 dark:bg-green-900 px-2 py-0.5 rounded font-mono font-bold">onboarding@resend.dev</code></p>
                                <p className="text-xs text-green-700 dark:text-green-300">
                                    ⚠️ Gmail, Yahoo, Outlook require domain verification at <a href="https://resend.com/domains" target="_blank" className="underline font-semibold">resend.com/domains</a>
                                </p>
                            </AlertDescription>
                        </Alert>
                    </div>

                    {/* From Name */}
                    <div className="space-y-2">
                        <Label htmlFor="resend_from_name">
                            From Name (Optional)
                        </Label>
                        <Input
                            id="resend_from_name"
                            type="text"
                            value={fromName}
                            onChange={(e) => setFromName(e.target.value)}
                            placeholder={user?.full_name || "Your Name"}
                        />
                    </div>

                    {/* Debug: Show what will be saved */}
                    {canSave && (
                        <Alert className="border-green-200 bg-green-50 dark:bg-green-900/20">
                            <CheckCircle2 className="h-4 w-4 text-green-600" />
                            <AlertDescription className="text-green-800 dark:text-green-200">
                                <p className="font-semibold mb-2">✅ Ready to save:</p>
                                <div className="text-xs font-mono space-y-1 bg-white dark:bg-slate-800 p-2 rounded">
                                    <p>• API Key: {apiKey.substring(0, 10)}...</p>
                                    <p>• From Email: {fromEmail}</p>
                                    <p>• From Name: {fromName || user?.full_name || 'RealtyMind'}</p>
                                </div>
                            </AlertDescription>
                        </Alert>
                    )}

                    {/* Save Button */}
                    <div className="space-y-3 pt-4 border-t-2">
                        <Button
                            onClick={handleSave}
                            disabled={updateMutation.isPending || !canSave}
                            className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-lg py-6 font-bold shadow-lg"
                            type="button"
                        >
                            {updateMutation.isPending ? (
                                <>
                                    <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                    Saving Settings...
                                </>
                            ) : (
                                <>
                                    <CheckCircle2 className="w-5 h-5 mr-2" />
                                    💾 Save Settings
                                </>
                            )}
                        </Button>

                        {/* Show why button is disabled */}
                        {!canSave && (
                            <Alert className="border-red-200 bg-red-50 dark:bg-red-900/20">
                                <AlertCircle className="h-4 w-4 text-red-600" />
                                <AlertDescription className="text-red-800 dark:text-red-200">
                                    <p className="font-bold mb-2">⚠️ Cannot save because:</p>
                                    <ul className="text-xs space-y-1">
                                        {!apiKey.trim() && <li>• API Key is empty</li>}
                                        {apiKey.trim() && !apiKey.startsWith('re_') && <li>• API Key must start with "re_"</li>}
                                        {!fromEmail.trim() && <li>• From Email is empty</li>}
                                        {fromEmail.trim() && !fromEmail.includes('@') && <li>• From Email is invalid</li>}
                                    </ul>
                                </AlertDescription>
                            </Alert>
                        )}

                        {hasUnsavedChanges && canSave && (
                            <Alert className="border-amber-200 bg-amber-50 dark:bg-amber-900/20">
                                <AlertCircle className="h-4 w-4 text-amber-600" />
                                <AlertDescription className="text-amber-800 dark:text-amber-200 font-bold">
                                    ⚠️ Changes not saved yet! Click the button above.
                                </AlertDescription>
                            </Alert>
                        )}
                    </div>
                </CardContent>
            </Card>

            {/* Test Email Section */}
            <Card className={isConfigured && !hasUnsavedChanges ? 'border-2 border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/10' : ''}>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Send className="w-5 h-5" />
                        Send Test Email
                    </CardTitle>
                    <CardDescription>
                        Verify your configuration works (reload page after saving!)
                    </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="test_email">Test Email Address</Label>
                        <Input
                            id="test_email"
                            type="email"
                            value={testEmail}
                            onChange={(e) => setTestEmail(e.target.value)}
                            placeholder="your-email@example.com"
                            disabled={!isConfigured}
                        />
                    </div>
                    
                    <Button
                        onClick={handleTestEmail}
                        disabled={isTesting || !testEmail || !isConfigured || hasUnsavedChanges}
                        className="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700"
                        size="lg"
                    >
                        {isTesting ? (
                            <>
                                <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                Sending Test Email...
                            </>
                        ) : (
                            <>
                                <Send className="w-5 h-5 mr-2" />
                                Send Test Email
                            </>
                        )}
                    </Button>

                    {/* Debug Information */}
                    {debugInfo && (
                        <Alert className={debugInfo.success ? "border-green-200 bg-green-50 dark:bg-green-900/20" : "border-red-200 bg-red-50 dark:bg-red-900/20"}>
                            <AlertCircle className={`h-4 w-4 ${debugInfo.success ? 'text-green-600' : 'text-red-600'}`} />
                            <AlertDescription>
                                <p className={`font-bold mb-3 text-lg ${debugInfo.success ? 'text-green-900 dark:text-green-100' : 'text-red-900 dark:text-red-100'}`}>
                                    {debugInfo.success ? '✅ SUCCESS!' : '🔍 ERROR DEBUG INFO'}
                                </p>
                                {debugInfo.success ? (
                                    <div className="text-sm text-green-800 dark:text-green-200 space-y-1">
                                        <p>✅ Email sent successfully!</p>
                                        <p>Message ID: <code className="bg-green-100 dark:bg-green-900 px-2 py-1 rounded font-mono">{debugInfo.messageId}</code></p>
                                        <p>From: <code className="bg-green-100 dark:bg-green-900 px-2 py-1 rounded">{debugInfo.from}</code></p>
                                        <p>To: <code className="bg-green-100 dark:bg-green-900 px-2 py-1 rounded">{debugInfo.to?.join(', ')}</code></p>
                                        <p className="mt-3 font-semibold">📬 Check your inbox!</p>
                                    </div>
                                ) : (
                                    <div className="text-sm space-y-3">
                                        {debugInfo.error && (
                                            <div className="bg-red-100 dark:bg-red-900/50 p-3 rounded">
                                                <p className="font-bold text-red-900 dark:text-red-100">Error: {debugInfo.error}</p>
                                            </div>
                                        )}
                                        {debugInfo.details && (
                                            <div className="bg-red-100 dark:bg-red-900/50 p-3 rounded">
                                                <p className="font-bold text-red-900 dark:text-red-100">Details: {debugInfo.details}</p>
                                            </div>
                                        )}
                                        {debugInfo.hint && (
                                            <div className="bg-yellow-100 dark:bg-yellow-900/50 p-3 rounded border-2 border-yellow-400">
                                                <p className="font-bold text-yellow-900 dark:text-yellow-100 mb-2">💡 HOW TO FIX:</p>
                                                <p className="text-yellow-900 dark:text-yellow-100 whitespace-pre-line">{debugInfo.hint}</p>
                                            </div>
                                        )}
                                        {debugInfo.rawResponse && (
                                            <details className="mt-3">
                                                <summary className="cursor-pointer font-bold text-red-900 dark:text-red-100 hover:underline">
                                                    🔍 View Full Response
                                                </summary>
                                                <pre className="bg-slate-900 text-slate-100 p-3 rounded mt-2 text-xs overflow-x-auto">
                                                    {debugInfo.rawResponse}
                                                </pre>
                                            </details>
                                        )}
                                    </div>
                                )}
                            </AlertDescription>
                        </Alert>
                    )}
                </CardContent>
            </Card>

            {/* Usage Examples */}
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center justify-between">
                        <span>Usage Examples</span>
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={handleCopyExample}
                        >
                            {copiedExample ? (
                                <>
                                    <Check className="w-4 h-4 mr-2 text-green-600" />
                                    Copied!
                                </>
                            ) : (
                                <>
                                    <Copy className="w-4 h-4 mr-2" />
                                    Copy Code
                                </>
                            )}
                        </Button>
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="bg-slate-900 rounded-lg p-4 overflow-x-auto">
                        <pre className="text-sm text-slate-100">
{`// Send appointment confirmation
import { base44 } from '@/api/base44Client';

await base44.functions.invoke('sendEmail', {
  to: 'client@example.com',
  subject: 'Appointment Confirmed',
  html: \`
    <h2>Hi John!</h2>
    <p>Your appointment is confirmed for tomorrow at 2pm.</p>
  \`
});`}
                        </pre>
                    </div>
                </CardContent>
            </Card>
        </div>
    );
}
